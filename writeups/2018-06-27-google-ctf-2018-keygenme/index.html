<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=false><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=theme-color><title>KEYGENME - Google CTF 2018 &#183; mhackeroni</title><meta name=title content="KEYGENME - Google CTF 2018 &#183; mhackeroni"><meta name=description content="Write-up for the KEYGENME challenge from Google CTF 2018."><meta name=keywords content="google,ctf,reversing,mhackeroni,"><link rel=canonical href=https://mhackeroni.it/writeups/2018-06-27-google-ctf-2018-keygenme/><link type=text/css rel=stylesheet href=/css/main.bundle.min.1d8c7618f0ef6623fd6ebffc2988f58f128a919c43d2ed5d99a0621768c50d3ec37bd1e02b3eb119ba92bc64d53422281addaaa107a57202376dbd6a14e2e50e.css integrity="sha512-HYx2GPDvZiP9br/8KYj1jxKKkZxD0u1dmaBiF2jFDT7De9HgKz6xGbqSvGTVNCIoGt2qoQelcgI3bb1qFOLlDg=="><script type=text/javascript src=/js/appearance.min.2a7f28406ff67c2e3fedcfa49ff1dc78cca5f4b2ace4618a279f94d3fd241566af610abcf38bb98ec3f039afc0acbb3c27e9eced17e4a072f1a98e18a628ec7e.js integrity="sha512-Kn8oQG/2fC4/7c+kn/HceMyl9LKs5GGKJ5+U0/0kFWavYQq884u5jsPwOa/ArLs8J+ns7RfkoHLxqY4Ypijsfg=="></script><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.a187118b41a60744310065c567365de85730c8495301d0ebae41810cc6f7a47432b1de7d4f3b11338959f1ac50c266be6b4b73acf6bf770016eb59b602cc1aa0.js integrity="sha512-oYcRi0GmB0QxAGXFZzZd6FcwyElTAdDrrkGBDMb3pHQysd59TzsRM4lZ8axQwma+a0tzrPa/dwAW61m2AswaoA==" data-copy=Copy data-copied=Copied></script><script src=/lib/zoom/zoom.min.umd.a527109b68c082a70f3697716dd72a9d5aa8b545cf800cecbbc7399f2ca6f6e0ce3e431f2062b48bbfa47c9ea42822714060bef309be073f49b9c0e30d318d7b.js integrity="sha512-pScQm2jAgqcPNpdxbdcqnVqotUXPgAzsu8c5nyym9uDOPkMfIGK0i7+kfJ6kKCJxQGC+8wm+Bz9JucDjDTGNew=="></script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:url" content="https://mhackeroni.it/writeups/2018-06-27-google-ctf-2018-keygenme/"><meta property="og:site_name" content="mhackeroni"><meta property="og:title" content="KEYGENME - Google CTF 2018"><meta property="og:description" content="Write-up for the KEYGENME challenge from Google CTF 2018."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="writeups"><meta property="article:published_time" content="2018-06-27T00:00:00+00:00"><meta property="article:modified_time" content="2018-06-27T00:00:00+00:00"><meta property="article:tag" content="Google"><meta property="article:tag" content="Ctf"><meta property="article:tag" content="Reversing"><meta property="article:tag" content="Mhackeroni"><meta name=twitter:card content="summary"><meta name=twitter:title content="KEYGENME - Google CTF 2018"><meta name=twitter:description content="Write-up for the KEYGENME challenge from Google CTF 2018."><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"","name":"KEYGENME - Google CTF 2018","headline":"KEYGENME - Google CTF 2018","description":"Write-up for the KEYGENME challenge from Google CTF 2018.","inLanguage":"en","url":"https:\/\/mhackeroni.it\/writeups\/2018-06-27-google-ctf-2018-keygenme\/","author":{"@type":"Person","name":"mhackeroni"},"copyrightYear":"2018","dateCreated":"2018-06-27T00:00:00\u002b00:00","datePublished":"2018-06-27T00:00:00\u002b00:00","dateModified":"2018-06-27T00:00:00\u002b00:00","keywords":["google","ctf","reversing","mhackeroni"],"mainEntityOfPage":"true","wordCount":"1038"}]</script><meta name=author content="mhackeroni"><link href=https://bsky.app/profile/mhackeroni.bsky.social rel=me><link href=https://www.facebook.com/mhackeroni rel=me><link href=https://github.com/mhackeroni/ rel=me><link href=https://www.linkedin.com/company/mhackeroni-inc/ rel=me><link href=https://x.com/mhackeroni rel=me><link href=https://www.youtube.com/@mhackeroni rel=me><script src=/lib/jquery/jquery.slim.min.b0dca576e87d7eaa5850ae4e61759c065786cdb6489d68fcc82240539eebd5da522bdb4fda085ffd245808c8fe2acb2516408eb774ef26b5f6015fc6737c0ea8.js integrity="sha512-sNylduh9fqpYUK5OYXWcBleGzbZInWj8yCJAU57r1dpSK9tP2ghf/SRYCMj+KsslFkCOt3TvJrX2AV/Gc3wOqA=="></script></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32 scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>Skip to main content</a></div><div class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start gap-x-3 pt-[2px] pr-0 pb-[3px] pl-0"><div><a href=/ class=flex><span class=sr-only>mhackeroni</span>
<img src=/mhackeroni-stylized-square.webp width=1024 height=1024 class="logo max-h-[5rem] max-w-[5rem] object-scale-down object-left nozoom" alt=mhackeroni></a></div><div class="flex flex-1 items-center justify-between"><nav class="flex space-x-3"><a href=/ class="text-base font-medium text-gray-500 hover:text-gray-900">mhackeroni</a></nav><nav class="hidden md:flex items-center gap-x-5 md:ml-12 h-12"><a href=/news/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title>News</p></a><a href=/writeups/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title>Writeups</p></a><a href=/sponsors/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title=Sponsors>Sponsors</p></a><a href=/gallery/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title="ðŸ“·  Photo Gallery">Gallery</p></a><a href class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title></p></a><button id=search-button aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title="Search (/)">
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button></nav><div class="flex md:hidden items-center gap-x-5 md:ml-12 h-12"><span></span>
<button id=search-button-mobile aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title="Search (/)">
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button></div></div><div class="-my-2 md:hidden"><div id=menu-button class=block><div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></div><div id=menu-wrapper class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50 pt-[5px]"><ul class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none ltr:text-right rtl:text-left max-w-7xl"><li id=menu-close-button><span class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></span></li><li class=mt-1><a href=/news/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title>News</p></a></li><li class=mt-1><a href=/writeups/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title>Writeups</p></a></li><li class=mt-1><a href=/sponsors/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title=Sponsors>Sponsors</p></a></li><li class=mt-1><a href=/gallery/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title="ðŸ“·  Photo Gallery">Gallery</p></a></li><li class=mt-1><a href class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title></p></a></li></ul></div></div></div></div><div class="relative flex flex-col grow"><main id=main-content class=grow><article><header id=single_header class="mt-5 max-w-prose"><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">KEYGENME - Google CTF 2018</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime=2018-06-27T00:00:00+00:00>27 June 2018</time><span class="px-2 text-primary-500">&#183;</span><span>1038 words</span><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">5 mins</span></div></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="min-w-0 min-h-0 max-w-fit"><div class="article-content max-w-prose mb-20"><div class="lead text-neutral-500 dark:text-neutral-400 !mb-9 text-xl">Authors: marcof, nearffxx, Mercurio</div><blockquote><p><em>I bet you can&rsquo;t reverse this algorithm!</em><br>$ nc keygenme.ctfcompetition.com 1337</p></blockquote><p>This was a 249pts reversing challenge from GoogleCTF-2018</p><h2 class="relative group">Stage One<div id=stage-one class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#stage-one aria-label=Anchor>#</a></span></h2><p>We are given an ELF 64 binary with an encrypted section containing its code base. The code is xored at runtime with an hardcoded key and later executed. We wrote an IDC script to decript the binary and make it possible to analyze in IDA.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;idc.idc&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=nf>decrypt</span><span class=p>(</span><span class=n>from</span><span class=p>,</span> <span class=n>size</span><span class=p>,</span> <span class=n>key</span> <span class=p>)</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>  <span class=k>auto</span> <span class=n>i</span><span class=p>,</span> <span class=n>x</span><span class=p>;</span>            
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span> <span class=n>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>size</span><span class=p>;</span> <span class=n>i</span><span class=o>=</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span> <span class=p>)</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=nf>get_qword</span><span class=p>(</span><span class=n>from</span><span class=p>);</span>   <span class=c1>// fetch the byte
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>x</span> <span class=o>=</span> <span class=p>(</span><span class=n>x</span><span class=o>^</span><span class=n>key</span><span class=p>);</span>           <span class=c1>// decrypt it
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>patch_qword</span><span class=p>(</span><span class=n>from</span><span class=p>,</span><span class=n>x</span><span class=p>);</span>   <span class=c1>// put it back
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>from</span> <span class=o>=</span> <span class=n>from</span> <span class=o>+</span> <span class=mi>8</span><span class=p>;</span>       <span class=c1>// next byte
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span> 
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=nf>stage_1</span><span class=p>()</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>  <span class=nf>decrypt</span><span class=p>(</span><span class=mh>0x6001bc</span><span class=p>,</span> <span class=mh>0x44a8</span><span class=p>,</span> <span class=mh>0x1122334455667788</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>patch_byte</span><span class=p>(</span><span class=mh>0x4000da</span><span class=p>,</span><span class=mh>0x56</span><span class=p>);</span> <span class=c1>// we push rsi (containing the decrypted code address)
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nf>patch_byte</span><span class=p>(</span><span class=mh>0x4000db</span><span class=p>,</span><span class=mh>0xc3</span><span class=p>);</span> <span class=c1>// retn
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></div><p>Now we learned the program is forking and ptracing its child process right after. The child process instead calls execve on &ldquo;/proc/self/fd/3&rdquo; which contains the main keygen logic. Our way to dump the child binary was to break before the execve and copy the binary using cp. For sake of simplicity we called this <em>main3</em></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>gdb<span class=o>)</span> <span class=nb>set</span> follow-fork-mode child
</span></span><span class=line><span class=cl><span class=o>(</span>gdb<span class=o>)</span> catch syscall execve
</span></span><span class=line><span class=cl>Catchpoint <span class=m>1</span> <span class=o>(</span>syscall <span class=s1>&#39;execve&#39;</span> <span class=o>[</span>59<span class=o>])</span>
</span></span><span class=line><span class=cl><span class=o>(</span>gdb<span class=o>)</span> r
</span></span><span class=line><span class=cl>Starting program: /home/nearffxx/tmp/main
</span></span><span class=line><span class=cl><span class=o>[</span>New process 24430<span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>Switching to process 24430<span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Thread 2.1 <span class=s2>&#34;main_o&#34;</span> hit Catchpoint <span class=m>1</span> <span class=o>(</span>call to syscall execve<span class=o>)</span>, 0x00007ffff7fddc10 in ?? 
</span></span><span class=line><span class=cl><span class=o>(</span>gdb<span class=o>)</span> !cp /proc/24430/fd/3 main3
</span></span></code></pre></div><h2 class="relative group">Understanding main3 (child process)<div id=understanding-main3-child-process class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#understanding-main3-child-process aria-label=Anchor>#</a></span></h2><p>As soon as we opened the child process we noticed antidebugging techniques. Basically the original code was filled with a bunch of trap instructions. The parent process would intercept its child traps and restore the original instructions.</p><p>We straced the parent process to observe the patches it was supplying to its child. Below the significant output:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>process_vm_writev<span class=o>(</span>26117, <span class=o>[{</span><span class=nv>iov_base</span><span class=o>=</span><span class=s2>&#34;\x01\xca&#34;</span>, <span class=nv>iov_len</span><span class=o>=</span>2<span class=o>}]</span>, 1, <span class=o>[{</span><span class=nv>iov_base</span><span class=o>=</span>0x555555554d56, <span class=nv>iov_len</span><span class=o>=</span>2<span class=o>}]</span>, 1, 0<span class=o>)</span> <span class=o>=</span> <span class=m>2</span>
</span></span><span class=line><span class=cl>process_vm_writev<span class=o>(</span>26117, <span class=o>[{</span><span class=nv>iov_base</span><span class=o>=</span><span class=s2>&#34;\x01\xca\x01&#34;</span>, <span class=nv>iov_len</span><span class=o>=</span>3<span class=o>}]</span>, 1, <span class=o>[{</span><span class=nv>iov_base</span><span class=o>=</span>0x555555555549, <span class=nv>iov_len</span><span class=o>=</span>3<span class=o>}]</span>, 1, 0<span class=o>)</span> <span class=o>=</span> <span class=m>3</span>
</span></span><span class=line><span class=cl>process_vm_writev<span class=o>(</span>26117, <span class=o>[{</span><span class=nv>iov_base</span><span class=o>=</span><span class=s2>&#34;\x01\xd0&#34;</span>, <span class=nv>iov_len</span><span class=o>=</span>2<span class=o>}]</span>, 1, <span class=o>[{</span><span class=nv>iov_base</span><span class=o>=</span>0x5555555552b6, <span class=nv>iov_len</span><span class=o>=</span>2<span class=o>}]</span>, 1, 0<span class=o>)</span> <span class=o>=</span> <span class=m>2</span>
</span></span><span class=line><span class=cl>process_vm_writev<span class=o>(</span>26117, <span class=o>[{</span><span class=nv>iov_base</span><span class=o>=</span><span class=s2>&#34;\x01\xd0&#34;</span>, <span class=nv>iov_len</span><span class=o>=</span>2<span class=o>}]</span>, 1, <span class=o>[{</span><span class=nv>iov_base</span><span class=o>=</span>0x5555555553c5, <span class=nv>iov_len</span><span class=o>=</span>2<span class=o>}]</span>, 1, 0<span class=o>)</span> <span class=o>=</span> <span class=m>2</span>
</span></span><span class=line><span class=cl>process_vm_writev<span class=o>(</span>26117, <span class=o>[{</span><span class=nv>iov_base</span><span class=o>=</span><span class=s2>&#34;\x01\xd0\x89&#34;</span>, <span class=nv>iov_len</span><span class=o>=</span>3<span class=o>}]</span>, 1, <span class=o>[{</span><span class=nv>iov_base</span><span class=o>=</span>0x555555554f2e, <span class=nv>iov_len</span><span class=o>=</span>3<span class=o>}]</span>, 1, 0<span class=o>)</span> <span class=o>=</span> <span class=m>3</span>
</span></span><span class=line><span class=cl>process_vm_writev<span class=o>(</span>26117, <span class=o>[{</span><span class=nv>iov_base</span><span class=o>=</span><span class=s2>&#34;\x31\xd1\x48&#34;</span>, <span class=nv>iov_len</span><span class=o>=</span>3<span class=o>}]</span>, 1, <span class=o>[{</span><span class=nv>iov_base</span><span class=o>=</span>0x555555554da8, <span class=nv>iov_len</span><span class=o>=</span>3<span class=o>}]</span>, 1, 0<span class=o>)</span> <span class=o>=</span> <span class=m>3</span>
</span></span><span class=line><span class=cl>process_vm_writev<span class=o>(</span>26117, <span class=o>[{</span><span class=nv>iov_base</span><span class=o>=</span><span class=s2>&#34;\x41\x5d&#34;</span>, <span class=nv>iov_len</span><span class=o>=</span>2<span class=o>}]</span>, 1, <span class=o>[{</span><span class=nv>iov_base</span><span class=o>=</span>0x555555555c1e, <span class=nv>iov_len</span><span class=o>=</span>2<span class=o>}]</span>, 1, 0<span class=o>)</span> <span class=o>=</span> <span class=m>2</span>
</span></span><span class=line><span class=cl>process_vm_writev<span class=o>(</span>26117, <span class=o>[{</span><span class=nv>iov_base</span><span class=o>=</span><span class=s2>&#34;\x48\x83\xc2&#34;</span>, <span class=nv>iov_len</span><span class=o>=</span>3<span class=o>}]</span>, 1, <span class=o>[{</span><span class=nv>iov_base</span><span class=o>=</span>0x555555554e3b, <span class=nv>iov_len</span><span class=o>=</span>3<span class=o>}]</span>, 1, 0<span class=o>)</span> <span class=o>=</span> <span class=m>3</span>
</span></span><span class=line><span class=cl>process_vm_writev<span class=o>(</span>26117, <span class=o>[{</span><span class=nv>iov_base</span><span class=o>=</span><span class=s2>&#34;\x48\x83\xc2&#34;</span>, <span class=nv>iov_len</span><span class=o>=</span>3<span class=o>}]</span>, 1, <span class=o>[{</span><span class=nv>iov_base</span><span class=o>=</span>0x555555555540, <span class=nv>iov_len</span><span class=o>=</span>3<span class=o>}]</span>, 1, 0<span class=o>)</span> <span class=o>=</span> <span class=m>3</span>
</span></span><span class=line><span class=cl>process_vm_writev<span class=o>(</span>26117, <span class=o>[{</span><span class=nv>iov_base</span><span class=o>=</span><span class=s2>&#34;\x48\x8b&#34;</span>, <span class=nv>iov_len</span><span class=o>=</span>2<span class=o>}]</span>, 1, <span class=o>[{</span><span class=nv>iov_base</span><span class=o>=</span>0x5555555559e9, <span class=nv>iov_len</span><span class=o>=</span>2<span class=o>}]</span>, 1, 0<span class=o>)</span> <span class=o>=</span> <span class=m>2</span>
</span></span><span class=line><span class=cl>process_vm_writev<span class=o>(</span>26117, <span class=o>[{</span><span class=nv>iov_base</span><span class=o>=</span><span class=s2>&#34;\x48\x8b&#34;</span>, <span class=nv>iov_len</span><span class=o>=</span>2<span class=o>}]</span>, 1, <span class=o>[{</span><span class=nv>iov_base</span><span class=o>=</span>0x555555555aed, <span class=nv>iov_len</span><span class=o>=</span>2<span class=o>}]</span>, 1, 0<span class=o>)</span> <span class=o>=</span> <span class=m>2</span>
</span></span><span class=line><span class=cl>process_vm_writev<span class=o>(</span>26117, <span class=o>[{</span><span class=nv>iov_base</span><span class=o>=</span><span class=s2>&#34;\x48\x8b\x85&#34;</span>, <span class=nv>iov_len</span><span class=o>=</span>3<span class=o>}]</span>, 1, <span class=o>[{</span><span class=nv>iov_base</span><span class=o>=</span>0x555555554b67, <span class=nv>iov_len</span><span class=o>=</span>3<span class=o>}]</span>, 1, 0<span class=o>)</span> <span class=o>=</span> <span class=m>3</span>
</span></span><span class=line><span class=cl>process_vm_writev<span class=o>(</span>26117, <span class=o>[{</span><span class=nv>iov_base</span><span class=o>=</span><span class=s2>&#34;\x48\x8d&#34;</span>, <span class=nv>iov_len</span><span class=o>=</span>2<span class=o>}]</span>, 1, <span class=o>[{</span><span class=nv>iov_base</span><span class=o>=</span>0x555555554b71, <span class=nv>iov_len</span><span class=o>=</span>2<span class=o>}]</span>, 1, 0<span class=o>)</span> <span class=o>=</span> <span class=m>2</span>
</span></span><span class=line><span class=cl>process_vm_writev<span class=o>(</span>26117, <span class=o>[{</span><span class=nv>iov_base</span><span class=o>=</span><span class=s2>&#34;\x48\xc1&#34;</span>, <span class=nv>iov_len</span><span class=o>=</span>2<span class=o>}]</span>, 1, <span class=o>[{</span><span class=nv>iov_base</span><span class=o>=</span>0x555555554845, <span class=nv>iov_len</span><span class=o>=</span>2<span class=o>}]</span>, 1, 0<span class=o>)</span> <span class=o>=</span> <span class=m>2</span>
</span></span><span class=line><span class=cl>process_vm_writev<span class=o>(</span>26117, <span class=o>[{</span><span class=nv>iov_base</span><span class=o>=</span><span class=s2>&#34;\x5d\x41&#34;</span>, <span class=nv>iov_len</span><span class=o>=</span>2<span class=o>}]</span>, 1, <span class=o>[{</span><span class=nv>iov_base</span><span class=o>=</span>0x555555555c1b, <span class=nv>iov_len</span><span class=o>=</span>2<span class=o>}]</span>, 1, 0<span class=o>)</span> <span class=o>=</span> <span class=m>2</span>
</span></span><span class=line><span class=cl>process_vm_writev<span class=o>(</span>26117, <span class=o>[{</span><span class=nv>iov_base</span><span class=o>=</span><span class=s2>&#34;\x5e\x48\x89&#34;</span>, <span class=nv>iov_len</span><span class=o>=</span>3<span class=o>}]</span>, 1, <span class=o>[{</span><span class=nv>iov_base</span><span class=o>=</span>0x5555555547c5, <span class=nv>iov_len</span><span class=o>=</span>3<span class=o>}]</span>, 1, 0<span class=o>)</span> <span class=o>=</span> <span class=m>3</span>
</span></span><span class=line><span class=cl>process_vm_writev<span class=o>(</span>26117, <span class=o>[{</span><span class=nv>iov_base</span><span class=o>=</span><span class=s2>&#34;\x89\x45\xd8&#34;</span>, <span class=nv>iov_len</span><span class=o>=</span>3<span class=o>}]</span>, 1, <span class=o>[{</span><span class=nv>iov_base</span><span class=o>=</span>0x555555554cc8, <span class=nv>iov_len</span><span class=o>=</span>3<span class=o>}]</span>, 1, 0<span class=o>)</span> <span class=o>=</span> <span class=m>3</span>
</span></span><span class=line><span class=cl>process_vm_writev<span class=o>(</span>26117, <span class=o>[{</span><span class=nv>iov_base</span><span class=o>=</span><span class=s2>&#34;\x8b\x00&#34;</span>, <span class=nv>iov_len</span><span class=o>=</span>2<span class=o>}]</span>, 1, <span class=o>[{</span><span class=nv>iov_base</span><span class=o>=</span>0x5555555558bd, <span class=nv>iov_len</span><span class=o>=</span>2<span class=o>}]</span>, 1, 0<span class=o>)</span> <span class=o>=</span> <span class=m>2</span>
</span></span><span class=line><span class=cl>process_vm_writev<span class=o>(</span>26117, <span class=o>[{</span><span class=nv>iov_base</span><span class=o>=</span><span class=s2>&#34;\x8b\x0a&#34;</span>, <span class=nv>iov_len</span><span class=o>=</span>2<span class=o>}]</span>, 1, <span class=o>[{</span><span class=nv>iov_base</span><span class=o>=</span>0x555555555186, <span class=nv>iov_len</span><span class=o>=</span>2<span class=o>}]</span>, 1, 0<span class=o>)</span> <span class=o>=</span> <span class=m>2</span>
</span></span><span class=line><span class=cl>process_vm_writev<span class=o>(</span>26117, <span class=o>[{</span><span class=nv>iov_base</span><span class=o>=</span><span class=s2>&#34;\x8b\x12\x01&#34;</span>, <span class=nv>iov_len</span><span class=o>=</span>3<span class=o>}]</span>, 1, <span class=o>[{</span><span class=nv>iov_base</span><span class=o>=</span>0x555555554d25, <span class=nv>iov_len</span><span class=o>=</span>3<span class=o>}]</span>, 1, 0<span class=o>)</span> <span class=o>=</span> <span class=m>3</span>
</span></span><span class=line><span class=cl>process_vm_writev<span class=o>(</span>26117, <span class=o>[{</span><span class=nv>iov_base</span><span class=o>=</span><span class=s2>&#34;\x8b\x45\xbc&#34;</span>, <span class=nv>iov_len</span><span class=o>=</span>3<span class=o>}]</span>, 1, <span class=o>[{</span><span class=nv>iov_base</span><span class=o>=</span>0x5555555552f6, <span class=nv>iov_len</span><span class=o>=</span>3<span class=o>}]</span>, 1, 0<span class=o>)</span> <span class=o>=</span> <span class=m>3</span>
</span></span><span class=line><span class=cl>process_vm_writev<span class=o>(</span>26117, <span class=o>[{</span><span class=nv>iov_base</span><span class=o>=</span><span class=s2>&#34;\x8b\x45\xc4&#34;</span>, <span class=nv>iov_len</span><span class=o>=</span>3<span class=o>}]</span>, 1, <span class=o>[{</span><span class=nv>iov_base</span><span class=o>=</span>0x555555554e22, <span class=nv>iov_len</span><span class=o>=</span>3<span class=o>}]</span>, 1, 0<span class=o>)</span> <span class=o>=</span> <span class=m>3</span>
</span></span><span class=line><span class=cl>process_vm_writev<span class=o>(</span>26117, <span class=o>[{</span><span class=nv>iov_base</span><span class=o>=</span><span class=s2>&#34;\x8b\x45\xe0&#34;</span>, <span class=nv>iov_len</span><span class=o>=</span>3<span class=o>}]</span>, 1, <span class=o>[{</span><span class=nv>iov_base</span><span class=o>=</span>0x555555554feb, <span class=nv>iov_len</span><span class=o>=</span>3<span class=o>}]</span>, 1, 0<span class=o>)</span> <span class=o>=</span> <span class=m>3</span>
</span></span><span class=line><span class=cl>process_vm_writev<span class=o>(</span>26117, <span class=o>[{</span><span class=nv>iov_base</span><span class=o>=</span><span class=s2>&#34;\x8b\x45\xf4&#34;</span>, <span class=nv>iov_len</span><span class=o>=</span>3<span class=o>}]</span>, 1, <span class=o>[{</span><span class=nv>iov_base</span><span class=o>=</span>0x555555554934, <span class=nv>iov_len</span><span class=o>=</span>3<span class=o>}]</span>, 1, 0<span class=o>)</span> <span class=o>=</span> <span class=m>3</span>
</span></span><span class=line><span class=cl>process_vm_writev<span class=o>(</span>26117, <span class=o>[{</span><span class=nv>iov_base</span><span class=o>=</span><span class=s2>&#34;\x8b\x4d\xc8&#34;</span>, <span class=nv>iov_len</span><span class=o>=</span>3<span class=o>}]</span>, 1, <span class=o>[{</span><span class=nv>iov_base</span><span class=o>=</span>0x5555555555f1, <span class=nv>iov_len</span><span class=o>=</span>3<span class=o>}]</span>, 1, 0<span class=o>)</span> <span class=o>=</span> <span class=m>3</span>
</span></span><span class=line><span class=cl>process_vm_writev<span class=o>(</span>26117, <span class=o>[{</span><span class=nv>iov_base</span><span class=o>=</span><span class=s2>&#34;\x8b\x55&#34;</span>, <span class=nv>iov_len</span><span class=o>=</span>2<span class=o>}]</span>, 1, <span class=o>[{</span><span class=nv>iov_base</span><span class=o>=</span>0x555555554e32, <span class=nv>iov_len</span><span class=o>=</span>2<span class=o>}]</span>, 1, 0<span class=o>)</span> <span class=o>=</span> <span class=m>2</span>
</span></span><span class=line><span class=cl>process_vm_writev<span class=o>(</span>26117, <span class=o>[{</span><span class=nv>iov_base</span><span class=o>=</span><span class=s2>&#34;\x8b\x55&#34;</span>, <span class=nv>iov_len</span><span class=o>=</span>2<span class=o>}]</span>, 1, <span class=o>[{</span><span class=nv>iov_base</span><span class=o>=</span>0x555555554e61, <span class=nv>iov_len</span><span class=o>=</span>2<span class=o>}]</span>, 1, 0<span class=o>)</span> <span class=o>=</span> <span class=m>2</span>
</span></span><span class=line><span class=cl>process_vm_writev<span class=o>(</span>26117, <span class=o>[{</span><span class=nv>iov_base</span><span class=o>=</span><span class=s2>&#34;\x8b\x55\xdc&#34;</span>, <span class=nv>iov_len</span><span class=o>=</span>3<span class=o>}]</span>, 1, <span class=o>[{</span><span class=nv>iov_base</span><span class=o>=</span>0x555555555482, <span class=nv>iov_len</span><span class=o>=</span>3<span class=o>}]</span>, 1, 0<span class=o>)</span> <span class=o>=</span> <span class=m>3</span>
</span></span><span class=line><span class=cl>process_vm_writev<span class=o>(</span>26117, <span class=o>[{</span><span class=nv>iov_base</span><span class=o>=</span><span class=s2>&#34;\x90\x5d\xc3&#34;</span>, <span class=nv>iov_len</span><span class=o>=</span>3<span class=o>}]</span>, 1, <span class=o>[{</span><span class=nv>iov_base</span><span class=o>=</span>0x555555555744, <span class=nv>iov_len</span><span class=o>=</span>3<span class=o>}]</span>, 1, 0<span class=o>)</span> <span class=o>=</span> <span class=m>3</span>
</span></span><span class=line><span class=cl>process_vm_writev<span class=o>(</span>26117, <span class=o>[{</span><span class=nv>iov_base</span><span class=o>=</span><span class=s2>&#34;\xc1\xe8\x08&#34;</span>, <span class=nv>iov_len</span><span class=o>=</span>3<span class=o>}]</span>, 1, <span class=o>[{</span><span class=nv>iov_base</span><span class=o>=</span>0x555555555b0f, <span class=nv>iov_len</span><span class=o>=</span>3<span class=o>}]</span>, 1, 0<span class=o>)</span> <span class=o>=</span> <span class=m>3</span>
</span></span></code></pre></div><p>We parsed this output using an helper python script to generate IDC valid patching instructions we later copy-pasted in the IDA cmd-line.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>re</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>f</span> <span class=o>=</span> <span class=n>file</span><span class=p>(</span><span class=s2>&#34;./patches&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>patches</span> <span class=o>=</span> <span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>()</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)[:</span><span class=o>-</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>l</span> <span class=ow>in</span> <span class=n>patches</span><span class=p>:</span>
</span></span><span class=line><span class=cl>	<span class=c1># print l</span>
</span></span><span class=line><span class=cl>	<span class=n>addr</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>l</span><span class=p>[</span><span class=n>l</span><span class=o>.</span><span class=n>index</span><span class=p>(</span><span class=s2>&#34;iov_base=&#34;</span><span class=p>,</span><span class=mi>45</span><span class=p>)</span><span class=o>+</span><span class=mi>9</span><span class=p>:</span><span class=n>l</span><span class=o>.</span><span class=n>index</span><span class=p>(</span><span class=s2>&#34;iov_base=&#34;</span><span class=p>,</span><span class=mi>45</span><span class=p>)</span><span class=o>+</span><span class=mi>9</span><span class=o>+</span><span class=mi>14</span><span class=p>],</span><span class=mi>16</span><span class=p>)</span><span class=o>-</span><span class=mh>0x555555554000</span>
</span></span><span class=line><span class=cl>	<span class=n>patch_len</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>l</span><span class=p>[</span><span class=n>l</span><span class=o>.</span><span class=n>index</span><span class=p>(</span><span class=s2>&#34;iov_len=&#34;</span><span class=p>)</span><span class=o>+</span><span class=mi>8</span><span class=p>:</span><span class=n>l</span><span class=o>.</span><span class=n>index</span><span class=p>(</span><span class=s2>&#34;iov_len=&#34;</span><span class=p>)</span><span class=o>+</span><span class=mi>8</span><span class=o>+</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>	<span class=n>patch</span> <span class=o>=</span> <span class=n>l</span><span class=p>[</span><span class=n>l</span><span class=o>.</span><span class=n>index</span><span class=p>(</span><span class=s2>&#34;iov_base=&#34;</span><span class=p>)</span><span class=o>+</span><span class=mi>10</span><span class=p>:</span><span class=n>l</span><span class=o>.</span><span class=n>index</span><span class=p>(</span><span class=s2>&#34;iov_base=&#34;</span><span class=p>)</span><span class=o>+</span><span class=mi>10</span><span class=o>+</span><span class=p>(</span><span class=n>patch_len</span><span class=o>*</span><span class=mi>4</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>	<span class=n>patch_s</span> <span class=o>=</span> <span class=n>patch</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\\</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=n>xrange</span><span class=p>(</span><span class=n>patch_len</span><span class=p>):</span>
</span></span><span class=line><span class=cl>		<span class=nb>print</span> <span class=s2>&#34;patch_byte(&#34;</span><span class=o>+</span><span class=nb>hex</span><span class=p>(</span><span class=n>addr</span><span class=o>+</span><span class=n>j</span><span class=p>)</span><span class=o>+</span><span class=s2>&#34;, 0&#34;</span><span class=o>+</span><span class=n>patch_s</span><span class=p>[</span><span class=n>j</span><span class=o>+</span><span class=mi>1</span><span class=p>]</span> <span class=o>+</span><span class=s2>&#34;);&#34;</span>
</span></span></code></pre></div><p>Which gave us:</p><pre tabindex=0><code>marcof:(~/googlectf/keygenme)$ python patcher.py 
patch_byte(0xd56, 0x01);
patch_byte(0xd57, 0xca);
patch_byte(0x1549, 0x01);
patch_byte(0x154a, 0xca);
patch_byte(0x154b, 0x01);
patch_byte(0x12b6, 0x01);
.
.
</code></pre><h2 class="relative group">main3 reversing<div id=main3-reversing class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#main3-reversing aria-label=Anchor>#</a></span></h2><p>This binary takes as input a 5byte validation code and a 32byte serial key. The serial key is shuffled according to some algorithm we didn&rsquo;t want to reverse. The scrumbled key is then compared with another value whose generation also we absolutely didn&rsquo;t want to reverse, surely something depending on the 5byte validation code. With a black box apporach we were able to both obtain the xoring key (inputing a &ldquo;0"x32 serial) and the byte mappings (find them in the final exploit). The only thing we missed now was a way to obtain the comparing value generated from the validation code.</p><h2 class="relative group">Solution<div id=solution class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#solution aria-label=Anchor>#</a></span></h2><p>The fastest way for us was to patch out the final strcmp() and substitute it with a puts() in our child binary (main3). For unknown reasons running main3 exlusively was not working so we rapidly produced a patched main version calling execve on it.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// Patch of main binary to execve our patched main3
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nf>patch_byte</span><span class=p>(</span><span class=mh>0x603da2</span><span class=p>,</span><span class=sc>&#39;m&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nf>patch_byte</span><span class=p>(</span><span class=mh>0x603da3</span><span class=p>,</span><span class=sc>&#39;a&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nf>patch_byte</span><span class=p>(</span><span class=mh>0x603da4</span><span class=p>,</span><span class=sc>&#39;i&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nf>patch_byte</span><span class=p>(</span><span class=mh>0x603da5</span><span class=p>,</span><span class=sc>&#39;n&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nf>patch_byte</span><span class=p>(</span><span class=mh>0x603da6</span><span class=p>,</span><span class=sc>&#39;3&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nf>patch_byte</span><span class=p>(</span><span class=mh>0x603da7</span><span class=p>,</span><span class=mh>0x00</span><span class=p>);</span>
</span></span></code></pre></div><p>Our approach now is:</p><ul><li>we get the 5 byte validation code from the server</li><li>we pass it to our patched version of the binary</li><li>the inserted puts() gives us the comparing value</li><li>we apply the byte mappings and xoring key on this value</li><li>we sent it back to the server</li><li><del>we get the flag</del></li><li>no actually repeat 100 times</li><li>we get the flag</li></ul><h2 class="relative group">Final exploit<div id=final-exploit class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#final-exploit aria-label=Anchor>#</a></span></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## this looks stupid but at the time we thought the mapping was far more complex</span>
</span></span><span class=line><span class=cl><span class=n>maps</span> <span class=o>=</span> <span class=p>{</span><span class=mi>0</span><span class=p>:</span><span class=mi>30</span><span class=p>,</span><span class=mi>1</span><span class=p>:</span><span class=mi>1</span><span class=p>,</span><span class=mi>2</span><span class=p>:</span><span class=mi>28</span><span class=p>,</span><span class=mi>3</span><span class=p>:</span><span class=mi>3</span><span class=p>,</span><span class=mi>4</span><span class=p>:</span><span class=mi>26</span><span class=p>,</span><span class=mi>5</span><span class=p>:</span><span class=mi>5</span><span class=p>,</span><span class=mi>6</span><span class=p>:</span><span class=mi>24</span><span class=p>,</span><span class=mi>7</span><span class=p>:</span><span class=mi>7</span><span class=p>,</span><span class=mi>8</span><span class=p>:</span><span class=mi>22</span><span class=p>,</span><span class=mi>9</span><span class=p>:</span><span class=mi>9</span><span class=p>,</span><span class=mi>10</span><span class=p>:</span><span class=mi>20</span><span class=p>,</span><span class=mi>11</span><span class=p>:</span><span class=mi>11</span><span class=p>,</span><span class=mi>12</span><span class=p>:</span><span class=mi>18</span><span class=p>,</span><span class=mi>13</span><span class=p>:</span><span class=mi>13</span><span class=p>,</span><span class=mi>14</span><span class=p>:</span><span class=mi>16</span><span class=p>,</span><span class=mi>15</span><span class=p>:</span><span class=mi>15</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=mi>16</span><span class=p>:</span><span class=mi>14</span><span class=p>,</span><span class=mi>17</span><span class=p>:</span><span class=mi>17</span><span class=p>,</span><span class=mi>18</span><span class=p>:</span><span class=mi>12</span><span class=p>,</span><span class=mi>19</span><span class=p>:</span><span class=mi>19</span><span class=p>,</span><span class=mi>20</span><span class=p>:</span><span class=mi>10</span><span class=p>,</span><span class=mi>21</span><span class=p>:</span><span class=mi>21</span><span class=p>,</span><span class=mi>22</span><span class=p>:</span><span class=mi>8</span><span class=p>,</span><span class=mi>23</span><span class=p>:</span><span class=mi>23</span><span class=p>,</span><span class=mi>24</span><span class=p>:</span><span class=mi>6</span><span class=p>,</span><span class=mi>25</span><span class=p>:</span><span class=mi>25</span><span class=p>,</span><span class=mi>26</span><span class=p>:</span><span class=mi>4</span><span class=p>,</span><span class=mi>27</span><span class=p>:</span><span class=mi>27</span><span class=p>,</span><span class=mi>28</span><span class=p>:</span><span class=mi>2</span><span class=p>,</span><span class=mi>29</span><span class=p>:</span><span class=mi>29</span><span class=p>,</span><span class=mi>30</span><span class=p>:</span><span class=mi>0</span><span class=p>,</span><span class=mi>31</span><span class=p>:</span><span class=mi>31</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>key</span> <span class=o>=</span> <span class=mh>0x00112233445566778899aabbccddeeff</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>map_key</span><span class=p>(</span><span class=n>otp</span><span class=p>):</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>arr</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;a&#34;</span><span class=p>]</span> <span class=o>*</span> <span class=mi>32</span>
</span></span><span class=line><span class=cl>    <span class=n>b</span> <span class=o>=</span> <span class=n>key</span><span class=o>^</span><span class=n>otp</span>
</span></span><span class=line><span class=cl>    <span class=n>b</span> <span class=o>=</span> <span class=nb>hex</span><span class=p>(</span><span class=n>b</span><span class=p>)[</span><span class=mi>2</span><span class=p>:]</span><span class=o>.</span><span class=n>rjust</span><span class=p>(</span><span class=mi>32</span><span class=p>,</span><span class=s1>&#39;0&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span><span class=p>,</span><span class=n>c</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>b</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># print i,c</span>
</span></span><span class=line><span class=cl>        <span class=n>arr</span><span class=p>[</span><span class=n>maps</span><span class=p>[</span><span class=n>i</span><span class=p>]]</span> <span class=o>=</span> <span class=n>c</span>
</span></span><span class=line><span class=cl>    <span class=c1># print &#34;UNAMPPED: &#34; + b</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s2>&#34;&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>arr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>r</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=s1>&#39;keygenme.ctfcompetition.com&#39;</span><span class=p>,</span><span class=mi>1337</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>count</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>num</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)[:</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=s1>&#39;CTF{&#39;</span> <span class=ow>in</span> <span class=n>num</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span> <span class=s2>&#34;FLAG?: &#34;</span> <span class=o>+</span> <span class=n>num</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span> <span class=s2>&#34;COUNT: &#34;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>count</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span>
</span></span><span class=line><span class=cl>    <span class=n>count</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s1>&#39;./main&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>num</span><span class=o>+</span><span class=s2>&#34;0&#34;</span><span class=o>*</span><span class=mi>32</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>xored</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)[:</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1># print &#34;CODE:     &#34; + num</span>
</span></span><span class=line><span class=cl>    <span class=c1># print &#34;XORED:    &#34; + xored</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>map_key</span><span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=n>xored</span><span class=p>,</span><span class=mi>16</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=c1># print &#34;MAPPED:   &#34; + result</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;OK</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span></code></pre></div><h2 class="relative group">Attachments<div id=attachments class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#attachments aria-label=Anchor>#</a></span></h2><p>The original challenge files <a href="https://drive.google.com/file/d/1CP7QQSWPNgzo_Hgxd78PyBi0WWReWMbC/view?usp=sharing" target=_blank>here</a><br>Final exploit, patched <em>main</em> and <em>main3</em> binaries <a href="https://drive.google.com/file/d/1VAU2HdpnfJOLSuxX3lsM3kQaTVhcZWPx/view?usp=sharing" target=_blank>here</a></p></div></div><script type=text/javascript src=/js/page.min.54b6f4371722649edbe871e431d8670d670878c22be8f36e229fe53cc9b786fe25a834def5e6de621f7a3e37b72bc8cd73839aa5ed907ed6cbd45cd3e1b0fa20.js integrity="sha512-VLb0NxciZJ7b6HHkMdhnDWcIeMIr6PNuIp/lPMm3hv4lqDTe9ebeYh96Pje3K8jNc4Oape2QftbL1FzT4bD6IA==" data-oid=views_writeups/2018-06-27-google-ctf-2018-keygenme/index.md data-oid-likes=likes_writeups/2018-06-27-google-ctf-2018-keygenme/index.md></script></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="flex group mr-3" href=/writeups/2018-05-27-rctf-2018-all-writeups/><span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&larr;</span>
<span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Rctf 2018 - Write ups</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2018-05-27T00:00:00+00:00>27 May 2018</time>
</span></span></a></span><span><a class="flex text-right group ml-3" href=/writeups/2018-06-29-google-ctf-2018-sftp/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">SFTP - Google CTF 2018</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2018-06-29T00:00:00+00:00>29 June 2018</time>
</span></span><span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&larr;</span></a></span></div></div></footer></article><div id=top-scroller class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0"><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer id=site-footer class="py-10 print:hidden"><nav class="flex flex-row pb-4 text-base font-medium text-neutral-500 dark:text-neutral-400"><ul class="flex flex-col list-none sm:flex-row"><li class="flex mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center" href title></a></li></ul></nav><div class="flex items-center justify-between"><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2025
mhackeroni</p><p class="text-xs text-neutral-500 dark:text-neutral-400">Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://blowfish.page/ target=_blank rel="noopener noreferrer">Blowfish</a></p></div><script>mediumZoom(document.querySelectorAll("img:not(.nozoom)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script><script type=text/javascript src=/js/process.min.ee03488f19c93c2efb199e2e3014ea5f3cb2ce7d45154adb3399a158cac27ca52831db249ede5bb602700ef87eb02434139de0858af1818ab0fb4182472204a4.js integrity="sha512-7gNIjxnJPC77GZ4uMBTqXzyyzn1FFUrbM5mhWMrCfKUoMdsknt5btgJwDvh+sCQ0E53ghYrxgYqw+0GCRyIEpA=="></script></footer><div id=search-wrapper class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh] z-500" data-url=https://mhackeroni.it/><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=Search tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="Close (Esc)">
<span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>